<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">
    <title>AI OS V5.1 (å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ (iOS é£æ ¼) --- */
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --primary: #007AFF;
            --danger: #FF3B30;
            --text-main: #000000;
            --text-sub: #8e8e93;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; }
        body { margin: 0; width: 100vw; height: 100dvh; background: var(--bg-color); overflow: hidden; color: var(--text-main); display: flex; flex-direction: column; }

        /* --- é€šç”¨ç»„ä»¶ --- */
        .app-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-color); z-index: 100; 
            display: flex; flex-direction: column; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .app-screen.active { transform: translateY(0); }
        
        .nav-bar { 
            height: calc(44px + var(--safe-top)); padding-top: var(--safe-top);
            background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px;
            z-index: 200; flex-shrink: 0;
        }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { color: var(--primary); background: none; border: none; font-size: 16px; padding: 5px; cursor: pointer; }

        .scroll-content { flex: 1; overflow-y: auto; padding: 20px 15px; }
        
        .list-group { background: var(--card-bg); border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .list-item { 
            padding: 12px 16px; border-bottom: 0.5px solid #e5e5ea; 
            display: flex; justify-content: space-between; align-items: center; font-size: 16px;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background-color: #f2f2f7; }
        
        .input-clean { border: none; outline: none; width: 100%; font-size: 16px; background: transparent; text-align: right; color: #007AFF; }
        .input-clean::placeholder { color: #c7c7cc; }

        /* --- ä¸»å±å¹• --- */
        #home-screen { 
            width: 100%; height: 100%; padding-top: calc(var(--safe-top) + 50px); padding-bottom: 100px;
            display: flex; flex-direction: column; gap: 20px; align-items: center; overflow-y: auto;
        }
        .widget { 
            width: 90%; background: rgba(255,255,255,0.6); backdrop-filter: blur(20px);
            border-radius: 22px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: center;
        }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 90%; margin-top: 20px; }
        .app-icon { 
            width: 60px; height: 60px; border-radius: 14px; background: #fff; 
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.9); }
        .dock { 
            position: fixed; bottom: calc(var(--safe-bottom) + 15px); width: 90%; height: 85px;
            background: rgba(255,255,255,0.5); backdrop-filter: blur(25px); border-radius: 28px;
            display: flex; align-items: center; justify-content: space-around; margin-left: 5%;
        }

        /* --- èŠå¤©ç•Œé¢ --- */
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #fff; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
        .msg-row.me { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #eee; object-fit: cover; flex-shrink: 0; }
        .bubble { 
            max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; word-wrap: break-word; 
        }
        .msg-row.other .bubble { background: #e9e9eb; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.me .bubble { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        
        .chat-input-bar {
            background: #f9f9f9; border-top: 0.5px solid #ccc; padding: 8px 12px;
            padding-bottom: max(8px, var(--safe-bottom));
            display: flex; align-items: flex-end; gap: 10px;
        }
        .chat-input { 
            flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 20px; 
            padding: 10px 12px; font-size: 16px; outline: none; max-height: 100px; overflow-y: auto;
        }
        .btn-round { width: 36px; height: 36px; border-radius: 50%; background: #eee; color: #007AFF; display: flex; align-items: center; justify-content: center; border: none; font-size: 20px; flex-shrink: 0; cursor: pointer;}

        /* --- ä¾§è¾¹æ  (Drawer) --- */
        .drawer-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 300; display: none; }
        .drawer { 
            position: fixed; top: 0; right: 0; width: 85%; height: 100%; 
            background: #f2f2f7; z-index: 310; 
            transform: translateX(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
            padding-top: var(--safe-top);
        }
        .drawer.show { transform: translateX(0); }

        /* --- æ¨¡æ€æ¡† --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 500; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #fff; width: 80%; border-radius: 14px; padding: 20px; text-align: center; }
    </style>
</head>
<body>

    <!-- 1. ä¸»å±å¹• -->
    <div id="home-screen">
        <div class="widget">
            <div style="font-size:12px; color:#888; font-weight:600;">THURSDAY</div>
            <div style="font-size:48px; font-weight:300; line-height:1.1;" id="clock">09:41</div>
            <div style="font-size:14px; color:#007AFF; margin-top:5px;">AI OS System Ready</div>
        </div>

        <div class="app-grid">
            <div class="app-icon" style="background:#e5e5ea" onclick="openApp('app-settings')">âš™ï¸</div>
            <div class="app-icon" style="background:#ffcc00" onclick="openApp('app-memory')">ğŸ§ </div>
            <div class="app-icon" style="background:#fff">ğŸ“·</div>
            <div class="app-icon" style="background:#fff">ğŸµ</div>
        </div>
    </div>

    <!-- 2. åº•éƒ¨ Dock -->
    <div class="dock">
        <div class="app-icon" style="background:linear-gradient(135deg, #30cfd0, #330867); color:white;" onclick="openApp('app-chat-list')">ğŸ’¬</div>
        <div class="app-icon" style="background:#fff" onclick="openApp('app-memory')">ğŸ“’</div>
        <div class="app-icon" style="background:#fff" onclick="openApp('app-settings')">âš™ï¸</div>
    </div>

    <!-- ================= APP: èŠå¤©åˆ—è¡¨ ================= -->
    <div id="app-chat-list" class="app-screen">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApp('app-chat-list')">å…³é—­</button>
            <span class="nav-title">æ¶ˆæ¯</span>
            <button class="nav-btn" onclick="document.getElementById('modal-add-contact').style.display='flex'">ï¼‹</button>
        </div>
        <div class="scroll-content" id="contact-list">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ================= APP: èŠå¤©å®¤ ================= -->
    <div id="app-chat-room" class="app-screen" style="z-index: 150;">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApp('app-chat-room')">è¿”å›</button>
            <span class="nav-title" id="chat-title">Chat</span>
            <button class="nav-btn" onclick="openDrawer()">â‰¡</button>
        </div>
        <div class="chat-container" id="msg-box"></div>
        
        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <div id="img-preview" style="display:none; padding:5px 15px; background:#eee; font-size:12px; align-items:center; gap:10px;">
            <img id="preview-thumb" src="" style="width:30px; height:30px; border-radius:4px;">
            <span>å·²æ·»åŠ å›¾ç‰‡</span>
            <span style="color:red; margin-left:auto;" onclick="clearImage()">âœ•</span>
        </div>

        <div class="chat-input-bar">
            <button class="btn-round" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
            <input type="file" id="file-input" hidden accept="image/*" onchange="handleImage(event)">
            
            <!-- ä¿®å¤ï¼šEnterå‘é€ -->
            <input type="text" id="chat-input" class="chat-input" placeholder="å‘æ¶ˆæ¯..." onkeydown="handleInputKey(event)">
            
            <button class="btn-round" style="font-size:14px; font-weight:bold;" onclick="sendMessage(false)" title="åªå‘ä¸å›">ğŸ’¬</button>
            <button class="btn-round" style="background:#007AFF; color:white;" onclick="sendMessage(true)">â†‘</button>
        </div>

        <!-- ä¾§è¾¹æ  Drawer -->
        <div class="drawer-mask" id="drawer-mask" onclick="closeDrawer()"></div>
        <div class="drawer" id="drawer">
            <div class="nav-bar">
                <span class="nav-title">è¯¦ç»†è®¾å®š</span>
                <button class="nav-btn" onclick="closeDrawer()">å®Œæˆ</button>
            </div>
            <div class="scroll-content">
                <div style="font-size:12px; color:#888; margin-bottom:5px; padding-left:10px;">AI è®¾å®š (å¯¹æ–¹)</div>
                <div class="list-group">
                    <div class="list-item" style="justify-content:center; padding:20px;">
                        <img id="drawer-ai-av" src="" style="width:60px; height:60px; border-radius:50%; border:1px solid #ccc;" onclick="document.getElementById('up-ai').click()">
                        <input type="file" id="up-ai" hidden onchange="updateAvatar('ai', event)">
                        <div style="margin-left:15px; color:#007AFF; font-size:14px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                    </div>
                    <div class="list-item">
                        <span>åç§°</span>
                        <input id="drawer-remark" class="input-clean" onchange="saveDrawer()">
                    </div>
                    <div class="list-item" style="flex-direction:column; align-items:flex-start;">
                        <span style="margin-bottom:5px; font-size:14px;">AI äººè®¾ (Prompt)</span>
                        <textarea id="drawer-persona" style="width:100%; border:none; height:60px; font-size:14px; resize:none;" onchange="saveDrawer()"></textarea>
                    </div>
                </div>

                <div style="font-size:12px; color:#888; margin-bottom:5px; padding-left:10px;">ç”¨æˆ·è®¾å®š (ä½ )</div>
                <div class="list-group">
                    <div class="list-item">
                        <span>ä½ çš„å¤´åƒ</span>
                        <img id="drawer-user-av" src="" style="width:30px; height:30px; border-radius:50%;" onclick="document.getElementById('up-user').click()">
                        <input type="file" id="up-user" hidden onchange="updateAvatar('user', event)">
                    </div>
                    <div class="list-item">
                        <span>ä½ çš„æ˜µç§°</span>
                        <input id="drawer-username" class="input-clean" onchange="saveDrawer()">
                    </div>
                    <div class="list-item" style="flex-direction:column; align-items:flex-start;">
                        <span style="margin-bottom:5px; font-size:14px;">ç”¨æˆ·äººè®¾ (User Persona)</span>
                        <textarea id="drawer-userpersona" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ä¸ªå¥½å¥‡çš„å­¦ç”Ÿ..." style="width:100%; border:none; height:60px; font-size:14px; resize:none;" onchange="saveDrawer()"></textarea>
                    </div>
                </div>

                <div class="list-group">
                    <div class="list-item" onclick="startSummary()" style="color:#007AFF; justify-content:center;">âœ¨ æ™ºèƒ½æ€»ç»“åˆ°è®°å¿†åº“</div>
                    <div class="list-item" onclick="clearHistory()" style="color:#FF3B30; justify-content:center;">ğŸ—‘ï¸ æ¸…ç©ºèŠå¤©è®°å½•</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= APP: è®°å¿†åº“ ================= -->
    <div id="app-memory" class="app-screen">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApp('app-memory')">å…³é—­</button>
            <span class="nav-title">è®°å¿†ç¢ç‰‡</span>
            <button class="nav-btn" onclick="addMemory()">ï¼‹</button>
        </div>
        <div class="scroll-content" id="memory-list"></div>
    </div>

    <!-- ================= APP: è®¾ç½® ================= -->
    <div id="app-settings" class="app-screen">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApp('app-settings')">å…³é—­</button>
            <span class="nav-title">è®¾ç½®</span>
            <div style="width:30px"></div>
        </div>
        <div class="scroll-content">
            <div class="list-group">
                <div class="list-item">
                    <input id="cfg-url" class="input-clean" style="text-align:left;" placeholder="API URL (ä¾‹å¦‚ https://api.openai.com/v1)" onchange="saveConfig()">
                </div>
                <div class="list-item">
                    <input id="cfg-key" type="password" class="input-clean" style="text-align:left;" placeholder="API Key (sk-xxxx)" onchange="saveConfig()">
                </div>
                
                <div class="list-item">
                    <span>æ¨¡å‹</span>
                    <div style="display:flex; align-items:center; flex:1; justify-content:flex-end;">
                        <select id="cfg-model-select" style="border:none; background:transparent; font-size:16px; color:#007AFF; margin-right:5px; max-width:120px;" onchange="applyModelSelect()">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            <option value="gpt-4o">gpt-4o</option>
                            <option value="custom">è‡ªå®šä¹‰...</option>
                        </select>
                        <input id="cfg-model" class="input-clean" style="width:100px; text-align:right; display:none;" placeholder="è¾“å…¥ID" onchange="saveConfig()">
                    </div>
                </div>
                
                <div class="list-item" onclick="fetchModels()" style="color:#5856D6; justify-content:center; font-weight:600;">
                    ğŸ“¡ æ‹‰å–æ¨¡å‹åˆ—è¡¨
                </div>
                <div class="list-item" onclick="testConnection()" style="color:#34C759; justify-content:center;">
                    ğŸ“¶ æµ‹è¯•è¿æ¥
                </div>
            </div>
            
            <div class="list-group">
                 <div class="list-item">
                    <span>æ¸©åº¦ (åˆ›é€ åŠ›) <span id="val-temp" style="color:#888; font-size:12px;">0.7</span></span>
                    <input type="range" id="cfg-temp" min="0" max="2" step="0.1" value="0.7" oninput="updateTemp(this.value)">
                 </div>
            </div>

             <div class="list-group">
                <div class="list-item" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</div>
                <div class="list-item" style="position:relative;">
                    ğŸ“¥ æ¢å¤æ•°æ®
                    <input type="file" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0;" onchange="importData(event)">
                </div>
             </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†: æ·»åŠ è”ç³»äºº -->
    <div id="modal-add-contact" class="modal">
        <div class="modal-content">
            <h3>æ–°å¯¹è¯</h3>
            <input id="new-contact-name" class="input-clean" style="border:1px solid #ccc; padding:10px; border-radius:8px; margin:15px 0; text-align:center;" placeholder="è¾“å…¥åå­—">
            <div style="display:flex; gap:10px;">
                <button class="nav-btn" style="flex:1; color:#888;" onclick="document.getElementById('modal-add-contact').style.display='none'">å–æ¶ˆ</button>
                <button class="nav-btn" style="flex:1; font-weight:bold;" onclick="createContact()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ•°æ®çŠ¶æ€ç®¡ç† ---
        const defaultState = {
            config: { url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo", temp: 0.7 },
            contacts: [],
            memories: []
        };
        let state = { ...defaultState };
        let currentContactId = null;
        let currentImgBase64 = null;

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            const saved = localStorage.getItem('aios_v5');
            if(saved) {
                try {
                    state = JSON.parse(saved);
                } catch(e) { console.error("æ•°æ®æŸå", e); }
            }
            
            // å¦‚æœæ²¡æœ‰è”ç³»äººï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„
            if(state.contacts.length === 0) createContact("AI åŠ©æ‰‹", true);

            updateClock(); setInterval(updateClock, 60000);
            loadConfigUI();
        };

        function saveData() { 
            try {
                localStorage.setItem('aios_v5', JSON.stringify(state)); 
            } catch(e) {
                // æ•è· LocalStorage å·²æ»¡çš„é”™è¯¯ï¼Œé˜²æ­¢è„šæœ¬å´©æºƒ
                console.error("ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºé—´ä¸è¶³", e);
                alert("âš ï¸ å­˜å‚¨ç©ºé—´å·²æ»¡ï¼è¯·æ¸…ç†èŠå¤©è®°å½•æˆ–ä¸è¦å‘é€å¤ªå¤šå¤§å›¾ç‰‡ã€‚");
            }
        }

        // --- ç•Œé¢å¯¼èˆª ---
        function openApp(id) {
            document.getElementById(id).classList.add('active');
            if(id === 'app-chat-list') renderContactList();
            if(id === 'app-memory') renderMemoryList();
            if(id === 'app-settings') loadConfigUI();
        }
        function closeApp(id) { document.getElementById(id).classList.remove('active'); }
        
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        }

        // --- èŠå¤©åŠŸèƒ½ (ä¿®å¤ç‰ˆ) ---
        function createContact(name=null, silent=false) {
            const n = name || document.getElementById('new-contact-name').value;
            if(!n) return;
            const newC = {
                id: Date.now().toString(),
                name: n,
                remark: "",
                persona: "ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„AIåŠ©æ‰‹ã€‚",
                userPersona: "",
                aiAvatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${n}`,
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                messages: []
            };
            state.contacts.push(newC);
            saveData();
            if(!silent) {
                document.getElementById('modal-add-contact').style.display='none';
                document.getElementById('new-contact-name').value='';
                renderContactList();
            }
        }

        function renderContactList() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            state.contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${c.aiAvatar}" style="width:40px; height:40px; border-radius:50%; background:#eee;">
                        <div>
                            <div style="font-weight:600;">${c.remark || c.name}</div>
                            <div style="font-size:12px; color:#888;">${c.messages.length} æ¡æ¶ˆæ¯</div>
                        </div>
                    </div>
                    <span style="color:#ccc;">â€º</span>
                `;
                div.onclick = () => openChat(c.id);
                list.appendChild(div);
            });
        }

        function openChat(id) {
            currentContactId = id;
            const c = state.contacts.find(x => x.id === id);
            document.getElementById('chat-title').innerText = c.remark || c.name;
            
            // é¢„å¡«ä¾§è¾¹æ 
            document.getElementById('drawer-ai-av').src = c.aiAvatar;
            document.getElementById('drawer-remark').value = c.remark;
            document.getElementById('drawer-persona').value = c.persona;
            document.getElementById('drawer-user-av').src = c.userAvatar;
            document.getElementById('drawer-username').value = c.userName;
            document.getElementById('drawer-userpersona').value = c.userPersona || "";

            renderMessages();
            openApp('app-chat-room');
            scrollToBottom();
        }

        function scrollToBottom() {
            const box = document.getElementById('msg-box');
            box.scrollTop = box.scrollHeight;
        }

        function renderMessages() {
            const c = state.contacts.find(x => x.id === currentContactId);
            const box = document.getElementById('msg-box');
            box.innerHTML = '';
            c.messages.forEach(msg => {
                appendMessageToUI(msg.role, msg.content, msg.image, c);
            });
        }

        // è¾…åŠ©ï¼šæŠŠæ¶ˆæ¯æ’å…¥åˆ° DOMï¼Œä¸é‡ç»˜æ•´ä¸ªåˆ—è¡¨
        function appendMessageToUI(role, content, image, contact) {
            const box = document.getElementById('msg-box');
            const isMe = role === 'user';
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'me' : 'other'}`;
            
            const imgHTML = image ? `<img src="${image}" style="max-width:100%; border-radius:8px; margin-bottom:5px; display:block;">` : '';
            const avatar = isMe ? contact.userAvatar : contact.aiAvatar;

            div.innerHTML = `
                <img src="${avatar}" class="avatar">
                <div class="bubble">${imgHTML}${content ? content.replace(/\n/g, '<br>') : ''}</div>
            `;
            box.appendChild(div);
            scrollToBottom();
            return div; // è¿”å›å…ƒç´ ä»¥ä¾¿åç»­æ“ä½œ
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleInputKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // é˜»æ­¢æ¢è¡Œ
                sendMessage(true);
            }
        }

        // --- å‘é€ä¸ API è¯·æ±‚ (æ ¸å¿ƒé‡å†™) ---
        async function sendMessage(triggerAI) {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            const c = state.contacts.find(x => x.id === currentContactId);

            // 1. ç”¨æˆ·æ¶ˆæ¯ä¸Šå± (ç«‹å³æ‰§è¡Œ)
            if (txt || currentImgBase64) {
                // å…ˆæ›´æ–°ç•Œé¢ï¼Œä¿è¯ç”¨æˆ·æ„Ÿè§‰"å¿«"
                appendMessageToUI('user', txt, currentImgBase64, c);
                
                // æ›´æ–°æ•°æ®
                c.messages.push({
                    role: 'user',
                    content: txt,
                    image: currentImgBase64
                });

                // æ¸…ç†è¾“å…¥æ¡†
                input.value = '';
                clearImage();
                
                // æœ€åä¿å­˜ (å¦‚æœä¿å­˜å¤±è´¥ä¹Ÿä¸å½±å“ç•Œé¢æ˜¾ç¤º)
                saveData();
            } else {
                // æ²¡å†…å®¹ä¸”ä¸è§¦å‘AI -> é€€å‡º
                if(!triggerAI) return;
                if(c.messages.length === 0) return;
            }

            if (!triggerAI) return; 

            if (!state.config.key) {
                alert("è¯·å…ˆå»è®¾ç½®é…ç½® API Key");
                return;
            }

            // 2. å‡†å¤‡ UIï¼šæ˜¾ç¤º Loading æ°”æ³¡
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ UI å¯¹è±¡ï¼Œç¨åå¡«å……å†…å®¹
            const loadingBubbleDiv = appendMessageToUI('assistant', '...', null, c);
            const bubbleContent = loadingBubbleDiv.querySelector('.bubble');
            bubbleContent.style.color = '#888';

            // 3. æ„é€  Prompt
            let sysPrompt = `${c.persona}\n`;
            sysPrompt += `[User Info] Name: ${c.userName}.`;
            if(c.userPersona) sysPrompt += ` Persona: ${c.userPersona}.`;
            sysPrompt += `\n[Time] ${new Date().toLocaleString()}`;
            if(state.memories.length > 0) sysPrompt += `\n[Memories] ${state.memories.join('; ')}`;

            const messages = [{role:'system', content: sysPrompt}];
            c.messages.slice(-10).forEach(m => {
                if(m.image) {
                    messages.push({role: m.role, content:[{type:"text", text:m.content||" "}, {type:"image_url", image_url:{url:m.image}}]});
                } else {
                    messages.push({role: m.role, content: m.content});
                }
            });

            try {
                const res = await fetch(state.config.url + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + state.config.key
                    },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: messages,
                        temperature: parseFloat(state.config.temp),
                        stream: true // å¼€å¯æµå¼
                    })
                });

                if(!res.ok) {
                    const errData = await res.json().catch(()=>({}));
                    throw new Error(errData.error?.message || res.statusText);
                }

                // 4. æµå¼å¤„ç† (å¢å¼ºç‰ˆï¼Œé˜²æ­¢ JSON æ–­è£‚)
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let aiText = "";
                let buffer = ""; // ç¼“å†²åŒº

                bubbleContent.style.color = "#000";
                bubbleContent.innerHTML = ""; // æ¸…ç©º "..."

                while(true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // æŒ‰ç…§æ¢è¡Œç¬¦åˆ‡å‰²æ•°æ®å—
                    let lines = buffer.split('\n');
                    // æœ€åä¸€ä¸ªå¯èƒ½æ˜¯ä¸å®Œæ•´çš„ï¼Œç•™åˆ°ä¸‹ä¸€æ¬¡å¤„ç†
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.startsWith('data: ')) {
                            const dataStr = trimmed.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(dataStr);
                                const delta = json.choices[0].delta.content || "";
                                aiText += delta;
                                // å®æ—¶æ›´æ–°ç•Œé¢
                                bubbleContent.innerHTML = aiText.replace(/\n/g, '<br>');
                                scrollToBottom();
                            } catch(e) {
                                // å¿½ç•¥è§£æé”™è¯¯çš„è¡Œï¼ˆé€šå¸¸æ˜¯å› ä¸ºæµè¢«åˆ‡æ–­ï¼‰ï¼Œç­‰å¾…Bufferæ‹¼æ¥å®Œæ•´
                            }
                        }
                    }
                }
                
                // 5. å¯¹è¯å®Œæˆï¼Œä¿å­˜åˆ°å†å²
                c.messages.push({ role: 'assistant', content: aiText });
                saveData();

            } catch (err) {
                bubbleContent.innerHTML = `<span style="color:red;">âŒ é”™è¯¯: ${err.message}</span>`;
                console.error(err);
            }
        }

        // --- ä¾§è¾¹æ ç®¡ç† ---
        function openDrawer() { 
            document.getElementById('drawer').classList.add('show');
            document.getElementById('drawer-mask').style.display = 'block';
        }
        function closeDrawer() {
            document.getElementById('drawer').classList.remove('show');
            document.getElementById('drawer-mask').style.display = 'none';
        }
        function saveDrawer() {
            const c = state.contacts.find(x => x.id === currentContactId);
            if(c) {
                c.remark = document.getElementById('drawer-remark').value;
                c.persona = document.getElementById('drawer-persona').value;
                c.username = document.getElementById('drawer-username').value;
                c.userPersona = document.getElementById('drawer-userpersona').value;
                saveData();
                document.getElementById('chat-title').innerText = c.remark || c.name;
            }
        }
        function updateAvatar(type, e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const c = state.contacts.find(x => x.id === currentContactId);
                // ç®€å•å‹ç¼©æ£€æŸ¥ï¼šå¦‚æœ Base64 å¤ªé•¿ï¼ŒLocalStorage å¯èƒ½ä¼šç‚¸
                if(ev.target.result.length > 500000) {
                    alert("å›¾ç‰‡å¤ªå¤§äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¿å­˜å¤±è´¥ã€‚è¯·ä½¿ç”¨å°ä¸€ç‚¹çš„å›¾ç‰‡ã€‚");
                }
                if(type==='ai') { c.aiAvatar = ev.target.result; document.getElementById('drawer-ai-av').src = c.aiAvatar; }
                else { c.userAvatar = ev.target.result; document.getElementById('drawer-user-av').src = c.userAvatar; }
                saveData();
                renderMessages();
            };
            r.readAsDataURL(f);
        }
        function clearHistory() {
            if(confirm("æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ")) {
                state.contacts.find(x=>x.id===currentContactId).messages = [];
                saveData(); renderMessages(); closeDrawer();
            }
        }
        
        async function startSummary() {
            const c = state.contacts.find(x=>x.id===currentContactId);
            if(c.messages.length < 2) { alert("æ¶ˆæ¯å¤ªå°‘ï¼Œæ— æ³•æ€»ç»“"); return; }
            
            const txt = c.messages.map(m=>`${m.role}:${m.content}`).join('\n');
            if(!state.config.key) { alert("è¯·é…ç½®API Key"); return; }

            try {
                const res = await fetch(state.config.url + '/chat/completions', {
                    method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+state.config.key},
                    body: JSON.stringify({model: state.config.model, messages: [{role:'system',content:'æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„å…³é”®ä¿¡æ¯ä¸ºä¸€å¥è¯è®°å¿†'},{role:'user',content:txt}]})
                });
                const d = await res.json();
                state.memories.push(d.choices[0].message.content);
                saveData();
                alert("âœ… å·²å­˜å…¥è®°å¿†åº“");
                closeDrawer();
            } catch(e) { alert("æ€»ç»“å¤±è´¥:"+e.message); }
        }

        // --- è®¾ç½®ä¸æ¨¡å‹æ‹‰å– ---
        function loadConfigUI() {
            document.getElementById('cfg-url').value = state.config.url;
            document.getElementById('cfg-key').value = state.config.key;
            document.getElementById('cfg-model').value = state.config.model;
            document.getElementById('cfg-temp').value = state.config.temp;
            document.getElementById('val-temp').innerText = state.config.temp;

            const sel = document.getElementById('cfg-model-select');
            let found = false;
            for(let opt of sel.options) {
                if(opt.value === state.config.model) {
                    sel.value = state.config.model;
                    found = true;
                    break;
                }
            }
            if(!found) {
                sel.value = 'custom';
                document.getElementById('cfg-model').style.display = 'block';
                document.getElementById('cfg-model').value = state.config.model;
            } else {
                document.getElementById('cfg-model').style.display = 'none';
            }
        }

        function saveConfig() {
            state.config.url = document.getElementById('cfg-url').value;
            state.config.key = document.getElementById('cfg-key').value;
            if(document.getElementById('cfg-model-select').value === 'custom') {
                 state.config.model = document.getElementById('cfg-model').value;
            }
            saveData();
        }
        
        function updateTemp(v) {
            state.config.temp = v;
            document.getElementById('val-temp').innerText = v;
            saveData();
        }

        function applyModelSelect() {
            const sel = document.getElementById('cfg-model-select');
            const input = document.getElementById('cfg-model');
            if(sel.value === 'custom') {
                input.style.display = 'block';
                input.value = state.config.model;
            } else {
                input.style.display = 'none';
                state.config.model = sel.value;
                saveData();
            }
        }

        async function fetchModels() {
            if(!state.config.key) { alert("è¯·å…ˆå¡«å†™ API Key"); return; }
            try {
                const res = await fetch(state.config.url + '/models', {
                    headers: { 'Authorization': 'Bearer ' + state.config.key }
                });
                const data = await res.json();
                
                if(data.data) {
                    const sel = document.getElementById('cfg-model-select');
                    sel.innerHTML = '<option value="custom">è‡ªå®šä¹‰...</option>';
                    data.data.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.innerText = m.id;
                        sel.appendChild(opt);
                    });
                    alert(`âœ… æˆåŠŸæ‹‰å– ${data.data.length} ä¸ªæ¨¡å‹ï¼`);
                    if(data.data.length > 0) {
                        sel.value = data.data[0].id;
                        state.config.model = data.data[0].id;
                        document.getElementById('cfg-model').style.display = 'none';
                        saveData();
                    }
                }
            } catch(e) {
                alert("âŒ æ‹‰å–å¤±è´¥: " + e.message);
            }
        }
        
        async function testConnection() {
             try {
                const res = await fetch(state.config.url + '/models', { headers: { 'Authorization': 'Bearer ' + state.config.key } });
                if(res.ok) alert("âœ… è¿æ¥é€šç•…ï¼"); else alert("âŒ å¤±è´¥: " + res.status);
            } catch(e) { alert("âŒ é”™è¯¯: " + e.message); }
        }

        // --- è®°å¿†åº“ç®¡ç† ---
        function renderMemoryList() {
            const list = document.getElementById('memory-list');
            list.innerHTML = '';
            state.memories.forEach((m, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div style="flex:1; font-size:14px;">${m}</div><div style="color:red; padding-left:15px;" onclick="delMem(${i})">Ã—</div>`;
                list.appendChild(d);
            });
        }
        function addMemory() {
            const t = prompt("è¾“å…¥æ–°è®°å¿†:");
            if(t) { state.memories.push(t); saveData(); renderMemoryList(); }
        }
        function delMem(i) {
            if(confirm("åˆ é™¤æ­¤æ¡è®°å¿†ï¼Ÿ")) { state.memories.splice(i, 1); saveData(); renderMemoryList(); }
        }

        // --- å›¾ç‰‡ä¸å¤‡ä»½ ---
        function handleImage(e) {
            const f = e.target.files[0]; if(!f) return;
            // é™åˆ¶å›¾ç‰‡å¤§å°ï¼Œé˜²æ­¢ LocalStorage å´©æºƒ
            if(f.size > 1024 * 1024) { // 1MB
                alert("å›¾ç‰‡å¤ªå¤§ï¼Œå»ºè®®ä¸Šä¼ å°äº1MBçš„å›¾ç‰‡");
            }
            const r = new FileReader();
            r.onload = (ev) => { 
                currentImgBase64 = ev.target.result; 
                document.getElementById('preview-thumb').src = currentImgBase64; 
                document.getElementById('img-preview').style.display = 'flex';
            };
            r.readAsDataURL(f);
        }
        function clearImage() { currentImgBase64 = null; document.getElementById('img-preview').style.display = 'none'; }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `aios_backup_${Date.now()}.json`;
            a.click();
        }
        function importData(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try { state = JSON.parse(ev.target.result); saveData(); location.reload(); } catch(e){ alert("æ–‡ä»¶æ— æ•ˆ"); }
            };
            r.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
