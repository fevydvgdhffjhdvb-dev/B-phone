<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#eef2f3">
    <title>AI OS 4.0</title>
    <style>
        /* --- å…¨å±€å˜é‡ä¸é‡ç½® --- */
        :root {
            --app-bg: #f2f4f6;
            --dock-bg: rgba(255, 255, 255, 0.6);
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #1c1c1e;
            --blue: #007AFF;
            --red: #FF3B30;
            --green: #34C759;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; }
        body { margin: 0; width: 100vw; height: 100dvh; background: linear-gradient(160deg, #eef2f3 0%, #d9e4f5 100%); overflow: hidden; color: var(--text-main); }

        /* --- ä¸»å±å¹• --- */
        #home-screen { width: 100%; height: 100%; padding: calc(var(--safe-top) + 40px) 24px 120px 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* Widgets */
        .widget { background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 22px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); position: relative; overflow: hidden; }
        .widget.wide { height: 150px; display: flex; flex-direction: column; justify-content: space-between; }
        .widget-date { font-size: 13px; font-weight: 600; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; }
        .widget-time { font-size: 46px; font-weight: 300; color: #000; line-height: 1; }
        .widget-row { display: flex; gap: 15px; width: 100%; }
        .widget.square { flex: 1; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 5px; }
        
        /* Icons */
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; margin-top: 10px; }
        .app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: 0.1s; }
        .app-item:active { transform: scale(0.95); opacity: 0.8; }
        .app-icon { width: 62px; height: 62px; border-radius: 16px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .icon-chat { background: linear-gradient(135deg, #6DD5FA, #2980B9); color: white; }
        .icon-mem { background: linear-gradient(135deg, #FF9A9E, #FECFEF); color: white; }
        .icon-set { background: linear-gradient(135deg, #a8edea, #fed6e3); color: white; }
        .app-name { font-size: 11px; color: #333; font-weight: 500; }

        /* Dock */
        .dock { position: fixed; bottom: calc(var(--safe-bottom) + 20px); left: 20px; right: 20px; height: 90px; background: var(--dock-bg); backdrop-filter: blur(25px); border-radius: 32px; display: flex; align-items: center; justify-content: space-around; padding: 0 10px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4); }

        /* --- APP å®¹å™¨ --- */
        .app-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); display: flex; flex-direction: column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
        .app-screen.active { transform: translateY(0); }
        
        /* å¯¼èˆªæ  */
        .nav-bar { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 202; }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { color: var(--blue); background: none; border: none; font-size: 16px; padding: 8px; cursor: pointer; }
        .nav-btn:active { opacity: 0.5; }

        /* --- åˆ—è¡¨é€šç”¨æ ·å¼ --- */
        .ios-list { padding: 20px 15px; overflow-y: auto; flex: 1; background: #f2f2f7; }
        .list-group { background: #fff; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .list-item { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid #eee; background: #fff; font-size: 16px; }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background: #f9f9f9; }
        .clean-input { border: none; outline: none; width: 100%; font-size: 16px; background: transparent; color: #000; }
        .list-header { font-size: 12px; color: #666; margin: 0 0 6px 15px; text-transform: uppercase; }

        /* --- èŠå¤©ç•Œé¢ --- */
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .msg-row { display: flex; gap: 10px; max-width: 100%; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .bubble { background: #f2f2f7; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .bubble { background: var(--blue); color: #fff; border-bottom-right-radius: 4px; }
        
        /* åº•éƒ¨è¾“å…¥æ  */
        .input-area { position: absolute; bottom: var(--safe-bottom); width: 100%; background: #f9f9f9; border-top: 0.5px solid #ccc; padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; z-index: 202; }
        .input-box { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 9px 12px; font-size: 16px; outline: none; max-height: 100px; background: #fff; }
        .btn-round { width: 34px; height: 34px; border-radius: 50%; background: #eee; color: var(--blue); display: flex; align-items: center; justify-content: center; border: none; font-size: 18px; flex-shrink: 0; }
        .btn-send { color: var(--blue); background: none; border: none; font-weight: 700; font-size: 16px; padding: 0 10px; margin-bottom: 8px; }

        /* --- ä¾§è¾¹æ  Drawer --- */
        .drawer-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .drawer-overlay.show { opacity: 1; pointer-events: auto; }
        .drawer { position: absolute; top:0; right:0; width: 85%; height: 100%; background: #f2f2f7; z-index: 301; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); padding-top: var(--safe-top); display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.1); }
        .drawer.show { transform: translateX(0); }

        /* --- æ¨¡æ€æ¡† Modal --- */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 80%; background: #fff; border-radius: 14px; padding: 20px; text-align: center; animation: popIn 0.2s; }
        @keyframes popIn { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        /* è¾…åŠ©ç±» */
        .img-preview { display: none; padding: 5px 15px; background: #eee; font-size: 12px; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <!-- 1. ä¸»å±å¹• -->
    <div id="home-screen">
        <div class="widget wide">
            <div class="widget-date" id="widget-date">Wait...</div>
            <div class="widget-time" id="widget-time">00:00</div>
            <div style="font-size:14px; color:var(--blue); font-weight:500;">= 0 w 0 =</div>
        </div>
        <div class="widget-row">
            <div class="widget square"><span style="font-size:30px;">ğŸ¾</span><span style="font-size:12px;color:#888;">Kitten</span></div>
            <div class="widget square" style="padding:0;"><img src="https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400" style="width:100%;height:100%;object-fit:cover;opacity:0.9;"></div>
        </div>

        <div class="app-grid">
            <div class="app-item" onclick="openApp('app-settings')"><div class="app-icon icon-set">âš™ï¸</div><span class="app-name">è®¾ç½®</span></div>
            <div class="app-item"><div class="app-icon" style="background:#fff;">ğŸ“·</div><span class="app-name">ç›¸å†Œ</span></div>
            <div class="app-item" onclick="openApp('app-memory')"><div class="app-icon icon-mem">ğŸ§ </div><span class="app-name">è®°å¿†åº“</span></div>
            <div class="app-item"><div class="app-icon" style="background:#e0e0e0;">ğŸµ</div><span class="app-name">éŸ³ä¹</span></div>
        </div>
    </div>

    <!-- 2. åº•éƒ¨ Dock -->
    <div class="dock">
        <div class="app-item" onclick="openApp('app-chat-list')"><div class="app-icon icon-chat">ğŸ’¬</div></div>
        <div class="app-item" onclick="openApp('app-memory')"><div class="app-icon icon-mem">ğŸ“’</div></div>
        <div class="app-item" onclick="openApp('app-settings')"><div class="app-icon icon-set">âš™ï¸</div></div>
    </div>

    <!-- ================= APP é¡µé¢ ================= -->

    <!-- A. èŠå¤©åˆ—è¡¨ -->
    <div id="app-chat-list" class="app-screen">
        <div class="nav-bar"><button class="nav-btn" onclick="closeApp('app-chat-list')">å…³é—­</button><span class="nav-title">æ¶ˆæ¯</span><button class="nav-btn" onclick="showModal('modal-create-contact')">ï¼‹</button></div>
        <div class="ios-list" id="contact-list"></div>
    </div>

    <!-- B. èŠå¤©å®¤ -->
    <div id="app-chat-room" class="app-screen" style="z-index:210;">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeApp('app-chat-room')">è¿”å›</button>
            <span class="nav-title" id="chat-title">Chat</span>
            <button class="nav-btn" onclick="toggleDrawer()">â‰¡</button>
        </div>
        <div class="chat-box" id="msg-container"></div>
        
        <!-- å›¾ç‰‡é¢„è§ˆæ¡ -->
        <div id="img-preview" class="img-preview">
            <img id="preview-thumb" src="" style="width:30px; height:30px; border-radius:4px; object-fit:cover;">
            <span>å›¾ç‰‡å·²æ·»åŠ </span>
            <span style="color:red; margin-left:auto;" onclick="clearImage()">âœ•</span>
        </div>

        <!-- è¾“å…¥æ  -->
        <div class="input-area">
            <button class="btn-round" onclick="document.getElementById('upload-img-chat').click()">ï¼‹</button>
            <input type="file" id="upload-img-chat" hidden accept="image/*" onchange="handleImageSelect(event)">
            
            <textarea id="chat-input" class="input-box" rows="1" placeholder="å‘æ¶ˆæ¯..." oninput="autoResize(this)"></textarea>
            
            <!-- ä¸¤ä¸ªå‘é€æŒ‰é’® -->
            <button class="btn-round" style="color:var(--blue); font-size:14px; font-weight:bold;" onclick="handleSend(false)">ğŸ’¬+</button>
            <button class="btn-send" onclick="handleSend(true)">â¤</button>
        </div>

        <!-- ä¾§è¾¹æ  Drawer -->
        <div class="drawer-overlay" id="drawer-mask" onclick="toggleDrawer()"></div>
        <div class="drawer" id="chat-drawer">
            <div class="nav-bar"><span class="nav-title" style="margin-left:15px;">è¯¦ç»†è®¾å®š</span><button class="nav-btn" onclick="toggleDrawer()">å®Œæˆ</button></div>
            <div class="ios-list">
                <div class="list-header">AI è®¾å®š (å¯¹æ–¹)</div>
                <div style="background:#fff; padding:20px; display:flex; flex-direction:column; align-items:center; margin-bottom:20px; border-radius:10px;">
                    <img id="drawer-ai-av" src="" style="width:70px; height:70px; border-radius:50%; border:2px solid #eee; object-fit:cover;">
                    <button class="nav-btn" onclick="document.getElementById('file-ai-av').click()">æ›´æ¢å¤´åƒ</button>
                    <input type="file" id="file-ai-av" hidden onchange="updateAvatar('ai', event)">
                </div>
                <div class="list-group">
                    <div class="list-item"><span>å¤‡æ³¨å</span><input id="drawer-remark" class="clean-input" style="text-align:right;" placeholder="AIåå­—"></div>
                    <div class="list-item" style="flex-direction:column; align-items:flex-start;">
                        <span style="font-size:12px; color:#888; margin-bottom:5px;">äººè®¾ Prompt</span>
                        <textarea id="drawer-persona" style="width:100%; border:none; outline:none; height:80px; resize:none;"></textarea>
                    </div>
                </div>

                <div class="list-header">ç”¨æˆ·è®¾å®š (ä½ )</div>
                <div class="list-group">
                    <div class="list-item">
                        <span>ä½ çš„å¤´åƒ</span>
                        <img id="drawer-user-av" src="" style="width:30px;height:30px;border-radius:50%;" onclick="document.getElementById('file-user-av').click()">
                        <input type="file" id="file-user-av" hidden onchange="updateAvatar('user', event)">
                    </div>
                    <div class="list-item"><span>ä½ çš„æ˜µç§°</span><input id="drawer-username" class="clean-input" style="text-align:right;" placeholder="ä½ "></div>
                </div>

                <div class="list-group">
                    <div class="list-item" onclick="openSummaryModal()" style="color:var(--blue); justify-content:center;">âœ¨ æ™ºèƒ½æ€»ç»“</div>
                    <div class="list-item" onclick="clearChatHistory()" style="color:var(--red); justify-content:center;">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</div>
                </div>
            </div>
        </div>
    </div>

    <!-- C. è®°å¿†åº“ -->
    <div id="app-memory" class="app-screen">
        <div class="nav-bar"><button class="nav-btn" onclick="closeApp('app-memory')">å…³é—­</button><span class="nav-title">è®°å¿†ç¢ç‰‡</span><button class="nav-btn" onclick="addMemory()">ï¼‹</button></div>
        <div class="ios-list" id="memory-list"></div>
    </div>

    <!-- D. è®¾ç½® -->
    <div id="app-settings" class="app-screen">
        <div class="nav-bar"><button class="nav-btn" onclick="closeApp('app-settings')">å…³é—­</button><span class="nav-title">è®¾ç½®</span><div style="width:30px;"></div></div>
        <div class="ios-list">
            <div class="list-header">API é…ç½®é¢„è®¾</div>
            <div class="list-group">
                <div class="list-item">
                    <span>åŠ è½½é¢„è®¾</span>
                    <select id="preset-select" style="border:none; outline:none; background:transparent; text-align:right;" onchange="loadPreset()">
                        <option value="">é€‰æ‹©é¢„è®¾...</option>
                    </select>
                </div>
                <div class="list-item" onclick="showModal('modal-save-preset')" style="color:var(--blue); justify-content:center;">ğŸ“¥ ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾</div>
            </div>

            <div class="list-header">å½“å‰è¿æ¥å‚æ•°</div>
            <div class="list-group">
                <div class="list-item"><input id="cfg-url" class="clean-input" placeholder="https://api.openai.com/v1"></div>
                <div class="list-item"><input id="cfg-key" type="password" class="clean-input" placeholder="sk-xxxxxxxx"></div>
                <div class="list-item"><input id="cfg-model" class="clean-input" placeholder="gpt-3.5-turbo"></div>
                <div class="list-item" style="display:flex; gap:10px;">
                    <button class="nav-btn" style="flex:1; background:#f2f2f7; border-radius:8px;" onclick="testConnection()">ğŸ“¶ æµ‹è¯•è¿æ¥</button>
                    <button class="nav-btn" style="flex:1; background:#f2f2f7; border-radius:8px;" onclick="fetchModels()">ğŸ“¡ æ‹‰å–æ¨¡å‹</button>
                </div>
            </div>

            <div class="list-header">æ¨¡å‹å‚æ•°</div>
            <div class="list-group">
                <div class="list-item"><span>æ¸©åº¦ (Creativity) <b id="disp-temp">0.7</b></span><input type="range" id="cfg-temp" min="0" max="2" step="0.1" value="0.7" oninput="updateConfigVal('temp', this.value)"></div>
                <div class="list-item"><span>æ—¶é—´æ„ŸçŸ¥</span><input type="checkbox" id="cfg-time" onchange="updateConfigVal('timeAware', this.checked)"></div>
            </div>

            <div class="list-group">
                <div class="list-item" onclick="saveDataToFile()">ğŸ“¤ å¤‡ä»½æ•°æ®</div>
                <div class="list-item" style="position:relative;">ğŸ“¥ æ¢å¤æ•°æ®<input type="file" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;" onchange="loadDataFromFile(event)"></div>
            </div>
        </div>
    </div>

    <!-- ================= æ¨¡æ€æ¡† ================= -->
    
    <!-- æ–°å»ºè”ç³»äºº -->
    <div id="modal-create-contact" class="modal-mask">
        <div class="modal-box">
            <h3>æ–°æœ‹å‹</h3>
            <input id="new-contact-name" class="clean-input" style="border:1px solid #ddd; padding:10px; border-radius:8px; margin:15px 0;" placeholder="è¯·è¾“å…¥åå­—">
            <div style="display:flex; gap:10px;">
                <button class="nav-btn" style="flex:1; color:#888;" onclick="closeModal('modal-create-contact')">å–æ¶ˆ</button>
                <button class="nav-btn" style="flex:1; font-weight:bold;" onclick="createContact()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜é¢„è®¾ -->
    <div id="modal-save-preset" class="modal-mask">
        <div class="modal-box">
            <h3>ä¿å­˜é…ç½®é¢„è®¾</h3>
            <input id="preset-name" class="clean-input" style="border:1px solid #ddd; padding:10px; border-radius:8px; margin:15px 0;" placeholder="èµ·ä¸ªåå­— (å¦‚: DeepSeek)">
            <div style="display:flex; gap:10px;">
                <button class="nav-btn" style="flex:1; color:#888;" onclick="closeModal('modal-save-preset')">å–æ¶ˆ</button>
                <button class="nav-btn" style="flex:1; font-weight:bold;" onclick="savePreset()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ€»ç»“ -->
    <div id="modal-summary" class="modal-mask">
        <div class="modal-box">
            <h3>âœ¨ æå–è®°å¿†</h3>
            <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin:15px 0;">
                <input id="sum-start" type="number" class="clean-input" style="width:50px; text-align:center; border-bottom:1px solid #ccc;" placeholder="1">
                <span>è‡³</span>
                <input id="sum-end" type="number" class="clean-input" style="width:50px; text-align:center; border-bottom:1px solid #ccc;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="nav-btn" style="flex:1; color:#888;" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
                <button id="btn-do-sum" class="nav-btn" style="flex:1; font-weight:bold;" onclick="doSummarize()">å¼€å§‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ•°æ®ä¸­å¿ƒ ---
        const defaultData = {
            config: { url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo", temp: 0.7, timeAware: false },
            presets: [], // {name, url, key, model}
            contacts: [],
            memories: []
        };
        let state = { ...defaultData };
        let currentContactId = null;
        let currentImage = null;

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            const saved = localStorage.getItem('aios_v4');
            if(saved) state = JSON.parse(saved);
            
            // é»˜è®¤è”ç³»äºº
            if(state.contacts.length === 0) createContact("AI åŠ©æ‰‹", true);
            
            updateClock(); setInterval(updateClock, 1000);
            renderPresets();
        };

        function saveData() { localStorage.setItem('aios_v4', JSON.stringify(state)); }

        // --- å¯¼èˆªé€»è¾‘ ---
        function openApp(id) {
            document.getElementById(id).classList.add('active');
            if(id === 'app-chat-list') renderContactList();
            if(id === 'app-memory') renderMemoryList();
            if(id === 'app-settings') loadConfigUI();
        }
        function closeApp(id) { document.getElementById(id).classList.remove('active'); }
        function showModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleDrawer() {
            const d = document.getElementById('chat-drawer');
            const m = document.getElementById('drawer-mask');
            const isOpen = d.classList.contains('show');
            d.classList.toggle('show', !isOpen);
            m.classList.toggle('show', !isOpen);
            if(!isOpen) loadDrawerData();
        }

        // --- åŠŸèƒ½é€»è¾‘ ---

        // 1. æ—¶é’Ÿ Widget
        function updateClock() {
            const now = new Date();
            document.getElementById('widget-time').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const m = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
            document.getElementById('widget-date').innerText = `${m[now.getMonth()]} ${now.getDate()}`;
        }

        // 2. èŠå¤©åˆ—è¡¨ä¸åˆ›å»º
        function createContact(nameArg=null, silent=false) {
            const name = nameArg || document.getElementById('new-contact-name').value;
            if(!name) return;
            const newC = {
                id: Date.now().toString(),
                name: name,
                remark: "",
                persona: "ä½ æ˜¯ä¸€ä¸ªä½“è´´çš„AIåŠ©æ‰‹ã€‚",
                aiAvatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                messages: []
            };
            state.contacts.push(newC);
            saveData();
            if(!silent) {
                closeModal('modal-create-contact');
                document.getElementById('new-contact-name').value = "";
                renderContactList();
            }
        }
        function renderContactList() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            state.contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${c.aiAvatar}" style="width:44px; height:44px; border-radius:50%; background:#eee;">
                        <div>
                            <div style="font-weight:600;">${c.remark || c.name}</div>
                            <div style="font-size:13px; color:#888;">${c.messages.length} æ¡æ¶ˆæ¯</div>
                        </div>
                    </div>
                    <span style="color:#ccc;">â€º</span>
                `;
                div.onclick = () => enterChat(c.id);
                list.appendChild(div);
            });
        }

        // 3. èŠå¤©å®¤æ ¸å¿ƒ (å·²é‡æ„å‘é€é€»è¾‘)
        function enterChat(id) {
            currentContactId = id;
            const c = state.contacts.find(x => x.id === id);
            document.getElementById('chat-title').innerText = c.remark || c.name;
            renderMessages();
            openApp('app-chat-room');
        }

        function renderMessages() {
            const c = state.contacts.find(x => x.id === currentContactId);
            const box = document.getElementById('msg-container');
            box.innerHTML = '';
            c.messages.forEach(msg => {
                const isUser = msg.role === 'user';
                const row = document.createElement('div');
                row.className = `msg-row ${isUser ? 'right' : 'left'}`;
                const avatarSrc = isUser ? c.userAvatar : c.aiAvatar;
                
                const imgHtml = msg.image ? `<img src="${msg.image}" style="max-width:100%; border-radius:10px; margin-bottom:5px; display:block;">` : '';
                
                row.innerHTML = `
                    <img src="${avatarSrc}" class="avatar">
                    <div class="bubble">${imgHtml}${msg.content.replace(/\n/g, '<br>')}</div>
                `;
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function handleSend(triggerAI) {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            const c = state.contacts.find(x => x.id === currentContactId);
            
            // 1. ç”¨æˆ·æ¶ˆæ¯å¤„ç†
            if (text || currentImage) {
                // æ£€æŸ¥ Key
                if(triggerAI && !state.config.key) { alert("âš ï¸ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Keyï¼"); return; }

                const msg = {
                    role: 'user',
                    content: text,
                    image: currentImage,
                    timestamp: new Date().getTime()
                };
                c.messages.push(msg);
                saveData();
                renderMessages();
                
                // æ¸…ç†è¾“å…¥æ¡†
                input.value = '';
                input.style.height = 'auto';
                clearImage();
            } else {
                // å¦‚æœæ²¡å†…å®¹ï¼Œä½†ç‚¹å‡»äº†å‘é€ï¼Œä¸”è§¦å‘AIä¸ºçœŸï¼Œåˆ™æ£€æŸ¥æ˜¯å¦åº”è¯¥åŸºäºå†å²å›å¤
                if(!triggerAI) return; // æ²¡å†…å®¹ä¸”ä¸è§¦å‘AIï¼Œæ— è§†
                if(c.messages.length === 0) return;
            }

            // 2. è§¦å‘ AI å›å¤
            if (triggerAI) {
                // æ„å»º System Prompt (åŒ…å«ç”¨æˆ·è®¾å®š)
                let sys = `${c.persona}\n[User Info] Name: ${c.userName}.`;
                if(state.config.timeAware) sys += `\n[Time] ${new Date().toLocaleString()}`;
                if(state.memories.length) sys += `\n[Memories] ${state.memories.join('; ')}`;

                const messages = [{role: 'system', content: sys}];
                // ä¸Šä¸‹æ–‡
                const history = c.messages.slice(-10);
                history.forEach(m => {
                    if(m.image) {
                        messages.push({
                            role: m.role,
                            content: [
                                {type: "text", text: m.content || " "},
                                {type: "image_url", image_url: {url: m.image}}
                            ]
                        });
                    } else {
                        messages.push({role: m.role, content: m.content});
                    }
                });

                // UI å ä½
                const box = document.getElementById('msg-container');
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'msg-row left';
                loadingDiv.innerHTML = `<img src="${c.aiAvatar}" class="avatar"><div class="bubble" style="color:#888;">...</div>`;
                box.appendChild(loadingDiv);
                box.scrollTop = box.scrollHeight;

                try {
                    const res = await fetch(state.config.url + '/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.config.key },
                        body: JSON.stringify({
                            model: state.config.model,
                            messages: messages,
                            temperature: parseFloat(state.config.temp),
                            stream: true
                        })
                    });

                    if(!res.ok) throw new Error("API Error: " + res.status);

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = "";
                    const bubble = loadingDiv.querySelector('.bubble');
                    bubble.style.color = "#000";

                    while(true) {
                        const {done, value} = await reader.read();
                        if(done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for(const line of lines) {
                            if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(line.slice(6));
                                    const delta = json.choices[0].delta.content || "";
                                    fullText += delta;
                                    bubble.innerHTML = fullText.replace(/\n/g, '<br>');
                                    box.scrollTop = box.scrollHeight;
                                } catch(e){}
                            }
                        }
                    }
                    // ä¿å­˜ AI æ¶ˆæ¯
                    c.messages.push({ role: 'assistant', content: fullText });
                    saveData();
                } catch(e) {
                    loadingDiv.querySelector('.bubble').innerText = "ğŸš« é”™è¯¯: " + e.message;
                    loadingDiv.querySelector('.bubble').style.color = "red";
                }
            }
        }

        // 4. ä¾§è¾¹æ è®¾å®š
        function loadDrawerData() {
            const c = state.contacts.find(x => x.id === currentContactId);
            document.getElementById('drawer-ai-av').src = c.aiAvatar;
            document.getElementById('drawer-remark').value = c.remark;
            document.getElementById('drawer-persona').value = c.persona;
            document.getElementById('drawer-user-av').src = c.userAvatar;
            document.getElementById('drawer-username').value = c.userName;

            // å®æ—¶ä¿å­˜ç›‘å¬
            ['drawer-remark', 'drawer-persona', 'drawer-username'].forEach(id => {
                document.getElementById(id).oninput = () => {
                    if(id === 'drawer-remark') c.remark = document.getElementById(id).value;
                    if(id === 'drawer-persona') c.persona = document.getElementById(id).value;
                    if(id === 'drawer-username') c.userName = document.getElementById(id).value;
                    saveData();
                    document.getElementById('chat-title').innerText = c.remark || c.name;
                };
            });
        }
        function updateAvatar(type, e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const c = state.contacts.find(x => x.id === currentContactId);
                if(type === 'ai') { c.aiAvatar = ev.target.result; document.getElementById('drawer-ai-av').src = c.aiAvatar; }
                else { c.userAvatar = ev.target.result; document.getElementById('drawer-user-av').src = c.userAvatar; }
                saveData();
                renderMessages(); // åˆ·æ–°èŠå¤©é‡Œçš„å¤´åƒ
            };
            r.readAsDataURL(f);
        }
        function clearChatHistory() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿä¸å¯æ¢å¤ã€‚')) {
                state.contacts.find(x => x.id === currentContactId).messages = [];
                saveData();
                renderMessages();
                toggleDrawer();
            }
        }

        // 5. è®°å¿†åº“ (å®æ—¶æ›´æ–°)
        function renderMemoryList() {
            const list = document.getElementById('memory-list');
            list.innerHTML = '';
            state.memories.forEach((m, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div style="flex:1; font-size:14px; line-height:1.4;">${m}</div><div style="color:var(--red); font-weight:bold; padding:0 10px;" onclick="delMemory(${i})">Ã—</div>`;
                list.appendChild(d);
            });
        }
        function addMemory() {
            const t = prompt("è¾“å…¥æ–°çš„è®°å¿†å†…å®¹:");
            if(t) { state.memories.push(t); saveData(); renderMemoryList(); }
        }
        function delMemory(i) {
            if(confirm("åˆ é™¤è¿™æ¡è®°å¿†ï¼Ÿ")) { state.memories.splice(i, 1); saveData(); renderMemoryList(); }
        }
        function openSummaryModal() {
            document.getElementById('sum-end').value = state.contacts.find(x => x.id === currentContactId).messages.length;
            showModal('modal-summary');
        }
        async function doSummarize() {
            const btn = document.getElementById('btn-do-sum');
            btn.innerText = "åˆ†æä¸­...";
            const s = parseInt(document.getElementById('sum-start').value) - 1;
            const e = parseInt(document.getElementById('sum-end').value);
            const c = state.contacts.find(x => x.id === currentContactId);
            const txt = c.messages.slice(s, e).map(m => `${m.role}: ${m.content}`).join('\n');

            try {
                const res = await fetch(state.config.url + '/chat/completions', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + state.config.key, 'Content-Type': 'application/json'},
                    body: JSON.stringify({model: state.config.model, messages: [{role:'system', content:'æ€»ç»“æ ¸å¿ƒ'}, {role:'user', content: txt}]})
                });
                const d = await res.json();
                const sum = d.choices[0].message.content;
                state.memories.push(sum);
                saveData();
                alert("âœ… è®°å¿†å·²æå–ï¼");
                closeModal('modal-summary');
                toggleDrawer();
                // å…³é”®ï¼šå¦‚æœè®°å¿†åº“ App å·²ç»åœ¨åå°æ‰“å¼€ï¼Œä¹Ÿéœ€è¦åˆ·æ–°å®ƒï¼Œæˆ–è€…ä¸‹æ¬¡æ‰“å¼€åˆ·æ–°
            } catch(e) { alert("å¤±è´¥: " + e.message); }
            btn.innerText = "å¼€å§‹";
        }

        // 6. è®¾ç½®ä¸é…ç½®é¢„è®¾
        function loadConfigUI() {
            document.getElementById('cfg-url').value = state.config.url;
            document.getElementById('cfg-key').value = state.config.key;
            document.getElementById('cfg-model').value = state.config.model;
            document.getElementById('cfg-temp').value = state.config.temp;
            document.getElementById('disp-temp').innerText = state.config.temp;
            document.getElementById('cfg-time').checked = state.config.timeAware;
            
            // ä¿å­˜é…ç½®ç›‘å¬
            ['cfg-url', 'cfg-key', 'cfg-model'].forEach(id => {
                document.getElementById(id).oninput = () => {
                    state.config.url = document.getElementById('cfg-url').value;
                    state.config.key = document.getElementById('cfg-key').value;
                    state.config.model = document.getElementById('cfg-model').value;
                    saveData();
                };
            });
        }
        function updateConfigVal(key, val) {
            state.config[key] = val;
            if(key === 'temp') document.getElementById('disp-temp').innerText = val;
            saveData();
        }

        // é¢„è®¾åŠŸèƒ½
        function savePreset() {
            const name = document.getElementById('preset-name').value;
            if(!name) return;
            state.presets.push({
                name: name,
                url: state.config.url,
                key: state.config.key,
                model: state.config.model
            });
            saveData();
            renderPresets();
            closeModal('modal-save-preset');
            alert(`é…ç½® "${name}" å·²ä¿å­˜`);
        }
        function renderPresets() {
            const sel = document.getElementById('preset-select');
            sel.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾...</option>';
            state.presets.forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = p.name;
                sel.appendChild(opt);
            });
        }
        function loadPreset() {
            const idx = document.getElementById('preset-select').value;
            if(idx === "") return;
            const p = state.presets[idx];
            state.config.url = p.url;
            state.config.key = p.key;
            state.config.model = p.model;
            saveData();
            loadConfigUI(); // åˆ·æ–° UI
        }

        // æµ‹è¯•ä¸æ‹‰å–
        async function testConnection() {
            if(!state.config.key) return alert("è¯·å¡«å†™ Key");
            try {
                const res = await fetch(state.config.url + '/models', { headers: {'Authorization': 'Bearer ' + state.config.key} });
                if(res.ok) alert("âœ… è¿æ¥æˆåŠŸï¼"); else alert("âŒ å¤±è´¥: " + res.status);
            } catch(e) { alert("âŒ é”™è¯¯: " + e.message); }
        }
        async function fetchModels() {
             if(!state.config.key) return alert("è¯·å¡«å†™ Key");
             try {
                const res = await fetch(state.config.url + '/models', { headers: {'Authorization': 'Bearer ' + state.config.key} });
                const d = await res.json();
                const names = d.data.map(m => m.id).join('\n');
                alert("å‘ç°æ¨¡å‹:\n" + names + "\n\nè¯·æ‰‹åŠ¨å¤åˆ¶å¡«å…¥æ¨¡å‹IDæ¡†");
             } catch(e) { alert("âŒ æ‹‰å–å¤±è´¥: " + e.message); }
        }

        // å¤‡ä»½æ¢å¤
        function saveDataToFile() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'}));
            a.download = `aios_backup.json`;
            a.click();
        }
        function loadDataFromFile(e) {
            const r = new FileReader();
            r.onload = (ev) => { try { state = JSON.parse(ev.target.result); saveData(); location.reload(); } catch(e){ alert('æ–‡ä»¶æŸå'); } };
            r.readAsText(e.target.files[0]);
        }

        // è¾…åŠ©
        function autoResize(el) { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
        function handleImageSelect(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => { currentImage = ev.target.result; document.getElementById('preview-thumb').src=currentImage; document.getElementById('img-preview').style.display='flex'; };
            r.readAsDataURL(f);
        }
        function clearImage() { currentImage = null; document.getElementById('img-preview').style.display='none'; }
    </script>
</body>
</html>
