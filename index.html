<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bjphone">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>My AI Phone</title>
    
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            background-color: #222; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            overflow: hidden; 
        }

        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #000; 
            border-radius: 45px; 
            box-shadow: 0 0 0 8px #333, 0 20px 50px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden; 
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .phone-frame { width: 100%; height: 100%; border-radius: 0; box-shadow: none; border: none; }
        }

        /* --- é¡µé¢åˆ‡æ¢ç³»ç»Ÿ --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            z-index: 10;
        }
        /* æ¿€æ´»çŠ¶æ€çš„é¡µé¢ */
        .page.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  (é€šç”¨) */
        .status-bar {
            height: 44px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px;
            font-size: 14px; font-weight: 600; color: inherit;
            z-index: 100;
            position: absolute; top: 0; left: 0;
        }

        /* --- 1. æ¡Œé¢ (Home Screen) --- */
        #page-home {
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop') no-repeat center center/cover;
            color: white;
            justify-content: flex-start;
        }
        .home-clock-widget {
            margin-top: 120px; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .clock-time { font-size: 72px; font-weight: 200; letter-spacing: -2px; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; font-weight: 500; }

        .app-grid {
            margin-top: auto; margin-bottom: 40px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            margin-left: 15px; margin-right: 15px;
        }
        .app-icon-container { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .app-icon-container:active { transform: scale(0.9); }
        .app-icon {
            width: 58px; height: 58px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        /* App é¢œè‰² */
        .icon-msg { background: linear-gradient(to bottom, #34c759, #30b753); }
        .icon-note { background: linear-gradient(to bottom, #ffd60a, #ffcc00); }
        .icon-settings { background: linear-gradient(to bottom, #8e8e93, #636366); }

        /* --- é€šç”¨ App å¤´éƒ¨ --- */
        .app-header {
            height: 90px; padding-top: 44px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding-left: 15px; padding-right: 15px;
            background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .app-title { font-size: 28px; font-weight: bold; color: #000; }
        .btn-back { font-size: 16px; color: #007AFF; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;}

        /* --- 2. æ¶ˆæ¯åˆ—è¡¨ (Message List) --- */
        #page-msg-list { background: #fff; }
        .msg-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: 0.2s;
        }
        .msg-list-item:active { background: #f5f5f5; }
        .list-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; }
        .list-info { flex: 1; }
        .list-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .list-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .list-time { font-size: 12px; color: #c7c7cc; }

        /* --- 3. èŠå¤©ç•Œé¢ (Chat) å¤ç”¨å¤§éƒ¨åˆ†åŸæœ‰æ ·å¼ --- */
        #page-chat { background-color: #f2f2f7; }
        .chat-header-bar {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; background: rgba(248,249,250,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #dbdbdb; margin-top: 44px;
            flex-shrink: 0;
        }
        .chat-back-btn { color: #007AFF; font-size: 16px; border: none; background: none; display: flex; align-items: center; cursor: pointer; }
        .chat-contact-name { font-weight: 600; font-size: 16px; }
        .chat-action-btn { font-size: 20px; background: none; border: none; cursor: pointer; color: #007AFF;}
        
        /* åŸæœ‰çš„èŠå¤©æ ·å¼é€‚é… */
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; animation: fadeIn 0.3s; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); }
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .message { background: #fff; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .message { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* åº•éƒ¨è¾“å…¥æ  */
        .input-area { background: #f9f9f9; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px; }
        .input-toolbar { display: flex; align-items: center; gap: 10px; }
        #userInput { flex: 1; padding: 9px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #userInput:focus { border-color: #007AFF; }
        .btn-icon-send { font-size: 24px; background: none; border: none; cursor: pointer; color: #007AFF; padding: 0; }
        .btn-icon-send:disabled { color: #ccc; }
        .typing-indicator { display: inline-block; width: 4px; height: 4px; background: #999; border-radius: 50%; margin: 0 1px; animation: bounce 1s infinite; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; gap: 10px; font-size: 12px; }

        /* --- 4. å¤‡å¿˜å½• (Notes) & 5. è®¾ç½® (Settings) --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; }
        .ios-list { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 15px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; justify-content: space-between; }
        .ios-item:last-child { border-bottom: none; }
        .ios-label { font-size: 16px; font-weight: 500; width: 100px;}
        .ios-input { border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; background: transparent; width: 100%; }
        .ios-btn { width: 100%; padding: 14px; text-align: center; color: #007AFF; background: #fff; border: none; font-size: 16px; cursor: pointer; border-top: 1px solid #e5e5ea; }
        .ios-btn.danger { color: #ff3b30; }
        
        .memory-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; position: relative; font-size: 15px;}
        .btn-del-mem { position: absolute; top: 10px; right: 10px; color: #ff3b30; font-weight: bold; cursor: pointer; }

        /* å°éƒ¨ä»¶: åº•éƒ¨å°é»‘æ¡ */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: #000; border-radius: 10px; z-index: 999;
        }
        /* æ¡Œé¢æ¨¡å¼ä¸‹å°é»‘æ¡æ˜¯ç™½è‰²çš„ */
        #page-home .home-indicator { background: #fff; }

        /* å¼¹çª— */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:500; display:none; align-items:center; justify-content:center; }
        .modal-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); width: 80%; border-radius: 20px; padding: 20px; text-align: center; }
    </style>
</head>
<body>

    <div class="phone-frame">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  (Visual Only) -->
        <div class="status-bar" id="statusBar">
            <span id="sb-time">12:00</span>
            <span style="display:flex; gap:5px;">
                <span>ğŸ“¶</span>
                <span>ğŸ”‹</span>
            </span>
        </div>

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="goHome()"></div>

        <!-- ============ é¡µé¢ 1: æ¡Œé¢ (Home) ============ -->
        <div class="page active" id="page-home">
            <div class="home-clock-widget">
                <div class="clock-time" id="clockTime">12:00</div>
                <div class="clock-date" id="clockDate">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            </div>

            <div class="app-grid">
                <!-- çŸ­ä¿¡ App -->
                <div class="app-icon-container" onclick="navigateTo('page-msg-list')">
                    <div class="app-icon icon-msg">ğŸ’¬</div>
                    <div class="app-name">ä¿¡æ¯</div>
                </div>
                <!-- å¤‡å¿˜å½• App -->
                <div class="app-icon-container" onclick="navigateTo('page-memory')">
                    <div class="app-icon icon-note">ğŸ“</div>
                    <div class="app-name">è®°å¿†åº“</div>
                </div>
                <!-- è®¾ç½® App -->
                <div class="app-icon-container" onclick="navigateTo('page-settings')">
                    <div class="app-icon icon-settings">âš™ï¸</div>
                    <div class="app-name">è®¾ç½®</div>
                </div>
                <!-- è¿™é‡Œå¯ä»¥åŠ æ›´å¤šè£…é¥°æ€§å›¾æ ‡ -->
                <div class="app-icon-container">
                    <div class="app-icon" style="background:#007AFF">ğŸ“·</div>
                    <div class="app-name">ç›¸æœº</div>
                </div>
            </div>
        </div>

        <!-- ============ é¡µé¢ 2: æ¶ˆæ¯åˆ—è¡¨ (Message List) ============ -->
        <div class="page" id="page-msg-list">
            <div class="app-header">
                <button class="btn-back" onclick="goHome()">
                    <span>â€¹</span> æ¡Œé¢
                </button>
                <span class="app-title">ä¿¡æ¯</span>
                <span style="width: 50px;"></span> <!-- å ä½ -->
            </div>
            <div style="padding: 0;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è”ç³»äºº -->
                <div class="msg-list-item" onclick="navigateTo('page-chat')">
                    <img id="contact-avatar-preview" src="" class="list-avatar">
                    <div class="list-info">
                        <div class="list-name" id="contact-name-preview">AI Assistant</div>
                        <div class="list-preview" id="last-msg-preview">ç‚¹å‡»å¼€å§‹èŠå¤©...</div>
                    </div>
                    <div class="list-time">åˆšåˆš</div>
                </div>
            </div>
        </div>

        <!-- ============ é¡µé¢ 3: èŠå¤©çª—å£ (Chat) ============ -->
        <div class="page" id="page-chat">
            <!-- èŠå¤©ä¸“å± Header -->
            <div class="chat-header-bar">
                <button class="chat-back-btn" onclick="navigateTo('page-msg-list')">
                    <span style="font-size:24px; margin-right:5px;">â€¹</span> ä¿¡æ¯
                </button>
                <span class="chat-contact-name" id="chat-title-name">AI Bot</span>
                <button class="chat-action-btn" onclick="openSummaryModal()" title="æ€»ç»“">âœ¨</button>
            </div>

            <div class="chat-box" id="chatBox">
                <!-- æ¶ˆæ¯ä¼šæ’åœ¨è¿™é‡Œ -->
            </div>

            <div class="input-area">
                <div id="uploadPreview">
                    <img id="img-preview-blob" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                    <span>å·²é€‰æ‹©å›¾ç‰‡</span>
                    <span onclick="clearUpload()" style="color:red; margin-left:auto; cursor:pointer;">Ã—</span>
                </div>
                <div class="input-toolbar">
                    <button class="btn-icon-send" onclick="document.getElementById('fileInput').click()" style="color:#888;">âŠ•</button>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
                    
                    <input type="text" id="userInput" placeholder="iMessage" onkeypress="if(event.key==='Enter') sendMsg('user')">
                    
                    <button class="btn-icon-send" onclick="sendMsg('user')">â¬†</button>
                    <button class="btn-icon-send" id="btn-ai" onclick="triggerAI()" style="color:#5856D6">ğŸ¤–</button>
                </div>
            </div>
        </div>

        <!-- ============ é¡µé¢ 4: è®°å¿†åº“ (Memory) ============ -->
        <div class="page" id="page-memory">
            <div class="app-header">
                <button class="btn-back" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®°å¿†åº“</span>
                <button class="btn-back" onclick="addMemoryManual()" style="font-size:24px;">+</button>
            </div>
            <div class="content-scroll">
                <div class="ios-list">
                    <div class="ios-item">
                        <input type="text" id="newMemInput" class="ios-input" style="text-align:left;" placeholder="è¾“å…¥æ–°è®°å¿†...">
                    </div>
                </div>
                <div id="memoryListContainer">
                    <!-- è®°å¿†å¡ç‰‡ -->
                </div>
            </div>
        </div>

        <!-- ============ é¡µé¢ 5: è®¾ç½® (Settings) ============ -->
        <div class="page" id="page-settings">
            <div class="app-header">
                <button class="btn-back" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®¾ç½®</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <div style="font-size:13px; color:#666; margin: 10px 15px 5px;">è¿æ¥</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">API URL</span>
                        <input type="text" id="apiUrl" class="ios-input" placeholder="https://api.openai.com/v1" onchange="saveAll()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="apiKey" class="ios-input" placeholder="sk-..." onchange="saveAll()">
                    </div>
                    <button class="ios-btn" onclick="testConn()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div style="font-size:13px; color:#666; margin: 10px 15px 5px;">è§’è‰²èµ„æ–™</div>
                <div class="ios-list">
                    <div class="ios-item" onclick="document.getElementById('aiAvatarFile').click()">
                        <span class="ios-label">AI å¤´åƒ</span>
                        <img id="set-ai-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                        <input type="file" id="aiAvatarFile" hidden onchange="uploadAvatar(event, 'ai')">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">AI è®¾å®š</span>
                        <input type="text" id="sysPrompt" class="ios-input" placeholder="ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹..." onchange="saveAll()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æˆ‘çš„æ˜µç§°</span>
                        <input type="text" id="userName" class="ios-input" placeholder="User" onchange="saveAll()">
                    </div>
                    <div class="ios-item" onclick="document.getElementById('userAvatarFile').click()">
                        <span class="ios-label">æˆ‘çš„å¤´åƒ</span>
                        <img id="set-user-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                        <input type="file" id="userAvatarFile" hidden onchange="uploadAvatar(event, 'user')">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">èŠå¤©å£çº¸</span>
                        <button style="border:none; background:none; color:#007AFF" onclick="document.getElementById('bgFile').click()">æ›´æ¢</button>
                        <button style="border:none; background:none; color:red" onclick="resetBg()">é‡ç½®</button>
                        <input type="file" id="bgFile" hidden onchange="uploadBg(event)">
                    </div>
                </div>

                <div style="font-size:13px; color:#666; margin: 10px 15px 5px;">æ¨¡å‹å‚æ•°</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">æ¨¡å‹ ID</span>
                        <input type="text" id="modelId" class="ios-input" value="gpt-3.5-turbo" onchange="saveAll()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ¸©åº¦</span>
                        <input type="number" id="tempVal" class="ios-input" value="0.7" step="0.1" onchange="saveAll()">
                    </div>
                </div>

                <div class="ios-list">
                    <button class="ios-btn" onclick="exportData()">å¤‡ä»½æ•°æ® (ä¸‹è½½ JSON)</button>
                    <button class="ios-btn" onclick="document.getElementById('importFile').click()">æ¢å¤æ•°æ®</button>
                    <input type="file" id="importFile" hidden onchange="importData(event)">
                    <button class="ios-btn danger" onclick="clearChat()">æ¸…ç©ºèŠå¤©è®°å½•</button>
                </div>
            </div>
        </div>

        <!-- æ€»ç»“å¼¹çª— (Modal) -->
        <div class="modal-overlay" id="summaryModal">
            <div class="modal-box">
                <h3>ç”Ÿæˆæ€»ç»“</h3>
                <p style="font-size:12px; color:#666;">å°†æœ€è¿‘çš„å¯¹è¯å‹ç¼©æˆè®°å¿†</p>
                <button class="ios-btn" onclick="doSummarize()" style="border-radius:10px; border:1px solid #eee;">å¼€å§‹</button>
                <button class="ios-btn danger" onclick="document.getElementById('summaryModal').style.display='none'" style="border-radius:10px; border:1px solid #eee; margin-top:10px;">å–æ¶ˆ</button>
            </div>
        </div>

    </div>

    <script>
        // --- æ•°æ®ç®¡ç† ---
        let config = {
            aiName: "AI Bot",
            aiAvatar: "https://api.dicebear.com/7.x/bottts/svg?seed=Ai",
            userName: "Me",
            userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
            sysPrompt: "ä½ æ˜¯ä¸€ä¸ªé£è¶£çš„AIåŠ©æ‰‹ã€‚",
            apiUrl: "https://api.openai.com/v1",
            apiKey: "",
            model: "gpt-3.5-turbo",
            temp: 0.7
        };
        let messages = [];
        let memories = [];
        let currentImg = null;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            startClock();
            loadData();
            updateUI();
            renderChat();
            renderMemories();
        };

        // --- é¡µé¢å¯¼èˆªé€»è¾‘ ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // çŠ¶æ€æ é¢œè‰²é€‚é…
            const bar = document.getElementById('statusBar');
            if(pageId === 'page-home') {
                bar.style.color = 'white';
                document.querySelector('.home-indicator').style.backgroundColor = 'white';
            } else {
                bar.style.color = 'black';
                document.querySelector('.home-indicator').style.backgroundColor = 'black';
            }

            // å¦‚æœè¿›å…¥æ¶ˆæ¯åˆ—è¡¨ï¼Œåˆ·æ–°ä¸€ä¸‹é¢„è§ˆ
            if(pageId === 'page-msg-list') updateMsgListPreview();
            // å¦‚æœè¿›å…¥èŠå¤©ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
            if(pageId === 'page-chat') scrollToBottom();
        }

        function goHome() { navigateTo('page-home'); }

        // --- æ—¶é’Ÿé€»è¾‘ ---
        function startClock() {
            function update() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
                const dateStr = now.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'long'});
                document.getElementById('clockTime').innerText = timeStr;
                document.getElementById('clockDate').innerText = dateStr;
                document.getElementById('sb-time').innerText = timeStr;
            }
            setInterval(update, 1000);
            update();
        }

        // --- æ ¸å¿ƒèŠå¤©åŠŸèƒ½ ---
        function sendMsg(role) {
            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            if(!txt && !currentImg) return;
            
            if(role === 'user') {
                messages.push({ role: 'user', content: txt, image: currentImg });
                appendMsgUI('user', txt, currentImg);
                input.value = '';
                clearUpload();
                saveData();
                // è‡ªåŠ¨è§¦å‘ AI å¯é€‰ï¼Œè¿™é‡Œåšæˆæ‰‹åŠ¨ç‚¹å‡»æœºå™¨äººè§¦å‘ï¼Œæˆ–è€…ä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨ triggerAI()
            }
        }

        async function triggerAI() {
            if(!config.apiKey) { alert("è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ API Key"); navigateTo('page-settings'); return; }
            
            const btn = document.getElementById('btn-ai');
            btn.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';
            
            // æ„å»ºä¸Šä¸‹æ–‡
            let prompt = `${config.sysPrompt}\n[Time: ${new Date().toLocaleString()}]\n[User: ${config.userName}]`;
            if(memories.length) prompt += `\n[Memories]:\n${memories.join('\n')}`;

            let apiMsgs = [{role:"system", content: prompt}];
            // å–æœ€è¿‘10æ¡
            messages.slice(-10).forEach(m => {
                if(m.image) {
                    apiMsgs.push({role:m.role, content:[{type:"text",text:m.content||" "},{type:"image_url",image_url:{url:m.image}}]});
                } else {
                    apiMsgs.push({role:m.role, content:m.content});
                }
            });

            // UI é¢„ç•™
            const aiRow = appendMsgUI('assistant', '...', null, true); // true indicates temporary loading state
            let fullText = "";

            try {
                const res = await fetch(normalizeUrl(config.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + config.apiKey },
                    body: JSON.stringify({
                        model: config.model, messages: apiMsgs, temperature: parseFloat(config.temp), stream: true
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ',''));
                                const txt = json.choices[0].delta.content || "";
                                fullText += txt;
                                aiRow.innerHTML = formatText(fullText);
                                scrollToBottom();
                            } catch(e){}
                        }
                    }
                }
                messages.push({role:'assistant', content: fullText});
                saveData();
            } catch(e) {
                aiRow.innerText = "Error: " + e.message;
            }
            btn.innerHTML = 'ğŸ¤–';
        }

        // --- UI æ¸²æŸ“è¾…åŠ© ---
        function appendMsgUI(role, text, img, isTemp=false) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            const avatar = role==='user' ? config.userAvatar : config.aiAvatar;
            
            let html = `
                <img src="${avatar}" class="avatar">
                <div class="message">
                    ${img ? `<img src="${img}" style="max-width:100%;border-radius:8px;display:block;margin-bottom:5px;">` : ''}
                    <span class="txt-content">${isTemp ? text : formatText(text)}</span>
                </div>
            `;
            div.innerHTML = html;
            box.appendChild(div);
            scrollToBottom();
            if(isTemp) return div.querySelector('.txt-content');
        }

        function renderChat() {
            document.getElementById('chatBox').innerHTML = '<div style="text-align:center;font-size:12px;color:#999;margin:20px;">åŠ å¯†å¯¹è¯å·²å¼€å¯</div>';
            messages.forEach(m => appendMsgUI(m.role, m.content, m.image));
        }

        function updateMsgListPreview() {
            document.getElementById('contact-avatar-preview').src = config.aiAvatar;
            // å¦‚æœè®¾ç½®é‡Œæ²¡åå­—ï¼Œé»˜è®¤å« AI
            // è¿™é‡Œå‡è®¾ç”¨æˆ·åœ¨sysPrompté‡Œå®šä¹‰åå­—æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨å˜é‡æˆ–è€…é»˜è®¤å€¼
            document.getElementById('contact-name-preview').innerText = "My AI"; 
            document.getElementById('chat-title-name').innerText = "My AI";

            if(messages.length > 0) {
                const last = messages[messages.length-1];
                let txt = last.image ? '[å›¾ç‰‡]' : last.content;
                document.getElementById('last-msg-preview').innerText = txt;
            }
        }

        function formatText(text) {
            return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }

        function scrollToBottom() {
            const b = document.getElementById('chatBox');
            b.scrollTop = b.scrollHeight;
        }

        // --- æ–‡ä»¶å¤„ç† ---
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                currentImg = ev.target.result;
                document.getElementById('img-preview-blob').src = currentImg;
                document.getElementById('uploadPreview').style.display = 'flex';
            };
            r.readAsDataURL(f);
        }
        function clearUpload() { currentImg=null; document.getElementById('uploadPreview').style.display='none'; document.getElementById('fileInput').value=''; }

        async function uploadAvatar(e, type) {
            const f = e.target.files[0]; if(!f)return;
            const base64 = await compressImg(f);
            if(type==='ai') config.aiAvatar = base64;
            else config.userAvatar = base64;
            saveAll(); updateUI(); renderChat();
        }
        async function uploadBg(e) {
            const f = e.target.files[0]; if(!f)return;
            const base64 = await compressImg(f);
            localStorage.setItem('v9_bg', base64);
            document.getElementById('page-chat').style.backgroundImage = `url(${base64})`;
            document.getElementById('page-chat').style.backgroundSize = 'cover';
        }
        function resetBg() {
            localStorage.removeItem('v9_bg');
            document.getElementById('page-chat').style.backgroundImage = '';
        }
        function compressImg(file) {
            return new Promise(r => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = 150/img.width;
                        cvs.width = 150; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        r(cvs.toDataURL('image/jpeg', 0.7));
                    }
                }
            })
        }

        // --- è®°å¿†åº“é€»è¾‘ ---
        function renderMemories() {
            const c = document.getElementById('memoryListContainer'); c.innerHTML = '';
            memories.forEach((m, i) => {
                c.innerHTML += `
                    <div class="memory-card">
                        ${m}
                        <div class="btn-del-mem" onclick="memories.splice(${i},1);saveData();renderMemories()">Ã—</div>
                    </div>`;
            });
        }
        function addMemoryManual() {
            const i = document.getElementById('newMemInput');
            if(i.value) { memories.push(i.value); i.value=''; saveData(); renderMemories(); }
        }
        
        // --- æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() { document.getElementById('summaryModal').style.display='flex'; }
        async function doSummarize() {
            // ç®€åŒ–çš„æ€»ç»“é€»è¾‘
            const txt = messages.slice(-15).map(m=>m.role+":"+m.content).join('\n');
            try {
                const res = await fetch(normalizeUrl(config.apiUrl)+'/chat/completions', {
                    method:"POST", headers:{"Authorization":"Bearer "+config.apiKey, "Content-Type":"application/json"},
                    body: JSON.stringify({model:config.model, messages:[{role:"system",content:"Summarize conversation into one distinct fact."}, {role:"user",content:txt}]})
                });
                const d = await res.json();
                memories.push(d.choices[0].message.content);
                saveData(); renderMemories();
                document.getElementById('summaryModal').style.display='none';
                alert("è®°å¿†å·²æå–");
            } catch(e) { alert(e.message); }
        }

        // --- è®¾ç½® & æ•°æ®æŒä¹…åŒ– ---
        function saveAll() {
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.sysPrompt = document.getElementById('sysPrompt').value;
            config.userName = document.getElementById('userName').value;
            config.model = document.getElementById('modelId').value;
            config.temp = document.getElementById('tempVal').value;
            localStorage.setItem('v9_cfg', JSON.stringify(config));
            updateUI();
        }
        function saveData() {
            localStorage.setItem('v9_msgs', JSON.stringify(messages));
            localStorage.setItem('v9_mems', JSON.stringify(memories));
        }
        function loadData() {
            const c = localStorage.getItem('v9_cfg');
            if(c) config = JSON.parse(c);
            const m = localStorage.getItem('v9_msgs');
            if(m) messages = JSON.parse(m);
            const mem = localStorage.getItem('v9_mems');
            if(mem) memories = JSON.parse(mem);
            
            const bg = localStorage.getItem('v9_bg');
            if(bg) {
                document.getElementById('page-chat').style.backgroundImage = `url(${bg})`;
                document.getElementById('page-chat').style.backgroundSize = 'cover';
            }
        }
        function updateUI() {
            document.getElementById('apiUrl').value = config.apiUrl;
            document.getElementById('apiKey').value = config.apiKey;
            document.getElementById('sysPrompt').value = config.sysPrompt;
            document.getElementById('userName').value = config.userName;
            document.getElementById('modelId').value = config.model;
            document.getElementById('tempVal').value = config.temp;
            
            document.getElementById('set-ai-avatar').src = config.aiAvatar;
            document.getElementById('set-user-avatar').src = config.userAvatar;
            updateMsgListPreview();
        }
        
        function normalizeUrl(u) { return u.endsWith('/') ? u.slice(0,-1) : u; }
        function clearChat() { if(confirm("ç¡®å®šæ¸…ç©º?")) { messages=[]; saveData(); renderChat(); } }
        function exportData() {
            const blob = new Blob([JSON.stringify({config,messages,memories})], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click();
        }
        function importData(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    config=d.config; messages=d.messages; memories=d.memories;
                    saveAll(); saveData(); location.reload();
                } catch(e){alert("æ–‡ä»¶æ— æ•ˆ");}
            }; r.readAsText(f);
        }
        async function testConn() {
            try { await fetch(normalizeUrl(document.getElementById('apiUrl').value)+'/models', {headers:{Authorization:"Bearer "+document.getElementById('apiKey').value}}); alert("è¿æ¥æˆåŠŸ"); }
            catch(e) { alert("è¿æ¥å¤±è´¥: "+e.message); }
        }
    </script>
</body>
</html>
