<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI OS 2.0</title>
    <style>
        /* --- å…¨å±€é‡ç½®ä¸åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: #dce1e8; display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            overflow: hidden;
        }

        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 812px; /* iPhone X å°ºå¯¸ */
            background-color: #000; border-radius: 40px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
            border: 12px solid #1a1a1a; 
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- çŠ¶æ€æ  --- */
        .status-bar {
            height: 44px; width: 100%; background: transparent; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; color: #000; font-size: 14px; font-weight: 600;
            z-index: 1000; pointer-events: none; position: absolute; top: 0;
        }
        .status-bar.dark { color: #fff; }

        /* --- å±å¹•é€šç”¨å®¹å™¨ --- */
        .screen {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background: #f2f2f7; overflow-y: auto; display: none;
            padding-top: 44px; /* é¿å¼€çŠ¶æ€æ  */
            padding-bottom: 20px; /* åº•éƒ¨å®‰å…¨åŒº */
        }
        .screen.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease; }

        /* --- ä¸»å±å¹• (Home) --- */
        #screen-home { 
            background: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1000&auto=format&fit=crop') no-repeat center center;
            background-size: cover;
            align-items: flex-start; align-content: flex-start; flex-direction: row; flex-wrap: wrap; padding: 60px 20px; gap: 20px;
        }
        .app-icon {
            width: 64px; height: 64px; border-radius: 14px; background: #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer;
            font-size: 32px; transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.9); }
        .app-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .app-label { color: #fff; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        /* --- å¯¼èˆªæ é€šç”¨ --- */
        .nav-bar {
            height: 44px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; background: rgba(249, 249, 249, 0.94); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { color: #007AFF; border: none; background: none; font-size: 16px; cursor: pointer; padding: 5px; }
        .nav-btn.danger { color: #FF3B30; }

        /* --- åˆ—è¡¨é€šç”¨ --- */
        .list-group { background: #fff; margin: 20px 15px; border-radius: 10px; overflow: hidden; }
        .list-item { 
            padding: 12px 15px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #eee; cursor: pointer; background: #fff;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background: #f0f0f0; }
        .chevron { color: #c7c7cc; font-size: 18px; }

        /* --- èŠå¤©åˆ—è¡¨ --- */
        .chat-row { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer;}
        .chat-row:active { background-color: #f5f5f5; }
        .chat-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: #ddd;}
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 600; font-size: 16px; color: #000; margin-bottom: 4px; }
        .chat-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- èŠå¤©å®¤ --- */
        #screen-chat-room { background: #fff; padding-top: 0; } /* èŠå¤©å®¤å…¨å± */
        .chat-room-body { 
            flex: 1; overflow-y: auto; padding: 15px; background: #f2f2f7; 
            display: flex; flex-direction: column; gap: 15px;
        }
        .msg-bubble-row { display: flex; flex-direction: column; width: 100%; position: relative;}
        .msg-bubble-row.user { align-items: flex-end; }
        .msg-bubble-row.ai { align-items: flex-start; }
        
        .msg-bubble { 
            max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; 
            position: relative; word-wrap: break-word;
        }
        .msg-bubble.user { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        .msg-bubble.ai { background: #e5e5ea; color: #000; border-bottom-left-radius: 4px; }
        
        .msg-time { font-size: 10px; color: #8e8e93; margin-top: 4px; padding: 0 4px; }
        .msg-img { max-width: 100%; border-radius: 8px; margin-bottom: 5px; display: block;}

        .chat-input-area {
            padding: 8px 15px; background: #f9f9f9; border-top: 1px solid #ddd;
            display: flex; align-items: flex-end; gap: 10px;
        }
        .chat-input {
            flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px 12px; 
            font-size: 15px; outline: none; background: #fff; max-height: 100px;
        }
        .icon-btn { font-size: 24px; color: #007AFF; cursor: pointer; background: none; border: none; padding: 0;}

        /* --- ä¾§è¾¹æ  (Drawer) --- */
        .drawer {
            position: absolute; top: 0; right: 0; width: 85%; height: 100%;
            background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 2000; transform: translateX(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }
        .drawer-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* --- å¼¹çª— (Modal) --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: #fff; width: 80%; border-radius: 14px; padding: 20px;
            text-align: center; animation: popIn 0.2s ease;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- è¡¨å•å…ƒç´  --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { font-size: 13px; color: #666; margin-bottom: 5px; display: block; }
        .form-input, .form-select, .form-textarea { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 16px; outline: none; background: #fff;
        }
        .form-textarea { height: 80px; resize: none; }
        .btn-primary { background: #007AFF; color: #fff; width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: #FF3B30; color: #fff; width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; float: right;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* åº•éƒ¨å°æ¨ªæ¡ */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: rgba(0,0,0,0.2); border-radius: 10px;
            z-index: 9999; cursor: pointer;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ */
        #img-preview-box { display: none; padding: 5px 15px; background: #f0f0f0; font-size: 12px; color: #666; justify-content: space-between; align-items: center;}
        #preview-thumb { height: 40px; width: 40px; border-radius: 4px; object-fit: cover; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="phone-frame">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <span id="clock">09:41</span>
            <span>ğŸ“¶ 5G ğŸ”‹ 100%</span>
        </div>

        <!-- ================= 1. ä¸»å±å¹• ================= -->
        <div id="screen-home" class="screen active">
            <div class="app-wrapper" onclick="navTo('screen-chat-list')">
                <div class="app-icon" style="background:#34C759; color:white;">ğŸ’¬</div>
                <span class="app-label">èŠå¤©</span>
            </div>
            <div class="app-wrapper" onclick="navTo('screen-memory')">
                <div class="app-icon" style="background:#FF9500; color:white;">ğŸ§ </div>
                <span class="app-label">è®°å¿†åº“</span>
            </div>
            <div class="app-wrapper" onclick="navTo('screen-settings')">
                <div class="app-icon" style="background:#8E8E93; color:white;">âš™ï¸</div>
                <span class="app-label">è®¾ç½®</span>
            </div>
        </div>

        <!-- ================= 2. è®¾ç½® APP ================= -->
        <div id="screen-settings" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navTo('screen-home')">â—€ ä¸»é¡µ</button>
                <span class="nav-title">è®¾ç½®</span>
                <div style="width:30px"></div>
            </div>
            
            <div style="padding:0 15px;">
                <!-- API é…ç½® -->
                <h4 style="color:#666; margin-left:10px; margin-bottom:5px; font-size:12px;">API é…ç½®</h4>
                <div class="list-group" style="margin-top:0;">
                    <div class="list-item" onclick="openSettingsModal('api')">
                        <span>APIè¿æ¥è®¾ç½®</span> <span class="chevron">â€º</span>
                    </div>
                    <div class="list-item" onclick="fetchModels()">
                        <span style="color:#007AFF">ğŸ“¡ æ‹‰å–æœ€æ–°æ¨¡å‹</span>
                    </div>
                    <div class="list-item" onclick="testConnection()">
                        <span style="color:#34C759">ğŸ“¶ æµ‹è¯•è¿æ¥</span>
                    </div>
                </div>

                <!-- æ¨¡å‹å‚æ•° -->
                <h4 style="color:#666; margin-left:10px; margin-bottom:5px; font-size:12px;">æ¨¡å‹å‚æ•°</h4>
                <div class="list-group" style="margin-top:0;">
                    <div class="list-item">
                        <span>æ¸©åº¦ (åˆ›æ„åº¦) <span id="disp-temp" style="color:#888; font-size:12px;">0.7</span></span>
                        <input type="range" id="set-temp" min="0" max="2" step="0.1" value="0.7" style="width:100px" oninput="updateConfig('temp', this.value); document.getElementById('disp-temp').innerText=this.value">
                    </div>
                    <div class="list-item">
                        <span>è®°å¿†è½®æ•° <span id="disp-context" style="color:#888; font-size:12px;">10</span></span>
                        <input type="range" id="set-context" min="2" max="50" step="2" value="10" style="width:100px" oninput="updateConfig('contextLimit', this.value); document.getElementById('disp-context').innerText=this.value">
                    </div>
                    <div class="list-item" style="cursor:default;">
                        <span>æ—¶é—´æ„ŸçŸ¥</span>
                        <label class="switch">
                            <input type="checkbox" id="set-time-aware" onchange="updateConfig('timeAware', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="padding:0 15px 10px; font-size:10px; color:#888;">å¼€å¯åï¼ŒAIå°†çŸ¥æ™“å½“å‰ç°å®æ—¶é—´ï¼Œå¹¶åœ¨æ¶ˆæ¯æ°”æ³¡ä¸Šæ˜¾ç¤ºæ—¶é—´æˆ³ã€‚</div>
                </div>

                <!-- æ•°æ®å­˜å‚¨ -->
                <h4 style="color:#666; margin-left:10px; margin-bottom:5px; font-size:12px;">æ•°æ®å­˜å‚¨</h4>
                <div class="list-group" style="margin-top:0;">
                    <div class="list-item" onclick="backupData()">
                        <span>ğŸ“¤ å¤‡ä»½æ•°æ® (ä¸‹è½½JSON)</span>
                    </div>
                    <div class="list-item" onclick="document.getElementById('file-restore').click()">
                        <span>ğŸ“¥ æ¢å¤æ•°æ®</span>
                        <input type="file" id="file-restore" style="display:none" onchange="restoreData(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= 3. è®°å¿†åº“ APP ================= -->
        <div id="screen-memory" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navTo('screen-home')">â—€ ä¸»é¡µ</button>
                <span class="nav-title">é•¿æœŸè®°å¿†</span>
                <button class="nav-btn" onclick="addMemoryUI()">ï¼‹</button>
            </div>
            <div id="memory-list" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                <!-- åŠ¨æ€ç”Ÿæˆè®°å¿†æ¡ç›® -->
            </div>
        </div>

        <!-- ================= 4. èŠå¤© APP - è”ç³»äººåˆ—è¡¨ ================= -->
        <div id="screen-chat-list" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navTo('screen-home')">â—€ ä¸»é¡µ</button>
                <span class="nav-title">èŠå¤©</span>
                <button class="nav-btn" onclick="openNewContactModal()">ï¼‹</button>
            </div>
            <div id="contact-list-container">
                <!-- åŠ¨æ€è”ç³»äºº -->
            </div>
        </div>

        <!-- ================= 5. èŠå¤© APP - èŠå¤©å®¤ ================= -->
        <div id="screen-chat-room" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navTo('screen-chat-list')">â—€</button>
                <span class="nav-title" id="chat-room-title">AI</span>
                <button class="nav-btn" onclick="toggleDrawer()">â‰¡</button>
            </div>

            <div class="chat-room-body" id="chat-container">
                <!-- æ¶ˆæ¯æµ -->
            </div>

            <!-- å›¾ç‰‡é¢„è§ˆæ¡ -->
            <div id="img-preview-box">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img id="preview-thumb" src="">
                    <span>å·²æ·»åŠ å›¾ç‰‡</span>
                </div>
                <span style="color:#FF3B30; cursor:pointer;" onclick="clearImage()">âœ•</span>
            </div>

            <div class="chat-input-area">
                <button class="icon-btn" onclick="document.getElementById('chat-file-input').click()">ğŸ“</button>
                <input type="file" id="chat-file-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
                
                <input type="text" class="chat-input" id="chat-input" placeholder="å‘æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="icon-btn" onclick="sendMessage()">â¤</button>
            </div>

            <!-- èŠå¤©å®¤ä¾§è¾¹æ  -->
            <div class="drawer" id="chat-drawer">
                <div class="nav-bar" style="background:#fff;">
                    <button class="nav-btn" onclick="toggleDrawer()">âœ•</button>
                    <span class="nav-title">è¯¦ç»†ä¿¡æ¯</span>
                    <div style="width:30px"></div>
                </div>
                <div class="drawer-content">
                    <h4 style="margin-top:0">ğŸ¤– AI è®¾ç½®</h4>
                    <div class="form-group">
                        <label class="form-label">å¤´åƒ (ç‚¹å‡»æ›´æ¢)</label>
                        <img id="drawer-ai-avatar" src="" style="width:60px; height:60px; border-radius:50%; border:1px solid #ddd;" onclick="document.getElementById('upload-ai-av').click()">
                        <input type="file" id="upload-ai-av" style="display:none" onchange="updateContactAvatar(event, 'ai')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤‡æ³¨å (Appå†…æ˜¾ç¤º)</label>
                        <input type="text" id="drawer-remark" class="form-input" onchange="saveDrawerSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI äººè®¾ (System Prompt)</label>
                        <textarea id="drawer-persona" class="form-textarea" onchange="saveDrawerSettings()"></textarea>
                    </div>

                    <h4 style="border-top:1px solid #eee; padding-top:15px;">ğŸ‘¤ ç”¨æˆ·è®¾ç½® (æœ¬ä¼šè¯)</h4>
                    <div class="form-group">
                        <label class="form-label">ä½ çš„å¤´åƒ</label>
                        <img id="drawer-user-avatar" src="" style="width:60px; height:60px; border-radius:50%; border:1px solid #ddd;" onclick="document.getElementById('upload-user-av').click()">
                        <input type="file" id="upload-user-av" style="display:none" onchange="updateContactAvatar(event, 'user')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä½ çš„ç§°å‘¼</label>
                        <input type="text" id="drawer-username" class="form-input" onchange="saveDrawerSettings()">
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-primary" style="background:#5856D6; margin-bottom:10px;" onclick="openSummaryModal()">ğŸª„ èŒƒå›´è‡ªåŠ¨æ€»ç»“</button>
                        <button class="btn-danger" onclick="resetChat()">ğŸ—‘ï¸ å¼€å¯æ–°å¯¹è¯ (æ¸…ç©ºè®°å½•)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= å¼¹çª—æ¨¡æ€æ¡†é›† ================= -->
        
        <!-- 1. æ–°å»ºè”ç³»äººå¼¹çª— -->
        <div class="modal-overlay" id="modal-new-contact">
            <div class="modal-box">
                <h3>æ–°å»ºè”ç³»äºº</h3>
                <div class="form-group">
                    <input type="text" id="new-contact-name" class="form-input" placeholder="è¾“å…¥åå­— (å¦‚: åŠ©æ‰‹)">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" style="background:#ccc; color:#000;" onclick="closeModal('modal-new-contact')">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="createContact()">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- 2. API è®¾ç½®å¼¹çª— -->
        <div class="modal-overlay" id="modal-api-settings">
            <div class="modal-box" style="text-align:left;">
                <h3 style="text-align:center; margin-top:0;">API è¿æ¥</h3>
                <div class="form-group">
                    <label class="form-label">Base URL (éœ€åŒ…å« /v1)</label>
                    <input type="text" id="cfg-url" class="form-input" placeholder="https://api.openai.com/v1">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="cfg-key" class="form-input" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹ ID</label>
                    <input type="text" id="cfg-model" class="form-input" placeholder="gpt-3.5-turbo">
                </div>
                <button class="btn-primary" onclick="saveApiConfig()">ä¿å­˜</button>
            </div>
        </div>

        <!-- 3. è®°å¿†ç¼–è¾‘å¼¹çª— -->
        <div class="modal-overlay" id="modal-memory-edit">
            <div class="modal-box">
                <h3>ç¼–è¾‘è®°å¿†</h3>
                <textarea id="mem-content" class="form-textarea" style="height:100px;"></textarea>
                <input type="hidden" id="mem-index">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-danger" onclick="deleteMemory()" id="btn-del-mem">åˆ é™¤</button>
                    <button class="btn-primary" onclick="saveMemoryItem()">ä¿å­˜</button>
                </div>
                <button class="nav-btn" style="margin-top:10px; width:100%;" onclick="closeModal('modal-memory-edit')">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- 4. æ€»ç»“èŒƒå›´é€‰æ‹©å¼¹çª— -->
        <div class="modal-overlay" id="modal-summary">
            <div class="modal-box">
                <h3>ğŸª„ æ™ºèƒ½æ€»ç»“</h3>
                <p style="font-size:12px; color:#666;">é€‰æ‹©æ¶ˆæ¯èŒƒå›´ï¼ŒAIå°†æå–é‡ç‚¹å­˜å…¥è®°å¿†åº“ã€‚</p>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                    <input type="number" id="sum-start" class="form-input" placeholder="å¼€å§‹#">
                    <span>è‡³</span>
                    <input type="number" id="sum-end" class="form-input" placeholder="ç»“æŸ#">
                </div>
                <div id="sum-hint" style="font-size:10px; color:#888; margin-bottom:10px;"></div>
                <button class="btn-primary" id="btn-do-sum" onclick="doSummarize()">å¼€å§‹æ€»ç»“</button>
                <button class="nav-btn" style="margin-top:10px;" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="navTo('screen-home')"></div>

    </div>

    <script>
        // --- æ•°æ®ç»“æ„å®šä¹‰ ---
        const defaultAvatarAI = "https://api.dicebear.com/7.x/bottts/svg?seed=AI";
        const defaultAvatarUser = "https://api.dicebear.com/7.x/avataaars/svg?seed=User";

        let state = {
            config: {
                apiUrl: "https://api.openai.com/v1",
                apiKey: "",
                model: "gpt-3.5-turbo",
                temp: 0.7,
                contextLimit: 10,
                timeAware: false
            },
            contacts: [], // { id, name, remark, persona, aiAvatar, userName, userAvatar, messages: [] }
            memories: [], // strings
            currentContactId: null
        };

        let currentImgBase64 = null;

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            loadData();
            updateClock();
            setInterval(updateClock, 60000);
            if (state.contacts.length === 0) {
                // é»˜è®¤åˆ›å»ºä¸€ä¸ªè”ç³»äºº
                createContact("AI åŠ©æ‰‹", true);
            }
        };

        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').innerText = `${h}:${m}`;
        }

        // --- å¯¼èˆªé€»è¾‘ ---
        function navTo(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.getElementById('statusBar').classList.toggle('dark', screenId === 'screen-home');
            
            // ç‰¹å®šé¡µé¢åˆå§‹åŒ–
            if(screenId === 'screen-chat-list') renderContactList();
            if(screenId === 'screen-memory') renderMemoryList();
            if(screenId === 'screen-settings') loadSettingsUI();
        }

        function toggleDrawer() {
            const d = document.getElementById('chat-drawer');
            d.classList.toggle('open');
            if (d.classList.contains('open')) loadDrawerUI();
        }

        // --- æ•°æ®æŒä¹…åŒ– ---
        function saveData() {
            localStorage.setItem('aios_state', JSON.stringify(state));
        }
        function loadData() {
            const d = localStorage.getItem('aios_state');
            if (d) state = JSON.parse(d);
        }
        function backupData() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `aios_backup_${Date.now()}.json`;
            a.click();
        }
        function restoreData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    state = JSON.parse(ev.target.result);
                    saveData();
                    alert('âœ… æ•°æ®å·²æ¢å¤ï¼Œå³å°†é‡å¯');
                    location.reload();
                } catch (err) { alert('âŒ æ ¼å¼é”™è¯¯'); }
            }
            reader.readAsText(file);
        }

        // --- è®¾ç½® APP é€»è¾‘ ---
        function openSettingsModal(type) {
            if (type === 'api') {
                document.getElementById('cfg-url').value = state.config.apiUrl;
                document.getElementById('cfg-key').value = state.config.apiKey;
                document.getElementById('cfg-model').value = state.config.model;
                document.getElementById('modal-api-settings').style.display = 'flex';
            }
        }
        function saveApiConfig() {
            state.config.apiUrl = document.getElementById('cfg-url').value.trim();
            state.config.apiKey = document.getElementById('cfg-key').value.trim();
            state.config.model = document.getElementById('cfg-model').value.trim();
            saveData();
            closeModal('modal-api-settings');
        }
        function loadSettingsUI() {
            document.getElementById('set-temp').value = state.config.temp;
            document.getElementById('disp-temp').innerText = state.config.temp;
            document.getElementById('set-context').value = state.config.contextLimit;
            document.getElementById('disp-context').innerText = state.config.contextLimit;
            document.getElementById('set-time-aware').checked = state.config.timeAware;
        }
        function updateConfig(key, val) {
            state.config[key] = val;
            saveData();
        }
        async function testConnection() {
            try {
                const res = await fetch(state.config.apiUrl + '/models', {
                    headers: { 'Authorization': 'Bearer ' + state.config.apiKey }
                });
                if(res.ok) alert('âœ… è¿æ¥æˆåŠŸ');
                else throw new Error(res.statusText);
            } catch(e) { alert('âŒ è¿æ¥å¤±è´¥: ' + e.message); }
        }
        async function fetchModels() {
            // ç®€å•æ¨¡æ‹Ÿï¼Œå®é™…åº”å½“å¡«å……åˆ°selectä¸­ï¼Œè¿™é‡Œä»…æç¤º
            try {
                const res = await fetch(state.config.apiUrl + '/models', {
                    headers: { 'Authorization': 'Bearer ' + state.config.apiKey }
                });
                const data = await res.json();
                alert(`âœ… è·å–åˆ° ${data.data.length} ä¸ªæ¨¡å‹ï¼Œå·²è®°å½•åœ¨æ§åˆ¶å°`);
                console.log(data.data);
            } catch(e) { alert('âŒ æ‹‰å–å¤±è´¥'); }
        }

        // --- è®°å¿† APP é€»è¾‘ ---
        function renderMemoryList() {
            const list = document.getElementById('memory-list');
            list.innerHTML = '';
            state.memories.forEach((mem, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.borderRadius = '10px';
                div.innerHTML = `<span style="font-size:14px; line-height:1.4;">${mem.substring(0, 40)}${mem.length>40?'...':''}</span> <span class="chevron">âœ</span>`;
                div.onclick = () => openMemoryEdit(idx);
                list.appendChild(div);
            });
        }
        function addMemoryUI() { openMemoryEdit(-1); }
        function openMemoryEdit(idx) {
            const modal = document.getElementById('modal-memory-edit');
            const content = idx === -1 ? '' : state.memories[idx];
            document.getElementById('mem-content').value = content;
            document.getElementById('mem-index').value = idx;
            document.getElementById('btn-del-mem').style.display = idx === -1 ? 'none' : 'block';
            modal.style.display = 'flex';
        }
        function saveMemoryItem() {
            const idx = parseInt(document.getElementById('mem-index').value);
            const txt = document.getElementById('mem-content').value.trim();
            if(!txt) return;
            if(idx === -1) state.memories.push(txt);
            else state.memories[idx] = txt;
            saveData(); renderMemoryList(); closeModal('modal-memory-edit');
        }
        function deleteMemory() {
            const idx = parseInt(document.getElementById('mem-index').value);
            if(confirm('ç¡®å®šåˆ é™¤?')) {
                state.memories.splice(idx, 1);
                saveData(); renderMemoryList(); closeModal('modal-memory-edit');
            }
        }

        // --- èŠå¤© APP é€»è¾‘ ---
        
        // 1. è”ç³»äºº
        function openNewContactModal() { document.getElementById('modal-new-contact').style.display = 'flex'; }
        function createContact(nameOverride = null, silent = false) {
            const nameInput = document.getElementById('new-contact-name');
            const name = nameOverride || nameInput.value.trim();
            if (!name) return;
            
            const newContact = {
                id: Date.now().toString(),
                name: name,
                remark: "",
                persona: "ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„AIåŠ©æ‰‹ã€‚",
                aiAvatar: defaultAvatarAI,
                userName: "æˆ‘",
                userAvatar: defaultAvatarUser,
                messages: []
            };
            state.contacts.push(newContact);
            saveData();
            if(!silent) {
                renderContactList();
                closeModal('modal-new-contact');
                nameInput.value = '';
            }
        }
        
        function renderContactList() {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = '';
            state.contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = 'chat-row';
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : 'ç‚¹å‡»å¼€å§‹èŠå¤©';
                // ä¼˜å…ˆæ˜¾ç¤ºå¤‡æ³¨ï¼Œå¦åˆ™æ˜¾ç¤ºåŸå
                const displayName = c.remark || c.name;
                
                div.innerHTML = `
                    <img src="${c.aiAvatar}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${displayName}</div>
                        <div class="chat-preview">${lastMsg.replace(/<[^>]+>/g,'')}</div>
                    </div>
                `;
                div.onclick = () => enterChatRoom(c.id);
                container.appendChild(div);
            });
        }

        // 2. èŠå¤©å®¤
        function enterChatRoom(id) {
            state.currentContactId = id;
            const c = state.contacts.find(x => x.id === id);
            document.getElementById('chat-room-title').innerText = c.remark || c.name;
            
            renderMessages();
            navTo('screen-chat-room');
            document.getElementById('chat-drawer').classList.remove('open');
        }

        function renderMessages() {
            const c = state.contacts.find(x => x.id === state.currentContactId);
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            
            c.messages.forEach((msg, idx) => {
                appendMessageUI(msg, idx);
            });
            scrollToBottom();
        }

        function appendMessageUI(msg, idx) {
            const container = document.getElementById('chat-container');
            const isUser = msg.role === 'user';
            const c = state.contacts.find(x => x.id === state.currentContactId);
            const avatar = isUser ? c.userAvatar : c.aiAvatar;
            
            const div = document.createElement('div');
            div.className = `msg-bubble-row ${isUser ? 'user' : 'ai'}`;
            
            // ç®€æ˜“ Markdown æ¸…æ´—ä¸æ¢è¡Œ
            let contentHtml = msg.content
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // ç²—ä½“
                .replace(/```[\s\S]*?```/g, '[ä»£ç å—]') // ç®€åŒ–ä»£ç 
                .replace(/\n/g, '<br>');

            // å›¾ç‰‡
            let imgHtml = msg.image ? `<img src="${msg.image}" class="msg-img">` : '';
            
            // æ—¶é—´æˆ³ (å¦‚æœæœ‰)
            let timeHtml = msg.timestamp ? `<div class="msg-time">${msg.timestamp}</div>` : '';

            div.innerHTML = `
                <div style="display:flex; gap:8px; max-width:100%; ${isUser?'flex-direction:row-reverse':''}">
                    <img src="${avatar}" style="width:36px; height:36px; border-radius:50%;">
                    <div class="msg-bubble ${isUser ? 'user' : 'ai'}">
                        ${imgHtml}
                        <span>${contentHtml}</span>
                    </div>
                </div>
                ${timeHtml}
            `;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const el = document.getElementById('chat-container');
            el.scrollTop = el.scrollHeight;
        }

        // 3. å‘é€ä¸æµå¼è¯·æ±‚
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text && !currentImgBase64) return;
            if (!state.config.apiKey) { alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key"); return; }

            const c = state.contacts.find(x => x.id === state.currentContactId);
            
            // ç”¨æˆ·æ¶ˆæ¯æ„å»º
            const userMsg = { 
                role: 'user', 
                content: text, 
                image: currentImgBase64,
                timestamp: state.config.timeAware ? new Date().toLocaleTimeString() : null
            };
            
            c.messages.push(userMsg);
            saveData();
            appendMessageUI(userMsg, c.messages.length - 1);
            scrollToBottom();

            input.value = '';
            clearImage();

            // å‡†å¤‡ API è¯·æ±‚
            // 1. System Prompt + Memory + Time
            let sysPrompt = c.persona;
            if(state.config.timeAware) {
                sysPrompt += `\n[å½“å‰æ—¶é—´: ${new Date().toLocaleString()}]`;
            }
            if(state.memories.length > 0) {
                sysPrompt += `\n[ç›¸å…³è®°å¿†åº“]:\n${state.memories.join('\n')}`;
            }
            sysPrompt += `\n[æ³¨æ„]: è¯·ç›´æ¥å›å¤å†…å®¹ï¼Œä¸è¦ä½¿ç”¨Markdownæ ¼å¼ï¼Œä¿æŒå£è¯­åŒ–ã€‚`;

            const apiMsgs = [{role: "system", content: sysPrompt}];
            
            // 2. Context Window
            const limit = parseInt(state.config.contextLimit);
            const history = c.messages.slice(-limit);
            
            history.forEach(m => {
                if(m.image) {
                    apiMsgs.push({
                        role: m.role,
                        content: [
                            {type: "text", text: m.content || " "},
                            {type: "image_url", image_url: {url: m.image}}
                        ]
                    });
                } else {
                    apiMsgs.push({role: m.role, content: m.content});
                }
            });

            // 3. Stream Fetch
            const aiTempMsg = { role: 'assistant', content: "...", timestamp: null };
            // UI ä¸Šå…ˆå ä½ï¼Œä¸å­˜å…¥ data
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'msg-bubble-row ai';
            bubbleDiv.innerHTML = `
                <div style="display:flex; gap:8px; max-width:100%;">
                    <img src="${c.aiAvatar}" style="width:36px; height:36px; border-radius:50%;">
                    <div class="msg-bubble ai" id="stream-bubble">...</div>
                </div>`;
            document.getElementById('chat-container').appendChild(bubbleDiv);
            scrollToBottom();

            try {
                const res = await fetch(state.config.apiUrl + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + state.config.apiKey },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: apiMsgs,
                        temperature: parseFloat(state.config.temp),
                        stream: true
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                const bubbleContent = document.getElementById('stream-bubble');

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ', ''));
                                const delta = json.choices[0].delta.content || "";
                                fullText += delta;
                                bubbleContent.innerHTML = fullText.replace(/\n/g, '<br>');
                                scrollToBottom();
                            } catch(e) {}
                        }
                    }
                }

                // å®Œæˆï¼Œå­˜å…¥æ•°æ®
                bubbleDiv.remove(); // ç§»é™¤å ä½
                const aiMsg = {
                    role: 'assistant',
                    content: fullText,
                    timestamp: state.config.timeAware ? new Date().toLocaleTimeString() : null
                };
                c.messages.push(aiMsg);
                saveData();
                appendMessageUI(aiMsg, c.messages.length - 1);

            } catch(e) {
                document.getElementById('stream-bubble').innerText = "Error: " + e.message;
            }
        }

        // 4. ä¾§è¾¹æ é€»è¾‘
        function loadDrawerUI() {
            const c = state.contacts.find(x => x.id === state.currentContactId);
            document.getElementById('drawer-ai-avatar').src = c.aiAvatar;
            document.getElementById('drawer-remark').value = c.remark;
            document.getElementById('drawer-persona').value = c.persona;
            document.getElementById('drawer-user-avatar').src = c.userAvatar;
            document.getElementById('drawer-username').value = c.userName;
        }
        function saveDrawerSettings() {
            const c = state.contacts.find(x => x.id === state.currentContactId);
            c.remark = document.getElementById('drawer-remark').value;
            c.persona = document.getElementById('drawer-persona').value;
            c.userName = document.getElementById('drawer-username').value;
            
            // æ›´æ–°UIæ ‡é¢˜
            document.getElementById('chat-room-title').innerText = c.remark || c.name;
            saveData();
        }
        function updateContactAvatar(e, target) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const c = state.contacts.find(x => x.id === state.currentContactId);
                if(target === 'ai') {
                    c.aiAvatar = ev.target.result;
                    document.getElementById('drawer-ai-avatar').src = c.aiAvatar;
                } else {
                    c.userAvatar = ev.target.result;
                    document.getElementById('drawer-user-avatar').src = c.userAvatar;
                }
                saveData();
                // åˆ·æ–°èŠå¤©ç•Œé¢å¤´åƒéœ€é‡ç»˜ï¼Œè¿™é‡Œå·æ‡’ç›´æ¥ç”Ÿæ•ˆäºæ–°æ¶ˆæ¯æˆ–é‡è¿›
            }
            reader.readAsDataURL(file);
        }
        function resetChat() {
            if(confirm("ç¡®å®šæ¸…ç©ºä¸è¯¥äººç‰©çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                const c = state.contacts.find(x => x.id === state.currentContactId);
                c.messages = [];
                saveData();
                renderMessages();
                toggleDrawer();
            }
        }

        // 5. è‡ªåŠ¨æ€»ç»“åŠŸèƒ½
        function openSummaryModal() {
            const c = state.contacts.find(x => x.id === state.currentContactId);
            document.getElementById('sum-start').value = 1;
            document.getElementById('sum-end').value = c.messages.length;
            document.getElementById('sum-hint').innerText = `å½“å‰å…±æœ‰ ${c.messages.length} æ¡æ¶ˆæ¯`;
            document.getElementById('modal-summary').style.display = 'flex';
        }

        async function doSummarize() {
            const s = parseInt(document.getElementById('sum-start').value) - 1;
            const e = parseInt(document.getElementById('sum-end').value);
            const c = state.contacts.find(x => x.id === state.currentContactId);
            
            if(isNaN(s) || s < 0 || e > c.messages.length) { alert('èŒƒå›´æ— æ•ˆ'); return; }
            
            const targetMsgs = c.messages.slice(s, e);
            const txt = targetMsgs.map(m => `${m.role}: ${m.content}`).join('\n');
            
            const btn = document.getElementById('btn-do-sum');
            btn.innerText = "æ­£åœ¨åˆ†æ..."; btn.disabled = true;

            try {
                const res = await fetch(state.config.apiUrl + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + state.config.apiKey },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°å½•å‘˜ã€‚è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„å…³é”®ä¿¡æ¯ï¼Œæç‚¼æˆä¸€æ¡ç®€çŸ­çš„è®°å¿†ç‚¹ã€‚"},
                            {role: "user", content: txt}
                        ]
                    })
                });
                const json = await res.json();
                const summary = json.choices[0].message.content;
                
                state.memories.push(summary);
                saveData();
                alert("âœ… æ€»ç»“æˆåŠŸï¼Œå·²å­˜å…¥è®°å¿†åº“ App");
                closeModal('modal-summary');
                toggleDrawer(); // å…³é—­ä¾§è¾¹æ 
            } catch(err) {
                alert("æ€»ç»“å¤±è´¥: " + err.message);
            }
            btn.innerText = "å¼€å§‹æ€»ç»“"; btn.disabled = false;
        }

        // --- é€šç”¨å·¥å…· ---
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentImgBase64 = ev.target.result;
                document.getElementById('preview-thumb').src = currentImgBase64;
                document.getElementById('img-preview-box').style.display = 'flex';
            }
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        function clearImage() {
            currentImgBase64 = null;
            document.getElementById('img-preview-box').style.display = 'none';
        }

    </script>
</body>
</html>
