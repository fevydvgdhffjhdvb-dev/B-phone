<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>AI Phone Pro</title>
    <!-- è‡ªå®šä¹‰ä¸»å±å¹•å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    <link rel="icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            background-color: #222; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            overflow: hidden; 
        }

        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #000; 
            border-radius: 45px; 
            box-shadow: 0 0 0 8px #333, 0 20px 50px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden; 
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .phone-frame { width: 100%; height: 100%; border-radius: 0; box-shadow: none; border: none; }
        }

        /* --- é¡µé¢åˆ‡æ¢ç³»ç»Ÿ --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            z-index: 10;
        }
        .page.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px;
            font-size: 14px; font-weight: 600; color: inherit;
            z-index: 100;
            position: absolute; top: 0; left: 0;
        }

        /* --- 1. æ¡Œé¢ (Home) --- */
        #page-home {
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop') no-repeat center center/cover;
            color: white;
            justify-content: flex-start;
        }
        /* ä¿®æ”¹ .home-clock-widget (åŸç¬¬65è¡Œ) */
        .home-clock-widget { 
            margin-top: 60px;  /* ä»120æ”¹åˆ°60ï¼Œè®©æ—¶é’Ÿå¾€ä¸Šæ */
            text-align: center; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            margin-bottom: 20px; /* å¢åŠ åº•éƒ¨é—´è· */
        }
        
        /* åŸæ¥çš„ .clock-time å’Œ .clock-date (ç¬¬66-67è¡Œ) ä¸ç”¨åŠ¨ï¼Œä¿ç•™å³å¯ */
        .clock-time { font-size: 72px; font-weight: 200; letter-spacing: -2px; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; font-weight: 500; }

        /* ä¿®æ”¹ .app-grid (åŸç¬¬69-75è¡Œ) */
        .app-grid {
            margin-top: 0;       /* å»æ‰ autoï¼Œè®©å®ƒä¸å†æ²‰åº•ï¼Œæ”¹ä¸ºé ä¸Š */
            margin-bottom: auto; /* åº•éƒ¨ç•™ç©º */
            
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 30px 15px;      /* è°ƒæ•´å›¾æ ‡é—´è·ï¼Œè¡Œè·å¤§ä¸€ç‚¹ */
            padding: 20px;
            
            /* å…³é”®ï¼šå»æ‰èƒŒæ™¯è‰²ã€ç£¨ç ‚å’Œè¾¹æ¡† */
            background: none;    
            backdrop-filter: none;
            border-radius: 0;
            
            margin-left: 10px; 
            margin-right: 10px;
        }
        .app-icon-container { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .app-icon-container:active { transform: scale(0.9); }
        .app-icon {
            width: 58px; height: 58px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .icon-msg { background: linear-gradient(to bottom, #34c759, #30b753); }
        .icon-note { background: linear-gradient(to bottom, #ffd60a, #ffcc00); }
        .icon-settings { background: linear-gradient(to bottom, #8e8e93, #636366); }

        /* --- é€šç”¨ App å¤´éƒ¨ --- */
        .app-header {
            height: 90px; padding-top: 44px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding-left: 15px; padding-right: 15px;
            background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .app-title { font-size: 28px; font-weight: bold; color: #000; }
        .btn-icon-text { font-size: 16px; color: #007AFF; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .btn-icon-only { font-size: 22px; color: #007AFF; background: none; border: none; cursor: pointer; padding: 5px; }

        /* --- 2. æ¶ˆæ¯åˆ—è¡¨ --- */
        #page-msg-list { background: #fff; }
        .msg-list-scroll { flex: 1; overflow-y: auto; }
        .msg-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: 0.2s;
        }
        .msg-list-item:active { background: #f5f5f5; }
        .list-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee;}
        .list-info { flex: 1; min-width: 0; }
        .list-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .list-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-time { font-size: 12px; color: #c7c7cc; white-space: nowrap; }

        /* --- 3. èŠå¤©ç•Œé¢ --- */
        /* ä¿®å¤åçš„èƒŒæ™¯ï¼šå»æ‰é¡¶éƒ¨å†…è¾¹è·ï¼Œè®©å£çº¸æ’‘æ»¡ */
        #page-chat { 
            background-color: #f2f2f7; 
            background-size: cover; 
            background-position: center; 
            padding-top: 95px; /* ç»™é¡¶éƒ¨ç•™å‡ºç©ºé—´ */
        }

        /* ä¿®å¤åçš„é¡¶éƒ¨æ ï¼šå¼ºåˆ¶å›ºå®šåœ¨æœ€ä¸Šæ–¹ï¼Œå¡«è¡¥çŠ¶æ€æ ç¼éš™ */
        .chat-header-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: auto; min-height: 90px;
            padding-top: max(44px, env(safe-area-inset-top));
            padding-bottom: 10px;
            padding-left: 15px; padding-right: 15px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            display: flex; align-items: flex-end; justify-content: space-between;
            border-bottom: 1px solid #dbdbdb;
            z-index: 50;
        }
        .chat-back-btn { color: #007AFF; font-size: 16px; border: none; background: none; display: flex; align-items: center; cursor: pointer; }
        .chat-contact-name { font-weight: 600; font-size: 16px; flex: 1; text-align: center; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .chat-header-actions { display: flex; gap: 15px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; position: relative; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); background:#fff;}
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .message { background: #fff; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .message { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        .msg-index { font-size: 10px; color: #999; position: absolute; top: -15px; opacity: 0.5; }
        .msg-row.left .msg-index { left: 45px; }
        .msg-row.right .msg-index { right: 45px; }

        .input-area { background: #f9f9f9; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px; }
        .input-toolbar { display: flex; align-items: center; gap: 8px; width: 100%; }
        #userInput { flex: 1; min-width: 0; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #userInput:focus { border-color: #007AFF; }
        .btn-send { font-size: 24px; background: none; border: none; cursor: pointer; color: #007AFF; padding: 0 5px; flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .typing-indicator { display: inline-block; width: 4px; height: 4px; background: #999; border-radius: 50%; margin: 0 1px; animation: bounce 1s infinite; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; gap: 10px; font-size: 12px; }

        /* --- é€šç”¨åˆ—è¡¨æ ·å¼ (è®¾ç½®/è®°å¿†) --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; }
        .ios-group-title { font-size: 13px; color: #666; margin: 15px 15px 5px; text-transform: uppercase; }
        .ios-list { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 12px 15px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; justify-content: space-between; min-height: 45px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-item:active { background-color: #f9f9f9; }
        .ios-label { font-size: 16px; font-weight: 500; color: #000; flex-shrink: 0; margin-right: 10px;}
        .ios-input { border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; background: transparent; flex: 1; min-width: 0;}
        .ios-btn { width: 100%; padding: 14px; text-align: center; color: #007AFF; background: #fff; border: none; font-size: 16px; cursor: pointer; border-top: 1px solid #e5e5ea; }
        .ios-btn.danger { color: #ff3b30; }
        .memory-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; position: relative; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-del-mem { position: absolute; top: 10px; right: 10px; color: #ff3b30; cursor: pointer; font-size: 18px;}

        /* --- å¼¹çª— Modal --- */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:500; display:none; align-items:center; justify-content:center; opacity: 0; transition: opacity 0.2s;}
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); width: 85%; max-height: 70%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; font-size: 17px;}
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #f2f2f7;}
        .modal-footer { display: flex; border-top: 1px solid #ccc; }
        .modal-btn { flex: 1; padding: 15px; background: #fff; border: none; font-size: 17px; cursor: pointer; }
        .modal-btn:first-child { border-right: 1px solid #ccc; color: #ff3b30; }
        .modal-btn:last-child { color: #007AFF; font-weight: 600; }

        /* Home Indicator */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: #000; border-radius: 10px; z-index: 999; cursor: pointer;
        }
        #page-home .home-indicator { background: #fff; }
        
        /* æ¶ˆæ¯ä¸‹æ–¹çš„å·¥å…·æ  */
        .msg-meta-row { display: flex; align-items: center; margin-top: 2px; }
        .msg-row.left .msg-meta-row { justify-content: flex-start; margin-left: 45px; }
        .msg-row.right .msg-meta-row { justify-content: flex-end; margin-right: 45px; }
        
        /* é‡åˆ·æŒ‰é’® */
        .btn-reroll { 
            font-size: 12px; color: #999; cursor: pointer; padding: 2px 5px; 
            background: rgba(255,255,255,0.5); border-radius: 10px;
            display: flex; align-items: center; gap: 3px;
        }
        .btn-reroll:active { transform: scale(0.9); background: #ddd; }
        /* --- å¼ºåˆ¶ä¿®å¤ iOS é•¿æŒ‰å†²çª --- */
        .msg-row.right .message {
            -webkit-touch-callout: none !important; 
            -webkit-user-select: none !important;
            user-select: none !important;
        }
        /* --- ç•ªèŒ„é’Ÿä¸“å±æ ·å¼ --- */
        .pomo-bubble {
            margin-top: 30px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 85%;
            text-align: center;
            font-size: 16px;
            color: #333;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }
        /* æˆ³ä¸€æˆ³åŠ¨ç”»ç±» */
        .anim-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
          10%, 90% { transform: translate3d(-2px, 0, 0); }
          20%, 80% { transform: translate3d(4px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
          40%, 60% { transform: translate3d(8px, 0, 0); }
        }
        /* --- Pop é£æ ¼æ—¶é—´æˆ³æ ·å¼ --- */
        .message {
            position: relative; /* ä¸ºç»å¯¹å®šä½çš„æ—¶é—´æˆ³åšå‚ç…§ */
            padding-bottom: 18px; /* åº•éƒ¨ç•™å‡ºç©ºé—´ç»™æ—¶é—´æˆ³ï¼Œé¿å…é®æŒ¡æ–‡å­— */
            min-width: 60px; /* ä¿è¯æ°”æ³¡ä¸ä¼šå¤ªçª„ */
        }

        .msg-time-stamp {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            opacity: 0.6; /* ç¨å¾®é€æ˜ï¼Œä¸æŠ¢çœ¼ */
            font-weight: 400;
            user-select: none;
        }

        /* é’ˆå¯¹æ·±è‰²æ°”æ³¡ï¼ˆå³ä¾§ï¼‰çš„é€‚é… */
        .msg-row.right .msg-time-stamp {
            color: rgba(255, 255, 255, 0.9);
        }

        /* é’ˆå¯¹æµ…è‰²æ°”æ³¡ï¼ˆå·¦ä¾§ï¼‰çš„é€‚é… */
        .msg-row.left .msg-time-stamp {
            color: rgba(0, 0, 0, 0.5);
        }
        /* --- æ—¥å† App æ ·å¼ --- */
.cal-month-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; font-size: 18px; font-weight: bold; border-bottom: 1px solid #eee;
}
.cal-month-nav button { background:none; border:none; font-size:20px; color:#007AFF; cursor:pointer; padding: 0 10px;}

.cal-week-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px 0; font-size: 12px; color: #999; border-bottom: 1px solid #f0f0f0; }

.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); auto-rows: 50px; }
.cal-cell { 
    border-bottom: 1px solid #fafafa; border-right: 1px solid #fafafa;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; cursor: pointer;
}
.cal-cell.active { background-color: #e5f1ff; } /* é€‰ä¸­æ€ */
.cal-cell.today { color: #007AFF; font-weight: bold; }
.cal-cell.empty { background: #fcfcfc; }

/* æ ‡è®°ç‚¹æ ·å¼ */
.cal-dot-container { display: flex; gap: 2px; margin-top: 2px; }
.dot-event { width: 5px; height: 5px; border-radius: 50%; background-color: #ff9500; } /* èŠ‚æ—¥æ˜¯æ©™è‰²ç‚¹ */
.dot-period { width: 6px; height: 6px; border-radius: 50%; background-color: #ff2d55; border: 1px solid #fff;} /* ç»æœŸæ˜¯ç²‰çº¢å¤§ç‚¹ */

/* ç»æœŸé¢„æµ‹åŒºé—´èƒŒæ™¯ (è¿›é˜¶æ•ˆæœ) */
.cal-cell.period-range { background-color: rgba(255, 45, 85, 0.1); }
    </style>
</head>
<body>

    <div class="phone-frame">
        
        

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="goHome()"></div>

        <!-- ============ 1. æ¡Œé¢ (Home) ============ -->
        <div class="page active" id="page-home">
            <div class="home-clock-widget">
                <div class="clock-time" id="clockTime">12:00</div>
                <div class="clock-date" id="clockDate">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            </div>
            <div class="app-grid">
                <!-- 1. ä¿¡æ¯ (åŠ äº† id="app-icon-msg") -->
                <div class="app-icon-container" onclick="navigateTo('page-msg-list')">
                    <div class="app-icon icon-msg" id="app-icon-msg">ğŸ’¬</div>
                    <div class="app-name">ä¿¡æ¯</div>
                </div>
                <!-- 2. è®°å¿†åº“ (åŠ äº† id="app-icon-mem") -->
                <div class="app-icon-container" onclick="navigateTo('page-memory')">
                    <div class="app-icon icon-note" id="app-icon-mem">ğŸ“</div>
                    <div class="app-name">è®°å¿†åº“</div>
                </div>
                <!-- 3. è®¾ç½® (åŠ äº† id="app-icon-set") -->
                <div class="app-icon-container" onclick="navigateTo('page-settings')">
                    <div class="app-icon icon-settings" id="app-icon-set">âš™ï¸</div>
                    <div class="app-name">è®¾ç½®</div>
                </div>
                <!-- 4. åŸç›¸æœº -> æ”¹æˆ ç¾åŒ– (åŠ äº† id="app-icon-theme") -->
                <div class="app-icon-container" onclick="navigateTo('page-theme')">
                    <div class="app-icon" id="app-icon-theme" style="background: linear-gradient(to bottom, #ff2d55, #ff375f);">ğŸ¨</div>
                    <div class="app-name">ç¾åŒ–</div>
                </div>
                <!-- 5. æ—¥è®°æœ¬ -->
                <div class="app-icon-container" onclick="navigateTo('page-diary')">
                    <div class="app-icon" id="app-icon-diary" style="background: linear-gradient(to bottom, #d4a373, #a98467);">ğŸ“–</div>
                    <div class="app-name">æ—¥è®°æœ¬</div>
                </div>
                <!-- 6. ç•ªèŒ„é’Ÿ (æ–°å¢) -->
                <div class="app-icon-container" onclick="navigateTo('page-pomodoro'); initPomoPage();">
                    <div class="app-icon" id="app-icon-pomo" style="background: linear-gradient(to bottom, #ff6b6b, #ee5253);">ğŸ…</div>
                    <div class="app-name">ç•ªèŒ„é’Ÿ</div>
                </div>
                <!-- 7. æ—¥å† (æ–°å¢) -->
<div class="app-icon-container" onclick="navigateTo('page-calendar'); initCalendarPage();">
    <div class="app-icon" id="app-icon-cal" style="background: #fff; color: #333;">ğŸ“…</div>
    <div class="app-name">æ—¥å†</div>
</div>
            </div>
        </div>

        <!-- ============ 2. æ¶ˆæ¯åˆ—è¡¨ (è”ç³»äºº) ============ -->
        <div class="page" id="page-msg-list">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()"><span>â€¹</span> æ¡Œé¢</button>
                <span class="app-title">ä¿¡æ¯</span>
                <button class="btn-icon-only" onclick="openModal('modal-add-char')" title="æ·»åŠ è§’è‰²" style="font-size: 26px;">+</button>
            </div>
            <div class="msg-list-scroll" id="contactListContainer">
                <!-- åŠ¨æ€åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ============ 3. èŠå¤©çª—å£ ============ -->
        <div class="page" id="page-chat">
            <div class="chat-header-bar">
                <button class="chat-back-btn" onclick="navigateTo('page-msg-list')">
                    <span style="font-size:24px; margin-right:5px;">â€¹</span> ä¿¡æ¯
                </button>
                <span class="chat-contact-name" id="chat-title-name">AI</span>
                <div class="chat-header-actions">
                    <button class="btn-icon-only" onclick="openChatSettings()" title="è§’è‰²è®¾ç½®" style="font-size: 20px;">âš™ï¸</button>
                    <button class="btn-icon-only" onclick="openSummaryModal()" title="æ™ºèƒ½æ€»ç»“" style="font-size: 20px;">âœ¨</button>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                <!-- æ¶ˆæ¯å†…å®¹ -->
            </div>

            <div class="input-area">
                <div id="uploadPreview">
                    <img id="img-preview-blob" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                    <span>å·²é€‰æ‹©å›¾ç‰‡</span>
                    <span onclick="clearUpload()" style="color:red; margin-left:auto; cursor:pointer;">Ã—</span>
                </div>
                <div class="input-toolbar">
                    <button class="btn-send" onclick="document.getElementById('fileInput').click()" style="color:#888;">âŠ•</button>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
                    <input type="text" id="userInput" placeholder="iMessage" onkeypress="if(event.key==='Enter') sendMsg('user')">
                    <button class="btn-send" onclick="sendMsg('user')">â¬†</button>
                    <button class="btn-send" id="btn-ai" onclick="triggerAI()" style="color:#5856D6">ğŸ¤–</button>
                </div>
            </div>
        </div>

        <!-- ============ 4. è®°å¿†åº“ ============ -->
        <div class="page" id="page-memory">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®°å¿†åº“</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
                <div class="ios-group-title">å½“å‰é€‰ä¸­è§’è‰²çš„è®°å¿†</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <input type="text" id="newMemInput" class="ios-input" style="text-align:left;" placeholder="æ‰‹åŠ¨æ·»åŠ è®°å¿†...">
                        <button onclick="addMemoryManual()" style="border:none;background:none;color:#007AFF;font-weight:bold;">+</button>
                    </div>
                </div>
                <div id="memoryListContainer"></div>
            </div>
        </div>

        <!-- ============ 5. å…¨å±€è®¾ç½® ============ -->
        <div class="page" id="page-settings">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®¾ç½®</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <div class="ios-group-title">API è¿æ¥</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">API URL</span>
                        <input type="text" id="apiUrl" class="ios-input" placeholder="https://api.openai.com/v1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="apiKey" class="ios-input" placeholder="sk-..." onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="testConn()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div class="ios-group-title">æ¨¡å‹é…ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">Model ID</span>
                        <input type="text" id="modelId" class="ios-input" value="gpt-3.5-turbo" onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="fetchModels()">â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                    <!-- éšè—çš„ Selectï¼Œç”¨äºæ‹‰å–åé€‰æ‹© -->
                    <div class="ios-item" id="modelSelectContainer" style="display:none;">
                        <span class="ios-label">é€‰æ‹©</span>
                        <select id="modelSelect" class="ios-input" style="direction: rtl;" onchange="document.getElementById('modelId').value=this.value;saveGlobalConfig()">
                        </select>
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ¸©åº¦ (Temperature)</span>
                        <input type="number" id="tempVal" class="ios-input" value="0.7" step="0.1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†è½®æ•° (æ¡æ•°)</span>
                        <input type="number" id="historyLimit" class="ios-input" value="20" step="1" placeholder="é»˜è®¤20" onchange="saveGlobalConfig()">
                    </div>
                </div>

                <div class="ios-group-title">æ•°æ®ç®¡ç†</div>
                <div class="ios-list">
                    <button class="ios-btn" onclick="exportData()">å¤‡ä»½æ‰€æœ‰æ•°æ® (JSON)</button>
                    <button class="ios-btn" onclick="document.getElementById('importFile').click()">æ¢å¤æ•°æ®</button>
                    <input type="file" id="importFile" hidden onchange="importData(event)">
                    <button class="ios-btn danger" onclick="resetAll()">é‡ç½®åº”ç”¨ (æ¸…é™¤æ‰€æœ‰)</button>
                </div>
            </div>
        </div>
        <!-- ============ 6. ç¾åŒ–ä¸­å¿ƒ (Theme) ============ -->
        <div class="page" id="page-theme">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç¾åŒ–ä¸­å¿ƒ</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <!-- æ¡Œé¢å£çº¸è®¾ç½® -->
                <div class="ios-group-title" style="margin-top:0;">æ¡Œé¢å£çº¸ (è¾“å…¥å›¾ç‰‡ URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å£çº¸ URL</span>
                        <input type="text" id="wallpaperInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div class="ios-group-title">APP å›¾æ ‡æ›¿æ¢ (è¾“å…¥å›¾ç‰‡URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¿¡æ¯å›¾æ ‡</span>
                        <input type="text" id="iconInput-msg" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†å›¾æ ‡</span>
                        <input type="text" id="iconInput-mem" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®¾ç½®å›¾æ ‡</span>
                        <input type="text" id="iconInput-set" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ç¾åŒ–å›¾æ ‡</span>
                        <input type="text" id="iconInput-theme" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ—¥è®°å›¾æ ‡</span>
                        <input type="text" id="iconInput-diary" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„æ—¥è®°å›¾æ ‡ä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">ç•ªèŒ„é’Ÿå›¾æ ‡</span>
                        <input type="text" id="iconInput-pomo" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„ç•ªèŒ„é’Ÿä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">æ—¥å†å›¾æ ‡</span>
                        <input type="text" id="iconInput-cal" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                </div>

                <div class="ios-group-title">å…¨å±€ CSS ä»£ç  (é«˜çº§ç¾åŒ–)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">åœ¨è¿™é‡Œè¾“å…¥ CSS å¯ä»¥æ›¿æ¢æŒ‰é’®ç´ æã€ä¿®æ”¹å­—ä½“ç­‰ã€‚</div>
                <div class="ios-list" style="height: 200px;">
                    <textarea id="customCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" placeholder=".btn-back { ... }" onchange="saveTheme()"></textarea>
                </div>
                <!-- æ°”æ³¡ç¾åŒ–åŒºåŸŸ (æ–°å¢) -->
                <div class="ios-group-title">æ°”æ³¡ç¾åŒ– (CSS)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">
                    å·¦è¾¹æ˜¯AI(.left)ï¼Œå³è¾¹æ˜¯ç”¨æˆ·(.right)ã€‚<br>
                    ä¾‹å¦‚: border-radius: 0;
                </div>
                <div class="ios-list" style="height: 150px;">
                    <textarea id="bubbleCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" 
                    placeholder="/* AI æ°”æ³¡ */
.msg-row.left .message { 
  background: #fff; 
}
/* ç”¨æˆ·æ°”æ³¡ */
.msg-row.right .message { 
  background: #007AFF; 
}" 
                    onchange="saveTheme()"></textarea>
                </div>
                <!-- å­—ä½“è®¾ç½®åŒºåŸŸ -->
                <div class="ios-group-title">å…¨å±€å­—ä½“ (è¾“å…¥ .ttf/.woff é“¾æ¥)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å­—ä½“ URL</span>
                        <input type="text" id="fontInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div style="text-align:center; padding:20px;">
                    <button class="ios-btn danger" style="border-radius:10px;" onclick="resetTheme()">é‡ç½®æ‰€æœ‰ç¾åŒ–</button>
                </div>
            </div>
        </div>
        <!-- ============ 7. æ—¥è®°æœ¬ (Diary) ============ -->
        <div class="page" id="page-diary">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">æ—¥è®°æœ¬</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
                <div class="ios-group-title">è§’è‰²å†…å¿ƒç‹¬ç™½</div>
                <!-- æ—¥è®°åˆ—è¡¨å®¹å™¨ -->
                <div id="diaryListContainer"></div>
            </div>
        </div>
        <!-- ============ 8. ç•ªèŒ„é’Ÿ (Pomodoro) ============ -->
        <div class="page" id="page-pomodoro">
            <div class="app-header">
                <button class="btn-icon-text" onclick="quitPomo()">â€¹ ç»“æŸ</button>
                <span class="app-title">ä¸“æ³¨æ¨¡å¼</span>
                <span style="width:50px;"></span>
            </div>
            
            <!-- è®¾ç½®ç•Œé¢ -->
            <div id="pomo-setup" class="content-scroll">
                <div class="ios-group-title" style="margin-top:20px;">é™ªä¼´å¯¹è±¡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">é€‰æ‹©è§’è‰²</span>
                        <select id="pomoCharSelect" class="ios-input" style="direction: rtl;"></select>
                    </div>
                </div>

                <div class="ios-group-title">ä¸“æ³¨è®¾ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">æ—¶é•¿ (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoDuration" class="ios-input" value="25">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ä¸“æ³¨å†…å®¹</span>
                        <input type="text" id="pomoTask" class="ios-input" placeholder="ä¾‹å¦‚: èƒŒå•è¯ã€å†™ä»£ç ">
                    </div>
                </div>

                <div class="ios-group-title">AI äº’åŠ¨é¢‘ç‡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¸»åŠ¨å‘è¨€é—´éš” (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoInterval" class="ios-input" value="5" placeholder="0ä¸ºä¸ä¸»åŠ¨">
                    </div>
                </div>
                <div style="padding:20px; font-size:12px; color:#999; text-align:center;">
                    å¼€å§‹åï¼Œç‚¹å‡»è§’è‰²å¤´åƒå¯ä»¥â€œæˆ³ä¸€æˆ³â€ï¼ŒTaä¼šæ ¹æ®å‰©ä½™æ—¶é—´å›åº”ä½ ã€‚
                </div>
                <div style="padding:0 20px;">
                    <button class="ios-btn" style="background:#ff3b30; color:#fff; border-radius:12px; font-weight:bold;" onclick="startPomoTimer()">å¼€å§‹ä¸“æ³¨</button>
                </div>
            </div>

            <!-- è¿è¡Œæ—¶ç•Œé¢ (é»˜è®¤éšè—) -->
            <div id="pomo-running" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px; padding-bottom:100px;">
                
                <!-- å€’è®¡æ—¶å¤§å­— -->
                <div id="pomo-timer-display" style="font-size:64px; font-weight:200; font-variant-numeric: tabular-nums;">25:00</div>
                <div id="pomo-task-display" style="font-size:18px; color:#666; margin-bottom:40px;">æ­£åœ¨è¿›è¡Œ: ...</div>

                <!-- è§’è‰²äº’åŠ¨åŒº -->
                <div style="position:relative;">
                    <img id="pomo-avatar" src="" style="width:120px; height:120px; border-radius:50%; border:4px solid #fff; box-shadow:0 10px 30px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.1s;" onclick="pokePomoChar()">
                    <!-- æˆ³ä¸€æˆ³ç‰¹æ•ˆå®¹å™¨ -->
                    <div id="poke-effect" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none; opacity:0; font-size:40px;">ğŸ‘ˆğŸ»</div>
                </div>

                <!-- AI æ°”æ³¡ -->
                <div class="pomo-bubble" id="pomo-ai-bubble">
                    ç‚¹å‡»å¤´åƒæˆ³ä¸€æˆ³æˆ‘ï¼Œæˆ‘ä¼šç›‘ç£ä½ å“¦ï¼
                </div>

            </div>
        </div>
        <!-- ============ 9. æ—¥å† (Calendar) ============ -->
        <div class="page" id="page-calendar">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç”Ÿæ´»æ—¥å†</span>
                <button class="btn-icon-only" onclick="jumpToToday()" style="font-size:14px;">ä»Šå¤©</button>
            </div>
            
            <div class="content-scroll" style="background:#fff; padding:0;">
                <!-- æœˆä»½åˆ‡æ¢æ  -->
                <div class="cal-month-nav">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="cal-current-month">2025å¹´ 11æœˆ</span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>

                <!-- æ˜ŸæœŸå¤´ -->
                <div class="cal-week-header">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>

                <!-- æ—¥å†æ ¼å­å®¹å™¨ -->
                <div id="cal-grid" class="cal-grid"></div>

                <!-- é€‰ä¸­æ—¥æœŸçš„è¯¦æƒ…æ“ä½œåŒº -->
                <div id="cal-detail-panel" style="padding:20px; background:#f2f2f7; min-height:300px;">
                    <div class="ios-group-title" id="selected-date-title">è¯·é€‰æ‹©æ—¥æœŸ</div>
                    <div class="ios-list">
                        <!-- çºªå¿µæ—¥/èŠ‚æ—¥è¾“å…¥ -->
                        <div class="ios-item">
                            <span class="ios-label">ç‰¹æ®Šæ—¥å­</span>
                            <input type="text" id="cal-event-input" class="ios-input" placeholder="ä¾‹å¦‚: ç”Ÿæ—¥ã€çºªå¿µæ—¥" onchange="saveCalendarEvent()">
                        </div>
                    </div>

                    <div class="ios-group-title">ç”Ÿç†æœŸè®°å½•</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="togglePeriodMark()">
                            <span class="ios-label">æ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥</span>
                            <div id="period-check-icon" style="font-size:20px; display:none;">ğŸ©¸</div>
                        </div>
                    </div>
                    
                    <div style="padding:15px; font-size:12px; color:#888; line-height:1.5;">
                        * è¯´æ˜ï¼š<br>
                        1. ç‚¹å‡»â€œæ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥â€ï¼ŒAI ä¼šè‡ªåŠ¨æ¨ç®—ä½ çš„å‘¨æœŸã€‚<br>
                        2. åœ¨ç‰¹æ®Šæ—¥å­ï¼ŒAI å¯èƒ½ä¼šåœ¨é›¶ç‚¹ç»™ä½ æƒŠå–œã€‚<br>
                        3. ç›®å‰æ•°æ®æ˜¯è·Ÿéšå½“å‰èŠå¤©è§’è‰²çš„ã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ å¼¹çª—ç»„ä»¶ ============ -->

        <!-- 1. æ·»åŠ è§’è‰²å¼¹çª— -->
        <div class="modal-overlay" id="modal-add-char">
            <div class="modal-box">
                <div class="modal-header">æ–°å»ºè”ç³»äºº</div>
                <div class="modal-body">
                    <div class="ios-list" style="margin: 20px 0; background:transparent;">
                        <div class="ios-item" style="background:#fff; border-radius:10px;">
                            <input type="text" id="newCharName" class="ios-input" style="text-align:center;" placeholder="è¾“å…¥è§’è‰²å§“å">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-add-char')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="addNewCharacter()">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- 2. è§’è‰²è®¾ç½®å¼¹çª— (åœ¨èŠå¤©ç•Œé¢è°ƒå‡º) -->
        <div class="modal-overlay" id="modal-chat-settings">
            <div class="modal-box" style="height: 80%;">
                <div class="modal-header">è§’è‰² & èŠå¤©è®¾ç½®</div>
                <div class="modal-body" style="padding: 15px;">
                    
                    <div class="ios-group-title" style="margin-top:0">å¯¹æ–¹ (AI) èµ„æ–™</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('charAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-char-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="charAvatarFile" hidden onchange="uploadCharAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">å§“å</span>
                            <input type="text" id="set-char-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <!-- æ–°å¢ï¼šä¸»åŠ¨æ‹›å‘¼è®¾ç½® -->
                        <div class="ios-item">
                            <span class="ios-label">ä¸»åŠ¨å‘æ¶ˆæ¯</span>
                            <select id="set-char-interval" class="ios-input" style="direction: rtl;" onchange="saveCurrentCharSettings()">
                                <option value="0">ä»ä¸</option>
                                <option value="2">è¶…è¿‡ 2 å°æ—¶</option>
                                <option value="6">è¶…è¿‡ 6 å°æ—¶</option>
                                <option value="12">è¶…è¿‡ 12 å°æ—¶ (åŠå¤©)</option>
                                <option value="24">è¶…è¿‡ 24 å°æ—¶ (ä¸€å¤©)</option>
                                <option value="48">è¶…è¿‡ 48 å°æ—¶ (ä¸¤å¤©)</option>
                            </select>
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">AI è®¾å®š (System Prompt)</span>
                            <textarea id="set-char-prompt" class="ios-input" style="text-align:left; width:100%; height:80px; border:1px solid #eee; padding:5px; border-radius:5px;" onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">æˆ‘çš„èµ„æ–™ (åœ¨æ­¤èŠå¤©ä¸­)</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('userAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-user-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="userAvatarFile" hidden onchange="uploadUserAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">æ˜µç§°</span>
                            <input type="text" id="set-user-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">æˆ‘çš„è®¾å®š (User Persona)</span>
                            <textarea id="set-user-desc" class="ios-input" style="text-align:left; width:100%; height:60px; border:1px solid #eee; padding:5px; border-radius:5px;" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ä¸ªå¥½å¥‡çš„å­¦ç”Ÿ..." onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">å¤–è§‚</div>
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èŠå¤©èƒŒæ™¯</span>
                            <button style="border:none; background:none; color:#007AFF" onclick="document.getElementById('bgFile').click()">æ›´æ¢</button>
                            <button style="border:none; background:none; color:red" onclick="clearChatBg()">è¿˜åŸ</button>
                            <input type="file" id="bgFile" hidden onchange="uploadChatBg(event)">
                        </div>
                    </div>

                    <div class="ios-group-title">èŠå¤©è®°å½•ç®¡ç†</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="openDeleteMsgModal()">
                            <span class="ios-label" style="color: #ff3b30;">åˆ é™¤èŠå¤©è®°å½•</span>
                            <span style="color:#999; font-size:12px;"> > </span>
                        </div>
                    </div>

                    <button class="ios-btn danger" style="border-radius:12px; margin-bottom:20px;" onclick="deleteCurrentChar()">åˆ é™¤æ­¤è§’è‰²</button>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" style="border:none; width:100%; color:#007AFF;" onclick="closeModal('modal-chat-settings')">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- 3. æ™ºèƒ½æ€»ç»“å¼¹çª— -->
        <div class="modal-overlay" id="modal-summary">
            <div class="modal-box">
                <div class="modal-header">æ™ºèƒ½è®°å¿†æå–</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">é€‰æ‹©èŠå¤©è®°å½•èŒƒå›´ç”Ÿæˆæ‘˜è¦å­˜å…¥è®°å¿†åº“</p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-end" class="ios-input" value="100">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999;">
                        å½“å‰å…±æœ‰ <span id="total-msg-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="doSummarize()">ç”Ÿæˆå¹¶å­˜å‚¨</button>
                </div>
            </div>
        </div>

        <!-- 4. åˆ é™¤æ¶ˆæ¯å¼¹çª— (æ–°) -->
        <div class="modal-overlay" id="modal-del-msg">
            <div class="modal-box">
                <div class="modal-header" style="color:#ff3b30">æ‰¹é‡åˆ é™¤æ¶ˆæ¯</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">
                        è¯·è¾“å…¥è¦åˆ é™¤çš„æ¶ˆæ¯æ¥¼å±‚èŒƒå›´<br>(#æ•°å­—)
                    </p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="del-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="del-end" class="ios-input">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999; margin-top:10px;">
                        å½“å‰å…±æœ‰ <span id="del-total-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-del-msg')">å–æ¶ˆ</button>
                    <button class="modal-btn" style="color:#ff3b30; font-weight:bold;" onclick="commitDeleteMsg()">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        let globalConfig = {
            apiUrl: "https://api.openai.com/v1",
            apiKey: "",
            model: "gpt-3.5-turbo",
            temp: 0.7,
            historyLimit: 20 
        };

        // è§’è‰²åˆ—è¡¨ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«å®Œæ•´ç‹¬ç«‹çš„æ•°æ®
        let contacts = []; 
        // å½“å‰æ´»è·ƒçš„èŠå¤©ID
        let activeContactId = null;

        // ä¸´æ—¶å›¾ç‰‡
        let currentImg = null;

        // --- åˆå§‹åŒ–ä¸ç”Ÿå‘½å‘¨æœŸ ---
        window.onload = function() {
            startClock();
            loadData();
            if (contacts.length === 0) {
                // é»˜è®¤åˆ›å»ºä¸€ä¸ªè§’è‰²
                createCharacter("AI Assistant", "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚", "https://api.dicebear.com/7.x/bottts/svg?seed=Default");
            }
            updateContactList();
            updateGlobalSettingsUI();
            loadTheme();
        };

        // --- æ•°æ®æŒä¹…åŒ– ---
        function saveData() {
            localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
            localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
        }

        function loadData() {
            const c = localStorage.getItem('ai_phone_config');
            if(c) globalConfig = JSON.parse(c);
            
            const ct = localStorage.getItem('ai_phone_contacts');
            if(ct) contacts = JSON.parse(ct);
        }

        function createCharacter(name, prompt, avatar) {
            const id = Date.now().toString();
            const newChar = {
                id: id,
                name: name,
                avatar: avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                systemPrompt: prompt || "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚",
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                userPersona: "", // ç”¨æˆ·åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„äººè®¾
                bgImage: "",     // èŠå¤©èƒŒæ™¯
                messages: [],
                memories: [],
                diaries: [],
                // --- æ–°å¢ï¼šæ—¥å†ä¸ç”Ÿç†æœŸæ•°æ® ---
                calendarEvents: {}, // æ ¼å¼: { "2025-11-21": "çºªå¿µæ—¥" }
                periodLog: [],      // æ ¼å¼: ["2025-10-01", "2025-11-28"] (è®°å½•ç»æœŸå¼€å§‹çš„æ—¥å­)
                // --- æ–°å¢å­—æ®µ ---
                autoReplyInterval: 0, // é»˜è®¤ä¸ä¸»åŠ¨
                lastActiveTime: Date.now()
            };
            contacts.push(newChar);
            saveData();
            return id;
        }

        // --- é¡µé¢å¯¼èˆª ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            const bar = document.getElementById('statusBar');
            const indicator = document.querySelector('.home-indicator');
            
            if(pageId === 'page-home') {
                // bar.style.color = 'white';
                indicator.style.backgroundColor = 'white';
            } else {
                // bar.style.color = 'black';
                indicator.style.backgroundColor = 'black';
            }

            if(pageId === 'page-chat' && activeContactId) {
                renderChat(activeContactId);
            }
            if(pageId === 'page-memory' && activeContactId) {
                renderMemories();
            } else if (pageId === 'page-memory' && !activeContactId) {
                document.getElementById('memoryListContainer').innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¯·å…ˆä»ä¿¡æ¯åˆ—è¡¨è¿›å…¥ä¸€ä¸ªèŠå¤©</p>';
            }
            // --- æ–°å¢ï¼šè¿›å…¥æ—¥è®°æœ¬æ—¶åˆ·æ–°åˆ—è¡¨ ---
            if (pageId === 'page-diary') {
                renderDiaries();
            }
        }

        function goHome() { navigateTo('page-home'); }

        // --- 1. è”ç³»äººåˆ—è¡¨é€»è¾‘ ---
        function updateContactList() {
            const container = document.getElementById('contactListContainer');
            container.innerHTML = '';
            
            // æŒ‰æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´æ’åºï¼ˆå¯é€‰ï¼Œè¿™é‡Œæš‚ä¸å¤æ‚åŒ–ï¼‰
            contacts.forEach(c => {
                // å¢åŠ å®¹é”™ï¼šå¦‚æœmessagesä¸å­˜åœ¨ï¼Œç»™ç©ºæ•°ç»„
                if(!c.messages) c.messages = [];
                
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : "ç‚¹å‡»å¼€å§‹èŠå¤©...";
                const previewText = lastMsg.startsWith('data:image') ? '[å›¾ç‰‡]' : lastMsg;
                
                const div = document.createElement('div');
                div.className = 'msg-list-item';
                div.onclick = () => enterChat(c.id);
                div.innerHTML = `
                    <img src="${c.avatar}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-name">${c.name}</div>
                        <div class="list-preview">${previewText}</div>
                    </div>
                    <div class="list-time"> > </div>
                `;
                container.appendChild(div);
            });
        }

        function enterChat(id) {
            activeContactId = id;
            navigateTo('page-chat');
            processAutoReplyChain(id);
        }

        function addNewCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            if(!name) return alert("è¯·è¾“å…¥åå­—");
            createCharacter(name);
            closeModal('modal-add-char');
            document.getElementById('newCharName').value = '';
            updateContactList();
        }

        // --- 2. èŠå¤©é€»è¾‘ ---
        function getActiveChar() {
            return contacts.find(c => c.id === activeContactId);
        }

        function renderChat(id) {
            const char = contacts.find(c => c.id === id);
            if(!char) return;

            document.getElementById('chat-title-name').innerText = char.name;
            
            // è®¾ç½®èƒŒæ™¯
            const page = document.getElementById('page-chat');
            if(char.bgImage) {
                page.style.backgroundImage = `url(${char.bgImage})`;
            } else {
                page.style.backgroundImage = '';
            }

            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if(!char.messages || char.messages.length === 0) {
                box.innerHTML = `<div style="text-align:center;font-size:12px;color:#999;margin:20px;">ä¸ ${char.name} å¼€å§‹æ–°çš„å¯¹è¯</div>`;
            } else {
                char.messages.forEach((m, index) => {
                    appendMsgUI(m.role, m.content, m.image, index + 1, false, m.timestamp);
                });
            }
            scrollToBottom();
        }

        // --- æ›¿æ¢åçš„ appendMsgUI å‡½æ•° (åŒ…å«é‡è¦ä¿®å¤) ---
        function appendMsgUI(role, text, img, index, isTemp=false, timestamp=null) {
            const char = getActiveChar();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            
            const avatarUrl = role==='user' ? char.userAvatar : char.avatar;
            
            // å¤„ç†å³é”®/åŒå‡»äº‹ä»¶
            let extraHtml = '';
            let eventAttr = '';
            if (role === 'user' && !isTemp) {
                eventAttr = `ondblclick="handleUserEdit(event, ${index}); return false;"`;
            } else if (role === 'assistant' && !isTemp) {
                extraHtml = `<div class="msg-meta-row"><div class="btn-reroll" onclick="rerollMessage(${index})">ğŸ”„</div></div>`;
            }

            // --- æ—¶é—´æˆ³å¤„ç†é€»è¾‘ (ä¿®å¤Safari Invalid Dateé”™è¯¯) ---
            let timeStr = "";
            if (timestamp) {
                const date = new Date(timestamp);
                // é‡è¦ä¿®å¤ï¼šæ£€æµ‹æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼Œæ—§æ•°æ®å¯èƒ½æ²¡æœ‰æ—¶é—´æˆ³æˆ–æ ¼å¼ä¸å…¼å®¹
                if (!isNaN(date.getTime())) {
                    try {
                        timeStr = date.toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                    } catch(e) {
                        console.warn("Date format error", e);
                    }
                }
            } else if (isTemp) {
                timeStr = "å‘é€ä¸­...";
            }

            let html = `
                <span class="msg-index">#${index || '?'}</span>
                <img src="${avatarUrl}" class="avatar">
                <div class="message" ${eventAttr}>
                    ${img ? `<img src="${img}" style="max-width:100%;border-radius:8px;display:block;margin-bottom:5px;">` : ''}
                    <span class="txt-content">${isTemp ? text : formatText(text)}</span>
                    
                    <!-- æ’å…¥æ—¶é—´æˆ³ -->
                    <span class="msg-time-stamp">${timeStr}</span>
                </div>
            `;
            
            div.innerHTML = html + extraHtml;
            box.appendChild(div);
            scrollToBottom();
            return div.querySelector('.txt-content'); 
        }

        async function sendMsg(role) {
            const char = getActiveChar();
            if(!char) return;

            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            
            if(!txt && !currentImg) return;

            // ç”¨æˆ·æ¶ˆæ¯
            const newMsg = { role: 'user', content: txt, image: currentImg, timestamp: Date.now() };
            char.messages.push(newMsg);
            saveData(); // ä¿å­˜æ•°æ®
            
            appendMsgUI('user', txt, currentImg, char.messages.length);
            
            input.value = '';
            clearUpload();
            
            // è§¦å‘ AI å›å¤ (åœ¨ sendMsg å†…éƒ¨è°ƒç”¨ triggerAI)
            setTimeout(triggerAI, 100); // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹é¿å…UIå¡é¡¿
        }

        async function triggerAI() {
            const char = getActiveChar();
            if(!char) return;
            if(!globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

            const btn = document.getElementById('btn-ai');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';
            btn.disabled = true;

            // æ„å»º Prompt
            let systemPromptFull = char.systemPrompt + `\n[å½“å‰æ—¶é—´: ${new Date().toLocaleString()}]\n[ç”¨æˆ·åç§°: ${char.userName}]`;
            if(char.userPersona) systemPromptFull += `\n[ç”¨æˆ·è®¾å®š: ${char.userPersona}]`;
            systemPromptFull += getStatusContext(char);
            // --- æ–°å¢ï¼šæŠŠæ—¥è®°å†…å®¹å–‚ç»™ AI ---
            if (char.diaries && char.diaries.length > 0) {
                // å–æœ€è¿‘çš„ 6 ç¯‡æ—¥è®°
                const recentDiaries = char.diaries.slice(-6).join('\n\n---\n\n');
                systemPromptFull += `\n\n[æˆ‘çš„ç§å¯†æ—¥è®°æœ¬ (åªæœ‰æˆ‘è‡ªå·±èƒ½çœ‹ï¼Œç”¨äºå›å¿†ä¹‹å‰çš„ç»å†å’Œå¿ƒæƒ…)]:\n${recentDiaries}`;
            }
            // ---------------------------
            if(char.memories.length > 0) {
                systemPromptFull += `\n[é•¿æœŸè®°å¿†åº“]:\n${char.memories.join('\n')}`;
            }

            let apiMsgs = [{role: "system", content: systemPromptFull}];
            
            // æ„å»ºæ¶ˆæ¯å†å² (æºå¸¦å›¾ç‰‡é€»è¾‘)
            // è¯»å–è®¾ç½®ä¸­çš„é™åˆ¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™é»˜è®¤20æ¡
            const limit = globalConfig.historyLimit || 20;
            const history = char.messages.slice(-limit);
            history.forEach(m => {
                if(m.image) {
                    // GPT-4 Vision æ ¼å¼, å…¼å®¹æ€§è§†æ¨¡å‹è€Œå®š
                    apiMsgs.push({
                        role: m.role,
                        content: [
                            { type: "text", text: m.content || " " },
                            { type: "image_url", image_url: { url: m.image } }
                        ]
                    });
                } else {
                    apiMsgs.push({ role: m.role, content: m.content });
                }
            });

            // UI å ä½
            const aiMsgIndex = char.messages.length + 1;
            const aiUiSpan = appendMsgUI('assistant', '...', null, aiMsgIndex, true);
            let fullText = "";

            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: apiMsgs,
                        temperature: parseFloat(globalConfig.temp),
                        stream: true
                    })
                });

                if(!res.ok) throw new Error(res.statusText);

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ',''));
                                const delta = json.choices[0].delta.content || "";
                                fullText += delta;
                                aiUiSpan.innerHTML = formatText(fullText);
                                scrollToBottom();
                            } catch(e){}
                        }
                    }
                }
                
                // ä¿å­˜ AI å›å¤ (åŠ ä¸Šæ—¶é—´æˆ³)
                char.messages.push({ role: 'assistant', content: fullText, timestamp: Date.now() });
                saveData();
                // --- åœ¨è¿™é‡Œæ’å…¥ä¸€è¡Œæ–°ä»£ç ï¼---
                renderChat(activeContactId); 
                // ---------------------------

            } catch(e) {
                aiUiSpan.innerText = "Error: " + e.message;
                char.messages.push({ role: 'assistant', content: "Error: " + e.message });
            }

            btn.innerHTML = originalBtnContent;
            btn.disabled = false;
        }

        // --- 3. æ™ºèƒ½æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() {
            const char = getActiveChar();
            if(!char) return;
            document.getElementById('total-msg-count').innerText = char.messages.length;
            
            // é»˜è®¤é€‰ä¸­æœ€è¿‘ 20 æ¡ï¼Œæˆ–è€…å…¨éƒ¨
            const total = char.messages.length;
            const start = Math.max(1, total - 20);
            document.getElementById('sum-start').value = start;
            document.getElementById('sum-end').value = total;
            
            openModal('modal-summary');
        }

        async function doSummarize() {
            const char = getActiveChar();
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœè€è§’è‰²æ²¡æœ‰æ—¥è®°æ•°ç»„ï¼Œç»™å®ƒåŠ ä¸€ä¸ª
            if (!char.diaries) char.diaries = [];

            const startIdx = parseInt(document.getElementById('sum-start').value) - 1;
            const endIdx = parseInt(document.getElementById('sum-end').value);
            
            if(startIdx < 0 || endIdx > char.messages.length || startIdx >= endIdx) {
                alert("æ¥¼å±‚èŒƒå›´æ— æ•ˆ");
                return;
            }

            const selectedMsgs = char.messages.slice(startIdx, endIdx);
            // æŠŠå¯¹è¯è½¬æ¢æˆæ–‡æœ¬ä¾› AI é˜…è¯»
            const textBlock = selectedMsgs.map(m => `${m.role === 'user' ? 'æˆ‘(ç”¨æˆ·)' : char.name}: ${m.content}`).join('\n');

            closeModal('modal-summary');
            const btn = document.querySelector('.chat-header-actions button:last-child');
            const oldIcon = btn.innerHTML;
            btn.innerText = "âœï¸"; // å˜æˆå†™å­—å›¾æ ‡

            try {
                // --- è¿™é‡Œæ˜¯æ ¸å¿ƒä¿®æ”¹ï¼šæç¤ºè¯æ”¹æˆäº†å†™æ—¥è®° ---
                const prompt = `è¯·é˜…è¯»ä»¥ä¸‹èŠå¤©è®°å½•ï¼Œä»¥è§’è‰² "${char.name}" çš„ç¬¬ä¸€äººç§°è§†è§’å†™ä¸€ç¯‡ç®€çŸ­çš„æ—¥è®°ã€‚
                è¦æ±‚ï¼š
                1. åŒ…å«èŠå¤©çš„ä¸»è¦å†…å®¹ï¼Œä½†è¦åŠ å…¥è§’è‰²çš„å†…å¿ƒç‹¬ç™½ã€æƒ…ç»ªå’Œå¯¹ç”¨æˆ·çš„çœ‹æ³•ã€‚
                2. æ ¼å¼ä¸ºï¼šâ€œ[æ—¥æœŸ] ä»Šå¤©...â€ (å¦‚æœæ˜¯æ·±å¤œèŠå¤©å¯ä»¥ç”¨â€œæ·±å¤œ...â€)ã€‚
                3. ç¯‡å¹…ä¸è¦å¤ªé•¿ï¼ŒåƒçœŸå®çš„æ‰‹æœºå¤‡å¿˜å½•æ—¥è®°ä¸€æ ·ã€‚
                
                èŠå¤©è®°å½•ï¼š
                ${textBlock}`;

                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ“…é•¿æ¨¡ä»¿äººç±»æƒ…æ„Ÿå’Œå†…å¿ƒæˆçš„å°è¯´å®¶ã€‚" },
                            { role: "user", content: prompt }
                        ]
                    })
                });
                const data = await res.json();
                const diaryEntry = data.choices[0].message.content;
                
                // å­˜å…¥æ—¥è®°æ•°ç»„
                char.diaries.push(diaryEntry);
                saveData();
                alert("æ—¥è®°å·²å†™å¥½ï¼Œå¿«å»æ—¥è®°æœ¬APPæŸ¥çœ‹å§ï¼");
            } catch(e) {
                alert("å†™æ—¥è®°å¤±è´¥: " + e.message);
            }
            btn.innerHTML = oldIcon;
        }

        // --- 4. è§’è‰²è®¾ç½®ä¸è®°å¿†åº“ ---
        function openChatSettings() {
            const char = getActiveChar();
            if(!char) return;
            
            document.getElementById('set-char-name').value = char.name;
            document.getElementById('set-char-prompt').value = char.systemPrompt;
            document.getElementById('set-char-avatar').src = char.avatar;
            
            document.getElementById('set-user-name').value = char.userName;
            document.getElementById('set-user-desc').value = char.userPersona || "";
            document.getElementById('set-user-avatar').src = char.userAvatar;
            document.getElementById('set-char-interval').value = char.autoReplyInterval || 0;
            
            openModal('modal-chat-settings');
        }

        function saveCurrentCharSettings() {
        const char = getActiveChar();
        if(!char) return;
        
        char.name = document.getElementById('set-char-name').value;
        char.systemPrompt = document.getElementById('set-char-prompt').value;
        char.userName = document.getElementById('set-user-name').value;
        char.userPersona = document.getElementById('set-user-desc').value;
        char.autoReplyInterval = parseInt(document.getElementById('set-char-interval').value) || 0;
        
        document.getElementById('chat-title-name').innerText = char.name;
        saveData();

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        updateContactList();        // åˆ·æ–°å¤–é¢çš„åˆ—è¡¨
        renderChat(activeContactId); // åˆ·æ–°é‡Œé¢çš„æ°”æ³¡
    }

    async function uploadCharAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().avatar = b64;
        document.getElementById('set-char-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }

    async function uploadUserAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().userAvatar = b64;
        document.getElementById('set-user-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }
        async function uploadChatBg(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().bgImage = b64;
            document.getElementById('page-chat').style.backgroundImage = `url(${b64})`;
            saveData();
        }

        function clearChatBg() {
            getActiveChar().bgImage = "";
            document.getElementById('page-chat').style.backgroundImage = '';
            saveData();
        }

        function deleteCurrentChar() {
            if(confirm("ç¡®å®šåˆ é™¤è¯¥è§’è‰²åŠæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                contacts = contacts.filter(c => c.id !== activeContactId);
                activeContactId = null;
                saveData();
                closeModal('modal-chat-settings');
                updateContactList();
                navigateTo('page-msg-list');
            }
        }

        // è®°å¿†åº“æ¸²æŸ“
        function renderMemories() {
            const char = getActiveChar();
            const c = document.getElementById('memoryListContainer'); 
            c.innerHTML = '';
            
            if(!char) return;
            
            if(!char.memories) char.memories = []; // å…¼å®¹æ—§æ•°æ®

            char.memories.forEach((m, i) => {
                c.innerHTML += `
                    <div class="memory-card">
                        ${m}
                        <div class="btn-del-mem" onclick="deleteMemory(${i})">Ã—</div>
                    </div>`;
            });
        }
        function addMemoryManual() {
            const char = getActiveChar();
            const input = document.getElementById('newMemInput');
            if(input.value && char) {
                char.memories.push(input.value);
                input.value = '';
                saveData(); renderMemories();
            }
        }
        function deleteMemory(index) {
            const char = getActiveChar();
            if(char) {
                char.memories.splice(index, 1);
                saveData(); renderMemories();
            }
        }

        // --- 5. å…¨å±€è®¾ç½®é€»è¾‘ ---
        function updateGlobalSettingsUI() {
            document.getElementById('apiUrl').value = globalConfig.apiUrl;
            document.getElementById('apiKey').value = globalConfig.apiKey;
            document.getElementById('modelId').value = globalConfig.model;
            document.getElementById('tempVal').value = globalConfig.temp;
            document.getElementById('historyLimit').value = globalConfig.historyLimit || 20;
        }
        
        function saveGlobalConfig() {
            globalConfig.apiUrl = document.getElementById('apiUrl').value;
            globalConfig.apiKey = document.getElementById('apiKey').value;
            globalConfig.model = document.getElementById('modelId').value;
            globalConfig.temp = document.getElementById('tempVal').value;
            globalConfig.historyLimit = parseInt(document.getElementById('historyLimit').value) || 20;
            saveData();
        }
        // --- ç¾åŒ–/ä¸»é¢˜ç³»ç»Ÿ (ç»ˆæç‰ˆ: å›¾æ ‡+å­—ä½“+å£çº¸) ---
    let themeConfig = {
            icons: { msg: "", mem: "", set: "", theme: "", diary: "", pomo: "" },
            customCss: "",
            bubbleCss: "",
            customFont: "",
            homeWallpaper: "" 
        };

    function loadTheme() {
        try {
            const t = localStorage.getItem('ai_phone_theme');
            if(t) themeConfig = JSON.parse(t);

            // 1. æ¢å¤å›¾æ ‡
            const iconMsg = document.getElementById('iconInput-msg');
            if(iconMsg) iconMsg.value = themeConfig.icons.msg || "";
            
            const iconMem = document.getElementById('iconInput-mem');
            if(iconMem) iconMem.value = themeConfig.icons.mem || "";
            
            const iconSet = document.getElementById('iconInput-set');
            if(iconSet) iconSet.value = themeConfig.icons.set || "";
            
            const iconTheme = document.getElementById('iconInput-theme');
            if(iconTheme) iconTheme.value = themeConfig.icons.theme || "";
            
            const iconDiary = document.getElementById('iconInput-diary');
            if(iconDiary) iconDiary.value = themeConfig.icons.diary || "";
            
            const iconPomo = document.getElementById('iconInput-pomo');
            if(iconPomo) iconPomo.value = themeConfig.icons.pomo || "";

            const iconCal = document.getElementById('iconInput-cal');
        if(iconCal) iconCal.value = themeConfig.icons.cal || "";

            // 2. æ¢å¤CSSå’Œå­—ä½“
            const cssInput = document.getElementById('customCssInput');
            if(cssInput) cssInput.value = themeConfig.customCss || "";

            // --- å…³é”®ç‚¹ï¼šé˜²æ­¢æŠ¥é”™ï¼Œå…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ ---
            const bubbleInput = document.getElementById('bubbleCssInput');
            if(bubbleInput) bubbleInput.value = themeConfig.bubbleCss || "";

            const fontInput = document.getElementById('fontInput');
            if(fontInput) fontInput.value = themeConfig.customFont || "";
            
            // 3. æ¢å¤å£çº¸
            const wpInput = document.getElementById('wallpaperInput');
            if(wpInput) wpInput.value = themeConfig.homeWallpaper || "";

            applyThemeUI();
        } catch(e) {
            console.error("åŠ è½½ä¸»é¢˜å‡ºé”™ï¼Œä½†è¿™ä¸å½±å“æ•°æ®å®‰å…¨", e);
        }
    }

    function saveTheme() {
        // ä½¿ç”¨å¯é€‰é“¾ (?.) é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
        themeConfig.icons.msg = document.getElementById('iconInput-msg')?.value || "";
        themeConfig.icons.mem = document.getElementById('iconInput-mem')?.value || "";
        themeConfig.icons.set = document.getElementById('iconInput-set')?.value || "";
        themeConfig.icons.theme = document.getElementById('iconInput-theme')?.value || "";
        themeConfig.icons.diary = document.getElementById('iconInput-diary')?.value || "";
        themeConfig.icons.pomo = document.getElementById('iconInput-pomo')?.value || "";
        themeConfig.icons.cal = document.getElementById('iconInput-cal')?.value || "";
        
        themeConfig.customCss = document.getElementById('customCssInput')?.value || "";
        themeConfig.bubbleCss = document.getElementById('bubbleCssInput')?.value || ""; // æ°”æ³¡ç¾åŒ–
        
        const fontInput = document.getElementById('fontInput');
        if(fontInput) themeConfig.customFont = fontInput.value;
        
        const wpInput = document.getElementById('wallpaperInput');
        if(wpInput) themeConfig.homeWallpaper = wpInput.value;

        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
        applyThemeUI();
    }

    function applyThemeUI() {
        // A. åº”ç”¨å›¾æ ‡
        updateAppIcon('app-icon-msg', themeConfig.icons.msg);
        updateAppIcon('app-icon-mem', themeConfig.icons.mem);
        updateAppIcon('app-icon-set', themeConfig.icons.set);
        updateAppIcon('app-icon-theme', themeConfig.icons.theme);
        updateAppIcon('app-icon-diary', themeConfig.icons.diary);
        updateAppIcon('app-icon-pomo', themeConfig.icons.pomo);
        updateAppIcon('app-icon-cal', themeConfig.icons.cal);

        // B. åº”ç”¨å£çº¸
        const homePage = document.getElementById('page-home');
        if (themeConfig.homeWallpaper && themeConfig.homeWallpaper.trim() !== "") {
            homePage.style.backgroundImage = `url(${themeConfig.homeWallpaper})`;
        } else {
            homePage.style.backgroundImage = "url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop')";
        }

        // C. åº”ç”¨å­—ä½“å’ŒCSS
        let styleTag = document.getElementById('user-custom-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'user-custom-style';
            document.head.appendChild(styleTag);
        }

        let finalCss = themeConfig.customCss || "";
        // åªæœ‰å½“æœ‰å­—ä½“æ—¶æ‰æ‹¼æ¥å­—ä½“è§„åˆ™
        if (themeConfig.customFont && themeConfig.customFont.trim() !== "") {
            const fontRule = `
                @font-face { font-family: 'UserCustomFont'; src: url('${themeConfig.customFont}'); font-display: swap; }
                body, button, input, textarea, select, .clock-time, .app-title, .chat-contact-name { font-family: 'UserCustomFont', -apple-system, sans-serif !important; }
            `;
            finalCss = fontRule + "\n" + finalCss;
        }
        styleTag.innerHTML = finalCss;

        // D. åº”ç”¨æ°”æ³¡ç¾åŒ– (ç‹¬ç«‹æ ·å¼æ ‡ç­¾) - ã€ä¿®å¤ï¼šç§»åˆ°äº†ifå¤–é¢ã€‘
        let bubbleStyleTag = document.getElementById('user-bubble-style');
        if (!bubbleStyleTag) {
            bubbleStyleTag = document.createElement('style');
            bubbleStyleTag.id = 'user-bubble-style';
            document.head.appendChild(bubbleStyleTag);
        }
        bubbleStyleTag.innerHTML = themeConfig.bubbleCss || "";
    }

    function updateAppIcon(elementId, url) {
        const el = document.getElementById(elementId);
        if(!el) return;
        if (url && url.trim() !== "") {
            el.style.backgroundImage = `url(${url})`;
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            el.style.color = 'transparent';
        } else {
            el.style.backgroundImage = '';
            el.style.color = 'white';
        }
    }

    function resetTheme() {
        if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®å—ï¼Ÿ")) {
            localStorage.removeItem('ai_phone_theme');
            location.reload();
        }
    }

        async function fetchModels() {
            if(!globalConfig.apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
            const btn = event.target;
            btn.innerText = "åŠ è½½ä¸­...";
            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/models', {
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey }
                });
                const data = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ¨¡å‹</option>';
                
                // å…¼å®¹ OpenAI å’Œ å…¼å®¹æ¥å£çš„è¿”å›æ ¼å¼
                const list = data.data || data; 
                if(Array.isArray(list)) {
                    list.sort((a,b) => a.id.localeCompare(b.id));
                    list.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.innerText = m.id;
                        select.appendChild(opt);
                    });
                    document.getElementById('modelSelectContainer').style.display = 'flex';
                } else {
                    alert("API è¿”å›æ ¼å¼æœªèƒ½è¯†åˆ«");
                }
            } catch(e) {
                alert("è·å–æ¨¡å‹å¤±è´¥: " + e.message);
            }
            btn.innerText = "â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨";
        }

        function resetAll() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- å·¥å…·å‡½æ•° ---
        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }
        function closeModal(id) { 
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 200);
        }
        function formatText(text) { return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); }
        function normalizeUrl(u) { return u.endsWith('/') ? u.slice(0,-1) : u; }
        function scrollToBottom() { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const t = now.toLocaleTimeString('zh-CN', {hour12:false,hour:'2-digit',minute:'2-digit'});
                document.getElementById('clockTime').innerText = t;
                document.getElementById('clockDate').innerText = now.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'long'});
            }, 1000);
        }
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            fileToBase64(f).then(res => {
                currentImg = res;
                document.getElementById('img-preview-blob').src = currentImg;
                document.getElementById('uploadPreview').style.display = 'flex';
            });
        }
        function clearUpload() { currentImg=null; document.getElementById('uploadPreview').style.display='none'; document.getElementById('fileInput').value=''; }
        function fileToBase64(file) {
            return new Promise(resolve => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    // ç®€å•å‹ç¼©
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = Math.min(1, 800/img.width); // é™åˆ¶æœ€å¤§å®½åº¦800
                        cvs.width = img.width * scale; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }
        
        // å¯¼å‡º/å¯¼å…¥
        // --- æ•°æ®å¤‡ä»½ä¸æ¢å¤ (å…¨é‡ç‰ˆ) ---
        function exportData() {
            // æŠŠ è®¾ç½®ã€è”ç³»äºº(å«è®°å¿†)ã€ç¾åŒ–æ•°æ® æ‰“åŒ…åœ¨ä¸€èµ·
            const backupPayload = {
                globalConfig: globalConfig,
                contacts: contacts,
                themeConfig: themeConfig 
            };
            
            const blob = new Blob([JSON.stringify(backupPayload)], {type:'application/json'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'ai_phone_full_backup.json'; // æ”¹ä¸ªåå­—ï¼Œå«å…¨é‡å¤‡ä»½
            a.click();
        }

        function importData(e) {
            const f = e.target.files[0]; 
            if(!f) return;
            
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    
                    // 1. æ¢å¤å…¨å±€è®¾ç½®
                    if(d.globalConfig) {
                        globalConfig = d.globalConfig;
                        localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
                    }

                    // 2. æ¢å¤è”ç³»äºº (åŒ…å«èŠå¤©è®°å½•ã€è®°å¿†åº“)
                    if(d.contacts) {
                        contacts = d.contacts;
                        localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
                    }

                    // 3. æ¢å¤ç¾åŒ–è®¾ç½® (å›¾æ ‡ã€CSSã€å­—ä½“)
                    if(d.themeConfig) {
                        themeConfig = d.themeConfig;
                        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
                    }

                    alert("ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†é‡æ–°åŠ è½½ä»¥åº”ç”¨æ›´æ”¹ã€‚");
                    location.reload(); // åˆ·æ–°é¡µé¢ï¼Œè®©æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆ
                    
                } catch(e) {
                    alert("âŒ æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å†…å®¹å·²æŸåã€‚\n" + e.message);
                }
            }; 
            r.readAsText(f);
            // æ¸…ç©º input é˜²æ­¢åŒåæ–‡ä»¶æ— æ³•å†æ¬¡è§¦å‘
            e.target.value = ''; 
        }
        async function testConn() {
            try { 
                await fetch(normalizeUrl(globalConfig.apiUrl)+'/models', {headers:{Authorization:"Bearer "+globalConfig.apiKey}}); 
                alert("è¿æ¥æˆåŠŸï¼"); 
            } catch(e) { alert("è¿æ¥å¤±è´¥: "+e.message); }
        }
        // --- 5. æ—¥è®°æœ¬æ¸²æŸ“é€»è¾‘ (æ–°å¢) ---
    function renderDiaries() {
        const char = getActiveChar();
        const container = document.getElementById('diaryListContainer');
        container.innerHTML = '';

        if (!char) {
            container.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¯·å…ˆä»ä¿¡æ¯åˆ—è¡¨è¿›å…¥ä¸€ä¸ªèŠå¤©</p>';
            return;
        }
        
        if (!char.diaries || char.diaries.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°å“¦<br>å»èŠå¤©ç•Œé¢ç‚¹å‡» âœ¨ ç”Ÿæˆå§</p>';
            return;
        }

        // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„æ—¥è®°åœ¨æœ€ä¸Šé¢
        const reversedDiaries = [...char.diaries].reverse();

        reversedDiaries.forEach((content, index) => {
            // è®¡ç®—åŸå§‹ç´¢å¼• (ç”¨äºåˆ é™¤)
            const originalIndex = char.diaries.length - 1 - index;
            
            const card = document.createElement('div');
            card.className = 'memory-card'; // å¤ç”¨è®°å¿†å¡çš„æ ·å¼
            // æŠŠæ¢è¡Œç¬¦è½¬ä¸ºbrï¼Œç¨å¾®ç¾åŒ–ä¸€ä¸‹æ˜¾ç¤º
            const displayContent = content.replace(/\n/g, '<br>');
            
            card.innerHTML = `
<div style="line-height:1.6; color:#333;">
                    ${displayContent}
                </div>
                <div class="btn-del-mem" onclick="deleteDiary(${originalIndex})">Ã—</div>
            `;
            container.appendChild(card);
        });
    }

    function deleteDiary(index) {
        const char = getActiveChar();
        if (confirm('ç¡®å®šè¦æ’•æ‰è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
            char.diaries.splice(index, 1);
            saveData();
            renderDiaries();
        }
    }
        // --- 6. åˆ é™¤æŒ‡å®šèŒƒå›´æ¶ˆæ¯çš„é€»è¾‘ (æ–°) ---
    function openDeleteMsgModal() {
        const char = getActiveChar();
        if(!char) return;
        
        // å…ˆå…³é—­è®¾ç½®å¼¹çª—ï¼Œå†å¼€åˆ é™¤å¼¹çª—ï¼Œä½“éªŒæ›´å¥½
        closeModal('modal-chat-settings');

        const total = char.messages.length;
        if (total === 0) return alert("åœ¨è¿™ä¸ªèŠå¤©ä¸­è¿˜æ²¡æœ‰æ¶ˆæ¯å“¦");

        document.getElementById('del-total-count').innerText = total;
        // é»˜è®¤å¡«å…¥ï¼šä»æœ€åä¸€æ¡åˆ åˆ°æœ€åä¸€æ¡ï¼ˆå³åˆ é™¤æœ€æ–°çš„ä¸€æ¡ï¼‰
        document.getElementById('del-start').value = total; 
        document.getElementById('del-end').value = total;
        
        openModal('modal-del-msg');
    }

    function commitDeleteMsg() {
        const char = getActiveChar();
        const startVal = parseInt(document.getElementById('del-start').value);
        const endVal = parseInt(document.getElementById('del-end').value);
        const total = char.messages.length;

        // 1. æ ¡éªŒè¾“å…¥
        if (isNaN(startVal) || isNaN(endVal)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        if (startVal < 1 || startVal > total) return alert("èµ·å§‹æ¥¼å±‚ä¸å­˜åœ¨");
        if (endVal < 1 || endVal > total) return alert("ç»“æŸæ¥¼å±‚ä¸å­˜åœ¨");
        if (startVal > endVal) return alert("èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚");

        // 2. è®¡ç®—åˆ é™¤æ•°é‡
        // æ¯”å¦‚è¦åˆ ç¬¬3æ¡åˆ°ç¬¬5æ¡ (3, 4, 5)ï¼Œé‚£å°±æ˜¯åˆ æ‰ (5-3)+1 = 3æ¡
        // æ•°ç»„ç´¢å¼•æ˜¯ 0-basedï¼Œæ‰€ä»¥ç¬¬3æ¡å¯¹åº”çš„ç´¢å¼•æ˜¯ 2
        const startIndex = startVal - 1;
        const deleteCount = endVal - startVal + 1;

        if (confirm(`âš ï¸  \n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç¬¬ ${startVal} åˆ° ${endVal} æ¥¼çš„ ${deleteCount} æ¡æ¶ˆæ¯å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
            
            // æ‰§è¡Œåˆ é™¤ (spliceä¼šä¿®æ”¹åŸæ•°ç»„)
            char.messages.splice(startIndex, deleteCount);
            
            saveData(); // ä¿å­˜
            
            // åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            updateContactList(); // åˆ—è¡¨é‡Œçš„é¢„è§ˆæ–‡å­—ä¹Ÿå¯èƒ½å˜äº†
            
            closeModal('modal-del-msg');
            alert("åˆ é™¤æˆåŠŸï¼");
        }
    }
        // --- 7. æ¶ˆæ¯ç¼–è¾‘ä¸é‡åˆ· (æ–°åŠŸèƒ½) ---

    // åŠŸèƒ½Aï¼šAI é‡åˆ· (Re-roll)
    function rerollMessage(uiIndex) {
        const char = getActiveChar();
        // uiIndex æ˜¯ä»1å¼€å§‹çš„ï¼Œæ•°ç»„æ˜¯ä»0å¼€å§‹çš„
        const arrayIndex = uiIndex - 1;
        
        if(arrayIndex < 0 || arrayIndex >= char.messages.length) return;

        // é€»è¾‘ï¼šåˆ é™¤ è¿™æ¡AIæ¶ˆæ¯ ä»¥åŠ å®ƒä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        // å› ä¸ºé‡åˆ·æ„å‘³ç€æ—¶é—´çº¿å˜åŠ¨ï¼Œåé¢çš„å¯¹è¯å°±ä½œåºŸäº†
        if(confirm("è¦è®©ä»–é‡æ–°å›ç­”è¿™ä¸€å¥å—ï¼Ÿ(ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)")) {
            char.messages.splice(arrayIndex, 999); // åˆ é™¤å½“å‰åŠä¹‹åæ‰€æœ‰
            saveData();
            
            // åˆ·æ–°ç•Œé¢æ˜¾ç¤ºåˆ é™¤åçš„çŠ¶æ€
            renderChat(activeContactId);
            
            // ç«‹å³è§¦å‘ AI ç”Ÿæˆ
            triggerAI();
        }
    }

    // åŠŸèƒ½Bï¼šç”¨æˆ·é•¿æŒ‰ç¼–è¾‘
    function handleUserEdit(e, uiIndex) {
        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„å³é”®èœå•
        
        const char = getActiveChar();
        const arrayIndex = uiIndex - 1;
        const msg = char.messages[arrayIndex];
        
        if(!msg) return;

        // ä½¿ç”¨ prompt è®©ç”¨æˆ·ä¿®æ”¹æ–‡æœ¬
        const newText = prompt("ç¼–è¾‘æ¶ˆæ¯ï¼š", msg.content);
        
        // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆæˆ–è€…å†…å®¹æ²¡å˜ï¼Œå°±ä¸åŠ¨
        if (newText === null || newText === msg.content) return;

        if(confirm("ä¿®æ”¹åï¼Œä»–å°†æ ¹æ®æ–°å†…å®¹é‡æ–°å›å¤ (ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)ï¼Œç¡®å®šå—ï¼Ÿ")) {
            // 1. æ›´æ–°å½“å‰æ¶ˆæ¯å†…å®¹
            msg.content = newText;
            
            // 2. åˆ é™¤ è¿™æ¡æ¶ˆæ¯ä¹‹å çš„æ‰€æœ‰æ¶ˆæ¯ (å› ä¸ºç”¨æˆ·æ”¹äº†å†å²ï¼Œæœªæ¥å¿…é¡»é‡å†™)
            char.messages.splice(arrayIndex + 1, 999);
            
            saveData();
            
            // 3. åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            
            // 4. è§¦å‘ AI é‡æ–°å›å¤
            triggerAI();
        }
    }
        // --- ç•ªèŒ„é’Ÿé€»è¾‘æ¨¡å— ---

let pomoState = {
    timerId: null,
    timeLeft: 0,      // ç§’
    totalTime: 0,     // ç§’
    charId: null,
    task: "",
    intervalSeconds: 0, // ä¸»åŠ¨å‘è¨€é—´éš”
    pokes: 0,         // ç”¨æˆ·æˆ³äº†å¤šå°‘æ¬¡
    lastSpeakTime: 0,  // ä¸Šæ¬¡AIè¯´è¯çš„å‰©ä½™æ—¶é—´ç‚¹
    lastReply: ""
};
        // --- å±å¹•å¸¸äº®æ§åˆ¶ (æ–°å¢) ---
let wakeLock = null;

async function setScreenKeepOn(status) {
    if ('wakeLock' in navigator) {
        try {
            if (status) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("å±å¹•å¸¸äº®å·²å¼€å¯");
            } else {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log("å±å¹•å¸¸äº®å·²å…³é—­");
                }
            }
        } catch (err) {
            console.log("å±å¹•å¸¸äº®è®¾ç½®å¤±è´¥:", err);
        }
    }
}

// ç›‘å¬é¡µé¢åˆ‡æ¢ï¼šå¦‚æœä½ åˆ‡å‡ºå»å›æ¶ˆæ¯ï¼Œå†åˆ‡å›æ¥ï¼Œéœ€è¦é‡æ–°ç”³è¯·å¸¸äº®
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await setScreenKeepOn(true);
    }
});

// 1. åˆå§‹åŒ–é¡µé¢ï¼šåŠ è½½è§’è‰²åˆ—è¡¨
function initPomoPage() {
    const select = document.getElementById('pomoCharSelect');
    select.innerHTML = '';
    contacts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        select.appendChild(opt);
    });
    // å¦‚æœä¹‹å‰æœ‰è®°å½•ï¼Œæ¢å¤é»˜è®¤å€¼
    if(activeContactId) select.value = activeContactId;
}

// 2. å¼€å§‹ä¸“æ³¨
function startPomoTimer() {
    const charId = document.getElementById('pomoCharSelect').value;
    const duration = parseInt(document.getElementById('pomoDuration').value);
    const task = document.getElementById('pomoTask').value || "å‘å‘†";
    const interval = parseInt(document.getElementById('pomoInterval').value);

    if(!charId) return alert("è¯·é€‰æ‹©ä¸€ä¸ªä¼´è¯»è§’è‰²");
    if(duration < 1) return alert("æ—¶é—´å¤ªçŸ­å•¦");

    // åˆå§‹åŒ–çŠ¶æ€
    pomoState.charId = charId;
    pomoState.totalTime = duration * 60;
    pomoState.timeLeft = pomoState.totalTime;
    pomoState.task = task;
    pomoState.intervalSeconds = interval > 0 ? interval * 60 : 999999;
    pomoState.pokes = 0;
    pomoState.lastSpeakTime = pomoState.timeLeft;

    // åˆ‡æ¢UI
    document.getElementById('pomo-setup').style.display = 'none';
    document.getElementById('pomo-running').style.display = 'flex';
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === charId);
    document.getElementById('pomo-avatar').src = char.avatar;
    document.getElementById('pomo-task-display').innerText = `æ­£åœ¨ä¸“æ³¨: ${task}`;
    document.getElementById('pomo-ai-bubble').innerText = "è®¡æ—¶å¼€å§‹ï¼åŠ æ²¹å“¦ï¼(ç‚¹å‡»æˆ‘å¯ä»¥æˆ³ä¸€æˆ³)";

    // å¯åŠ¨è®¡æ—¶å™¨
    updatePomoDisplay();
    pomoState.timerId = setInterval(pomoTick, 1000);

    // è§¦å‘ä¸€æ¬¡AIå¼€åœºç™½
    triggerPomoAI("start");
    // å¼€å¯å±å¹•å¸¸äº®
    setScreenKeepOn(true);
}

// 3. è®¡æ—¶å™¨å¿ƒè·³ (æ¯ç§’æ‰§è¡Œ)
function pomoTick() {
    if(pomoState.timeLeft <= 0) {
        finishPomo();
        return;
    }

    pomoState.timeLeft--;
    updatePomoDisplay();

    // æ£€æŸ¥æ˜¯å¦åˆ°äº†è‡ªåŠ¨å‘è¨€æ—¶é—´
    const timeSinceLastSpeak = pomoState.lastSpeakTime - pomoState.timeLeft;
    if(timeSinceLastSpeak >= pomoState.intervalSeconds) {
        triggerPomoAI("auto_check");
        pomoState.lastSpeakTime = pomoState.timeLeft;
    }
}

// 4. æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
function updatePomoDisplay() {
    const m = Math.floor(pomoState.timeLeft / 60).toString().padStart(2, '0');
    const s = (pomoState.timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('pomo-timer-display').innerText = `${m}:${s}`;
}

// 5. æˆ³ä¸€æˆ³äº¤äº’
function pokePomoChar() {
    if(!pomoState.timerId) return; // æ²¡å¼€å§‹ä¸èƒ½æˆ³

    pomoState.pokes++;
    
    // è§†è§‰ç‰¹æ•ˆ
    const img = document.getElementById('pomo-avatar');
    img.classList.remove('anim-shake');
    void img.offsetWidth; // è§¦å‘é‡ç»˜
    img.classList.add('anim-shake');

    const effect = document.getElementById('poke-effect');
    effect.style.opacity = 1;
    effect.style.top = '40%';
    setTimeout(() => { effect.style.opacity = 0; effect.style.top = '50%'; }, 500);

    // è§¦å‘AIååº”
    triggerPomoAI("poke");
}

// 6. ç»“æŸ/é€€å‡º
function quitPomo() {
    if(pomoState.timerId) {
        if(!confirm("ä¸“æ³¨è¿˜æ²¡ç»“æŸï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ")) return;
        clearInterval(pomoState.timerId);
        pomoState.timerId = null;
        savePomoToChat(false);
    }
    // æ¢å¤UI
    document.getElementById('pomo-setup').style.display = 'block';
    document.getElementById('pomo-running').style.display = 'none';
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    goHome(); // æˆ–è€…è¿”å›ä¸Šçº§
}

function finishPomo() {
    clearInterval(pomoState.timerId);
    pomoState.timerId = null;
    savePomoToChat(true);
    triggerPomoAI("finish");
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    alert("ä¸“æ³¨æ—¶é—´åˆ°ï¼ä½ çœŸæ£’ï¼");
    // å¯ä»¥åœ¨è¿™é‡Œæ’­æ”¾æç¤ºéŸ³
}
        // --- æ–°å¢ï¼šå°†ä¸“æ³¨ç»“æœå†™å…¥èŠå¤©è®°å¿† (æ¸©æš–ä¸ªæ€§åŒ–ç‰ˆ) ---
function savePomoToChat(isSuccess) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if (!char) return;

    // 1. è·å–åå­—
    const myName = char.userName || "æˆ‘"; // ä½ çš„æ˜µç§°
    const aiName = char.name || "Ta";     // è§’è‰²çš„åå­—

    // 2. è®¡ç®—æ•°æ®
    const timeSpent = Math.ceil((pomoState.totalTime - pomoState.timeLeft) / 60);
    const totalDuration = Math.ceil(pomoState.totalTime / 60);

    // 3. ç”Ÿæˆæ›´æœ‰æ¸©åº¦çš„æ–‡æ¡ˆ
    let resultStr = isSuccess 
        ? `ğŸ‰ ${myName} æˆåŠŸåšæŒäº†å…¨ç¨‹ï¼` 
        : `â¹ï¸ ${myName} ä¸­é€”æºœèµ°äº†...`;

    // 4. æ„å»ºâ€œéšå½¢æç¤ºâ€
    const summary = `
ã€ğŸ•’ ä¸“æ³¨æ¨¡å¼è®°å½•ã€‘
------------------
ğŸ‘¤ ä¸»è§’ï¼š${myName} & ${aiName}
ğŸ“ ä»»åŠ¡ï¼š${pomoState.task}
â±ï¸ æ—¶é•¿ï¼š${timeSpent} åˆ†é’Ÿ (è®¡åˆ’ ${totalDuration} åˆ†é’Ÿ)
ğŸ’¡ çŠ¶æ€ï¼š${resultStr}
ğŸ‘ˆ äº’åŠ¨ï¼š${myName} æˆ³äº† ${aiName} ${pomoState.pokes} æ¬¡
ğŸ’¬ ${aiName}æœ€åçš„ç•™è¨€ï¼š"${pomoState.lastReply || '...'}"
------------------
(ç³»ç»Ÿæç¤ºï¼šä»¥ä¸Šæ˜¯åˆšæ‰å‘ç”Ÿçš„çœŸå®æƒ…å†µã€‚è¯·${aiName}æ ¹æ®è¿™ä¸ªç»“æœä¸${myName}ç»§ç»­å¯¹è¯ã€‚å¦‚æœ${myName}æˆåŠŸäº†å°±å¤¸å¤¸ï¼Œå¤±è´¥äº†å°±è°ƒä¾ƒä¸€ä¸‹ï¼Œå¦‚æœæˆ³å¾—å¾ˆå¤šå¯ä»¥åæ§½æ‰‹å¤ªæ¬ ã€‚)
    `.trim();

    // 5. å­˜å…¥èŠå¤©è®°å½•
    char.messages.push({ 
        role: 'user', 
        content: summary 
    });
    
    saveData(); 
}

// 7. æ ¸å¿ƒï¼šç•ªèŒ„é’Ÿä¸“ç”¨çš„ AI è§¦å‘é€»è¾‘
async function triggerPomoAI(reason) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if(!char || !globalConfig.apiKey) return;

    const bubble = document.getElementById('pomo-ai-bubble');
    const originalText = bubble.innerText;
    bubble.innerText = "ğŸ’¬ æ­£åœ¨æ€è€ƒ...";

    // æ„å»ºé’ˆå¯¹ä¸“æ³¨æ¨¡å¼çš„ Prompt
    const minsLeft = Math.ceil(pomoState.timeLeft / 60);
    let systemInstruction = `
        ä½ æ­£åœ¨â€œç•ªèŒ„é’Ÿä¸“æ³¨æ¨¡å¼â€ä¸‹é™ªä¼´ç”¨æˆ·ã€‚
        ç”¨æˆ·æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼š${pomoState.task}ã€‚
        å‰©ä½™æ—¶é—´ï¼š${minsLeft}åˆ†é’Ÿã€‚
        ã€å½“å‰çŠ¶æ€ã€‘ï¼šç”¨æˆ·ç›®å‰å·²ç»â€œæˆ³ä¸€æˆ³â€éªšæ‰°äº†ä½  ${pomoState.pokes} æ¬¡ã€‚
        ä½ çš„æ€§æ ¼ï¼š${char.systemPrompt}ã€‚
        
        è¯·æ ¹æ®å½“å‰çš„è§¦å‘åŸå› ï¼Œè¯´ä¸€å¥ç®€çŸ­çš„è¯ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š
    `;

    let userTrigger = "";
    if(reason === "start") userTrigger = "æˆ‘åˆšå¼€å§‹è®¡æ—¶ï¼Œé¼“åŠ±æˆ‘ä¸€ä¸‹ã€‚";
    if(reason === "auto_check") userTrigger = `æ—¶é—´è¿‡å»äº†${pomoState.intervalSeconds/60}åˆ†é’Ÿï¼Œæ£€æŸ¥ä¸€ä¸‹æˆ‘çš„çŠ¶æ€ï¼Œæé†’æˆ‘ä¿æŒä¸“æ³¨ã€‚`;
    if(reason === "poke") userTrigger = `æˆ‘åˆšåˆšæˆ³äº†ä½ ä¸€ä¸‹ï¼ˆè¿™æ˜¯ç¬¬${pomoState.pokes}æ¬¡æˆ³ä½ ï¼‰ã€‚æ ¹æ®å‰©ä½™æ—¶é—´${minsLeft}åˆ†é’Ÿï¼Œå¯¹æˆ‘çš„éªšæ‰°åšå‡ºååº”ï¼ˆå¦‚æœæ—¶é—´è¿˜å¤šå°±é™ªæˆ‘ç©ä¸€ä¸‹ï¼Œå¦‚æœå¿«ç»“æŸäº†å°±è®©æˆ‘èµ¶ç´§ä¸“å¿ƒï¼‰ã€‚`;
    if(reason === "finish") userTrigger = "è®¡æ—¶ç»“æŸäº†ï¼å¤¸å¥–æˆ‘ï¼";

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: systemInstruction },
                    { role: "user", content: userTrigger }
                ],
                temperature: 0.7
            })
        });
        
        const data = await res.json();
        const reply = data.choices[0].message.content;
        
        bubble.innerText = reply;
        pomoState.lastReply = reply;
        pomoState.lastSpeakTime = pomoState.timeLeft;

        // ã€å¯é€‰ã€‘æŠŠè¿™æ®µè¯ä¹Ÿå­˜å…¥èŠå¤©è®°å½•ï¼Œè¿™æ ·å›åˆ°èŠå¤©ç•Œé¢ä¹Ÿèƒ½çœ‹åˆ°
        // char.messages.push({ role: 'assistant', content: `[ä¸“æ³¨æ¨¡å¼]: ${reply}` });
        // saveData();

    } catch(e) {
        bubble.innerText = originalText; // å¤±è´¥å›æ»š
        console.error(e);
    }
}
        // ==========================================
// --- æ ¸å¿ƒåŠŸèƒ½ï¼šPop é£æ ¼è¿ç¯è¿½é—®ä¸æ—¶é—´å›å¡«ç³»ç»Ÿ ---
// ==========================================

// ==========================================
// --- è°ƒè¯•ä¸“ç”¨ç‰ˆï¼šå¼ºåˆ¶è§¦å‘ç¦»çº¿æ¶ˆæ¯ ---
// ==========================================

async function processAutoReplyChain(charId) {
    const char = contacts.find(c => c.id === charId);
    
    // 1. æ£€æŸ¥è®¾ç½®
    if (!char) return;
    const interval = char.autoReplyInterval || 0;
    
    // --- è°ƒè¯•å¼¹çª— A ---
    // alert(`è°ƒè¯•ä¿¡æ¯:\nè§’è‰²: ${char.name}\nè®¾ç½®é—´éš”: ${interval}å°æ—¶`);

    if (interval <= 0) return;

    const now = Date.now();
    
    // 2. è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´
    let lastMsg = char.messages[char.messages.length - 1];
    let lastMsgTime = lastMsg ? (lastMsg.timestamp || char.lastActiveTime || now) : now;


    const intervalMs = interval * 60 * 60 * 1000; 
    const maxConsecutive = 5; 
    let addedCount = 0;

    const titleDom = document.getElementById('chat-title-name');
    const originalTitle = titleDom ? titleDom.innerText : char.name;

    let virtualClock = lastMsgTime; 

    // --- è°ƒè¯•å¼¹çª— B ---
    // alert("å‡†å¤‡å¼€å§‹è®¡ç®—æ—¶é—´å·®...");

    while (addedCount < maxConsecutive) {
        // æ³¢åŠ¨èŒƒå›´
        const jitter = (Math.random() * 60 * 60 * 1000) - (30 * 60 * 1000);
        let nextTargetTime = virtualClock + intervalMs + jitter;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å‘
        if (nextTargetTime < now) {
            // --- è°ƒè¯•å¼¹çª— C ---
            // alert(`è§¦å‘æˆåŠŸï¼\næ­£åœ¨è¡¥å‘ç¬¬ ${addedCount+1} æ¡æ¶ˆæ¯...`);

            if(titleDom) titleDom.innerText = `æ­£åœ¨æ¥æ”¶ç¦»çº¿æ¶ˆæ¯ (${addedCount + 1})...`;
            
            virtualClock = nextTargetTime; 
            
            // è¿™é‡Œçš„ await å¯èƒ½ä¼šå› ä¸ºç½‘ç»œæ…¢è€Œå¡ä½ï¼Œæ³¨æ„çœ‹æ•ˆæœ
            try {
                await generateBackfillMessage(char, nextTargetTime, addedCount + 1);
                addedCount++;
            } catch (err) {
                alert("API è¯·æ±‚å¤±è´¥ï¼š" + err.message);
                break;
            }
            
        } else {
            break;
        }
    }
    
    if(titleDom) titleDom.innerText = originalTitle;
    if (addedCount > 0) {
        saveData(); 
        // alert("ç¦»çº¿æ¶ˆæ¯æ¥æ”¶å®Œæ¯•ï¼");
    } else {
        // alert("æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦è¡¥å‘çš„æ¶ˆæ¯ (æ—¶é—´è¿˜æ²¡åˆ°)");
    }
}

// ç”Ÿæˆå•æ¡å›å¡«æ¶ˆæ¯çš„å‡½æ•°
async function generateBackfillMessage(char, simulatedTime, chainIndex) {
    // è®¡ç®—æ¨¡æ‹Ÿæ—¶é—´ç‚¹çš„æ—¥æœŸæè¿°
    const simDate = new Date(simulatedTime);
    const timeStr = simDate.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
    const dayStr = simDate.toLocaleDateString('zh-CN', {weekday: 'long'});
    
    // è®¡ç®—è¿™ä¸ªæ¨¡æ‹Ÿç‚¹è·ç¦»ç”¨æˆ·æœ€åä¸€æ¬¡è¯´è¯ï¼ˆæˆ–äº’åŠ¨ï¼‰è¿‡äº†å¤šä¹…
    const hoursSinceUser = Math.floor((simulatedTime - (char.lastActiveTime || simulatedTime)) / (1000 * 60 * 60));
    
    // æ„å»º Prompt
    const backfillPrompt = `
    ã€åœºæ™¯æ¨¡æ‹Ÿï¼šç¦»çº¿è¡¥å‘æ¶ˆæ¯ã€‘
    ç°åœ¨æ˜¯è™šæ‹Ÿæ—¶é—´ï¼š${dayStr} ${timeStr}ã€‚
    ç°çŠ¶ï¼šç”¨æˆ·å·²ç»æ¶ˆå¤±äº†çº¦ ${hoursSinceUser} å°æ—¶ã€‚
    è¿™æ˜¯ä½ ã€è¿ç»­ç¬¬ ${chainIndex} æ¬¡ã€‘ä¸»åŠ¨å‘æ¶ˆæ¯å¯»æ‰¾ç”¨æˆ·ï¼ˆç”¨æˆ·ä¹‹å‰çš„éƒ½æ²¡å›ï¼‰ã€‚
    
    è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šå’Œå½“å‰çš„è™šæ‹Ÿæ—¶é—´ç‚¹ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ã€‚
    è¦æ±‚ï¼š
    1. å¦‚æœæ˜¯ç¬¬1æ¬¡è¿½é—®ï¼šè¯­æ°”æ­£å¸¸ï¼Œå¼€å¯æ–°è¯é¢˜æˆ–é—®å€™ã€‚
    2. å¦‚æœæ˜¯ç¬¬2-3æ¬¡è¿½é—®ï¼šè¯­æ°”å¼€å§‹ç–‘æƒ‘ã€æ‹…å¿§æˆ–ç¨å¾®æœ‰ç‚¹å°æƒ…ç»ªã€‚
    3. å¦‚æœæ˜¯ç¬¬4-5æ¬¡è¿½é—®ï¼šè¯­æ°”å¯ä»¥æ˜¯å¤±è½ã€è‡ªè¨€è‡ªè¯­æˆ–è€…å‡è£…ç”Ÿæ°”ã€‚
    4. ç»“åˆæ—¶é—´ç‚¹ï¼ˆæ¯”å¦‚æ·±å¤œã€æ¸…æ™¨ï¼‰è‡ªç„¶å‘æŒ¥ã€‚
    5. å­—æ•°ä¸è¦è¶…è¿‡äº”åå­—ã€‚
    6. ã€é‡è¦ã€‘ç»å¯¹ä¸è¦é‡å¤ä½ ä¸Šä¸€æ¡å‘é€çš„å†…å®¹ï¼å¿…é¡»æ¢ä¸€ç§è¯´æ³•æˆ–æ¢ä¸ªè§’åº¦ã€‚
    `;

    // è°ƒç”¨ API
    try {
        // æˆªå–æœ€è¿‘ 15 æ¡è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
        const history = char.messages.slice(-15).map(m => ({ 
            role: m.role, 
            content: m.content 
        }));

        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: char.systemPrompt },
                    ...history,
                    { role: "system", content: backfillPrompt }
                ],
                temperature: 0.85 
            })
        });
        
        const data = await res.json();
        const reply = data.choices[0].message.content;

        // å­˜å…¥æ¶ˆæ¯ï¼Œæ³¨æ„ï¼štimestamp ä½¿ç”¨æ¨¡æ‹Ÿçš„é‚£ä¸ªè¿‡å»çš„æ—¶é—´ï¼
        char.messages.push({ 
            role: 'assistant', 
            content: reply,
            timestamp: simulatedTime 
        });

        // ç«‹å³æ¸²æŸ“åˆ°ç•Œé¢ä¸Šï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯â€œå¼¹â€å‡ºæ¥
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸æ’­æ”¾æ‰“å­—åŠ¨ç”»ï¼Œç›´æ¥æ˜¾ç¤ºï¼Œå› ä¸ºæ˜¯å†å²æ¶ˆæ¯
        appendMsgUI('assistant', reply, null, char.messages.length, false, simulatedTime);

    } catch (e) {
        console.error("è¡¥å‘ç”Ÿæˆå¤±è´¥", e);
    }
}
        // ==========================================
// --- 9. æ—¥å† (Calendar) é€»è¾‘æ¨¡å— ---
// ==========================================

let calState = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(), // 0-11
    selectedDateStr: null // æ ¼å¼ YYYY-MM-DD
};

// åˆå§‹åŒ–é¡µé¢
function initCalendarPage() {
    const now = new Date();
    calState.year = now.getFullYear();
    calState.month = now.getMonth();
    renderCalendar();
    // é»˜è®¤é€‰ä¸­ä»Šå¤©
    selectDate(formatDateKey(now.getFullYear(), now.getMonth(), now.getDate()));
}

function jumpToToday() {
    initCalendarPage();
}

function changeMonth(delta) {
    calState.month += delta;
    if(calState.month > 11) {
        calState.month = 0;
        calState.year++;
    } else if(calState.month < 0) {
        calState.month = 11;
        calState.year--;
    }
    renderCalendar();
}

// æ ¸å¿ƒï¼šæ¸²æŸ“æ—¥å†ç½‘æ ¼
function renderCalendar() {
    const grid = document.getElementById('cal-grid');
    const title = document.getElementById('cal-current-month');
    
    grid.innerHTML = '';
    title.innerText = `${calState.year}å¹´ ${calState.month + 1}æœˆ`;

    const char = getActiveChar(); // è·å–å½“å‰èŠå¤©çš„è§’è‰²æ•°æ®
    
    // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
    const firstDay = new Date(calState.year, calState.month, 1).getDay();
    // è®¡ç®—å½“æœˆæœ‰å¤šå°‘å¤©
    const daysInMonth = new Date(calState.year, calState.month + 1, 0).getDate();

    // å¡«å……ç©ºç™½æ ¼ (ä¸Šä¸ªæœˆçš„ä½™å°¾)
    for(let i=0; i<firstDay; i++) {
        const div = document.createElement('div');
        div.className = 'cal-cell empty';
        grid.appendChild(div);
    }

    // å¡«å……çœŸå®æ—¥æœŸ
    const todayKey = formatDateKey(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

    for(let d=1; d<=daysInMonth; d++) {
        const dateKey = formatDateKey(calState.year, calState.month, d);
        const div = document.createElement('div');
        div.className = 'cal-cell';
        if(dateKey === todayKey) div.classList.add('today');
        
        // æ¸²æŸ“æ•°å­—
        div.innerHTML = `<span>${d}</span><div class="cal-dot-container"></div>`;
        
        // --- æ¸²æŸ“æ ‡è®°ç‚¹ (å¦‚æœæœ‰æ•°æ®) ---
        if(char) {
            // 1. æ¸²æŸ“èŠ‚æ—¥/äº‹ä»¶ (æ©™è‰²ç‚¹)
            if(char.calendarEvents && char.calendarEvents[dateKey]) {
                const dot = document.createElement('div');
                dot.className = 'dot-event';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
            // 2. æ¸²æŸ“ç»æœŸå¼€å§‹æ—¥ (ç²‰è‰²ç‚¹)
            if(char.periodLog && char.periodLog.includes(dateKey)) {
                const dot = document.createElement('div');
                dot.className = 'dot-period';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
        }

        div.onclick = () => selectDate(dateKey, div);
        // è®°å½•DOMå¼•ç”¨æ–¹ä¾¿é«˜äº®
        div.dataset.date = dateKey; 
        grid.appendChild(div);
    }
    
    // é‡æ–°é«˜äº®å½“å‰é€‰ä¸­çš„æ—¥æœŸ
    if(calState.selectedDateStr) {
        const el = grid.querySelector(`div[data-date="${calState.selectedDateStr}"]`);
        if(el) el.classList.add('active');
    }
}

// é€‰ä¸­æŸä¸€å¤©çš„é€»è¾‘
function selectDate(dateKey, element) {
    calState.selectedDateStr = dateKey;
    
    // UI é«˜äº®åˆ‡æ¢
    document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('active'));
    if(element) {
        element.classList.add('active');
    } else {
        // å¦‚æœæ˜¯ä»ä»£ç è°ƒç”¨çš„ï¼ˆæ¯”å¦‚åˆå§‹åŒ–ï¼‰ï¼Œæ‰‹åŠ¨æ‰¾DOM
        const el = document.getElementById('cal-grid').querySelector(`div[data-date="${dateKey}"]`);
        if(el) el.classList.add('active');
    }

    // æ›´æ–°ä¸‹æ–¹è¯¦æƒ…é¢æ¿
    document.getElementById('selected-date-title').innerText = dateKey;
    
    const char = getActiveChar();
    if(!char) {
        // å¦‚æœæ²¡é€‰è§’è‰²ï¼Œç¦ç”¨è¾“å…¥
        document.getElementById('cal-event-input').disabled = true;
        document.getElementById('cal-event-input').placeholder = "è¯·å…ˆåœ¨ä¿¡æ¯åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè§’è‰²";
        return;
    } else {
        document.getElementById('cal-event-input').disabled = false;
    }

    // 1. å›æ˜¾äº‹ä»¶æ–‡å­—
    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰å¯¹è±¡å…ˆåˆ›å»º
    if(!char.calendarEvents) char.calendarEvents = {};
    const eventText = char.calendarEvents[dateKey] || "";
    document.getElementById('cal-event-input').value = eventText;

    // 2. å›æ˜¾ç»æœŸæ ‡è®°
    if(!char.periodLog) char.periodLog = [];
    const isPeriodStart = char.periodLog.includes(dateKey);
    document.getElementById('period-check-icon').style.display = isPeriodStart ? 'block' : 'none';
}

// ä¿å­˜äº‹ä»¶æ–‡å­—
function saveCalendarEvent() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const val = document.getElementById('cal-event-input').value.trim();
    if(val) {
        char.calendarEvents[calState.selectedDateStr] = val;
    } else {
        delete char.calendarEvents[calState.selectedDateStr]; // æ¸…ç©ºåˆ™åˆ é™¤
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// åˆ‡æ¢ç»æœŸæ ‡è®°
function togglePeriodMark() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const dateKey = calState.selectedDateStr;
    const index = char.periodLog.indexOf(dateKey);

    if(index >= 0) {
        // å·²ç»æ ‡è®°äº† -> å–æ¶ˆæ ‡è®°
        char.periodLog.splice(index, 1);
        document.getElementById('period-check-icon').style.display = 'none';
    } else {
        // æ²¡æ ‡è®° -> æ·»åŠ æ ‡è®°
        char.periodLog.push(dateKey);
        // æ’åºä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åè®¡ç®—å‘¨æœŸ
        char.periodLog.sort();
        document.getElementById('period-check-icon').style.display = 'block';
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// è¾…åŠ©ï¼šç”Ÿæˆ YYYY-MM-DD å­—ç¬¦ä¸²
function formatDateKey(year, month, day) {
    // month æ˜¯ 0-11ï¼Œéœ€è¦+1
    const m = (month + 1).toString().padStart(2, '0');
    const d = day.toString().padStart(2, '0');
    return `${year}-${m}-${d}`;
}
        // --- 10. AI æ„ŸçŸ¥é€»è¾‘ (å¤§è„‘å‡çº§) ---

function getStatusContext(char) {
    let context = "";
    const now = new Date();
    const todayKey = formatDateKey(now.getFullYear(), now.getMonth(), now.getDate());

    // 1. æ£€æŸ¥ç‰¹æ®ŠèŠ‚æ—¥/çºªå¿µæ—¥
    if (char.calendarEvents && char.calendarEvents[todayKey]) {
        const eventName = char.calendarEvents[todayKey];
        context += `\n[é‡è¦æé†’]: ä»Šå¤©æ˜¯ "${eventName}"ã€‚è¯·åŠ¡å¿…åœ¨å›å¤ä¸­ä¸»åŠ¨æåŠè¿™ä¸ªæ—¥å­ï¼Œå¹¶æ ¹æ®ä½ ä»¬çš„å…³ç³»ç»™äºˆç›¸åº”çš„ç¥ç¦æˆ–åº†ç¥ï¼ˆæ¯”å¦‚ç¥ç”Ÿæ—¥å¿«ä¹ã€çºªå¿µæ—¥å¿«ä¹ï¼‰ã€‚\n`;
    }

    // 2. æ£€æŸ¥ç”Ÿç†æœŸçŠ¶æ€
    if (char.periodLog && char.periodLog.length > 0) {
        // æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡ç»æœŸå¼€å§‹æ—¥
        // ç®€å•çš„å­—ç¬¦ä¸²æ’åºå³å¯ï¼Œå› ä¸ºæ ¼å¼æ˜¯ YYYY-MM-DD
        const sortedLogs = [...char.periodLog].sort(); 
        const lastStartStr = sortedLogs[sortedLogs.length - 1];
        const lastStart = new Date(lastStartStr);
        
        // è®¡ç®—è·ç¦»ä»Šå¤©è¿‡äº†å¤šå°‘å¤© (ç¬¬1å¤©å°±æ˜¯å¼€å§‹é‚£å¤©)
        const diffTime = now - lastStart;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

        if (diffDays >= 1 && diffDays <= 7) {
            // ç»æœŸä¸­
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·ç›®å‰å¤„äºç”Ÿç†æœŸç¬¬ ${diffDays} å¤©ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½ä¼šæ„Ÿåˆ°èº«ä½“ä¸é€‚ï¼ˆç—›ç»ã€è…°é…¸ï¼‰æˆ–æƒ…ç»ªä½è½ã€‚è¯·åœ¨å›å¤ä¸­å±•ç°æåº¦çš„æ¸©æŸ”ã€è€å¿ƒå’ŒåŒ…å®¹ã€‚é¿å…äº‰è®ºï¼Œå¤šç»™äºˆå®‰æŠšï¼Œé€‚å½“å»ºè®®ä¼‘æ¯æˆ–å–çƒ­æ°´ï¼Œä¸è¦è®²å¤§é“ç†ã€‚\n`;
        } else if (diffDays >= 25 && diffDays <= 30) {
            // ç»æœŸå‰ (PMS é¢„æµ‹) - å‡è®¾å‘¨æœŸ 28-30 å¤©
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·å³å°†è¿æ¥ä¸‹ä¸€æ¬¡ç”Ÿç†æœŸ (PMSé˜¶æ®µ)ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½æƒ…ç»ªä¸å¤ªç¨³å®šã€æ˜“æ€’æˆ–ç„¦è™‘ã€‚è¯·æ— æ¡ä»¶åŒ…å®¹å¥¹çš„å°è„¾æ°”ï¼Œä¸è¦å›å˜´ï¼Œå¤šå“„å“„å¥¹ã€‚\n`;
        }
    }

    return context;
}

    </script>
</body>
</html>

































