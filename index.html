<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>AI Phone Pro</title>
    <!-- è‡ªå®šä¹‰ä¸»å±å¹•å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    <link rel="icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            background-color: #222; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            overflow: hidden; 
        }

        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #000; 
            border-radius: 45px; 
            box-shadow: 0 0 0 8px #333, 0 20px 50px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden; 
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .phone-frame { width: 100%; height: 100%; border-radius: 0; box-shadow: none; border: none; }
        }

        /* --- é¡µé¢åˆ‡æ¢ç³»ç»Ÿ --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            z-index: 10;
        }
        .page.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px;
            font-size: 14px; font-weight: 600; color: inherit;
            z-index: 100;
            position: absolute; top: 0; left: 0;
        }

        /* --- 1. æ¡Œé¢ (Home) --- */
        #page-home {
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop') no-repeat center center/cover;
            color: white;
            justify-content: flex-start;
        }
        /* ä¿®æ”¹ .home-clock-widget (åŸç¬¬65è¡Œ) */
        .home-clock-widget { 
            margin-top: 60px;  /* ä»120æ”¹åˆ°60ï¼Œè®©æ—¶é’Ÿå¾€ä¸Šæ */
            text-align: center; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            margin-bottom: 20px; /* å¢åŠ åº•éƒ¨é—´è· */
        }
        
        /* åŸæ¥çš„ .clock-time å’Œ .clock-date (ç¬¬66-67è¡Œ) ä¸ç”¨åŠ¨ï¼Œä¿ç•™å³å¯ */
        .clock-time { font-size: 72px; font-weight: 200; letter-spacing: -2px; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; font-weight: 500; }

        /* ä¿®æ”¹ .app-grid (åŸç¬¬69-75è¡Œ) */
        .app-grid {
            margin-top: 0;       /* å»æ‰ autoï¼Œè®©å®ƒä¸å†æ²‰åº•ï¼Œæ”¹ä¸ºé ä¸Š */
            margin-bottom: auto; /* åº•éƒ¨ç•™ç©º */
            
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 30px 15px;      /* è°ƒæ•´å›¾æ ‡é—´è·ï¼Œè¡Œè·å¤§ä¸€ç‚¹ */
            padding: 20px;
            
            /* å…³é”®ï¼šå»æ‰èƒŒæ™¯è‰²ã€ç£¨ç ‚å’Œè¾¹æ¡† */
            background: none;    
            backdrop-filter: none;
            border-radius: 0;
            
            margin-left: 10px; 
            margin-right: 10px;
        }
        .app-icon-container { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .app-icon-container:active { transform: scale(0.9); }
        .app-icon {
            width: 58px; height: 58px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .icon-msg { background: linear-gradient(to bottom, #34c759, #30b753); }
        .icon-note { background: linear-gradient(to bottom, #ffd60a, #ffcc00); }
        .icon-settings { background: linear-gradient(to bottom, #8e8e93, #636366); }

        /* --- é€šç”¨ App å¤´éƒ¨ --- */
        .app-header {
            height: 90px; padding-top: 44px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding-left: 15px; padding-right: 15px;
            background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .app-title { font-size: 28px; font-weight: bold; color: #000; }
        .btn-icon-text { font-size: 16px; color: #007AFF; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .btn-icon-only { font-size: 22px; color: #007AFF; background: none; border: none; cursor: pointer; padding: 5px; }

        /* --- 2. æ¶ˆæ¯åˆ—è¡¨ --- */
        #page-msg-list { background: #fff; }
        .msg-list-scroll { flex: 1; overflow-y: auto; }
        .msg-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: 0.2s;
        }
        .msg-list-item:active { background: #f5f5f5; }
        .list-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee;}
        .list-info { flex: 1; min-width: 0; }
        .list-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .list-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-time { font-size: 12px; color: #c7c7cc; white-space: nowrap; }

        /* --- 3. èŠå¤©ç•Œé¢ --- */
        #page-chat { background-color: #f2f2f7; background-size: cover; background-position: center; }
        .chat-header-bar {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; background: rgba(248,249,250,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #dbdbdb; margin-top: 44px; flex-shrink: 0; z-index: 50;
        }
        .chat-back-btn { color: #007AFF; font-size: 16px; border: none; background: none; display: flex; align-items: center; cursor: pointer; }
        .chat-contact-name { font-weight: 600; font-size: 16px; flex: 1; text-align: center; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .chat-header-actions { display: flex; gap: 15px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; position: relative; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); background:#fff;}
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .message { background: #fff; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .message { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        .msg-index { font-size: 10px; color: #999; position: absolute; top: -15px; opacity: 0.5; }
        .msg-row.left .msg-index { left: 45px; }
        .msg-row.right .msg-index { right: 45px; }

        .input-area { background: #f9f9f9; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px; }
        .input-toolbar { display: flex; align-items: center; gap: 10px; }
        #userInput { flex: 1; padding: 9px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #userInput:focus { border-color: #007AFF; }
        .btn-send { font-size: 24px; background: none; border: none; cursor: pointer; color: #007AFF; padding: 0; }
        .typing-indicator { display: inline-block; width: 4px; height: 4px; background: #999; border-radius: 50%; margin: 0 1px; animation: bounce 1s infinite; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; gap: 10px; font-size: 12px; }

        /* --- é€šç”¨åˆ—è¡¨æ ·å¼ (è®¾ç½®/è®°å¿†) --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; }
        .ios-group-title { font-size: 13px; color: #666; margin: 15px 15px 5px; text-transform: uppercase; }
        .ios-list { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 12px 15px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; justify-content: space-between; min-height: 45px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-item:active { background-color: #f9f9f9; }
        .ios-label { font-size: 16px; font-weight: 500; color: #000; flex-shrink: 0; margin-right: 10px;}
        .ios-input { border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; background: transparent; flex: 1; min-width: 0;}
        .ios-btn { width: 100%; padding: 14px; text-align: center; color: #007AFF; background: #fff; border: none; font-size: 16px; cursor: pointer; border-top: 1px solid #e5e5ea; }
        .ios-btn.danger { color: #ff3b30; }
        .memory-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; position: relative; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-del-mem { position: absolute; top: 10px; right: 10px; color: #ff3b30; cursor: pointer; font-size: 18px;}

        /* --- å¼¹çª— Modal --- */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:500; display:none; align-items:center; justify-content:center; opacity: 0; transition: opacity 0.2s;}
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); width: 85%; max-height: 70%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; font-size: 17px;}
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #f2f2f7;}
        .modal-footer { display: flex; border-top: 1px solid #ccc; }
        .modal-btn { flex: 1; padding: 15px; background: #fff; border: none; font-size: 17px; cursor: pointer; }
        .modal-btn:first-child { border-right: 1px solid #ccc; color: #ff3b30; }
        .modal-btn:last-child { color: #007AFF; font-weight: 600; }

        /* Home Indicator */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: #000; border-radius: 10px; z-index: 999; cursor: pointer;
        }
        #page-home .home-indicator { background: #fff; }
    </style>
</head>
<body>

    <div class="phone-frame">
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <span id="sb-time">12:00</span>
            <span style="display:flex; gap:5px;"><span>ğŸ“¶</span><span>ğŸ”‹</span></span>
        </div>

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="goHome()"></div>

        <!-- ============ 1. æ¡Œé¢ (Home) ============ -->
        <div class="page active" id="page-home">
            <div class="home-clock-widget">
                <div class="clock-time" id="clockTime">12:00</div>
                <div class="clock-date" id="clockDate">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            </div>
            <div class="app-grid">
                <div class="app-icon-container" onclick="navigateTo('page-msg-list')">
                    <div class="app-icon icon-msg">ğŸ’¬</div>
                    <div class="app-name">ä¿¡æ¯</div>
                </div>
                <div class="app-icon-container" onclick="navigateTo('page-memory')">
                    <div class="app-icon icon-note">ğŸ“</div>
                    <div class="app-name">è®°å¿†åº“</div>
                </div>
                <div class="app-icon-container" onclick="navigateTo('page-settings')">
                    <div class="app-icon icon-settings">âš™ï¸</div>
                    <div class="app-name">è®¾ç½®</div>
                </div>
                <div class="app-icon-container">
                    <div class="app-icon" style="background:#007AFF">ğŸ“·</div>
                    <div class="app-name">ç›¸æœº</div>
                </div>
            </div>
        </div>

        <!-- ============ 2. æ¶ˆæ¯åˆ—è¡¨ (è”ç³»äºº) ============ -->
        <div class="page" id="page-msg-list">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()"><span>â€¹</span> æ¡Œé¢</button>
                <span class="app-title">ä¿¡æ¯</span>
                <button class="btn-icon-only" onclick="openModal('modal-add-char')" title="æ·»åŠ è§’è‰²" style="font-size: 26px;">+</button>
            </div>
            <div class="msg-list-scroll" id="contactListContainer">
                <!-- åŠ¨æ€åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ============ 3. èŠå¤©çª—å£ ============ -->
        <div class="page" id="page-chat">
            <div class="chat-header-bar">
                <button class="chat-back-btn" onclick="navigateTo('page-msg-list')">
                    <span style="font-size:24px; margin-right:5px;">â€¹</span> ä¿¡æ¯
                </button>
                <span class="chat-contact-name" id="chat-title-name">AI</span>
                <div class="chat-header-actions">
                    <button class="btn-icon-only" onclick="openChatSettings()" title="è§’è‰²è®¾ç½®" style="font-size: 20px;">âš™ï¸</button>
                    <button class="btn-icon-only" onclick="openSummaryModal()" title="æ™ºèƒ½æ€»ç»“" style="font-size: 20px;">âœ¨</button>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                <!-- æ¶ˆæ¯å†…å®¹ -->
            </div>

            <div class="input-area">
                <div id="uploadPreview">
                    <img id="img-preview-blob" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                    <span>å·²é€‰æ‹©å›¾ç‰‡</span>
                    <span onclick="clearUpload()" style="color:red; margin-left:auto; cursor:pointer;">Ã—</span>
                </div>
                <div class="input-toolbar">
                    <button class="btn-send" onclick="document.getElementById('fileInput').click()" style="color:#888;">âŠ•</button>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
                    <input type="text" id="userInput" placeholder="iMessage" onkeypress="if(event.key==='Enter') sendMsg('user')">
                    <button class="btn-send" onclick="sendMsg('user')">â¬†</button>
                    <button class="btn-send" id="btn-ai" onclick="triggerAI()" style="color:#5856D6">ğŸ¤–</button>
                </div>
            </div>
        </div>

        <!-- ============ 4. è®°å¿†åº“ ============ -->
        <div class="page" id="page-memory">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®°å¿†åº“</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
                <div class="ios-group-title">å½“å‰é€‰ä¸­è§’è‰²çš„è®°å¿†</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <input type="text" id="newMemInput" class="ios-input" style="text-align:left;" placeholder="æ‰‹åŠ¨æ·»åŠ è®°å¿†...">
                        <button onclick="addMemoryManual()" style="border:none;background:none;color:#007AFF;font-weight:bold;">+</button>
                    </div>
                </div>
                <div id="memoryListContainer"></div>
            </div>
        </div>

        <!-- ============ 5. å…¨å±€è®¾ç½® ============ -->
        <div class="page" id="page-settings">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®¾ç½®</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <div class="ios-group-title">API è¿æ¥</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">API URL</span>
                        <input type="text" id="apiUrl" class="ios-input" placeholder="https://api.openai.com/v1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="apiKey" class="ios-input" placeholder="sk-..." onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="testConn()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div class="ios-group-title">æ¨¡å‹é…ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">Model ID</span>
                        <input type="text" id="modelId" class="ios-input" value="gpt-3.5-turbo" onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="fetchModels()">â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                    <!-- éšè—çš„ Selectï¼Œç”¨äºæ‹‰å–åé€‰æ‹© -->
                    <div class="ios-item" id="modelSelectContainer" style="display:none;">
                        <span class="ios-label">é€‰æ‹©</span>
                        <select id="modelSelect" class="ios-input" style="direction: rtl;" onchange="document.getElementById('modelId').value=this.value;saveGlobalConfig()">
                        </select>
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ¸©åº¦ (Temperature)</span>
                        <input type="number" id="tempVal" class="ios-input" value="0.7" step="0.1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†è½®æ•° (æ¡æ•°)</span>
                        <input type="number" id="historyLimit" class="ios-input" value="20" step="1" placeholder="é»˜è®¤20" onchange="saveGlobalConfig()">
                    </div>
                </div>

                <div class="ios-group-title">æ•°æ®ç®¡ç†</div>
                <div class="ios-list">
                    <button class="ios-btn" onclick="exportData()">å¤‡ä»½æ‰€æœ‰æ•°æ® (JSON)</button>
                    <button class="ios-btn" onclick="document.getElementById('importFile').click()">æ¢å¤æ•°æ®</button>
                    <input type="file" id="importFile" hidden onchange="importData(event)">
                    <button class="ios-btn danger" onclick="resetAll()">é‡ç½®åº”ç”¨ (æ¸…é™¤æ‰€æœ‰)</button>
                </div>
            </div>
        </div>

        <!-- ============ å¼¹çª—ç»„ä»¶ ============ -->

        <!-- 1. æ·»åŠ è§’è‰²å¼¹çª— -->
        <div class="modal-overlay" id="modal-add-char">
            <div class="modal-box">
                <div class="modal-header">æ–°å»ºè”ç³»äºº</div>
                <div class="modal-body">
                    <div class="ios-list" style="margin: 20px 0; background:transparent;">
                        <div class="ios-item" style="background:#fff; border-radius:10px;">
                            <input type="text" id="newCharName" class="ios-input" style="text-align:center;" placeholder="è¾“å…¥è§’è‰²å§“å">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-add-char')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="addNewCharacter()">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- 2. è§’è‰²è®¾ç½®å¼¹çª— (åœ¨èŠå¤©ç•Œé¢è°ƒå‡º) -->
        <div class="modal-overlay" id="modal-chat-settings">
            <div class="modal-box" style="height: 80%;">
                <div class="modal-header">è§’è‰² & èŠå¤©è®¾ç½®</div>
                <div class="modal-body" style="padding: 15px;">
                    
                    <div class="ios-group-title" style="margin-top:0">å¯¹æ–¹ (AI) èµ„æ–™</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('charAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-char-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="charAvatarFile" hidden onchange="uploadCharAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">å§“å</span>
                            <input type="text" id="set-char-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">AI è®¾å®š (System Prompt)</span>
                            <textarea id="set-char-prompt" class="ios-input" style="text-align:left; width:100%; height:80px; border:1px solid #eee; padding:5px; border-radius:5px;" onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">æˆ‘çš„èµ„æ–™ (åœ¨æ­¤èŠå¤©ä¸­)</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('userAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-user-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="userAvatarFile" hidden onchange="uploadUserAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">æ˜µç§°</span>
                            <input type="text" id="set-user-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">æˆ‘çš„è®¾å®š (User Persona)</span>
                            <textarea id="set-user-desc" class="ios-input" style="text-align:left; width:100%; height:60px; border:1px solid #eee; padding:5px; border-radius:5px;" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ä¸ªå¥½å¥‡çš„å­¦ç”Ÿ..." onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">å¤–è§‚</div>
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èŠå¤©èƒŒæ™¯</span>
                            <button style="border:none; background:none; color:#007AFF" onclick="document.getElementById('bgFile').click()">æ›´æ¢</button>
                            <button style="border:none; background:none; color:red" onclick="clearChatBg()">è¿˜åŸ</button>
                            <input type="file" id="bgFile" hidden onchange="uploadChatBg(event)">
                        </div>
                    </div>

                    <button class="ios-btn danger" style="border-radius:12px; margin-bottom:20px;" onclick="deleteCurrentChar()">åˆ é™¤æ­¤è§’è‰²</button>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" style="border:none; width:100%; color:#007AFF;" onclick="closeModal('modal-chat-settings')">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- 3. æ™ºèƒ½æ€»ç»“å¼¹çª— -->
        <div class="modal-overlay" id="modal-summary">
            <div class="modal-box">
                <div class="modal-header">æ™ºèƒ½è®°å¿†æå–</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">é€‰æ‹©èŠå¤©è®°å½•èŒƒå›´ç”Ÿæˆæ‘˜è¦å­˜å…¥è®°å¿†åº“</p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-end" class="ios-input" value="100">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999;">
                        å½“å‰å…±æœ‰ <span id="total-msg-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="doSummarize()">ç”Ÿæˆå¹¶å­˜å‚¨</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        let globalConfig = {
    apiUrl: "https://api.openai.com/v1",
    apiKey: "",
    model: "gpt-3.5-turbo",
    temp: 0.7,
    historyLimit: 20 // æ–°å¢è¿™ä¸€è¡Œï¼Œé»˜è®¤è®°ä½æœ€è¿‘20æ¡æ¶ˆæ¯
};

        // è§’è‰²åˆ—è¡¨ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«å®Œæ•´ç‹¬ç«‹çš„æ•°æ®
        let contacts = []; 
        // å½“å‰æ´»è·ƒçš„èŠå¤©ID
        let activeContactId = null;

        // ä¸´æ—¶å›¾ç‰‡
        let currentImg = null;

        // --- åˆå§‹åŒ–ä¸ç”Ÿå‘½å‘¨æœŸ ---
        window.onload = function() {
            startClock();
            loadData();
            if (contacts.length === 0) {
                // é»˜è®¤åˆ›å»ºä¸€ä¸ªè§’è‰²
                createCharacter("AI Assistant", "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚", "https://api.dicebear.com/7.x/bottts/svg?seed=Default");
            }
            updateContactList();
            updateGlobalSettingsUI();
        };

        // --- æ•°æ®æŒä¹…åŒ– ---
        function saveData() {
            localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
            localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
        }

        function loadData() {
            const c = localStorage.getItem('ai_phone_config');
            if(c) globalConfig = JSON.parse(c);
            
            const ct = localStorage.getItem('ai_phone_contacts');
            if(ct) contacts = JSON.parse(ct);
        }

        function createCharacter(name, prompt, avatar) {
            const id = Date.now().toString();
            const newChar = {
                id: id,
                name: name,
                avatar: avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                systemPrompt: prompt || "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚",
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                userPersona: "", // ç”¨æˆ·åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„äººè®¾
                bgImage: "",     // èŠå¤©èƒŒæ™¯
                messages: [],
                memories: []
            };
            contacts.push(newChar);
            saveData();
            return id;
        }

        // --- é¡µé¢å¯¼èˆª ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            const bar = document.getElementById('statusBar');
            const indicator = document.querySelector('.home-indicator');
            
            if(pageId === 'page-home') {
                bar.style.color = 'white';
                indicator.style.backgroundColor = 'white';
            } else {
                bar.style.color = 'black';
                indicator.style.backgroundColor = 'black';
            }

            if(pageId === 'page-chat' && activeContactId) {
                renderChat(activeContactId);
            }
            if(pageId === 'page-memory' && activeContactId) {
                renderMemories();
            } else if (pageId === 'page-memory' && !activeContactId) {
                document.getElementById('memoryListContainer').innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¯·å…ˆä»ä¿¡æ¯åˆ—è¡¨è¿›å…¥ä¸€ä¸ªèŠå¤©</p>';
            }
        }

        function goHome() { navigateTo('page-home'); }

        // --- 1. è”ç³»äººåˆ—è¡¨é€»è¾‘ ---
        function updateContactList() {
            const container = document.getElementById('contactListContainer');
            container.innerHTML = '';
            
            // æŒ‰æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´æ’åºï¼ˆå¯é€‰ï¼Œè¿™é‡Œæš‚ä¸å¤æ‚åŒ–ï¼‰
            contacts.forEach(c => {
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : "ç‚¹å‡»å¼€å§‹èŠå¤©...";
                const previewText = lastMsg.startsWith('data:image') ? '[å›¾ç‰‡]' : lastMsg;
                
                const div = document.createElement('div');
                div.className = 'msg-list-item';
                div.onclick = () => enterChat(c.id);
                div.innerHTML = `
                    <img src="${c.avatar}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-name">${c.name}</div>
                        <div class="list-preview">${previewText}</div>
                    </div>
                    <div class="list-time"> > </div>
                `;
                container.appendChild(div);
            });
        }

        function enterChat(id) {
            activeContactId = id;
            navigateTo('page-chat');
        }

        function addNewCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            if(!name) return alert("è¯·è¾“å…¥åå­—");
            createCharacter(name);
            closeModal('modal-add-char');
            document.getElementById('newCharName').value = '';
            updateContactList();
        }

        // --- 2. èŠå¤©é€»è¾‘ ---
        function getActiveChar() {
            return contacts.find(c => c.id === activeContactId);
        }

        function renderChat(id) {
            const char = contacts.find(c => c.id === id);
            if(!char) return;

            document.getElementById('chat-title-name').innerText = char.name;
            
            // è®¾ç½®èƒŒæ™¯
            const page = document.getElementById('page-chat');
            if(char.bgImage) {
                page.style.backgroundImage = `url(${char.bgImage})`;
            } else {
                page.style.backgroundImage = '';
            }

            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if(char.messages.length === 0) {
                box.innerHTML = `<div style="text-align:center;font-size:12px;color:#999;margin:20px;">ä¸ ${char.name} å¼€å§‹æ–°çš„å¯¹è¯</div>`;
            } else {
                char.messages.forEach((m, index) => appendMsgUI(m.role, m.content, m.image, index + 1));
            }
            scrollToBottom();
        }

        function appendMsgUI(role, text, img, index, isTemp=false) {
            const char = getActiveChar();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            
            const avatarUrl = role==='user' ? char.userAvatar : char.avatar;
            
            let html = `
                <span class="msg-index">#${index || '?'}</span>
                <img src="${avatarUrl}" class="avatar">
                <div class="message">
                    ${img ? `<img src="${img}" style="max-width:100%;border-radius:8px;display:block;margin-bottom:5px;">` : ''}
                    <span class="txt-content">${isTemp ? text : formatText(text)}</span>
                </div>
            `;
            div.innerHTML = html;
            box.appendChild(div);
            scrollToBottom();
            return div.querySelector('.txt-content'); // è¿”å›æ–‡æœ¬èŠ‚ç‚¹ç”¨äºæµå¼æ›´æ–°
        }

        async function sendMsg(role) {
            const char = getActiveChar();
            if(!char) return;

            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            
            if(!txt && !currentImg) return;

            // ç”¨æˆ·æ¶ˆæ¯
            const newMsg = { role: 'user', content: txt, image: currentImg };
            char.messages.push(newMsg);
            saveData(); // ä¿å­˜æ•°æ®
            
            appendMsgUI('user', txt, currentImg, char.messages.length);
            
            input.value = '';
            clearUpload();
            
            // è§¦å‘ AI å›å¤ (åœ¨ sendMsg å†…éƒ¨è°ƒç”¨ triggerAI)
            setTimeout(triggerAI, 100); // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹é¿å…UIå¡é¡¿
        }

        async function triggerAI() {
            const char = getActiveChar();
            if(!char) return;
            if(!globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

            const btn = document.getElementById('btn-ai');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';
            btn.disabled = true;

            // æ„å»º Prompt
            let systemPromptFull = char.systemPrompt + `\n[å½“å‰æ—¶é—´: ${new Date().toLocaleString()}]\n[ç”¨æˆ·åç§°: ${char.userName}]`;
            if(char.userPersona) systemPromptFull += `\n[ç”¨æˆ·è®¾å®š: ${char.userPersona}]`;
            if(char.memories.length > 0) {
                systemPromptFull += `\n[é•¿æœŸè®°å¿†åº“]:\n${char.memories.join('\n')}`;
            }

            let apiMsgs = [{role: "system", content: systemPromptFull}];
            
            // æ„å»ºæ¶ˆæ¯å†å² (æºå¸¦å›¾ç‰‡é€»è¾‘)
// è¯»å–è®¾ç½®ä¸­çš„é™åˆ¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™é»˜è®¤20æ¡
const limit = globalConfig.historyLimit || 20;
const history = char.messages.slice(-limit);
            history.forEach(m => {
                if(m.image) {
                    // GPT-4 Vision æ ¼å¼, å…¼å®¹æ€§è§†æ¨¡å‹è€Œå®š
                    apiMsgs.push({
                        role: m.role,
                        content: [
                            { type: "text", text: m.content || " " },
                            { type: "image_url", image_url: { url: m.image } }
                        ]
                    });
                } else {
                    apiMsgs.push({ role: m.role, content: m.content });
                }
            });

            // UI å ä½
            const aiMsgIndex = char.messages.length + 1;
            const aiUiSpan = appendMsgUI('assistant', '...', null, aiMsgIndex, true);
            let fullText = "";

            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: apiMsgs,
                        temperature: parseFloat(globalConfig.temp),
                        stream: true
                    })
                });

                if(!res.ok) throw new Error(res.statusText);

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ',''));
                                const delta = json.choices[0].delta.content || "";
                                fullText += delta;
                                aiUiSpan.innerHTML = formatText(fullText);
                                scrollToBottom();
                            } catch(e){}
                        }
                    }
                }
                
                // ä¿å­˜ AI å›å¤
                char.messages.push({ role: 'assistant', content: fullText });
                saveData();

            } catch(e) {
                aiUiSpan.innerText = "Error: " + e.message;
                char.messages.push({ role: 'assistant', content: "Error: " + e.message });
            }

            btn.innerHTML = originalBtnContent;
            btn.disabled = false;
        }

        // --- 3. æ™ºèƒ½æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() {
            const char = getActiveChar();
            if(!char) return;
            document.getElementById('total-msg-count').innerText = char.messages.length;
            
            // é»˜è®¤é€‰ä¸­æœ€è¿‘ 20 æ¡ï¼Œæˆ–è€…å…¨éƒ¨
            const total = char.messages.length;
            const start = Math.max(1, total - 20);
            document.getElementById('sum-start').value = start;
            document.getElementById('sum-end').value = total;
            
            openModal('modal-summary');
        }

        async function doSummarize() {
            const char = getActiveChar();
            const startIdx = parseInt(document.getElementById('sum-start').value) - 1; // UIæ˜¯1-basedï¼Œæ•°ç»„æ˜¯0-based
            const endIdx = parseInt(document.getElementById('sum-end').value);
            
            if(startIdx < 0 || endIdx > char.messages.length || startIdx >= endIdx) {
                alert("æ¥¼å±‚èŒƒå›´æ— æ•ˆ");
                return;
            }

            const selectedMsgs = char.messages.slice(startIdx, endIdx);
            const textBlock = selectedMsgs.map(m => `${m.role}: ${m.content}`).join('\n');

            closeModal('modal-summary');
            const btn = document.querySelector('.chat-header-actions button:last-child'); // æ€»ç»“æŒ‰é’®
            const oldIcon = btn.innerHTML;
            btn.innerText = "â³";

            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: [
                            { role: "system", content: "è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯ä¸­çš„é‡è¦äº‹å®ã€ç”¨æˆ·å–œå¥½æˆ–å…³é”®äº‹ä»¶ã€‚æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œä½œä¸ºä¸€æ¡è®°å¿†å­˜å‚¨ã€‚" },
                            { role: "user", content: textBlock }
                        ]
                    })
                });
                const data = await res.json();
                const summary = data.choices[0].message.content;
                
                char.memories.push(summary);
                saveData();
                alert("æ€»ç»“æˆåŠŸï¼Œå·²å­˜å…¥è®°å¿†åº“ï¼\n\n" + summary);
            } catch(e) {
                alert("æ€»ç»“å¤±è´¥: " + e.message);
            }
            btn.innerHTML = oldIcon;
        }

        // --- 4. è§’è‰²è®¾ç½®ä¸è®°å¿†åº“ ---
        function openChatSettings() {
            const char = getActiveChar();
            if(!char) return;
            
            document.getElementById('set-char-name').value = char.name;
            document.getElementById('set-char-prompt').value = char.systemPrompt;
            document.getElementById('set-char-avatar').src = char.avatar;
            
            document.getElementById('set-user-name').value = char.userName;
            document.getElementById('set-user-desc').value = char.userPersona || "";
            document.getElementById('set-user-avatar').src = char.userAvatar;
            
            openModal('modal-chat-settings');
        }

        function saveCurrentCharSettings() {
            const char = getActiveChar();
            if(!char) return;
            
            char.name = document.getElementById('set-char-name').value;
            char.systemPrompt = document.getElementById('set-char-prompt').value;
            char.userName = document.getElementById('set-user-name').value;
            char.userPersona = document.getElementById('set-user-desc').value;
            
            document.getElementById('chat-title-name').innerText = char.name;
            saveData();
        }

        async function uploadCharAvatar(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().avatar = b64;
            document.getElementById('set-char-avatar').src = b64;
            saveData(); renderChat(activeContactId);
        }

        async function uploadUserAvatar(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().userAvatar = b64;
            document.getElementById('set-user-avatar').src = b64;
            saveData(); renderChat(activeContactId);
        }

        async function uploadChatBg(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().bgImage = b64;
            document.getElementById('page-chat').style.backgroundImage = `url(${b64})`;
            saveData();
        }

        function clearChatBg() {
            getActiveChar().bgImage = "";
            document.getElementById('page-chat').style.backgroundImage = '';
            saveData();
        }

        function deleteCurrentChar() {
            if(confirm("ç¡®å®šåˆ é™¤è¯¥è§’è‰²åŠæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                contacts = contacts.filter(c => c.id !== activeContactId);
                activeContactId = null;
                saveData();
                closeModal('modal-chat-settings');
                updateContactList();
                navigateTo('page-msg-list');
            }
        }

        // è®°å¿†åº“æ¸²æŸ“
        function renderMemories() {
            const char = getActiveChar();
            const c = document.getElementById('memoryListContainer'); 
            c.innerHTML = '';
            
            if(!char) return;
            
            char.memories.forEach((m, i) => {
                c.innerHTML += `
                    <div class="memory-card">
                        ${m}
                        <div class="btn-del-mem" onclick="deleteMemory(${i})">Ã—</div>
                    </div>`;
            });
        }
        function addMemoryManual() {
            const char = getActiveChar();
            const input = document.getElementById('newMemInput');
            if(input.value && char) {
                char.memories.push(input.value);
                input.value = '';
                saveData(); renderMemories();
            }
        }
        function deleteMemory(index) {
            const char = getActiveChar();
            if(char) {
                char.memories.splice(index, 1);
                saveData(); renderMemories();
            }
        }

        // --- 5. å…¨å±€è®¾ç½®é€»è¾‘ ---
        function updateGlobalSettingsUI() {
            document.getElementById('apiUrl').value = globalConfig.apiUrl;
            document.getElementById('apiKey').value = globalConfig.apiKey;
            document.getElementById('modelId').value = globalConfig.model;
            document.getElementById('tempVal').value = globalConfig.temp;
            document.getElementById('historyLimit').value = globalConfig.historyLimit || 20;
        }
        
        function saveGlobalConfig() {
            globalConfig.apiUrl = document.getElementById('apiUrl').value;
            globalConfig.apiKey = document.getElementById('apiKey').value;
            globalConfig.model = document.getElementById('modelId').value;
            globalConfig.temp = document.getElementById('tempVal').value;
            globalConfig.historyLimit = parseInt(document.getElementById('historyLimit').value) || 20;
            saveData();
        }

        async function fetchModels() {
            if(!globalConfig.apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
            const btn = event.target;
            btn.innerText = "åŠ è½½ä¸­...";
            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/models', {
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey }
                });
                const data = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ¨¡å‹</option>';
                
                // å…¼å®¹ OpenAI å’Œ å…¼å®¹æ¥å£çš„è¿”å›æ ¼å¼
                const list = data.data || data; 
                if(Array.isArray(list)) {
                    list.sort((a,b) => a.id.localeCompare(b.id));
                    list.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.innerText = m.id;
                        select.appendChild(opt);
                    });
                    document.getElementById('modelSelectContainer').style.display = 'flex';
                } else {
                    alert("API è¿”å›æ ¼å¼æœªèƒ½è¯†åˆ«");
                }
            } catch(e) {
                alert("è·å–æ¨¡å‹å¤±è´¥: " + e.message);
            }
            btn.innerText = "â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨";
        }

        function resetAll() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- å·¥å…·å‡½æ•° ---
        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }
        function closeModal(id) { 
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 200);
        }
        function formatText(text) { return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); }
        function normalizeUrl(u) { return u.endsWith('/') ? u.slice(0,-1) : u; }
        function scrollToBottom() { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const t = now.toLocaleTimeString('zh-CN', {hour12:false,hour:'2-digit',minute:'2-digit'});
                document.getElementById('clockTime').innerText = t;
                document.getElementById('sb-time').innerText = t;
                document.getElementById('clockDate').innerText = now.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'long'});
            }, 1000);
        }
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            fileToBase64(f).then(res => {
                currentImg = res;
                document.getElementById('img-preview-blob').src = currentImg;
                document.getElementById('uploadPreview').style.display = 'flex';
            });
        }
        function clearUpload() { currentImg=null; document.getElementById('uploadPreview').style.display='none'; document.getElementById('fileInput').value=''; }
        function fileToBase64(file) {
            return new Promise(resolve => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    // ç®€å•å‹ç¼©
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = Math.min(1, 800/img.width); // é™åˆ¶æœ€å¤§å®½åº¦800
                        cvs.width = img.width * scale; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }
        
        // å¯¼å‡º/å¯¼å…¥
        function exportData() {
            const blob = new Blob([JSON.stringify({globalConfig, contacts})], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai_phone_backup.json'; a.click();
        }
        function importData(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    globalConfig = d.globalConfig; contacts = d.contacts;
                    saveData(); location.reload();
                } catch(e){alert("æ–‡ä»¶æ— æ•ˆ");}
            }; r.readAsText(f);
        }
        async function testConn() {
            try { 
                await fetch(normalizeUrl(globalConfig.apiUrl)+'/models', {headers:{Authorization:"Bearer "+globalConfig.apiKey}}); 
                alert("è¿æ¥æˆåŠŸï¼"); 
            } catch(e) { alert("è¿æ¥å¤±è´¥: "+e.message); }
        }

    </script>
</body>
</html>



