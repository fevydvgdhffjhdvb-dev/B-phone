<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ä¿®æ”¹ 1: å¢åŠ  viewport-fit=cover é€‚é…åˆ˜æµ·å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- å…³é”®ä¿®æ”¹ 2: iOS å…¨å±æ¨¡å¼ä¸“ç”¨æ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bjphone">
    
    <!-- å®‰å“/é€šç”¨ å…¨å±æ ‡ç­¾ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8f9fa">

    <title>=á—œÏ‰á—œ=</title>
    
    <!-- å»ºè®®ï¼šä½ è‡ªå·±æ‰¾ä¸€ä¸ªå›¾æ ‡å›¾ç‰‡çš„é“¾æ¥æ”¾åœ¨è¿™é‡Œï¼Œæ·»åŠ åˆ°æ¡Œé¢æ—¶å°±ä¼šæ˜¾ç¤ºè¿™ä¸ªå›¾æ ‡ -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">

    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #e0e5ec; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; /* é˜²æ­¢èƒŒæ™¯æ»šåŠ¨ */
        }
        
        /* --- æ‰‹æœºå¤–å£³ (ç”µè„‘ç«¯æ˜¾ç¤ºæ ·å¼) --- */
        .phone-frame { 
            width: 375px; 
            height: 85vh; 
            max-height: 850px; 
            background-color: #fff; 
            border-radius: 35px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); 
            border: 10px solid #2c3e50; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }

        /* --- å…³é”®ä¿®æ”¹ 3: æ‰‹æœºç«¯å…¨å±é€‚é… (CSS Media Query) --- */
        /* å½“å±å¹•å®½åº¦å°äº 768px (ä¹Ÿå°±æ˜¯æ‰‹æœºä¸Š) æ—¶ï¼Œå–æ¶ˆå¤–å£³ï¼Œå æ»¡å…¨å± */
        @media (max-width: 768px) {
            body {
                background-color: #fff; /* å»æ‰ç°è‰²èƒŒæ™¯ */
            }
            .phone-frame {
                width: 100%; 
                height: 100%; 
                max-height: none; 
                border: none; /* å»æ‰è¾¹æ¡† */
                border-radius: 0; /* å»æ‰åœ†è§’ */
                box-shadow: none; /* å»æ‰é˜´å½± */
            }
        }

        /* --- é¡¶éƒ¨æ  --- */
        .header { 
            /* é€‚é…åˆ˜æµ·å±ï¼šå¦‚æœæœ‰åˆ˜æµ·ï¼Œå¢åŠ é¡¶éƒ¨å†…è¾¹è· */
            padding: 15px 20px; 
            padding-top: max(15px, env(safe-area-inset-top)); 
            background-color: rgba(248, 249, 250, 0.95); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .header-title { font-weight: 700; color: #333; font-size: 16px; }
        .header-icons { display: flex; gap: 8px; }
        .btn-icon { background: none; border: none; font-size: 18px; cursor: pointer; padding: 6px; transition: 0.2s; border-radius: 50%; }
        .btn-icon:hover { background-color: #e1e1e1; }

        /* --- èŠå¤©åŒºåŸŸ --- */
        .chat-box {
            flex: 1; padding: 15px; overflow-y: auto;
            background-color: #ffffff; 
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            position: relative;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
            /* ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨ä½“éªŒ */
            -webkit-overflow-scrolling: touch; 
        }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; animation: fadeIn 0.3s ease; }
        .msg-row.right { flex-direction: row-reverse; }
        
        .avatar { 
            width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #ddd; border: 1px solid #fff;
        }

        .message { 
            max-width: 75%; padding: 12px 15px; border-radius: 18px; 
            font-size: 15px; /* æ‰‹æœºä¸Šå­—ä½“ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹ */
            line-height: 1.5; word-wrap: break-word; 
            position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-row.right .message { background-color: #007AFF; color: white; border-bottom-right-radius: 4px; }
        .msg-row.left .message { background-color: #F2F2F7; color: #000; border-bottom-left-radius: 4px; }
        
        .msg-index { font-size: 9px; opacity: 0.5; position: absolute; top: -15px; color: #999; width: 100%; display: none;}
        .msg-row:hover .msg-index { display: block; } 
        
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .system-notice { text-align: center; font-size: 12px; color: #aaa; margin: 10px 0; width: 100%; }

        /* --- åº•éƒ¨è¾“å…¥æ  --- */
        .input-area { 
            padding: 10px 12px; 
            /* é€‚é…åº•éƒ¨å°é»‘æ¡ safe-area */
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            background-color: #f8f9fa; border-top: 1px solid #eee; 
            display: flex; flex-direction: column; gap: 10px;
        }
        
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; justify-content: space-between; font-size: 12px; color: #666;}
        #previewImg { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }

        .input-toolbar { display: flex; align-items: center; gap: 8px; width: 100%; }
        #userInput { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 16px; /* é˜²æ­¢iOSè¾“å…¥æ¡†è‡ªåŠ¨æ”¾å¤§ */ transition: border 0.2s;}
        #userInput:focus { border-color: #007AFF; }
        
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; transition: transform 0.1s; flex-shrink: 0; }
        .btn-circle:active { transform: scale(0.95); }
        .btn-circle:disabled { background-color: #ccc !important; cursor: not-allowed; }
        .btn-send-user { background-color: #007AFF; }
        .btn-trigger-ai { background-color: #5856D6; position: relative; }
        .btn-attach { background: none; border: none; font-size: 24px; color: #555; cursor: pointer; padding: 0 5px; }

        .typing-indicator { display: inline-block; width: 5px; height: 5px; border-radius: 50%; background-color: white; animation: bounce 1s infinite; margin: 0 2px;}
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- é¢æ¿é€šç”¨æ ·å¼ --- */
        .panel-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.98); backdrop-filter: blur(5px);
            z-index: 100; padding: 20px; 
            padding-top: max(20px, env(safe-area-inset-top)); /* é€‚é…é¢æ¿é¡¶éƒ¨ */
            display: none; flex-direction: column; overflow-y: auto;
        }
        .panel-overlay.show { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-size: 20px; font-weight: bold; margin: 0; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; outline: none; }
        .form-textarea { height: 80px; resize: none; }
        
        .btn { padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; text-align: center; transition: 0.2s; width: 100%; margin-top: 5px;}
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-primary { background-color: #007AFF; color: white; }
        .btn-secondary { background-color: #e9ecef; color: #333; border: 1px solid #ddd; }
        .btn-danger { background-color: #FF3B30; color: white; }
        .btn-fetch { background-color: #5856D6; color: white; } 

        .avatar-uploader { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .current-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #eee; object-fit: cover; }
        .upload-btn-label { background: #f0f0f0; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #ccc; }

        .memory-item { background: #f0f4f8; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: flex-start; font-size: 13px;}
        .mem-del { color: #ff3b30; cursor: pointer; margin-left: 10px; font-weight: bold; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; display:none;}
        .modal-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .hint-text { font-size: 11px; color: #888; margin-top: 3px; }
    </style>
</head>
<body>

    <div class="phone-frame">
        <!-- é¡¶éƒ¨ -->
        <div class="header">
            <span class="header-title">AI Phone V8.1</span>
            <div class="header-icons">
                <button class="btn-icon" onclick="openSummaryModal()" title="è‡ªåŠ¨æ€»ç»“">^Ï‰^</button>
                <button class="btn-icon" onclick="togglePanel('memoryPanel')" title="è®°å¿†åº“">Õâ¦à¼â¦Õ</button>
                <button class="btn-icon" onclick="togglePanel('settingsPanel')" title="è®¾ç½®">â©Œâ¤™â©Œ</button>
            </div>
        </div>

        <!-- èŠå¤©å†…å®¹ -->
        <div class="chat-box" id="chatBox">
            <div class="system-notice">
                æ¬¢è¿å›å®¶ (Õâ¸â¸oÌ´Ì¶Ì·Ì¥á·…  Ì« oÌ´Ì¶Ì·Ì¥á·…â¸â¸Õ)
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥ -->
        <div class="input-area">
            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <div id="uploadPreview">
                <div style="display:flex; align-items:center; gap:8px;">
                    <img id="previewImg" src="">
                    <span>å·²æ·»åŠ å›¾ç‰‡</span>
                </div>
                <span style="cursor:pointer; color:red; font-size:16px;" onclick="clearUpload()">Ã—</span>
            </div>

            <div class="input-toolbar">
                <button class="btn-attach" onclick="document.getElementById('chatFileInput').click()" title="ä¸Šä¼ å›¾ç‰‡">â©Œ â©Œ</button>
                <input type="file" id="chatFileInput" accept="image/*" style="display:none" onchange="handleChatImageSelect(event)">
                
                <!-- è¾“å…¥æ¡† -->
                <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleEnter(event)">
                
                <!-- æŒ‰é’®ç»„ -->
                <button class="btn-circle btn-send-user" id="btnSendUser" onclick="sendUserMsg()" title="å‘é€ä¸Šå± (ä¸è§¦å‘AI)">
                    ğŸ’­
                </button>
                
                <button class="btn-circle btn-trigger-ai" id="btnTriggerAI" onclick="triggerAI()" title="è®© AI å›å¤">
                    ğŸ’¬
                </button>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="panel-overlay" id="settingsPanel">
            <div class="panel-header">
                <h2 class="panel-title">è®¾ç½®ä¸­å¿ƒ</h2>
                <button class="btn-close" onclick="togglePanel('settingsPanel')">Ã—</button>
            </div>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #eee;">
                <div class="form-group">
                    <label class="form-label">API Base URL</label>
                    <input type="text" id="apiUrl" class="form-input" value="https://api.openai.com/v1" onchange="saveSettings()">
                    <div class="hint-text">å¿…é¡»åŒ…å«ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ <b>/v1</b></div>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="sk-xxxxxxxx" onchange="saveSettings()">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-fetch" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" style="color:#007AFF">è§’è‰²è®¾å®š</label>
                <div class="avatar-uploader">
                    <img id="aiAvatarPreview" src="https://api.dicebear.com/7.x/bottts/svg?seed=AI" class="current-avatar">
                    <label class="upload-btn-label">è§’è‰²å¤´åƒ <input type="file" style="display:none" accept="image/*" onchange="handleAvatarUpload(event, 'ai')"></label>
                </div>
                <textarea id="systemPrompt" class="form-textarea" onchange="saveSettings()">ä½ æ˜¯ä¸€ä¸ªå¹½é»˜çš„AIåŠ©æ‰‹ã€‚</textarea>
            </div>

            <div class="form-group">
                <label class="form-label" style="color:#34C759">æˆ‘çš„è®¾å®š</label>
                <div class="avatar-uploader">
                    <img id="userAvatarPreview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="current-avatar">
                    <label class="upload-btn-label">æˆ‘çš„å¤´åƒ <input type="file" style="display:none" accept="image/*" onchange="handleAvatarUpload(event, 'user')"></label>
                </div>
                <input type="text" id="userName" class="form-input" placeholder="æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ" onchange="saveSettings()">
            </div>
            
            <div class="form-group">
                <label class="form-label" style="color:#FF9500">è‡ªå®šä¹‰èŠå¤©å£çº¸</label>
                <div class="avatar-uploader">
                    <div id="bgPreview" style="width: 60px; height: 100px; border-radius: 8px; border: 2px solid #eee; background: #f0f0f0; background-size: cover; background-position: center;"></div>
                    
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label class="upload-btn-label">æ›´æ¢å£çº¸ <input type="file" style="display:none" accept="image/*" onchange="handleBgUpload(event)"></label>
                        <button onclick="resetBg()" style="background:none; border:1px solid #ccc; padding:4px 10px; border-radius:6px; font-size:12px; cursor:pointer;">æ¢å¤é»˜è®¤</button>
                    </div>
                </div>
            </div>
           
            <div class="form-group">
                <label class="form-label" style="color:#9C27B0">è‡ªå®šä¹‰æ°”æ³¡ç¾åŒ– (CSS)</label>
                <textarea id="userCss" class="form-textarea" style="height:100px; font-family:monospace; font-size:12px; background:#282c34; color:#98c379;" placeholder="è¾“å…¥ CSS ä»£ç ...&#10;.message { background: pink !important; }" oninput="applyUserCss(this.value); saveSettings();"></textarea>
            </div>

            <div style="border-top:1px solid #eee; padding-top:15px;">
                <div class="form-group">
                    <label class="form-label">æ¸©åº¦: <span id="tempVal" style="color:#007AFF">0.7</span></label>
                    <input type="range" id="tempRange" min="0" max="2" step="0.1" value="0.7" style="width:100%" oninput="document.getElementById('tempVal').innerText=this.value; saveSettings()">
                </div>
                <div class="form-group">
                    <label class="form-label">è®°å¿†è½®æ•°: <span id="contextVal" style="color:#007AFF">10</span></label>
                    <input type="range" id="contextRange" min="2" max="50" step="2" value="10" style="width:100%" oninput="document.getElementById('contextVal').innerText=this.value; saveSettings()">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹</label>
                    <select id="modelSelect" class="form-input" onchange="document.getElementById('customModel').value=this.value; saveSettings();">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4o">gpt-4o (è§†è§‰æ¨è)</option>
                    </select>
                    <input type="text" id="customModel" class="form-input" style="display:none; margin-top:5px;" placeholder="è¾“å…¥æ¨¡å‹ID">
                    <div style="text-align:right; font-size:11px; color:#007AFF; margin-top:2px; cursor:pointer" onclick="toggleCustomModel()">åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥</div>
                </div>
            </div>

            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-secondary" onclick="exportData()">å¤‡ä»½</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">æ¢å¤</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            </div>
            <button class="btn btn-danger" onclick="clearChat()" style="margin-top:10px;">æ¸…ç©ºå¯¹è¯</button>
        </div>

        <!-- è®°å¿†åº“é¢æ¿ -->
        <div class="panel-overlay" id="memoryPanel">
            <div class="panel-header">
                <h2 class="panel-title">è®°å¿†åº“</h2>
                <button class="btn-close" onclick="togglePanel('memoryPanel')">Ã—</button>
            </div>
            <div style="margin-bottom: 15px;">
                <textarea id="newMemoryInput" class="form-input" style="height:60px;" placeholder="æ·»åŠ è®°å¿†..."></textarea>
                <button class="btn btn-primary" onclick="addMemoryManual()">â• æ·»åŠ </button>
            </div>
            <div id="memoryList"></div>
        </div>

        <!-- æ€»ç»“å¼¹çª— -->
        <div class="modal-overlay" id="summaryModalOverlay">
            <div class="modal-box">
                <h3>æ™ºèƒ½æ€»ç»“</h3>
                <div class="form-group">
                    <label class="form-label">From Msg #</label>
                    <input type="number" id="sumStart" class="form-input" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">To Msg #</label>
                    <input type="number" id="sumEnd" class="form-input" value="10">
                </div>
                <div class="hint-text" id="msgCountHint"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSummaryModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="btnDoSum" onclick="doSummarize()">æ€»ç»“</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        let settings = {
            aiAvatar: "https://api.dicebear.com/7.x/bottts/svg?seed=AI",
            userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
            userName: "",
            contextLimit: 10,
            temperature: 0.7
        };
        let messages = []; 
        let memories = [];
        let currentUploadBase64 = null; 

        window.onload = function() {
            loadSettings();
            loadData();
            renderMessages();
            renderMemories();
        };
        function renderMessages() {
            const box = document.getElementById('chatBox');
            const notice = box.querySelector('.system-notice');
            box.innerHTML = ''; 
            if (notice) box.appendChild(notice);
            messages.forEach(msg => {
                appendMessageUI(msg.role, msg.content, msg.image, false);
            });
            scrollToBottom();
        }

        function sendUserMsg() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text && !currentUploadBase64) return;
            appendMessageUI('user', text, currentUploadBase64);
            messages.push({ role: 'user', content: text, image: currentUploadBase64 });
            saveData();
            input.value = '';
            clearUpload();
        }

        async function triggerAI() {
            if (!document.getElementById('apiKey').value) {
                alert("è¯·å…ˆé…ç½® API Key ğŸ”‘"); togglePanel('settingsPanel'); return;
            }
            
            const btnAI = document.getElementById('btnTriggerAI');
            btnAI.disabled = true; 
            btnAI.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';

            const sysPromptRaw = document.getElementById('systemPrompt').value;
            const userName = document.getElementById('userName').value || "ç”¨æˆ·";
            const timeStr = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
            
            let fullSystemPrompt = `${sysPromptRaw}\n[Time: ${timeStr}]\n[User: ${userName}]`;
            if(memories.length > 0) {
                fullSystemPrompt += `\n\n[Memories]:\n${memories.map(m => '- ' + m).join('\n')}`;
            }

            const limit = parseInt(document.getElementById('contextRange').value) || 10;
            let apiMessages = [{ role: "system", content: fullSystemPrompt }];
            const history = messages.slice(-limit);
            
            history.forEach(msg => {
                if(msg.image) {
                    apiMessages.push({
                        role: msg.role,
                        content: [
                            { type: "text", text: msg.content || " " },
                            { type: "image_url", image_url: { url: msg.image } }
                        ]
                    });
                } else {
                    apiMessages.push({ role: msg.role, content: msg.content });
                }
            });

            const aiBubble = appendMessageUI('assistant', '', null, true);
            let fullReply = "";

            try {
                const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
                const key = document.getElementById('apiKey').value;
                const model = document.getElementById('customModel').value || "gpt-3.5-turbo";
                const temp = parseFloat(document.getElementById('tempRange').value);

                const res = await fetch(url + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
                    body: JSON.stringify({
                        model: model, messages: apiMessages, temperature: temp, stream: true
                    })
                });

                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || res.statusText);
                }

                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while(true) {
                    const { done, value } = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if(dataStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(dataStr);
                                const content = json.choices[0].delta.content || "";
                                fullReply += content;
                                aiBubble.innerHTML = cleanText(fullReply).replace(/\n/g, '<br>');
                                scrollToBottom();
                            } catch(e) {}
                        }
                    }
                }
                messages.push({ role: 'assistant', content: fullReply });
                saveData();

            } catch (e) {
                aiBubble.innerHTML += `<br><span style="color:red;font-size:12px;">ğŸš« ${e.message}</span>`;
            }
            btnAI.disabled = false; 
            btnAI.innerHTML = 'ğŸ¤–';
        }

        function cleanText(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '$1').replace(/```/g, '').replace(/`/g, '');
        }

        function appendMessageUI(role, text, imgBase64, isStreaming) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            const avatarUrl = role==='user' ? settings.userAvatar : settings.aiAvatar;
            const index = messages.length + (isStreaming ? 1 : 0); 

            div.innerHTML = `
                <div style="position:relative"><img src="${avatarUrl}" class="avatar"></div>
                <div class="message">
                    <div class="msg-index">#${index}</div>
                    ${imgBase64 ? `<img src="${imgBase64}" class="chat-img"><br>` : ''}
                    <span class="msg-content">${cleanText(text).replace(/\n/g, '<br>')}</span>
                </div>
            `;
            box.appendChild(div);
            scrollToBottom();
            if(isStreaming) return div.querySelector('.msg-content');
        }

        function scrollToBottom() {
            const b = document.getElementById('chatBox');
            b.scrollTop = b.scrollHeight;
        }

        function handleEnter(e) { 
            if(e.key==='Enter') sendUserMsg();
        }

        function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentUploadBase64 = ev.target.result;
                document.getElementById('previewImg').src = currentUploadBase64;
                document.getElementById('uploadPreview').style.display = 'flex';
            }
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        function clearUpload() {
            currentUploadBase64 = null;
            document.getElementById('uploadPreview').style.display = 'none';
        }

        async function doSummarize() {
            const start = parseInt(document.getElementById('sumStart').value) - 1;
            const end = parseInt(document.getElementById('sumEnd').value);
            if (isNaN(start) || end > messages.length) return;

            const btn = document.getElementById('btnDoSum');
            btn.innerText = "â³"; btn.disabled=true;
            
            try {
                const targetText = messages.slice(start, end).map(m=>`${m.role}:${m.content}`).join('\n');
                const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
                const key = document.getElementById('apiKey').value;
                const model = document.getElementById('customModel').value || "gpt-3.5-turbo";

                const res = await fetch(url + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {role:"system", content:"Summarize briefly."},
                            {role:"user", content: targetText}
                        ]
                    })
                });
                const d = await res.json();
                memories.push(d.choices[0].message.content);
                saveData(); renderMemories(); closeSummaryModal();
            } catch(e){ alert(e.message); }
            btn.innerText = "æ€»ç»“"; btn.disabled=false;
        }

        function normalizeBaseUrl(url) {
            url = url.trim();
            if (url.endsWith('/')) url = url.slice(0, -1); 
            if (url.endsWith('/chat/completions')) url = url.replace('/chat/completions', ''); 
            if (!url.endsWith('/v1') && url.includes('openai')) url += '/v1'; 
            return url;
        }
        function togglePanel(id) {
            document.querySelectorAll('.panel-overlay').forEach(p => { if(p.id !== id) p.style.display='none'; });
            const p = document.getElementById(id);
            p.style.display = p.style.display==='flex' ? 'none' : 'flex';
            if(p.style.display==='flex') p.classList.add('show');
            else saveSettings();
        }
        function saveSettings() {
            localStorage.setItem('v8_url', document.getElementById('apiUrl').value);
            localStorage.setItem('v8_key', document.getElementById('apiKey').value);
            localStorage.setItem('v8_sys', document.getElementById('systemPrompt').value);
            localStorage.setItem('v8_mod', document.getElementById('customModel').value);
            localStorage.setItem('v8_css', document.getElementById('userCss').value);
            settings.userName = document.getElementById('userName').value;
            settings.contextLimit = document.getElementById('contextRange').value;
            settings.temperature = document.getElementById('tempRange').value;
            localStorage.setItem('v8_settings', JSON.stringify(settings));
        }
        function loadSettings() {
            if(localStorage.getItem('v8_url')) document.getElementById('apiUrl').value = localStorage.getItem('v8_url');
            if(localStorage.getItem('v8_key')) document.getElementById('apiKey').value = localStorage.getItem('v8_key');
            if(localStorage.getItem('v8_sys')) document.getElementById('systemPrompt').value = localStorage.getItem('v8_sys');
            
            const savedModel = localStorage.getItem('v8_mod');
            if(savedModel) {
                document.getElementById('customModel').value = savedModel;
                const select = document.getElementById('modelSelect');
                select.value = savedModel;
                if(select.value !== savedModel) toggleCustomModel();
            }

            const s = localStorage.getItem('v8_settings');
            if(s) {
                settings = JSON.parse(s);
                document.getElementById('userName').value = settings.userName || "";
                const ctx = settings.contextLimit || 10;
                document.getElementById('contextRange').value = ctx;
                document.getElementById('contextVal').innerText = ctx; 
                const temp = settings.temperature || 0.7;
                document.getElementById('tempRange').value = temp;
                document.getElementById('tempVal').innerText = temp;
                document.getElementById('aiAvatarPreview').src = settings.aiAvatar;
                document.getElementById('userAvatarPreview').src = settings.userAvatar;
            }
            const bg = localStorage.getItem('v8_bg');
            if(bg) {
                document.getElementById('chatBox').style.backgroundImage = `url(${bg})`;
                document.getElementById('bgPreview').style.backgroundImage = `url(${bg})`;
            }
            const css = localStorage.getItem('v8_css');
            if(css) {
                const area = document.getElementById('userCss');
                if(area) area.value = css;
                applyUserCss(css);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('v8_msg', JSON.stringify(messages));
                localStorage.setItem('v8_mem', JSON.stringify(memories));
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.log("ç©ºé—´å·²æ»¡ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºã€çº¯æ–‡å­—ä¿å­˜ã€‘...");
                    const textOnlyMessages = messages.map(msg => {
                        return { role: msg.role, content: msg.content, image: null };
                    });
                    try {
                        localStorage.setItem('v8_msg', JSON.stringify(textOnlyMessages));
                        localStorage.setItem('v8_mem', JSON.stringify(memories));
                    } catch (err) { console.log("æ”¾å¼ƒä¿å­˜"); }
                }
            }
        }
        function loadData() {
            const m = localStorage.getItem('v8_msg'); if(m) messages = JSON.parse(m);
            const mem = localStorage.getItem('v8_mem'); if(mem) memories = JSON.parse(mem);
        }

        async function handleAvatarUpload(e, type) {
            const file = e.target.files[0];
            if(!file) return;
            try {
                const r = await compressImage(file, 150, 0.7);
                if(type==='ai') { 
                    settings.aiAvatar = r; 
                    document.getElementById('aiAvatarPreview').src = r; 
                } else { 
                    settings.userAvatar = r; 
                    document.getElementById('userAvatarPreview').src = r; 
                }
                saveSettings();
            } catch (err) { alert("å¤´åƒå¤„ç†å¤±è´¥"); }
        }

        function renderMemories() {
            const l = document.getElementById('memoryList'); l.innerHTML='';
            memories.forEach((m,i)=> l.innerHTML+=`<div class="memory-item"><span>${m}</span><span class="mem-del" onclick="memories.splice(${i},1);saveData();renderMemories()">Ã—</span></div>`);
        }
        function addMemoryManual() {
            const v = document.getElementById('newMemoryInput').value;
            if(v){ memories.push(v); saveData(); renderMemories(); document.getElementById('newMemoryInput').value=''; }
        }
        function openSummaryModal() {
            document.getElementById('summaryModalOverlay').style.display='block';
            document.getElementById('sumEnd').value = messages.length;
            document.getElementById('msgCountHint').innerText = `Total: ${messages.length}`;
        }
        function closeSummaryModal() { document.getElementById('summaryModalOverlay').style.display='none'; }
        function exportData() {
            const d = {settings, memories, messages, api:{url:document.getElementById('apiUrl').value, sys:document.getElementById('systemPrompt').value}};
            const b = new Blob([JSON.stringify(d)],{type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click();
        }
        function importData(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload=(ev)=>{
                try{
                    const d = JSON.parse(ev.target.result);
                    if(confirm("è¦†ç›–å½“å‰æ•°æ®?")){
                        messages=d.messages||[]; memories=d.memories||[]; settings=d.settings||settings;
                        if(d.api){ document.getElementById('apiUrl').value=d.api.url; document.getElementById('systemPrompt').value=d.api.sys; }
                        saveData(); saveSettings(); location.reload();
                    }
                }catch(err){alert("æ–‡ä»¶é”™è¯¯");}
            }; r.readAsText(f);
        }
        function toggleCustomModel() {
            const s = document.getElementById('modelSelect'); const i = document.getElementById('customModel');
            if(i.style.display==='none'){i.style.display='block'; s.style.display='none'; i.value=s.value;}
            else{i.style.display='none'; s.style.display='block';}
        }
        function clearChat() { if(confirm("æ¸…ç©º?")) { messages=[]; saveData(); renderMessages(); } }
        async function fetchModels() {
             try{
                 const u = normalizeBaseUrl(document.getElementById('apiUrl').value);
                 const k = document.getElementById('apiKey').value;
                 const r = await fetch(u+'/models',{headers:{Authorization:"Bearer "+k}});
                 const d = await r.json();
                 const s = document.getElementById('modelSelect'); s.innerHTML='';
                 d.data.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.innerText=m.id; s.appendChild(o); });
                 alert(`Loaded ${d.data.length} models`);
             } catch(e){alert(e.message); toggleCustomModel();}
        }
        async function testConnection(){
            try{
                 const u = normalizeBaseUrl(document.getElementById('apiUrl').value);
                 const k = document.getElementById('apiKey').value;
                 await fetch(u+'/models',{headers:{Authorization:"Bearer "+k}});
                 alert("è¿æ¥é¡ºç•…(ËŠoÌ´Ì¶Ì·Ì¤  Ì« oÌ´Ì¶Ì·Ì¤Ë‹)");
            }catch(e){alert("âŒ "+e.message);}
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function handleBgUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            try {
                const compressedBg = await compressImage(file, 750, 0.6);
                localStorage.setItem('v8_bg', compressedBg);
                document.getElementById('chatBox').style.backgroundImage = `url(${compressedBg})`;
                document.getElementById('bgPreview').style.backgroundImage = `url(${compressedBg})`;
            } catch (err) { alert("å£çº¸å¤„ç†å¤±è´¥ï¼Œå›¾ç‰‡å¯èƒ½å¤ªå¤§"); }
        }
        function resetBg() {
            localStorage.removeItem('v8_bg');
            document.getElementById('chatBox').style.backgroundImage = 'none';
            document.getElementById('bgPreview').style.backgroundImage = 'none';
        }
        function applyUserCss(cssCode) {
            let styleTag = document.getElementById('custom-style-tag');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'custom-style-tag';
                document.head.appendChild(styleTag);
            }
            styleTag.innerHTML = cssCode;
        }
    </script>
</body>
</html>


