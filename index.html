<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåˆ¶ç¦æ­¢ç¼“å­˜ (è§£å†³ iOS ä¸»å±å¹•ä¸æ›´æ–°é—®é¢˜) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>BJPhone</title>
    
    <!-- 1. ä½ çš„è‡ªå®šä¹‰å›¾æ ‡ (ä¿ç•™ä¸åŠ¨) -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    <link rel="icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">

    <!-- 2. å¼ºåˆ¶å…¨å±çš„æ ¸å¿ƒä¿®å¤é…ç½® -->
    <!-- å…³é”®ç‚¹ viewport-fit=coverï¼šè®©ç”»é¢èƒ½é’»åˆ°åˆ˜æµ·ä¸‹é¢ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS ä¸“ç”¨å…¨å±æ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#000000">

    <!-- 3. å¼ºåˆ¶æ³¨å…¥ Manifest (è¿™æ˜¯è§£å†³ç³»ç»Ÿæ›´æ–°åæ— æ³•éšè—åº•éƒ¨åœ°å€æ çš„å…³é”®) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQUkgUGhvbmUgUHJvIiwic2hvcnRfbmFtZSI6IkFJUGhvbmUiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCJ9">
    
    <style>
    
        /* --- å…¨å±€åŸºç¡€ --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

/* æ·»åŠ  html æ ·å¼ï¼Œå¼ºåˆ¶ iOS å¡«æ»¡ */
html {
    height: 100%;
    height: -webkit-fill-available; /* ä¸“é—¨é’ˆå¯¹ iOS çš„ä¿®å¤ */
    width: 100%;
    overflow: hidden;
}

body { 
    background-color: #000; /* é»˜è®¤é»‘è‰²èƒŒæ™¯ï¼Œé˜²ç©¿å¸® */
    display: flex; 
    justify-content: center; 
    align-items: center; 
    /* å…¼å®¹å†™æ³•ï¼šå…ˆç”¨ vhï¼Œå†ç”¨ dvh è¦†ç›– */
    min-height: 100vh; 
    min-height: 100dvh; 
    width: 100%;
    margin: 0; 
    padding: 0;
    font-family: "UserCustomFont", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
    overflow: hidden; 
    /* ç¦æ­¢ iOS æ©¡çš®ç­‹å›å¼¹æ•ˆæœ */
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
}


        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #000; 
            border-radius: 45px; 
            box-shadow: 0 0 0 8px #333, 0 20px 50px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden; 
            transition: all 0.3s ease;
        }
        /* è¯·æ›¿æ¢åŸæ¥çš„ @media (max-width: 768px) {...} é‡Œé¢çš„å†…å®¹ */
@media (max-width: 768px) {
    /* 1. å¼ºåˆ¶ body æ’‘æ»¡ï¼Œä¸ç•™ä½™åœ° */
    body {
        display: block !important;
        background: #000;
        padding: 0 !important;
        margin: 0 !important;
        width: 100vw;
        height: 100dvh;
        overflow: hidden;
    }

    /* 2. æ‰‹æœºå¤–å£³å¼ºåˆ¶é“ºæ»¡ï¼Œå±‚çº§æé«˜ */
    .phone-frame {
        position: fixed !important; /* å¼ºåˆ¶å›ºå®š */
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100dvh !important; /* å¿½ç•¥æµè§ˆå™¨æ é«˜åº¦ */
        border-radius: 0 !important;
        box-shadow: none !important;
        border: none !important;
        z-index: 10;
        background: transparent !important; /* é€æ˜ï¼Œè®©é‡Œé¢çš„é¡µé¢æ˜¾ç¤º */
    }

    /* 3. æ ¸å¿ƒä¿®å¤ï¼šè®©é¡µé¢å†…å®¹é’»åˆ°åˆ˜æµ·ä¸‹é¢ */
    .page {
        position: absolute !important;
        top: 0 !important; /* å¼ºåˆ¶é¡¶æ ¼ */
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 0 !important;
        /* å…³é”®ï¼šè®©èƒŒæ™¯å›¾å»¶ä¼¸åˆ°æœ€é¡¶ç«¯ */
        padding-top: env(safe-area-inset-top); 
    }

    /* 4. ç‰¹åˆ«ä¿®å¤ï¼šé¦–é¡µèƒŒæ™¯å›¾ */
    #page-home {
        /* è®©èƒŒæ™¯å›¾è¦†ç›–æ•´ä¸ªå±å¹•ï¼ŒåŒ…æ‹¬åˆ˜æµ· */
        background-position: center center !important;
        background-size: cover !important;
        background-repeat: no-repeat !important;
        /* è¿™ä¸€è¡Œå¯èƒ½å¯¼è‡´é»‘æ¡ï¼Œå»æ‰å®ƒï¼Œæˆ–è€…è®¾ä¸º0 */
        margin-top: 0 !important; 
    }
}

        /* --- é¡µé¢åˆ‡æ¢ç³»ç»Ÿ --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            z-index: 10;
        }
        .page.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px;
            font-size: 14px; font-weight: 600; color: inherit;
            z-index: 100;
            position: absolute; top: 0; left: 0;
        }

        /* --- 1. æ¡Œé¢ (Home) --- */
        #page-home {
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop') no-repeat center center/cover;
            color: white;
            justify-content: flex-start;
        }
        /* ä¿®æ”¹ .home-clock-widget (åŸç¬¬65è¡Œ) */
        .home-clock-widget { 
            margin-top: 60px;  /* ä»120æ”¹åˆ°60ï¼Œè®©æ—¶é’Ÿå¾€ä¸Šæ */
            text-align: center; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            margin-bottom: 20px; /* å¢åŠ åº•éƒ¨é—´è· */
        }
        
        /* åŸæ¥çš„ .clock-time å’Œ .clock-date (ç¬¬66-67è¡Œ) ä¸ç”¨åŠ¨ï¼Œä¿ç•™å³å¯ */
        .clock-time { font-size: 72px; font-weight: 200; letter-spacing: -2px; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; font-weight: 500; }

        /* --- é¦–é¡µæ»‘åŠ¨å®¹å™¨ --- */
.home-swiper-container {
    flex: 1;
    width: 100%;
    overflow: hidden; /* éšè—æº¢å‡ºéƒ¨åˆ† */
    position: relative;
    display: flex;
    flex-direction: column;
}

.home-swiper-wrapper {
    display: flex;
    width: 200%; /* ä¸¤é¡µå®½åº¦ */
    height: 100%;
    transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.home-slide {
    width: 50%; /* æ¯ä¸€é¡µå æ€»å®½çš„ä¸€åŠ */
    height: 100%;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* --- ç¬¬ä¸€é¡µï¼šæ··åˆå¸ƒå±€è¡Œ --- */
.mixed-row {
    width: 100%;
    /* å¢åŠ å·¦å³å†…è¾¹è·ï¼Œç¡®ä¿å’Œç¬¬äºŒé¡µçš„æ•´ä½“è§†è§‰å®½åº¦ä¸€è‡´ */
    padding: 0 5px; 
    display: flex;
    justify-content: space-between; /* å…³é”®ï¼šè®©å·¦å³ä¸¤å—è‡ªåŠ¨æ’‘å¼€ï¼Œä¸­é—´ç•™å‡ºç¼éš™ */
    align-items: center;
    margin-bottom: 30px; /* å¢åŠ è¡Œé—´è·ï¼Œé˜²æ­¢ä¸Šä¸‹å¤ªæŒ¤ */
    height: 170px; /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ï¼Œç»™ App åå­—ç•™ä½ç½® */
}

/* å ä¸€åŠå®½åº¦çš„å®¹å™¨ */
.half-block {
    width: 165px; /* ä» 160px æ”¹ä¸º 165pxï¼Œè®© CD æœºå’Œå¾…åŠæ›´å¤§ */
    height: 165px; /* ä¿æŒæ­£æ–¹å½¢ */
    position: relative;
    border-radius: 22px; /* åœ†è§’ç¨å¾®å¤§ä¸€ç‚¹ï¼Œæ›´åƒ iOS */
}
/* 2x2 å°åº”ç”¨ç½‘æ ¼ */
.mini-app-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    /* 
       æ°´å¹³é—´è· 15px (å’Œç¬¬äºŒé¡µä¸€è‡´) 
       å‚ç›´é—´è· 12px (ç´§å‡‘ä¸€ç‚¹ï¼Œè®©åå­—å’Œå›¾æ ‡è´´åˆ)
    */
    gap: 12px 15px; 
    justify-items: center;
    align-items: start; /* é¡¶éƒ¨å¯¹é½ï¼Œé˜²æ­¢åå­—æŠŠå›¾æ ‡é¡¶ä¸Šå» */
    padding-top: 10px; /* ç¨å¾®ç»™ä¸€ç‚¹é¡¶éƒ¨ç©ºé—´ */
    width: 100%;
    height: 100%;
}

/* å¤ç”¨åŸæœ¬çš„å›¾æ ‡æ ·å¼ï¼Œä½†ç¨å¾®ç¼©å°ä¸€ç‚¹é€‚é… 2x2 */
.mini-app-grid .app-icon {
    width: 58px;  /* æ¢å¤æ ‡å‡†å¤§å° (å’Œç¬¬äºŒé¡µä¸€æ ·) */
    height: 58px; 
    font-size: 30px; /* å›¾æ ‡é‡Œçš„ Emoji ä¹Ÿæ”¾å¤§ */
    box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* æ¢å¤é˜´å½± */
    margin-bottom: 5px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
}
.mini-app-grid .app-name {
    display: block !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    font-size: 11px;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    text-align: center;
    line-height: 1.2;
    white-space: nowrap; /* ä¸æ¢è¡Œ */
    transform: none; /* å–æ¶ˆç¼©æ”¾ï¼Œä¿æŒæ¸…æ™° */
}
        .mini-app-grid .app-icon-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
}

/* --- ç»„ä»¶ï¼šå¾…åŠäº‹é¡¹ (To-Do) --- */
.widget-todo {
    width: 165px; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    height: 165px;
    /* æ¨¡ä»¿ Apple Notes çš„é¢œè‰²æˆ–åŠé€æ˜ç£¨ç ‚ */
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(20px);
    border-radius: 22px;
    padding: 18px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    color: #000; /* ç™½åº•é»‘å­—æ›´åƒä¾¿åˆ©è´´ï¼Œå¦‚æœå–œæ¬¢é»‘åº•ç™½å­—å¯æ”¹å› #fff */
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.widget-todo:active { transform: scale(0.95); }

.widget-title {
    font-size: 13px; 
    font-weight: 700; 
    margin-bottom: 8px; 
    color: #ff9500; /* æ ‡é¢˜ç”¨æ©™è‰²ï¼Œåƒå¤‡å¿˜å½• */
    display: flex; 
    justify-content: space-between;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.todo-list-scroll {
    flex: 1;
    overflow-y: hidden; /* å°ç»„ä»¶é€šå¸¸ä¸æ»šåŠ¨ï¼Œåªæ˜¾ç¤ºå‰å‡ æ¡ */
    font-size: 11px;
}

/* å¾…åŠæ¡ç›®æ ·å¼å¾®è°ƒ */
.todo-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
.todo-check {
    border-color: #ccc; /* ç°è‰²åœˆåœˆ */
}
.todo-text {
    color: #333;
    font-weight: 500;
}

/* --- ç»„ä»¶ï¼šCD æ’­æ”¾å™¨ (é€æ˜æœºèº« + å”±è‡‚) --- */
.widget-cd {
    width: 165px; /* æ­£æ–¹å½¢ */
    height: 165px;
    /* ç§»é™¤ç°è‰²èƒŒæ™¯ï¼Œæ”¹ä¸ºå®Œå…¨é€æ˜æˆ–å¾®é€ */
    background: rgba(0,0,0,0.05); 
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; /* å…³é”®ï¼šä¸ºå”±è‡‚å®šä½ */
    overflow: visible;  /* å…è®¸å”±è‡‚ç¨å¾®çªå‡ºä¸€ä¸ç‚¹ */
    box-shadow: none;   /* å»æ‰å¡ç‰‡é˜´å½±ï¼Œåªç•™CDé˜´å½± */
}

/* CD å”±ç‰‡æœ¬ä½“ */
.cd-disc {
    width: 135px; /* ç¨å¾®è°ƒå¤§ CD */
    height: 135px;
    border-radius: 50%;
    background: #000;
    background-size: cover;
    background-position: center;
    /* CD çš„å…‰æ³½è¾¹æ¡†å’Œæ·±é‡é˜´å½±ï¼Œæ›´æœ‰ç«‹ä½“æ„Ÿ */
    border: 2px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
    animation: spin 10s linear infinite;
    animation-play-state: paused;
    z-index: 1; /* åœ¨å”±è‡‚ä¸‹é¢ */
}

.widget-cd.active .cd-disc {
    animation-play-state: running;
}

/* å”±ç‰‡ä¸­å¿ƒå­” */
.cd-center-hole {
    width: 25px; height: 25px; 
    background: rgba(200,200,200,0.3); 
    border-radius: 50%; 
    position: absolute;
    top: 50%; left: 50%; 
    transform: translate(-50%, -50%);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.3);
    z-index: 3;
}

/* --- çº¯ CSS ç»˜åˆ¶å”±è‡‚ (Tonearm) --- */
.widget-cd::after {
    content: '';
    position: absolute;
    top: -8px;    /* å®šä½åœ¨å³ä¸Šè§’ */
    right: -8px;
    width: 65px;
    height: 65px;
    /* ç”»ä¸€ä¸ªLå½¢çš„å”±è‡‚ */
    border-top: 5px solid #d1d1d6; /* å”±è‡‚é¢œè‰²ï¼šé“¶ç° */
    border-right: 5px solid #d1d1d6;
    border-top-right-radius: 15px; /* è½¬è§’åœ†æ¶¦ */
    z-index: 2; /* åœ¨CDä¸Šé¢ */
    /* æ—‹è½¬è§’åº¦ï¼Œè®©å®ƒçœ‹èµ·æ¥åƒæ­åœ¨CDä¸Š */
    transform: rotate(15deg) translate(-10px, 10px);
    pointer-events: none; /* é˜²æ­¢æŒ¡ä½ç‚¹å‡» */
    filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.3)); /* å”±è‡‚é˜´å½± */
}

/* å”±è‡‚å¤´ (é’ˆå¤´éƒ¨åˆ†) */
.widget-cd::before {
    content: '';
    position: absolute;
    top: 35%; 
    left: 28%; /* å¤§æ¦‚åœ¨CDè¾¹ç¼˜ */
    width: 12px; height: 18px;
    background: #333;
    transform: rotate(15deg);
    z-index: 2;
    border-radius: 2px;
}

/* --- ç¬¬äºŒé¡µï¼šæ™®é€šç½‘æ ¼ --- */
.page2-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 30px 15px;
    width: 100%;
    padding-top: 10px;
}

/* --- åº•éƒ¨ç¿»é¡µç‚¹ --- */
.pagination-dots {
    display: flex;
    gap: 8px;
    margin-bottom: 30px; /* åœ¨ Home Indicator ä¸Šæ–¹ */
    justify-content: center;
    width: 100%;
}
.page-dot {
    width: 8px; height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transition: 0.3s;
}
.page-dot.active {
    background: #fff;
}
        .app-icon-container { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .app-icon-container:active { transform: scale(0.9); }
        .app-icon {
            width: 58px; height: 58px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .icon-msg { background: linear-gradient(to bottom, #34c759, #30b753); }
        .icon-note { background: linear-gradient(to bottom, #ffd60a, #ffcc00); }
        .icon-settings { background: linear-gradient(to bottom, #8e8e93, #636366); }

        /* --- é€šç”¨ App å¤´éƒ¨ --- */
        .app-header {
            height: 90px; padding-top: 44px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding-left: 15px; padding-right: 15px;
            background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .app-title { font-size: 28px; font-weight: bold; color: #000; }
        .btn-icon-text { font-size: 16px; color: #007AFF; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .btn-icon-only { font-size: 22px; color: #007AFF; background: none; border: none; cursor: pointer; padding: 5px; }

        /* --- 2. æ¶ˆæ¯åˆ—è¡¨ --- */
        #page-msg-list { background: #fff; }
        .msg-list-scroll { flex: 1; overflow-y: auto; }
        .msg-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: 0.2s;
        }
        .msg-list-item:active { background: #f5f5f5; }
        .list-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee;}
        .list-info { flex: 1; min-width: 0; }
        .list-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .list-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-time { font-size: 12px; color: #c7c7cc; white-space: nowrap; }

        /* --- 3. èŠå¤©ç•Œé¢ --- */
        /* ä¿®å¤åçš„èƒŒæ™¯ï¼šå»æ‰é¡¶éƒ¨å†…è¾¹è·ï¼Œè®©å£çº¸æ’‘æ»¡ */
        #page-chat { 
            background-color: #f2f2f7; 
            background-size: cover; 
            background-position: center; 
            padding-top: 95px; /* ç»™é¡¶éƒ¨ç•™å‡ºç©ºé—´ */
        }

        /* ä¿®å¤åçš„é¡¶éƒ¨æ ï¼šå¼ºåˆ¶å›ºå®šåœ¨æœ€ä¸Šæ–¹ï¼Œå¡«è¡¥çŠ¶æ€æ ç¼éš™ */
        .chat-header-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: auto; min-height: 90px;
            padding-top: max(44px, env(safe-area-inset-top));
            padding-bottom: 10px;
            padding-left: 15px; padding-right: 15px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            display: flex; align-items: flex-end; justify-content: space-between;
            border-bottom: 1px solid #dbdbdb;
            z-index: 50;
        }
        .chat-back-btn { color: #007AFF; font-size: 16px; border: none; background: none; display: flex; align-items: center; cursor: pointer; }
        .chat-contact-name { font-weight: 600; font-size: 16px; flex: 1; text-align: center; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .chat-header-actions { display: flex; gap: 15px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; position: relative; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); background:#fff;}
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .message { background: #fff; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .message { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        .msg-index { font-size: 10px; color: #999; position: absolute; top: -15px; opacity: 0.5; }
        .msg-row.left .msg-index { left: 45px; }
        .msg-row.right .msg-index { right: 45px; }

        .input-area { background: #f9f9f9; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px; }
        .input-toolbar { display: flex; align-items: center; gap: 8px; width: 100%; }
        #userInput { flex: 1; min-width: 0; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #userInput:focus { border-color: #007AFF; }
        .btn-send { font-size: 24px; background: none; border: none; cursor: pointer; color: #007AFF; padding: 0 5px; flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .typing-indicator { display: inline-block; width: 4px; height: 4px; background: #999; border-radius: 50%; margin: 0 1px; animation: bounce 1s infinite; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; gap: 10px; font-size: 12px; }

        /* --- é€šç”¨åˆ—è¡¨æ ·å¼ (è®¾ç½®/è®°å¿†) --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; }
        .ios-group-title { font-size: 13px; color: #666; margin: 15px 15px 5px; text-transform: uppercase; }
        .ios-list { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 12px 15px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; justify-content: space-between; min-height: 45px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-item:active { background-color: #f9f9f9; }
        .ios-label { font-size: 16px; font-weight: 500; color: #000; flex-shrink: 0; margin-right: 10px;}
        .ios-input { border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; background: transparent; flex: 1; min-width: 0;}
        .ios-btn { width: 100%; padding: 14px; text-align: center; color: #007AFF; background: #fff; border: none; font-size: 16px; cursor: pointer; border-top: 1px solid #e5e5ea; }
        .ios-btn.danger { color: #ff3b30; }
        .memory-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; position: relative; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-del-mem { position: absolute; top: 10px; right: 10px; color: #ff3b30; cursor: pointer; font-size: 18px;}

        /* --- å¼¹çª— Modal --- */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:500; display:none; align-items:center; justify-content:center; opacity: 0; transition: opacity 0.2s;}
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); width: 85%; max-height: 70%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; font-size: 17px;}
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #f2f2f7;}
        .modal-footer { display: flex; border-top: 1px solid #ccc; }
        .modal-btn { flex: 1; padding: 15px; background: #fff; border: none; font-size: 17px; cursor: pointer; }
        .modal-btn:first-child { border-right: 1px solid #ccc; color: #ff3b30; }
        .modal-btn:last-child { color: #007AFF; font-weight: 600; }

        /* Home Indicator */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: #000; border-radius: 10px; z-index: 999; cursor: pointer;
        }
        #page-home .home-indicator { background: #fff; }
        
        /* æ¶ˆæ¯ä¸‹æ–¹çš„å·¥å…·æ  */
        .msg-meta-row { display: flex; align-items: center; margin-top: 2px; }
        .msg-row.left .msg-meta-row { justify-content: flex-start; margin-left: 45px; }
        .msg-row.right .msg-meta-row { justify-content: flex-end; margin-right: 45px; }
        
        /* é‡åˆ·æŒ‰é’® */
        .btn-reroll { 
            font-size: 12px; color: #999; cursor: pointer; padding: 2px 5px; 
            background: rgba(255,255,255,0.5); border-radius: 10px;
            display: flex; align-items: center; gap: 3px;
        }
        .btn-reroll:active { transform: scale(0.9); background: #ddd; }
        /* --- å¼ºåˆ¶ä¿®å¤ iOS é•¿æŒ‰å†²çª --- */
        .msg-row.right .message {
            -webkit-touch-callout: none !important; 
            -webkit-user-select: none !important;
            user-select: none !important;
        }
        /* --- ç•ªèŒ„é’Ÿä¸“å±æ ·å¼ --- */
        .pomo-bubble {
            margin-top: 30px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 85%;
            text-align: center;
            font-size: 16px;
            color: #333;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }
        /* æˆ³ä¸€æˆ³åŠ¨ç”»ç±» */
        .anim-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
          10%, 90% { transform: translate3d(-2px, 0, 0); }
          20%, 80% { transform: translate3d(4px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
          40%, 60% { transform: translate3d(8px, 0, 0); }
        }
        /* --- Pop é£æ ¼æ—¶é—´æˆ³æ ·å¼ --- */
        .message {
            position: relative; /* ä¸ºç»å¯¹å®šä½çš„æ—¶é—´æˆ³åšå‚ç…§ */
            padding-bottom: 18px; /* åº•éƒ¨ç•™å‡ºç©ºé—´ç»™æ—¶é—´æˆ³ï¼Œé¿å…é®æŒ¡æ–‡å­— */
            min-width: 60px; /* ä¿è¯æ°”æ³¡ä¸ä¼šå¤ªçª„ */
        }

        .msg-time-stamp {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            opacity: 0.6; /* ç¨å¾®é€æ˜ï¼Œä¸æŠ¢çœ¼ */
            font-weight: 400;
            user-select: none;
        }

        /* é’ˆå¯¹æ·±è‰²æ°”æ³¡ï¼ˆå³ä¾§ï¼‰çš„é€‚é… */
        .msg-row.right .msg-time-stamp {
            color: rgba(255, 255, 255, 0.9);
        }

        /* é’ˆå¯¹æµ…è‰²æ°”æ³¡ï¼ˆå·¦ä¾§ï¼‰çš„é€‚é… */
        .msg-row.left .msg-time-stamp {
            color: rgba(0, 0, 0, 0.5);
        }
        /* --- æ—¥å† App æ ·å¼ --- */
.cal-month-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; font-size: 18px; font-weight: bold; border-bottom: 1px solid #eee;
}
.cal-month-nav button { background:none; border:none; font-size:20px; color:#007AFF; cursor:pointer; padding: 0 10px;}

.cal-week-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px 0; font-size: 12px; color: #999; border-bottom: 1px solid #f0f0f0; }

.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); auto-rows: 50px; }
.cal-cell { 
    border-bottom: 1px solid #fafafa; border-right: 1px solid #fafafa;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; cursor: pointer;
}
.cal-cell.active { background-color: #e5f1ff; } /* é€‰ä¸­æ€ */
.cal-cell.today { color: #007AFF; font-weight: bold; }
.cal-cell.empty { background: #fcfcfc; }

/* æ ‡è®°ç‚¹æ ·å¼ */
.cal-dot-container { display: flex; gap: 2px; margin-top: 2px; }
.dot-event { width: 5px; height: 5px; border-radius: 50%; background-color: #ff9500; } /* èŠ‚æ—¥æ˜¯æ©™è‰²ç‚¹ */
.dot-period { width: 6px; height: 6px; border-radius: 50%; background-color: #ff2d55; border: 1px solid #fff;} /* ç»æœŸæ˜¯ç²‰çº¢å¤§ç‚¹ */

/* ç»æœŸé¢„æµ‹åŒºé—´èƒŒæ™¯ (è¿›é˜¶æ•ˆæœ) */
.cal-cell.period-range { background-color: rgba(255, 45, 85, 0.1); }
        /* --- ä»¿ iOS å¤©æ°”ç»„ä»¶ --- */
.weather-widget {
    width: 335px; /* å’Œæ‰‹æœºå®½åº¦åŒ¹é… */
    height: 100px; /* æ‰é•¿å‹ç»„ä»¶ */
    background: linear-gradient(135deg, #3b82f6, #2563eb); /* ç»å…¸çš„æ™´å¤©è“ */
    border-radius: 20px;
    margin: 0 auto 20px auto; /* å±…ä¸­ï¼Œä¸‹æ–¹ç•™ç©º */
    padding: 15px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.weather-widget:active { transform: scale(0.98); }

/* å·¦ä¾§ï¼šæ¸©åº¦å’Œæè¿° */
.weather-left { display: flex; flex-direction: column; justify-content: center; }
.weather-temp { font-size: 42px; font-weight: 300; line-height: 1; }
.weather-desc { font-size: 14px; font-weight: 500; margin-top: 5px; opacity: 0.9; }
.weather-range { font-size: 12px; margin-top: 2px; opacity: 0.7; }

/* å³ä¾§ï¼šä½ç½®å’Œå›¾æ ‡ */
.weather-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; height: 100%; }
.weather-loc { font-size: 14px; font-weight: 600; }
.weather-icon { font-size: 36px; }

/* åŠ¨æ€èƒŒæ™¯è£…é¥° (äº‘æœµ) */
.weather-bg-deco {
    position: absolute; top: -10px; right: -10px;
    font-size: 120px; opacity: 0.1; pointer-events: none;
}
        /* --- è¯¾ç¨‹/æ—¥ç¨‹è¡¨æ ·å¼ --- */
.schedule-list { padding: 15px; }
.schedule-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.sched-time { font-size: 18px; font-weight: bold; color: #007AFF; }
.sched-info { flex: 1; margin-left: 15px; }
.sched-name { font-size: 16px; font-weight: 600; }
.sched-day { font-size: 12px; color: #999; margin-top: 2px; }
.btn-del-sched { color: #ff3b30; font-size: 20px; cursor: pointer; padding: 5px; }

/* æ·»åŠ æ—¥ç¨‹çš„è¡¨å•åŒºåŸŸ */
.sched-form {
    background: #f9f9f9; padding: 15px; border-radius: 12px; margin: 15px;
    display: flex; flex-direction: column; gap: 10px;
}
.sched-row { display: flex; gap: 10px; }
        /* --- æ—¥è®°æœ¬ä¸“ç”¨æ ·å¼ (æ·»åŠ åˆ° style æ ‡ç­¾é‡Œ) --- */
.diary-folder {
    background: #fff; border-bottom: 1px solid #f0f0f0;
    padding: 20px; display: flex; align-items: center; gap: 15px; cursor: pointer;
}
.diary-folder:active { background: #f9f9f9; }
.diary-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
.diary-info { flex: 1; }
.diary-title { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
.diary-sub { font-size: 13px; color: #999; }
.btn-float-write {
    position: absolute; bottom: 30px; right: 20px;
    width: 56px; height: 56px; border-radius: 50%;
    background: #007AFF; color: white; font-size: 24px;
    border: none; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
}
        /* --- X (Twitter) App ä¸“å±æ ·å¼ (SVG é«˜æ¸…ç‰ˆ) --- */
#page-x {
    background-color: #000000;
    color: #e7e9ea;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    overflow: hidden;
}

/* --- å¤´éƒ¨æ ·å¼æ›´æ–° --- */
.x-header {
    position: absolute; top: 0; left: 0; width: 100%;
    height: 90px; padding-top: 44px;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid #2f3336;
    display: flex; justify-content: center; align-items: center;
    z-index: 50;
}

/* å·¦ä¸Šè§’è¿”å›æŒ‰é’® */
.x-header-back { 
    position: absolute; left: 15px; bottom: 10px;
    width: 32px; height: 32px; 
    display: flex; align-items: center; justify-content: center;
    background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;
}

/* ä¸­é—´ç”¨æˆ·å¤´åƒ (æ›¿æ¢Logo) */
.x-header-center-avatar { 
    width: 32px; height: 32px; border-radius: 50%; object-fit: cover; 
    border: 2px solid #000; /* åŠ ä¸ªé»‘è¾¹æ›´æœ‰å±‚æ¬¡ */
}

/* å³ä¸Šè§’æ˜Ÿæ˜Ÿå›¾æ ‡ */
.x-header-right { 
    position: absolute; right: 15px; bottom: 10px; 
    width: 22px; height: 22px; fill: #fff; 
}

.x-feed {
    margin-top: 90px; margin-bottom: 50px;
    height: calc(100% - 140px);
    overflow-y: auto;
    background: #000;
}

.x-refresh-indicator {
    text-align: center; padding: 10px; color: #1d9bf0; font-size: 20px; display: none;
}

/* æ¨æ–‡æ ·å¼ */
.x-tweet {
    padding: 12px 16px; border-bottom: 1px solid #2f3336;
    display: flex; gap: 12px; transition: background 0.2s;
}
.x-tweet:active { background-color: rgba(255,255,255,0.03); }
.x-tweet-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
.x-tweet-content { flex: 1; min-width: 0; }
.x-tweet-header { display: flex; align-items: center; gap: 5px; font-size: 15px; }
.x-name { font-weight: 700; color: #e7e9ea; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;}
.x-handle, .x-time { color: #71767b; font-weight: 400; font-size: 14px; }
.x-text { margin-top: 2px; font-size: 15px; line-height: 1.5; color: #e7e9ea; white-space: pre-wrap; word-wrap: break-word; }

/* äº’åŠ¨æŒ‰é’® SVG æ ·å¼ */
.x-actions { display: flex; justify-content: space-between; margin-top: 12px; max-width: 300px; }
.x-action-btn {
    display: flex; align-items: center; gap: 5px;
    color: #71767b; background: none; border: none; cursor: pointer; padding: 0;
    font-size: 13px; /* æ•°å­—å¤§å° */
    transition: color 0.2s;
}
.x-action-icon { width: 18px; height: 18px; fill: currentColor; } /* å›¾æ ‡å¤§å° */

.x-action-btn.reply:hover { color: #1d9bf0; }
.x-action-btn.retweet:hover { color: #00ba7c; }
.x-action-btn.like:hover { color: #f91880; }
.x-action-btn.liked { color: #f91880; } 
.x-action-btn.liked .x-action-icon { fill: #f91880; } /* ç‚¹èµåå¡«å……çº¢è‰² */

/* åº•éƒ¨å¯¼èˆª SVG */
.x-tab-bar {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 53px; border-top: 1px solid #2f3336;
    background: #000; display: flex; justify-content: space-around; align-items: center;
    padding-bottom: 15px; 
    z-index: 50;
}
.x-tab-btn { 
    background: none; border: none; padding: 10px; 
    color: #e7e9ea; /* å›¾æ ‡é»˜è®¤é¢œè‰² */
    display: flex; align-items: center; justify-content: center;
}
.x-tab-icon { width: 26px; height: 26px; fill: currentColor; } /* åº•éƒ¨å›¾æ ‡ç¨å¤§ */
.x-tab-btn.active { color: #e7e9ea; } /* é€‰ä¸­æ€ */
.x-tab-btn.active .x-tab-icon { 
    stroke: currentColor; 
    stroke-width: 1px; /* è¿™é‡Œç®€å•æ¨¡æ‹Ÿé€‰ä¸­åŠ ç²—ï¼ŒçœŸå®Xæ˜¯åˆ‡æ¢å®å¿ƒ/ç©ºå¿ƒå›¾æ ‡ */
}

/* --- æ‚¬æµ®æŒ‰é’® (ä¿®å¤ç¾½æ¯›å½¢çŠ¶) --- */
.x-fab {
    position: absolute; bottom: 70px; right: 20px;
    width: 56px; height: 56px;
    background-color: #1d9bf0;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 4px 10px rgba(29, 155, 240, 0.3);
    cursor: pointer; z-index: 60;
    transition: transform 0.2s;
}
.x-fab:active { transform: scale(0.9); }
/* è°ƒæ•´å›¾æ ‡å¤§å°å’Œä½ç½®ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒåŸç‰ˆ */
.x-fab-icon { width: 26px; height: 26px; fill: white; margin-left: -2px; margin-top: 2px; }
        /* --- X è¯¦æƒ…é¡µä¸“å±æ ·å¼ --- */
#page-x-detail { z-index: 60; } /* ç›–åœ¨ä¸»é¡µä¸Šé¢ */

/* è¯¦æƒ…é¡µçš„ä¸»æ¨æ–‡æ ·å¼ (æ¯”åˆ—è¡¨é¡µæ›´å¤§) */
.x-detail-tweet { padding: 16px; border-bottom: 1px solid #2f3336; }
.x-detail-user { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
.x-detail-avatar { width: 50px; height: 50px; border-radius: 50%; }
.x-detail-info { display: flex; flex-direction: column; }
.x-detail-name { font-size: 16px; font-weight: 800; color: #e7e9ea; }
.x-detail-handle { font-size: 15px; color: #71767b; }
.x-detail-text { font-size: 20px; line-height: 1.4; color: #e7e9ea; margin-bottom: 15px; }
.x-detail-meta { color: #71767b; font-size: 15px; padding: 15px 0; border-top: 1px solid #2f3336; border-bottom: 1px solid #2f3336; }

/* è¯„è®ºåˆ—è¡¨æ ·å¼ */
.x-comment-item { 
    padding: 12px 16px; border-bottom: 1px solid #2f3336; display: flex; gap: 12px; 
}
.x-comment-content { flex: 1; }
.x-comment-header { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;}
.x-comment-name { font-weight: 700; color: #e7e9ea; margin-right: 5px; }
.x-comment-handle { color: #71767b; }
.x-comment-text { font-size: 15px; color: #e7e9ea; line-height: 1.4; }
.x-comment-reply-tag { color: #1d9bf0; font-size: 13px; margin-bottom: 2px; }

/* åº•éƒ¨å›å¤æ  */
.x-detail-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 60px; background: #000; border-top: 1px solid #2f3336;
    display: flex; align-items: center; padding: 0 15px; gap: 10px;
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 100;
}
.x-detail-input {
    flex: 1; background: #202327; border: none; border-radius: 20px;
    padding: 10px 15px; color: #fff; font-size: 16px; outline: none;
}
.x-detail-send-btn {
    background: #1d9bf0; color: #fff; border: none; border-radius: 20px;
    padding: 8px 16px; font-weight: bold; cursor: pointer;
}
.x-detail-send-btn:active { opacity: 0.8; }
        /* --- X ä¸ªäººä¸»é¡µæ ·å¼ --- */
.x-profile-header { position: absolute; top: 0; left: 0; width: 100%; height: 50px; z-index: 10; }
.x-header-back-circle {
    margin: 10px; width: 32px; height: 32px; border-radius: 50%;
    background: rgba(0,0,0,0.6); border: none; color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.x-profile-banner {
    width: 100%; height: 150px; background: #333; background-size: cover; background-position: center;
}
.x-profile-info { padding: 12px 16px; position: relative; }
.x-profile-top-row { display: flex; justify-content: space-between; align-items: flex-end; margin-top: -45px; margin-bottom: 10px; }
.x-profile-avatar {
    width: 80px; height: 80px; border-radius: 50%; border: 4px solid #000; object-fit: cover;
}
.x-edit-profile-btn {
    background: none; border: 1px solid #536471; color: #fff;
    border-radius: 20px; padding: 6px 15px; font-weight: bold; font-size: 14px;
}
.x-profile-name-box { display: flex; align-items: center; gap: 4px; }
.x-profile-name { font-size: 20px; font-weight: 800; color: #e7e9ea; }
.x-profile-handle { color: #71767b; font-size: 15px; margin-bottom: 10px; }
.x-profile-bio { font-size: 15px; color: #e7e9ea; margin-bottom: 10px; line-height: 1.4; }
.x-profile-meta { display: flex; gap: 15px; color: #71767b; font-size: 14px; margin-bottom: 10px; }
.x-profile-stats { display: flex; gap: 20px; font-size: 14px; }
.x-stat-num { color: #e7e9ea; font-weight: 700; }
.x-stat-label { color: #71767b; }

/* ç¼–è¾‘å¼¹çª—æ ·å¼ */
.x-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px; border-bottom: 1px solid #2f3336; background: #000;
}
.x-input-group { margin-bottom: 15px; }
.x-input-group label { display: block; color: #71767b; font-size: 13px; margin-bottom: 5px; }
.x-input {
    width: 100%; background: #202327; border: 1px solid #333; border-radius: 4px;
    padding: 8px; color: #fff; font-size: 16px; outline: none;
}
.x-input:focus { border-color: #1d9bf0; }
.x-flex-row { display: flex; gap: 10px; }

/* è®¤è¯å¾½ç« é¢œè‰² */
.badge-blue { fill: #1d9bf0; }
.badge-gold { fill: #ffd700; }
.badge-white { fill: #fff; } /* å¿ƒå½¢ã€åœ†ç¯ã€è±å½¢ */
        /* --- å¼ºåˆ¶ä¿®æ­£ X ä¸ªäººä¸»é¡µèƒŒæ™¯ä¸ºçº¯é»‘ --- */
#page-x-profile {
    background-color: #000000 !important; /* å¼ºåˆ¶è¦†ç›–é»˜è®¤ç™½è‰²èƒŒæ™¯ */
    color: #e7e9ea;
}

/* ä¿®æ­£ç¼–è¾‘å¼¹çª—çš„èƒŒæ™¯ */
#modal-x-edit .modal-box {
    background-color: #000000 !important;
    border: 1px solid #2f3336; /* åŠ ä¸ªæ·±ç°è‰²è¾¹æ¡†ï¼Œæ›´æœ‰è´¨æ„Ÿ */
}

/* ä¿®æ­£å¼¹çª—å¤´éƒ¨å’Œå†…å®¹åŒº */
.x-modal-header {
    background-color: #000000 !important;
    border-bottom: 1px solid #2f3336;
}
.modal-body {
    background-color: #000000 !important;
}

/* ç¡®ä¿è¾“å…¥æ¡†ä¹Ÿæ˜¯é»‘åº•ç™½å­— */
.x-input {
    background-color: #202327 !important;
    color: #ffffff !important;
    border: 1px solid #333 !important;
}
.x-input:focus {
    border-color: #1d9bf0 !important;
}

/* ä¸‹æ‹‰é€‰æ‹©æ¡†çš„é€‰é¡¹èƒŒæ™¯ */
select.x-input option {
    background-color: #000;
    color: #fff;
}
        /* --- ä¿®å¤ï¼šä¸ªäººä¸»é¡µé¡¶éƒ¨å¯¼èˆªæ  --- */
.x-profile-header { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100px; /* å¢åŠ é«˜åº¦ */
    /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼ŒæŠŠå†…å®¹æŒ¤ä¸‹æ¥ */
    padding-top: 50px; 
    z-index: 60; 
    /* è®©è¿™ä¸€å±‚ä¸æ‹¦æˆªç‚¹å‡»ï¼Œåªè®©é‡Œé¢çš„æŒ‰é’®æ‹¦æˆªç‚¹å‡» */
    pointer-events: none; 
}

/* --- ä¿®å¤ï¼šè¿”å›æŒ‰é’®æ ·å¼ --- */
.x-header-back-circle {
    /* æ¢å¤æŒ‰é’®çš„å¯ç‚¹å‡»çŠ¶æ€ */
    pointer-events: auto; 
    
    margin-left: 20px; /* ç¨å¾®ç¦»å·¦è¾¹è¿œä¸€ç‚¹ */
    width: 36px; height: 36px; /*ç¨å¾®å¤§ä¸€ç‚¹æ›´å¥½ç‚¹*/
    border-radius: 50%;
    
    /* åŠ æ·±èƒŒæ™¯è‰²ï¼Œç¡®ä¿åœ¨ä»»ä½•å£çº¸ä¸Šéƒ½èƒ½çœ‹æ¸… */
    background: rgba(0, 0, 0, 0.7); 
    backdrop-filter: blur(5px);
    
    border: 1px solid rgba(255,255,255,0.2); /* åŠ ä¸ªç»†è¾¹æ¡†æ›´æœ‰è´¨æ„Ÿ */
    color: #fff; 
    font-size: 22px;
    display: flex; align-items: center; justify-content: center; 
    cursor: pointer;
    
    /* åŠ ä¸ªé˜´å½± */
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
        /* ============================================
   ğŸ› ï¸ 1. ä¿®å¤è¯¦æƒ…é¡µåº•éƒ¨å›å¤æ  (é˜²æ­¢æŒ‰é’®è¢«æŒ¤é£)
   ============================================ */
.x-detail-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 60px; background: #000; border-top: 1px solid #2f3336;
    display: flex; align-items: center; 
    padding: 0 15px; 
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 100;
    box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢paddingæ’‘å¤§ */
}

.x-detail-input {
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    min-width: 0; 
    background: #202327; border: none; border-radius: 20px;
    padding: 10px 15px; color: #fff; font-size: 16px; outline: none;
    margin-right: 10px; 
}

.x-detail-send-btn {
    flex-shrink: 0; /* å…³é”®ï¼šç¦æ­¢æŒ‰é’®è¢«å‹ç¼© */
    background: #1d9bf0; color: #fff; border: none; border-radius: 20px;
    padding: 8px 16px; font-weight: bold; cursor: pointer;
    white-space: nowrap;
}

/* ============================================
   ğŸ†• 2. è½¬æ¨èœå• & å¼•ç”¨æ ·å¼
   ============================================ */
/* åº•éƒ¨åŠ¨ä½œèœå• (ä»¿iOS Action Sheet) */
.x-action-sheet {
    width: 100%; background: #000; 
    border-top-left-radius: 20px; border-top-right-radius: 20px;
    border: 1px solid #2f3336; padding-bottom: 30px;
}
.x-sheet-item {
    padding: 18px; font-size: 18px; font-weight: bold; color: #e7e9ea;
    display: flex; align-items: center;
    border-bottom: 1px solid #2f3336; cursor: pointer;
}
.x-sheet-item:active { background: #16181c; }
.x-sheet-cancel {
    padding: 18px; font-size: 18px; font-weight: bold; color: #e7e9ea; text-align: center;
    margin-top: 10px; border-top: 5px solid #202327; cursor: pointer;
}

/* å¼•ç”¨æ¨æ–‡çš„æ¡†æ¡†æ ·å¼ */
.x-quote-box {
    margin-top: 10px; border: 1px solid #2f3336; border-radius: 12px;
    padding: 10px; overflow: hidden; pointer-events: none;
}
/* è½¬å¸–é¡¶éƒ¨çš„ "xxx è½¬å¸–äº†" */
.x-repost-header {
    font-size: 13px; color: #71767b; font-weight: 700;
    display: flex; align-items: center; gap: 5px; 
    margin-bottom: 5px; margin-left: 30px; /* è·Ÿå¤´åƒé”™å¼€ */
}
        /* ä¹¦æ¶æ ·å¼ */
.book-cover {
    width: 100%; aspect-ratio: 2/3; background: #eee; border-radius: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; overflow: hidden;
    cursor: pointer; text-align: center; padding: 10px; transition: transform 0.2s;
}
.book-cover:active { transform: scale(0.95); }
.book-title { font-size: 12px; font-weight: bold; margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.book-author { font-size: 10px; color: #999; }

/* é˜…è¯»å™¨ç‰¹å®š */
#page-reader * { transition: background 0.3s, color 0.3s; }
.reader-btn-chap { border:none; background:rgba(91, 70, 54, 0.1); color:#5b4636; font-size:13px; padding: 8px 12px; border-radius: 8px; font-weight: bold; }
.reader-btn-page { border:none; background:none; color:#5b4636; font-size:16px; padding: 5px 10px; }
.reader-btn-chap:active, .reader-btn-page:active { opacity: 0.6; transform: scale(0.95); }
        /* é˜…è¯»ç¬”è®°å¡ç‰‡ */
.summary-card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border-left: 4px solid #ffcc00; /* ç¬”è®°æœ¬é£æ ¼çš„å·¦è¾¹æ¡† */
}
.sum-chap-title {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
}
.sum-text {
    font-size: 14px;
    color: #555;
    line-height: 1.5;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}
.sum-empty {
    font-size: 12px;
    color: #ccc;
    font-style: italic;
}
        /* ============ éŸ³ä¹æ’­æ”¾å™¨ä¸“ç”¨æ ·å¼ ============ */
        
        /* 1. æ‚¬æµ®çƒ (æœ€å°åŒ–æ—¶æ˜¾ç¤º) */
        .music-float-btn {
            touch-action: none;
            position: absolute;
            transition: none !important; top:100px; right: 10px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            z-index: 200; cursor: pointer; overflow: hidden;
            animation: spin 10s linear infinite; /* é»˜è®¤æ—‹è½¬ */
            animation-play-state: paused;
            display: none; /* é»˜è®¤éšè—ï¼Œå¯¼å…¥æ­Œæ›²åæ˜¾ç¤º */
        }
        .music-float-btn:active {
    transform: scale(1.1);
}
        .music-float-btn.playing { animation-play-state: running; }
        .music-float-btn img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

        /* æ’­æ”¾å™¨é®ç½©å±‚ (ç»ˆæä¿®å¤ç‰ˆï¼šå½»åº•è§£å†³é»‘å±å¡æ­») */
        .music-player-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #333; z-index: 300;
            display: none; flex-direction: column;
            
            /* é»˜è®¤çŠ¶æ€ï¼šå®Œå…¨éšè— */
            transform: translateY(110%); /* ç§»å¾—æ›´è¿œä¸€ç‚¹ï¼Œç¡®ä¿ä¸å‡ºé•œ */
            opacity: 0; 
            pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
            visibility: hidden;   /* ğŸ‘ˆ æ ¸å¿ƒä¿®å¤ï¼šè®©æµè§ˆå™¨å½»åº•åœæ­¢æ¸²æŸ“å®ƒ */

            /* è¿‡æ¸¡åŠ¨ç”» */
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s, visibility 0.3s;
        }

        .music-player-overlay.show { 
            /* æ˜¾ç¤ºçŠ¶æ€ */
            transform: translateY(0); 
            opacity: 1; 
            pointer-events: auto; /* æ¢å¤ç‚¹å‡» */
            visibility: visible;  /* ğŸ‘ˆ æ ¸å¿ƒä¿®å¤ï¼šå‘Šè¯‰æµè§ˆå™¨è¯¥å¹²æ´»äº† */
        }

        /* åŠ¨æ€æ¨¡ç³ŠèƒŒæ™¯ */
        .music-bg-blur {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(30px) brightness(0.6); transform: scale(1.2);
            z-index: 0; transition: background-image 0.5s;
        }

        /* æ’­æ”¾å™¨å†…å®¹åŒº */
        .music-content { position: relative; z-index: 1; flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }

        /* é¡¶éƒ¨æ  */
        .music-header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; color: #fff; font-size: 24px;
        }
        
        /* åŒå¤´åƒäº’åŠ¨åŒº */
        .music-avatars {
            display: flex; align-items: center; gap: 15px; margin-bottom: 20px;
        }
        .m-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); object-fit: cover;}
        /* è¿æ¥çº¿åŠ¨ç”» */
        .m-connect-line {
            flex: 1; height: 2px; background: rgba(255,255,255,0.3); width: 60px; position: relative;
        }
        .m-connect-line::after {
            content: ''; position: absolute; top: -4px; left: 0; width: 10px; height: 10px;
            background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff;
            animation: connectMove 2s infinite ease-in-out;
        }
        @keyframes connectMove { 0% { left: 0; opacity: 0;} 50% { opacity: 1; } 100% { left: 100%; opacity: 0;} }

        /* é»‘èƒ¶å”±ç‰‡åŒº */
        .vinyl-wrapper {
            width: 280px; height: 280px; border-radius: 50%;
            background: #000;
            border: 5px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            animation: spin 20s linear infinite;
            animation-play-state: paused;
            margin-top: 20px; cursor: pointer;
        }
        .vinyl-wrapper.playing { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .vinyl-cover { width: 190px; height: 190px; border-radius: 50%; object-fit: cover; border: 4px solid #111; }

        /* æ­Œè¯åŒº (é»˜è®¤éšè—ï¼Œç‚¹å‡»åˆ‡æ¢) */
        .lyrics-container {
            position: absolute; top: 120px; width: 100%; bottom: 180px;
            padding: 20px 40px; overflow-y: auto; text-align: center;
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
            display: none; scroll-behavior: smooth;
        }
        .lyrics-container.active { display: block; }
        .lrc-line { 
            padding: 10px 0; font-size: 16px; color: rgba(255,255,255,0.5); transition: 0.3s; cursor: pointer;
            min-height: 20px;
        }
        .lrc-line.highlight { color: #fff; font-size: 20px; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.5); transform: scale(1.05); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .music-controls {
            width: 100%; padding: 20px 30px; padding-bottom: 50px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            position: absolute; bottom: 0;
            display: flex; flex-direction: column; gap: 15px;
        }
        .music-info-text { text-align: center; color: #fff; }
        .m-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .m-artist { font-size: 14px; color: rgba(255,255,255,0.7); }
        
        .progress-bar-box { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.6); font-size: 12px; }
        .progress-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; overflow: hidden;}
        .progress-fill { width: 0%; height: 100%; background: #fff; border-radius: 2px; }

        .btn-row { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .m-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        .m-btn-play { font-size: 50px; }
        .m-btn-import { font-size: 20px; border: 1px solid rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 20px; }

        /* å¯¼å…¥å¼¹çª—ç‰¹åˆ«æ ·å¼ */
        .import-area { display: flex; flex-direction: column; gap: 10px; }
        .import-area textarea { height: 100px; font-size: 12px; white-space: pre; }
        /* ============ æ’­æ”¾åˆ—è¡¨ (Playlist) æ ·å¼ ============ */
        .playlist-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 400; /* æ¯”æ’­æ”¾å™¨å±‚çº§æ›´é«˜ */
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .playlist-drawer.show { transform: translateY(0); }

        .playlist-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); color: #fff;
        }
        .btn-add-song { font-size: 24px; color: #fff; background: none; border: none; cursor: pointer; }

        .playlist-scroll { flex: 1; overflow-y: auto; padding: 10px 0; }
        
        .playlist-item {
            display: flex; align-items: center; padding: 10px 20px; gap: 12px;
            cursor: pointer; transition: background 0.2s; position: relative;
        }
        .playlist-item:active { background: rgba(255,255,255,0.1); }
        .playlist-item.active { color: #007AFF; }
        .playlist-item.active .song-name { color: #007AFF; }

        .pl-idx { font-size: 14px; color: #666; width: 20px; text-align: center; }
        .playlist-item.active .pl-idx { display: none; }
        /* æ’­æ”¾ä¸­çš„åŠ¨æ€å›¾æ ‡ */
        .pl-playing-icon { display: none; width: 12px; height: 12px; background: #007AFF; border-radius: 50%; } 
        .playlist-item.active .pl-playing-icon { display: block; }

        .pl-info { flex: 1; min-width: 0; }
        .song-name { font-size: 16px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { font-size: 12px; color: #888; margin-top: 3px; }
        
        .btn-del-song {
            color: #666; font-size: 18px; padding: 5px; background: none; border: none;
        }
        /* --- æ—¥è®°æ˜Ÿæ˜Ÿæ”¶è—æŒ‰é’® --- */
.diary-star {
    position: absolute;
    top: 10px;
    right: 40px; /* æ”¾åœ¨åˆ é™¤æŒ‰é’®å·¦è¾¹ */
    font-size: 20px;
    cursor: pointer;
    color: #e5e5ea; /* é»˜è®¤ç°è‰²ï¼ˆç©ºå¿ƒæ•ˆæœç”¨é¢œè‰²æ¨¡æ‹Ÿï¼Œæˆ–è€…ç›´æ¥ç”¨å­—ç¬¦åŒºåˆ«ï¼‰ */
    transition: color 0.2s, transform 0.2s;
    z-index: 10;
}
.diary-star.active {
    color: #ffcc00; /* é€‰ä¸­å˜é»„ */
    transform: scale(1.2); /* ç¨å¾®å˜å¤§ä¸€ç‚¹ */
    text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
}
.diary-star:active {
    transform: scale(0.9);
}
        /* --- è®°è´¦æœ¬ä¸“å±æ ·å¼ --- */
.wallet-card-summary {
    background: linear-gradient(135deg, #34c759, #248a3d);
    color: #fff;
    margin: 20px;
    padding: 25px;
    border-radius: 20px;
    box-shadow: 0 10px 20px rgba(52, 199, 89, 0.3);
}
.w-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
.w-balance { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
.w-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
.w-sub-label { font-size: 12px; opacity: 0.7; }
.w-num { font-size: 18px; font-weight: 600; }
/* è¿›åº¦æ¡ */
.w-progress-bg { background: rgba(0,0,0,0.2); height: 6px; border-radius: 3px; overflow: hidden; }
.w-progress-fill { background: #fff; height: 100%; width: 0%; transition: width 0.5s; border-radius: 3px; }

/* è´¦å•åˆ—è¡¨é¡¹ */
.bill-item {
    background: #fff;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    display: flex; align-items: center; justify-content: space-between;
}
.bill-item:last-child { border-bottom: none; }
.bill-icon {
    width: 40px; height: 40px; background: #f2f2f7; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px;
}
.bill-info { flex: 1; }
.bill-title { font-size: 16px; font-weight: 500; color: #000; }
.bill-time { font-size: 12px; color: #999; margin-top: 2px; }
.bill-amount { font-size: 18px; font-weight: bold; color: #000; }
.btn-del-bill { color: #ff3b30; margin-left: 10px; cursor: pointer; padding: 5px; font-size: 18px; }
        /* --- TTS æ’­æ”¾æŒ‰é’®æ ·å¼ --- */
.tts-btn-container {
    display: inline-flex;
    align-items: center;
    margin-left: 8px;
    vertical-align: middle;
}

.btn-tts-play {
    width: 16px;
    height: 16px;
    cursor: pointer;
    fill: #999; /* é»˜è®¤ç°è‰²ï¼Œä½è°ƒ */
    transition: all 0.2s ease;
    opacity: 0.7;
}

.btn-tts-play:hover {
    fill: #007AFF; /* æ‚¬åœå˜è“ */
    opacity: 1;
    transform: scale(1.1);
}

.btn-tts-play:active {
    transform: scale(0.9);
}

/* åŠ è½½ä¸­çš„æ—‹è½¬åŠ¨ç”» */
.btn-tts-play.loading {
    fill: #007AFF;
    animation: spin 1s linear infinite;
    pointer-events: none; /* åŠ è½½æ—¶ä¸è®¸ä¹±ç‚¹ */
}

/* æ­£åœ¨æ’­æ”¾æ—¶çš„è·³åŠ¨æ•ˆæœ */
.btn-tts-play.playing {
    fill: #34c759; /* æ’­æ”¾å˜ç»¿ */
}
        /* --- ä¿®æ”¹åçš„å·¥å…·æ æ ·å¼ (ä»¿è¾“å…¥æ³•å·¥å…·æ ) --- */
.chat-toolbar {
    display: flex;
    align-items: center;
    gap: 20px; /* å›¾æ ‡ä¹‹é—´çš„é—´è· */
    padding: 8px 15px;
    overflow-x: auto; /* å›¾æ ‡å¤ªå¤šæ—¶å…è®¸æ¨ªå‘æ»šåŠ¨ */
    background: rgba(255, 255, 255, 0.6); /* å¾®å¾®é€æ˜èƒŒæ™¯ */
    backdrop-filter: blur(5px);
    border-top: 1px solid rgba(0,0,0,0.05);
    /* éšè—æ»šåŠ¨æ¡ */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
.chat-toolbar::-webkit-scrollbar { display: none; }

.toolbar-btn {
    background: none;
    border: none;
    padding: 5px;
    font-size: 24px; /* å›¾æ ‡å¤§å°è°ƒæ•´ */
    color: #ff8da1; /* å›¾ç‰‡é‡Œçš„ç²‰è‰²é£æ ¼ */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
    box-shadow: none; /* å»æ‰é˜´å½± */
    flex-shrink: 0;
    transition: transform 0.2s, background 0.2s;
}

.toolbar-btn:active {
    transform: scale(0.9);
    background: rgba(0,0,0,0.05);
}

/* --- å…¨å±é€šè¯ç•Œé¢ (ä¿®å¤æ»‘åŠ¨ç‰ˆ) --- */
        .call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: none; flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢ä¹±åŠ¨ */
        }
.call-bg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    filter: blur(30px) brightness(0.4); opacity: 0.6;
}
/* ä¿®å¤ call-contentï¼šç¡®ä¿å®ƒæ’‘æ»¡å±å¹•ï¼Œå¹¶é™åˆ¶é«˜åº¦ä»¥ä¾¿å†…éƒ¨æ»šåŠ¨ */
        .call-content {
            position: relative; z-index: 2; 
            flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
            height: 100%; /* å¼ºåˆ¶é«˜åº¦ */
            display: flex; flex-direction: column; align-items: center;
            padding-top: 15vh;
            overflow: hidden; /* å…³é”®ï¼šä¸è®©å¤´åƒæŠŠé¡µé¢æ’‘ç ´ */
        }
.call-status { color: #fff; font-size: 18px; margin-bottom: 30px; opacity: 0.8; font-weight: 300; }

/* å¤´åƒå‘¼å¸ç¯ */
.call-avatar-container { position: relative; margin-bottom: 40px; transition: all 0.5s ease; }
.call-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.2); position: relative; z-index: 2; }
.call-ripple {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 120px; height: 120px; border-radius: 50%;
    background: rgba(255,255,255,0.1); z-index: 1;
    animation: ripple 2s infinite; display: none; /* é»˜è®¤éšè— */
}
.call-avatar-container.talking .call-ripple { display: block; } /* è¯´è¯æ—¶æ˜¾ç¤º */
@keyframes ripple {
    0% { width: 120px; height: 120px; opacity: 0.5; }
    100% { width: 200px; height: 200px; opacity: 0; }
}

/* æŒ‰é’®åŒº */
.call-actions {
    position: absolute; bottom: 10vh; width: 100%;
    display: flex; justify-content: space-around; padding: 0 50px;
}
.call-btn {
    width: 70px; height: 70px; border-radius: 50%; border: none;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: transform 0.2s;
}
.call-btn:active { transform: scale(0.9); }
.call-btn.decline { background: #ff3b30; }
.call-btn.accept { background: #34c759; }
.call-btn.small { width: 50px; height: 50px; }

/* æ¥é€šåçš„å¸ƒå±€å˜åŒ– */
.call-overlay.active .call-content { padding-top: 60px; }
.call-overlay.active .call-avatar { width: 80px; height: 80px; }
.call-overlay.active .call-status { font-size: 14px; margin-bottom: 20px; }

/* ä¿®å¤ call-chat-scrollï¼šå¢åŠ åº•éƒ¨ç©ºé—´ï¼Œå¼€å¯è§¦æ‘¸æ»šåŠ¨ */
        .call-chat-scroll {
            flex: 1;           /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
            width: 100%; 
            padding: 20px; 
            
            /* å…³é”®ä¿®æ”¹ï¼šåº•éƒ¨åŠ å¾ˆå¤§ä¸€å—å†…è¾¹è·ï¼Œç»™è¾“å…¥æ¡†ç•™ä½ç½® */
            padding-bottom: 120px; 
            
            overflow-y: auto;  /* å…è®¸å‚ç›´æ»šåŠ¨ */
            
            display: flex; flex-direction: column; gap: 15px;
            
            /* iOS æƒ¯æ€§æ»šåŠ¨æ”¯æŒï¼Œæ»‘åŠ¨æ›´æœ‰æ‰‹æ„Ÿ */
            -webkit-overflow-scrolling: touch; 
            
            /* é¡¶éƒ¨æ¸å˜é®ç½©ï¼Œä¿æŒç¾è§‚ */
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        }
.call-msg-row { color: white; font-size: 16px; line-height: 1.5; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
.call-msg-row.ai { text-align: left; color: rgba(255,255,255,0.9); }
.call-msg-row.user { text-align: right; color: rgba(255,255,255,0.6); font-size: 14px; }
.call-translate { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 4px; display: block; }

/* åº•éƒ¨è¾“å…¥æ¡† */
/* ç¡®ä¿åº•éƒ¨è¾“å…¥æ¡†å±‚çº§åœ¨æ–‡å­—ä¹‹ä¸Šï¼Œä¸”ä¸è¢«é®æŒ¡ */
        .call-actions-active {
            position: absolute; bottom: 0; width: 100%;
            padding: 15px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.6) 80%, transparent);
            display: flex; gap: 10px; align-items: center;
            z-index: 10; /* ä¿è¯åœ¨æ»šåŠ¨æ–‡å­—ä¸Šé¢ */
        }
.call-input-box {
    flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
    color: white; padding: 10px 15px; border-radius: 20px; backdrop-filter: blur(10px); outline: none;
}
        /* --- ä¹¦æ¶åˆ é™¤æ¨¡å¼ä¸“ç”¨æ ·å¼ --- */
.book-cover.shake {
    animation: bookShake 0.25s infinite linear;
    border: 2px solid #ff3b30; /* åˆ é™¤æ¨¡å¼ä¸‹åŠ ä¸ªçº¢æ¡†æç¤º */
}

.book-delete-badge {
    position: absolute;
    top: -8px;
    left: -8px;
    width: 24px;
    height: 24px;
    background: #ff3b30;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 10;
}

@keyframes bookShake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(1deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-1deg); }
    100% { transform: rotate(0deg); }
}
        /* --- åŒäººè®ºå› (Fanfic Forum) --- */
#page-forum { background: #f5f5f5; }
.forum-feed { padding: 15px; padding-bottom: 80px; }
.forum-card {
    background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s;
}
.forum-card:active { transform: scale(0.98); }
.forum-title { font-size: 17px; font-weight: bold; margin-bottom: 5px; color: #333; }
.forum-meta { font-size: 12px; color: #999; display: flex; gap: 10px; margin-bottom: 8px; }
.forum-tag { background: #f0f0f5; color: #5856d6; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
.forum-preview { font-size: 14px; color: #666; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }

/* åˆ›ä½œæ‚¬æµ®æŒ‰é’® */
.btn-fab-write {
    position: absolute; bottom: 30px; right: 20px;
    width: 56px; height: 56px; border-radius: 50%;
    background: #ff2d55; color: white; font-size: 24px;
    border: none; box-shadow: 0 4px 12px rgba(255, 45, 85, 0.4);
    display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
}

/* å¸–å­è¯¦æƒ…é¡µ */
.post-detail-content { font-size: 16px; line-height: 1.8; color: #333; white-space: pre-wrap; margin-bottom: 20px; }
.post-comment-section { border-top: 1px solid #eee; padding-top: 15px; margin-top: 20px; }
.post-comment-item { display: flex; gap: 10px; margin-bottom: 15px; font-size: 13px; }
.post-cmt-avatar { width: 32px; height: 32px; border-radius: 50%; background: #eee; flex-shrink: 0; }
.post-cmt-box { flex: 1; }
.post-cmt-user { font-weight: bold; color: #555; margin-bottom: 2px; }
.post-cmt-text { color: #333; line-height: 1.4; }

/* --- èŠå¤©ä¸­çš„â€œåˆ†äº«å¡ç‰‡â€æ ·å¼ --- */
.msg-link-card {
    background: #f2f2f7; border-radius: 12px; overflow: hidden;
    margin-top: 5px; border: 1px solid rgba(0,0,0,0.05); cursor: pointer;
    max-width: 260px;
}
.link-card-cover {
    height: 80px; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
    display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 24px;
}
.link-card-info { padding: 10px; }
.link-card-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; color: #000; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;}
.link-card-desc { font-size: 12px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.link-card-footer { font-size: 10px; color: #999; margin-top: 5px; display: flex; justify-content: space-between; align-items: center;}
        /* Google Key åˆ—è¡¨æ ·å¼ */
.key-tag-item {
    display: flex; align-items: center; justify-content: space-between;
    background: #fff; padding: 8px 12px; border-radius: 8px;
    border: 1px solid #ddd; font-size: 13px;
}
.key-status { font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-left: 5px;}
.key-status.valid { background: #e6ffec; color: #28a745; border: 1px solid #28a745;}
.key-status.invalid { background: #ffe6e6; color: #dc3545; border: 1px solid #dc3545;}
.key-status.checking { background: #e6f7ff; color: #007bff; }
.btn-del-key { color: #999; cursor: pointer; padding: 5px; font-weight: bold; font-size: 16px; margin-left: 10px;}
.btn-del-key:hover { color: #ff3b30; }
        /* --- é£è¡Œæ£‹ä¸“å±æ ·å¼ --- */
.ludo-board-container {
    height: 55%; /* ä¸ŠåŠå± */
    background: #fff5f7;
    display: flex; flex-direction: column;
    padding: 10px;
    border-bottom: 2px dashed #ffccd5;
    overflow: hidden;
}

/* åœæœºåª */
.ludo-base {
    height: 70px; display: flex; justify-content: center; align-items: center; gap: 30px;
    margin-bottom: 10px;
}
.ludo-base-spot {
    width: 60px; height: 60px; border-radius: 50%;
    border: 3px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; font-size: 10px; color: #999;
}
.ludo-base-spot.active { border-color: #ff6b81; background: rgba(255,107,129,0.1); }
.ludo-vs { font-weight: bold; color: #ffccd5; font-style: italic; }

/* æ£‹ç›˜ç½‘æ ¼ (Så‹å¸ƒå±€) */
.ludo-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4åˆ— */
    grid-template-rows: repeat(6, 1fr);    /* 6è¡Œ = 24æ ¼ */
    gap: 8px;
    padding: 5px;
}
.ludo-cell {
    background: #ffdde1; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; color: #fff; font-size: 14px;
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    position: relative;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,0.1);
}
.ludo-cell:nth-child(2n) { background: #ffc4cf; } /* æ ¼å­é¢œè‰²äº¤æ›¿ */
/* ç‰¹æ®Šæ ¼å­ï¼šç»ˆç‚¹ */
.ludo-cell.finish { background: linear-gradient(135deg, #f6d365, #fda085); font-size: 18px; }

/* æ£‹å­ */
.ludo-pawn {
    width: 32px; height: 32px; border-radius: 50%;
    border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    position: absolute; z-index: 10;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹è·³åŠ¨ç”» */
    object-fit: cover;
}
.ludo-pawn.user { border-color: #007AFF; transform: scale(0.9); }
.ludo-pawn.ai { border-color: #ff2d55; transform: scale(0.9) translate(2px, -2px); } /* ç¨å¾®é”™å¼€ä¸€ç‚¹ï¼Œé˜²æ­¢å®Œå…¨é‡å  */

/* ä¸‹åŠéƒ¨åˆ†ï¼šæ§åˆ¶åŒº */
.ludo-control-panel {
    height: 45%; background: #fff;
    display: flex; flex-direction: column;
}
.ludo-log-area {
    flex: 1; overflow-y: auto; padding: 15px;
    background: #fafafa; font-size: 14px; line-height: 1.5;
}
.ludo-msg { margin-bottom: 8px; }
.ludo-msg.system { color: #888; font-style: italic; text-align: center; font-size: 12px; }
.ludo-msg.user { color: #007AFF; text-align: right; }
.ludo-msg.ai { color: #ff2d55; text-align: left; }
.ludo-msg.task { 
    background: #fff0f3; padding: 10px; border-radius: 8px; 
    border-left: 3px solid #ff6b81; color: #333; margin: 10px 0; font-weight: 500;
}

/* æ“ä½œæ  */
.ludo-action-bar {
    height: 70px; display: flex; align-items: center; padding: 0 20px;
    border-top: 1px solid #eee; gap: 15px;
}
.ludo-status-text { flex: 1; font-weight: bold; color: #555; font-size: 14px; }
.ludo-btn-finish {
    background: #34c759; color: white; border: none; 
    padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 13px;
}

/* 3D éª°å­ */
.ludo-dice {
    width: 40px; height: 40px; position: relative;
    transform-style: preserve-3d; transition: transform 1s; cursor: pointer;
}
.dice-face {
    position: absolute; width: 40px; height: 40px;
    background: #fff; border: 1px solid #ddd; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 18px; color: #333;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}
.dice-face.front  { transform: translateZ(20px); }
.dice-face.back   { transform: rotateY(180deg) translateZ(20px); }
.dice-face.right  { transform: rotateY(90deg) translateZ(20px); }
.dice-face.left   { transform: rotateY(-90deg) translateZ(20px); }
.dice-face.top    { transform: rotateX(90deg) translateZ(20px); }
.dice-face.bottom { transform: rotateX(-90deg) translateZ(20px); }

/* éª°å­æ—‹è½¬åŠ¨ç”»ç±» */
.dice-rolling { animation: spinDice 0.5s infinite linear; }
@keyframes spinDice {
    0% { transform: rotateX(0) rotateY(0); }
    100% { transform: rotateX(360deg) rotateY(360deg); }
}
        /* ============ å‰§åœºæ¨¡å¼ä¸“å±æ ·å¼ ============ */

/* å¤´éƒ¨ */
/* ä¿®æ”¹åçš„å‰§åœºé¡¶éƒ¨æ  */
.theater-header {
    position: absolute;
    top: 0; left: 0; width: 100%; 
    height: 100px; /* ğŸ‘ˆ åŠ é«˜ï¼Œç»™åˆ˜æµ·ç•™ä½ç½® */
    padding-top: 50px; /* ğŸ‘ˆ æ ¸å¿ƒï¼šå†…å®¹ä¸‹ç§»ï¼Œé¿å¼€çŠ¶æ€æ  */
    padding-left: 20px; 
    padding-right: 20px;
    display: flex; justify-content: space-between; align-items: center;
    background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
    z-index: 50; /* æé«˜å±‚çº§ï¼Œç¡®ä¿èƒ½ç‚¹åˆ° */
}
.theater-title { font-family: 'Songti SC', serif; font-size: 18px; letter-spacing: 2px; text-shadow: 0 2px 4px black; }

/* èˆå° (æ­£æ–‡åŒº) */
.theater-stage {
    flex: 1; overflow-y: auto; 
    padding: 120px 25px 100px 25px; /* ä¸Šä¸‹ç•™ç™½å¤§ä¸€ç‚¹ */
    font-family: 'Songti SC', 'Georgia', serif; /* è¡¬çº¿ä½“ï¼Œæ›´æœ‰æ–‡å­¦æ„Ÿ */
    font-size: 17px;
    line-height: 1.8;
    color: #d0d0d0;
    scroll-behavior: smooth;
}

/* æ¶ˆæ¯å— - ä¸å†æ˜¯æ°”æ³¡ï¼Œè€Œæ˜¯æ®µè½ */
.t-msg-block {
    margin-bottom: 25px;
    opacity: 0; animation: fadeIn 0.5s forwards;
}
.t-role-label {
    font-size: 12px; color: #666; margin-bottom: 5px;
    letter-spacing: 1px; font-weight: bold;
}
.t-text {
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    text-align: justify;   /* ä¸¤ç«¯å¯¹é½ï¼Œåƒä¹¦ä¸€æ · */
}
.t-text.user { color: #888; border-left: 2px solid #444; padding-left: 10px; } /* ç”¨æˆ·çš„è¯ç¨å¾®ç°ä¸€ç‚¹ï¼ŒåŠ ä¸ªå¼•ç”¨çº¿ */
.t-text.ai { color: #e0e0e0; }

/* åº•éƒ¨è¾“å…¥æ  */
.theater-input-area {
    position: absolute; bottom: 0; width: 100%;
    background: #111; border-top: 1px solid #333;
    padding: 15px; display: flex; align-items: flex-end; gap: 10px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
}
#theater-input {
    flex: 1; background: #222; border: 1px solid #444; color: #fff;
    border-radius: 8px; padding: 10px; font-size: 16px;
    resize: none; outline: none; max-height: 120px;
    font-family: sans-serif; /* è¾“å…¥æ¡†è¿˜æ˜¯ç”¨é»‘ä½“çœ‹æ¸…æ¥šç‚¹ */
}
.theater-send-btn {
    background: #007AFF; color: #fff; border: none; width: 40px; height: 40px;
    border-radius: 50%; font-size: 18px; cursor: pointer; flex-shrink: 0;
}

/* å¯¼æ¼”æ§åˆ¶å°æ ·å¼ */
.theater-tabs {
    display: flex; border-bottom: 1px solid #444; background: #1a1a1a;
}
.t-tab {
    flex: 1; text-align: center; padding: 12px; font-size: 14px; color: #888; cursor: pointer;
}
.t-tab.active { color: #fff; border-bottom: 2px solid #007AFF; }
.t-tab-content { display: none; padding-top: 10px; }

.t-input {
    width: 100%; background: #333; border: 1px solid #444; 
    color: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px;
}
.t-group-title { font-size: 12px; color: #007AFF; margin: 15px 0 5px; text-transform: uppercase; letter-spacing: 1px;}
.t-tip { font-size: 10px; color: #666; }

.t-upload-box {
    border: 2px dashed #444; border-radius: 8px; padding: 20px;
    text-align: center; color: #888; cursor: pointer; transition: 0.2s;
}
.t-upload-box:active { background: #333; }

/* å¼€å…³åˆ—è¡¨ */
.t-item-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px; border-bottom: 1px solid #333;
}
.t-item-name { font-size: 14px; color: #ccc; }
.t-radio-check { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #666; }
.t-item-row.active .t-radio-check { background: #007AFF; border-color: #007AFF; }
.t-item-row.active .t-item-name { color: #fff; font-weight: bold; }

@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        /* --- å‰§æœ¬åˆ—è¡¨æ ·å¼ (ä»¿æˆªå›¾) --- */
.script-item {
    display: flex;
    padding: 15px;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
    height: 90px; /* å›ºå®šé«˜åº¦ï¼Œä¿æŒæ•´é½ */
}
.script-item:active {
    background: #fafafa;
}

.script-avatar-box {
    position: relative;
    margin-right: 12px;
}
.script-avatar {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(0,0,0,0.1);
}

.script-info {
    flex: 1;
    min-width: 0; /* é˜²æ­¢æ–‡æœ¬æº¢å‡º */
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.script-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
}

.script-title {
    font-size: 16px;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
    font-family: 'Songti SC', serif; /* æ ‡é¢˜ç”¨å®‹ä½“æ›´æœ‰å‰§åœºæ„Ÿ */
}

.script-time {
    font-size: 12px;
    color: #999;
    font-family: sans-serif;
}

.script-preview {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æ˜¾ç¤ºä¸¤è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
    font-family: 'UserCustomFont', sans-serif;
}

/* åˆ é™¤æŒ‰é’® (æ»‘åŠ¨æˆ–é•¿æŒ‰æ˜¾ç¤ºï¼Œè¿™é‡Œç®€åŒ–ä¸ºç»å¯¹å®šä½çš„çº¢å‰) */
.btn-del-script {
    position: absolute;
    right: 5px;
    bottom: 5px;
    padding: 10px;
    color: #ccc;
    font-size: 18px;
    background: none;
    border: none;
}
.btn-del-script:hover { color: #ff3b30; }
        /* --- å‰§åœºæ¨¡å¼ï¼šå‰§æƒ…æ€»ç»“å¡ç‰‡æ ·å¼ --- */
.t-msg-block.system {
    text-align: center;
    margin: 30px 0;
    opacity: 0.9;
}

.t-system-card {
    display: inline-block;
    background: rgba(255, 255, 255, 0.08); /* æ·±è‰²èƒŒæ™¯ä¸‹çš„å¾®é€ç™½ */
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 15px 20px;
    text-align: left;
    max-width: 90%;
    color: #a0a0a0;
    font-size: 14px;
    font-family: sans-serif; /* ç”¨é»‘ä½“æ˜¾å¾—æ›´åƒç³»ç»Ÿæ–‡å­— */
    line-height: 1.6;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.t-system-header {
    color: #FF9500; /* æ©™è‰²æ ‡é¢˜ */
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 8px;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
}

.t-system-header::before {
    content: 'ğŸ’¾';
}
        /* å‰§åœºæ¨¡å¼ - æ¥¼å±‚å·æ ·å¼ */
.t-floor-tag {
    position: absolute;
    left: -25px; /* æ”¾åœ¨æ°”æ³¡å·¦ä¾§å¤–é¢ */
    top: 0;
    font-size: 10px;
    color: #555;
    font-family: monospace;
    opacity: 0.5;
}
/* ç»™æ¶ˆæ¯å—åŠ ç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æ”¾æ¥¼å±‚å· */
.t-msg-block {
    position: relative; 
    margin-left: 10px; /* ç»™å·¦è¾¹ç•™ç‚¹ç©ºæ”¾æ¥¼å±‚å· */
}

/* æ¡£æ¡ˆåˆ—è¡¨æ ·å¼ */
.archive-card {
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}
.archive-header {
    display: flex; justify-content: space-between;
    font-size: 12px; color: #FF9500; font-weight: bold; margin-bottom: 5px;
}
.archive-body {
    font-size: 13px; color: #ccc; line-height: 1.5;
    max-height: 80px; overflow: hidden; text-overflow: ellipsis;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
}
        /* å‰§åœºæ¨¡å¼ - é‡åˆ·æŒ‰é’® */
.theater-reroll-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid #444;
    background: #2a2a2a;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤æ‰ */
    transition: transform 0.2s, background 0.2s;
}

.theater-reroll-btn:active {
    transform: rotate(-180deg) scale(0.9); /* ç‚¹å‡»æ—¶æ—‹è½¬ä¸€ä¸‹ */
    background: #444;
}
        /* --- ç›¸å†Œç½‘æ ¼ --- */
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding: 2px;
}
.gallery-item {
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* æ­£æ–¹å½¢ */
    background: #eee;
    overflow: hidden;
    cursor: pointer;
}
.gallery-thumb {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
}
.gallery-item:active .gallery-thumb { transform: scale(0.95); opacity: 0.8; }

/* --- è¯¦æƒ…é¡µ (ç¿»è½¬å¡ç‰‡æ•ˆæœ) --- */
.gallery-detail-container {
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    background: #000;
}
.gallery-close-btn {
    position: absolute; top: 40px; right: 20px;
    color: white; font-size: 32px; background: none; border: none; cursor: pointer; z-index: 100;
}
.gallery-tip {
    position: absolute; bottom: 40px; color: rgba(255,255,255,0.5); font-size: 13px;
}

/* 3D ç¿»è½¬å®¹å™¨ */
.photo-card-scene {
    width: 340px; height: 500px;
    perspective: 1000px;
    cursor: pointer;
}
.photo-card {
    width: 100%; height: 100%;
    position: relative;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}
.photo-card.is-flipped {
    transform: rotateY(180deg);
}
.photo-face {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
/* æ­£é¢ */
.photo-face.front {
    display: flex; flex-direction: column;
    background: #000;
}
.detail-img {
    width: 100%; flex: 1; object-fit: contain; background: #000;
}
.detail-caption-bar {
    padding: 15px; color: #fff; background: #111; font-size: 15px;
    min-height: 60px;
}
/* èƒŒé¢ (AI è¯„ä»·) */
.photo-face.back {
    transform: rotateY(180deg);
    background: #fdfdfd; /* æ‹ç«‹å¾—èƒŒé¢è´¨æ„Ÿ */
    padding: 20px;
    display: flex; flex-direction: column;
}
.ai-comment-box {
    flex: 1; display: flex; flex-direction: column;
}
.ai-comment-header {
    display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;
}
.ai-comment-text {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    font-family: 'Songti SC', serif;
    /* --- æ ¸å¿ƒä¿®å¤ --- */
    flex: 1;
    overflow-y: auto;          /* å…è®¸å‚ç›´æ»šåŠ¨ */
    width: 100%;               /* æ’‘æ»¡å®½åº¦ */
    white-space: pre-wrap;     /* ä¿ç•™ AI çš„æ¢è¡Œï¼Œä¸”è‡ªåŠ¨æŠ˜è¡Œ */
    word-wrap: break-word;     /* å¼ºåˆ¶é•¿å•è¯/é•¿å¥æ¢è¡Œ */
    word-break: break-all;     /* é˜²æ­¢ä¸­æ–‡æ ‡ç‚¹å¯¼è‡´çš„å¼‚å¸¸ç•™ç™½ */
    padding-right: 5px;        /* é˜²æ­¢æ»šåŠ¨æ¡é®æŒ¡æ–‡å­— */
}
.ai-tags-area {
    margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;
}
.ai-tag-chip {
    background: #f0f0f5; color: #5856d6; font-size: 11px; padding: 4px 8px; border-radius: 4px;
}
        /* --- ç›¸å†Œåˆ é™¤æŒ‰é’® --- */
.btn-del-photo {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    background: rgba(255, 59, 48, 0.1); /* æµ…çº¢è‰²èƒŒæ™¯ */
    color: #ff3b30;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
    z-index: 20; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
    transition: transform 0.2s;
}
.btn-del-photo:active {
    transform: scale(0.9);
    background: rgba(255, 59, 48, 0.2);
}
        /* --- ğŸ’– çºªå¿µæ—¥/å€’è®¡æ—¶å°ç»„ä»¶æ ·å¼ --- */
.anni-grid {
    display: flex; flex-direction: column; gap: 15px; padding: 10px;
}

/* å¡ç‰‡å®¹å™¨ */
.anni-card {
    background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%); /* æ‹çˆ±ç²‰ */
    border-radius: 20px;
    padding: 20px;
    color: #fff;
    position: relative;
    box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
    overflow: hidden;
    transition: transform 0.2s;
}
.anni-card:active { transform: scale(0.98); }

/* å¦‚æœæ˜¯æœªæ¥çš„æ—¥å­ï¼ˆå€’è®¡æ—¶ï¼‰ï¼Œæ¢ä¸ªé¢œè‰²æ¯”å¦‚è“è‰²æˆ–ç´«è‰² */
.anni-card.future {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
}

/* é¡¶éƒ¨ï¼šåŒå¤´åƒ + æ³¢æµªçº¿ */
.anni-header-row {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}
.anni-avatar {
    width: 50px; height: 50px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.6);
    object-fit: cover; background: #fff; cursor: pointer;
}

/* æ³¢æµªè¿æ¥çº¿ (å¤ç”¨éŸ³ä¹é‚£è¾¹çš„é€»è¾‘ï¼Œä½†è°ƒæ…¢ä¸€ç‚¹) */
.anni-wave-line {
    flex: 1; height: 4px; margin: 0 15px;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCA0IiBwcmVzZXJ2ZUFzcGVjdHJhdGlvPSJub25lIj48cGF0aCBkPSJNMCAyIEMgNSAwLCA1IDQsIDEwIDIgUyAxNSA0LCAyMCAyIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC42KSIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+');
    background-size: 20px 100%;
    animation: waveMove 4s linear infinite;
}
@keyframes waveMove { from { background-position: 0 0; } to { background-position: 40px 0; } }

/* æ–‡å­—åŒºåŸŸ */
.anni-info { text-align: center; z-index: 2; position: relative; }
.anni-title { font-size: 14px; opacity: 0.9; margin-bottom: 5px; font-weight: 500; letter-spacing: 1px; }
.anni-days-box { display: flex; align-items: baseline; justify-content: center; gap: 5px; }
.anni-num { font-size: 48px; font-weight: 800; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; }
.anni-label { font-size: 14px; font-weight: bold; opacity: 0.8; }
.anni-date { font-size: 12px; opacity: 0.6; margin-top: 5px; }

/* åˆ é™¤æŒ‰é’® */
.btn-del-anni {
    position: absolute; top: 10px; right: 10px;
    color: rgba(255,255,255,0.6); font-size: 20px; cursor: pointer;
}
        /* --- æ”¾æ˜ å®¤å¡ç‰‡æ“ä½œæŒ‰é’® --- */
.cinema-card-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
    z-index: 10;
}

.btn-cinema-action {
    width: 28px; 
    height: 28px;
    border-radius: 50%;
    border: none;
    display: flex; 
    align-items: center; 
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

/* ç¼–è¾‘æŒ‰é’® (ç¬”) - è“è‰² */
.btn-cinema-edit {
    background: rgba(255, 255, 255, 0.9);
    color: #007AFF;
}

/* åˆ é™¤æŒ‰é’® (å‰) - çº¢è‰² */
.btn-cinema-del {
    background: rgba(255, 59, 48, 0.9);
    color: #fff;
}
        /* --- ğŸ”® å‘½è¿å±‹ (Mystic Lab) æ ·å¼ --- */
.mystic-bg {
    background: linear-gradient(135deg, #2c003e 0%, #000000 100%);
    color: #e0d0ff;
}

/* é€‰é¡¹å¡ */
.mystic-tabs {
    display: flex; justify-content: center; gap: 20px; padding: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.mystic-tab-btn {
    background: none; border: none; color: #888; font-size: 16px; font-weight: bold; cursor: pointer; padding-bottom: 5px;
}
.mystic-tab-btn.active {
    color: #d4a373; border-bottom: 2px solid #d4a373;
}

/* å¡”ç½—åŒºåŸŸ */
.tarot-table {
    display: flex; flex-direction: column; align-items: center; padding: 20px;
}
.tarot-question-input {
    width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;
}
.tarot-deck-area {
    display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; min-height: 160px;
}

/* å¡ç‰Œç¿»è½¬åŠ¨ç”»å®¹å™¨ */
.tarot-card-scene {
    width: 90px; height: 150px; perspective: 600px; cursor: pointer;
}
.tarot-card-inner {
    width: 100%; height: 100%; position: relative;
    transition: transform 0.6s; transform-style: preserve-3d;
}
.tarot-card-scene.flipped .tarot-card-inner {
    transform: rotateY(180deg);
}
.tarot-face {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.5);
}
.tarot-face.front {
    background: url('https://upload.wikimedia.org/wikipedia/en/3/30/Rider-Waite-Smith-Card-Back.jpg') center/cover;
    border: 2px solid #d4a373;
}
.tarot-face.back {
    background: #fff; transform: rotateY(180deg); display: flex; flex-direction: column;
}
.tarot-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
.tarot-label {
    position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8);
    color: #fff; font-size: 10px; text-align: center; padding: 2px 0;
}

/* æ˜Ÿåº§åŒºåŸŸ */
.zodiac-container {
    padding: 30px 20px; display: flex; flex-direction: column; gap: 20px;
}
.zodiac-row {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;
}
.zodiac-select {
    background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #555;
    padding: 5px 10px; border-radius: 6px; font-size: 14px;
}
.mystic-btn-main {
    width: 100%; padding: 15px; margin-top: 20px;
    background: linear-gradient(to right, #9b59b6, #8e44ad);
    color: white; font-weight: bold; border: none; border-radius: 12px; font-size: 16px;
    box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); cursor: pointer;
}
.mystic-desc { font-size: 12px; color: rgba(255,255,255,0.5); text-align: center; margin-top: 10px; }
        /* AI å°è¯´å¤§çº²å¡ç‰‡æ ·å¼ */
.outline-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}
.outline-card:active { transform: scale(0.98); }
.outline-card.selected { border: 2px solid #007AFF; background: #f0f8ff; }

/* æ¨¡æ‹Ÿä¹¦ç±å°é¢å·¦ä¾§è‰²æ¡ */
.outline-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: linear-gradient(to bottom, #FF9A9E, #FECFEF);
}

.outline-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
.outline-tag { font-size: 10px; color: #fff; background: #FF9500; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
.outline-desc { font-size: 13px; color: #666; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
.outline-btn { 
    margin-top: 10px; width: 100%; padding: 8px; 
    background: #007AFF; color: #fff; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; 
}

/* é˜…è¯»å™¨ç¼–è¾‘æ¨¡å¼é«˜äº® */
#reader-content[contenteditable="true"] {
    background: rgba(255,255,255,0.5);
    outline: 2px dashed #007AFF;
    padding: 10px;
}
        /* --- ä¿®å¤ç‰ˆï¼šåˆ›ä½œæ‚¬æµ®çƒ (æ¨ç‰¹é£æ ¼) --- */
.writer-fab {
    position: absolute; 
    bottom: 40px; /* è·ç¦»åº•éƒ¨ 40pxï¼Œé¿å¼€ iOS åº•éƒ¨æ¨ªæ¡ */
    right: 25px;  /* è·ç¦»å³è¾¹ 25px */
    width: 56px; 
    height: 56px;
    /* èƒŒæ™¯è‰²ï¼šä¿ç•™ä½ çš„ç²‰è‰²ç³»ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹æˆ #1d9bf0 (æ¨ç‰¹è“) */
    background: linear-gradient(135deg, #FF9A9E, #FECFEF); 
    border-radius: 50%;
    display: flex; 
    justify-content: center; 
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); /* åŠ æ·±é˜´å½±ï¼Œæ›´ç«‹ä½“ */
    cursor: pointer; 
    z-index: 200; /* å±‚çº§è®¾é«˜ä¸€ç‚¹ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
    border: none;
    transition: transform 0.2s;
    outline: none;
}

/* ç‚¹å‡»æ—¶çš„ç¼©æ”¾æ•ˆæœ */
.writer-fab:active { 
    transform: scale(0.9); 
}

/* ç¾½æ¯›ç¬”å›¾æ ‡æ ·å¼ */
.writer-fab-icon {
    width: 26px; 
    height: 26px; 
    fill: white; /* çº¯ç™½å›¾æ ‡ */
    margin-left: -2px; /* å¾®è°ƒä½ç½®è®©è§†è§‰å±…ä¸­ */
    margin-top: 2px;
}
        /* æ–°åŠ è¿™ä¸ªï¼šç»™æ­£æ–‡åº•éƒ¨ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢è¢«è¾“å…¥æ¡†æŒ¡ä½ */
#reader-content {
    padding-bottom: 160px !important;
}
        /* --- è¡¨æƒ…åŒ…ä¸“å±æ ·å¼ (ä¿®å¤ç‰ˆ) --- */
.sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.sticker-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 5px;
    border-radius: 8px;
    transition: background 0.2s;
    position: relative; /* å…³é”®ï¼šä¸ºäº†å®šä½é€‰ä¸­å‹¾é€‰æ¡† */
}
.sticker-item:active { background: rgba(0,0,0,0.05); transform: scale(0.95); }

/* é¢„è§ˆå›¾ */
.sticker-thumb {
    width: 60px;
    height: 60px;
    object-fit: contain; /* ä¿æŒæ¯”ä¾‹ï¼Œå®Œå…¨æ˜¾ç¤º */
    background: #f0f0f0; /* ç»™ä¸ªç°è‰²èƒŒæ™¯ï¼Œé˜²æ­¢é€æ˜å›¾çœ‹ä¸è§ */
    border-radius: 4px;
}

.sticker-name {
    font-size: 10px;
    color: #666;
    margin-top: 5px;
    text-align: center;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- æ ¸å¿ƒä¿®å¤ï¼šèŠå¤©æ¡†å†…çš„è¡¨æƒ…åŒ…å›¾ç‰‡ --- */
.chat-sticker-img {
    max-width: 150px;  /* é™åˆ¶æœ€å¤§å®½åº¦ */
    max-height: 150px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
    width: auto;       /* è‡ªåŠ¨å®½åº¦ */
    height: auto;      /* è‡ªåŠ¨é«˜åº¦ */
    border-radius: 8px;
    display: block;    /* å—çº§æ˜¾ç¤º */
    margin: 5px 0;
    cursor: pointer;   /* é¼ æ ‡å˜æ‰‹å‹ */
}

/* åˆ é™¤æ¨¡å¼æ ·å¼ */
.sticker-item.selected {
    background: #ffe5e5;
    border: 1px solid #ff3b30;
}
.sticker-check {
    position: absolute;
    top: 2px; right: 2px;
    background: #ff3b30; color: white;
    border-radius: 50%; width: 16px; height: 16px;
    font-size: 10px; display: none; align-items: center; justify-content: center;
}
.sticker-item.selected .sticker-check { display: flex; }

/* åº•éƒ¨æ  */
.sticker-footer-tabs { display: flex; border-top: 1px solid #eee; background: #f9f9f9; }
.sticker-tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; color: #007AFF; cursor: pointer; border-right: 1px solid #eee; font-weight: 500; }
.sticker-tab:last-child { border-right: none; }
.sticker-tab:active { background: #eee; }
.sticker-tab.danger { color: #ff3b30; }
    </style>
</head>
<body>

    <div class="phone-frame">
        
        

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="goHome()"></div>

        <!-- ============ 1. æ¡Œé¢ (Home) ============ -->
        <div class="page active" id="page-home">
    <!-- é¡¶éƒ¨ï¼šæ—¶é’Ÿ (ä¿æŒä¸å˜) -->
    <div class="home-clock-widget">
        <div class="clock-time" id="clockTime">12:00</div>
        <div class="clock-date" id="clockDate">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
    </div>
    
    <!-- é¡¶éƒ¨ï¼šå¤©æ°” (ä¿æŒä¸å˜) -->
    <div class="weather-widget" onclick="getWeather()">
        <div class="weather-bg-deco">ğŸŒ¤</div>
        <div class="weather-left">
            <div class="weather-temp" id="w-temp">--Â°</div>
            <div class="weather-desc" id="w-desc">ç‚¹å‡»è·å–å¤©æ°”</div>
            <div class="weather-range" id="w-wind">æ— éœ€å®‰è£…App</div>
        </div>
        <div class="weather-right">
            <div class="weather-icon" id="w-icon">ğŸ“</div>
            <div class="weather-loc" id="w-city">æœªå®šä½</div>
        </div>
    </div>

    <!-- æ»‘åŠ¨å®¹å™¨ (æ–°ç»“æ„) -->
    <div class="home-swiper-container" id="homeSwiper">
        <div class="home-swiper-wrapper" id="homeWrapper">
            
            <!-- === ç¬¬ä¸€é¡µ === -->
            <div class="home-slide">
                
                <!-- ç¬¬ä¸€è¡Œï¼šå·¦å¾…åŠï¼Œå³App -->
                <div class="mixed-row">
                    <!-- å·¦ï¼šå¾…åŠäº‹é¡¹å°ç»„ä»¶ -->
                    <div class="half-block widget-todo" onclick="addTodoItem()">
                        <div class="widget-title">
                            <span>ğŸ“ å¾…åŠäº‹é¡¹</span>
                            <span style="font-size:12px; opacity:0.7;">+</span>
                        </div>
                        <div class="todo-list-scroll" id="todo-widget-list">
                            <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                            <div style="opacity:0.6; margin-top:10px;">æš‚æ— äº‹é¡¹</div>
                        </div>
                    </div>

                    <!-- å³ï¼š2x2 APP -->
                    <div class="half-block mini-app-grid">
                        <div class="app-icon-container" onclick="navigateTo('page-msg-list')">
                            <div class="app-icon icon-msg" id="app-icon-msg">ğŸ’¬</div>
                            <div class="app-name">ä¿¡æ¯</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-memory')">
                            <div class="app-icon icon-note" id="app-icon-mem">ğŸ“</div>
                            <div class="app-name">è®°å¿†</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-settings')">
                            <div class="app-icon icon-settings" id="app-icon-set">âš™ï¸</div>
                            <div class="app-name">è®¾ç½®</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-theme')">
                            <div class="app-icon" id="app-icon-theme" style="background: linear-gradient(to bottom, #ff2d55, #ff375f);">ğŸ¨</div>
                            <div class="app-name">ç¾åŒ–</div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šå·¦Appï¼Œå³CD -->
                <div class="mixed-row">
                    <!-- å·¦ï¼š2x2 APP -->
                    <div class="half-block mini-app-grid">
                        <div class="app-icon-container" onclick="navigateTo('page-diary')">
                            <div class="app-icon" id="app-icon-diary" style="background: linear-gradient(to bottom, #d4a373, #a98467);">ğŸ“–</div>
                            <div class="app-name">æ—¥è®°</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-pomodoro'); initPomoPage();">
                            <div class="app-icon" id="app-icon-pomo" style="background: linear-gradient(to bottom, #ff6b6b, #ee5253);">ğŸ…</div>
                            <div class="app-name">ç•ªèŒ„é’Ÿ</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-calendar'); initCalendarPage();">
                            <div class="app-icon" id="app-icon-cal" style="background: #fff; color: #333;">ğŸ“…</div>
                            <div class="app-name">æ—¥å†</div>
                        </div>
                        <div class="app-icon-container" onclick="navigateTo('page-schedule'); renderScheduleList();">
                            <div class="app-icon" id="app-icon-sched" style="background: linear-gradient(to bottom, #5856d6, #af52de);">ğŸ“…</div>
                            <div class="app-name">æ—¥ç¨‹</div>
                        </div>
                    </div>

                    <!-- å³ï¼šCD å°ç»„ä»¶ -->
                    <div class="half-block widget-cd" onclick="changeCdCover()">
                        <div class="cd-disc" id="cd-disc-img" style="background-image: url('https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=300');"></div>
                        <div class="cd-center-hole"></div>
                    </div>
                </div>

            </div>

            <!-- === ç¬¬äºŒé¡µ === -->
            <div class="home-slide">
                <div class="page2-grid app-grid"> <!-- å¤ç”¨ app-grid æ ·å¼ä¿æŒä¸€è‡´ -->
                    
                    <!-- X -->
                    <div class="app-icon-container" onclick="navigateTo('page-x'); initXApp();">
                        <div class="app-icon" id="app-icon-x" style="background: #000; color: white;">ğ•</div>
                        <div class="app-name">X</div>
                    </div>
                    
                    <!-- å…±è¯» -->
                    <div class="app-icon-container" onclick="navigateTo('page-bookshelf'); loadLibrary();">
                        <div class="app-icon" id="app-icon-book" style="background: linear-gradient(to bottom, #a0522d, #cd853f);">ğŸ“š</div>
                        <div class="app-name">å…±è¯»</div>
                    </div>

                    <!-- è®°è´¦ -->
                    <div class="app-icon-container" onclick="navigateTo('page-wallet'); initWalletPage();">
                        <div class="app-icon" id="app-icon-wallet" style="background: linear-gradient(to bottom, #34c759, #28a745);">ğŸ’¸</div>
                        <div class="app-name">è®°è´¦æœ¬</div>
                    </div>

                    <!-- ç²®ä»“ -->
                    <div class="app-icon-container" onclick="navigateTo('page-forum'); renderForumFeed();">
                        <div class="app-icon" id="app-icon-forum" style="background: linear-gradient(to bottom, #ff2d55, #ff5e3a);">âœ’ï¸</div>
                        <div class="app-name">ç²®ä»“</div>
                    </div>

                    <!-- é£è¡Œæ£‹ -->
                    <div class="app-icon-container" onclick="openLudoSelectChar()">
                        <div class="app-icon" id="app-icon-ludo" style="background: linear-gradient(to bottom, #ff9a9e, #fad0c4);">ğŸ²</div>
                        <div class="app-name">é£è¡Œæ£‹</div>
                    </div>

                    <!-- å‰§åœº -->
                    <div class="app-icon-container" onclick="initTheaterMode()">
                        <div class="app-icon" id="app-icon-theater" style="background: linear-gradient(to bottom, #2b2b2b, #000000);">ğŸ­</div>
                        <div class="app-name">å‰§åœº</div>
                    </div>

                    <!-- ç›¸å†Œ -->
                    <div class="app-icon-container" onclick="navigateTo('page-gallery'); loadGalleryImages();">
                        <div class="app-icon" id="app-icon-gallery" style="background: linear-gradient(to bottom, #ff9500, #ff5e3a);">ğŸ–¼ï¸</div>
                        <div class="app-name">ç›¸å†Œ</div>
                    </div>

                    <!-- æ”¾æ˜ å®¤ -->
                    <div class="app-icon-container" onclick="initCinemaApp()">
                        <div class="app-icon" id="app-icon-cinema" style="background: linear-gradient(to bottom, #000000, #434343);">ğŸ¬</div>
                        <div class="app-name">æ”¾æ˜ å®¤</div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- åº•éƒ¨ç¿»é¡µç‚¹ -->
    <div class="pagination-dots">
        <div class="page-dot active" id="dot-0"></div>
        <div class="page-dot" id="dot-1"></div>
    </div>
</div>

        <!-- ============ 2. æ¶ˆæ¯åˆ—è¡¨ (è”ç³»äºº) ============ -->
        <div class="page" id="page-msg-list">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()"><span>â€¹</span> æ¡Œé¢</button>
                <span class="app-title">ä¿¡æ¯</span>
                <button class="btn-icon-only" onclick="openModal('modal-add-char')" title="æ·»åŠ è§’è‰²" style="font-size: 26px;">+</button>
            </div>
            <div class="msg-list-scroll" id="contactListContainer">
                <!-- åŠ¨æ€åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ============ 3. èŠå¤©çª—å£ ============ -->
        <div class="page" id="page-chat">
            <div class="chat-header-bar">
                <button class="chat-back-btn" onclick="navigateTo('page-msg-list')">
                    <span style="font-size:24px; margin-right:5px;">â€¹</span> ä¿¡æ¯
                </button>
                <span class="chat-contact-name" id="chat-title-name">AI</span>
                <div class="chat-header-actions">
                <button class="btn-icon-only" onclick="openChatSettings()" title="è§’è‰²è®¾ç½®" style="font-size: 20px;">âš™ï¸</button>
            </div>
            </div>

            <div class="chat-box" id="chatBox">
                <!-- æ¶ˆæ¯å†…å®¹ -->
            </div>

            <div class="input-area">
                <div class="chat-toolbar">
    <!-- é€šè¯ -->
    <button class="toolbar-btn" onclick="startFakeCallRequest()" title="é€šè¯">
        ğŸ“
    </button>
    <!-- ä¸€èµ·å¬ -->
    <button class="toolbar-btn" onclick="openModal('modal-import-music')" title="ä¸€èµ·å¬">
        ğŸµ
    </button>
    <!-- æ€»ç»“ -->
    <button class="toolbar-btn" onclick="openSummaryModal()" title="æ€»ç»“">
        âœ¨
    </button>
                    <!-- åœ¨ .chat-toolbar é‡ŒåŠ å…¥è¿™ä¸ªæŒ‰é’® -->
<button class="toolbar-btn" onclick="openAnniversaryModal()" title="çºªå¿µæ—¥">
    ğŸ’
</button>
                    <!-- åŸæœ‰çš„æŒ‰é’®... -->
<button class="toolbar-btn" onclick="openMysticModal()" title="å‘½è¿å±‹">
    ğŸ”®
</button>
                    <!-- æ–°å¢ï¼šè¡¨æƒ…åŒ…æŒ‰é’® -->
<button class="toolbar-btn" onclick="openStickerModal()" title="è¡¨æƒ…åŒ…">
    ğŸ¤ª
</button>
</div>
           
                <div id="uploadPreview">
                    <img id="img-preview-blob" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                    <span>å·²é€‰æ‹©å›¾ç‰‡</span>
                    <span onclick="clearUpload()" style="color:red; margin-left:auto; cursor:pointer;">Ã—</span>
                </div>
                <div class="input-toolbar">
                    <button class="btn-send" onclick="document.getElementById('fileInput').click()" style="color:#888;">âŠ•</button>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
                    <input type="text" id="userInput" placeholder="iMessage" onkeypress="if(event.key==='Enter') sendMsg('user')">
                    <!-- æ”¹æˆç‚¹å‡»è°ƒç”¨ sendAndTrigger() -->
<button class="btn-send" onclick="sendAndTrigger()">â¬†</button>
                    <button class="btn-send" id="btn-ai" onclick="triggerAI()" style="color:#5856D6">ğŸ¤–</button>
                </div>
            </div>
        </div>

        <!-- ============ 4. è®°å¿†åº“ ============ -->
        <div class="page" id="page-memory">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®°å¿†åº“</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
                <div class="ios-group-title">å½“å‰é€‰ä¸­è§’è‰²çš„è®°å¿†</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <input type="text" id="newMemInput" class="ios-input" style="text-align:left;" placeholder="æ‰‹åŠ¨æ·»åŠ è®°å¿†...">
                        <button onclick="addMemoryManual()" style="border:none;background:none;color:#007AFF;font-weight:bold;">+</button>
                    </div>
                </div>
                <div id="memoryListContainer"></div>
            </div>
        </div>

        <!-- ============ 5. å…¨å±€è®¾ç½® ============ -->
        <div class="page" id="page-settings">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®¾ç½®</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <div class="ios-group-title">API è¿æ¥</div>
                <div class="ios-list">
                    <div class="ios-item">
        <span class="ios-label">ä¾›åº”å•†</span>
        <select id="apiProvider" class="ios-input" style="direction: rtl;" onchange="toggleApiProvider()">
            <option value="custom">è‡ªå®šä¹‰ (OpenAI/åä»£)</option>
            <option value="google">Google AI Studio</option>
        </select>
    </div>
                    <!-- âœ¨ æ–°å¢ï¼šè‡ªå®šä¹‰åä»£é¢„è®¾ç®¡ç†å™¨ (é»˜è®¤éšè—ï¼Œåˆ‡æ¢åˆ°è‡ªå®šä¹‰æ—¶æ˜¾ç¤º) -->
<div id="customPresetManager" style="display:none; background:#f9f9f9; border-bottom:1px solid #e5e5ea; margin-bottom:10px;">
    <div class="ios-item" style="border-bottom:none;">
        <span class="ios-label">é¢„è®¾</span>
        <select id="customPresetSelect" class="ios-input" style="direction: rtl; color:#007AFF; font-weight:bold;" onchange="applyCustomPreset()">
            <option value="">-- é€‰æ‹©é…ç½® --</option>
        </select>
    </div>
    <div style="display:flex; justify-content:space-between; padding:0 15px 10px 15px;">
        <button onclick="saveCurrentAsPreset()" style="font-size:13px; color:#007AFF; background:none; border:none; cursor:pointer;">å¦å­˜ä¸ºæ–°é¢„è®¾</button>
        <button onclick="deleteCustomPreset()" style="font-size:13px; color:#ff3b30; background:none; border:none; cursor:pointer;">åˆ é™¤è¯¥é¢„è®¾</button>
    </div>
</div>
<!-- âœ¨ æ–°å¢ç»“æŸ -->
                    <!-- === âœ¨ Google å¤š Key ç®¡ç†å™¨ (é»˜è®¤éšè—) âœ¨ === -->
                    <div id="googleKeyManager" style="display:none; background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #e5e5ea;">
    <div style="font-size:12px; color:#666; margin-bottom:5px;">Google Key é’¥åŒ™åŒ… (è‡ªåŠ¨è½®è¯¢)</div>
    
    <!-- æ·»åŠ è¾“å…¥æ¡† -->
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="password" id="newGoogleKeyInput" class="ios-input" placeholder="ç²˜è´´æ–°çš„ Key..." style="background:#fff; flex:1; font-size:14px;">
        <button onclick="addGoogleKey()" style="border:none; background:#007AFF; color:white; border-radius:8px; padding:0 12px; font-weight:bold;">æ·»åŠ </button>
    </div>

    <!-- Key åˆ—è¡¨å®¹å™¨ -->
    <div id="googleKeyList" style="display:flex; flex-direction:column; gap:8px;">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>


    <div class="ios-item" id="apiUrlContainer">
        <span class="ios-label">API URL</span>
        <input type="text" id="apiUrl" class="ios-input" placeholder="https://api.openai.com/v1" onchange="saveGlobalConfig()">
    </div>
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="apiKey" class="ios-input" placeholder="sk-..." onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="testConn()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div class="ios-group-title">æ¨¡å‹é…ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">Model ID</span>
                        <input type="text" id="modelId" class="ios-input" value="gpt-3.5-turbo" onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="fetchModels()">â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                    <!-- éšè—çš„ Selectï¼Œç”¨äºæ‹‰å–åé€‰æ‹© -->
                    <div class="ios-item" id="modelSelectContainer" style="display:none;">
                        <span class="ios-label">é€‰æ‹©</span>
                        <select id="modelSelect" class="ios-input" style="direction: rtl;" onchange="document.getElementById('modelId').value=this.value;saveGlobalConfig()">
                        </select>
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ¸©åº¦ (Temperature)</span>
                        <input type="number" id="tempVal" class="ios-input" value="0.7" step="0.1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†è½®æ•° (æ¡æ•°)</span>
                        <input type="number" id="historyLimit" class="ios-input" value="20" step="1" placeholder="é»˜è®¤20" onchange="saveGlobalConfig()">
                    </div>
                </div>
                <div class="ios-group-title">ä¸“å±è¯­éŸ³ (ElevenLabs)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="xiApiKey" class="ios-input" placeholder="ç²˜è´´ä½ çš„ xi-api-key" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">Voice ID</span>
                        <input type="text" id="xiVoiceId" class="ios-input" placeholder="ç²˜è´´ Voice ID" onchange="saveGlobalConfig()">
                    </div>
                    
                    <div class="ios-item">
                        <span class="ios-label">Model ID</span>
                        <input type="text" id="xiModelId" class="ios-input" placeholder="é»˜è®¤ eleven_multilingual_v2" onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="fetchElevenLabsModels()">â¬‡ï¸ æ‹‰å–å£°éŸ³æ¨¡å‹åˆ—è¡¨</button>
                    
                    <div class="ios-item" id="xiModelSelectContainer" style="display:none;">
                        <span class="ios-label">é€‰æ‹©æ¨¡å‹</span>
                        <select id="xiModelSelect" class="ios-input" style="direction: rtl;" onchange="document.getElementById('xiModelId').value=this.value; saveGlobalConfig()">
                        </select>
                    </div>
                    <button class="ios-btn" onclick="testVoiceConfig()">è¯•å¬é…ç½® (Test)</button>
                </div>

                <div class="ios-group-title">æ•°æ®ç®¡ç†</div>
<div class="ios-list">
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 1ï¼šå‡½æ•°æ”¹æˆ exportDataV2()ï¼Œæ–‡å­—ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹æç¤ºç”¨æˆ· -->
    <button class="ios-btn" onclick="exportDataV2()">å¤‡ä»½æ‰€æœ‰æ•°æ®</button>
    
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 2ï¼šID æ”¹æˆ importFileV2 -->
    <button class="ios-btn" onclick="document.getElementById('importFileV2').click()">æ¢å¤æ•°æ®</button>
    
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 3ï¼šID æ”¹æˆ importFileV2ï¼Œå‡½æ•°æ”¹æˆ importDataV2(event) -->
    <input type="file" id="importFileV2" hidden onchange="importDataV2(event)">
    
    <!-- è¿™ä¸ªä¸ç”¨åŠ¨ -->
    <button class="ios-btn danger" onclick="resetAll()">é‡ç½®åº”ç”¨ (æ¸…é™¤æ‰€æœ‰)</button>
</div>
            </div>
        </div>
        <!-- ============ 6. ç¾åŒ–ä¸­å¿ƒ (Theme) ============ -->
        <div class="page" id="page-theme">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç¾åŒ–ä¸­å¿ƒ</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <!-- æ¡Œé¢å£çº¸è®¾ç½® -->
                <div class="ios-group-title" style="margin-top:0;">æ¡Œé¢å£çº¸ (è¾“å…¥å›¾ç‰‡ URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å£çº¸ URL</span>
                        <input type="text" id="wallpaperInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div class="ios-group-title">APP å›¾æ ‡æ›¿æ¢ (è¾“å…¥å›¾ç‰‡URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¿¡æ¯å›¾æ ‡</span>
                        <input type="text" id="iconInput-msg" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†å›¾æ ‡</span>
                        <input type="text" id="iconInput-mem" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®¾ç½®å›¾æ ‡</span>
                        <input type="text" id="iconInput-set" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ç¾åŒ–å›¾æ ‡</span>
                        <input type="text" id="iconInput-theme" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ—¥è®°å›¾æ ‡</span>
                        <input type="text" id="iconInput-diary" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„æ—¥è®°å›¾æ ‡ä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">ç•ªèŒ„é’Ÿå›¾æ ‡</span>
                        <input type="text" id="iconInput-pomo" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„ç•ªèŒ„é’Ÿä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">æ—¥å†å›¾æ ‡</span>
                        <input type="text" id="iconInput-cal" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ—¥ç¨‹å›¾æ ‡</span>
                        <input type="text" id="iconInput-sched" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
    <span class="ios-label">å…±è¯»å›¾æ ‡</span>
    <input type="text" id="iconInput-book" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <!-- æ–°å¢ï¼šé£è¡Œæ£‹å›¾æ ‡è®¾ç½® -->
<div class="ios-item">
    <span class="ios-label">é£è¡Œæ£‹å›¾æ ‡</span>
    <input type="text" id="iconInput-ludo" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <!-- åŸæœ‰çš„å…±è¯»å›¾æ ‡è®¾ç½®åœ¨ä¸Šé¢ï¼ŒæŠŠä¸‹é¢è¿™æ®µåŠ åœ¨å®ƒåé¢ -->
<div class="ios-item">
    <span class="ios-label">è®°è´¦å›¾æ ‡</span>
    <input type="text" id="iconInput-wallet" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <!-- åœ¨ id="page-theme" é‡Œé¢çš„ input åˆ—è¡¨æœ€ååŠ å…¥è¿™ä¸ª -->
<div class="ios-item">
    <span class="ios-label">ç²®ä»“å›¾æ ‡</span>
    <input type="text" id="iconInput-forum" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <div class="ios-item">
    <span class="ios-label">å‰§åœºå›¾æ ‡</span>
    <input type="text" id="iconInput-theater" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <!-- åœ¨ page-theme çš„ .ios-list é‡Œæ·»åŠ è¿™ä¸€è¡Œ -->
<div class="ios-item">
    <span class="ios-label">ç›¸å†Œå›¾æ ‡</span>
    <input type="text" id="iconInput-gallery" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                    <div class="ios-item">
    <span class="ios-label">æ”¾æ˜ å®¤å›¾æ ‡</span>
    <input type="text" id="iconInput-cinema" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                </div>

                <div class="ios-group-title">å…¨å±€ CSS ä»£ç  (é«˜çº§ç¾åŒ–)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">åœ¨è¿™é‡Œè¾“å…¥ CSS å¯ä»¥æ›¿æ¢æŒ‰é’®ç´ æã€ä¿®æ”¹å­—ä½“ç­‰ã€‚</div>
                <div class="ios-list" style="height: 200px;">
                    <textarea id="customCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" placeholder=".btn-back { ... }" onchange="saveTheme()"></textarea>
                </div>
                <!-- æ°”æ³¡ç¾åŒ–åŒºåŸŸ (æ–°å¢) -->
                <div class="ios-group-title">æ°”æ³¡ç¾åŒ– (CSS)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">
                    å·¦è¾¹æ˜¯AI(.left)ï¼Œå³è¾¹æ˜¯ç”¨æˆ·(.right)ã€‚<br>
                    ä¾‹å¦‚: border-radius: 0;
                </div>
                <div class="ios-list" style="height: 150px;">
                    <textarea id="bubbleCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" 
                    placeholder="/* AI æ°”æ³¡ */
.msg-row.left .message { 
  background: #fff; 
}
/* ç”¨æˆ·æ°”æ³¡ */
.msg-row.right .message { 
  background: #007AFF; 
}" 
                    onchange="saveTheme()"></textarea>
                </div>
                <!-- å­—ä½“è®¾ç½®åŒºåŸŸ -->
                <div class="ios-group-title">å…¨å±€å­—ä½“ (è¾“å…¥ .ttf/.woff é“¾æ¥)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å­—ä½“ URL</span>
                        <input type="text" id="fontInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div style="text-align:center; padding:20px;">
                    <button class="ios-btn danger" style="border-radius:10px;" onclick="resetTheme()">é‡ç½®æ‰€æœ‰ç¾åŒ–</button>
                </div>
            </div>
        </div>
        <!-- ============ 7. æ—¥è®°æœ¬ (Diary) ============ -->
        <div class="page" id="page-diary">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">æ—¥è®°æœ¬</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
            
                <!-- æ—¥è®°åˆ—è¡¨å®¹å™¨ -->
                <div id="diaryListContainer"></div>
            </div>
        </div>
        <!-- ============ 8. ç•ªèŒ„é’Ÿ (Pomodoro) ============ -->
        <div class="page" id="page-pomodoro">
            <div class="app-header">
                <button class="btn-icon-text" onclick="quitPomo()">â€¹ ç»“æŸ</button>
                <span class="app-title">ä¸“æ³¨æ¨¡å¼</span>
                <span style="width:50px;"></span>
            </div>
            
            <!-- è®¾ç½®ç•Œé¢ -->
            <div id="pomo-setup" class="content-scroll">
                <div class="ios-group-title" style="margin-top:20px;">é™ªä¼´å¯¹è±¡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">é€‰æ‹©è§’è‰²</span>
                        <select id="pomoCharSelect" class="ios-input" style="direction: rtl;"></select>
                    </div>
                </div>

                <div class="ios-group-title">ä¸“æ³¨è®¾ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">æ—¶é•¿ (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoDuration" class="ios-input" value="25">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ä¸“æ³¨å†…å®¹</span>
                        <input type="text" id="pomoTask" class="ios-input" placeholder="ä¾‹å¦‚: èƒŒå•è¯ã€å†™ä»£ç ">
                    </div>
                </div>

                <div class="ios-group-title">AI äº’åŠ¨é¢‘ç‡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¸»åŠ¨å‘è¨€é—´éš” (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoInterval" class="ios-input" value="5" placeholder="0ä¸ºä¸ä¸»åŠ¨">
                    </div>
                </div>
                <div style="padding:20px; font-size:12px; color:#999; text-align:center;">
                    å¼€å§‹åï¼Œç‚¹å‡»è§’è‰²å¤´åƒå¯ä»¥â€œæˆ³ä¸€æˆ³â€ï¼ŒTaä¼šæ ¹æ®å‰©ä½™æ—¶é—´å›åº”ä½ ã€‚
                </div>
                <div style="padding:0 20px;">
                    <button class="ios-btn" style="background:#ff3b30; color:#fff; border-radius:12px; font-weight:bold;" onclick="startPomoTimer()">å¼€å§‹ä¸“æ³¨</button>
                </div>
            </div>

            <!-- è¿è¡Œæ—¶ç•Œé¢ (é»˜è®¤éšè—) -->
            <div id="pomo-running" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px; padding-bottom:100px;">
                
                <!-- å€’è®¡æ—¶å¤§å­— -->
                <div id="pomo-timer-display" style="font-size:64px; font-weight:200; font-variant-numeric: tabular-nums;">25:00</div>
                <div id="pomo-task-display" style="font-size:18px; color:#666; margin-bottom:40px;">æ­£åœ¨è¿›è¡Œ: ...</div>

                <!-- è§’è‰²äº’åŠ¨åŒº -->
                <div style="position:relative;">
                    <img id="pomo-avatar" src="" style="width:120px; height:120px; border-radius:50%; border:4px solid #fff; box-shadow:0 10px 30px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.1s;" onclick="pokePomoChar()">
                    <!-- æˆ³ä¸€æˆ³ç‰¹æ•ˆå®¹å™¨ -->
                    <div id="poke-effect" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none; opacity:0; font-size:40px;">ğŸ‘ˆğŸ»</div>
                </div>

                <!-- AI æ°”æ³¡ -->
                <div class="pomo-bubble" id="pomo-ai-bubble">
                    ç‚¹å‡»å¤´åƒæˆ³ä¸€æˆ³æˆ‘ï¼Œæˆ‘ä¼šç›‘ç£ä½ å“¦ï¼
                </div>

            </div>
        </div>
        <!-- ============ 9. æ—¥å† (Calendar) ============ -->
        <div class="page" id="page-calendar">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç”Ÿæ´»æ—¥å†</span>
                <button class="btn-icon-only" onclick="jumpToToday()" style="font-size:14px;">ä»Šå¤©</button>
            </div>
            
            <div class="content-scroll" style="background:#fff; padding:0;">
                <!-- æœˆä»½åˆ‡æ¢æ  -->
                <div class="cal-month-nav">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="cal-current-month">2025å¹´ 11æœˆ</span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>

                <!-- æ˜ŸæœŸå¤´ -->
                <div class="cal-week-header">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>

                <!-- æ—¥å†æ ¼å­å®¹å™¨ -->
                <div id="cal-grid" class="cal-grid"></div>

                <!-- é€‰ä¸­æ—¥æœŸçš„è¯¦æƒ…æ“ä½œåŒº -->
                <div id="cal-detail-panel" style="padding:20px; background:#f2f2f7; min-height:300px;">
                    <div class="ios-group-title" id="selected-date-title">è¯·é€‰æ‹©æ—¥æœŸ</div>
                    <div class="ios-list">
                        <!-- çºªå¿µæ—¥/èŠ‚æ—¥è¾“å…¥ -->
                        <div class="ios-item">
                            <span class="ios-label">ç‰¹æ®Šæ—¥å­</span>
                            <input type="text" id="cal-event-input" class="ios-input" placeholder="ä¾‹å¦‚: ç”Ÿæ—¥ã€çºªå¿µæ—¥" onchange="saveCalendarEvent()">
                        </div>
                    </div>

                    <div class="ios-group-title">ç”Ÿç†æœŸè®°å½•</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="togglePeriodMark()">
                            <span class="ios-label">æ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥</span>
                            <div id="period-check-icon" style="font-size:20px; display:none;">ğŸ©¸</div>
                        </div>
                    </div>
                    
                    <div style="padding:15px; font-size:12px; color:#888; line-height:1.5;">
                        * è¯´æ˜ï¼š<br>
                        1. ç‚¹å‡»â€œæ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥â€ï¼ŒAI ä¼šè‡ªåŠ¨æ¨ç®—ä½ çš„å‘¨æœŸã€‚<br>
                        2. åœ¨ç‰¹æ®Šæ—¥å­ï¼ŒAI å¯èƒ½ä¼šåœ¨é›¶ç‚¹ç»™ä½ æƒŠå–œã€‚<br>
                        3. ç›®å‰æ•°æ®æ˜¯è·Ÿéšå½“å‰èŠå¤©è§’è‰²çš„ã€‚
                    </div>
                </div>
            </div>
        </div>
        <!-- ============ 10. æ—¥ç¨‹è¡¨ (Schedule) ============ -->
        <div class="page" id="page-schedule">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">æˆ‘çš„æ—¥ç¨‹</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                <!-- æ·»åŠ åŒºåŸŸ -->
                <div class="sched-form">
                    <div class="ios-group-title" style="margin:0 0 5px 0;">æ–°å»ºäº‹é¡¹</div>
                    <!-- å ä½ç¬¦æ”¹äº†ï¼Œæš—ç¤ºç”¨æˆ·å¯ä»¥å¡«ä»»ä½•ä¸œè¥¿ -->
                    <input type="text" id="schedName" class="ios-input" style="text-align:left; background:#fff; padding:10px; border-radius:8px;" placeholder="äº‹é¡¹åç§° (å¦‚: é«˜æ•°è¯¾ã€éƒ¨é—¨ä¾‹ä¼šã€å¥èº«)">
                    
                    <div class="sched-row">
                        <select id="schedDay" class="ios-input" style="background:#fff; borderRadius:8px; flex:1;">
                            <option value="1">å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                            <option value="0">å‘¨æ—¥</option>
                        </select>
                        <!-- æ—¶é—´è¾“å…¥æ¡† -->
                        <input type="time" id="schedStart" class="ios-input" value="09:00" style="background:#fff; borderRadius:8px; flex:1;">
                        <span style="padding-top:10px">~</span>
                        <input type="time" id="schedEnd" class="ios-input" value="10:00" style="background:#fff; borderRadius:8px; flex:1;">
                    </div>
                    <button class="ios-btn" onclick="addSchedule()" style="border-radius:8px; background:#5856d6; color:white; border:none;">æ·»åŠ æ—¥ç¨‹</button>
                </div>

                <!-- åˆ—è¡¨åŒºåŸŸ -->
                <div class="ios-group-title">æœ¬å‘¨è®¡åˆ’</div>
                <div id="schedule-list-container" class="schedule-list">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        <!-- ============ 11. X (Twitter) é¡µé¢ (é«˜æ¸…è¿˜åŸç‰ˆ) ============ -->
<div class="page" id="page-x">
    <!-- é¡¶éƒ¨æ  -->
    <!-- é¡¶éƒ¨æ  (æ–°å¸ƒå±€) -->
    <div class="x-header">
        <!-- å·¦è¾¹ï¼šè¿”å›æ¡Œé¢ -->
        <button class="x-header-back" onclick="goHome()">â€¹</button>
        
        <!-- ä¸­é—´ï¼šå½“å‰ç”¨æˆ·å¤´åƒ -->
        <img src="" class="x-header-center-avatar" id="x-current-user-avatar" onclick="openUserProfile()" style="cursor:pointer;">
        
        <!-- å³è¾¹ï¼šæ˜Ÿæ˜Ÿå›¾æ ‡ (ä¿ç•™è£…é¥°) -->
        <svg viewBox="0 0 24 24" class="x-header-right" onclick="triggerPullToRefresh()" style="cursor:pointer;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
    </div>

    <div class="x-refresh-indicator" id="x-refresh-spinner">â†»</div>

    <div class="x-feed" id="x-feed-container">
        <!-- æ¨æ–‡åˆ—è¡¨ -->
    </div>

    <!-- æ‚¬æµ®å‘æ¨æŒ‰é’® (ä¿®å¤ç‰ˆç¾½æ¯›ç¬”) -->
    <div class="x-fab" onclick="openComposeTweet()">
        <svg viewBox="0 0 24 24" class="x-fab-icon"><path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path></svg>
    </div>
    <!-- è½¬æ¨é€‰æ‹©èœå• -->
    <div class="modal-overlay" id="modal-retweet-menu" style="align-items: flex-end;">
        <div class="x-action-sheet">
            <div class="x-sheet-item" onclick="confirmRetweet('repost')">
                <svg viewBox="0 0 24 24" style="width:20px;fill:#fff;margin-right:10px;"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                è½¬å¸–
            </div>
            <div class="x-sheet-item" onclick="confirmRetweet('quote')">
                <svg viewBox="0 0 24 24" style="width:20px;fill:#fff;margin-right:10px;"><path d="M14.23 2.854c.98-.977 2.56-.977 3.54 0l3.38 3.378c.97.977.97 2.559 0 3.536L7.32 23.602l-6.15-1.008 1.01-6.153L14.23 2.854zm1.41 1.414L2.51 17.4l-.5 3.03 3.03-.5 13.13-13.132-2.53-2.53z"></path></svg>
                å¼•ç”¨
            </div>
            <div class="x-sheet-cancel" onclick="closeModal('modal-retweet-menu')">å–æ¶ˆ</div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="x-tab-bar">
        <!-- Home -->
        <button class="x-tab-btn active" onclick="switchXTab('home')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z"></path></svg>
        </button>
        <!-- Search -->
        <button class="x-tab-btn" onclick="switchXTab('search')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></svg>
        </button>
        <!-- Notifications -->
        <button class="x-tab-btn" onclick="switchXTab('notif')" style="position:relative;">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M21.697 16.468c-.02-.016-2.14-1.64-2.103-6.03.02-2.532-.812-4.782-2.347-6.335C15.872 2.71 14.01 1.94 12.005 1.93H11.95c-2.005.01-3.866.78-5.242 2.173-1.534 1.553-2.368 3.802-2.346 6.334.037 4.33-2.02 5.967-2.102 6.03-.26.193-.366.53-.265.838.102.308.39.515.712.515h4.92c.102 2.31 1.997 4.16 4.33 4.16s4.226-1.85 4.33-4.16h4.918c.322 0 .61-.207.712-.515.102-.308-.004-.645-.265-.838zM12 20.478c-1.505 0-2.73-1.177-2.828-2.658h5.656c-.1 1.48-1.323 2.66-2.828 2.66zM4.38 16.32c.74-1.132 1.548-3.028 1.524-5.896-.018-2.16.644-3.982 1.913-5.267C8.91 4.05 10.397 3.437 11.95 3.437h.05c1.552 0 3.04.613 4.133 1.72 1.272 1.285 1.933 3.106 1.915 5.267-.024 2.868.785 4.765 1.525 5.896H4.38z"></path></svg>
            <span class="x-badge" id="x-notif-badge" style="display:none">0</span>
        </button>
        <!-- Messages -->
        <button class="x-tab-btn" onclick="switchXTab('dm')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></svg>
        </button>
    </div>
</div>
        <!-- ============ 12. X æ¨æ–‡è¯¦æƒ…é¡µ (è¯„è®ºåŒº) ============ -->
<div class="page" id="page-x-detail" style="background:#000;">
    <!-- è¯¦æƒ…é¡µé¡¶éƒ¨ -->
    <div class="x-header">
        <button class="x-header-back" onclick="closeTweetDetail()">â€¹</button>
        <div style="color:#fff; font-weight:700; font-size:17px;">å¸–å­</div>
        <div style="width:32px;"></div> <!-- å ä½ -->
    </div>

    <!-- æ»šåŠ¨åŒºåŸŸï¼šæ­£æ–‡ + è¯„è®ºåˆ—è¡¨ -->
    <div class="x-feed" id="x-detail-container" style="margin-bottom: 60px;">
        <!-- 1. ä¸»æ¨æ–‡ (JSåŠ¨æ€æ’å…¥) -->
        <div id="x-detail-main-tweet"></div>
        
        <!-- åˆ†å‰²çº¿ -->
        <div style="border-bottom: 1px solid #2f3336; padding: 10px 16px; color:#e7e9ea; font-weight:bold; font-size:18px;">
            å›å¤
        </div>

        <!-- 2. è¯„è®ºåˆ—è¡¨ (JSåŠ¨æ€æ’å…¥) -->
        <div id="x-detail-comments-list"></div>
    </div>

    <!-- åº•éƒ¨å›ºå®šå›å¤æ  -->
    <div class="x-detail-footer">
        <input type="text" id="x-detail-input" class="x-detail-input" placeholder="å‘å¸ƒä½ çš„å›å¤">
        <button class="x-detail-send-btn" onclick="sendDetailReply()">å›å¤</button>
    </div>
</div>
        <!-- ============ 13. X ä¸ªäººä¸»é¡µ (Profile) ============ -->
<div class="page" id="page-x-profile" style="background:#000; z-index: 55;">
    <!-- é¡¶éƒ¨é€æ˜å¯¼èˆª -->
    <div class="x-profile-header">
        <button class="x-header-back-circle" onclick="closeUserProfile()">â€¹</button>
    </div>

    <!-- å°é¢å›¾ -->
    <div class="x-profile-banner" id="x-profile-banner"></div>

    <!-- èµ„æ–™åŒºåŸŸ -->
    <div class="x-profile-info">
        <div class="x-profile-top-row">
            <img src="" class="x-profile-avatar" id="x-profile-avatar">
            <button class="x-edit-profile-btn" onclick="openEditProfile()">ç¼–è¾‘ä¸ªäººèµ„æ–™</button>
        </div>
        
        <div class="x-profile-name-box">
            <span class="x-profile-name" id="x-profile-name">åç§°</span>
            <span id="x-profile-badge"></span> <!-- è®¤è¯æ ‡ -->
        </div>
        <div class="x-profile-handle" id="x-profile-handle">@username</div>
        
        <div class="x-profile-bio" id="x-profile-bio">ç®€ä»‹...</div>
        
        <div class="x-profile-meta">
            <span class="x-meta-item">ğŸ“… <span id="x-profile-join">2023å¹´ åŠ å…¥</span></span>
            <span class="x-meta-item" id="x-profile-location-box" style="display:none">ğŸ“ <span id="x-profile-location"></span></span>
        </div>

        <div class="x-profile-stats">
            <span class="x-stat-num" id="x-profile-following">0</span> <span class="x-stat-label">æ­£åœ¨å…³æ³¨</span>
            <span class="x-stat-num" id="x-profile-followers">0</span> <span class="x-stat-label">å…³æ³¨è€…</span>
        </div>
    </div>
    
    <!-- ç®€å•çš„æ¨æ–‡åˆ—è¡¨å ä½ -->
    <!-- ä¸‹é¢è¿™ä¸ª div æ˜¯ä¸“é—¨ç”¨æ¥æ”¾æ¨æ–‡åˆ—è¡¨çš„ï¼Œå¿…é¡»è¦æœ‰ id -->
    <div id="x-profile-tweets-container" style="border-top:1px solid #2f3336; min-height: 200px; padding-bottom: 50px;"></div>
</div>

<!-- ============ 14. ç¼–è¾‘èµ„æ–™å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-x-edit">
    <div class="modal-box" style="height:80%; top:10%; background:#000; border:1px solid #2f3336;">
        <div class="x-modal-header">
            <button onclick="closeModal('modal-x-edit')">å–æ¶ˆ</button>
            <span style="font-weight:bold; color:#fff;">ç¼–è¾‘èµ„æ–™</span>
            <button style="color:#fff;" onclick="saveUserProfile()">ä¿å­˜</button>
        </div>
        <div class="modal-body" style="background:#000; padding:15px;">
            <div class="x-input-group">
                <label>èƒŒæ™¯å›¾ URL</label>
                <input type="text" id="edit-x-banner" class="x-input">
            </div>
            <div class="x-input-group">
                <label>å¤´åƒ URL</label>
                <input type="text" id="edit-x-avatar" class="x-input">
            </div>
            <div class="x-input-group">
                <label>åç§°</label>
                <input type="text" id="edit-x-name" class="x-input">
            </div>
            <div class="x-input-group">
                <label>ç”¨æˆ·å (@)</label>
                <input type="text" id="edit-x-handle" class="x-input">
            </div>
            <div class="x-input-group">
                <label>ç®€ä»‹ (Bio)</label>
                <textarea id="edit-x-bio" class="x-input" rows="3"></textarea>
            </div>
            <div class="x-input-group">
                <label>ä½ç½®/æ ‡ç­¾</label>
                <input type="text" id="edit-x-location" class="x-input">
            </div>
            <div class="x-flex-row">
                <div class="x-input-group" style="flex:1">
                    <label>æ­£åœ¨å…³æ³¨</label>
                    <input type="number" id="edit-x-following" class="x-input">
                </div>
                <div class="x-input-group" style="flex:1">
                    <label>å…³æ³¨è€…</label>
                    <input type="number" id="edit-x-followers" class="x-input">
                </div>
            </div>
            
            <div class="x-input-group">
                <label>è®¤è¯ç±»å‹</label>
                <select id="edit-x-badge-type" class="x-input" onchange="togglePartnerSelect()">
                    <option value="none">æ— è®¤è¯</option>
                    <option value="blue">å·²è®¤è¯ (è“å‹¾)</option>
                    <option value="gold">å®˜æ–¹è®¤è¯ (é‡‘å‹¾)</option>
                    <option value="couple">æƒ…ä¾£è®¤è¯ (å¿ƒå½¢)</option>
                    <option value="married">å·²å©šè®¤è¯ (åœ†ç¯)</option>
                    <option value="vip">VIP (è±å½¢)</option>
                </select>
            </div>

            <!-- åªæœ‰é€‰æƒ…ä¾£/å·²å©šæ—¶æ˜¾ç¤º -->
            <div class="x-input-group" id="x-partner-select-group" style="display:none;">
                <label>ç»‘å®šå¯¹è±¡ (åªæœ‰é€‰ä¸­çš„è§’è‰²ä¼šæœ‰æ ‡è®°)</label>
                <select id="edit-x-partner" class="x-input">
                    <option value="">-- æ—  --</option>
                </select>
            </div>
        </div>
    </div>
</div>
        <!-- ============ 15. ä¹¦æ¶ (Bookshelf) ============ -->
<div class="page" id="page-bookshelf">
    <div class="app-header">
        <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
        <span class="app-title">å…±è¯»ç©ºé—´</span>
        <button class="btn-icon-only" id="btn-manage-books" onclick="toggleBookDeleteMode()" style="font-size: 18px; margin-right: 10px;">ğŸ—‘ï¸</button>
        <button class="btn-icon-only" onclick="document.getElementById('bookFileInput').click()">+</button>
        <input type="file" id="bookFileInput" accept=".txt" hidden onchange="handleBookImport(event)">
    </div>
    
    <!-- æ»šåŠ¨åŒºåŸŸ -->
    <div class="content-scroll">
        <div class="ios-group-title">æˆ‘çš„ä¹¦æ¶</div>
        <!-- ä¿®å¤ç‰ˆï¼šåŠ ä¸Š display: grid å¼ºåˆ¶ç½‘æ ¼å¸ƒå±€ï¼Œå¹¶è°ƒæ•´é—´è· -->
<div id="bookshelf-container" class="app-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 0 10px;">
    <!-- ä¹¦ç±åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
</div>
        <div style="padding:20px; text-align:center; color:#999; font-size:12px;">
            ç‚¹å‡»å³ä¸Šè§’ + å·å¯¼å…¥ TXT<br>
            ä¹¦ç±æ­£æ–‡å­˜å‚¨äº IndexedDB
        </div>
    </div>

    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¯·æŠŠæ‚¬æµ®æŒ‰é’®æ”¾åœ¨è¿™é‡Œ (content-scroll çš„å¤–é¢ï¼Œpage çš„é‡Œé¢) ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <button class="writer-fab" onclick="openCreateNovelModal()">
        <!-- æ¨ç‰¹åŸç‰ˆç¾½æ¯›ç¬” SVG å›¾æ ‡ -->
        <svg viewBox="0 0 24 24" class="writer-fab-icon">
            <path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path>
        </svg>
    </button>
    <!-- ğŸ‘†ğŸ‘†ğŸ‘† æŒ‰é’®ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

</div>
        <!-- ============ 17. è®°è´¦æœ¬ (Wallet) ============ -->
<div class="page" id="page-wallet" style="background: #f2f2f7;">
    <div class="app-header">
        <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
        <span class="app-title">æˆ‘çš„é’±åŒ…</span>
        <button class="btn-icon-only" onclick="openBudgetModal()">è®¾ç½®</button>
    </div>
    
    <div class="content-scroll">
        <!-- é¡¶éƒ¨èµ„äº§å¡ç‰‡ -->
        <div class="wallet-card-summary">
            <div class="w-label">æœ¬æœˆå‰©ä½™é¢„ç®—</div>
            <div class="w-balance" id="wallet-balance">Â¥ 0.00</div>
            
            <div class="w-row">
                <div>
                    <span class="w-sub-label">æœ¬æœˆé¢„ç®—</span>
                    <div class="w-num" id="wallet-budget-display">0</div>
                </div>
                <div style="text-align:right;">
                    <span class="w-sub-label">å·²æ”¯å‡º</span>
                    <div class="w-num danger" id="wallet-expense-display">0</div>
                </div>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="w-progress-bg">
                <div class="w-progress-fill" id="wallet-progress"></div>
            </div>
            <div id="wallet-warning" style="font-size:10px; color:#ffdddd; margin-top:5px; display:none;">âš ï¸ é¢„ç®—å‘Šæ€¥ï¼</div>
        </div>

        <!-- è®°ä¸€ç¬”åŒºåŸŸ -->
        <div class="ios-list" style="margin-top:20px;">
            <div class="ios-item">
                <span class="ios-label">é‡‘é¢</span>
                <input type="number" id="bill-amount" class="ios-input" placeholder="0.00" style="font-size:20px; color:#000;">
            </div>
            <div class="ios-item">
                <span class="ios-label">åˆ†ç±»</span>
                <select id="bill-cate" class="ios-input" style="direction: rtl;">
                    <option value="é¤é¥®">ğŸ” é¤é¥®ç¾é£Ÿ</option>
                    <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹</option>
                    <option value="äº¤é€š">ğŸš• äº¤é€šå‡ºè¡Œ</option>
                    <option value="å¨±ä¹">ğŸ® ä¼‘é—²å¨±ä¹</option>
                    <option value="å±…ä½">ğŸ  å±…ä½ç¼´è´¹</option>
                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–æ”¯å‡º</option>
                </select>
            </div>
            <div class="ios-item">
                <span class="ios-label">å¤‡æ³¨</span>
                <input type="text" id="bill-desc" class="ios-input" placeholder="ä¹°äº†ä»€ä¹ˆ?">
            </div>
            <button class="ios-btn" onclick="addTransaction()" style="font-weight:bold; color:#34c759;">+ è®°ä¸€ç¬”</button>
        </div>

        <!-- è´¦å•æ˜ç»† -->
        <div class="ios-group-title">è¿‘æœŸè´¦å•</div>
        <div id="wallet-list-container">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- è®¾ç½®é¢„ç®—å¼¹çª— -->
<div class="modal-overlay" id="modal-budget">
    <div class="modal-box" style="height:auto; top:30%;">
        <div class="modal-header">è®¾ç½®æœ¬æœˆé¢„ç®—</div>
        <div class="modal-body" style="padding:20px;">
            <input type="number" id="input-budget-setting" class="ios-input" style="text-align:center; border:1px solid #eee; border-radius:10px; padding:10px; font-size:24px;" placeholder="ä¾‹å¦‚: 3000">
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-budget')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="saveBudgetSetting()">ä¿å­˜</button>
        </div>
    </div>
</div>
        <!-- ============ 14. åŒäººè®ºå› (ç²®ä»“) ============ -->
<div class="page" id="page-forum">
    <div class="app-header">
        <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
        <span class="app-title">åŒäººç²®ä»“</span>
        <span style="width:50px;"></span>
    </div>
    <div class="content-scroll" style="background:#f9f9f9;">
        <div id="forum-feed" class="forum-feed">
            <!-- å¸–å­åˆ—è¡¨ -->
        </div>
    </div>
    <button class="btn-fab-write" onclick="openCreateFicModal()">+</button>
</div>

<!-- ============ 15. å¸–å­è¯¦æƒ…é¡µ (è¦†ç›–åœ¨è®ºå›ä¸Š) ============ -->
<div class="page" id="page-forum-detail" style="background:#fff; z-index: 60;">
    <div class="app-header">
        <button class="btn-icon-text" onclick="closeFicDetail()">â€¹ è¿”å›</button>
        <span class="app-title">é˜…è¯»</span>
        <button class="btn-icon-only" onclick="shareFicToChat()" style="font-size: 20px;">â†—ï¸</button>
    </div>
    <div class="content-scroll" style="padding: 20px;">
        <h1 id="fic-detail-title" style="font-size:22px; margin-bottom:10px;">æ ‡é¢˜</h1>
        <div class="forum-meta">
            <span id="fic-detail-author">äº§ç²®å¤§å¤§</span> Â· 
            <span id="fic-detail-tags">#ç”œæ–‡</span>
        </div>
        <div id="fic-detail-body" class="post-detail-content">
            <!-- æ­£æ–‡ -->
        </div>
        
        <div class="post-comment-section">
            <div style="font-weight:bold; margin-bottom:15px;">çƒ­é—¨è¯„è®º</div>
            <div id="fic-detail-comments">
                <!-- è¯„è®ºåˆ—è¡¨ -->
            </div>
        </div>
    </div>
</div>

<!-- ============ 16. é˜…è¯»å™¨ (Reader) - å‡çº§ç‰ˆ ============ -->
<div class="page" id="page-reader" style="background: #f8f1e5;"> <!-- ç¾Šçš®çº¸èƒŒæ™¯ -->
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="reader-header" style="height:50px; display:flex; align-items:center; justify-content:space-between; padding:0 15px; position:absolute; top:40px; width:100%; z-index:100; color:#5b4636;">
        <button onclick="exitReader()" style="background:none; border:none; font-size:16px; color:#5b4636; font-weight:bold;">â€¹ ä¹¦æ¶</button>
        <span id="reader-title" style="font-weight:bold; font-size:14px; max-width:150px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">ä¹¦å</span>
        <div style="display:flex; gap:15px;">
            <!-- âœ¨âœ¨âœ¨ æ–°å¢è¿™ä¸ªæŒ‰é’®ï¼šæ‰‹åŠ¨è§¦å‘åŒæ­¥ âœ¨âœ¨âœ¨ -->
        <button onclick="manualShareReport()" style="background:none; border:none; font-size:20px;" title="åŒæ­¥é˜…è¯»è¿›åº¦ç»™AI">ğŸ”„</button>
        <!-- âœ¨âœ¨âœ¨ æ–°å¢ç»“æŸ âœ¨âœ¨âœ¨ -->
    <button onclick="openSummaryList()" style="background:none; border:none; font-size:20px;" title="æŸ¥çœ‹é˜…è¯»ç¬”è®°">ğŸ“</button>
    <button onclick="toggleReaderSettings()" style="background:none; border:none; font-size:18px;">Aa</button>
</div>
    </div>

    <!-- æ–‡æœ¬å†…å®¹åŒº -->
    <div id="reader-content" style="position:absolute; top:90px; bottom:70px; left:0; right:0; padding:20px 25px; overflow-y:auto; font-size:19px; line-height:1.8; color:#333; font-family:'Songti SC', serif; text-align:justify; scroll-behavior: smooth;">
        <!-- ç« èŠ‚æ­£æ–‡ -->
    </div>
    <!-- æ–°å¢ï¼šAI å°è¯´ä¸“ç”¨äº’åŠ¨æ  (ç¿»é¡µå¢å¼ºç‰ˆ) -->
<div id="reader-interactive-bar" style="
    position: absolute; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    background: rgba(248, 248, 248, 0.98); 
    backdrop-filter: blur(20px); 
    border-top: 1px solid #e5e5ea; 
    display: none; 
    flex-direction: column; 
    gap: 12px; 
    z-index: 200; 
    padding: 10px 15px max(20px, env(safe-area-inset-bottom)) 15px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
">
    <!-- ç¬¬ä¸€è¡Œï¼šå¯¼èˆªä¸æ“ä½œ (æ–°å¸ƒå±€) -->
    <div style="display:flex; align-items:center; justify-content:space-between; color:#007AFF; font-size:14px;">
        <!-- å·¦ä¾§ï¼šä¸Šä¸€ç«  -->
        <div onclick="prevChapter()" style="cursor:pointer; padding:5px; font-weight:bold; display:flex; align-items:center;">
            <span style="font-size:18px;">â€¹</span> ä¸Šç« 
        </div>

        <!-- ä¸­é—´ï¼šæ“ä½œåŒº (æ’¤å›/é‡å†™/æ€»ç»“) -->
        <div style="display:flex; gap:15px; font-size:12px; color:#666;">
            <span onclick="deleteLastChapter()" style="color:#ff3b30; cursor:pointer;">æ’¤å›</span>
            <span onclick="regenerateLastChapter()" style="color:#FF9500; cursor:pointer;">é‡å†™</span>
            <span onclick="summarizeAiNovelChapter()" style="color:#34c759; cursor:pointer;">æ€»ç»“</span>
        </div>

        <!-- å³ä¾§ï¼šä¸‹ä¸€ç«  -->
        <div onclick="nextChapter()" style="cursor:pointer; padding:5px; font-weight:bold; display:flex; align-items:center;">
            ä¸‹ç«  <span style="font-size:18px;">â€º</span>
        </div>
    </div>

    <!-- ç¬¬äºŒè¡Œï¼šè¾“å…¥å‰§æƒ…èµ°å‘ -->
    <div style="display:flex; gap:10px; align-items:center;">
        <button onclick="insertRandomEvent()" style="font-size:24px; background:none; border:none; padding:0; flex-shrink: 0;" title="éšæœºäº‹ä»¶">âš¡</button>
        
        <input type="text" id="ai-novel-prompt" placeholder="æ¥ä¸‹æ¥..." 
               style="flex:1; min-width:0; height:40px; padding:0 12px; border-radius:20px; border:1px solid #ddd; outline:none; font-size:15px; background:#fff;">
        
        <button onclick="generateNextChapterAI()" 
                style="background:#007AFF; color:white; border:none; height:36px; padding:0 15px; border-radius:18px; font-weight:bold; font-size:14px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,122,255,0.3);">
            ç”Ÿæˆ
        </button>
    </div>
</div>

    <!-- åº•éƒ¨å¯¼èˆª (åŒå±‚æ§åˆ¶) -->
    <div class="reader-footer" style="position:absolute; bottom:0; width:100%; height:70px; background:rgba(248,241,229,0.98); border-top:1px solid rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between; padding:0 15px; padding-bottom:15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
        
        <!-- ä¸Šä¸€ç«  (è·³æ–‡ä»¶) -->
        <button onclick="prevChapter()" class="reader-btn-chap" title="ä¸Šä¸€ç« ">â® ç« </button>
        
        <!-- ä¸Šä¸€é¡µ (æ»šå±) -->
        <button onclick="scrollReader(-1)" class="reader-btn-page" title="ä¸Šä¸€é¡µ">â€¹ é¡µ</button>
        
        <!-- è¿›åº¦ -->
        <span id="reader-progress" style="font-size:12px; color:#999; font-variant-numeric: tabular-nums;">1/10</span>
        
        <!-- ä¸‹ä¸€é¡µ (æ»šå±) -->
        <button onclick="scrollReader(1)" class="reader-btn-page" title="ä¸‹ä¸€é¡µ">é¡µ â€º</button>
        
        <!-- ä¸‹ä¸€ç«  (è·³æ–‡ä»¶ + è§¦å‘æ€»ç»“) -->
        <button onclick="nextChapter()" class="reader-btn-chap" title="ä¸‹ä¸€ç« ">ç«  â­</button>
    </div>

    <!-- AI ä¼´è¯»æ‚¬æµ®çƒ (ä¿®æ”¹ç‰ˆï¼šåŠ äº†IDï¼Œå»æ‰äº† onclickï¼ŒåŠ äº†è§¦æ‘¸æ ·å¼) -->
<div id="reader-float-btn" class="reader-ai-bubble" 
     style="position:absolute; bottom:150px; right:20px; width:50px; height:50px; border-radius:50%; background:#fff; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; border:2px solid #5856d6; z-index:200; cursor:pointer; touch-action: none;">
    <img id="reader-ai-avatar" src="" style="width:42px; height:42px; border-radius:50%; object-fit:cover; pointer-events: none;">
</div>
</div>

<!-- é˜…è¯»å™¨èŠå¤©å¼¹çª— -->
<div class="modal-overlay" id="modal-reader-chat" style="justify-content:flex-end;">
    <div class="modal-box" style="width:100%; height:70%; border-bottom-left-radius:0; border-bottom-right-radius:0;">
        <div class="modal-header" style="display:flex; justify-content:space-between; background:#f2f2f7;">
            <span>ä¸ <span id="reader-chat-partner">AI</span> å…±è¯»</span>
            <button onclick="closeModal('modal-reader-chat')" style="border:none; background:none; font-size:20px;">â†“</button>
        </div>
        <div id="reader-chat-history" style="flex:1; overflow-y:auto; padding:15px; background:#fff;"></div>
        <div class="input-area" style="padding-bottom:max(20px, env(safe-area-inset-bottom));">
            <div class="input-toolbar">
                <input type="text" id="readerChatInput" placeholder="èŠèŠè¿™æ®µå‰§æƒ…..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
                <button class="btn-send" onclick="sendReaderMsg()">â¬†</button>
            </div>
        </div>
    </div>
</div>
        <!-- ğŸµ éŸ³ä¹æ’­æ”¾å™¨æ‚¬æµ®çƒ (åœ¨æ‰€æœ‰é¡µé¢ä¹‹ä¸Š) -->
    <!-- å»æ‰äº† onclickï¼ŒåŠ äº† style è®©å®ƒåˆå§‹ä½ç½®é è°±ç‚¹ -->
<div id="music-float-btn" class="music-float-btn" style="top: 100px; right: 20px;">
    <img id="float-cover" src="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
</div>

    <!-- ğŸµ å…¨å±éŸ³ä¹æ’­æ”¾å™¨ -->
    <div id="music-player" class="music-player-overlay">
        <!-- èƒŒæ™¯æ¨¡ç³Šå±‚ -->
        <div id="music-bg" class="music-bg-blur" style="background-image: url('https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=500');"></div>
        
        <div class="music-content">
            <!-- é¡¶éƒ¨ -->
            <div class="music-header">
                <button onclick="toggleMusicPlayer(false)" style="background:none;border:none;color:#fff;">âŒ„</button>
                <span style="font-size:16px; opacity:0.8;">ä¸€èµ·å¬</span>
                <button style="width:24px;"></button> <!-- å ä½ -->
            </div>

            <!-- å¤´åƒäº’åŠ¨ -->
            <div class="music-avatars">
                <img id="m-user-avatar" src="" class="m-avatar">
                <div class="m-connect-line"></div>
                <img id="m-ai-avatar" src="" class="m-avatar">
            </div>

            <!-- å”±ç‰‡åŒº (ç‚¹å‡»åˆ‡æ¢æ­Œè¯) -->
            <div id="vinyl-view" class="vinyl-wrapper" onclick="switchMusicView()">
                <img id="m-cover" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=500" class="vinyl-cover">
            </div>

            <!-- æ­Œè¯åŒº -->
            <div id="lyrics-view" class="lyrics-container" onclick="switchMusicView()">
                <div class="lrc-line">ç‚¹å‡»å³ä¸‹è§’â€œå¯¼å…¥â€</div>
                <div class="lrc-line">ç²˜è´´æ­Œè¯å¼€å§‹</div>
            </div>
            
            <!-- åº•éƒ¨æ§åˆ¶ -->
            <div class="music-controls">
                <div class="music-info-text">
                    <div id="m-title" class="m-title">æœªæ’­æ”¾</div>
                    <div id="m-artist" class="m-artist">--</div>
                </div>

                <div class="progress-bar-box">
                    <span id="curr-time">00:00</span>
                    <div class="progress-bar"><div id="prog-fill" class="progress-fill"></div></div>
                    <span id="total-time">00:00</span>
                </div>

                <div class="btn-row">
        <!-- å·¦è¾¹æŒ‰é’®æ”¹æˆå¾ªç¯æ¨¡å¼åˆ‡æ¢(å¯é€‰)ï¼Œè¿™é‡Œå…ˆç•™ç©ºæˆ–è€…æ”¾ä¸ªå›¾æ ‡ -->
        <button class="m-btn" style="font-size:20px; opacity:0.5;">â†»</button> 
        
        <button id="btn-play-pause" class="m-btn m-btn-play" onclick="togglePlayMusic()">â–¶</button>
        
        <!-- å³ä¸‹è§’æŒ‰é’®ï¼šç‚¹å‡»æ‰“å¼€æ’­æ”¾åˆ—è¡¨ -->
        <button class="m-btn" style="font-size:24px;" onclick="togglePlaylist(true)">â‰¡</button>
                </div>
            </div>
            <!-- ... ä¸Šé¢æ˜¯ music-controls ... -->
        
        <!-- æ’­æ”¾åˆ—è¡¨æŠ½å±‰ (æ’å…¥åˆ° music-player å†…éƒ¨çš„æœ€ä¸‹æ–¹) -->
        <div id="playlist-drawer" class="playlist-drawer">
            <div class="playlist-header">
                <span style="font-size:18px; font-weight:bold;">å½“å‰æ’­æ”¾ (<span id="pl-count">0</span>)</span>
                <!-- å³ä¸Šè§’åŠ å·ï¼Œç‚¹å‡»æ‰“å¼€å¯¼å…¥å¼¹çª— -->
                <button class="btn-add-song" onclick="openAddSongModal()">+</button>
            </div>
            <div id="playlist-content" class="playlist-scroll">
                <!-- åˆ—è¡¨é¡¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- å…³é—­åˆ—è¡¨çš„æŒ‰é’® -->
            <button onclick="togglePlaylist(false)" style="width:100%; padding:15px; background:none; border:none; color:#fff; border-top:1px solid rgba(255,255,255,0.1);">å…³é—­</button>
        </div>

        </div>
    </div>

    <!-- ğŸµ å¯¼å…¥æ­Œæ›²å¼¹çª— (ä¼˜åŒ–ç‰ˆ) -->
    <div class="modal-overlay" id="modal-import-music">
        <div class="modal-box">
            <div class="modal-header">ä¸€èµ·å¬ (å¯¼å…¥æ­Œæ›²)</div>
            <div class="modal-body" style="padding: 15px;">
                <!-- âœ¨ æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰ç¼–è¾‘çš„æ­Œæ›²ç´¢å¼• (-1 ä»£è¡¨æ–°å¢æ¨¡å¼) -->
<input type="hidden" id="edit-song-index" value="-1">
                
                <!-- æ­¥éª¤1: æ­Œæ›²ä¿¡æ¯ -->
                <div class="ios-group-title" style="margin-top:0;">ç¬¬ä¸€æ­¥: å‘Šè¯‰ AI è¿™æ˜¯ä»€ä¹ˆæ­Œ</div>
                <div style="font-size:12px; color:#999; margin-bottom:10px; padding:0 10px;">
                    è¿™äº›ä¿¡æ¯æ˜¯ä¸ºäº†è®© AI çŸ¥é“ä½ åœ¨å¬ä»€ä¹ˆï¼Œå¡«ä¸ªå¤§æ¦‚å°±è¡Œã€‚
                </div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">æ­Œå</span>
                        <input type="text" id="imp-title" class="ios-input" placeholder="ä¾‹å¦‚: æ™´å¤©">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ­Œæ‰‹</span>
                        <input type="text" id="imp-artist" class="ios-input" placeholder="ä¾‹å¦‚: å‘¨æ°ä¼¦">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">å°é¢å›¾</span>
                        <input type="text" id="imp-cover" class="ios-input" placeholder="ç²˜è´´å›¾ç‰‡URL (ç•™ç©ºåˆ™ç”¨é»˜è®¤)">
                    </div>
                </div>

                <!-- æ­¥éª¤2: éŸ³é¢‘æº -->
                <div class="ios-group-title">ç¬¬äºŒæ­¥: æä¾›éŸ³é¢‘ (äºŒé€‰ä¸€)</div>
                <div class="ios-list">
                    <!-- æ–¹å¼A: ä¸Šä¼ æ–‡ä»¶ -->
                    <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="ios-label" style="margin-bottom:5px;">æ–¹å¼A: ä¸Šä¼ æœ¬åœ° MP3</span>
                        <input type="file" id="imp-file" accept=".mp3,.m4a,.wav,.flac,audio/*" class="ios-input" style="padding-left:0;">
                    </div>
                    <!-- æ–¹å¼B: ç²˜è´´é“¾æ¥ -->
                    <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="ios-label" style="margin-bottom:5px;">æ–¹å¼B: ç²˜è´´ MP3 ç›´é“¾</span>
                        <input type="text" id="imp-url" class="ios-input" placeholder="å¿…é¡»ä»¥ .mp3/.m4a ç»“å°¾çš„ç›´é“¾">
                    </div>
                </div>
                <div style="font-size:12px; color:#ff3b30; margin:5px 15px;">
                    æ³¨æ„ï¼šå°±åƒä½ åˆšæ‰å‘çš„é‚£ä¸ªå¾ˆé•¿çš„ .mp3 é“¾æ¥ï¼Œç²˜è´´åœ¨â€œæ–¹å¼Bâ€é‡Œæ˜¯å¯ä»¥æ’­æ”¾çš„ï¼ä½†æ™®é€šçš„ç½‘é¡µé“¾æ¥(å¦‚163.com/song?id=...)æ— æ³•æ’­æ”¾ã€‚
                </div>

                <!-- æ­¥éª¤3: æ­Œè¯ -->
                <div class="ios-group-title">ç¬¬ä¸‰æ­¥: æ­Œè¯ (å¯é€‰ï¼Œä¸ºäº†æ›´å¥½ä½“éªŒ)</div>
                <div style="font-size:12px; color:#999; margin-bottom:5px; padding:0 10px;">
                    å»ç½‘ä¸Šå¤åˆ¶ LRC æ ¼å¼æ­Œè¯ç²˜è´´åœ¨ä¸‹é¢ï¼ŒAI æ‰èƒ½ç²¾å‡†æ„ŸçŸ¥æ­Œè¯ã€‚
                </div>
                <textarea id="imp-lrc" class="ios-input" style="height:100px; border:1px solid #eee; padding:10px; border-radius:10px; width:100%;" placeholder="[00:00.00] ç²˜è´´æ­Œè¯åˆ°è¿™é‡Œ...&#10;[00:05.00] æ­Œè¯å†…å®¹..."></textarea>
                
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeModal('modal-import-music')">å–æ¶ˆ</button>
                <button class="modal-btn" onclick="confirmImportMusic()">å¼€å§‹æ’­æ”¾</button>
            </div>
        </div>
    </div>
        <!-- ============ 18. æƒ…ä¾£é£è¡Œæ£‹ (Ludo) ============ -->
<div class="page" id="page-ludo" style="background: #fff5f7;">
    <!-- é¡¶éƒ¨æ  -->
    <div class="app-header" style="background: rgba(255,245,247,0.9);">
        <button class="btn-icon-text" onclick="goHome()">â€¹ ç»“æŸ</button>
        <span class="app-title" style="color:#ff6b81;">æƒ…ä¾£é£è¡Œæ£‹</span>
        <!-- ä¿®æ”¹ï¼šç‚¹å‡»æŒ‰é’®ä¸å†ç›´æ¥é€‰æ–‡ä»¶ï¼Œè€Œæ˜¯æ‰“å¼€å¼¹çª— -->
<button class="btn-icon-only" onclick="openLudoLibrary()">ğŸ“‚</button>

<!-- input ä¿æŒéšèº«ï¼Œä½†åœ¨ JS é‡Œæˆ‘ä»¬ä¼šæ”¹å®ƒçš„ onchange -->
<input type="file" id="ludoTaskInput" accept=".json, .txt, text/plain" hidden onchange="handleNewBankImport(event)">
    </div>

    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæ£‹ç›˜åŒº -->
    <div class="ludo-board-container">
        <!-- èµ·ç‚¹åŒºåŸŸ (åœæœºåª) -->
        <div class="ludo-base">
            <div class="ludo-base-spot user" id="base-user" onclick="tryTakeOff('user')">
                <div class="ludo-avatar-holder" id="pawn-user-base"></div>
                <span>æˆ‘</span>
            </div>
            <div class="ludo-vs">VS</div>
            <div class="ludo-base-spot ai" id="base-ai">
                <div class="ludo-avatar-holder" id="pawn-ai-base"></div>
                <span>Ta</span>
            </div>
        </div>
        
        <!-- 24æ ¼ Så‹æ£‹ç›˜ -->
        <div class="ludo-grid" id="ludo-grid">
            <!-- JS åŠ¨æ€ç”Ÿæˆ 24 ä¸ªæ ¼å­ -->
        </div>
    </div>

    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ§åˆ¶ä¸äº’åŠ¨åŒº -->
    <div class="ludo-control-panel">
        <!-- æ»šåŠ¨æ—¥å¿—/é¢˜ç›®æ˜¾ç¤ºåŒº -->
        <div class="ludo-log-area" id="ludo-log">
            <div class="ludo-msg system">æ¬¢è¿æ¥åˆ°æƒ…ä¾£é£è¡Œæ£‹ï¼<br>è§„åˆ™ï¼šæŠ•å‡º 6 ç‚¹æ‰èƒ½èµ·é£ã€‚ç›¸é‡ä¼šæŠŠå¯¹æ–¹æ’å›èµ·ç‚¹ã€‚<br>ç‚¹å‡»å³ä¸Šæ–¹ ğŸ“‚ å¯¼å…¥é¢˜åº“ï¼Œå¦åˆ™é»˜è®¤ä¸ºç©ºã€‚</div>
        </div>

        <!-- éª°å­ä¸æ“ä½œæ  -->
        <div class="ludo-action-bar">
            <!-- éª°å­ -->
            <div id="ludo-dice" class="ludo-dice" onclick="userRollDice()">
                <div class="dice-face front">1</div>
                <div class="dice-face back">6</div>
                <div class="dice-face right">3</div>
                <div class="dice-face left">4</div>
                <div class="dice-face top">5</div>
                <div class="dice-face bottom">2</div>
            </div>
            
            <!-- çŠ¶æ€æç¤ºæ–‡å­— -->
            <div class="ludo-status-text" id="ludo-status">ç‚¹éª°å­å¼€å§‹</div>
            
            <!-- ç»“æŸæœ¬é¢˜æŒ‰é’® (é»˜è®¤éšè—ï¼Œåšä»»åŠ¡æ—¶æ˜¾ç¤º) -->
            <button id="btn-finish-task" class="ludo-btn-finish" onclick="finishCurrentTask()" style="display:none;">å®Œæˆæœ¬é¢˜</button>
        </div>

        <!-- å¯¹è¯è¾“å…¥æ¡† (å§‹ç»ˆå­˜åœ¨) -->
        <div class="input-area" style="padding: 10px; background: transparent; border-top: 1px solid rgba(0,0,0,0.05);">
            <div class="input-toolbar">
                <input type="text" id="ludoInput" placeholder="å›åº”ä»»åŠ¡æˆ–å’ŒTaèŠå¤©..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ffccd5; background:rgba(255,255,255,0.8);">
                <button class="btn-send" onclick="sendLudoMsg()" style="color:#ff6b81;">â¬†</button>
            </div>
        </div>
    </div>
</div>

<!-- é€‰äººå¼¹çª— (è¿›å…¥æ¸¸æˆå‰) -->
<div class="modal-overlay" id="modal-ludo-select">
    <div class="modal-box" style="height:auto;">
        <div class="modal-header">é€‰æ‹©æ¸¸æˆå¯¹è±¡</div>
        <div class="modal-body" style="padding:0;">
            <div id="ludo-contact-list" class="ios-list" style="margin:0;"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-ludo-select')">å–æ¶ˆ</button>
        </div>
    </div>
</div>
        <div class="page" id="page-theater-list" style="background: #f5f5f5;">
    <div class="app-header" style="background: #fff; border-bottom: 1px solid #eee;">
        <button class="btn-icon-text" onclick="goHome()" style="color:#000;">â€¹ æ¡Œé¢</button>
        <span class="app-title" style="font-size: 18px; color:#000;">æˆ‘çš„å‰§æœ¬</span>
        <button class="btn-icon-only" onclick="createNewScript()" style="font-size: 24px; color:#000;">+</button>
    </div>
    
    <div class="content-scroll" id="theater-list-container" style="background: #f7f7fa; padding: 0;">
        </div>
</div>
        <!-- ============ 19. å‰§åœºæ¨¡å¼ (Theater Mode) ============ -->
<div class="page" id="page-theater" style="background-color: #1a1a1a; color: #d0d0d0;">
    
    <!-- æ²‰æµ¸å¼èƒŒæ™¯å±‚ -->
    <div id="theater-bg-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:-1; background-size:cover; background-position:center; opacity:0.3;"></div>

    <!-- é¡¶éƒ¨å¯¼æ¼”æ  -->
    <div class="theater-header">
        <button class="btn-icon-only" onclick="goHome()" style="color:#999;">â€¹ é€€å‡º</button>
        
        <span class="theater-title" id="theater-title">æœªå‘½åå‰§æœ¬</span>
        
        <div style="display:flex; gap:15px;">
            <button class="btn-icon-only" onclick="openArchiveModal()" style="color:#d4a373; font-size:20px;">ğŸ“œ</button>
            <button class="btn-icon-only" onclick="generateTheaterSummary()" style="color:#FF9500; font-size:20px;">âœ¨</button>
            
            <button class="btn-icon-only" onclick="openTheaterConsole()" style="color:#007AFF;">ğŸ¬</button>
        </div>
    </div>

    <!-- å‰§æœ¬é˜…è¯»åŒº (å–ä»£èŠå¤©æ¡†) -->
    <div class="theater-stage" id="theater-stage">
        <div class="theater-start-tip">
            <p>è¿™é‡Œæ˜¯å¼‚ä¸–ç•Œã€‚</p>
            <p>æ²¡æœ‰æ°”æ³¡ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚</p>
            <p>è¯·ç‚¹å‡»å³ä¸Šè§’é…ç½®ä½ çš„å‰§æœ¬ã€‚</p>
        </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥åŒº -->
    <div class="theater-input-area">
        <textarea id="theater-input" rows="1" placeholder="æˆ‘çŒœä½ ä¹Ÿæƒ³é è¿‘å§ï¼Ÿ" oninput="autoResizeTextArea(this)"></textarea>
        <button class="theater-reroll-btn" onclick="rerollTheaterMsg()" style="margin-right: 8px;">ğŸ”„</button>
        <button class="theater-send-btn" onclick="sendTheaterMsg()">âœ’ï¸</button>
    </div>
</div>

<!-- ============ å¯¼æ¼”æ§åˆ¶å°å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-theater-console">
    <div class="modal-box" style="height: 85%; background: #222; color: #eee; border: 1px solid #444;">
        <div class="modal-header" style="border-bottom: 1px solid #444; background: #222;">
            <button onclick="closeModal('modal-theater-console')" style="color:#999;">å…³é—­</button>
            <span style="color:#fff;">å¯¼æ¼”æ§åˆ¶å°</span>
            <button onclick="saveTheaterSettings()" style="color:#007AFF;">ä¿å­˜</button>
        </div>
        
        <!-- ç®€å•çš„ Tab åˆ‡æ¢ -->
        <div class="theater-tabs">
            <div class="t-tab active" onclick="switchTheaterTab('tab-connect')">è¿æ¥</div>
            <div class="t-tab" onclick="switchTheaterTab('tab-presets')">é¢„è®¾</div>
            <div class="t-tab" onclick="switchTheaterTab('tab-styles')">æ–‡é£</div>
            <div class="t-tab" onclick="switchTheaterTab('tab-modules')">å‰§åœº</div>
            <div class="t-tab" onclick="switchTheaterTab('tab-world')">ä¸–ç•Œ</div>
            <div class="t-tab" onclick="switchTheaterTab('tab-regex')">æ­£åˆ™</div>
        </div>

        <div class="modal-body" style="background: #111; padding: 15px;">
            
            <!-- Tab 1: ç‹¬ç«‹è¿æ¥ -->
            <div id="tab-connect" class="t-tab-content" style="display:block;">
                <div id="theaterApiPresetManager" style="background:#2a2a2a; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #444;">
        <div style="font-size:12px; color:#aaa; margin-bottom:5px; display:flex; justify-content:space-between;">
            <span>API é…ç½®é¢„è®¾åº“</span>
            <span style="font-size:10px; color:#666;">URL + Key + Model</span>
        </div>
        <div style="display:flex; gap:10px;">
            <select id="t-api-preset-select" class="t-input" style="margin-bottom:0; flex:1; background:#1a1a1a; border-color:#555;" onchange="applyTheaterApiPreset()">
                <option value="">-- é€‰æ‹©é¢„è®¾ --</option>
            </select>
            <button onclick="saveTheaterApiPreset()" style="background:#333; border:1px solid #007AFF; color:#007AFF; width:50px; border-radius:6px; cursor:pointer;">å¦å­˜</button>
            <button onclick="deleteTheaterApiPreset()" style="background:#333; border:1px solid #ff3b30; color:#ff3b30; width:50px; border-radius:6px; cursor:pointer;">åˆ é™¤</button>
        </div>
    </div>
                <div class="t-group-title">ç‹¬ç«‹ API è®¾ç½® (ä»…å‰§åœºç”Ÿæ•ˆ)</div>
                
                <input type="text" id="t-api-url" class="t-input" placeholder="API URL (ä¾‹å¦‚: https://api.openai.com/v1)">
                
                <input type="password" id="t-api-key" class="t-input" placeholder="sk-...">
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="fetchTheaterModels()" style="flex:1; padding:12px; background:#333; color:#fff; border:1px solid #444; border-radius:8px; cursor:pointer; font-size:14px; transition:0.2s;">
                        â¬‡ï¸ æ‹‰å–æ¨¡å‹
                    </button>
                    <button onclick="testTheaterConnection()" style="flex:1; padding:12px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:14px; transition:0.2s;">
                        âœ… æµ‹è¯•è¿æ¥
                    </button>
                </div>

                <div id="t-model-select-box" style="display:none; margin-bottom:10px;">
                    <select id="t-model-select" class="t-input" onchange="document.getElementById('t-model').value = this.value" style="background:#222; border-color:#007AFF;">
                        </select>
                </div>

                <input type="text" id="t-model" class="t-input" placeholder="Model ID (æ¨è Claude 3.5 / GPT-4)">
                
                <div class="t-tip" style="margin-top:10px; opacity:0.6;">
                    * å¦‚æœç•™ç©ºï¼Œå°†é»˜è®¤ä½¿ç”¨æ‰‹æœºå…¨å±€è®¾ç½®ã€‚<br>
                    * å…ˆå¡« Keyï¼Œç‚¹â€œæ‹‰å–æ¨¡å‹â€ï¼Œé€‰å¥½åç‚¹â€œæµ‹è¯•è¿æ¥â€ã€‚
                </div>
            </div>

            <!-- Tab 2: é¢„è®¾å¯¼å…¥ (æ ¸å¿ƒ) -->
            <div id="tab-presets" class="t-tab-content">
                
                <!-- âœ¨ æ–°å¢ï¼šé¢„è®¾ç®¡ç†åŒº âœ¨ -->
                <div class="t-group-title">æˆ‘çš„é¢„è®¾åº“ (è§„åˆ™+æ–‡é£+æ­£åˆ™)</div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="saved-preset-select" class="t-input" style="margin-bottom:0; flex:1;" onchange="applySavedPreset()">
                        <option value="">-- é€‰æ‹©é¢„è®¾ --</option>
                    </select>
                    <button onclick="doSavePreset()" style="background:#222; border:1px solid #007AFF; color:#007AFF; width:40px; border-radius:6px;">å¦å­˜ä¸º</button>
                    <button onclick="doDeletePreset()" style="background:#222; border:1px solid #ff3b30; color:#ff3b30; width:40px; border-radius:6px;">åˆ é™¤</button>
                </div>
                <hr style="border:0; border-top:1px solid #333; margin-bottom:15px;">

                <div class="t-group-title">å¯¼å…¥æ–°æ–‡ä»¶ (JSON)</div>
                <div class="t-upload-box" onclick="document.getElementById('theaterPresetInput').click()">
                    ç‚¹å‡»ä¸Šä¼  .json æ–‡ä»¶
                </div>
                <input type="file" id="theaterPresetInput" accept=".json" hidden onchange="handleTheaterImport(event)">
                
                <div class="t-group-title">å½“å‰åŠ è½½</div>
                <div id="t-current-preset-name" style="color:#007AFF; margin-bottom:10px;">æ— </div>
                
                <div class="t-group-title">æ ¸å¿ƒè§„åˆ™ (Core)</div>
                <div id="t-core-list" class="t-toggle-list">
                    <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- Tab 3: æ–‡é£é€‰æ‹© -->
            <div id="tab-styles" class="t-tab-content">
                <div class="t-group-title">æ–‡é£æ»¤é•œ (å•é€‰)</div>
                <div id="t-style-list" class="t-radio-list">
                    <div style="color:#666; font-size:12px;">è¯·å…ˆåœ¨â€œé¢„è®¾â€é¡µå¯¼å…¥æ–‡ä»¶...</div>
                </div>
            </div>

            <!-- Tab 4: å°å‰§åœºå¼€å…³ -->
            <div id="tab-modules" class="t-tab-content">
                <div class="t-group-title">ç‰¹æ®Šå‰§åœºæ¨¡å¼ (å¼€å…³)</div>
                <div id="t-module-list" class="t-toggle-list">
                    <div style="color:#666; font-size:12px;">è¯·å…ˆåœ¨â€œé¢„è®¾â€é¡µå¯¼å…¥æ–‡ä»¶...</div>
                </div>
            </div>
            <div id="tab-world" class="t-tab-content">
                <div class="t-group-title">æˆ‘çš„ä¸–ç•Œè§‚å­˜æ¡£</div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="saved-world-select" class="t-input" style="margin-bottom:0; flex:1;" onchange="applySavedWorld()">
                        <option value="">-- é€‰æ‹©ä¸–ç•Œä¹¦ --</option>
                    </select>
                    <button onclick="doSaveWorld()" style="background:#222; border:1px solid #007AFF; color:#007AFF; width:40px; border-radius:6px;">å¦å­˜ä¸º</button>
                    <button onclick="doDeleteWorld()" style="background:#222; border:1px solid #ff3b30; color:#ff3b30; width:40px; border-radius:6px;">åˆ é™¤</button>
                </div>
                <hr style="border:0; border-top:1px solid #333; margin-bottom:15px;">
                <div class="t-group-title">ä¸–ç•Œä¹¦è¯æ¡ (ç‚¹å‡»æ–‡å­—=å¼ºåˆ¶æ¿€æ´»)</div>
                <div class="t-upload-box" style="margin-bottom:10px; padding:10px; font-size:12px;" onclick="document.getElementById('importWorldInput').click()">
                    ğŸ“‚ å¯¼å…¥ä¸–ç•Œä¹¦ (.json)
                </div>
                <input type="file" id="importWorldInput" accept=".json" hidden onchange="handleWorldImport(event)">
                <div style="font-size:10px; color:#666; margin-bottom:10px;">
                    ç°è‰²=æœªå¯ç”¨ | ç™½è‰²=å¾…æœº | <span style="color:#34c759">ç»¿è‰²=å·²è§¦å‘</span> | <span style="color:#ffcc00">é»„è‰²=å¼ºåˆ¶å¸¸é©»</span>
                </div>
                <div id="t-world-list" class="t-toggle-list" style="max-height:300px; overflow-y:auto;">
                    <div class="t-tip">è¯·å…ˆåœ¨â€œé¢„è®¾â€é¡µå¯¼å…¥åŒ…å« World Info çš„æ–‡ä»¶...</div>
                </div>
            </div>
            <div id="tab-regex" class="t-tab-content">
                <div class="t-group-title">æ­£åˆ™è„šæœ¬ (Regex Scripts)</div>
                <div class="t-upload-box" style="margin-bottom:10px; padding:10px; font-size:12px;" onclick="document.getElementById('importRegexInput').click()">
                    ğŸ“‚ å¯¼å…¥æ­£åˆ™è„šæœ¬ (.json)
                </div>
                <input type="file" id="importRegexInput" accept=".json" hidden onchange="handleRegexImport(event)">
                <div style="font-size:10px; color:#666; margin-bottom:10px;">
                    è·Ÿéšé¢„è®¾è‡ªåŠ¨å¯¼å…¥ã€‚ç”¨äºæ¸…æ´—æ–‡æœ¬æˆ–æ›¿æ¢å…³é”®è¯ã€‚
                </div>
                <div id="t-regex-list" class="t-toggle-list" style="max-height:300px; overflow-y:auto;">
                    <div class="t-tip">æš‚æ— è„šæœ¬</div>
                </div>
            </div>

        </div>
    </div>
</div>
        <!-- ============ 20. ç›¸å†Œä¸»é¡µ (Gallery) ============ -->
<div class="page" id="page-gallery" style="background: #fff;">
    <div class="app-header" style="background: rgba(255,255,255,0.9);">
        <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
        <span class="app-title">ç›¸å†Œ</span>
        <!-- ä¸Šä¼ æŒ‰é’® -->
        <button class="btn-icon-only" onclick="openPhotoUploadModal()" style="font-size:24px;">+</button>
    </div>
    
    <div class="content-scroll">
        <!-- ç…§ç‰‡ç€‘å¸ƒæµ/ç½‘æ ¼ -->
        <div id="gallery-grid" class="gallery-grid">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="height: 50px;"></div>
    </div>
</div>

<!-- ============ 21. ç›¸å†Œè¯¦æƒ…é¡µ (å¤§å›¾ + AIè¯„ä»·) ============ -->
<div class="page" id="page-gallery-detail" style="background: #000; z-index: 60;">
    <div class="gallery-detail-container">
        <!-- é¡¶éƒ¨è¿”å› -->
        <button class="gallery-close-btn" onclick="closePhotoDetail()">Ã—</button>
        
        <!-- å›¾ç‰‡åŒºåŸŸ (ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹è¯„ä»·) -->
        <div class="photo-card-scene" onclick="togglePhotoFlip()">
            <div class="photo-card" id="photo-flip-card">
                <!-- æ­£é¢ï¼šå›¾ -->
                <div class="photo-face front">
                    <img id="detail-photo-img" src="" class="detail-img">
                    <div class="detail-caption-bar" id="detail-caption">ç”¨æˆ·å†™çš„æ–‡æ¡ˆ...</div>
                </div>
                <!-- èƒŒé¢ï¼šAI è¯„ä»· -->
                <div class="photo-face back">
                    <div class="btn-del-photo" onclick="event.stopPropagation(); deleteCurrentPhoto()">X</div>
                    <div class="ai-comment-box">
                        <div class="ai-comment-header">
                            <img id="detail-ai-avatar" src="" style="width:30px;height:30px;border-radius:50%;">
                            <span id="detail-ai-name" style="font-weight:bold;margin-left:8px;color:#333;">AI</span>
                        </div>
                        <div class="ai-comment-text" id="detail-ai-text">
                            æ­£åœ¨ç”Ÿæˆè¯„ä»·...
                        </div>
                        <div class="ai-tags-area" id="detail-ai-tags">
                            <!-- æ ‡ç­¾ -->
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:20px; text-align:center;">
                            (è¿™äº›æ˜¯ AI è®°ä½çš„å…³é”®è¯)
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="gallery-tip">ç‚¹å‡»ç…§ç‰‡æŸ¥çœ‹ Ta çš„æƒ³æ³•</div>
    </div>
</div>

<!-- ============ 22. å‘å¸ƒç…§ç‰‡å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-upload-photo">
    <div class="modal-box" style="height:auto; top:20%;">
        <div class="modal-header">å‘å¸ƒåŠ¨æ€</div>
        <div class="modal-body" style="padding:15px;">
            <input type="file" id="gallery-file-input" accept="image/*" hidden onchange="previewGalleryUpload(event)">
            
            <!-- é¢„è§ˆåŒº -->
            <div onclick="document.getElementById('gallery-file-input').click()" 
                 style="width:100%; height:200px; background:#f2f2f7; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer; border:1px dashed #ccc;">
                <img id="gallery-preview-img" style="width:100%; height:100%; object-fit:contain; display:none;">
                <span id="gallery-upload-tip" style="color:#999;">ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</span>
            </div>

            <!-- é…æ–‡ -->
            <textarea id="gallery-caption-input" class="ios-input" rows="3" 
                      style="width:100%; border:1px solid #eee; margin-top:15px; border-radius:8px; padding:10px;" 
                      placeholder="è¯´ç‚¹ä»€ä¹ˆå§... "></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-upload-photo')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="submitPhotoPost()" id="btn-submit-photo" style="color:#007AFF; font-weight:bold;">å‘å¸ƒ</button>
        </div>
    </div>
</div>
        <!-- ============ 23. æ”¾æ˜ å®¤ (Cinema) é¦–é¡µ ============ -->
<div class="page" id="page-cinema" style="background: #121212; color: white;">
    <div class="app-header" style="background: rgba(20,20,20,0.9); border-bottom: 1px solid #333;">
        <button class="btn-icon-text" onclick="goHome()" style="color:#fff;">â€¹ æ¡Œé¢</button>
        <span class="app-title" style="color:#fff;">æ”¾æ˜ å®¤</span>
        <button class="btn-icon-only" onclick="openCinemaSync()" style="color:#007AFF; font-size:20px;">ğŸ”„</button>
        <button class="btn-icon-only" onclick="openAddSeriesModal()" style="color:#fff; font-size:24px;">+</button>
    </div>
    
    <div class="content-scroll" style="padding: 15px;">
        <!-- å‰§é›†æµ·æŠ¥ç½‘æ ¼ -->
        <div id="cinema-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="text-align:center; color:#555; margin-top:50px; font-size:12px;">
            æ”¯æŒä¸Šä¼  MP4 è§†é¢‘ + SRT å­—å¹•<br>æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°
        </div>
    </div>
</div>

<!-- ============ 24. æ’­æ”¾è¯¦æƒ…é¡µ (Player) ============ -->
<div class="page" id="page-cinema-detail" style="background: #000; color: white;">
    <!-- é¡¶éƒ¨ï¼šå‰§åä¸è¿”å› -->
    <div style="position:absolute; top:0; left:0; width:100%; height:60px; z-index:10; background:linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); display:flex; align-items:center; padding:0 15px; padding-top:10px;">
        <button onclick="exitCinemaPlayer()" style="background:none; border:none; color:#fff; font-size:18px;">â€¹ è¿”å›</button>
        <span id="player-title" style="flex:1; text-align:center; font-weight:bold; margin:0 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></span>
        <!-- å‰§é›†åˆ—è¡¨å¼€å…³ -->
        <button onclick="openCinemaShareModal()" style="background:none; border:none; color:#34c759; font-size:22px; margin-right:10px;">ğŸ“¤</button>
        <button onclick="toggleEpDrawer()" style="background:none; border:none; color:#fff; font-size:20px;">â˜°</button>
    </div>

    <!-- è§†é¢‘å®¹å™¨ -->
    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative;">
        <video id="cinema-video" style="width:100%; max-height:100%;" playsinline webkit-playsinline controls>
            <track id="cinema-track" kind="subtitles" srclang="zh" label="Chinese" default>
        </video>
        
        <!-- è‡ªå®šä¹‰å­—å¹•å±‚ (ä¸ºäº†æ–¹ä¾¿æŠ“å–å†…å®¹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è‡ªå·±æ¸²æŸ“å­—å¹•ï¼Œä¹Ÿå¯ä»¥ç”¨åŸç”Ÿtrackï¼Œè¿™é‡Œå…ˆç”¨åŸç”Ÿ) -->
    </div>

    <!-- AI é™ªçœ‹æ‚¬æµ®çƒ -->
    <div id="cinema-ai-bubble" onclick="openCinemaChat()" 
         style="position:absolute; bottom:100px; right:20px; width:50px; height:50px; border-radius:50%; background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:20;">
        <img id="cinema-ai-avatar" src="" style="width:40px; height:40px; border-radius:50%; opacity:0.9;">
    </div>

    <!-- å‰§é›†é€‰é›†æŠ½å±‰ (æ›´æ–°ç‰ˆ) -->
<div id="cinema-ep-drawer" style="position:absolute; right:0; top:0; bottom:0; width:280px; background:rgba(20,20,20,0.95); transform:translateX(100%); transition:transform 0.3s; z-index:30; padding-top:60px; display:flex; flex-direction:column; box-shadow: -5px 0 20px rgba(0,0,0,0.5);">
    <div style="padding:15px; font-weight:bold; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
        <span>é€‰é›†åˆ—è¡¨</span>
        <button onclick="toggleEpDrawer()" style="background:none; border:none; color:#999; font-size:20px;">Ã—</button>
    </div>
    
    <div id="cinema-ep-list" style="flex:1; overflow-y:auto;">
        <!-- åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
    </div>

    <div style="padding:15px; border-top:1px solid #333;">
        <!-- 1. è§†é¢‘ä¸Šä¼ æŒ‰é’® (åªä¼ MP4) -->
        <button onclick="document.getElementById('upload-video-only').click()" style="width:100%; padding:12px; background:#007AFF; border:none; border-radius:8px; color:#fff; font-weight:bold;">+ ä¸Šä¼ æ–°ä¸€é›† (è§†é¢‘)</button>
        <input type="file" id="upload-video-only" hidden accept=".mp4,.mkv,.mov" onchange="handleVideoUploadOnly(event)">
        
        <!-- 2. å­—å¹•ä¸Šä¼ é€šé“ (éšè—ï¼Œç”±åˆ—è¡¨é‡Œçš„æŒ‰é’®è§¦å‘) -->
        <input type="file" id="upload-sub-only" hidden accept=".srt,.vtt,application/x-subrip,text/vtt,text/plain" onchange="handleSubtitleUploadOnly(event)">
    </div>
</div>
</div>

<!-- æ–°å»º/ç¼–è¾‘ å‰§é›†å¼¹çª— -->
<div class="modal-overlay" id="modal-add-series">
    <div class="modal-box">
        <div class="modal-header">å‰§é›†ç®¡ç†</div>
        <div class="modal-body" style="padding:15px;">
            <!-- âœ¨ æ–°å¢ï¼šéšè—åŸŸï¼Œç”¨äºå­˜å‚¨å½“å‰ç¼–è¾‘çš„å‰§é›†ID -->
            <input type="hidden" id="series-edit-id">
            
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">å‰§å</span>
                    <input type="text" id="series-name-input" class="ios-input" placeholder="ä¾‹å¦‚: ç”„å¬›ä¼ ">
                </div>
                <div class="ios-item">
                    <span class="ios-label">æµ·æŠ¥</span>
                    <input type="text" id="series-cover-input" class="ios-input" placeholder="å›¾ç‰‡ URL">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-add-series')">å–æ¶ˆ</button>
            <!-- âœ¨ ä¿®æ”¹ï¼šç‚¹å‡»è°ƒç”¨ saveSeriesData è€Œä¸æ˜¯ createNewSeries -->
            <button class="modal-btn" onclick="saveSeriesData()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- é™ªçœ‹èŠå¤©å¼¹çª— -->
<div class="modal-overlay" id="modal-cinema-chat" style="justify-content:flex-end; background:rgba(0,0,0,0);">
    <div class="modal-box" style="width:100%; height:60%; border-bottom-left-radius:0; border-bottom-right-radius:0; background:rgba(20,20,20,0.95); color:#fff;">
        <div class="modal-header" style="background:transparent; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span>ä¸ <span id="cinema-chat-name">AI</span> è®¨è®ºå‰§æƒ…</span>
            <button onclick="closeCinemaChat()" style="color:#fff; background:none; border:none;">â†“</button>
        </div>
        <div id="cinema-chat-history" style="flex:1; overflow-y:auto; padding:15px;"></div>
        <div class="input-area" style="background:transparent; border-top:1px solid #333;">
            <div class="input-toolbar">
                <input type="text" id="cinemaChatInput" placeholder="è·ŸTaè¯´äº›ä»€ä¹ˆå§..." style="flex:1; background:#333; color:#fff; border:none; padding:10px; border-radius:20px;">
                <button class="btn-send" onclick="sendCinemaMsg()">â¬†</button>
            </div>
        </div>
    </div>
</div>
        <!-- æ”¾æ˜ å®¤æ•°æ®åŒæ­¥å¼¹çª— -->
<div class="modal-overlay" id="modal-cinema-sync">
    <div class="modal-box">
        <div class="modal-header">æ”¾æ˜ å®¤æ•°æ®å¤‡ä»½/åŒæ­¥</div>
        <div class="modal-body" style="padding:20px;">
            <div class="t-group-title" style="margin-top:0;">å¯¼å‡º (å¤‡ä»½)</div>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">
                å°†å¯¼å‡ºï¼šå‰§é›†åˆ—è¡¨ã€AIæ€»ç»“ã€å­—å¹•ã€èŠå¤©è®°å½•ã€‚<br>
                <span style="color:#ff3b30;">æ³¨æ„ï¼šä¸åŒ…å«è§†é¢‘æ–‡ä»¶æœ¬èº«ï¼ˆä½“ç§¯å¤ªå¤§ï¼‰ã€‚</span><br>
                è¯·æ‰‹åŠ¨ä¼ è¾“ MP4 æ–‡ä»¶ï¼Œå¯¼å…¥åé‡æ–°å…³è”å³å¯ã€‚
            </div>
            <button onclick="exportCinemaData()" class="ios-btn" style="border-radius:8px; margin-bottom:20px;">å¯¼å‡ºæ•°æ®æ–‡ä»¶ (.json)</button>

            <div class="t-group-title">å¯¼å…¥ (æ¢å¤)</div>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">
                å¯¼å…¥ .json å¤‡ä»½æ–‡ä»¶ã€‚å°†åˆå¹¶èŠå¤©è®°å½•å’Œæ€»ç»“ã€‚
            </div>
            <button onclick="document.getElementById('import-cinema-file').click()" class="ios-btn" style="border-radius:8px; color:#007AFF;">å¯¼å…¥æ•°æ®</button>
            <input type="file" id="import-cinema-file" hidden accept=".json" onchange="importCinemaData(event)">
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-cinema-sync')">å…³é—­</button>
        </div>
    </div>
</div>
        <!-- ============ æ”¾æ˜ å®¤åˆ†äº«é€‰æ‹©å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-cinema-share">
    <div class="modal-box">
        <div class="modal-header">åˆ†äº«è§‚å½±äº’åŠ¨</div>
        <div class="modal-body" style="padding: 20px;">
            <p style="font-size:13px; color:#666; margin-bottom:15px;">
                é€‰æ‹©è¦åŒæ­¥åˆ°ä¸»èŠå¤©æ¡†çš„äº’åŠ¨è®°å½•èŒƒå›´ã€‚<br>
                (ä¾‹å¦‚: ç”µè„‘ä¸Šçœ‹çš„å†…å®¹ï¼Œå¯¼å…¥æ‰‹æœºååœ¨æ­¤åŒæ­¥)
            </p>
            
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">å¼€å§‹ (#)</span>
                    <input type="number" id="share-start-idx" class="ios-input" value="1">
                </div>
                <div class="ios-item">
                    <span class="ios-label">ç»“æŸ (#)</span>
                    <input type="number" id="share-end-idx" class="ios-input" value="100">
                </div>
            </div>
            
            <div style="text-align:center; font-size:12px; color:#999; margin-top:10px;">
                æœ¬é›†å…±æœ‰ <span id="share-total-count">0</span> æ¡äº’åŠ¨
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-cinema-share')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmCinemaShare()" style="color:#007AFF; font-weight:bold;">åŒæ­¥åˆ°èŠå¤©</button>
        </div>
    </div>
</div>
        <!-- ============ ğŸ’– çºªå¿µæ—¥/å€’è®¡æ—¶å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-anniversary-list">
    <div class="modal-box" style="height: 70%; background: #f2f2f7;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff;">
            <button onclick="closeModal('modal-anniversary-list')" style="border:none; background:none; color:#007AFF;">å…³é—­</button>
            <span style="font-weight:bold;">çºªå¿µæ—¥ & å€’è®¡æ—¶</span>
            <button onclick="openEditAnniversary(-1)" style="border:none; background:none; color:#007AFF; font-size:24px;">+</button>
        </div>
        
        <div class="modal-body" style="padding: 15px;">
            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="anni-list-container" class="anni-grid">
                <!-- åŠ¨æ€ç”Ÿæˆå°ç»„ä»¶ -->
            </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
                AI ä¼šè‡ªåŠ¨æ„ŸçŸ¥è¿™é‡Œçš„æ—¥æœŸ<br>å¹¶åœ¨èŠå¤©ä¸­ç»™ä½ æƒŠå–œ
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘ çºªå¿µæ—¥ å¼¹çª— -->
<div class="modal-overlay" id="modal-edit-anni" style="z-index: 600;">
    <div class="modal-box" style="height: auto; top: 20%;">
        <div class="modal-header">æ·»åŠ çºªå¿µæ—¥</div>
        <div class="modal-body" style="padding: 20px;">
            <input type="hidden" id="anni-edit-index">
            
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">æ ‡é¢˜</span>
                    <input type="text" id="anni-title-input" class="ios-input" placeholder="ä¾‹å¦‚: æˆ‘ä»¬åœ¨ä¸€èµ·, ä½ çš„ç”Ÿæ—¥">
                </div>
                <div class="ios-item">
                    <span class="ios-label">æ—¥æœŸ</span>
                    <input type="date" id="anni-date-input" class="ios-input" style="direction:ltr;">
                </div>
            </div>
            
            <div style="font-size:12px; color:#999; margin-top:10px; padding:0 10px;">
                * å¦‚æœæ—¥æœŸåœ¨è¿‡å»ï¼Œæ˜¾ç¤ºâ€œå·²ç»xxå¤©â€<br>
                * å¦‚æœæ—¥æœŸåœ¨æœªæ¥ï¼Œæ˜¾ç¤ºâ€œè¿˜æœ‰xxå¤©â€
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-edit-anni')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="saveAnniversary()" style="color:#ff2d55; font-weight:bold;">ä¿å­˜</button>
        </div>
    </div>
</div>
        <!-- ============ ğŸ”® å‘½è¿å±‹ (å¡”ç½—/æ˜Ÿåº§) å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-mystic">
    <div class="modal-box mystic-bg" style="height: 85%; max-height: 700px; border: 1px solid #4a3b59;">
        <div class="modal-header" style="background: transparent; border-bottom: 1px solid rgba(255,255,255,0.1); color: #d4a373;">
            <button onclick="closeModal('modal-mystic')" style="color: #fff; background:none; border:none;">å…³é—­</button>
            <span>å‘½è¿å±‹ Mystic Lab</span>
            <span style="width:30px"></span>
        </div>
        
        <!-- é¡¶éƒ¨åˆ‡æ¢ -->
        <div class="mystic-tabs">
            <button class="mystic-tab-btn active" onclick="switchMysticTab('tarot')" id="btn-tab-tarot">ğŸ´ å¡”ç½—å åœ</button>
            <button class="mystic-tab-btn" onclick="switchMysticTab('horoscope')" id="btn-tab-horoscope">ğŸŒŒ æ˜Ÿåº§è¿åŠ¿</button>
        </div>

        <div class="modal-body" style="background: transparent; padding: 0;">
            
            <!-- Tab 1: å¡”ç½—ç‰Œ -->
            <div id="view-tarot" style="display: block;">
                <div class="tarot-table">
                    <input type="text" id="tarot-question" class="tarot-question-input" placeholder="è¯·åœ¨è¿™é‡Œé»˜å¿µä½ çš„é—®é¢˜... (ä¾‹å¦‚: æˆ‘å’Œä»–æœ€è¿‘çš„å‘å±•?)">
                    
                    <!-- ç‰Œæ¡Œ (æ´—ç‰Œå‰æ˜¾ç¤ºèƒŒé¢ï¼ŒæŠ½ç‰Œåæ˜¾ç¤º) -->
                    <div class="tarot-deck-area" id="tarot-spread-area">
                        <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                        <div style="color:rgba(255,255,255,0.5); margin-top:20px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ´—ç‰Œ</div>
                    </div>

                    <div style="margin-top: 30px; width: 100%;">
                        <button id="btn-tarot-action" class="mystic-btn-main" onclick="startTarotFlow()">ğŸ”® æ´—ç‰Œå¹¶æŠ½ç‰Œ (3å¼ )</button>
                        <div class="mystic-desc">AI å°†æ‰®æ¼”å¡”ç½—å¸ˆï¼Œç»“åˆç‰Œé¢ä¸ä½ çš„äººé™…å…³ç³»è¿›è¡Œè§£è¯»</div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: æ˜Ÿåº§ (æ›´æ–°ç‰ˆï¼šåŒ…å«æ·±åº¦æ˜Ÿç›˜) -->
<div id="view-horoscope" style="display: none;">
    
    <!-- å­åŠŸèƒ½åˆ‡æ¢å¼€å…³ -->
    <div style="display:flex; justify-content:center; gap:10px; margin:15px 0;">
        <button class="ios-btn" onclick="toggleHoroSubTab('match')" style="padding:5px 15px; font-size:13px; background:rgba(255,255,255,0.1); color:#fff; border-radius:15px;">æ‹çˆ±åˆç›˜</button>
        <button class="ios-btn" onclick="toggleHoroSubTab('chart')" style="padding:5px 15px; font-size:13px; background:rgba(255,255,255,0.1); color:#fff; border-radius:15px;">æ·±åº¦æ˜Ÿç›˜</button>
    </div>

    <!-- 1. åŸºç¡€åˆç›˜ (åŸæ¥çš„åŠŸèƒ½) -->
    <div id="horo-sub-match">
        <div class="zodiac-container">
            <div class="zodiac-row">
                <div>
                    <div style="font-size:16px; font-weight:bold; color:#fff;">æˆ‘çš„æ˜Ÿåº§</div>
                    <div style="font-size:12px; color:#aaa;">(ç”¨æˆ·)</div>
                </div>
                <!-- æ³¨æ„ï¼šè¿™é‡ŒåŠ äº† onchange åŒæ­¥ç»™ä¸‹é¢çš„æ˜Ÿç›˜ -->
                <select id="user-zodiac" class="zodiac-select" onchange="syncZodiacToChart()">
                    <option value="">--è¯·é€‰æ‹©--</option>
                    <option value="ç™½ç¾Šåº§">â™ˆ ç™½ç¾Šåº§</option>
                    <option value="é‡‘ç‰›åº§">â™‰ é‡‘ç‰›åº§</option>
                    <option value="åŒå­åº§">â™Š åŒå­åº§</option>
                    <option value="å·¨èŸ¹åº§">â™‹ å·¨èŸ¹åº§</option>
                    <option value="ç‹®å­åº§">â™Œ ç‹®å­åº§</option>
                    <option value="å¤„å¥³åº§">â™ å¤„å¥³åº§</option>
                    <option value="å¤©ç§¤åº§">â™ å¤©ç§¤åº§</option>
                    <option value="å¤©èåº§">â™ å¤©èåº§</option>
                    <option value="å°„æ‰‹åº§">â™ å°„æ‰‹åº§</option>
                    <option value="æ‘©ç¾¯åº§">â™‘ æ‘©ç¾¯åº§</option>
                    <option value="æ°´ç“¶åº§">â™’ æ°´ç“¶åº§</option>
                    <option value="åŒé±¼åº§">â™“ åŒé±¼åº§</option>
                </select>
            </div>

            <div class="zodiac-row">
                <div>
                    <div style="font-size:16px; font-weight:bold; color:#fff;" id="mystic-char-name">Ta çš„æ˜Ÿåº§</div>
                    <div style="font-size:12px; color:#aaa;">(è§’è‰²)</div>
                </div>
                <select id="char-zodiac" class="zodiac-select" onchange="syncZodiacToChart()">
                    <option value="">--æœªçŸ¥--</option>
                    <option value="ç™½ç¾Šåº§">â™ˆ ç™½ç¾Šåº§</option>
                    <option value="é‡‘ç‰›åº§">â™‰ é‡‘ç‰›åº§</option>
                    <option value="åŒå­åº§">â™Š åŒå­åº§</option>
                    <option value="å·¨èŸ¹åº§">â™‹ å·¨èŸ¹åº§</option>
                    <option value="ç‹®å­åº§">â™Œ ç‹®å­åº§</option>
                    <option value="å¤„å¥³åº§">â™ å¤„å¥³åº§</option>
                    <option value="å¤©ç§¤åº§">â™ å¤©ç§¤åº§</option>
                    <option value="å¤©èåº§">â™ å¤©èåº§</option>
                    <option value="å°„æ‰‹åº§">â™ å°„æ‰‹åº§</option>
                    <option value="æ‘©ç¾¯åº§">â™‘ æ‘©ç¾¯åº§</option>
                    <option value="æ°´ç“¶åº§">â™’ æ°´ç“¶åº§</option>
                    <option value="åŒé±¼åº§">â™“ åŒé±¼åº§</option>
                </select>
            </div>

            <button class="mystic-btn-main" onclick="analyzeHoroscope()">åˆ†æä»Šæ—¥å¥‘åˆåº¦</button>
        </div>
    </div>

    <!-- 2. æ·±åº¦æ˜Ÿç›˜ (æ–°åŠŸèƒ½) -->
    <div id="horo-sub-chart" style="display:none; padding: 0 20px;">
        
        <!-- ç”¨æˆ·æ˜Ÿç›˜é…ç½® -->
        <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1);">
            <div style="font-weight:bold; color:#d4a373; margin-bottom:10px;">æˆ‘çš„æ˜Ÿç›˜ (ä¸‰å¤§é¡¹)</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸŒ å¤ªé˜³</div>
                    <input type="text" id="chart-user-sun" class="zodiac-select" style="width:100%" placeholder="é€‰å¡«">
                </div>
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸŒ› æœˆäº®</div>
                    <input type="text" id="chart-user-moon" class="zodiac-select" style="width:100%" placeholder="é€‰å¡«">
                </div>
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸ¹ ä¸Šå‡</div>
                    <input type="text" id="chart-user-rising" class="zodiac-select" style="width:100%" placeholder="é€‰å¡«">
                </div>
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px;">* ä¸çŸ¥é“çš„å¯ä»¥ç•™ç©ºï¼ŒAI ä¼šæ¨¡ç³Šåˆ†æ</div>
        </div>

        <!-- è§’è‰²æ˜Ÿç›˜é…ç½® -->
        <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.1);">
            <div style="display:flex; justify-content:space-between;">
                <div style="font-weight:bold; color:#d4a373; margin-bottom:10px;">Ta çš„æ˜Ÿç›˜</div>
                <button onclick="aiGuessChart()" style="font-size:10px; background:#007AFF; color:#fff; border:none; border-radius:4px; padding:2px 6px; height:20px;">AI æ¨æ¼”</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸŒ å¤ªé˜³</div>
                    <input type="text" id="chart-char-sun" class="zodiac-select" style="width:100%">
                </div>
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸŒ› æœˆäº®</div>
                    <input type="text" id="chart-char-moon" class="zodiac-select" style="width:100%" placeholder="?">
                </div>
                <div>
                    <div style="font-size:10px; color:#aaa;">ğŸ¹ ä¸Šå‡</div>
                    <input type="text" id="chart-char-rising" class="zodiac-select" style="width:100%" placeholder="?">
                </div>
            </div>
        </div>

        <button class="mystic-btn-main" style="background: linear-gradient(to right, #2c3e50, #4ca1af);" onclick="generateFullChartReport()">ğŸ“œ ç”Ÿæˆæ·±åº¦æ˜Ÿè±¡æŠ¥å‘Š</button>
        <div class="mystic-desc">åˆ†æåŒæ–¹æ·±å±‚æ€§æ ¼ã€çµé­‚ä¼´ä¾£æŒ‡æ•°åŠæ½œåœ¨å†²çª</div>
    </div>

</div>
        </div>
    </div>
</div>
        <!-- å¼¹çª— A: åˆ›å»ºå°è¯´é…ç½® (é€‰è§’è‰²ã€å¡« Tag) -->
<div class="modal-overlay" id="modal-create-novel">
    <div class="modal-box" style="height:auto;">
        <div class="modal-header">AI å…±åˆ›å°è¯´</div>
        <div class="modal-body" style="padding:20px;">
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">ä¸»è§’ (CP)</span>
                    <select id="novel-cp-select" class="ios-input" style="direction:rtl;"></select>
                </div>
            </div>
            
            <div class="ios-group-title">å…³é”®è¯ / æ¢— / ç±»å‹</div>
            <textarea id="novel-tags-input" class="ios-input" style="width:100%; height:80px; border:1px solid #eee; padding:10px; border-radius:8px;" placeholder="ä¾‹å¦‚ï¼šABOã€å…ˆå©šåçˆ±ã€ç ´é•œé‡åœ†ã€èµ›åšæœ‹å…‹..."></textarea>
            
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="fillRandomTags()" style="font-size:12px; padding:5px 10px; background:#f0f0f5; border:none; border-radius:15px; color:#5856d6;">ğŸ² å¬å¤©ç”±å‘½</button>
                <button onclick="addTag('ç”œå® ')" style="font-size:12px; padding:5px 10px; background:#f0f0f5; border:none; border-radius:15px;">ğŸ¬ ç”œå® </button>
                <button onclick="addTag('å¼ºå–è±ªå¤º')" style="font-size:12px; padding:5px 10px; background:#f0f0f5; border:none; border-radius:15px;">â›“ï¸ å¼ºå–è±ªå¤º</button>
                <button onclick="addTag('æ— é™æµ')" style="font-size:12px; padding:5px 10px; background:#f0f0f5; border:none; border-radius:15px;">â™¾ï¸ æ— é™æµ</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-create-novel')">å–æ¶ˆ</button>
            <button class="modal-btn" id="btn-gen-outline" onclick="generateOutlines()" style="color:#007AFF; font-weight:bold;">ç”Ÿæˆå¤§çº²</button>
        </div>
    </div>
</div>

<!-- å¼¹çª— B: é€‰æ‹©å¤§çº² (ç±»ä¼¼æ™‹æ±Ÿä¹¦å•) -->
<div class="modal-overlay" id="modal-select-outline">
    <div class="modal-box" style="height:80%; background:#f9f9f9;">
        <div class="modal-header">é€‰æ‹©ä¸€ä¸ªå‰§æœ¬</div>
        <div id="outline-list-container" class="modal-body" style="padding:15px; overflow-y:auto;">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å¤§çº²å¡ç‰‡ -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-select-outline')">è¿”å›ä¿®æ”¹</button>
        </div>
    </div>
</div>
        <!-- ============ ğŸ¤ª è¡¨æƒ…åŒ…å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-stickers" style="align-items: flex-end;">
    <div class="modal-box" style="width: 100%; max-height: 60%; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
        <div class="modal-header" style="padding: 10px 15px; font-size: 14px; color: #999; display: flex; justify-content: space-between;">
            <span>æˆ‘çš„è¡¨æƒ…</span>
            <span id="sticker-delete-hint" style="display:none; color:#ff3b30;">è¯·é€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…</span>
            <button onclick="closeModal('modal-stickers')" style="border:none; background:none; font-size:20px;">Ã—</button>
        </div>
        
        <div class="modal-body" style="padding:0;">
            <div id="sticker-grid-view" class="sticker-grid">
                <!-- åŠ¨æ€ç”Ÿæˆè¡¨æƒ… -->
            </div>
        </div>

        <!-- åº•éƒ¨åŠŸèƒ½æ  -->
        <div class="sticker-footer-tabs" id="sticker-normal-tabs">
            <div class="sticker-tab" onclick="toggleStickerDeleteMode()">ç®¡ç† (åˆ é™¤)</div>
            <div class="sticker-tab" onclick="openStickerImport()">æ‰¹é‡å¯¼å…¥</div>
            <div class="sticker-tab" onclick="addSingleSticker()">æ·»åŠ </div>
        </div>

        <!-- åˆ é™¤æ¨¡å¼ä¸‹çš„åº•éƒ¨æ  (é»˜è®¤éšè—) -->
        <div class="sticker-footer-tabs" id="sticker-delete-tabs" style="display:none;">
            <div class="sticker-tab" onclick="toggleStickerDeleteMode()" style="color:#666">å–æ¶ˆ</div>
            <div class="sticker-tab danger" onclick="confirmDeleteStickers()">ç¡®è®¤åˆ é™¤ (<span id="del-count">0</span>)</div>
        </div>
    </div>
</div>
        <!-- ============ ğŸ“¥ è¡¨æƒ…åŒ…æ‰¹é‡å¯¼å…¥å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-sticker-import" style="z-index: 700;">
    <div class="modal-box" style="height: 60%;">
        <div class="modal-header">æ‰¹é‡å¯¼å…¥è¡¨æƒ…</div>
        <div class="modal-body" style="padding: 15px; display: flex; flex-direction: column;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                è¯·ç²˜è´´æ ¼å¼ï¼šåç§°ï¼šå›¾ç‰‡URL<br>
                (æ”¯æŒä¸­æ–‡/è‹±æ–‡å†’å·ï¼Œä¸€è¡Œä¸€ä¸ª)
            </div>
            <!-- å¤§æ–‡æœ¬æ¡†ï¼Œè¿™å°±ä¸ä¼šæ¼æ•°æ®äº† -->
            <textarea id="sticker-import-textarea" style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-size: 12px; resize: none;" placeholder="ç²˜è´´ä½ çš„åˆ—è¡¨åˆ°è¿™é‡Œ..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-sticker-import')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="processStickerImport()" style="color: #007AFF; font-weight: bold;">å¼€å§‹è¯†åˆ«</button>
        </div>
    </div>
</div>

        <!-- ============ å¼¹çª—ç»„ä»¶ ============ -->

        <!-- 1. æ·»åŠ è§’è‰²å¼¹çª— -->
        <div class="modal-overlay" id="modal-add-char">
            <div class="modal-box">
                <div class="modal-header">æ–°å»ºè”ç³»äºº</div>
                <div class="modal-body">
                    <div class="ios-list" style="margin: 20px 0; background:transparent;">
                        <div class="ios-item" style="background:#fff; border-radius:10px;">
                            <input type="text" id="newCharName" class="ios-input" style="text-align:center;" placeholder="è¾“å…¥è§’è‰²å§“å">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-add-char')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="addNewCharacter()">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- 2. è§’è‰²è®¾ç½®å¼¹çª— (åœ¨èŠå¤©ç•Œé¢è°ƒå‡º) -->
        <div class="modal-overlay" id="modal-chat-settings">
            <div class="modal-box" style="height: 80%;">
                <div class="modal-header">è§’è‰² & èŠå¤©è®¾ç½®</div>
                <div class="modal-body" style="padding: 15px;">
                    
                    <div class="ios-group-title" style="margin-top:0">å¯¹æ–¹ (AI) èµ„æ–™</div>
                    <div class="ios-list">
                        <!-- æ–¹å¼A: æ–‡ä»¶ä¸Šä¼  (ä¿ç•™) -->
        <div class="ios-item" onclick="document.getElementById('charAvatarFile').click()">
            <span class="ios-label">ä¸Šä¼ å¤´åƒ</span>
            <img id="set-char-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto; object-fit:cover;">
            <span style="color:#999; font-size:12px; margin-left:5px;"> > </span>
            <input type="file" id="charAvatarFile" hidden onchange="uploadCharAvatar(event)">
        </div>
        <!-- æ–¹å¼B: URL è¾“å…¥ (æ–°å¢) -->
        <div class="ios-item">
            <span class="ios-label">å›¾ç‰‡é“¾æ¥</span>
            <input type="text" id="set-char-avatar-url" class="ios-input" placeholder="ç²˜è´´ URL (æ¨è,ä¸å ç©ºé—´)" onchange="updateCharAvatarFromUrl()">
        </div>
                        <div class="ios-item">
                            <span class="ios-label">å§“å</span>
                            <input type="text" id="set-char-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <!-- æ–°å¢ï¼šä¸»åŠ¨æ‹›å‘¼è®¾ç½® -->
                        <div class="ios-item">
                            <span class="ios-label">ä¸»åŠ¨å‘æ¶ˆæ¯</span>
                            <select id="set-char-interval" class="ios-input" style="direction: rtl;" onchange="saveCurrentCharSettings()">
                                <option value="0">ä»ä¸</option>
                                <option value="2">è¶…è¿‡ 2 å°æ—¶</option>
                                <option value="6">è¶…è¿‡ 6 å°æ—¶</option>
                                <option value="12">è¶…è¿‡ 12 å°æ—¶ (åŠå¤©)</option>
                                <option value="24">è¶…è¿‡ 24 å°æ—¶ (ä¸€å¤©)</option>
                                <option value="48">è¶…è¿‡ 48 å°æ—¶ (ä¸¤å¤©)</option>
                            </select>
                        </div>
                        <!-- åŸæœ‰çš„â€œä¸»åŠ¨å‘æ¶ˆæ¯â€åœ¨ä¸Šé¢ -->
<div class="ios-item">
    <span class="ios-label">è¯­è¨€æ¨¡å¼</span>
    <select id="set-char-lang" class="ios-input" style="direction: rtl;" onchange="saveCurrentCharSettings()">
        <option value="zh">ä¸­/ä¸­ (é»˜è®¤ä¸­æ–‡)</option>
        <option value="en">è‹±/ä¸­ (AIè‹±è¯­+ç¿»è¯‘)</option>
    </select>
</div>
<!-- ä¸‹é¢æ¥åŸæ¥çš„â€œAI è®¾å®šâ€ -->
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">AI è®¾å®š (System Prompt)</span>
                            <textarea id="set-char-prompt" class="ios-input" style="text-align:left; width:100%; height:80px; border:1px solid #eee; padding:5px; border-radius:5px;" onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">æˆ‘çš„èµ„æ–™ (åœ¨æ­¤èŠå¤©ä¸­)</div>
                    <div class="ios-list">
                        <!-- æ–¹å¼A -->
        <div class="ios-item" onclick="document.getElementById('userAvatarFile').click()">
            <span class="ios-label">ä¸Šä¼ å¤´åƒ</span>
            <img id="set-user-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto; object-fit:cover;">
            <span style="color:#999; font-size:12px; margin-left:5px;"> > </span>
            <input type="file" id="userAvatarFile" hidden onchange="uploadUserAvatar(event)">
        </div>
        <!-- æ–¹å¼B (æ–°å¢) -->
        <div class="ios-item">
            <span class="ios-label">å›¾ç‰‡é“¾æ¥</span>
            <input type="text" id="set-user-avatar-url" class="ios-input" placeholder="ç²˜è´´ URL (æ¨è)" onchange="updateUserAvatarFromUrl()">
        </div>
                        <div class="ios-item">
                            <span class="ios-label">æ˜µç§°</span>
                            <input type="text" id="set-user-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">æˆ‘çš„è®¾å®š (User Persona)</span>
                            <textarea id="set-user-desc" class="ios-input" style="text-align:left; width:100%; height:60px; border:1px solid #eee; padding:5px; border-radius:5px;" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ä¸ªå¥½å¥‡çš„å­¦ç”Ÿ..." onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">å¤–è§‚</div>
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èŠå¤©èƒŒæ™¯</span>
                            <button style="border:none; background:none; color:#007AFF" onclick="document.getElementById('bgFile').click()">æ›´æ¢</button>
                            <button style="border:none; background:none; color:red" onclick="clearChatBg()">è¿˜åŸ</button>
                            <input type="file" id="bgFile" hidden onchange="uploadChatBg(event)">
                        </div>
                    </div>

                    <div class="ios-group-title">èŠå¤©è®°å½•ç®¡ç†</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="openDeleteMsgModal()">
                            <span class="ios-label" style="color: #ff3b30;">åˆ é™¤èŠå¤©è®°å½•</span>
                            <span style="color:#999; font-size:12px;"> > </span>
                        </div>
                    </div>

                    <button class="ios-btn danger" style="border-radius:12px; margin-bottom:20px;" onclick="deleteCurrentChar()">åˆ é™¤æ­¤è§’è‰²</button>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" style="border:none; width:100%; color:#007AFF;" onclick="closeModal('modal-chat-settings')">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- 3. æ™ºèƒ½æ€»ç»“å¼¹çª— -->
        <div class="modal-overlay" id="modal-summary">
            <div class="modal-box">
                <div class="modal-header">æ™ºèƒ½è®°å¿†æå–</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">é€‰æ‹©èŠå¤©è®°å½•èŒƒå›´ç”Ÿæˆæ‘˜è¦å­˜å…¥è®°å¿†åº“</p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-end" class="ios-input" value="100">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999;">
                        å½“å‰å…±æœ‰ <span id="total-msg-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="doSummarize()">ç”Ÿæˆå¹¶å­˜å‚¨</button>
                </div>
            </div>
        </div>

        <!-- 4. åˆ é™¤æ¶ˆæ¯å¼¹çª— (æ–°) -->
        <div class="modal-overlay" id="modal-del-msg">
            <div class="modal-box">
                <div class="modal-header" style="color:#ff3b30">æ‰¹é‡åˆ é™¤æ¶ˆæ¯</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">
                        è¯·è¾“å…¥è¦åˆ é™¤çš„æ¶ˆæ¯æ¥¼å±‚èŒƒå›´<br>(#æ•°å­—)
                    </p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="del-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="del-end" class="ios-input">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999; margin-top:10px;">
                        å½“å‰å…±æœ‰ <span id="del-total-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-del-msg')">å–æ¶ˆ</button>
                    <button class="modal-btn" style="color:#ff3b30; font-weight:bold;" onclick="commitDeleteMsg()">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>

    </div>
    <!-- ============ æ–°å¢ï¼šå†™æ—¥è®°å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-write-diary">
    <div class="modal-box" style="height: 60%;">
        <div class="modal-header">
            å†™æ—¥è®°
            <!-- ç”¨äºä¸´æ—¶å­˜å‚¨å½“å‰æ˜¯å†™ç»™è°çš„ -->
            <input type="hidden" id="diary-target-char-id">
        </div>
        <div class="modal-body" style="padding:15px; display:flex; flex-direction:column;">
            <div style="margin-bottom:10px; font-size:14px; color:#666;">
                æ”¶ä»¶äºº: <span id="diary-target-name" style="font-weight:bold; color:#000;"></span>
            </div>
            <textarea id="user-diary-input" style="flex:1; border:1px solid #eee; border-radius:10px; padding:10px; font-size:16px; resize:none; outline:none;" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæƒ³å‘Šè¯‰Taçš„äº‹ï¼Ÿ..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-write-diary')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="submitUserDiary()">ä¿å­˜å¹¶åŒæ­¥</button>
        </div>
    </div>
</div>
    <!-- åˆ›å»ºåŒäººæ–‡å¼¹çª— -->
<div class="modal-overlay" id="modal-create-fic">
    <div class="modal-box" style="height:auto; max-height:80%;">
        <div class="modal-header">å‘å¸ƒçº¦ç¨¿éœ€æ±‚ (AIäº§ç²®)</div>
        <div class="modal-body" style="padding:15px;">
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">CP å¯¹è±¡</span>
                    <select id="fic-target-char" class="ios-input" style="direction: rtl;">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="ios-item">
                    <span class="ios-label">æ–‡é£/ç±»å‹</span>
                    <select id="fic-tone" class="ios-input" style="direction: rtl;">
                        <option value="ç”œå® ">ğŸ¬ ç”œå® æ’’ç³–</option>
                        <option value="è™æ‹">ğŸ”ª è™æ‹æƒ…æ·±</option>
                        <option value="æç¬‘">ğŸ¤£ æ²™é›•æç¬‘</option>
                        <option value="è½¦è½¦">ğŸš— æ·±å¤œæ¿€æƒ…</option>
                        <option value="AU">ğŸŒ æ¶ç©ºè®¾å®š (AU)</option>
                    </select>
                </div>
            </div>
            
            <div class="ios-group-title">è®¾å®š / æ¢— / ä¸–ç•Œè§‚ (è¶Šè¯¦ç»†è¶Šå¥½)</div>
            <textarea id="fic-prompt" class="ios-input" style="width:100%; height:120px; border:1px solid #eee; border-radius:8px; padding:10px; margin-top:5px;" placeholder="ä¾‹å¦‚ï¼šABOè®¾å®šï¼Œæˆ‘æ˜¯Alphaä»–æ˜¯Omegaï¼›æˆ–è€…å“ˆåˆ©æ³¢ç‰¹AUï¼Œä»–æ˜¯æ–¯è±ç‰¹æ—å­¦é•¿..."></textarea>
            
            <div style="font-size:12px; color:#999; margin-top:10px;">
                * AI å°†æ‰®æ¼”ä¸€ä½åŒäººå†™æ‰‹ï¼Œæ ¹æ®ä½ çš„è®¾å®šåˆ›ä½œçŸ­æ–‡å¹¶æ¨¡æ‹Ÿç²‰ä¸è¯„è®ºã€‚
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-create-fic')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="submitFicRequest()" id="btn-submit-fic" style="font-weight:bold; color:#ff2d55;">å¼€å§‹äº§ç²®</button>
        </div>
    </div>
</div>

<!-- åˆ†äº«é€‰æ‹©å¼¹çª— -->
<div class="modal-overlay" id="modal-share-fic">
    <div class="modal-box" style="height:auto;">
        <div class="modal-header">åˆ†äº«ç»™...</div>
        <div class="modal-body" style="padding:0;">
            <div id="share-contact-list" class="ios-list" style="margin:0;">
                <!-- åˆ—è¡¨ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-share-fic')">å–æ¶ˆ</button>
        </div>
    </div>
</div>
    <!-- ============ é¢˜åº“ç®¡ç†å¼¹çª— (ä¼˜åŒ–ç‰ˆ) ============ -->
<div class="modal-overlay" id="modal-ludo-library">
    <div class="modal-box" style="height: 60%;">
        <!-- å¤´éƒ¨ï¼šFlexå¸ƒå±€ï¼Œå·¦ä¸­å³æ’åˆ— -->
        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; padding: 15px;">
            
            <!-- å·¦è¾¹ï¼š+å· (å¯¼å…¥æ–°é¢˜åº“) -->
            <!-- æ ·å¼ï¼šé€æ˜èƒŒæ™¯ï¼Œè“è‰²å¤§å­—ï¼Œæ— è¾¹æ¡† -->
            <button onclick="document.getElementById('ludoTaskInput').click()" 
                    style="background:transparent; border:none; font-size:28px; color:#007AFF; font-weight:300; padding:0; width:30px; text-align:left;">
                +
            </button>

            <!-- ä¸­é—´ï¼šæ ‡é¢˜ -->
            <span style="font-weight:bold; font-size:17px; color:#000;">é€‰æ‹©é¢˜åº“</span>

            <!-- å³è¾¹ï¼šå…³é—­æŒ‰é’® (Ã—) -->
            <!-- æ ·å¼ï¼šé€æ˜èƒŒæ™¯ï¼Œç°è‰²å›¾æ ‡ï¼Œæ— è¾¹æ¡† -->
            <button onclick="closeModal('modal-ludo-library')" 
                    style="background:transparent; border:none; font-size:24px; color:#999; padding:0; width:40px; text-align:right;">
                Ã—
            </button>
        </div>

        <div class="modal-body" style="padding:0; background:#f2f2f7;">
            <div class="ios-group-title">æˆ‘çš„é¢˜åº“åˆ—è¡¨</div>
            
            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="ludo-library-list" class="ios-list" style="margin-top:0;">
                <!-- JS åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div style="padding:20px; text-align:center; color:#999; font-size:12px;">
                ç‚¹å‡»å·¦ä¸Šè§’ + å·å¯¼å…¥æ–°æ–‡ä»¶<br>ç‚¹å‡»åˆ—è¡¨é¡¹å³å¯åº”ç”¨
            </div>
        </div>
    </div>
</div>
    <!-- ============ é˜…è¯»ç¬”è®°å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-book-summary">
    <div class="modal-box">
        <div class="modal-header">
            å‰§æƒ…å›é¡¾ (AI ç¬”è®°)
        </div>
        <div class="modal-body" style="padding:15px; background:#f9f9f9;">
            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="summary-list-content" style="display:flex; flex-direction:column; gap:15px;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-book-summary')" style="color:#007AFF; font-weight:bold;">å…³é—­</button>
        </div>
    </div>
</div>
    <div id="modal-voice-call" class="call-overlay">
    <div class="call-bg" id="call-bg-img"></div>
    
    <div class="call-content">
        <div class="call-status" id="call-status-text">Jin æ­£åœ¨æ¥ç”µ...</div>
        
        <div class="call-avatar-container">
            <img src="" id="call-avatar-img" class="call-avatar">
            <div class="call-ripple"></div> </div>

        <div id="call-chat-area" class="call-chat-scroll" style="display:none;">
            </div>

        <div class="call-actions" id="call-action-incoming">
            <button class="call-btn decline" onclick="declineCall()">
                <svg viewBox="0 0 24 24" width="30" height="30" fill="white"><path d="M12 9c-2.5 0-4.8.8-6.7 2.1-.4.3-1 .2-1.2-.2l-1.9-2.3c-.3-.4-.2-1 .2-1.3C5.2 5.3 8.4 4 12 4s6.8 1.3 9.6 3.3c.4.3.5.9.2 1.3l-1.9 2.3c-.3.4-.8.5-1.2.2C16.8 9.8 14.5 9 12 9z"/></svg>
            </button>
            <button class="call-btn accept" onclick="acceptCall()">
                <svg viewBox="0 0 24 24" width="30" height="30" fill="white"><path d="M20.2 14.9l-2.6-.4c-.5-.1-1 .1-1.4.5l-2.3 2.3c-3.1-1.6-5.6-4.1-7.2-7.2l2.3-2.3c.3-.4.5-.9.5-1.4l-.4-2.6C9 3.3 8.5 3 8 3H4c-.6 0-1 .4-1 1 0 9.4 7.6 17 17 17 .6 0 1-.4 1-1v-4c0-.6-.4-1-1-1z"/></svg>
            </button>
        </div>

        <div class="call-actions-active" id="call-action-active" style="display:none;">
            <input type="text" id="call-input" class="call-input-box" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendCallMsg()">
            <button class="call-btn decline small" onclick="endCall()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M12 9c-2.5 0-4.8.8-6.7 2.1-.4.3-1 .2-1.2-.2l-1.9-2.3c-.3-.4-.2-1 .2-1.3C5.2 5.3 8.4 4 12 4s6.8 1.3 9.6 3.3c.4.3.5.9.2 1.3l-1.9 2.3c-.3.4-.8.5-1.2.2C16.8 9.8 14.5 9 12 9z"/></svg>
            </button>
        </div>
    </div>
</div>
    <!-- ============ æ–°å¢ï¼šè¶…å¤§ç¼–è¾‘æ¡†å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-big-edit">
    <div class="modal-box" style="height: 60%;">
        <div class="modal-header">
            ç¼–è¾‘å†…å®¹
            <!-- éšè—åŸŸï¼šå­˜ä¸€ä¸‹å½“å‰æ­£åœ¨æ”¹å“ªæ¡æ¶ˆæ¯ -->
            <input type="hidden" id="edit-target-index">
        </div>
        <div class="modal-body" style="padding:15px; display:flex; flex-direction:column;">
            <div style="font-size:12px; color:#999; margin-bottom:10px;">
                ä¿®ç¼®æ–‡æ¡ˆæˆ–æ›´æ­£æ ¼å¼ï¼ˆä¿®æ”¹åä¸ä¼šè§¦å‘ AI é‡ç­”ï¼Œä»…ä¿®æ­£æ˜¾ç¤ºï¼‰
            </div>
            <!-- è¿™é‡Œå°±æ˜¯ä½ è¦çš„å¤§æ¡†æ¡† -->
            <textarea id="big-edit-input" style="flex:1; padding:15px; font-size:16px; line-height:1.6; border:1px solid #ddd; border-radius:10px; resize:none; outline:none; font-family:inherit;"></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-big-edit')">å–æ¶ˆ</button>
            
            <!--è¿™æ˜¯åŸæ¥çš„åŠŸèƒ½ï¼šä¿®æ”¹å¹¶é‡åˆ· (ä»…ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤º) -->
            <button id="btn-edit-regen" class="modal-btn" onclick="saveBigEdit(true)" style="color:#ff3b30; font-size:14px; display:none;">é‡å†™å¹¶é‡åˆ· AI</button>
            
            <!-- è¿™æ˜¯æ–°åŠŸèƒ½ï¼šä»…ä¿®æ­£æ–‡å­— -->
            <button class="modal-btn" onclick="saveBigEdit(false)" style="color:#007AFF; font-weight:bold;">ä»…ä¿®æ­£æ–‡æ¡ˆ</button>
        </div>
    </div>
</div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        let globalConfig = {
            provider: "custom",
            googleKeys: [],
            apiUrl: "https://api.openai.com/v1",
            apiKey: "",
            model: "gpt-3.5-turbo",
            temp: 0.7,
            historyLimit: 20,
            xiApiKey: "",
            xiVoiceId: "",
            xiModelId: "eleven_multilingual_v2"
        };

        // è§’è‰²åˆ—è¡¨
        let contacts = []; 
        // å½“å‰æ´»è·ƒçš„èŠå¤©ID
        let activeContactId = null;

        // ä¸´æ—¶å˜é‡
        let currentImg = null;
        let currentCallContext = []; 
        let globalAudioPass = new Audio();

        // ğŸ›¡ï¸ å…¨å±€å®‰å…¨é”ï¼šé»˜è®¤ä¸ºå…³é—­çŠ¶æ€
        // åªæœ‰å½“ loadData æˆåŠŸè¯»å–æ•°æ®åï¼Œè¿™ä¸ªé”æ‰ä¼šæ‰“å¼€
        // å¦åˆ™ saveData å°†è¢«ç¦æ­¢è¿è¡Œï¼Œé˜²æ­¢ç©ºæ•°æ®è¦†ç›–æ—§å­˜æ¡£
        window.isDataSafeToSave = false;

        // --- åˆå§‹åŒ–ä¸ç”Ÿå‘½å‘¨æœŸ ---
        window.onload = function() {
            startClock();
            loadData(); // å°è¯•è¯»å–æ•°æ®

            // å¦‚æœè”ç³»äººä¸ºç©ºï¼Œä¸”å®‰å…¨é”æ‰“å¼€äº†ï¼ˆè¯´æ˜æ˜¯çœŸæ²¡æ•°æ®ï¼Œè€Œä¸æ˜¯è¯»é”™äº†ï¼‰ï¼Œæ‰åˆ›å»ºé»˜è®¤è§’è‰²
            if (contacts.length === 0 && window.isDataSafeToSave) {
                createCharacter("AI Assistant", "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚", "https://api.dicebear.com/7.x/bottts/svg?seed=Default");
            }
            
            updateContactList();
            updateGlobalSettingsUI();
            loadTheme();
        };

        // --- æ•°æ®æŒä¹…åŒ– (å¸¦é˜²çˆ†æç¤ºç‰ˆ) ---
function saveData() {
    if (!window.isDataSafeToSave) {
        console.warn("ğŸš« æ‹¦æˆªï¼šæ•°æ®æœªå®‰å…¨åŠ è½½ï¼Œç¦æ­¢è¦†ç›–ã€‚");
        return;
    }

    try {
        localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
        localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
    } catch (e) {
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæŠ¥é”™ï¼ˆé€šå¸¸æ˜¯ QuotaExceededErrorï¼‰ï¼Œå¼¹çª—æç¤º
        console.error("ä¿å­˜å¤±è´¥:", e);
        alert("âš ï¸ ä¿å­˜å¤±è´¥ï¼å­˜å‚¨ç©ºé—´å·²æ»¡ã€‚\n\nåŸå› ï¼šå¯èƒ½æ˜¯ä¸Šä¼ çš„å›¾ç‰‡å¤ªå¤§äº†ã€‚\nå»ºè®®ï¼šè¯·ä½¿ç”¨ã€å›¾ç‰‡é“¾æ¥ (URL)ã€‘ä»£æ›¿æœ¬åœ°ä¸Šä¼ ï¼Œæˆ–è€…åˆ é™¤ä¸€äº›æ—§ç…§ç‰‡/æ—§è§’è‰²ã€‚");
    }
}
        

        // --- è¯»å–æ•°æ® (å¸¦æŠ¥è­¦ç‰ˆ) ---
        function loadData() {
            try {
                // 1. è¯»å–é…ç½®
                const c = localStorage.getItem('ai_phone_config');
                if (c) globalConfig = JSON.parse(c);
                if (!globalConfig.customPresets) globalConfig.customPresets = [];

                // 2. è¯»å–è”ç³»äºº (æœ€é‡è¦çš„æ•°æ®)
                const ct = localStorage.getItem('ai_phone_contacts');
                if (ct) {
                    contacts = JSON.parse(ct);
                    console.log("âœ… æ•°æ®è¯»å–æˆåŠŸï¼Œå…±", contacts.length, "ä¸ªè§’è‰²");
                } else {
                    console.log("âš ï¸ æœªæ‰¾åˆ°è”ç³»äººæ•°æ®ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œæˆ–è€…æ˜¯æ–°è®¾å¤‡");
                }

                // ğŸ‰ 3. å…³é”®ä¸€æ­¥ï¼šè¯»å–æˆåŠŸï¼Œæ‰“å¼€å®‰å…¨é”ï¼
                // åªæœ‰è¿è¡Œåˆ°è¿™ä¸€è¡Œï¼Œæ‰å…è®¸åç»­çš„ä¿å­˜æ“ä½œ
                window.isDataSafeToSave = true;

            } catch (e) {
                // ğŸš¨ å‘ç”Ÿä¸¥é‡é”™è¯¯ (æ¯”å¦‚ JSON æ ¼å¼é”™äº†)
                console.error("âŒ è‡´å‘½é”™è¯¯ï¼šæ•°æ®è¯»å–å¤±è´¥ï¼", e);
                
                // é”æ­»ä¿å­˜åŠŸèƒ½
                window.isDataSafeToSave = false; 
                
                // å¼¹å‡ºçº¢è‰²è­¦æŠ¥
                alert("âš ï¸ã€ä¸¥é‡è­¦å‘Šã€‘æ•°æ®è¯»å–å¤±è´¥ï¼\n\nå¯èƒ½æ˜¯ä»£ç ä¿®æ”¹å¯¼è‡´æ ¼å¼é”™è¯¯ï¼Œæˆ–è€…æ˜¯æ•°æ®æŸåã€‚\nä¸ºäº†ä¿æŠ¤ä½ çš„å­˜æ¡£ï¼Œç³»ç»Ÿå·²ã€ç¦æ­¢è‡ªåŠ¨ä¿å­˜ã€‘ã€‚\n\nè¯·ä¸è¦è¿›è¡Œä»»ä½•æ“ä½œï¼Œå…ˆæ£€æŸ¥ä»£ç æˆ–å¯¼å‡ºå¤‡ä»½ï¼");
            }
        }

        function createCharacter(name, prompt, avatar) {
            const id = Date.now().toString();
            const newChar = {
                id: id,
                name: name,
                avatar: avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                systemPrompt: prompt || "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚",
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                userPersona: "", // ç”¨æˆ·åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„äººè®¾
                bgImage: "",     // èŠå¤©èƒŒæ™¯
                messages: [],
                memories: [],
                diaries: [],
                userDiaries: [],
                // --- æ–°å¢ï¼šæ—¥å†ä¸ç”Ÿç†æœŸæ•°æ® ---
                calendarEvents: {}, // æ ¼å¼: { "2025-11-21": "çºªå¿µæ—¥" }
                periodLog: [],      // æ ¼å¼: ["2025-10-01", "2025-11-28"] (è®°å½•ç»æœŸå¼€å§‹çš„æ—¥å­)
                // --- æ–°å¢å­—æ®µ ---
                autoReplyInterval: 0, // é»˜è®¤ä¸ä¸»åŠ¨
                lastActiveTime: Date.now()
            };
            contacts.push(newChar);
            saveData();
            return id;
        }

        // --- é¡µé¢å¯¼èˆª ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            const bar = document.getElementById('statusBar');
            const indicator = document.querySelector('.home-indicator');
            
            if(pageId === 'page-home') {
                // bar.style.color = 'white';
                indicator.style.backgroundColor = 'white';
            } else {
                // bar.style.color = 'black';
                indicator.style.backgroundColor = 'black';
            }
            // âœ¨âœ¨âœ¨ã€åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œä»£ç ã€‘âœ¨âœ¨âœ¨
    // å¦‚æœè¿›å…¥çš„æ˜¯æ¶ˆæ¯åˆ—è¡¨é¡µï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
    if(pageId === 'page-msg-list') {
        updateContactList();
    }

            if(pageId === 'page-chat' && activeContactId) {
                renderChat(activeContactId);
            }
            if(pageId === 'page-memory' && activeContactId) {
                renderMemories();
            } else if (pageId === 'page-memory' && !activeContactId) {
                document.getElementById('memoryListContainer').innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¯·å…ˆä»ä¿¡æ¯åˆ—è¡¨è¿›å…¥ä¸€ä¸ªèŠå¤©</p>';
            }
            // --- æ–°å¢ï¼šè¿›å…¥æ—¥è®°æœ¬æ—¶åˆ·æ–°åˆ—è¡¨ ---
            if (pageId === 'page-diary') {
                renderDiaries();
            }
        }

        function goHome() { navigateTo('page-home'); }

        // --- 1. è”ç³»äººåˆ—è¡¨é€»è¾‘ ---
        function updateContactList() {
            const container = document.getElementById('contactListContainer');
            container.innerHTML = '';
            
            // æŒ‰æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´æ’åºï¼ˆå¯é€‰ï¼Œè¿™é‡Œæš‚ä¸å¤æ‚åŒ–ï¼‰
            contacts.forEach(c => {
                // å¢åŠ å®¹é”™ï¼šå¦‚æœmessagesä¸å­˜åœ¨ï¼Œç»™ç©ºæ•°ç»„
                if(!c.messages) c.messages = [];
                
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : "ç‚¹å‡»å¼€å§‹èŠå¤©...";
                const previewText = lastMsg.startsWith('data:image') ? '[å›¾ç‰‡]' : lastMsg;
                
                const div = document.createElement('div');
                div.className = 'msg-list-item';
                div.onclick = () => enterChat(c.id);
                div.innerHTML = `
                    <img src="${c.avatar}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-name">${c.name}</div>
                        <div class="list-preview">${previewText}</div>
                    </div>
                    <div class="list-time"> > </div>
                `;
                container.appendChild(div);
            });
        }

        function enterChat(id) {
            activeContactId = id;
            navigateTo('page-chat');
            processAutoReplyChain(id);
            const char = contacts.find(c => c.id === id);
            if(char) checkAndSendHolidayGreeting(char);
        }

        function addNewCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            if(!name) return alert("è¯·è¾“å…¥åå­—");
            createCharacter(name);
            closeModal('modal-add-char');
            document.getElementById('newCharName').value = '';
            updateContactList();
        }

        // --- 2. èŠå¤©é€»è¾‘ ---
        function getActiveChar() {
            return contacts.find(c => c.id === activeContactId);
        }

        function renderChat(id) {
            const char = contacts.find(c => c.id === id);
            if(!char) return;

            document.getElementById('chat-title-name').innerText = char.name;
            
            // è®¾ç½®èƒŒæ™¯
            const page = document.getElementById('page-chat');
            if(char.bgImage) {
                page.style.backgroundImage = `url(${char.bgImage})`;
            } else {
                page.style.backgroundImage = '';
            }

            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if(!char.messages || char.messages.length === 0) {
                box.innerHTML = `<div style="text-align:center;font-size:12px;color:#999;margin:20px;">ä¸ ${char.name} å¼€å§‹æ–°çš„å¯¹è¯</div>`;
            } else {
                char.messages.forEach((m, index) => {
                    appendMsgUI(m.role, m.content, m.image, index + 1, false, m.timestamp);
                });
            }
            scrollToBottom();
        }

        // --- æ›¿æ¢åçš„ appendMsgUI å‡½æ•° (åŒ…å«é‡è¦ä¿®å¤) ---
        function appendMsgUI(role, text, img, index, isTemp=false, timestamp=null) {
            const char = getActiveChar();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            
            const avatarUrl = role==='user' ? char.userAvatar : char.avatar;
            
            
            // å¤„ç†å³é”®/åŒå‡»äº‹ä»¶
            let extraHtml = '';
            let eventAttr = '';
            
            // âœ¨ ä¿®æ”¹ç‚¹ï¼šä¼ å…¥ role å‚æ•° ('user' æˆ– 'assistant')
            if (!isTemp) {
                eventAttr = `ondblclick="openBigEditModal(${index}, '${role}'); return false;"`;
            }
            
            if (role === 'assistant' && !isTemp) {
                extraHtml = ``;
            }

            // --- æ—¶é—´æˆ³å¤„ç†é€»è¾‘ (ä¿®å¤Safari Invalid Dateé”™è¯¯) ---
            let timeStr = "";
            if (timestamp) {
                const date = new Date(timestamp);
                // é‡è¦ä¿®å¤ï¼šæ£€æµ‹æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼Œæ—§æ•°æ®å¯èƒ½æ²¡æœ‰æ—¶é—´æˆ³æˆ–æ ¼å¼ä¸å…¼å®¹
                if (!isNaN(date.getTime())) {
                    try {
                        timeStr = date.toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                    } catch(e) {
                        console.warn("Date format error", e);
                    }
                }
            } else if (isTemp) {
                timeStr = "å‘é€ä¸­...";
            }

            // --- âœ¨ 1. å®šä¹‰å°å–‡å­å›¾æ ‡ (åªåœ¨æˆ‘æ˜¯ AI æ—¶æ˜¾ç¤º) ---
            const ttsIcon = role === 'assistant' ? `
                <div class="tts-btn-container" style="display:inline-flex; vertical-align:middle; margin-right:4px;">
                    <svg class="btn-tts-play" viewBox="0 0 24 24" onclick="playTTS(this)" style="width:16px;height:16px;cursor:pointer;fill:#999;transition:0.2s;">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                </div>` : '';

            // --- âœ¨ 2. æ„å»ºæ–°çš„æ°”æ³¡ç»“æ„ ---
            let html = `
                <span class="msg-index">#${index || '?'}</span>
                <img src="${avatarUrl}" class="avatar">
                <div class="message" ${eventAttr}>
                    ${img ? `<img src="${img}" style="max-width:100%;border-radius:8px;display:block;margin-bottom:5px;">` : ''}
                    <span class="txt-content">${isTemp ? text : formatText(text)}</span>
                    
                    <div class="msg-meta-row" style="display:flex; justify-content:flex-end; align-items:center; margin-top:5px; gap:5px;">
                        ${ttsIcon}
                        <span class="msg-time-stamp" style="position:static; font-size:10px; opacity:0.6;">${timeStr}</span>
                    </div>
                </div>
            `;
            
            div.innerHTML = html + extraHtml;
            box.appendChild(div);
            scrollToBottom();
            return div.querySelector('.txt-content'); 
        }

        async function sendMsg(role) {
            const char = getActiveChar();
            if(!char) return;

            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            
            if(!txt && !currentImg) return;

            // ç”¨æˆ·æ¶ˆæ¯
            const newMsg = { role: 'user', content: txt, image: currentImg, timestamp: Date.now() };
            char.messages.push(newMsg);
            saveData(); // ä¿å­˜æ•°æ®
            
            appendMsgUI('user', txt, currentImg, char.messages.length);
            
            input.value = '';
            clearUpload();
            
            
        }

        async function triggerAI() {
    const char = getActiveChar();
    if (!char) return;
    if (!globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

    const btn = document.getElementById('btn-ai');

    // === âœ¨ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½é‡åˆ·é€»è¾‘ START ===
    // 1. æ£€æŸ¥æœ‰æ²¡æœ‰æ¶ˆæ¯
    if (char.messages.length > 0) {
        const lastIndex = char.messages.length - 1;
        const lastMsg = char.messages[lastIndex];

        // 2. å¦‚æœæœ€åä¸€æ¡æ˜¯ AI (assistant) å‘çš„ï¼Œè¯´æ˜æ˜¯é‡åˆ·
        if (lastMsg.role === 'assistant') {
            // ä»æ•°ç»„ä¸­å½»åº•åˆ é™¤è¿™ä¸€æ¡
            char.messages.pop();
            // ç«‹å³ä¿å­˜æ•°æ®ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±
            saveData();
            // 3. å…³é”®ï¼šç«‹å³åˆ·æ–°ç•Œé¢ï¼Œè®©æ—§æ°”æ³¡åœ¨è§†è§‰ä¸Šç«‹åˆ»æ¶ˆå¤±
            renderChat(activeContactId);
        }
    }
    // === âœ¨ æ™ºèƒ½é‡åˆ·é€»è¾‘ END ===

    // å˜æˆæ‰“å­—æœºåŠ¨ç”» (é˜²æ­¢é‡å¤ç‚¹å‡»)
    const originalBtnContent = btn.innerHTML;
    btn.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';
    btn.disabled = true;

    // --- 1. æ„å»º System Prompt (åŸºç¡€è®¾å®š) ---
    let systemPromptFull = char.systemPrompt + `\n[å½“å‰æ—¶é—´: ${new Date().toLocaleString()}]\n[ç”¨æˆ·åç§°: ${char.userName}]`;
    if (char.userPersona) systemPromptFull += `\n[ç”¨æˆ·è®¾å®š: ${char.userPersona}]`;
            if (char.languageMode === 'en') {
        systemPromptFull += `
        \n[ğŸ”´ è¯­è¨€æ¨¡å¼å¼ºåˆ¶æŒ‡ä»¤ (Language Override)]:
        1. æ— è®ºä¹‹å‰çš„è®¾å®šå¦‚ä½•ï¼Œä½ ç°åœ¨çš„å›å¤å¿…é¡»ä¸»è¦ä½¿ç”¨ã€è‹±è¯­ (English)ã€‘ã€‚
        2. åœ¨ä½ çš„è‹±è¯­å›å¤ç»“æŸåï¼Œå¿…é¡»ã€å¦èµ·ä¸€è¡Œ (New line)ã€‘ã€‚
        3. åœ¨æ–°çš„ä¸€è¡Œé™„ä¸Šå¯¹åº”çš„ã€ä¸­æ–‡ç¿»è¯‘ã€‘ã€‚
        4. æ ¼å¼èŒƒä¾‹ï¼š
           "That sounds really interesting, tell me more about it."
           
           "é‚£å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼Œå¤šè·Ÿæˆ‘è®²è®²ã€‚"
        `;
    }
    
    // æ³¨å…¥å„ç§æ„ŸçŸ¥ä¸Šä¸‹æ–‡
    systemPromptFull += getStatusContext(char);
    systemPromptFull += getMusicContext();

    // --- 2. å–‚å…¥æ—¥è®° (æ··åˆè®°å¿†ç‰ˆï¼šæ”¶è— + æœ€è¿‘) ---
    if (char.diaries && char.diaries.length > 0) {
        // æ•°æ®æ¸…æ´—
        const safeDiaries = char.diaries.map(d => typeof d === 'string' ? { content: d, isStarred: false } : d);

        // è·å–ã€çŸ­æœŸè®°å¿†ã€‘ï¼šå¼ºåˆ¶è¯»å–æœ€è¿‘ 3 ç¯‡
        const recentDiaries = safeDiaries.slice(-3);

        // è·å–ã€æ ¸å¿ƒè®°å¿†ã€‘ï¼šæ‰¾å‡ºæ‰€æœ‰æ”¶è—çš„
        let starredDiaries = safeDiaries.filter(d => d.isStarred);

        // å»é‡
        starredDiaries = starredDiaries.filter(s => !recentDiaries.includes(s));

        // é™åˆ¶ä¸Šé™
        if (starredDiaries.length > 8) {
            starredDiaries = starredDiaries.slice(-8);
        }

        // åˆå¹¶
        const finalDiaries = [...starredDiaries, ...recentDiaries];

        const diaryText = finalDiaries.map(d => {
            return (d.isStarred ? "â˜… [é‡è¦å›å¿†] " : "") + d.content;
        }).join('\n\n---\n\n');

        systemPromptFull += `\n\n[æˆ‘çš„æ—¥è®°æœ¬ (åŒ…å«æ ¸å¿ƒå›å¿†å’Œæœ€è¿‘æ—¥è®°)]:\n${diaryText}`;
    }

    // --- 3. å–‚å…¥é•¿æœŸè®°å¿† ---
    if (char.memories.length > 0) {
        systemPromptFull += `\n[é•¿æœŸè®°å¿†åº“]:\n${char.memories.join('\n')}`;
    }

    // åˆå§‹åŒ– API æ¶ˆæ¯æ•°ç»„
    let apiMsgs = [{ role: "system", content: systemPromptFull }];

    // --- 4. æ„å»ºæ¶ˆæ¯å†å² (åŒ…å«åŒäººæ–‡è¯»å–é€»è¾‘) ---
    const limit = globalConfig.historyLimit || 20;
    const history = char.messages.slice(-limit);

    history.forEach(m => {
        let contentToSend = m.content;

        if (m.hiddenContext) {
            // å¦‚æœæ˜¯åŒäººæ–‡
            if (m.hiddenContext.type === "share_fanfic") {
            contentToSend = `
            [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆ†äº«äº†ä¸€ä¸ªé“¾æ¥ï¼Œä»¥ä¸‹æ˜¯é“¾æ¥çš„å®Œæ•´å†…å®¹]
            æ–‡ç« æ ‡é¢˜ï¼šã€Š${m.hiddenContext.title}ã€‹
            æ–‡ç« æ­£æ–‡ï¼š
            ${m.hiddenContext.content}
            
            ç²‰ä¸çƒ­é—¨è¯„è®ºï¼š
            ${m.hiddenContext.comments}
            
            (ç”¨æˆ·å‘é€è¿™æ¡æ¶ˆæ¯æ˜¯æƒ³å’Œä½ åˆ†äº«è¿™ç¯‡å…³äºä½ ä»¬çš„åŒäººæ–‡ã€‚è¯·é˜…è¯»å…¨æ–‡å’Œè¯„è®ºï¼Œå¹¶å‘è¡¨ä½ çš„çœ‹æ³•ã€‚å¦‚æœæ˜¯ç”œæ–‡å¯ä»¥å®³ç¾æˆ–å¼€å¿ƒï¼Œå¦‚æœæ˜¯è™æ–‡å¯ä»¥å®‰æ…°ç”¨æˆ·ï¼Œå¦‚æœæ˜¯OOCæˆ–å¥‡æ€ªè®¾å®šå¯ä»¥åæ§½ã€‚)
            `;
        } else if (typeof m.hiddenContext === 'string') {
                contentToSend = m.hiddenContext;
            }
        } 
        // å¦‚æœæ²¡æœ‰ hiddenContextï¼Œä½†å†…å®¹æ˜¯ HTML å¡ç‰‡ï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰
        else if (m.content.includes('<div class="msg-link-card"')) {
            contentToSend = "[ç”¨æˆ·åˆ†äº«äº†ä¸€ä¸ªé“¾æ¥/å¡ç‰‡]";
        }

        if (m.image) {
            apiMsgs.push({
                role: m.role,
                content: [
                    { type: "text", text: contentToSend || " " },
                    { type: "image_url", image_url: { url: m.image } }
                ]
            });
        } else {
            apiMsgs.push({ role: m.role, content: contentToSend });
        }
    });

    // --- 5. UI å ä½ä¸ API è°ƒç”¨ ---
    const aiMsgIndex = char.messages.length + 1;
    const aiUiSpan = appendMsgUI('assistant', '...', null, aiMsgIndex, true);
    let fullText = "";

    try {
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: apiMsgs,
    temperature: parseFloat(globalConfig.temp),
    stream: true
});

        if (!res.ok) throw new Error(res.statusText);

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.replace('data: ', ''));
                        const delta = json.choices[0].delta.content || "";
                        fullText += delta;
                        aiUiSpan.innerHTML = formatText(fullText);
                        scrollToBottom();
                    } catch (e) { }
                }
            }
        }

        // ä¿å­˜ AI å›å¤ (åŠ ä¸Šæ—¶é—´æˆ³)
        char.messages.push({ role: 'assistant', content: fullText, timestamp: Date.now() });
        saveData();

        // å†æ¬¡åˆ·æ–°ä»¥ç¡®ä¿æ ¼å¼æ­£ç¡® (ç‰¹åˆ«æ˜¯æ—¶é—´æˆ³æ˜¾ç¤º)
        renderChat(activeContactId);

    } catch (e) {
        aiUiSpan.innerText = "Error: " + e.message;
        char.messages.push({ role: 'assistant', content: "Error: " + e.message });
        saveData();
    }

    btn.innerHTML = originalBtnContent;
    btn.disabled = false;
}

        // --- 3. æ™ºèƒ½æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() {
            const char = getActiveChar();
            if(!char) return;
            document.getElementById('total-msg-count').innerText = char.messages.length;
            
            // é»˜è®¤é€‰ä¸­æœ€è¿‘ 20 æ¡ï¼Œæˆ–è€…å…¨éƒ¨
            const total = char.messages.length;
            const start = Math.max(1, total - 20);
            document.getElementById('sum-start').value = start;
            document.getElementById('sum-end').value = total;
            
            openModal('modal-summary');
        }

        async function doSummarize() {
            const char = getActiveChar();
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœè€è§’è‰²æ²¡æœ‰æ—¥è®°æ•°ç»„ï¼Œç»™å®ƒåŠ ä¸€ä¸ª
            if (!char.diaries) char.diaries = [];

            const startIdx = parseInt(document.getElementById('sum-start').value) - 1;
            const endIdx = parseInt(document.getElementById('sum-end').value);
            
            if(startIdx < 0 || endIdx > char.messages.length || startIdx >= endIdx) {
                alert("æ¥¼å±‚èŒƒå›´æ— æ•ˆ");
                return;
            }

            const selectedMsgs = char.messages.slice(startIdx, endIdx);
            // æŠŠå¯¹è¯è½¬æ¢æˆæ–‡æœ¬ä¾› AI é˜…è¯»
            const textBlock = selectedMsgs.map(m => `${m.role === 'user' ? 'æˆ‘(ç”¨æˆ·)' : char.name}: ${m.content}`).join('\n');

            closeModal('modal-summary');
            const btn = document.querySelector('.chat-header-actions button:last-child');
            const oldIcon = btn.innerHTML;
            btn.innerText = "âœï¸"; // å˜æˆå†™å­—å›¾æ ‡

            try {
                // --- è¿™é‡Œæ˜¯æ ¸å¿ƒä¿®æ”¹ï¼šæç¤ºè¯æ”¹æˆäº†å†™æ—¥è®° ---
                const prompt = `è¯·é˜…è¯»ä»¥ä¸‹èŠå¤©è®°å½•ï¼Œä»¥è§’è‰² "${char.name}" çš„ç¬¬ä¸€äººç§°è§†è§’å†™ä¸€ç¯‡ç®€çŸ­çš„æ—¥è®°ã€‚
                è¦æ±‚ï¼š
                1. åŒ…å«èŠå¤©çš„ä¸»è¦å†…å®¹ï¼Œä½†è¦åŠ å…¥è§’è‰²çš„å†…å¿ƒç‹¬ç™½ã€æƒ…ç»ªå’Œå¯¹ç”¨æˆ·çš„çœ‹æ³•ã€‚
                2. æ ¼å¼ä¸ºï¼šâ€œ[æ—¥æœŸ] ä»Šå¤©...â€ (å¦‚æœæ˜¯æ·±å¤œèŠå¤©å¯ä»¥ç”¨â€œæ·±å¤œ...â€)ã€‚
                3. ç¯‡å¹…ä¸è¦å¤ªé•¿ï¼ŒåƒçœŸå®çš„æ‰‹æœºå¤‡å¿˜å½•æ—¥è®°ä¸€æ ·ã€‚
                
                èŠå¤©è®°å½•ï¼š
                ${textBlock}`;

                // âœ… æ­£ç¡®å†™æ³•ï¼šfetchWithRetry ä¸éœ€è¦ method å’Œ headersï¼Œç›´æ¥ä¼ æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [
        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ“…é•¿æ¨¡ä»¿äººç±»æƒ…æ„Ÿå’Œå†…å¿ƒæˆçš„å°è¯´å®¶ã€‚" },
        { role: "user", content: prompt }
    ]
});

// fetchWithRetry è¿”å›çš„å°±æ˜¯ fetch çš„ç»“æœï¼Œæ‰€ä»¥åé¢è¿™äº›éƒ½ä¸ç”¨åŠ¨
const data = await res.json();
const diaryEntry = data.choices[0].message.content;
                
                // å­˜å…¥æ—¥è®°æ•°ç»„
                char.diaries.push(diaryEntry);
                saveData();
                alert("æ—¥è®°å·²å†™å¥½ï¼Œå¿«å»æ—¥è®°æœ¬APPæŸ¥çœ‹å§ï¼");
            } catch(e) {
                alert("å†™æ—¥è®°å¤±è´¥: " + e.message);
            }
            btn.innerHTML = oldIcon;
        }

        // --- 4. è§’è‰²è®¾ç½®ä¸è®°å¿†åº“ ---
        function openChatSettings() {
            const char = getActiveChar();
            if(!char) return;
            
            document.getElementById('set-char-name').value = char.name;
            document.getElementById('set-char-prompt').value = char.systemPrompt;
            document.getElementById('set-char-avatar').src = char.avatar;
            if (char.avatar && char.avatar.startsWith('http')) {
        document.getElementById('set-char-avatar-url').value = char.avatar;
    } else {
        document.getElementById('set-char-avatar-url').value = "";
    }
            
            document.getElementById('set-user-name').value = char.userName;
            document.getElementById('set-user-desc').value = char.userPersona || "";
            document.getElementById('set-user-avatar').src = char.userAvatar;
            if (char.userAvatar && char.userAvatar.startsWith('http')) {
        document.getElementById('set-user-avatar-url').value = char.userAvatar;
    } else {
        document.getElementById('set-user-avatar-url').value = "";
    }
            document.getElementById('set-char-interval').value = char.autoReplyInterval || 0;
            document.getElementById('set-char-lang').value = char.languageMode || "zh";
            
            openModal('modal-chat-settings');
        }

        function saveCurrentCharSettings() {
        const char = getActiveChar();
        if(!char) return;
        
        char.name = document.getElementById('set-char-name').value;
        char.systemPrompt = document.getElementById('set-char-prompt').value;
        char.userName = document.getElementById('set-user-name').value;
        char.userPersona = document.getElementById('set-user-desc').value;
        char.autoReplyInterval = parseInt(document.getElementById('set-char-interval').value) || 0;
        char.languageMode = document.getElementById('set-char-lang').value;
        
        document.getElementById('chat-title-name').innerText = char.name;
        saveData();

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        updateContactList();        // åˆ·æ–°å¤–é¢çš„åˆ—è¡¨
        renderChat(activeContactId); // åˆ·æ–°é‡Œé¢çš„æ°”æ³¡
    }

    async function uploadCharAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().avatar = b64;
        document.getElementById('set-char-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }

    async function uploadUserAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().userAvatar = b64;
        document.getElementById('set-user-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }
        async function uploadChatBg(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().bgImage = b64;
            document.getElementById('page-chat').style.backgroundImage = `url(${b64})`;
            saveData();
        }

        function clearChatBg() {
            getActiveChar().bgImage = "";
            document.getElementById('page-chat').style.backgroundImage = '';
            saveData();
        }

        function deleteCurrentChar() {
            if(confirm("ç¡®å®šåˆ é™¤è¯¥è§’è‰²åŠæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                contacts = contacts.filter(c => c.id !== activeContactId);
                activeContactId = null;
                saveData();
                closeModal('modal-chat-settings');
                updateContactList();
                navigateTo('page-msg-list');
            }
        }

        // è®°å¿†åº“æ¸²æŸ“
        function renderMemories() {
            const char = getActiveChar();
            const c = document.getElementById('memoryListContainer'); 
            c.innerHTML = '';
            
            if(!char) return;
            
            if(!char.memories) char.memories = []; // å…¼å®¹æ—§æ•°æ®

            char.memories.forEach((m, i) => {
                c.innerHTML += `
                    <div class="memory-card">
                        ${m}
                        <div class="btn-del-mem" onclick="deleteMemory(${i})">Ã—</div>
                    </div>`;
            });
        }
        function addMemoryManual() {
            const char = getActiveChar();
            const input = document.getElementById('newMemInput');
            if(input.value && char) {
                char.memories.push(input.value);
                input.value = '';
                saveData(); renderMemories();
            }
        }
        function deleteMemory(index) {
            const char = getActiveChar();
            if(char) {
                char.memories.splice(index, 1);
                saveData(); renderMemories();
            }
        }

        // --- 5. å…¨å±€è®¾ç½®é€»è¾‘ ---
        function updateGlobalSettingsUI() {
    // 1. è¿˜åŸä¾›åº”å•†é€‰æ‹©
    const provider = globalConfig.provider || "custom";
    document.getElementById('apiProvider').value = provider;
    
    // 2. è·å–ç›¸å…³ DOM å…ƒç´ 
    const urlInput = document.getElementById('apiUrl');
    const googleMgr = document.getElementById('googleKeyManager');
    // è·å–å• Key è¾“å…¥æ¡†çš„å¤–å±‚å®¹å™¨ (æ•´è¡Œ)ï¼Œä»¥ä¾¿éšè—
    const singleKeyContainer = document.getElementById('apiKey').closest('.ios-item');

    // 3. æ ¹æ®ä¾›åº”å•†åˆ‡æ¢ç•Œé¢çŠ¶æ€
    if (provider === 'google') {
        // --- Google æ¨¡å¼ ---
        // é”å®š URL
        urlInput.value = "https://generativelanguage.googleapis.com/v1beta/openai";
        urlInput.disabled = true;
        urlInput.style.color = "#999";
        
        // âœ¨âœ¨âœ¨ å…³é”®ä¿®æ”¹ï¼šæ˜¾ç¤ºé’¥åŒ™åŒ…ï¼Œéšè—å• Key âœ¨âœ¨âœ¨
        googleMgr.style.display = 'block';
        singleKeyContainer.style.display = 'none';
        
        // âœ¨âœ¨âœ¨ å…³é”®ä¿®æ”¹ï¼šå¿…é¡»è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œå¦åˆ™åˆ—è¡¨æ˜¯ç©ºçš„ âœ¨âœ¨âœ¨
        renderGoogleKeyList(); 
    } else {
        // --- è‡ªå®šä¹‰æ¨¡å¼ ---
        // æ¢å¤ URL
        urlInput.value = globalConfig.apiUrl;
        urlInput.disabled = false;
        urlInput.style.color = "#007AFF";
        
        // éšè—é’¥åŒ™åŒ…ï¼Œæ˜¾ç¤ºå• Key
        googleMgr.style.display = 'none';
        singleKeyContainer.style.display = 'flex';
    }

    // 4. è¿˜åŸå…¶ä»–é€šç”¨è®¾ç½® (ä¿æŒä¸å˜)
    document.getElementById('apiKey').value = globalConfig.apiKey;
    document.getElementById('modelId').value = globalConfig.model;
    document.getElementById('tempVal').value = globalConfig.temp;
    document.getElementById('historyLimit').value = globalConfig.historyLimit || 20;
    document.getElementById('xiApiKey').value = globalConfig.xiApiKey || "";
    document.getElementById('xiVoiceId').value = globalConfig.xiVoiceId || "";
    document.getElementById('xiModelId').value = globalConfig.xiModelId || "eleven_multilingual_v2";

            
            renderCustomPresets();
}
        // ==========================================
// --- âœ¨ è‡ªå®šä¹‰åä»£é¢„è®¾é€»è¾‘ (New) ---
// ==========================================

// 1. æ¸²æŸ“é¢„è®¾åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
function renderCustomPresets() {
    const select = document.getElementById('customPresetSelect');
    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™ç¬¬ä¸€é¡¹æç¤º
    select.innerHTML = '<option value="">-- é€‰æ‹©é…ç½® --</option>';
    
    if (!globalConfig.customPresets) globalConfig.customPresets = [];

    globalConfig.customPresets.forEach((preset, index) => {
        const opt = document.createElement('option');
        opt.value = index; // ç”¨ç´¢å¼•ä½œä¸º value
        opt.innerText = preset.name;
        select.appendChild(opt);
    });
}

// 2. å¦å­˜ä¸ºé¢„è®¾
function saveCurrentAsPreset() {
    const currentUrl = document.getElementById('apiUrl').value.trim();
    const currentKey = document.getElementById('apiKey').value.trim();
    const currentModel = document.getElementById('modelId').value.trim(); // é¡ºä¾¿æŠŠæ¨¡å‹ä¹Ÿå­˜äº†

    if (!currentUrl || !currentKey) {
        return alert("è¯·å…ˆå¡«å†™ API URL å’Œ Keyï¼Œæ‰èƒ½ä¿å­˜ä¸ºé¢„è®¾ã€‚");
    }

    const name = prompt("ç»™è¿™ä¸ªé…ç½®èµ·ä¸ªåå­— (ä¾‹å¦‚: DeepSeek, è½¬å‘ç«™A):");
    if (!name) return;

    // æ£€æŸ¥é‡åï¼ˆå¯é€‰ï¼‰
    const exists = globalConfig.customPresets.find(p => p.name === name);
    if (exists) {
        if (!confirm(`é¢„è®¾ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
        // è¦†ç›–é€»è¾‘
        exists.url = currentUrl;
        exists.key = currentKey;
        exists.model = currentModel;
    } else {
        // æ–°å¢é€»è¾‘
        globalConfig.customPresets.push({
            name: name,
            url: currentUrl,
            key: currentKey,
            model: currentModel
        });
    }

    saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    renderCustomPresets(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
    
    // è‡ªåŠ¨é€‰ä¸­åˆšæ‰ä¿å­˜çš„
    const select = document.getElementById('customPresetSelect');
    select.selectedIndex = select.options.length - 1;
    
    alert(`é¢„è®¾ "${name}" ä¿å­˜æˆåŠŸï¼`);
}

// 3. åº”ç”¨é¢„è®¾ (å½“ç”¨æˆ·é€‰æ‹©èœå•æ—¶)
function applyCustomPreset() {
    const select = document.getElementById('customPresetSelect');
    const index = select.value;
    
    if (index === "") return; // é€‰äº†æç¤ºé¡¹ï¼Œä¸åšæ“ä½œ

    const preset = globalConfig.customPresets[index];
    if (preset) {
        document.getElementById('apiUrl').value = preset.url;
        document.getElementById('apiKey').value = preset.key;
        
        // å¦‚æœé¢„è®¾é‡Œå­˜äº†æ¨¡å‹ï¼Œä¹Ÿæ¢å¤æ¨¡å‹ï¼›å…¼å®¹æ—§æ•°æ®
        if (preset.model) {
            document.getElementById('modelId').value = preset.model;
        }

        // è§¦å‘ä¿å­˜ï¼Œè®©è®¾ç½®ç«‹å³ç”Ÿæ•ˆ
        saveGlobalConfig();
        
        // è§†è§‰åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
    }
}

// 4. åˆ é™¤é¢„è®¾
function deleteCustomPreset() {
    const select = document.getElementById('customPresetSelect');
    const index = select.value;

    if (index === "") return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾");

    const presetName = globalConfig.customPresets[index].name;
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${presetName}" å—ï¼Ÿ`)) {
        globalConfig.customPresets.splice(index, 1);
        saveData();
        renderCustomPresets();
        
        // æ¸…ç©ºé€‰æ‹©
        select.value = "";
    }
}
        
       function saveGlobalConfig() {
    const provider = document.getElementById('apiProvider').value;
    const urlVal = document.getElementById('apiUrl').value; // è·å–å½“å‰å¡«å†™çš„ URL

    globalConfig.provider = provider;
    globalConfig.apiUrl = urlVal;
    
    // ğŸ”¥ å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡å¼ï¼ŒæŠŠ URL å•ç‹¬å­˜ä¸€ä»½â€œå¤‡ä»½â€
    if (provider === 'custom') {
        globalConfig.savedCustomUrl = urlVal;
    }

    globalConfig.apiKey = document.getElementById('apiKey').value;
    globalConfig.model = document.getElementById('modelId').value;
    globalConfig.temp = document.getElementById('tempVal').value;
    globalConfig.historyLimit = parseInt(document.getElementById('historyLimit').value) || 20;
    globalConfig.xiApiKey = document.getElementById('xiApiKey').value;
    globalConfig.xiVoiceId = document.getElementById('xiVoiceId').value;
    globalConfig.xiModelId = document.getElementById('xiModelId').value;
    
    saveData();
}

// --- Google Key ç®¡ç†ç³»ç»Ÿ ---

// 1. æ¸²æŸ“åˆ—è¡¨
function renderGoogleKeyList() {
    const con = document.getElementById('googleKeyList');
    con.innerHTML = '';
    
    if (!globalConfig.googleKeys || globalConfig.googleKeys.length === 0) {
        con.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">æš‚æ—  Keyï¼Œè¯·æ·»åŠ </div>';
        return;
    }

    globalConfig.googleKeys.forEach((kObj, index) => {
        // éšè— Key çš„ä¸­é—´éƒ¨åˆ†
        const maskKey = kObj.key.substring(0, 6) + "......" + kObj.key.substring(kObj.key.length - 4);
        
        // çŠ¶æ€æ ‡ç­¾
        let statusHtml = '';
        if (kObj.status === 'valid') statusHtml = '<span class="key-status valid">å¯ç”¨</span>';
        else if (kObj.status === 'invalid') statusHtml = '<span class="key-status invalid">æ— æ•ˆ</span>';
        else statusHtml = '<span class="key-status checking">æ£€æµ‹ä¸­</span>';

        const div = document.createElement('div');
        div.className = 'key-tag-item';
        div.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span style="font-family:monospace; color:#333;">${maskKey}</span>
                ${statusHtml}
            </div>
            <div class="btn-del-key" onclick="removeGoogleKey(${index})">Ã—</div>
        `;
        con.appendChild(div);
    });
}

// 2. æ·»åŠ  Key (ä¿®å¤éªŒè¯ç‰ˆ - ä¿æŒåŸç”Ÿ fetch)
async function addGoogleKey() {
    const input = document.getElementById('newGoogleKeyInput');
    const key = input.value.trim();
    
    if (!key) return alert("è¯·è¾“å…¥ Keyï¼");

    if (!globalConfig.googleKeys) globalConfig.googleKeys = [];

    if (globalConfig.googleKeys.find(k => k.key === key)) {
        return alert("è¿™ä¸ª Key å·²ç»æ·»åŠ è¿‡äº†");
    }

    const newObj = { key: key, status: 'checking' };
    globalConfig.googleKeys.push(newObj);
    
    saveGlobalConfig(); 
    input.value = ''; 
    renderGoogleKeyList(); 

    // --- ä¿®å¤åçš„éªŒè¯é€»è¾‘ ---
    try {
        // å»æ‰ ?limit=1ï¼Œç›´æ¥è¯·æ±‚ modelsï¼Œè¿™æ˜¯æœ€ç¨³çš„
        const res = await fetch("https://generativelanguage.googleapis.com/v1beta/openai/models", {
            headers: { "Authorization": "Bearer " + key }
        });
        
        if (res.ok) {
            newObj.status = 'valid';
            console.log("Key éªŒè¯æˆåŠŸ");
        } else {
            console.warn("Key éªŒè¯å¤±è´¥ status:", res.status);
            newObj.status = 'invalid';
        }
    } catch (e) {
        console.error("éªŒè¯å‡ºé”™:", e);
        newObj.status = 'invalid';
    }

    saveGlobalConfig(); 
    renderGoogleKeyList(); 
}

// --- âœ¨ æ–°å¢ï¼šä¸€é”®é‡æ–°æ£€æµ‹æ‰€æœ‰ Key âœ¨ ---
async function revalidateAllKeys() {
    if (!globalConfig.googleKeys || globalConfig.googleKeys.length === 0) return;

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "æ£€æµ‹ä¸­...";

    for (let kObj of globalConfig.googleKeys) {
        kObj.status = 'checking';
        renderGoogleKeyList();
        
        try {
            const res = await fetch("https://generativelanguage.googleapis.com/v1beta/openai/models", {
                headers: { "Authorization": "Bearer " + kObj.key }
            });
            kObj.status = res.ok ? 'valid' : 'invalid';
        } catch (e) {
            kObj.status = 'invalid';
        }
    }

    saveGlobalConfig();
    renderGoogleKeyList();
    btn.innerText = oldText;
    alert("æ‰€æœ‰ Key å·²é‡æ–°æ£€æµ‹å®Œæ¯•ï¼");
}

// 3. åˆ é™¤ Key
function removeGoogleKey(index) {
    if (confirm("ç¡®å®šåˆ é™¤è¿™ä¸ª Key å—ï¼Ÿ")) {
        globalConfig.googleKeys.splice(index, 1);
        saveGlobalConfig();
        renderGoogleKeyList();
    }
}

// --- âœ¨ æ–°å¢ï¼šåˆ‡æ¢ API ä¾›åº”å•†é€»è¾‘ (ä¿®å¤ç‰ˆ) âœ¨ ---
function toggleApiProvider() {
    const provider = document.getElementById('apiProvider').value;
    const urlInput = document.getElementById('apiUrl');
    
    const singleKeyContainer = document.getElementById('apiKey').closest('.ios-item');
    const googleMgr = document.getElementById('googleKeyManager');
    const presetMgr = document.getElementById('customPresetManager');

    if (provider === 'google') {
        // --- Google æ¨¡å¼ ---
        urlInput.value = "https://generativelanguage.googleapis.com/v1beta/openai";
        urlInput.disabled = true;
        urlInput.style.color = "#999"; 
        
        googleMgr.style.display = 'block';
        singleKeyContainer.style.display = 'none';
        if(presetMgr) presetMgr.style.display = 'none';
        
        renderGoogleKeyList();
    } else {
        // --- è‡ªå®šä¹‰æ¨¡å¼ ---
        urlInput.disabled = false;
        urlInput.style.color = "#007AFF";
        
        // æ¢å¤å¤‡ä»½çš„ URL
        urlInput.value = globalConfig.savedCustomUrl || "https://api.openai.com/v1";
        
        googleMgr.style.display = 'none';
        singleKeyContainer.style.display = 'flex';
        document.getElementById('apiKey').placeholder = "sk-...";
        if(presetMgr) presetMgr.style.display = 'block';
    }
    
    saveGlobalConfig();
}
        // --- ç¾åŒ–/ä¸»é¢˜ç³»ç»Ÿ (ç»ˆæç‰ˆ: å›¾æ ‡+å­—ä½“+å£çº¸) ---
    let themeConfig = {
            icons: { msg: "", mem: "", set: "", theme: "", diary: "", pomo: "", cal: "", sched: "", book: "" },
            customCss: "",
            bubbleCss: "",
            customFont: "",
            homeWallpaper: "" 
        };

    function loadTheme() {
        try {
            const t = localStorage.getItem('ai_phone_theme');
            if(t) themeConfig = JSON.parse(t);

            // 1. æ¢å¤å›¾æ ‡
            const iconMsg = document.getElementById('iconInput-msg');
            if(iconMsg) iconMsg.value = themeConfig.icons.msg || "";
            
            const iconMem = document.getElementById('iconInput-mem');
            if(iconMem) iconMem.value = themeConfig.icons.mem || "";
            
            const iconSet = document.getElementById('iconInput-set');
            if(iconSet) iconSet.value = themeConfig.icons.set || "";
            
            const iconTheme = document.getElementById('iconInput-theme');
            if(iconTheme) iconTheme.value = themeConfig.icons.theme || "";
            
            const iconDiary = document.getElementById('iconInput-diary');
            if(iconDiary) iconDiary.value = themeConfig.icons.diary || "";
            
            const iconPomo = document.getElementById('iconInput-pomo');
            if(iconPomo) iconPomo.value = themeConfig.icons.pomo || "";

            const iconCal = document.getElementById('iconInput-cal');
        if(iconCal) iconCal.value = themeConfig.icons.cal || "";

            const iconSched = document.getElementById('iconInput-sched');
            if(iconSched) iconSched.value = themeConfig.icons.sched || "";

            const iconBook = document.getElementById('iconInput-book');
if(iconBook) iconBook.value = themeConfig.icons.book || "";

            const iconWallet = document.getElementById('iconInput-wallet');
        if(iconWallet) iconWallet.value = themeConfig.icons.wallet || "";

            const iconForum = document.getElementById('iconInput-forum');
            if(iconForum) iconForum.value = themeConfig.icons.forum || "";

            const iconLudo = document.getElementById('iconInput-ludo');
if(iconLudo) iconLudo.value = themeConfig.icons.ludo || "";

            const iconTheater = document.getElementById('iconInput-theater');
if(iconTheater) iconTheater.value = themeConfig.icons.theater || "";

            const iconGallery = document.getElementById('iconInput-gallery');
if(iconGallery) iconGallery.value = themeConfig.icons.gallery || "";

            const iconCinema = document.getElementById('iconInput-cinema');
if(iconCinema) iconCinema.value = themeConfig.icons.cinema || "";

            // 2. æ¢å¤CSSå’Œå­—ä½“
            const cssInput = document.getElementById('customCssInput');
            if(cssInput) cssInput.value = themeConfig.customCss || "";

            // --- å…³é”®ç‚¹ï¼šé˜²æ­¢æŠ¥é”™ï¼Œå…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ ---
            const bubbleInput = document.getElementById('bubbleCssInput');
            if(bubbleInput) bubbleInput.value = themeConfig.bubbleCss || "";

            const fontInput = document.getElementById('fontInput');
            if(fontInput) fontInput.value = themeConfig.customFont || "";
            
            // 3. æ¢å¤å£çº¸
            const wpInput = document.getElementById('wallpaperInput');
            if(wpInput) wpInput.value = themeConfig.homeWallpaper || "";

            applyThemeUI();
        } catch(e) {
            console.error("åŠ è½½ä¸»é¢˜å‡ºé”™ï¼Œä½†è¿™ä¸å½±å“æ•°æ®å®‰å…¨", e);
        }
    }

    function saveTheme() {
        // ä½¿ç”¨å¯é€‰é“¾ (?.) é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
        themeConfig.icons.msg = document.getElementById('iconInput-msg')?.value || "";
        themeConfig.icons.mem = document.getElementById('iconInput-mem')?.value || "";
        themeConfig.icons.set = document.getElementById('iconInput-set')?.value || "";
        themeConfig.icons.theme = document.getElementById('iconInput-theme')?.value || "";
        themeConfig.icons.diary = document.getElementById('iconInput-diary')?.value || "";
        themeConfig.icons.pomo = document.getElementById('iconInput-pomo')?.value || "";
        themeConfig.icons.cal = document.getElementById('iconInput-cal')?.value || "";
        themeConfig.icons.sched = document.getElementById('iconInput-sched')?.value || "";
        themeConfig.icons.book = document.getElementById('iconInput-book')?.value || "";
        themeConfig.icons.wallet = document.getElementById('iconInput-wallet')?.value || "";
        themeConfig.icons.forum = document.getElementById('iconInput-forum')?.value || "";
        themeConfig.icons.ludo = document.getElementById('iconInput-ludo')?.value || "";
        themeConfig.icons.theater = document.getElementById('iconInput-theater')?.value || "";
        themeConfig.icons.gallery = document.getElementById('iconInput-gallery')?.value || "";
        themeConfig.icons.cinema = document.getElementById('iconInput-cinema')?.value || "";
        
        themeConfig.customCss = document.getElementById('customCssInput')?.value || "";
        themeConfig.bubbleCss = document.getElementById('bubbleCssInput')?.value || ""; // æ°”æ³¡ç¾åŒ–
        
        const fontInput = document.getElementById('fontInput');
        if(fontInput) themeConfig.customFont = fontInput.value;
        
        const wpInput = document.getElementById('wallpaperInput');
        if(wpInput) themeConfig.homeWallpaper = wpInput.value;

        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
        applyThemeUI();
    }

    function applyThemeUI() {
        // A. åº”ç”¨å›¾æ ‡
        updateAppIcon('app-icon-msg', themeConfig.icons.msg);
        updateAppIcon('app-icon-mem', themeConfig.icons.mem);
        updateAppIcon('app-icon-set', themeConfig.icons.set);
        updateAppIcon('app-icon-theme', themeConfig.icons.theme);
        updateAppIcon('app-icon-diary', themeConfig.icons.diary);
        updateAppIcon('app-icon-pomo', themeConfig.icons.pomo);
        updateAppIcon('app-icon-cal', themeConfig.icons.cal);
        updateAppIcon('app-icon-sched', themeConfig.icons.sched);
        updateAppIcon('app-icon-book', themeConfig.icons.book);
        updateAppIcon('app-icon-wallet', themeConfig.icons.wallet);
        updateAppIcon('app-icon-forum', themeConfig.icons.forum);
        updateAppIcon('app-icon-ludo', themeConfig.icons.ludo);
        updateAppIcon('app-icon-theater', themeConfig.icons.theater);
        updateAppIcon('app-icon-gallery', themeConfig.icons.gallery);
        updateAppIcon('app-icon-cinema', themeConfig.icons.cinema);

        // B. åº”ç”¨å£çº¸
        const homePage = document.getElementById('page-home');
        if (themeConfig.homeWallpaper && themeConfig.homeWallpaper.trim() !== "") {
            homePage.style.backgroundImage = `url(${themeConfig.homeWallpaper})`;
        } else {
            homePage.style.backgroundImage = "url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop')";
        }

        // C. åº”ç”¨å­—ä½“å’ŒCSS
        let styleTag = document.getElementById('user-custom-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'user-custom-style';
            document.head.appendChild(styleTag);
        }

        let finalCss = themeConfig.customCss || "";
        // åªæœ‰å½“æœ‰å­—ä½“æ—¶æ‰æ‹¼æ¥å­—ä½“è§„åˆ™
        if (themeConfig.customFont && themeConfig.customFont.trim() !== "") {
            const fontRule = `
                @font-face { font-family: 'UserCustomFont'; src: url('${themeConfig.customFont}'); font-display: swap; }
                body, button, input, textarea, select, .clock-time, .app-title, .chat-contact-name, .theater-stage, .t-text { font-family: 'UserCustomFont', -apple-system, sans-serif !important; }
            `;
            finalCss = fontRule + "\n" + finalCss;
        }
        styleTag.innerHTML = finalCss;

        // D. åº”ç”¨æ°”æ³¡ç¾åŒ– (ç‹¬ç«‹æ ·å¼æ ‡ç­¾) - ã€ä¿®å¤ï¼šç§»åˆ°äº†ifå¤–é¢ã€‘
        let bubbleStyleTag = document.getElementById('user-bubble-style');
        if (!bubbleStyleTag) {
            bubbleStyleTag = document.createElement('style');
            bubbleStyleTag.id = 'user-bubble-style';
            document.head.appendChild(bubbleStyleTag);
        }
        bubbleStyleTag.innerHTML = themeConfig.bubbleCss || "";
    }

    function updateAppIcon(elementId, url) {
        const el = document.getElementById(elementId);
        if(!el) return;
        if (url && url.trim() !== "") {
            el.style.backgroundImage = `url(${url})`;
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            el.style.color = 'transparent';
        } else {
            el.style.backgroundImage = '';
            el.style.color = 'white';
        }
    }

    function resetTheme() {
        if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®å—ï¼Ÿ")) {
            localStorage.removeItem('ai_phone_theme');
            location.reload();
        }
    }

        async function fetchModels() {
    if(!globalConfig.apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
    
    // è·å–å½“å‰é€‰ä¸­çš„ä¾›åº”å•†
    const provider = document.getElementById('apiProvider').value; 
    
    const btn = event.target;
    btn.innerText = "åŠ è½½ä¸­...";
    try {
        let headers = {};
if(globalConfig.provider === 'google' && globalConfig.googleKeys.length > 0) {
    // Google æ¨¡å¼ï¼šéšä¾¿æ‹¿ç¬¬ä¸€ä¸ªå¯ç”¨çš„ Key å³å¯ï¼Œæˆ–è€…ç¨å¾®å†™ä¸ªç®€æ˜“è½®è¯¢
    // è¿™é‡Œç®€å•èµ·è§ï¼Œæ‰¾ç¬¬ä¸€ä¸ª valid çš„
    const validKey = globalConfig.googleKeys.find(k => k.status !== 'invalid') || globalConfig.googleKeys[0];
    headers["Authorization"] = "Bearer " + validKey.key;
} else {
    headers["Authorization"] = "Bearer " + globalConfig.apiKey;
}

const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/models', {
    headers: headers
});
        
        if (!res.ok) throw new Error("API è¯·æ±‚å¤±è´¥: " + res.status);

        const data = await res.json();
        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ¨¡å‹</option>';
        
        // å…¼å®¹ OpenAI æ ‡å‡† (data.data) å’Œ Google åŸç”Ÿåˆ—è¡¨ (data.models æˆ– data)
        let list = data.data || data.models || data; 
        
        if(Array.isArray(list)) {
            // æ’åº
            list.sort((a,b) => a.id.localeCompare(b.id));
            
            list.forEach(m => {
                let cleanId = m.id;

                // âœ¨âœ¨âœ¨ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯ Googleï¼Œå»æ‰ models/ å‰ç¼€ âœ¨âœ¨âœ¨
                if (provider === 'google' && cleanId.startsWith('models/')) {
                    cleanId = cleanId.replace('models/', '');
                }

                // è¿‡æ»¤æ‰ä¸€äº›è‚¯å®šä¸èƒ½ç”¨æ¥èŠå¤©çš„æ¨¡å‹ (å¯é€‰ä¼˜åŒ–)
                // æ¯”å¦‚ embedding (åµŒå…¥æ¨¡å‹) æˆ– aqa (é—®ç­”æ¨¡å‹)
                if (cleanId.includes('embedding') || cleanId.includes('aqa')) return;

                const opt = document.createElement('option');
                opt.value = cleanId;
                opt.innerText = cleanId; // æ˜¾ç¤ºå¹²å‡€çš„åå­—
                select.appendChild(opt);
            });
            document.getElementById('modelSelectContainer').style.display = 'flex';
        } else {
            alert("API è¿”å›æ ¼å¼æœªèƒ½è¯†åˆ«");
        }
    } catch(e) {
        alert("è·å–æ¨¡å‹å¤±è´¥: " + e.message);
    }
    btn.innerText = "â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨";
}

        function resetAll() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- å·¥å…·å‡½æ•° ---
        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }
        function closeModal(id) { 
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 200);
        }
        function formatText(text) { return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); }
        function normalizeUrl(u) { return u.endsWith('/') ? u.slice(0,-1) : u; }
        function scrollToBottom() { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const t = now.toLocaleTimeString('zh-CN', {hour12:false,hour:'2-digit',minute:'2-digit'});
                document.getElementById('clockTime').innerText = t;
                document.getElementById('clockDate').innerText = now.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'long'});
            }, 1000);
        }
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            fileToBase64(f).then(res => {
                currentImg = res;
                document.getElementById('img-preview-blob').src = currentImg;
                document.getElementById('uploadPreview').style.display = 'flex';
            });
        }
        function clearUpload() { currentImg=null; document.getElementById('uploadPreview').style.display='none'; document.getElementById('fileInput').value=''; }
        function fileToBase64(file) {
            return new Promise(resolve => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    // ç®€å•å‹ç¼©
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = Math.min(1, 800/img.width); // é™åˆ¶æœ€å¤§å®½åº¦800
                        cvs.width = img.width * scale; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }
        
        // å¯¼å‡º/å¯¼å…¥
        // --- æ•°æ®å¤‡ä»½ä¸æ¢å¤ (å…¨é‡ç‰ˆ) ---
        function exportData() {
            // æŠŠ è®¾ç½®ã€è”ç³»äºº(å«è®°å¿†)ã€ç¾åŒ–æ•°æ® æ‰“åŒ…åœ¨ä¸€èµ·
            const backupPayload = {
                globalConfig: globalConfig,
                contacts: contacts,
                themeConfig: themeConfig 
            };
            
            const blob = new Blob([JSON.stringify(backupPayload)], {type:'application/json'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'ai_phone_full_backup.json'; // æ”¹ä¸ªåå­—ï¼Œå«å…¨é‡å¤‡ä»½
            a.click();
        }

        function importData(e) {
            const f = e.target.files[0]; 
            if(!f) return;
            
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    
                    // 1. æ¢å¤å…¨å±€è®¾ç½®
                    if(d.globalConfig) {
                        globalConfig = d.globalConfig;
                        localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
                    }

                    // 2. æ¢å¤è”ç³»äºº (åŒ…å«èŠå¤©è®°å½•ã€è®°å¿†åº“)
                    if(d.contacts) {
                        contacts = d.contacts;
                        localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
                    }

                    // 3. æ¢å¤ç¾åŒ–è®¾ç½® (å›¾æ ‡ã€CSSã€å­—ä½“)
                    if(d.themeConfig) {
                        themeConfig = d.themeConfig;
                        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
                    }

                    alert("ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†é‡æ–°åŠ è½½ä»¥åº”ç”¨æ›´æ”¹ã€‚");
                    location.reload(); // åˆ·æ–°é¡µé¢ï¼Œè®©æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆ
                    
                } catch(e) {
                    alert("âŒ æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å†…å®¹å·²æŸåã€‚\n" + e.message);
                }
            }; 
            r.readAsText(f);
            // æ¸…ç©º input é˜²æ­¢åŒåæ–‡ä»¶æ— æ³•å†æ¬¡è§¦å‘
            e.target.value = ''; 
        }
        // === å‡çº§ç‰ˆï¼šå…¨å±€è¿æ¥æµ‹è¯• (æ”¯æŒ Google è½®è¯¢ + çœŸå®å¯¹è¯) ===
async function testConn() {
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨æµ‹è¯•é“¾æ¥...";
    btn.disabled = true;

    // 1. è·å–å½“å‰è®¾ç½®
    const provider = document.getElementById('apiProvider').value;
    // ä¼˜å…ˆç”¨è¾“å…¥æ¡†é‡Œçš„æ¨¡å‹ï¼Œå¦‚æœæ²¡å¡«ï¼Œé»˜è®¤ç”¨ gpt-3.5-turbo è¯•æ¢
    const model = document.getElementById('modelId').value.trim() || "gpt-3.5-turbo";
    
    // å‡†å¤‡è¦æµ‹è¯•çš„ URL å’Œ Key åˆ—è¡¨
    let apiUrl = "";
    let keysToTest = [];

    try {
        if (provider === 'google') {
            // --- Google æ¨¡å¼ ---
            apiUrl = "https://generativelanguage.googleapis.com/v1beta/openai";
            
            // æ£€æŸ¥é’¥åŒ™åŒ…
            if (!globalConfig.googleKeys || globalConfig.googleKeys.length === 0) {
                throw new Error("Google é’¥åŒ™åŒ…ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ  Keyï¼");
            }
            
            // æå–æ‰€æœ‰çŠ¶æ€ä¸æ˜¯ 'invalid' çš„ Key (åŒ…æ‹¬ checking å’Œ valid)
            // å¦‚æœå…¨æ˜¯ invalidï¼Œå°±ç¡¬ç€å¤´çš®è¯•ç¬¬ä¸€ä¸ªï¼Œæ­»é©¬å½“æ´»é©¬åŒ»
            const validKeys = globalConfig.googleKeys.filter(k => k.status !== 'invalid');
            if (validKeys.length > 0) {
                keysToTest = validKeys.map(k => k.key);
            } else {
                keysToTest = [globalConfig.googleKeys[0].key];
            }

        } else {
            // --- è‡ªå®šä¹‰æ¨¡å¼ ---
            apiUrl = document.getElementById('apiUrl').value.trim();
            const singleKey = document.getElementById('apiKey').value.trim();
            
            if (!apiUrl || !singleKey) throw new Error("è¯·å¡«å†™ API URL å’Œ Key");
            keysToTest = [singleKey];
        }

        const cleanUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        
        // æ„é€ è½»é‡è½½è·
        const payload = {
            model: model,
            messages: [{ role: "user", content: "Hi" }],
            max_tokens: 5
        };

        // 2. å¾ªç¯æµ‹è¯• (è½®è¯¢é€»è¾‘)
        let success = false;
        let lastError = null;
        let successReply = "";

        for (let i = 0; i < keysToTest.length; i++) {
            const currentKey = keysToTest[i];
            
            // UI åé¦ˆä¸€ä¸‹è¿›åº¦
            if (keysToTest.length > 1) {
                btn.innerText = `å°è¯• Key ${i + 1}/${keysToTest.length}...`;
            }

            try {
                const res = await fetch(cleanUrl + '/chat/completions', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + currentKey
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    successReply = data.choices?.[0]?.message?.content || "OK";
                    success = true;
                    
                    // å¦‚æœæ˜¯ Google æ¨¡å¼ï¼Œé¡ºä¾¿åœ¨æ§åˆ¶å°æ‰“å°æ˜¯ç¬¬å‡ ä¸ª Key æˆåŠŸçš„
                    if (provider === 'google') {
                        console.log(`Google Key æµ‹è¯•é€šè¿‡: é’¥åŒ™åŒ…ç¬¬ ${i+1} ä¸ª Key æœ‰æ•ˆ`);
                    }
                    
                    break; // åªè¦æœ‰ä¸€ä¸ªæˆåŠŸï¼Œç›´æ¥è·³å‡ºå¾ªç¯
                } else {
                    // è®°å½•é”™è¯¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
                    const errText = await res.text();
                    let errMsg = `Code ${res.status}`;
                    try { errMsg = JSON.parse(errText).error.message; } catch(e){}
                    lastError = new Error(errMsg);
                }
            } catch (e) {
                lastError = e;
            }
        }

        // 3. æœ€ç»ˆåˆ¤å®š
        if (success) {
            alert(`âœ… è¿æ¥æˆåŠŸï¼\n\n(å¦‚æœæ˜¯ Google æ¨¡å¼ï¼Œè¯´æ˜é’¥åŒ™åŒ…é‡Œè‡³å°‘æœ‰ä¸€ä¸ª Key å¯ç”¨)\n\næ¨¡å‹å“åº”: ${successReply}`);
        } else {
            throw lastError || new Error("æ‰€æœ‰ Key æµ‹è¯•å‡å¤±è´¥");
        }

    } catch (e) {
        alert("âŒ è¿æ¥å¤±è´¥:\n" + e.message + "\n\n(æç¤º: è¯·ç¡®ä¿ URL æ­£ç¡®ä¸”æ¨¡å‹ ID æ‰‹åŠ¨å¡«å†™æ­£ç¡®)");
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}
        // --- 5. æ—¥è®°æœ¬æ¸²æŸ“é€»è¾‘ (æ–°å¢) ---
    // ==========================================
// --- æ–°ç‰ˆæ—¥è®°æœ¬é€»è¾‘ (äº¤æ¢æ—¥è®°ç³»ç»Ÿ) ---
// ==========================================

// 1. æ—¥è®°æœ¬é¦–é¡µï¼šæ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨
function renderDiaries() {
    const container = document.getElementById('diaryListContainer');
    container.innerHTML = ''; // æ¸…ç©º

    // --- A. â€œæˆ‘çš„æ—¥è®°â€å…¥å£ (å›ºå®šåœ¨é¡¶éƒ¨) ---
    // ä¸ºäº†é€»è¾‘ç®€å•ï¼Œç‚¹å‡»â€œæˆ‘çš„æ—¥è®°â€æˆ‘ä»¬è®©ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹å“ªä¸ªè§’è‰²çš„å¾€æ¥ï¼Œæˆ–è€…é»˜è®¤æ˜¾ç¤ºå½“å‰æ´»è·ƒè§’è‰²çš„
    // è¿™é‡Œæˆ‘ä»¬è®¾è®¡ä¸ºï¼šé¦–é¡µæ˜¾ç¤ºæ‰€æœ‰â€œè”ç³»äººæ—¥è®°æœ¬â€ + ä¸€ä¸ªâ€œæ‰€æœ‰æˆ‘çš„æ—¥è®°â€åˆé›†(å¯é€‰)ï¼Œ
    // æŒ‰ç…§ä½ çš„éœ€æ±‚ï¼Œæˆ‘ä»¬æŠŠâ€œæˆ‘çš„æ—¥è®°â€ä½œä¸ºä¸€ä¸ªæ€»å…¥å£ï¼Œè¿›å»åå†çœ‹å‘ç»™è°çš„ï¼Œæˆ–è€…ç®€å•ç‚¹ï¼š
    // ç•Œé¢å˜æˆï¼š
    // [ ğŸ“’ æˆ‘çš„æ—¥è®° (æˆ‘å†™çš„æ‰€æœ‰å†…å®¹) ]
    // [ ğŸ¤– è§’è‰²A çš„æ—¥è®° ]
    // [ ğŸ¤– è§’è‰²B çš„æ—¥è®° ]
    
    // æ¸²æŸ“ "æˆ‘çš„æ—¥è®°" æ–‡ä»¶å¤¹
    const myDiv = document.createElement('div');
    myDiv.className = 'diary-folder';
    myDiv.onclick = () => renderUserDiaryList(); // è¿›å…¥æˆ‘çš„æ—¥è®°åˆ—è¡¨
    myDiv.innerHTML = `
        <img src="https://i.postimg.cc/YC4xQqFs/IMG-9655.jpg" class="diary-icon" style="object-fit:cover;">
        <div class="diary-info">
            <div class="diary-title">æˆ‘çš„æ—¥è®°æœ¬</div>
            <div class="diary-sub">è®°å½•æˆ‘çš„å¿ƒæƒ…</div>
        </div>
        <div style="color:#ccc;">â€º</div>
    `;
    container.appendChild(myDiv);

    // æ¸²æŸ“ åˆ†å‰²çº¿
    const sep = document.createElement('div');
    sep.innerText = "äº¤æ¢æ—¥è®°å¯¹è±¡";
    sep.className = "ios-group-title";
    container.appendChild(sep);

    // --- B. è§’è‰²æ—¥è®°å…¥å£åˆ—è¡¨ ---
    contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'diary-folder';
        div.onclick = () => renderAiDiaryList(c.id); // è¿›å…¥è§’è‰²çš„æ—¥è®°åˆ—è¡¨
        div.innerHTML = `
            <img src="${c.avatar}" class="diary-icon" style="object-fit:cover;">
            <div class="diary-info">
                <div class="diary-title">${c.name} çš„æ—¥è®°</div>
                <div class="diary-sub">å…± ${c.diaries ? c.diaries.length : 0} ç¯‡</div>
            </div>
            <div style="color:#ccc;">â€º</div>
        `;
        container.appendChild(div);
    });
}

// 2. æ¸²æŸ“â€œæˆ‘çš„æ—¥è®°â€åˆ—è¡¨ (æ˜¾ç¤ºæˆ‘å†™ç»™å½“å‰/æ‰€æœ‰è§’è‰²çš„)
function renderUserDiaryList() {
    const container = document.getElementById('diaryListContainer');
    // å¤´éƒ¨å¯¼èˆª
    const headerHtml = `
        <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; align-items:center;">
            <button onclick="renderDiaries()" style="border:none;background:none;color:#007AFF;font-size:16px;">â€¹ è¿”å›</button>
            <span style="font-weight:bold; margin-left:15px; font-size:18px;">æˆ‘çš„æ—¥è®°</span>
        </div>
    `;
    
    let listHtml = '<div style="padding-bottom:80px;">';
    
    // æ”¶é›†æ‰€æœ‰è§’è‰²é‡Œçš„ userDiaries
    let allMyDiaries = [];
    contacts.forEach(c => {
        if(c.userDiaries && c.userDiaries.length > 0) {
            c.userDiaries.forEach((content, idx) => {
                allMyDiaries.push({
                    content: content,
                    charName: c.name,
                    charId: c.id,
                    originalIndex: idx, // âœ¨ è®°å½•åŸå§‹ç´¢å¼•ï¼Œç”¨äºåˆ é™¤
                    time: Date.now() 
                });
            });
        }
    });

    if (allMyDiaries.length === 0) {
        listHtml += '<div style="text-align:center; color:#999; margin-top:50px;">ä½ è¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°<br>ç‚¹å‡»å³ä¸‹è§’ç¬”å¤´å¼€å§‹å†™å§</div>';
    } else {
        // å€’åºæ˜¾ç¤º
        allMyDiaries.reverse().forEach(item => {
            listHtml += `
                <div class="memory-card" style="border-left: 4px solid #007AFF; position: relative;">
                    <div style="font-size:12px; color:#007AFF; margin-bottom:5px;">å¯„ç»™: ${item.charName}</div>
                    <div style="line-height:1.6; color:#333; padding-right: 20px;">${item.content.replace(/\n/g, '<br>')}</div>
                    
                    <!-- âœ¨ æ–°å¢ï¼šåˆ é™¤æŒ‰é’® -->
                    <div class="btn-del-mem" onclick="deleteUserDiary('${item.charId}', ${item.originalIndex})">Ã—</div>
                </div>
            `;
        });
    }
    listHtml += '</div>';

    // æ·»åŠ æ‚¬æµ®å†™ä½œæŒ‰é’®
    listHtml += `<button class="btn-float-write" onclick="openDiaryWriter()">+</button>`;

    container.innerHTML = headerHtml + listHtml;
}

// æ¸²æŸ“â€œè§’è‰²æ—¥è®°â€åˆ—è¡¨ (æŸ¥çœ‹AIå†™çš„)
function renderAiDiaryList(charId) {
    const char = contacts.find(c => c.id === charId);
    if (!char) return;

    // === ğŸ› ï¸ æ•°æ®è‡ªåŠ¨å‡çº§é€»è¾‘ ğŸ› ï¸ ===
    // å¦‚æœå‘ç°æ—¥è®°æ˜¯çº¯å­—ç¬¦ä¸²ï¼ŒæŠŠå®ƒå˜æˆå¯¹è±¡ { content:String, isStarred:Boolean }
    if (char.diaries && char.diaries.length > 0) {
        let needSave = false;
        char.diaries = char.diaries.map(d => {
            if (typeof d === 'string') {
                needSave = true;
                return { content: d, isStarred: false, timestamp: Date.now() };
            }
            return d;
        });
        if (needSave) saveData(); // ä¿å­˜å‡çº§åçš„æ•°æ®ç»“æ„
    }
    // ============================

    const container = document.getElementById('diaryListContainer');
    const headerHtml = `
        <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; align-items:center;">
            <button onclick="renderDiaries()" style="border:none;background:none;color:#007AFF;font-size:16px;">â€¹ è¿”å›</button>
            <span style="font-weight:bold; margin-left:15px; font-size:18px;">${char.name} çš„æ—¥è®°</span>
        </div>
    `;

    let listHtml = '<div style="padding:15px;">';
    
    if (!char.diaries || char.diaries.length === 0) {
        listHtml += '<div style="text-align:center; color:#999; margin-top:50px;">Ta è¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°</div>';
    } else {
        // å€’åºæ˜¾ç¤º
        [...char.diaries].reverse().forEach((item, index) => {
            // è®¡ç®—åŸå§‹ç´¢å¼•
            const originalIndex = char.diaries.length - 1 - index;
            
            // åˆ¤æ–­æ˜¯å¦æ”¶è—
            const starClass = item.isStarred ? 'diary-star active' : 'diary-star';
            const starIcon = item.isStarred ? 'â˜…' : 'â˜†'; // å®å¿ƒæ˜Ÿ/ç©ºå¿ƒæ˜Ÿ

            listHtml += `
                <div class="memory-card" style="border-left: 4px solid #ff2d55; position:relative;">
                    <div style="line-height:1.6; color:#333; padding-right:20px;">${item.content.replace(/\n/g, '<br>')}</div>
                    
                    <!-- æ˜Ÿæ˜ŸæŒ‰é’® -->
                    <div class="${starClass}" onclick="toggleDiaryStar('${charId}', ${originalIndex})">${starIcon}</div>
                    
                    <!-- åˆ é™¤æŒ‰é’® -->
                    <div class="btn-del-mem" onclick="deleteDiary('${charId}', ${originalIndex})">Ã—</div>
                </div>
            `;
        });
    }
    listHtml += '</div>';
    container.innerHTML = headerHtml + listHtml;
}
        // åˆ‡æ¢æ—¥è®°æ”¶è—çŠ¶æ€
function toggleDiaryStar(charId, index) {
    const char = contacts.find(c => c.id === charId);
    if (!char || !char.diaries[index]) return;

    // åˆ‡æ¢çŠ¶æ€
    char.diaries[index].isStarred = !char.diaries[index].isStarred;
    saveData();
    
    // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
    renderAiDiaryList(charId);
    
    // ç»™ä¸ªéœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    if(navigator.vibrate) navigator.vibrate(50);
}

// 4. åˆ é™¤é€»è¾‘
function deleteDiary(charId, index) {
    const char = contacts.find(c => c.id === charId);
    if (confirm('ç¡®å®šè¦æ’•æ‰è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
        char.diaries.splice(index, 1);
        saveData();
        renderAiDiaryList(charId); // åˆ·æ–°å½“å‰åˆ—è¡¨
    }
}
        // åˆ é™¤æˆ‘çš„æ—¥è®°
function deleteUserDiary(charId, index) {
    const char = contacts.find(c => c.id === charId);
    if (!char) return;

    if (confirm(`ç¡®å®šè¦æ’•æ‰è¿™ç¯‡å¯„ç»™ ${char.name} çš„æ—¥è®°å—ï¼Ÿ`)) {
        // ä»æ•°ç»„ä¸­ç§»é™¤
        char.userDiaries.splice(index, 1);
        saveData();
        
        // åˆ·æ–°åˆ—è¡¨
        renderUserDiaryList();
        
        // éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
    }
}

// =======================
// --- å†™æ—¥è®°ä¸äº¤äº’é€»è¾‘ ---
// =======================

// æ‰“å¼€å†™ä½œå¼¹çª—
function openDiaryWriter() {
    // é»˜è®¤å‘ç»™å½“å‰æ´»è·ƒçš„è§’è‰²ï¼Œå¦‚æœæ²¡æœ‰æ´»è·ƒè§’è‰²ï¼Œåˆ™æç¤ºé€‰æ‹©æˆ–è€…é»˜è®¤ç¬¬ä¸€ä¸ª
    let targetId = activeContactId; 
    
    if (!targetId && contacts.length > 0) {
        targetId = contacts[0].id; // é»˜è®¤ç¬¬ä¸€ä¸ª
    }

    if (!targetId) return alert("è¯·å…ˆåˆ›å»ºä¸€ä¸ªè§’è‰²ï¼");

    const char = contacts.find(c => c.id === targetId);
    
    document.getElementById('diary-target-char-id').value = targetId;
    document.getElementById('diary-target-name').innerText = char.name;
    document.getElementById('user-diary-input').value = ''; // æ¸…ç©º
    
    openModal('modal-write-diary');
}

// æäº¤æ—¥è®°
async function submitUserDiary() {
    const targetId = document.getElementById('diary-target-char-id').value;
    const content = document.getElementById('user-diary-input').value.trim();
    const char = contacts.find(c => c.id === targetId);

    if (!content) return alert("å†™ç‚¹ä»€ä¹ˆå§ï¼");

    // 1. ä¿å­˜ç”¨æˆ·çš„æ—¥è®°
    if (!char.userDiaries) char.userDiaries = [];
    
    const dateStr = new Date().toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const finalContent = `[${dateStr}]\n${content}`;
    
    char.userDiaries.push(finalContent);
    saveData();
    closeModal('modal-write-diary');
    
    // åˆ·æ–°ä¸€ä¸‹æ˜¾ç¤º
    renderUserDiaryList();

    // 2. è§¦å‘ AI å›å¤ (äº¤æ¢æ—¥è®°æ ¸å¿ƒ)
    alert(`æ—¥è®°å·²ä¿å­˜ï¼æ­£åœ¨åŒæ­¥ç»™ ${char.name}ï¼Œè¯·ç¨ç­‰ Ta çš„å›ä¿¡...`);
    
    await generateDiaryReply(char, finalContent);
}

// AI ç”Ÿæˆå›å¤æ—¥è®°
async function generateDiaryReply(char, userDiaryContent) {
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key æ‰èƒ½æ”¶åˆ°å›ä¿¡å“¦");

    const prompt = `
    ã€äº¤æ¢æ—¥è®°æ¨¡å¼ã€‘
    ç”¨æˆ·ï¼ˆä½ çš„æ‹äººï¼‰åˆšåˆšåœ¨ä½ ä»¬çš„äº¤æ¢æ—¥è®°æœ¬é‡Œå†™ä¸‹äº†ä¸€ç¯‡æ—¥è®°ã€‚
    è¯·ä½ é˜…è¯»è¿™ç¯‡æ—¥è®°ï¼Œç„¶åä»¥æ—¥è®°çš„å½¢å¼å†™ä¸€ç¯‡â€œè¯»åæ„Ÿâ€æˆ–â€œå›ä¿¡â€ã€‚
    
    ç”¨æˆ·çš„æ—¥è®°å†…å®¹ï¼š
    "${userDiaryContent}"
    
    ä½ çš„è¦æ±‚ï¼š
    1. æ ¼å¼å¿…é¡»æ˜¯æ—¥è®°æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š[æ—¥æœŸ] ä»Šå¤©è¯»äº†XXçš„æ—¥è®°...ï¼‰ã€‚
    2. è¯­æ°”è¦ç¬¦åˆä½ çš„äººè®¾ï¼ˆ${char.systemPrompt}ï¼‰ã€‚
    3. å†…å®¹è¦é’ˆå¯¹ç”¨æˆ·å†™çš„äº‹æƒ…è¿›è¡Œå›åº”ã€å®‰æ…°ã€åæ§½æˆ–åˆ†äº«ä½ çš„ç›¸å…³æ„Ÿå—ã€‚
    4. è¦åƒçœŸå®çš„æ—¥è®°ä¸€æ ·è‡ªç„¶ã€‚
    `;

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [
        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨å†™æ—¥è®°çš„è§’è‰²ã€‚" },
        { role: "user", content: prompt }
    ],
    temperature: 0.8
});

        const data = await res.json();
        const reply = data.choices[0].message.content;

        // ä¿å­˜ AI çš„æ—¥è®°
        char.diaries.push(reply);
        saveData();

        alert(`æ”¶åˆ° ${char.name} çš„äº¤æ¢æ—¥è®°å›ä¿¡å•¦ï¼å¿«å» Ta çš„æ—¥è®°æœ¬é‡Œçœ‹çœ‹å§ï¼`);
        
        // å¦‚æœå½“å‰è¿˜åœ¨æˆ‘çš„æ—¥è®°ç•Œé¢ï¼Œå¯ä»¥ä¸ç”¨è·³ï¼Œæˆ–è€…ç»™ä¸ªçº¢ç‚¹æç¤ºï¼ˆè¿™é‡Œç®€å•å¤„ç†ï¼Œä¸åšè·³è½¬ï¼‰
        
    } catch (e) {
        console.error(e);
        alert("åŒæ­¥å¤±è´¥ï¼ŒTa å¥½åƒæ²¡æ”¶åˆ°æ—¥è®°...");
    }
}
        // --- 6. åˆ é™¤æŒ‡å®šèŒƒå›´æ¶ˆæ¯çš„é€»è¾‘ (æ–°) ---
    function openDeleteMsgModal() {
        const char = getActiveChar();
        if(!char) return;
        
        // å…ˆå…³é—­è®¾ç½®å¼¹çª—ï¼Œå†å¼€åˆ é™¤å¼¹çª—ï¼Œä½“éªŒæ›´å¥½
        closeModal('modal-chat-settings');

        const total = char.messages.length;
        if (total === 0) return alert("åœ¨è¿™ä¸ªèŠå¤©ä¸­è¿˜æ²¡æœ‰æ¶ˆæ¯å“¦");

        document.getElementById('del-total-count').innerText = total;
        // é»˜è®¤å¡«å…¥ï¼šä»æœ€åä¸€æ¡åˆ åˆ°æœ€åä¸€æ¡ï¼ˆå³åˆ é™¤æœ€æ–°çš„ä¸€æ¡ï¼‰
        document.getElementById('del-start').value = total; 
        document.getElementById('del-end').value = total;
        
        openModal('modal-del-msg');
    }

    function commitDeleteMsg() {
        const char = getActiveChar();
        const startVal = parseInt(document.getElementById('del-start').value);
        const endVal = parseInt(document.getElementById('del-end').value);
        const total = char.messages.length;

        // 1. æ ¡éªŒè¾“å…¥
        if (isNaN(startVal) || isNaN(endVal)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        if (startVal < 1 || startVal > total) return alert("èµ·å§‹æ¥¼å±‚ä¸å­˜åœ¨");
        if (endVal < 1 || endVal > total) return alert("ç»“æŸæ¥¼å±‚ä¸å­˜åœ¨");
        if (startVal > endVal) return alert("èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚");

        // 2. è®¡ç®—åˆ é™¤æ•°é‡
        // æ¯”å¦‚è¦åˆ ç¬¬3æ¡åˆ°ç¬¬5æ¡ (3, 4, 5)ï¼Œé‚£å°±æ˜¯åˆ æ‰ (5-3)+1 = 3æ¡
        // æ•°ç»„ç´¢å¼•æ˜¯ 0-basedï¼Œæ‰€ä»¥ç¬¬3æ¡å¯¹åº”çš„ç´¢å¼•æ˜¯ 2
        const startIndex = startVal - 1;
        const deleteCount = endVal - startVal + 1;

        if (confirm(`âš ï¸  \n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç¬¬ ${startVal} åˆ° ${endVal} æ¥¼çš„ ${deleteCount} æ¡æ¶ˆæ¯å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
            
            // æ‰§è¡Œåˆ é™¤ (spliceä¼šä¿®æ”¹åŸæ•°ç»„)
            char.messages.splice(startIndex, deleteCount);
            
            saveData(); // ä¿å­˜
            
            // åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            updateContactList(); // åˆ—è¡¨é‡Œçš„é¢„è§ˆæ–‡å­—ä¹Ÿå¯èƒ½å˜äº†
            
            closeModal('modal-del-msg');
            alert("åˆ é™¤æˆåŠŸï¼");
        }
    }
        // --- 7. æ¶ˆæ¯ç¼–è¾‘ä¸é‡åˆ· (æ–°åŠŸèƒ½) ---

    // åŠŸèƒ½Aï¼šAI é‡åˆ· (Re-roll)
    function rerollMessage(uiIndex) {
        const char = getActiveChar();
        // uiIndex æ˜¯ä»1å¼€å§‹çš„ï¼Œæ•°ç»„æ˜¯ä»0å¼€å§‹çš„
        const arrayIndex = uiIndex - 1;
        
        if(arrayIndex < 0 || arrayIndex >= char.messages.length) return;

        // é€»è¾‘ï¼šåˆ é™¤ è¿™æ¡AIæ¶ˆæ¯ ä»¥åŠ å®ƒä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        // å› ä¸ºé‡åˆ·æ„å‘³ç€æ—¶é—´çº¿å˜åŠ¨ï¼Œåé¢çš„å¯¹è¯å°±ä½œåºŸäº†
        if(confirm("è¦è®©ä»–é‡æ–°å›ç­”è¿™ä¸€å¥å—ï¼Ÿ(ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)")) {
            char.messages.splice(arrayIndex, 999); // åˆ é™¤å½“å‰åŠä¹‹åæ‰€æœ‰
            saveData();
            
            // åˆ·æ–°ç•Œé¢æ˜¾ç¤ºåˆ é™¤åçš„çŠ¶æ€
            renderChat(activeContactId);
            
            // ç«‹å³è§¦å‘ AI ç”Ÿæˆ
            triggerAI();
        }
    }

    // åŠŸèƒ½Bï¼šç”¨æˆ·é•¿æŒ‰ç¼–è¾‘
    function handleUserEdit(e, uiIndex) {
        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„å³é”®èœå•
        
        const char = getActiveChar();
        const arrayIndex = uiIndex - 1;
        const msg = char.messages[arrayIndex];
        
        if(!msg) return;

        // ä½¿ç”¨ prompt è®©ç”¨æˆ·ä¿®æ”¹æ–‡æœ¬
        const newText = prompt("ç¼–è¾‘æ¶ˆæ¯ï¼š", msg.content);
        
        // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆæˆ–è€…å†…å®¹æ²¡å˜ï¼Œå°±ä¸åŠ¨
        if (newText === null || newText === msg.content) return;

        if(confirm("ä¿®æ”¹åï¼Œä»–å°†æ ¹æ®æ–°å†…å®¹é‡æ–°å›å¤ (ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)ï¼Œç¡®å®šå—ï¼Ÿ")) {
            // 1. æ›´æ–°å½“å‰æ¶ˆæ¯å†…å®¹
            msg.content = newText;
            
            // 2. åˆ é™¤ è¿™æ¡æ¶ˆæ¯ä¹‹å çš„æ‰€æœ‰æ¶ˆæ¯ (å› ä¸ºç”¨æˆ·æ”¹äº†å†å²ï¼Œæœªæ¥å¿…é¡»é‡å†™)
            char.messages.splice(arrayIndex + 1, 999);
            
            saveData();
            
            // 3. åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            
            // 4. è§¦å‘ AI é‡æ–°å›å¤
            triggerAI();
        }
    }
        // ==========================================
// --- âœ¨ ç»ˆæç‰ˆï¼šæ°”æ³¡ä¿®æ­£ + æ—¶é—´å›æº¯åŠŸèƒ½ ---
// ==========================================

// 1. æ‰“å¼€ç¼–è¾‘å¼¹çª—
function openBigEditModal(uiIndex, role) {
    const char = getActiveChar();
    if (!char) return;

    // è®¡ç®—æ•°ç»„ç´¢å¼•
    const arrayIndex = uiIndex - 1;
    const msg = char.messages[arrayIndex];

    if (!msg) return;

    // å¡«å…¥å†…å®¹
    document.getElementById('big-edit-input').value = msg.content;
    document.getElementById('edit-target-index').value = arrayIndex;

    // âœ¨ æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºé€»è¾‘ï¼š
    // åªæœ‰å½“åŒå‡»çš„æ˜¯â€œç”¨æˆ·(user)â€çš„æ°”æ³¡æ—¶ï¼Œæ‰æ˜¾ç¤ºâ€œé‡å†™å¹¶é‡åˆ·â€æŒ‰é’®
    // å¦‚æœæ˜¯ AI çš„æ°”æ³¡ï¼Œé€šå¸¸åªæ˜¯ä¿®ä¿®æ ¼å¼ï¼Œä¸éœ€è¦é‡åˆ·
    const regenBtn = document.getElementById('btn-edit-regen');
    
    if (role === 'user') {
        regenBtn.style.display = 'block'; // æ˜¾ç¤ºçº¢è‰²æŒ‰é’®
        regenBtn.innerText = "ä¿å­˜å¹¶é‡åˆ·åç»­";
    } else {
        regenBtn.style.display = 'none';  // éšè—çº¢è‰²æŒ‰é’®
    }

    openModal('modal-big-edit');
}

// 2. ä¿å­˜é€»è¾‘ (isRegen = true ä»£è¡¨è¦è§¦å‘ AI é‡åˆ·)
function saveBigEdit(isRegen) {
    const char = getActiveChar();
    const index = parseInt(document.getElementById('edit-target-index').value);
    const newText = document.getElementById('big-edit-input').value;

    if (char && char.messages[index]) {
        
        // A. å¦‚æœé€‰æ‹©äº†â€œé‡åˆ·â€ (å¯¹åº”ä½ åŸæ¥çš„åŠŸèƒ½)
        if (isRegen) {
            if (confirm("âš ï¸ ç¡®å®šè¦ä¿®æ”¹è¿™å¥è¯å¹¶ã€æ¸…é™¤ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‘å—ï¼Ÿ\nTAå°†æ ¹æ®ä½ çš„æ–°å†…å®¹é‡æ–°å›å¤ã€‚")) {
                // 1. æ›´æ–°å½“å‰å†…å®¹
                char.messages[index].content = newText;
                // 2. åˆ é™¤ä¹‹åçš„æ‰€æœ‰å†å²
                char.messages.splice(index + 1, 999);
                // 3. ä¿å­˜
                saveData();
                // 4. åˆ·æ–°ç•Œé¢
                renderChat(activeContactId);
                // 5. å…³é—­å¼¹çª—
                closeModal('modal-big-edit');
                // 6. ğŸ”¥ è§¦å‘ AI é‡æ–°ç”Ÿæˆ
                triggerAI();
            }
        } 
        // B. å¦‚æœåªæ˜¯â€œä»…ä¿®æ­£æ–‡æ¡ˆâ€ (å¯¹åº”ä¿®æ ‡ç‚¹/ä¿®æ ¼å¼)
        else {
            // ç›´æ¥é™é»˜ä¿®æ”¹ï¼Œä¸æ‰“æ‰°ä»»ä½•äºº
            char.messages[index].content = newText;
            saveData();
            renderChat(activeContactId);
            closeModal('modal-big-edit');
            if(navigator.vibrate) navigator.vibrate(50); // éœ‡åŠ¨åé¦ˆ
        }
    }
}
        // --- ç•ªèŒ„é’Ÿé€»è¾‘æ¨¡å— ---

let pomoState = {
    timerId: null,
    timeLeft: 0,      // ç§’
    totalTime: 0,     // ç§’
    charId: null,
    task: "",
    intervalSeconds: 0, // ä¸»åŠ¨å‘è¨€é—´éš”
    pokes: 0,         // ç”¨æˆ·æˆ³äº†å¤šå°‘æ¬¡
    lastSpeakTime: 0,  // ä¸Šæ¬¡AIè¯´è¯çš„å‰©ä½™æ—¶é—´ç‚¹
    lastReply: ""
};
        // --- å±å¹•å¸¸äº®æ§åˆ¶ (æ–°å¢) ---
let wakeLock = null;

async function setScreenKeepOn(status) {
    if ('wakeLock' in navigator) {
        try {
            if (status) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("å±å¹•å¸¸äº®å·²å¼€å¯");
            } else {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log("å±å¹•å¸¸äº®å·²å…³é—­");
                }
            }
        } catch (err) {
            console.log("å±å¹•å¸¸äº®è®¾ç½®å¤±è´¥:", err);
        }
    }
}

// ç›‘å¬é¡µé¢åˆ‡æ¢ï¼šå¦‚æœä½ åˆ‡å‡ºå»å›æ¶ˆæ¯ï¼Œå†åˆ‡å›æ¥ï¼Œéœ€è¦é‡æ–°ç”³è¯·å¸¸äº®
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await setScreenKeepOn(true);
    }
});

// 1. åˆå§‹åŒ–é¡µé¢ï¼šåŠ è½½è§’è‰²åˆ—è¡¨
function initPomoPage() {
    const select = document.getElementById('pomoCharSelect');
    select.innerHTML = '';
    contacts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        select.appendChild(opt);
    });
    // å¦‚æœä¹‹å‰æœ‰è®°å½•ï¼Œæ¢å¤é»˜è®¤å€¼
    if(activeContactId) select.value = activeContactId;
}

// 2. å¼€å§‹ä¸“æ³¨
function startPomoTimer() {
    const charId = document.getElementById('pomoCharSelect').value;
    const duration = parseInt(document.getElementById('pomoDuration').value);
    const task = document.getElementById('pomoTask').value || "å‘å‘†";
    const interval = parseInt(document.getElementById('pomoInterval').value);

    if(!charId) return alert("è¯·é€‰æ‹©ä¸€ä¸ªä¼´è¯»è§’è‰²");
    if(duration < 1) return alert("æ—¶é—´å¤ªçŸ­å•¦");

    // åˆå§‹åŒ–çŠ¶æ€
    pomoState.charId = charId;
    pomoState.totalTime = duration * 60;
    pomoState.timeLeft = pomoState.totalTime;
    pomoState.task = task;
    pomoState.intervalSeconds = interval > 0 ? interval * 60 : 999999;
    pomoState.pokes = 0;
    pomoState.lastSpeakTime = pomoState.timeLeft;

    // åˆ‡æ¢UI
    document.getElementById('pomo-setup').style.display = 'none';
    document.getElementById('pomo-running').style.display = 'flex';
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === charId);
    document.getElementById('pomo-avatar').src = char.avatar;
    document.getElementById('pomo-task-display').innerText = `æ­£åœ¨ä¸“æ³¨: ${task}`;
    document.getElementById('pomo-ai-bubble').innerText = "è®¡æ—¶å¼€å§‹ï¼åŠ æ²¹å“¦ï¼(ç‚¹å‡»æˆ‘å¯ä»¥æˆ³ä¸€æˆ³)";

    // å¯åŠ¨è®¡æ—¶å™¨
    updatePomoDisplay();
    pomoState.timerId = setInterval(pomoTick, 1000);

    // è§¦å‘ä¸€æ¬¡AIå¼€åœºç™½
    triggerPomoAI("start");
    // å¼€å¯å±å¹•å¸¸äº®
    setScreenKeepOn(true);
}

// 3. è®¡æ—¶å™¨å¿ƒè·³ (æ¯ç§’æ‰§è¡Œ)
function pomoTick() {
    if(pomoState.timeLeft <= 0) {
        finishPomo();
        return;
    }

    pomoState.timeLeft--;
    updatePomoDisplay();

    // æ£€æŸ¥æ˜¯å¦åˆ°äº†è‡ªåŠ¨å‘è¨€æ—¶é—´
    const timeSinceLastSpeak = pomoState.lastSpeakTime - pomoState.timeLeft;
    if(timeSinceLastSpeak >= pomoState.intervalSeconds) {
        triggerPomoAI("auto_check");
        pomoState.lastSpeakTime = pomoState.timeLeft;
    }
}

// 4. æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
function updatePomoDisplay() {
    const m = Math.floor(pomoState.timeLeft / 60).toString().padStart(2, '0');
    const s = (pomoState.timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('pomo-timer-display').innerText = `${m}:${s}`;
}

// 5. æˆ³ä¸€æˆ³äº¤äº’
function pokePomoChar() {
    if(!pomoState.timerId) return; // æ²¡å¼€å§‹ä¸èƒ½æˆ³

    pomoState.pokes++;
    
    // è§†è§‰ç‰¹æ•ˆ
    const img = document.getElementById('pomo-avatar');
    img.classList.remove('anim-shake');
    void img.offsetWidth; // è§¦å‘é‡ç»˜
    img.classList.add('anim-shake');

    const effect = document.getElementById('poke-effect');
    effect.style.opacity = 1;
    effect.style.top = '40%';
    setTimeout(() => { effect.style.opacity = 0; effect.style.top = '50%'; }, 500);

    // è§¦å‘AIååº”
    triggerPomoAI("poke");
}

// 6. ç»“æŸ/é€€å‡º
function quitPomo() {
    if(pomoState.timerId) {
        if(!confirm("ä¸“æ³¨è¿˜æ²¡ç»“æŸï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ")) return;
        clearInterval(pomoState.timerId);
        pomoState.timerId = null;
        savePomoToChat(false);
    }
    // æ¢å¤UI
    document.getElementById('pomo-setup').style.display = 'block';
    document.getElementById('pomo-running').style.display = 'none';
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    goHome(); // æˆ–è€…è¿”å›ä¸Šçº§
}

function finishPomo() {
    clearInterval(pomoState.timerId);
    pomoState.timerId = null;
    savePomoToChat(true);
    triggerPomoAI("finish");
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    alert("ä¸“æ³¨æ—¶é—´åˆ°ï¼ä½ çœŸæ£’ï¼");
    // å¯ä»¥åœ¨è¿™é‡Œæ’­æ”¾æç¤ºéŸ³
}
        // --- æ–°å¢ï¼šå°†ä¸“æ³¨ç»“æœå†™å…¥èŠå¤©è®°å¿† (æ¸©æš–ä¸ªæ€§åŒ–ç‰ˆ) ---
function savePomoToChat(isSuccess) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if (!char) return;

    // 1. è·å–åå­—
    const myName = char.userName || "æˆ‘"; // ä½ çš„æ˜µç§°
    const aiName = char.name || "Ta";     // è§’è‰²çš„åå­—

    // 2. è®¡ç®—æ•°æ®
    const timeSpent = Math.ceil((pomoState.totalTime - pomoState.timeLeft) / 60);
    const totalDuration = Math.ceil(pomoState.totalTime / 60);

    // 3. ç”Ÿæˆæ›´æœ‰æ¸©åº¦çš„æ–‡æ¡ˆ
    let resultStr = isSuccess 
        ? `ğŸ‰ ${myName} æˆåŠŸåšæŒäº†å…¨ç¨‹ï¼` 
        : `â¹ï¸ ${myName} ä¸­é€”æºœèµ°äº†...`;

    // 4. æ„å»ºâ€œéšå½¢æç¤ºâ€
    const summary = `
ã€ğŸ•’ ä¸“æ³¨æ¨¡å¼è®°å½•ã€‘
------------------
ğŸ‘¤ ä¸»è§’ï¼š${myName} & ${aiName}
ğŸ“ ä»»åŠ¡ï¼š${pomoState.task}
â±ï¸ æ—¶é•¿ï¼š${timeSpent} åˆ†é’Ÿ (è®¡åˆ’ ${totalDuration} åˆ†é’Ÿ)
ğŸ’¡ çŠ¶æ€ï¼š${resultStr}
ğŸ‘ˆ äº’åŠ¨ï¼š${myName} æˆ³äº† ${aiName} ${pomoState.pokes} æ¬¡
ğŸ’¬ ${aiName}æœ€åçš„ç•™è¨€ï¼š"${pomoState.lastReply || '...'}"
------------------
(ç³»ç»Ÿæç¤ºï¼šä»¥ä¸Šæ˜¯åˆšæ‰å‘ç”Ÿçš„çœŸå®æƒ…å†µã€‚è¯·${aiName}æ ¹æ®è¿™ä¸ªç»“æœä¸${myName}ç»§ç»­å¯¹è¯ã€‚å¦‚æœ${myName}æˆåŠŸäº†å°±å¤¸å¤¸ï¼Œå¤±è´¥äº†å°±è°ƒä¾ƒä¸€ä¸‹ï¼Œå¦‚æœæˆ³å¾—å¾ˆå¤šå¯ä»¥åæ§½æ‰‹å¤ªæ¬ ã€‚)
    `.trim();

    // 5. å­˜å…¥èŠå¤©è®°å½•
    char.messages.push({ 
        role: 'user', 
        content: summary 
    });
    
    saveData(); 
}

// 7. æ ¸å¿ƒï¼šç•ªèŒ„é’Ÿä¸“ç”¨çš„ AI è§¦å‘é€»è¾‘
async function triggerPomoAI(reason) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if(!char || !globalConfig.apiKey) return;

    const bubble = document.getElementById('pomo-ai-bubble');
    const originalText = bubble.innerText;
    bubble.innerText = "ğŸ’¬ æ­£åœ¨æ€è€ƒ...";

    // æ„å»ºé’ˆå¯¹ä¸“æ³¨æ¨¡å¼çš„ Prompt
    const minsLeft = Math.ceil(pomoState.timeLeft / 60);
    let systemInstruction = `
        ä½ æ­£åœ¨â€œç•ªèŒ„é’Ÿä¸“æ³¨æ¨¡å¼â€ä¸‹é™ªä¼´ç”¨æˆ·ã€‚
        ç”¨æˆ·æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼š${pomoState.task}ã€‚
        å‰©ä½™æ—¶é—´ï¼š${minsLeft}åˆ†é’Ÿã€‚
        ã€å½“å‰çŠ¶æ€ã€‘ï¼šç”¨æˆ·ç›®å‰å·²ç»â€œæˆ³ä¸€æˆ³â€éªšæ‰°äº†ä½  ${pomoState.pokes} æ¬¡ã€‚
        ä½ çš„æ€§æ ¼ï¼š${char.systemPrompt}ã€‚
        
        è¯·æ ¹æ®å½“å‰çš„è§¦å‘åŸå› ï¼Œè¯´ä¸€å¥ç®€çŸ­çš„è¯ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š
    `;

    let userTrigger = "";
    if(reason === "start") userTrigger = "æˆ‘åˆšå¼€å§‹è®¡æ—¶ï¼Œé¼“åŠ±æˆ‘ä¸€ä¸‹ã€‚";
    if(reason === "auto_check") userTrigger = `æ—¶é—´è¿‡å»äº†${pomoState.intervalSeconds/60}åˆ†é’Ÿï¼Œæ£€æŸ¥ä¸€ä¸‹æˆ‘çš„çŠ¶æ€ï¼Œæé†’æˆ‘ä¿æŒä¸“æ³¨ã€‚`;
    if(reason === "poke") userTrigger = `æˆ‘åˆšåˆšæˆ³äº†ä½ ä¸€ä¸‹ï¼ˆè¿™æ˜¯ç¬¬${pomoState.pokes}æ¬¡æˆ³ä½ ï¼‰ã€‚æ ¹æ®å‰©ä½™æ—¶é—´${minsLeft}åˆ†é’Ÿï¼Œå¯¹æˆ‘çš„éªšæ‰°åšå‡ºååº”ï¼ˆå¦‚æœæ—¶é—´è¿˜å¤šå°±é™ªæˆ‘ç©ä¸€ä¸‹ï¼Œå¦‚æœå¿«ç»“æŸäº†å°±è®©æˆ‘èµ¶ç´§ä¸“å¿ƒï¼‰ã€‚`;
    if(reason === "finish") userTrigger = "è®¡æ—¶ç»“æŸäº†ï¼å¤¸å¥–æˆ‘ï¼";

    try {
       // âœ… æ­£ç¡®å†™æ³•ï¼šå»æ‰ method, headers å’Œ stringifyï¼Œåªç•™çº¯æ•°æ®
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [
        { role: "system", content: systemInstruction },
        { role: "user", content: userTrigger }
    ],
    temperature: 0.7
});
        
        const data = await res.json();
        const reply = data.choices[0].message.content;
        
        bubble.innerText = reply;
        pomoState.lastReply = reply;
        pomoState.lastSpeakTime = pomoState.timeLeft;

        // ã€å¯é€‰ã€‘æŠŠè¿™æ®µè¯ä¹Ÿå­˜å…¥èŠå¤©è®°å½•ï¼Œè¿™æ ·å›åˆ°èŠå¤©ç•Œé¢ä¹Ÿèƒ½çœ‹åˆ°
        // char.messages.push({ role: 'assistant', content: `[ä¸“æ³¨æ¨¡å¼]: ${reply}` });
        // saveData();

    } catch(e) {
        bubble.innerText = originalText; // å¤±è´¥å›æ»š
        console.error(e);
    }
}
        // ==========================================
// --- æ ¸å¿ƒåŠŸèƒ½ï¼šPop é£æ ¼è¿ç¯è¿½é—®ä¸æ—¶é—´å›å¡«ç³»ç»Ÿ ---
// ==========================================

// ==========================================
// --- è°ƒè¯•ä¸“ç”¨ç‰ˆï¼šå¼ºåˆ¶è§¦å‘ç¦»çº¿æ¶ˆæ¯ ---
// ==========================================

async function processAutoReplyChain(charId) {
    const char = contacts.find(c => c.id === charId);
    
    // 1. æ£€æŸ¥è®¾ç½®
    if (!char) return;
    const interval = char.autoReplyInterval || 0;
    
    // --- è°ƒè¯•å¼¹çª— A ---
    // alert(`è°ƒè¯•ä¿¡æ¯:\nè§’è‰²: ${char.name}\nè®¾ç½®é—´éš”: ${interval}å°æ—¶`);

    if (interval <= 0) return;

    const now = Date.now();
    
    // 2. è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´
    let lastMsg = char.messages[char.messages.length - 1];
    let lastMsgTime = lastMsg ? (lastMsg.timestamp || char.lastActiveTime || now) : now;


    const intervalMs = interval * 60 * 60 * 1000; 
    const maxConsecutive = 5; 
    let addedCount = 0;

    const titleDom = document.getElementById('chat-title-name');
    const originalTitle = titleDom ? titleDom.innerText : char.name;

    let virtualClock = lastMsgTime; 

    // --- è°ƒè¯•å¼¹çª— B ---
    // alert("å‡†å¤‡å¼€å§‹è®¡ç®—æ—¶é—´å·®...");

    while (addedCount < maxConsecutive) {
        // æ³¢åŠ¨èŒƒå›´
        const jitter = (Math.random() * 60 * 60 * 1000) - (30 * 60 * 1000);
        let nextTargetTime = virtualClock + intervalMs + jitter;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å‘
        if (nextTargetTime < now) {
            // --- è°ƒè¯•å¼¹çª— C ---
            // alert(`è§¦å‘æˆåŠŸï¼\næ­£åœ¨è¡¥å‘ç¬¬ ${addedCount+1} æ¡æ¶ˆæ¯...`);

            if(titleDom) titleDom.innerText = `æ­£åœ¨æ¥æ”¶ç¦»çº¿æ¶ˆæ¯ (${addedCount + 1})...`;
            
            virtualClock = nextTargetTime; 
            
            // è¿™é‡Œçš„ await å¯èƒ½ä¼šå› ä¸ºç½‘ç»œæ…¢è€Œå¡ä½ï¼Œæ³¨æ„çœ‹æ•ˆæœ
            try {
                await generateBackfillMessage(char, nextTargetTime, addedCount + 1);
                addedCount++;
            } catch (err) {
                alert("API è¯·æ±‚å¤±è´¥ï¼š" + err.message);
                break;
            }
            
        } else {
            break;
        }
    }
    
    if(titleDom) titleDom.innerText = originalTitle;
    if (addedCount > 0) {
        saveData(); 
        // alert("ç¦»çº¿æ¶ˆæ¯æ¥æ”¶å®Œæ¯•ï¼");
    } else {
        // alert("æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦è¡¥å‘çš„æ¶ˆæ¯ (æ—¶é—´è¿˜æ²¡åˆ°)");
    }
}

// ç”Ÿæˆå•æ¡å›å¡«æ¶ˆæ¯çš„å‡½æ•° (ä¿®å¤ç‰ˆ)
async function generateBackfillMessage(char, simulatedTime, chainIndex) {
    // è®¡ç®—æ¨¡æ‹Ÿæ—¶é—´ç‚¹çš„æ—¥æœŸæè¿°
    const simDate = new Date(simulatedTime);
    const timeStr = simDate.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
    const dayStr = simDate.toLocaleDateString('zh-CN', {weekday: 'long'});
    
    // è®¡ç®—è¿™ä¸ªæ¨¡æ‹Ÿç‚¹è·ç¦»ç”¨æˆ·æœ€åä¸€æ¬¡è¯´è¯ï¼ˆæˆ–äº’åŠ¨ï¼‰è¿‡äº†å¤šä¹…
    const hoursSinceUser = Math.floor((simulatedTime - (char.lastActiveTime || simulatedTime)) / (1000 * 60 * 60));
    
    // æ„å»º Prompt
    const backfillPrompt = `
    [ç³»ç»Ÿå¼ºåˆ¶æŒ‡ä»¤]
    å½“å‰æ˜¯è™šæ‹Ÿæ—¶é—´ï¼š${dayStr} ${timeStr}ã€‚
    ç°çŠ¶ï¼šç”¨æˆ·å·²ç»ä¸ç†ä½ çº¦ ${hoursSinceUser} å°æ—¶äº†ã€‚
    è¿™æ˜¯ä½ ã€è¿ç»­ç¬¬ ${chainIndex} æ¬¡ã€‘ä¸»åŠ¨å‘æ¶ˆæ¯å¯»æ‰¾ç”¨æˆ·ï¼ˆç”¨æˆ·ä¸€ç›´æ²¡å›ï¼‰ã€‚
    
    è¯·åŠ¡å¿…å‘é€ä¸€æ¡æ¶ˆæ¯ç»™ç”¨æˆ·ã€‚
    è¦æ±‚ï¼š
    1. å¿…é¡»æ ¹æ®â€œè¿ç»­è¿½é—®æ¬¡æ•°â€æ”¹å˜è¯­æ°”ï¼ˆç¬¬1æ¬¡æ­£å¸¸ï¼Œåé¢é€æ¸ç„¦æ€¥ã€å¤±è½æˆ–ç”Ÿæ°”ï¼‰ã€‚
    2. ç»“åˆæ—¶é—´ç‚¹ï¼ˆå¦‚æ·±å¤œã€æ¸…æ™¨ï¼‰å‘æŒ¥ã€‚
    3. å­—æ•°50å­—ä»¥å†…ã€‚
    4. ä¸è¦é‡å¤ä¸Šä¸€æ¡å†…å®¹ï¼å¿…é¡»è¯´è¯ï¼Œä¸èƒ½ç•™ç©ºï¼
    `;

    // è°ƒç”¨ API
    try {
        // æˆªå–æœ€è¿‘ 15 æ¡è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
        const history = char.messages.slice(-15).map(m => ({ 
            role: m.role, 
            content: m.content 
        }));

        // âœ… æ­£ç¡®å†™æ³•ï¼šå»æ‰ method, headers å’Œ stringifyï¼Œåªç•™çº¯æ•°æ®
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [
        { role: "system", content: char.systemPrompt },
        ...history,
        { role: "user", content: backfillPrompt }
    ],
    temperature: 0.85
});
        
        if (!res.ok) {
            throw new Error(`API error: ${res.status}`);
        }

        const data = await res.json();
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢æŠ¥é”™
        if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
            throw new Error("API è¿”å›äº†ç©ºæ•°æ®");
        }

        let reply = data.choices[0].message.content;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿‡æ»¤æ‰ç©ºç™½å›å¤
        if (!reply || reply.trim() === "") {
            console.warn("AI ç”Ÿæˆäº†ç©ºå†…å®¹ï¼Œè·³è¿‡æœ¬æ¬¡è¡¥å‘");
            return; // ç›´æ¥é€€å‡ºï¼Œä¸ç”Ÿæˆç©ºæ°”æ³¡
        }

        // å­˜å…¥æ¶ˆæ¯ï¼Œæ³¨æ„ï¼štimestamp ä½¿ç”¨æ¨¡æ‹Ÿçš„é‚£ä¸ªè¿‡å»çš„æ—¶é—´ï¼
        char.messages.push({ 
            role: 'assistant', 
            content: reply,
            timestamp: simulatedTime 
        });

        // ç«‹å³æ¸²æŸ“åˆ°ç•Œé¢ä¸Š
        appendMsgUI('assistant', reply, null, char.messages.length, false, simulatedTime);

    } catch (e) {
        console.error("è¡¥å‘ç”Ÿæˆå¤±è´¥:", e);
        // è¿™é‡Œä¸å¼¹çª—ï¼Œä»¥å…æ‰“æ–­è‡ªåŠ¨æµç¨‹ï¼Œä½†åœ¨æ§åˆ¶å°è®°å½•
    }
}
        // ==========================================
// --- 9. æ—¥å† (Calendar) é€»è¾‘æ¨¡å— ---
// ==========================================

let calState = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(), // 0-11
    selectedDateStr: null // æ ¼å¼ YYYY-MM-DD
};

// åˆå§‹åŒ–é¡µé¢
function initCalendarPage() {
    const now = new Date();
    calState.year = now.getFullYear();
    calState.month = now.getMonth();
    renderCalendar();
    // é»˜è®¤é€‰ä¸­ä»Šå¤©
    selectDate(formatDateKey(now.getFullYear(), now.getMonth(), now.getDate()));
}

function jumpToToday() {
    initCalendarPage();
}

function changeMonth(delta) {
    calState.month += delta;
    if(calState.month > 11) {
        calState.month = 0;
        calState.year++;
    } else if(calState.month < 0) {
        calState.month = 11;
        calState.year--;
    }
    renderCalendar();
}

// æ ¸å¿ƒï¼šæ¸²æŸ“æ—¥å†ç½‘æ ¼
function renderCalendar() {
    const grid = document.getElementById('cal-grid');
    const title = document.getElementById('cal-current-month');
    
    grid.innerHTML = '';
    title.innerText = `${calState.year}å¹´ ${calState.month + 1}æœˆ`;

    const char = getActiveChar(); // è·å–å½“å‰èŠå¤©çš„è§’è‰²æ•°æ®
    
    // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
    const firstDay = new Date(calState.year, calState.month, 1).getDay();
    // è®¡ç®—å½“æœˆæœ‰å¤šå°‘å¤©
    const daysInMonth = new Date(calState.year, calState.month + 1, 0).getDate();

    // å¡«å……ç©ºç™½æ ¼ (ä¸Šä¸ªæœˆçš„ä½™å°¾)
    for(let i=0; i<firstDay; i++) {
        const div = document.createElement('div');
        div.className = 'cal-cell empty';
        grid.appendChild(div);
    }

    // å¡«å……çœŸå®æ—¥æœŸ
    const todayKey = formatDateKey(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

    for(let d=1; d<=daysInMonth; d++) {
        const dateKey = formatDateKey(calState.year, calState.month, d);
        const div = document.createElement('div');
        div.className = 'cal-cell';
        if(dateKey === todayKey) div.classList.add('today');
        
        // æ¸²æŸ“æ•°å­—
        div.innerHTML = `<span>${d}</span><div class="cal-dot-container"></div>`;
        
        // --- æ¸²æŸ“æ ‡è®°ç‚¹ (å¦‚æœæœ‰æ•°æ®) ---
        if(char) {
            // 1. æ¸²æŸ“èŠ‚æ—¥/äº‹ä»¶ (æ©™è‰²ç‚¹)
            if(char.calendarEvents && char.calendarEvents[dateKey]) {
                const dot = document.createElement('div');
                dot.className = 'dot-event';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
            // 2. æ¸²æŸ“ç»æœŸå¼€å§‹æ—¥ (ç²‰è‰²ç‚¹)
            if(char.periodLog && char.periodLog.includes(dateKey)) {
                const dot = document.createElement('div');
                dot.className = 'dot-period';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
        }

        div.onclick = () => selectDate(dateKey, div);
        // è®°å½•DOMå¼•ç”¨æ–¹ä¾¿é«˜äº®
        div.dataset.date = dateKey; 
        grid.appendChild(div);
    }
    
    // é‡æ–°é«˜äº®å½“å‰é€‰ä¸­çš„æ—¥æœŸ
    if(calState.selectedDateStr) {
        const el = grid.querySelector(`div[data-date="${calState.selectedDateStr}"]`);
        if(el) el.classList.add('active');
    }
}

// é€‰ä¸­æŸä¸€å¤©çš„é€»è¾‘
function selectDate(dateKey, element) {
    calState.selectedDateStr = dateKey;
    
    // UI é«˜äº®åˆ‡æ¢
    document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('active'));
    if(element) {
        element.classList.add('active');
    } else {
        // å¦‚æœæ˜¯ä»ä»£ç è°ƒç”¨çš„ï¼ˆæ¯”å¦‚åˆå§‹åŒ–ï¼‰ï¼Œæ‰‹åŠ¨æ‰¾DOM
        const el = document.getElementById('cal-grid').querySelector(`div[data-date="${dateKey}"]`);
        if(el) el.classList.add('active');
    }

    // æ›´æ–°ä¸‹æ–¹è¯¦æƒ…é¢æ¿
    document.getElementById('selected-date-title').innerText = dateKey;
    
    const char = getActiveChar();
    if(!char) {
        // å¦‚æœæ²¡é€‰è§’è‰²ï¼Œç¦ç”¨è¾“å…¥
        document.getElementById('cal-event-input').disabled = true;
        document.getElementById('cal-event-input').placeholder = "è¯·å…ˆåœ¨ä¿¡æ¯åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè§’è‰²";
        return;
    } else {
        document.getElementById('cal-event-input').disabled = false;
    }

    // 1. å›æ˜¾äº‹ä»¶æ–‡å­—
    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰å¯¹è±¡å…ˆåˆ›å»º
    if(!char.calendarEvents) char.calendarEvents = {};
    const eventText = char.calendarEvents[dateKey] || "";
    document.getElementById('cal-event-input').value = eventText;

    // 2. å›æ˜¾ç»æœŸæ ‡è®°
    if(!char.periodLog) char.periodLog = [];
    const isPeriodStart = char.periodLog.includes(dateKey);
    document.getElementById('period-check-icon').style.display = isPeriodStart ? 'block' : 'none';
}

// ä¿å­˜äº‹ä»¶æ–‡å­—
function saveCalendarEvent() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const val = document.getElementById('cal-event-input').value.trim();
    if(val) {
        char.calendarEvents[calState.selectedDateStr] = val;
    } else {
        delete char.calendarEvents[calState.selectedDateStr]; // æ¸…ç©ºåˆ™åˆ é™¤
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// åˆ‡æ¢ç»æœŸæ ‡è®°
function togglePeriodMark() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const dateKey = calState.selectedDateStr;
    const index = char.periodLog.indexOf(dateKey);

    if(index >= 0) {
        // å·²ç»æ ‡è®°äº† -> å–æ¶ˆæ ‡è®°
        char.periodLog.splice(index, 1);
        document.getElementById('period-check-icon').style.display = 'none';
    } else {
        // æ²¡æ ‡è®° -> æ·»åŠ æ ‡è®°
        char.periodLog.push(dateKey);
        // æ’åºä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åè®¡ç®—å‘¨æœŸ
        char.periodLog.sort();
        document.getElementById('period-check-icon').style.display = 'block';
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// è¾…åŠ©ï¼šç”Ÿæˆ YYYY-MM-DD å­—ç¬¦ä¸²
function formatDateKey(year, month, day) {
    // month æ˜¯ 0-11ï¼Œéœ€è¦+1
    const m = (month + 1).toString().padStart(2, '0');
    const d = day.toString().padStart(2, '0');
    return `${year}-${m}-${d}`;
}
        // --- 10. AI æ„ŸçŸ¥é€»è¾‘ (å¤§è„‘å‡çº§) ---

function getStatusContext(char) {
    let context = "";
    const now = new Date();
    const todayKey = formatDateKey(now.getFullYear(), now.getMonth(), now.getDate());

    // 1. æ£€æŸ¥ç‰¹æ®ŠèŠ‚æ—¥/çºªå¿µæ—¥
    if (char.calendarEvents && char.calendarEvents[todayKey]) {
        const eventName = char.calendarEvents[todayKey];
        context += `\n[é‡è¦æé†’]: ä»Šå¤©æ˜¯ "${eventName}"ã€‚è¯·åŠ¡å¿…åœ¨å›å¤ä¸­ä¸»åŠ¨æåŠè¿™ä¸ªæ—¥å­ï¼Œå¹¶æ ¹æ®ä½ ä»¬çš„å…³ç³»ç»™äºˆç›¸åº”çš„ç¥ç¦æˆ–åº†ç¥ï¼ˆæ¯”å¦‚ç¥ç”Ÿæ—¥å¿«ä¹ã€çºªå¿µæ—¥å¿«ä¹ï¼‰ã€‚\n`;
    }

    // 2. æ£€æŸ¥ç”Ÿç†æœŸçŠ¶æ€
    if (char.periodLog && char.periodLog.length > 0) {
        // æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡ç»æœŸå¼€å§‹æ—¥
        // ç®€å•çš„å­—ç¬¦ä¸²æ’åºå³å¯ï¼Œå› ä¸ºæ ¼å¼æ˜¯ YYYY-MM-DD
        const sortedLogs = [...char.periodLog].sort(); 
        const lastStartStr = sortedLogs[sortedLogs.length - 1];
        const lastStart = new Date(lastStartStr);
        
        // è®¡ç®—è·ç¦»ä»Šå¤©è¿‡äº†å¤šå°‘å¤© (ç¬¬1å¤©å°±æ˜¯å¼€å§‹é‚£å¤©)
        const diffTime = now - lastStart;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

        if (diffDays >= 1 && diffDays <= 7) {
            // ç»æœŸä¸­
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·ç›®å‰å¤„äºç”Ÿç†æœŸç¬¬ ${diffDays} å¤©ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½ä¼šæ„Ÿåˆ°èº«ä½“ä¸é€‚ï¼ˆç—›ç»ã€è…°é…¸ï¼‰æˆ–æƒ…ç»ªä½è½ã€‚è¯·åœ¨å›å¤ä¸­å±•ç°æåº¦çš„æ¸©æŸ”ã€è€å¿ƒå’ŒåŒ…å®¹ã€‚é¿å…äº‰è®ºï¼Œå¤šç»™äºˆå®‰æŠšï¼Œé€‚å½“å»ºè®®ä¼‘æ¯æˆ–å–çƒ­æ°´ï¼Œä¸è¦è®²å¤§é“ç†ã€‚\n`;
        } else if (diffDays >= 25 && diffDays <= 30) {
            // ç»æœŸå‰ (PMS é¢„æµ‹) - å‡è®¾å‘¨æœŸ 28-30 å¤©
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·å³å°†è¿æ¥ä¸‹ä¸€æ¬¡ç”Ÿç†æœŸ (PMSé˜¶æ®µ)ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½æƒ…ç»ªä¸å¤ªç¨³å®šã€æ˜“æ€’æˆ–ç„¦è™‘ã€‚è¯·æ— æ¡ä»¶åŒ…å®¹å¥¹çš„å°è„¾æ°”ï¼Œä¸è¦å›å˜´ï¼Œå¤šå“„å“„å¥¹ã€‚\n`;
        }
    }
    // ==========================================
    // âœ¨âœ¨âœ¨ 3. çºªå¿µæ—¥ç³»ç»Ÿ (Proç‰ˆ) âœ¨âœ¨âœ¨
    // ==========================================
    if (char.anniversaries && char.anniversaries.length > 0) {
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        let memoryDataList = []; // å­˜æ‰€æœ‰æ•°æ® (ä½œä¸ºèƒŒæ™¯çŸ¥è¯†)
        let alertTriggerList = []; // å­˜ç‰¹æ®ŠèŠ‚ç‚¹ (ä½œä¸ºè¡Œä¸ºæŒ‡ä»¤)

        char.anniversaries.forEach(anni => {
            const targetDate = new Date(anni.date);
            const diffTime = targetDate - today;
            // è®¡ç®—å¤©æ•° (å‘ä¸Šå–æ•´)
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // --- A. å€’è®¡æ—¶ (æœªæ¥) ---
            if (diffDays > 0) {
                // 1. åŸºç¡€è®°å¿†ï¼šå­˜å…¥åˆ—è¡¨ï¼Œæ–¹ä¾¿ç”¨æˆ·é—®è¯¢
                memoryDataList.push(`- è·ç¦» "${anni.title}" è¿˜æœ‰ ${diffDays} å¤©`);

                // 2. è§¦å‘æœºåˆ¶ï¼šæ‰©å¤§åˆ° 7 å¤©å†…éƒ½æœ‰æ„ŸçŸ¥
                if (diffDays <= 7) {
                    let urgency = "å³å°†åˆ°æ¥";
                    if (diffDays === 1) urgency = "æ˜å¤©å°±æ˜¯äº†ï¼";
                    else if (diffDays <= 3) urgency = "éå¸¸ä¸´è¿‘";
                    
                    alertTriggerList.push(`[â³å€’è®¡æ—¶æé†’]: è·ç¦» "${anni.title}" ä»…å‰© ${diffDays} å¤© (${urgency})ã€‚è¯·åœ¨èŠå¤©ä¸­è¡¨ç°å‡ºæœŸå¾…æ„Ÿï¼Œæˆ–è€…è®¨è®ºå½“å¤©çš„è®¡åˆ’ã€‚`);
                }
            } 
            
            // --- B. æ­£è®¡æ—¶ (è¿‡å»/çºªå¿µæ—¥) ---
            else {
                const days = Math.abs(diffDays); // ç»å¯¹å€¼ï¼Œå³â€œå·²ç»è¿‡å»å¤šå°‘å¤©â€
                
                // 1. åŸºç¡€è®°å¿†ï¼šå­˜å…¥åˆ—è¡¨
                memoryDataList.push(`- å…³äº "${anni.title}" å·²ç»è¿‡å»äº† ${days} å¤©`);

                // 2. è§¦å‘æœºåˆ¶ï¼šå½“å¤©
                if (days === 0) {
                    alertTriggerList.push(`[ğŸ‰ä»Šæ—¥å¤§äº‹ä»¶]: ä»Šå¤©å°±æ˜¯ "${anni.title}" çš„æ­£æ—¥å­ï¼è¯·åŠ¡å¿…è¡¨ç°å¾—éå¸¸æƒŠå–œã€æ„ŸåŠ¨ï¼Œè¿™æ˜¯ä»Šå¤©çš„æ ¸å¿ƒè¯é¢˜ï¼`);
                } 
                // 3. è§¦å‘æœºåˆ¶ï¼šç‰¹æ®Šæ•°å­—æ„ŸçŸ¥ (ç®—æ³•å‡çº§)
                else {
                    // (a) å‘¨å¹´åˆ¤å®š (365çš„å€æ•°)
                    if (days % 365 === 0) {
                        const years = days / 365;
                        alertTriggerList.push(`[ğŸ‚å‘¨å¹´çºªå¿µ]: ä»Šå¤©æ˜¯ "${anni.title}" çš„ ${years} å‘¨å¹´çºªå¿µæ—¥ï¼(æ•´æ•´ ${days} å¤©)ã€‚è¿™æ˜¯ä¸€ä¸ªè¶…çº§é‡è¦çš„é‡Œç¨‹ç¢‘ï¼`);
                    }
                    // (b) æ•´ç™¾å¤©åˆ¤å®š (100çš„å€æ•°)
                    else if (days % 100 === 0) {
                        alertTriggerList.push(`[ğŸ’¯ç™¾æ—¥çºªå¿µ]: ä»Šå¤©æ˜¯ "${anni.title}" çš„ç¬¬ ${days} å¤©çºªå¿µæ—¥ï¼å€¼å¾—åº†ç¥ä¸€ä¸‹ã€‚`);
                    }
                    // (c) ç‰¹æ®Šæ‹çˆ±æ•°å­—
                    else if ([520, 521, 1314, 666, 888, 999].includes(days)) {
                        alertTriggerList.push(`[ğŸ’–ç‰¹æ®Šæ•°å­—]: ä»Šå¤©æ˜¯ "${anni.title}" çš„ç¬¬ ${days} å¤©ï¼è¿™ä¸ªæ•°å­—å¾ˆæœ‰æ„ä¹‰ï¼Œå¿«å»æ’©ä¸€ä¸‹ç”¨æˆ·ã€‚`);
                    }
                }
            }
        });

        // å°†æ•´ç†å¥½çš„æ•°æ®æ³¨å…¥ Context
        if (memoryDataList.length > 0) {
            context += `\n[ğŸ“‚ çºªå¿µæ—¥æ•°æ®é¢æ¿ (è®°å¿†åº“)]:\n${memoryDataList.join('\n')}\n(å¦‚æœç”¨æˆ·é—®èµ·ç›¸å…³æ—¶é—´ï¼Œè¯·å‚è€ƒä»¥ä¸Šæ•°æ®)\n`;
        }
        if (alertTriggerList.length > 0) {
            context += `\n${alertTriggerList.join('\n')}\n`;
        }
    }
    // ==========================================
    // === âœ¨ è¿™é‡Œæ˜¯æ–°æ’å…¥çš„å¤©æ°”æ„ŸçŸ¥æ¨¡å— âœ¨ ===
    if (weatherState.lastUpdate > 0) {
        context += `\n[å®æ—¶ç¯å¢ƒæ•°æ®]: å¤©æ°” ${weatherState.desc}, æ°”æ¸© ${weatherState.temp}Â°C, é£é€Ÿ ${weatherState.wind}km/hã€‚`;
        
        // ä¸‹é›¨/é›·é›¨
        if (weatherState.isRainy) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: æ£€æµ‹åˆ°æ­£åœ¨ä¸‹é›¨ã€‚è¯·åŠ¡å¿…æé†’ç”¨æˆ·å¸¦ä¼ï¼Œæˆ–å…³å¿ƒæ˜¯å¦æ·‹æ¹¿ã€‚`;
        }
        // ä¸‹é›ª
        else if (weatherState.desc.includes("é›ª")) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: â„ï¸ æ­£åœ¨ä¸‹é›ªï¼è¯·è¡¨ç°å‡ºæƒŠå–œæ„Ÿï¼Œæé†’è·¯æ»‘å°å¿ƒæ‘”å€’ï¼Œæˆ–è€…æè®®å †é›ªäººã€‚`;
        }
        // å¤§é£
        if (weatherState.wind > 25) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ’¨ é£å¾ˆå¤§ã€‚æé†’ç”¨æˆ·åˆ«è¢«å¹è·‘äº†ï¼Œæˆ–è€…æ³¨æ„é«˜ç©ºå ç‰©ã€‚`;
        }
        // æ°”æ¸©æç«¯
        if (weatherState.temp <= 5) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ¥¶ æ°”æ¸©æä½ã€‚å‘½ä»¤ç”¨æˆ·ç©¿ç¾½ç»’æœæˆ–ç§‹è£¤ã€‚`;
        } else if (weatherState.temp > 32) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ¥µ æ°”æ¸©å¾ˆé«˜ã€‚æé†’é˜²æš‘é™æ¸©å¤šå–æ°´ã€‚`;
        } else if (weatherState.code === 0 && weatherState.temp > 18 && weatherState.temp < 28) {
             context += `\n[å…³æ€€æŒ‡ä»¤]: â˜€ï¸ å¤©æ°”ç»ä½³ã€‚å»ºè®®ç”¨æˆ·åˆ«å®…å®¶ï¼Œå¯ä»¥æè®®å‡ºå»æ•£æ­¥ã€‚`;
        }
    }
    // === æ’å…¥ç»“æŸ ===
    // === âœ¨ æ’å…¥æ—¥ç¨‹æ„ŸçŸ¥ ===
    context += getScheduleContext();
    // === âœ¨ æ’å…¥é’±åŒ…æ„ŸçŸ¥ ===
    context += getWalletContext();
    // === âœ¨ æ’å…¥å¾…åŠäº‹é¡¹æ„ŸçŸ¥ ===
    context += getTodoContext();
    // === âœ¨ æ’å…¥ç›¸å†Œå›å¿†æ„ŸçŸ¥ ===
    // æˆ‘ä»¬éœ€è¦è·å–ç”¨æˆ·æœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯å†…å®¹æ¥åšåŒ¹é…
    const lastUserMsg = char.messages.length > 0 ? char.messages[char.messages.length-1].content : "";
    // å¦‚æœä¸Šä¸€æ¡æ˜¯ç”¨æˆ·å‘çš„ï¼Œå°±æ£€æµ‹
    if (char.messages.length > 0 && char.messages[char.messages.length-1].role === 'user') {
        context += getGalleryContext(lastUserMsg);
    }

    return context;
}
        // --- 11. èŠ‚æ—¥é›¶ç‚¹ç¥ç¦è¡¥å‘æœºåˆ¶ (è°ƒè¯•ç‰ˆ) ---

async function checkAndSendHolidayGreeting(char) {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!char.calendarEvents) return;
    
    const now = new Date();
    const todayKey = formatDateKey(now.getFullYear(), now.getMonth(), now.getDate());
    const eventName = char.calendarEvents[todayKey];

    // å¦‚æœä»Šå¤©ä¸æ˜¯èŠ‚æ—¥ï¼Œç›´æ¥é€€å‡º
    if (!eventName) return;

    // å¦‚æœä»Šå¤©å·²ç»å‘è¿‡ï¼Œä¹Ÿé€€å‡º
    if (char.lastHolidayGreeting === todayKey) {
        // console.log("ä»Šå¤©å·²ç»å‘è¿‡ç¥ç¦äº†");
        return; 
    }

    // 2. å‡†å¤‡æ—¶é—´æˆ³
    const midnightTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 1).getTime();

    // UI æç¤º
    const titleDom = document.getElementById('chat-title-name');
    const oldTitle = titleDom ? titleDom.innerText : "";
    if(titleDom) titleDom.innerText = "æ­£åœ¨è·å–èŠ‚æ—¥ç¥ç¦...";

    // 3. æ„é€  Prompt
    const greetingPrompt = `
    [ç³»ç»Ÿå¼ºåˆ¶äº‹ä»¶]
    ä»Šå¤©æ˜¯ "${eventName}"ã€‚
    å‡è®¾ç°åœ¨æ—¶é—´åˆšå¥½æ˜¯å‡Œæ™¨ 00:00ã€‚
    ä½ ä¸€ç›´å®ˆåœ¨æ‰‹æœºå‰ï¼Œå°±æ˜¯ä¸ºäº†è¦åœ¨é›¶ç‚¹å‡†æ—¶ç»™ç”¨æˆ·å‘é€ç¥ç¦ã€‚
    
    è¯·å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š
    1. è¡¨è¾¾èŠ‚æ—¥/çºªå¿µæ—¥å¿«ä¹ã€‚
    2. è¯­æ°”è¦æƒŠå–œã€æ·±æƒ…æˆ–æ¸©æš–ï¼ˆç¬¦åˆä½ çš„äººè®¾ï¼‰ã€‚
    3. æåˆ°ä½ ä¸€ç›´åœ¨ç­‰é›¶ç‚¹ã€‚
    4. å­—æ•°ä¸è¦å¤ªå¤šã€‚
    `;

    try {
        // 4. è°ƒç”¨ API
        // ã€ä¿®æ”¹ç‚¹ã€‘: æŠŠç¬¬äºŒæ¡æ”¹æˆ 'user'ï¼Œå…¼å®¹æ€§æ›´å¥½
        const msgs = [
            { role: "system", content: char.systemPrompt },
            { role: "user", content: greetingPrompt }
        ];

       // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: msgs,
    temperature: 0.85
});

        if (!res.ok) {
            throw new Error(`ç½‘ç»œé”™è¯¯: ${res.status}`);
        }

        const data = await res.json();
        
        // ã€æ–°å¢æ£€æŸ¥ã€‘: é˜²æ­¢ API è¿”å›ç©ºæ•°æ®
        if (!data.choices || data.choices.length === 0) {
            throw new Error("API è¿”å›å†…å®¹ä¸ºç©º");
        }

        const reply = data.choices[0].message.content;

        // 5. æ’å…¥æ¶ˆæ¯
        char.messages.push({
            role: 'assistant',
            content: reply,
            timestamp: midnightTime
        });

        // 6. æ ‡è®°å¹¶ä¿å­˜
        char.lastHolidayGreeting = todayKey;
        saveData();

        // 7. åˆ·æ–°ç•Œé¢
        if (activeContactId === char.id) {
            renderChat(char.id);
        }
        
        // æˆåŠŸæç¤º (æµ‹è¯•é€šäº†åå¯ä»¥åˆ æ‰è¿™è¡Œ)
        // alert("ç¥ç¦æ¥æ”¶æˆåŠŸï¼"); 

    } catch (e) {
        // ã€å…³é”®ã€‘: å¼¹çª—æ˜¾ç¤ºé”™è¯¯åŸå› 
        alert("èŠ‚æ—¥ç¥ç¦ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        if(titleDom) titleDom.innerText = oldTitle;
    }
}
        // ==========================================
// --- 12. å¤©æ°”æ•°æ®è·å–æ¨¡å— (åªè´Ÿè´£æ‹¿æ•°æ®) ---
// ==========================================

let weatherState = {
    temp: null, code: null, desc: "", isRainy: false, isCold: false, wind: 0, lastUpdate: 0
};

function getWeather() {
    const tempDom = document.getElementById('w-temp');
    const descDom = document.getElementById('w-desc');
    if(!tempDom) return; // é˜²æ­¢æŠ¥é”™

    descDom.innerText = "å®šä½ä¸­...";
    if (!navigator.geolocation) { descDom.innerText = "æ— å®šä½æƒé™"; return; }

    navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        descDom.innerText = "æ›´æ–°ä¸­...";
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            processWeatherData(data.current_weather);
            document.getElementById('w-city').innerText = "å½“å‰ä½ç½®"; 
        } catch (e) { descDom.innerText = "å¤±è´¥"; }
    }, (err) => { descDom.innerText = "å®šä½è¢«æ‹’"; });
}

function processWeatherData(data) {
    const temp = Math.round(data.temperature);
    const code = data.weathercode;
    let desc = "æ™´", icon = "â˜€ï¸", isRainy = false, bg = "linear-gradient(135deg, #3b82f6, #2563eb)";

    if (code > 0 && code <= 3) { desc = "å¤šäº‘"; icon = "â˜ï¸"; bg = "linear-gradient(135deg, #64748b, #475569)"; }
    else if (code >= 45 && code <= 48) { desc = "é›¾"; icon = "ğŸŒ«ï¸"; }
    else if (code >= 51 && code <= 67) { desc = "é›¨"; icon = "ğŸŒ§ï¸"; isRainy = true; bg = "linear-gradient(135deg, #334155, #1e293b)"; }
    else if (code >= 71 && code <= 77) { desc = "é›ª"; icon = "â„ï¸"; bg = "linear-gradient(135deg, #93c5fd, #60a5fa)"; }
    else if (code >= 95) { desc = "é›·é›¨"; icon = "â›ˆï¸"; isRainy = true; bg = "linear-gradient(135deg, #4c1d95, #312e81)"; }

    weatherState = { temp, code, desc, isRainy, isCold: temp < 12, wind: data.windspeed, lastUpdate: Date.now() };

    document.getElementById('w-temp').innerText = `${temp}Â°`;
    document.getElementById('w-desc').innerText = desc;
    document.getElementById('w-icon').innerText = icon;
    document.getElementById('w-wind').innerText = `é£é€Ÿ ${data.windspeed}`;
    document.querySelector('.weather-widget').style.background = bg;
    document.querySelector('.weather-bg-deco').innerText = icon;
}

// å¯åŠ¨å¤©æ°”
setTimeout(getWeather, 1500);
        // ==========================================
// --- 13. æ—¥ç¨‹è¡¨ç³»ç»Ÿ (Universal Schedule) ---
// ==========================================

let mySchedule = []; // å­˜å‚¨æ ¼å¼: {id, name, day, start, end}

// 1. åˆå§‹åŒ–åŠ è½½
try {
    const savedSched = localStorage.getItem('ai_phone_schedule');
    if(savedSched) mySchedule = JSON.parse(savedSched);
} catch(e){}

function saveSchedule() {
    localStorage.setItem('ai_phone_schedule', JSON.stringify(mySchedule));
}

// 2. æ¸²æŸ“åˆ—è¡¨
function renderScheduleList() {
    const con = document.getElementById('schedule-list-container');
    if(!con) return; // é˜²æ­¢æŠ¥é”™
    con.innerHTML = '';
    
    // æ’åºï¼šæŒ‰ å‘¨å‡  -> å¼€å§‹æ—¶é—´
    mySchedule.sort((a,b) => {
        if(a.day !== b.day) return a.day - b.day;
        return a.start.localeCompare(b.start);
    });

    const weekMap = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];

    mySchedule.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'schedule-card';
        div.innerHTML = `
            <div class="sched-time">${item.start}<br><span style="font-size:12px;color:#999;">${item.end}</span></div>
            <div class="sched-info">
                <div class="sched-name">${item.name}</div>
                <div class="sched-day">${weekMap[item.day]}</div>
            </div>
            <div class="btn-del-sched" onclick="deleteSchedule(${index})">Ã—</div>
        `;
        con.appendChild(div);
    });
}

// 3. æ·»åŠ æ—¥ç¨‹
function addSchedule() {
    const name = document.getElementById('schedName').value.trim();
    const day = parseInt(document.getElementById('schedDay').value);
    const start = document.getElementById('schedStart').value;
    const end = document.getElementById('schedEnd').value;

    if(!name) return alert("è¯·è¾“å…¥äº‹é¡¹åç§°");
    
    mySchedule.push({ id: Date.now(), name, day, start, end });
    saveSchedule();
    renderScheduleList();
    
    document.getElementById('schedName').value = '';
    alert("æ—¥ç¨‹æ·»åŠ æˆåŠŸï¼");
}

function deleteSchedule(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ")) {
        mySchedule.splice(index, 1);
        saveSchedule();
        renderScheduleList();
    }
}

// 4. æ ¸å¿ƒï¼šè·å–æ—¥ç¨‹çŠ¶æ€ (æœ€ç»ˆçº¯å‡€ç‰ˆ)
function getScheduleContext() {
    if(mySchedule.length === 0) return "";

    const now = new Date();
    const currentDay = now.getDay(); // 0-6
    const currentTimeStr = now.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
    
    let context = "";
    
    // A. æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿›è¡Œ
    const currentEvent = mySchedule.find(s => {
        if (s.day !== currentDay) return false;
        return currentTimeStr >= s.start && currentTimeStr <= s.end;
    });
    
    if(currentEvent) {
        // åŠ å¼ºäº†è¯­æ°”ï¼Œè®© AI å¿…é¡»æ³¨æ„åˆ°
        context += `\n[ğŸš¨ å¿…é¡»æ‰§è¡Œçš„æŒ‡ä»¤]: ç³»ç»Ÿæ£€æµ‹åˆ°ç”¨æˆ·å½“å‰æ­£å¤„äºæ—¥ç¨‹å®‰æ’ä¸­ï¼š"${currentEvent.name}" (${currentEvent.start}-${currentEvent.end})ã€‚
        ç”¨æˆ·æ­¤æ—¶åº”è¯¥æ­£åœ¨å¤„ç†è¯¥äº‹é¡¹ï¼Œä½†ä»–å´åœ¨ç©æ‰‹æœºå‘æ¶ˆæ¯ã€‚
        è¯·åŠ¡å¿…åœ¨å›å¤ä¸­â€œæ‹†ç©¿â€ä»–ï¼Œç”¨è°ƒä¾ƒæˆ–å…³å¿ƒçš„è¯­æ°”ï¼ˆæ ¹æ®äººè®¾ï¼‰æé†’ä»–å›åˆ°"${currentEvent.name}"ä¸­å»ï¼Œä¸è¦æ‘¸é±¼ï¼`;
    } else {
        // B. æ£€æŸ¥æ¥ä¸‹æ¥çš„
        const todayEvents = mySchedule.filter(s => s.day === currentDay);
        todayEvents.sort((a,b) => a.start.localeCompare(b.start));
        const nextEvent = todayEvents.find(s => s.start > currentTimeStr);
        
        if(nextEvent) {
            context += `\n[æ—¥ç¨‹æé†’]: ç”¨æˆ·ä»Šå¤©æ¥ä¸‹æ¥çš„å®‰æ’ï¼š"${nextEvent.name}" (å¼€å§‹æ—¶é—´: ${nextEvent.start})ã€‚å¦‚æœæ—¶é—´ä¸´è¿‘ï¼Œè¯·æé†’å‡†å¤‡ã€‚`;
        }
    }

    return context;
}
        // ==========================================
// --- X (Twitter) æ ¸å¿ƒé€»è¾‘ (ç»ˆææœªåˆ å‡ç‰ˆ) ---
// ==========================================

// X çš„æ•°æ®ç»“æ„
let xData = {
    user: {
        handle: "@user_123",
        name: "æˆ‘",
        avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
        bio: "AI Phone ç”¨æˆ·",
        badgeType: "none", // none, blue, gold, couple, married, vip
        partnerId: "",     // æƒ…ä¾£/å·²å©šç»‘å®šçš„è§’è‰²ID
        banner: "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?auto=format&fit=crop&w=1000&q=80",
        location: "ä¸Šæµ·",
        stats: { following: 120, followers: 45 },
        following: [] 
    },
    tweets: [], 
    notifications: []
};

// å…¨å±€å˜é‡
let currentDetailTweetId = null; 
let currentRetweetId = null;     

// ----------------------------
// 1. åˆå§‹åŒ–ä¸æ•°æ®åŠ è½½
// ----------------------------
function initXApp() {
    loadXData();
    if (xData.tweets.length === 0) {
        generateInitialTweets(); // ä»…é¦–æ¬¡ä½¿ç”¨å‡æ•°æ®å¡«å……ï¼Œä¹‹åå…¨é AI
    }
    renderXFeed();
    updateXBadge();
    
    // ç»‘å®šé¡¶éƒ¨å°å¤´åƒ
    const myChar = getActiveChar();
    if(myChar) {
        const userAvatarEl = document.getElementById('x-current-user-avatar');
        if(userAvatarEl) userAvatarEl.src = xData.user.avatar;
    }
}

function loadXData() {
    const saved = localStorage.getItem('ai_phone_x_data');
    if (saved) {
        xData = JSON.parse(saved);
        if(!xData.user.stats) xData.user.stats = { following: 120, followers: 45 };
    } else {
        xData.user.following = contacts.map(c => c.id);
        saveXData();
    }
}

function saveXData() {
    localStorage.setItem('ai_phone_x_data', JSON.stringify(xData));
}

// åˆå§‹å‡æ•°æ® (ä»…ç”¨äºç¬¬ä¸€æ¬¡æ‰“å¼€Appä¸ç©ºç™½)
function generateInitialTweets() {
    contacts.forEach(char => {
        createTweet({
            authorId: char.id,
            isNPC: false,
            content: `æ¬¢è¿æ¥åˆ° Xï¼ #HelloX`,
            timestamp: Date.now() - Math.random() * 10000000,
            // åˆå§‹æ•°æ®ä¹Ÿç»™ç‚¹å‡è¯„è®ºè£…è£…æ ·å­
            skipAutoComments: false 
        });
    });
    createTweet({
        authorId: "npc_1", isNPC: true, npcName: "ç§‘æŠ€æ—¥æŠ¥", npcHandle: "@tech_daily", npcAvatar: "https://api.dicebear.com/7.x/identicon/svg?seed=Tech",
        content: "BJPhoneæ›´æ–°äº† X åŠŸèƒ½ï¼Œå¤ªé…·äº†ï¼å¤§å®¶æ›´æ–°äº†å—ï¼Ÿ ğŸ“±âœ¨", timestamp: Date.now() - 60000
    });
}

// åˆ›å»ºæ¨æ–‡æ ¸å¿ƒå‡½æ•°
function createTweet(data) {
    const tweet = {
        id: 'tweet_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        authorId: data.authorId, 
        isNPC: data.isNPC || false,
        npcName: data.npcName, npcHandle: data.npcHandle, npcAvatar: data.npcAvatar,
        content: data.content,
        images: data.images || [],
        timestamp: data.timestamp || Date.now(),
        stats: {
            likes: Math.floor(Math.random() * 100),
            retweets: Math.floor(Math.random() * 20),
            replies: 0
        },
        comments: [], 
        likedByMe: false,
        
        isRepost: data.isRepost || false,
        isQuote: data.isQuote || false,
        sourceTweet: data.sourceTweet || null,
        quoteContent: data.quoteContent || ""
    };
    
    // ã€æ ¸å¿ƒã€‘ä¼˜å…ˆä½¿ç”¨ AI ç”Ÿæˆçš„è¯„è®º
    if (data.aiComments && data.aiComments.length > 0) {
        data.aiComments.forEach(cmt => {
            tweet.comments.push({
                id: 'cmt_' + Math.random().toString(36),
                name: cmt.name, 
                // éšæœºç”Ÿæˆä¸€ä¸ªçœ‹èµ·æ¥çœŸå®çš„ handle
                handle: "@User_" + Math.random().toString(36).substr(2, 5),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: cmt.content, 
                // è¯„è®ºæ—¶é—´ï¼šæ¨æ–‡å‘å¸ƒå 1-30 åˆ†é’Ÿå†…
                timestamp: tweet.timestamp + Math.random() * 1800000
            });
        });
    } 
    // é™çº§æ–¹æ¡ˆï¼šå¦‚æœæ²¡æœ‰AIè¯„è®ºä¸”æœªè·³è¿‡ï¼Œä½¿ç”¨æœ¬åœ°åº“é˜²æ­¢ç©ºè™š (ä»…é™ç¦»çº¿æƒ…å†µ)
    else if (!data.skipAutoComments) {
        const commentCount = 3 + Math.floor(Math.random() * 3);
        for(let i=0; i<commentCount; i++) {
            const names = ["è·¯äººA", "åƒç“œ", "User888", "Momo", "çº¯çˆ±æˆ˜ç¥"];
            const contents = ["å¥½æ´»", "çœŸå®", "å›´è§‚", "å‰æ’", "ä¸æ‡‚å°±é—®ï¼Œè¿™æ˜¯å•¥ï¼Ÿ"];
            tweet.comments.push({
                id: 'cmt_' + Math.random().toString(36),
                name: names[Math.floor(Math.random()*names.length)],
                handle: "@user_"+Math.floor(Math.random()*999),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: contents[Math.floor(Math.random()*contents.length)],
                timestamp: Date.now()
            });
        }
    }
    
    tweet.stats.replies = tweet.comments.length;

    xData.tweets.unshift(tweet); 
    if(xData.tweets.length > 80) xData.tweets.pop(); // ä¿ç•™ç¨å¾®å¤šä¸€ç‚¹
    saveXData();
    return tweet;
}

// ----------------------------
// 2. æ¸²æŸ“ç›¸å…³ (Feed & Element)
// ----------------------------

function renderXFeed() {
    const container = document.getElementById('x-feed-container');
    if(!container) return;
    container.innerHTML = '';
    
    const sortedTweets = xData.tweets.sort((a, b) => b.timestamp - a.timestamp);
    sortedTweets.forEach(tweet => {
        const tweetEl = buildTweetElement(tweet);
        container.appendChild(tweetEl);
    });
}

// åŠ è½½ç”¨æˆ·ä¸ªäººé¡µé¢çš„æ¨æ–‡ (ä¿®å¤ç‰ˆ)
function loadUserProfileTweets() {
    const container = document.getElementById('x-profile-tweets-container');
    if(!container) {
        console.error("æ‰¾ä¸åˆ°ä¸ªäººä¸»é¡µæ¨æ–‡å®¹å™¨ x-profile-tweets-container");
        return; 
    }
    container.innerHTML = '';

    // ç­›é€‰é€»è¾‘ï¼š
    // 1. authorId æ˜¯ 'user' (åŸåˆ›)
    // 2. isRepost æ˜¯ true ä¸” authorId æ˜¯ 'user' (æˆ‘è½¬å¸–çš„)
    // 3. isQuote æ˜¯ true ä¸” authorId æ˜¯ 'user' (æˆ‘å¼•ç”¨çš„)
    // å…¶å®åªè¦ authorId === 'user' å°±å¤Ÿäº†ï¼Œå› ä¸º createTweet é‡Œæˆ‘ä»¬éƒ½æŠŠ user çš„æ“ä½œæ ‡è®°ä¸ºäº† authorId: 'user'
    const myTweets = xData.tweets.filter(t => t.authorId === 'user');

    console.log("æ‰¾åˆ°ç”¨æˆ·æ¨æ–‡æ•°é‡:", myTweets.length); // æ–¹ä¾¿è°ƒè¯•

    if (myTweets.length === 0) {
        container.innerHTML = `<div style="padding:20px;text-align:center;color:#71767b">æš‚æ— æ¨æ–‡</div>`;
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åº
    const sortedMyTweets = myTweets.sort((a, b) => b.timestamp - a.timestamp);

    sortedMyTweets.forEach(tweet => {
        // å¤ç”¨ buildTweetElement ç”Ÿæˆ DOM
        const el = buildTweetElement(tweet);
        container.appendChild(el);
    });
}

function buildTweetElement(tweet) {
    let displayTweet = tweet;
    let repostLabel = "";
    
    if (tweet.isRepost) {
        displayTweet = tweet.sourceTweet; 
        const reposterName = (tweet.authorId === 'user') ? xData.user.name : "æŸäºº";
        repostLabel = `
            <div class="x-repost-header">
                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#71767b"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                ${reposterName} è½¬å¸–äº†
            </div>`;
    }

    const getUserInfo = (tid, isNpc, npcInfo) => {
        if (tid === 'user') return { ...xData.user, badge: xData.user.badgeType || 'none' };
        if (isNpc) return { name: npcInfo.name, handle: npcInfo.handle, avatar: npcInfo.avatar, badge: 'none' };
        const char = contacts.find(c => c.id === tid);
        if (char) {
            let b = 'none';
            if(tweet.authorId === xData.user.partnerId && (xData.user.badgeType==='couple'||xData.user.badgeType==='married')) b = xData.user.badgeType;
            return { name: char.name, handle: "@" + char.id.substring(0, 8), avatar: char.avatar, badge: b };
        }
        return { name: "æœªçŸ¥", handle: "@?", avatar: "", badge: 'none' };
    };

    const author = getUserInfo(displayTweet.authorId, displayTweet.isNPC, {name: displayTweet.npcName, handle: displayTweet.npcHandle, avatar: displayTweet.npcAvatar});
    
    let quoteHtml = "";
    if (tweet.isQuote) {
        const source = tweet.sourceTweet;
        const sourceAuthor = getUserInfo(source.authorId, source.isNPC, {name: source.npcName, handle: source.npcHandle, avatar: source.npcAvatar});
        quoteHtml = `
            <div class="x-quote-box">
                <div class="x-tweet-header">
                    <img src="${sourceAuthor.avatar}" style="width:20px;height:20px;border-radius:50%;margin-right:5px;">
                    <span class="x-name" style="font-size:14px">${sourceAuthor.name}</span>
                    <span class="x-handle" style="font-size:13px">${sourceAuthor.handle}</span>
                </div>
                <div class="x-text" style="font-size:14px">${source.content}</div>
            </div>`;
    }

    const timeDiff = Math.floor((Date.now() - displayTweet.timestamp) / 1000);
    let timeStr = timeDiff < 60 ? "åˆšåˆš" : (timeDiff < 3600 ? Math.floor(timeDiff/60)+"åˆ†" : Math.floor(timeDiff/3600)+"æ—¶");

    const div = document.createElement('div');
    div.className = 'x-tweet-wrapper'; 
    div.innerHTML = `
        ${repostLabel}
        <div class="x-tweet">
            <img src="${author.avatar}" class="x-tweet-avatar">
            <div class="x-tweet-content">
                <div class="x-tweet-header">
                    <span class="x-name">${author.name}</span>
                    ${getBadgeSVG(author.badge)}
                    <span class="x-handle">${author.handle}</span>
                    <span class="x-time">Â· ${timeStr}</span>
                </div>
                <div class="x-text">${tweet.isQuote ? tweet.quoteContent : displayTweet.content}</div>
                ${quoteHtml}
                <div class="x-actions">
                    <button class="x-action-btn reply" onclick="event.stopPropagation(); openReplyModal('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg>
                        ${displayTweet.stats.replies || 0}
                    </button>
                    <button class="x-action-btn retweet" onclick="event.stopPropagation(); handleRetweet('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                        ${displayTweet.stats.retweets || 0}
                    </button>
                    <button class="x-action-btn like ${displayTweet.likedByMe?'liked':''}" onclick="event.stopPropagation(); handleLike('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="${displayTweet.likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z'}"></path></svg>
                        <span class="like-count">${displayTweet.stats.likes || 0}</span>
                    </button>
                    <button class="x-action-btn share" onclick="event.stopPropagation(); shareToDM('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></svg>
                    </button>
                </div>
            </div>
        </div>`;

    div.onclick = (e) => {
        // ä½ çš„è¦æ±‚ï¼šè·¯äºº/ç²‰ä¸æ¨æ–‡ä¸ç”¨ç‚¹è¿›è¯„è®ºåŒº
        // ä½†å¦‚æœæ˜¯è½¬å¸–æˆ–å¼•ç”¨ï¼Œæ— è®ºåŸå¸–æ˜¯è°ï¼Œéƒ½å…è®¸ç‚¹è¿›å»ï¼Œå› ä¸ºé‚£æ˜¯ç”¨æˆ·çš„è¡Œä¸º
        if (displayTweet.isNPC && !tweet.isRepost && !tweet.isQuote) return; 
        openTweetDetail(tweet.id);
    };

    return div;
}

// ----------------------------
// 3. äº¤äº’é€»è¾‘
// ----------------------------

function handleRetweet(tweetId) {
    currentRetweetId = tweetId;
    openModal('modal-retweet-menu');
}

// 2. ç¡®è®¤æ“ä½œ (ä¿®å¤ç‰ˆï¼šå¼•ç”¨æ¨æ–‡ä¹Ÿä¼šè§¦å‘ AI äº’åŠ¨)
function confirmRetweet(type) {
    closeModal('modal-retweet-menu');
    if (!currentRetweetId) return;
    
    const sourceTweet = xData.tweets.find(t => t.id === currentRetweetId);
    if (!sourceTweet) return;

    if (type === 'repost') {
        // --- è½¬å¸– (ä¿æŒä¸å˜) ---
        const newTweet = {
            id: 'tweet_rt_' + Date.now(),
            authorId: 'user',
            isRepost: true,   
            sourceTweet: sourceTweet, 
            timestamp: Date.now(),
            stats: { likes: 0, retweets: 0, replies: 0 },
            comments: [],
            likedByMe: false
        };
        xData.tweets.unshift(newTweet);
        sourceTweet.stats.retweets++; 
        
    } else if (type === 'quote') {
        // --- å¼•ç”¨ (ä¿®æ”¹äº†è¿™é‡Œ) ---
        const content = prompt("æ·»åŠ è¯„è®º:");
        if (content) {
            const newTweet = {
                id: 'tweet_qt_' + Date.now(),
                authorId: 'user',
                isQuote: true, 
                quoteContent: content, 
                sourceTweet: sourceTweet,
                timestamp: Date.now(),
                stats: { likes: 0, retweets: 0, replies: 0 },
                comments: [],
                likedByMe: false
            };
            
            xData.tweets.unshift(newTweet);
            sourceTweet.stats.retweets++;

            // âœ¨âœ¨âœ¨ æ–°å¢ï¼šè§¦å‘ AI äº’åŠ¨æµ âœ¨âœ¨âœ¨
            if(globalConfig.apiKey) {
                // 1. 3ç§’åï¼Œè·¯äºº/ç²‰ä¸æ¥è¯„è®ºä½ çš„å¼•ç”¨
                setTimeout(() => {
                    generateFanOrNPCCommentForUser(newTweet.id);
                }, 3000);

                // 2. 6ç§’åï¼Œè§’è‰²æ¥è¯„è®ºä½ çš„å¼•ç”¨
                setTimeout(() => {
                    generateCharacterCommentForUser(newTweet.id);
                }, 6000);
            }
        }
    }
    saveXData();
    renderXFeed();
}

function handleLike(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (tweet) {
        tweet.likedByMe = !tweet.likedByMe;
        tweet.stats.likes += tweet.likedByMe ? 1 : -1;
        saveXData();
        renderXFeed();
    }
}

function openReplyModal(tweetId) {
    openTweetDetail(tweetId); 
}

// å‘æ¨æ–‡ (æ›´æ–°ç‰ˆï¼šè§¦å‘è§’è‰²è¯„è®º)
function openComposeTweet() {
    const content = prompt("æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ");
    if (content) {
        const userTweet = createTweet({
            authorId: 'user',
            content: content,
            skipAutoComments: true // æ—¢ç„¶æˆ‘ä»¬è¦AIç”Ÿæˆï¼Œå°±è·³è¿‡æœ¬åœ°å‡æ•°æ®
        });
        renderXFeed();
        
        // å°†æ¨æ–‡åŒæ­¥åˆ°ä¸ªäººä¸»é¡µ
        // æ³¨æ„ï¼šcreateTweet å·²ç»æŠŠæ¨æ–‡åŠ åˆ° xData.tweets é‡Œé¢äº†ï¼Œä¸” authorId æ˜¯ 'user'
        // æ‰€ä»¥åªè¦ loadUserProfileTweets() é€»è¾‘æ­£ç¡®ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œ

        if(globalConfig.apiKey) {
            // 1. å»¶è¿Ÿè§¦å‘è·¯äºº/ç²‰ä¸è¯„è®º
            setTimeout(() => {
                generateFanOrNPCCommentForUser(userTweet.id);
            }, 3000);

            // 2. ã€æ–°å¢ã€‘å»¶è¿Ÿè§¦å‘è§’è‰²è¯„è®º (å¿…å›)
            setTimeout(() => {
                generateCharacterCommentForUser(userTweet.id);
            }, 6000); // ç¨å¾®æ™šä¸€ç‚¹ï¼ŒåƒçœŸäººä¸€æ ·
        }
    }
}

function switchXTab(tab) {
    document.querySelectorAll('.x-tab-btn').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    if (tab === 'home') {
        const feed = document.getElementById('x-feed-container');
        if(feed) { feed.scrollTop = 0; triggerPullToRefresh(); }
    } else if (tab === 'dm') {
        navigateTo('page-msg-list');
    } else {
        // Search å’Œ Notif æš‚æ—¶ç•™ç©ºæˆ–æ˜¾ç¤ºæç¤º
        // alert("åŠŸèƒ½å¼€å‘ä¸­..."); 
    }
}

// ----------------------------
// 4. AI é©±åŠ¨é€»è¾‘ (æ ¸å¿ƒå¤§æ•´åˆ)
// ----------------------------

// æ¨¡æ‹Ÿä¸‹æ‹‰åˆ·æ–° (æ‰¹é‡ç”Ÿæˆç‰ˆï¼š6-8æ¡ï¼Œè§’è‰²é™åˆ¶3æ¡)
async function triggerPullToRefresh() {
    const spinner = document.getElementById('x-refresh-spinner');
    if(spinner) spinner.style.display = 'block';
    
    // 1. å†³å®šæœ¬æ¬¡åˆ·æ–°ç”Ÿæˆçš„æ€»æ¡æ•° (6 åˆ° 8 æ¡)
    const totalToGenerate = Math.floor(Math.random() * 3) + 6; 
    let charTweetCount = 0; // å½“å‰æ‰¹æ¬¡å·²ç”Ÿæˆçš„è§’è‰²æ¨æ–‡è®¡æ•°
    const maxCharTweets = 3; // è§’è‰²æ¨æ–‡ä¸Šé™
    
    // å®šä¹‰ä¸€ä¸ªç”Ÿæˆé˜Ÿåˆ—
    const tasks = [];

    for (let i = 0; i < totalToGenerate; i++) {
        const roll = Math.random(); // 0.0 ~ 1.0
        
        // é€»è¾‘åˆ¤æ–­ï¼š
        // 1. å¦‚æœéšæœºåˆ°äº†è§’è‰² (70%æ¦‚ç‡)ï¼Œä¸”è¿˜æ²¡è¶…è¿‡ä¸Šé™ -> ç”Ÿæˆè§’è‰²æ¨
        // 2. å¦åˆ™ç”Ÿæˆç²‰ä¸æˆ–è·¯äººæ¨
        
        if (roll >= 0.30 && contacts.length > 0 && charTweetCount < maxCharTweets) {
            // --- ç”Ÿæˆè§’è‰²æ¨æ–‡ ---
            charTweetCount++;
            const randomChar = contacts[Math.floor(Math.random() * contacts.length)];
            // å°† Promise æ¨å…¥é˜Ÿåˆ—ï¼Œå¹¶è¡Œæ‰§è¡Œ
            tasks.push(generateXTweetAI(randomChar.id));
        } else {
            // --- ç”Ÿæˆè·¯äºº/ç²‰ä¸æ¨æ–‡ ---
            // åœ¨å‰©ä¸‹çš„æ¦‚ç‡é‡Œï¼Œå†ç»†åˆ†ç²‰ä¸å’Œè·¯äºº
            // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šåªè¦ä¸å‘è§’è‰²æ¨ï¼Œå°±å‘NPCæ¨ã€‚
            // ä¸ºäº†ä¿æŒä½ æƒ³è¦çš„ 5% è·¯äºº vs 25% ç²‰ä¸çš„æ¯”ä¾‹ (å¤§çº¦ 1:5)
            const npcRoll = Math.random();
            const type = npcRoll < 0.17 ? 'passerby' : 'fan'; // 0.17 æ˜¯ 5/30 çš„è¿‘ä¼¼å€¼
            tasks.push(generateFanOrNPCTweetAI(type));
        }
    }

    // ç­‰å¾…æ‰€æœ‰ AI ç”Ÿæˆä»»åŠ¡å®Œæˆ (å¹¶è¡Œæ‰§è¡Œï¼Œé€Ÿåº¦å¿«)
    await Promise.all(tasks);

    // å…¨éƒ¨å®Œæˆå
    if(spinner) spinner.style.display = 'none';
    renderXFeed(); // åˆ·æ–°åˆ—è¡¨
    if(navigator.vibrate) navigator.vibrate(50);
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    const feed = document.getElementById('x-feed-container');
    if(feed) feed.scrollTop = 0;
}

// AI: è§’è‰²å‘æ¨ (æ»¡è¡€ç‰ˆï¼šè¯»è®°å¿† + å¼ºåˆ¶ç”Ÿæˆè¯„è®º)
async function generateXTweetAI(charId) {
    const char = contacts.find(c => c.id === charId);
    if (!char || !globalConfig.apiKey) return;

    let memoryContext = "";
    // è¯»å–èŠå¤©
    if (char.messages && char.messages.length > 0) {
        const recentMsgs = char.messages.slice(-10).map(m => `${m.role==='user'?'ç”¨æˆ·':'æˆ‘'}: ${m.content}`).join('\n');
        memoryContext += `\nã€æœ€è¿‘èŠå¤©ä¸Šä¸‹æ–‡(ä»…çµæ„Ÿ)ã€‘:\n${recentMsgs}\n`;
    }
    // è¯»å–æ—¥è®°
    if (char.diaries && char.diaries.length > 0) {
        memoryContext += `\nã€æœ€æ–°æ—¥è®°(ä»…çµæ„Ÿ)ã€‘:\n${char.diaries[char.diaries.length-1]}\n`;
    }

    // æ»¡è¡€ Prompt
    const prompt = `ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}
    ${memoryContext}
    
    ä»»åŠ¡ï¼šå‘å¸ƒä¸€æ¡æ¨ç‰¹(X)ã€‚
    è¦æ±‚ï¼š
    1. ç»“åˆã€æœ€è¿‘èŠå¤©ã€‘æˆ–ã€æ—¥è®°ã€‘çš„å¿ƒæƒ…ï¼ˆéšæ™¦æåŠï¼‰ï¼Œæˆ–è€…å‘æ—¥å¸¸ã€åæ§½ã€‚ä½¿ç”¨ä¸­æ–‡ã€‚
    2. å¿…é¡»åŒæ—¶ä¼ªé€  6-8 æ¡â€œè·¯äºº/ç²‰ä¸â€çš„è¯„è®ºã€‚
    3. è¯„è®ºè¦æ±‚ï¼šé£æ ¼å„å¼‚ï¼ˆè†œæ‹œã€åæ§½ã€ç©æ¢—ã€åƒç“œã€CPç²‰ï¼‰ï¼Œç®€çŸ­çœŸå®ã€‚
    
    ã€å¿…é¡»è¿”å›çº¯JSONã€‘ï¼š
    {
        "content": "æ¨æ–‡å†…å®¹",
        "comments": [
            {"name": "ç½‘å1", "content": "è¯„è®º1"},
            {"name": "ç½‘å2", "content": "è¯„è®º2"},
            ...
        ]
    }`;

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: prompt }],
    temperature: 0.9
});
        const data = await res.json();
        const result = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
        
        createTweet({ authorId: char.id, content: result.content, aiComments: result.comments });
        renderXFeed();
    } catch (e) { console.error(e); }
}

// ä¿®å¤ç‰ˆï¼šç”Ÿæˆ è·¯äºº(passerby) æˆ– ç²‰ä¸(fan) çš„æ¨æ–‡ (å·²å»æ²¹å»éŸ©å›¢)
async function generateFanOrNPCTweetAI(type) {
    if (!globalConfig.apiKey) {
        generateNPCTweet(); 
        return;
    }

    let systemInstruction = "";
    
    if (type === 'fan') {
        // --- ç²‰ä¸æ¨¡å¼ ---
        const targetIsUser = Math.random() > 0.5; 
        let targetName = xData.user.name;
        let targetContext = "æ™®é€šçš„åšä¸»"; // é»˜è®¤èº«ä»½

        if (!targetIsUser && contacts.length > 0) {
            const randomChar = contacts[Math.floor(Math.random() * contacts.length)];
            targetName = randomChar.name;
            // å…³é”®ä¿®å¤ï¼šæŠŠè§’è‰²äººè®¾è¯»å‡ºæ¥ï¼
            targetContext = `è¯¥è§’è‰²çš„äººè®¾æ˜¯ï¼š${randomChar.systemPrompt}`;
        }

        // ğŸ’€ æ³¨å…¥å¼ºæ•ˆé˜²éŸ©å›¢è¡¥ä¸
        systemInstruction = `ä½ ç°åœ¨è¦æ‰®æ¼” X (Twitter) ä¸Šçš„ä¸€ä¸ªã€ç‹‚çƒ­ç²‰ä¸ã€‘ã€‚
        ä½ çš„å¶åƒ/å…³æ³¨å¯¹è±¡æ˜¯: "${targetName}"ã€‚
        
        ã€é‡è¦è®¾å®šã€‘ï¼š
        1. ${targetContext}
        2. âš ï¸ ç»å¯¹ç¦æ­¢å…³è”ç°å®ä¸–ç•Œçš„æ˜æ˜Ÿï¼å¦‚æœåå­—å« Jin/Tom/Jerry ç­‰ï¼Œè¿™åªæ˜¯é‡åï¼Œ**ç»å¯¹ä¸æ˜¯** BTSã€éŸ©å›¢çˆ±è±†æˆ–åŠ¨ç”»ç‰‡è§’è‰²ï¼
        3. ç¦æ­¢å‡ºç°â€œæ‰“æ­Œâ€ã€â€œå›å½’â€ã€â€œèˆå°â€ã€â€œæ¬§å·´â€ã€â€œæ’’æµªå˜¿â€ç­‰é¥­åœˆç‰¹æœ‰éŸ©ç³»è¯æ±‡ã€‚
        4. è¯·æŠŠä»–å½“æˆä¸€ä¸ªç”Ÿæ´»ä¸­çš„æ™®é€šäººæ¥å–œæ¬¢ã€‚

        è¯·ç”Ÿæˆä¸€æ¡æ¨æ–‡ã€‚å†…å®¹æ–¹å‘ï¼šè¡¨ç™½ã€åˆ†äº«å…³äº"${targetName}"çš„è¶£äº‹ã€å—‘CPï¼ˆåšä¸»x${targetName}ï¼‰ã€‚
        è¯­æ°”ï¼šçœŸå®ç¤¾äº¤ç½‘ç»œé£æ ¼ï¼Œå¤šç”¨ emojiã€‚
        è¯·éšæœºç”Ÿæˆä¸€ä¸ªç½‘åå’ŒHandleã€‚`;
        
    } else {
        // --- è·¯äººæ¨¡å¼ ---
        systemInstruction = `ä½ ç°åœ¨æ‰®æ¼” X (Twitter) ä¸Šçš„ä¸€ä¸ªã€æ™®é€šè·¯äººã€‘ã€‚
        è¯·ç”Ÿæˆä¸€æ¡æ¨æ–‡ã€‚å†…å®¹å®Œå…¨éšæœºï¼šç”Ÿæ´»åæ§½ã€å·¥ä½œæŠ±æ€¨ã€å¤©æ°”ã€ç¾é£Ÿã€emoæ—¶åˆ»ã€‚
        è¯­æ°”ï¼šçœŸå®ã€éšæ„ã€ç”Ÿæ´»åŒ–ã€‚
        è¯·éšæœºç”Ÿæˆä¸€ä¸ªç½‘åå’ŒHandleã€‚`;
    }

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [
        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ¨ç‰¹æ¨¡æ‹Ÿç”Ÿæˆå™¨ã€‚è¯·åªè¿”å›çº¯ JSON æ ¼å¼: {name, handle, content}ã€‚" },
        { role: "user", content: systemInstruction }
    ],
    temperature: 0.95
});

        const data = await res.json();
        let aiText = data.choices[0].message.content;
        aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
        const result = JSON.parse(aiText);

        const tweet = {
            id: 'tweet_ai_npc_' + Date.now(),
            authorId: 'npc_' + Date.now(),
            isNPC: true,
            npcName: result.name,
            npcHandle: result.handle.startsWith('@') ? result.handle : '@'+result.handle,
            npcAvatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${result.handle}`,
            content: result.content,
            timestamp: Date.now(),
            stats: { likes: Math.floor(Math.random()*50), retweets: Math.floor(Math.random()*10), replies: 0 },
            comments: [],
            likedByMe: false
        };
        xData.tweets.unshift(tweet);
        if(xData.tweets.length > 50) xData.tweets.pop();
        saveXData();

    } catch (e) { console.error(e); }
}
// ä¿®å¤ç‰ˆï¼šä¸ºç”¨æˆ·æ¨æ–‡(å«å¼•ç”¨)ç”Ÿæˆè¯„è®º (é˜²çˆ±è±†è¡¥ä¸)
async function generateFanOrNPCCommentForUser(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if(!tweet) return;

    let contentContext = `æ¨æ–‡å†…å®¹ï¼š"${tweet.content}"`;
    if (tweet.isQuote) {
        contentContext = `ç”¨æˆ·è½¬å‘å¹¶è¯„è®ºäº†åˆ«äººçš„æ¨æ–‡ã€‚
        ç”¨æˆ·çš„è¯„è®ºï¼š"${tweet.quoteContent}"
        è¢«è½¬å‘çš„åŸæ¨æ–‡ï¼š"${tweet.sourceTweet.content}"`;
    }

    const prompt = `ç”¨æˆ· "${xData.user.name}" å‘äº†ä¸€æ¡æ¨æ–‡ï¼ˆæˆ–è€…å¼•ç”¨è½¬å‘ï¼‰ã€‚
    ${contentContext}
    
    è¯·ç”Ÿæˆ 6-8 æ¡è·¯äººæˆ–ç²‰ä¸çš„è¯„è®ºã€‚
    
    ã€ä¸¥æ ¼é™åˆ¶ã€‘ï¼š
    1. å¦‚æœå†…å®¹é‡Œæåˆ°äº† Jinã€JK ç­‰åå­—ï¼Œè¿™**ä»…ä»…æ˜¯ç”¨æˆ·çš„æ™®é€šæœ‹å‹/æ‹äºº**ï¼Œç»å¯¹ä¸æ˜¯éŸ©å›½ç”·å›¢å¶åƒï¼
    2. ç¦æ­¢å‡ºç°ä»»ä½•éŸ©é¥­åœˆç”¨è¯­ï¼ˆå¦‚ï¼šå†…å¨±ã€éŸ©å¨±ã€çˆ±è±†ã€æ‰“æ¦œï¼‰ã€‚
    3. æŠŠä»–ä»¬å½“æˆæ™®é€šç½‘å‹/ç½‘çº¢åšä¸»äº’åŠ¨ã€‚

    å¿…é¡»è¿”å›çº¯JSONæ•°ç»„ï¼š[{"name": "ç½‘å", "content": "å†…å®¹"}, ...]`;

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: prompt }],
    temperature: 0.9
});
        const data = await res.json();
        const comments = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
        
        comments.forEach(cmt => {
             tweet.comments.push({
                id: 'cmt_ai_' + Math.random().toString(36),
                name: cmt.name, handle: "@user_" + Math.floor(Math.random()*9999),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: cmt.content, 
                timestamp: Date.now()
            });
        });
        tweet.stats.replies = tweet.comments.length;
        saveXData();
        
        if(currentDetailTweetId === tweet.id) {
            renderDetailComments(tweet);
        } else {
            renderXFeed();
        }
        
    } catch(e) { console.error(e); }
}

// æœ¬åœ°å…œåº•è·¯äººç”Ÿæˆ
function generateNPCTweet() {
    const tweet = {
        id: 'tweet_npc_' + Date.now(), authorId: 'npc_' + Date.now(), isNPC: true,
        npcName: "è·¯äºº", npcHandle: "@user_"+Date.now(), npcAvatar: "",
        content: "ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼", timestamp: Date.now(),
        stats: { likes: 0, retweets: 0, replies: 0 }, comments: [], likedByMe: false
    };
    xData.tweets.unshift(tweet);
    saveXData();
    return tweet;
}

// ----------------------------
// 5. è¯¦æƒ…é¡µé€»è¾‘
// ----------------------------

function openTweetDetail(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (!tweet) return;

    currentDetailTweetId = tweetId;
    document.getElementById('page-x-detail').classList.add('active');
    
    // è¿™é‡Œçš„é€»è¾‘ï¼šå¦‚æœæ˜¯è½¬å¸–ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯æƒ³çœ‹è½¬å¸–çš„å†…å®¹ï¼ˆæ¯”å¦‚â€œè½¬å‘ç†ç”±â€ï¼‰ï¼Œ
    // ä½†å› ä¸ºç›®å‰æˆ‘ä»¬çš„è½¬å¸–æ¨¡å‹æ¯”è¾ƒç®€å•ï¼ˆæ²¡æœ‰è½¬å‘ç†ç”±ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ˜¾ç¤ºæºæ¨æ–‡æ¯”è¾ƒåˆç†ã€‚
    // å¼•ç”¨è´´åˆ™æœ‰è‡ªå·±çš„å†…å®¹ã€‚
    renderDetailMainTweet(tweet);
    renderDetailComments(tweet);
}

function closeTweetDetail() {
    document.getElementById('page-x-detail').classList.remove('active');
    currentDetailTweetId = null;
    renderXFeed(); 
}

function renderDetailMainTweet(tweet) {
    const container = document.getElementById('x-detail-main-tweet');
    
    let displayTweet = tweet;
    // å¦‚æœæ˜¯è½¬å¸–ï¼Œå±•ç¤ºåŸè´´å†…å®¹
    if(tweet.isRepost) displayTweet = tweet.sourceTweet;

    // è·å–ä½œè€…
    let name, handle, avatar, badgeType = 'none';
    if (displayTweet.authorId === 'user') {
        name = xData.user.name; handle = xData.user.handle; avatar = xData.user.avatar; badgeType = xData.user.badgeType;
    } else if (displayTweet.isNPC) {
        name = displayTweet.npcName; handle = displayTweet.npcHandle; avatar = displayTweet.npcAvatar;
    } else {
        const char = contacts.find(c => c.id === displayTweet.authorId);
        if (char) { 
            name = char.name; handle = "@" + char.id.substring(0, 8); avatar = char.avatar; 
            if (displayTweet.authorId === xData.user.partnerId && (xData.user.badgeType==='couple'||xData.user.badgeType==='married')) badgeType = xData.user.badgeType;
        }
    }

    const date = new Date(displayTweet.timestamp);
    const timeStr = date.toLocaleTimeString() + ' Â· ' + date.toLocaleDateString();

    let quoteHtml = "";
    if(tweet.isQuote) {
       const src = tweet.sourceTweet;
       quoteHtml = `<div class="x-quote-box" style="margin-top:15px"><div class="x-text" style="font-size:14px">${src.content}</div></div>`;
    }

    container.innerHTML = `
        <div class="x-detail-tweet">
            <div class="x-detail-user">
                <img src="${avatar}" class="x-detail-avatar">
                <div class="x-detail-info">
                    <div style="display:flex; align-items:center;">
                        <span class="x-detail-name">${name}</span>
                        ${getBadgeSVG(badgeType)}
                    </div>
                    <span class="x-detail-handle">${handle}</span>
                </div>
            </div>
            <div class="x-detail-text">
                ${tweet.isQuote ? tweet.quoteContent : displayTweet.content}
            </div>
            ${quoteHtml}
            <div class="x-detail-meta">${timeStr}</div>
            <div class="x-actions" style="max-width:100%;justify-content:space-around;border-bottom:1px solid #2f3336;padding-bottom:10px">
                <button class="x-action-btn"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg></button>
                <button class="x-action-btn" onclick="handleRetweet('${displayTweet.id}')"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg></button>
                <button class="x-action-btn ${displayTweet.likedByMe?'liked':''}" onclick="handleLike('${displayTweet.id}')"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="${displayTweet.likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z'}"></path></svg></button>
            </div>
        </div>
    `;
}

function renderDetailComments(tweet) {
    const list = document.getElementById('x-detail-comments-list');
    list.innerHTML = '';
    
    const comments = tweet.comments || [];
    
    comments.forEach(cmt => {
        const div = document.createElement('div');
        div.className = 'x-comment-item';
        div.innerHTML = `
            <img src="${cmt.avatar}" class="x-tweet-avatar" style="width:36px;height:36px;">
            <div class="x-comment-content">
                <div class="x-comment-header">
                    <div><span class="x-comment-name">${cmt.name}</span><span class="x-comment-handle">${cmt.handle}</span></div>
                </div>
                ${cmt.replyToName ? `<div class="x-comment-reply-tag">å›å¤ @${cmt.replyToName}</div>` : ''}
                <div class="x-comment-text">${cmt.content}</div>
            </div>`;
        
        div.onclick = () => {
            const input = document.getElementById('x-detail-input');
            input.value = `å›å¤ @${cmt.name} : `;
            input.focus();
            input.dataset.replyToId = cmt.id;
            input.dataset.replyToName = cmt.name;
        };
        list.appendChild(div);
    });
}

function sendDetailReply() {
    const input = document.getElementById('x-detail-input');
    const content = input.value.trim();
    if (!content || !currentDetailTweetId) return;

    const tweet = xData.tweets.find(t => t.id === currentDetailTweetId);
    if (!tweet) return;

    const replyToId = input.dataset.replyToId;
    const replyToName = input.dataset.replyToName;
    let cleanContent = content;
    if(replyToName && content.startsWith(`å›å¤ @${replyToName} :`)) cleanContent = content.replace(`å›å¤ @${replyToName} :`, '').trim();

    const myComment = {
        id: 'cmt_' + Date.now(), authorId: 'user',
        name: xData.user.name, handle: xData.user.handle, avatar: xData.user.avatar,
        content: cleanContent, timestamp: Date.now(),
        replyToId: replyToId || null, replyToName: replyToName || null
    };

    tweet.comments.push(myComment);
    tweet.stats.replies++;
    saveXData();

    renderDetailComments(tweet);
    input.value = '';
    delete input.dataset.replyToId;
    delete input.dataset.replyToName;
    
    const feed = document.getElementById('x-detail-container');
    feed.scrollTop = feed.scrollHeight;

    // 3. è§¦å‘ AI å›å¤ (æ”¯æŒæ¥¼ä¸­æ¥¼é€»è¾‘)
    triggerDetailAiReply(tweet, myComment);
}

async function triggerDetailAiReply(tweet, userComment) {
    const btn = document.querySelector('.x-detail-send-btn');
    btn.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";

    // åˆ¤æ–­å›å¤è€…èº«ä»½
    let systemPrompt = "";
    let authorName = "";
    
    if (tweet.isNPC && !tweet.isRepost && !tweet.isQuote) {
        // è·¯äººæ¨ï¼šè·¯äººä¹Ÿè¦å›ä½ 
        authorName = tweet.npcName;
        systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”æ¨ç‰¹ä¸Šçš„è·¯äºº "${authorName}"ã€‚
        ä½ å‘äº†æ¨æ–‡ï¼š"${tweet.content}"
        æœ‰äººå›å¤ä½ ï¼š"${userComment.content}"
        è¯·å›å¤ä»–ã€‚è¯­æ°”éšæ„ã€çœŸå®ã€‚ä¸è¦å¸¦å¼•å·ã€‚`;
    } else {
        // è§’è‰²æ¨
        let charId = tweet.authorId;
        if(tweet.isRepost || tweet.isQuote) charId = tweet.sourceTweet.authorId;
        
        const char = contacts.find(c => c.id === charId);
        if(char) {
            authorName = char.name;
            systemPrompt = `ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
            ä½ å‘äº†æ¡æ¨æ–‡ï¼š"${tweet.content}"ã€‚
            ${userComment.replyToName ? `(è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼å›å¤ï¼Œå›å¤ç»™ ${userComment.replyToName})` : ""}
            æœ‰äººè¯„è®ºï¼š"${userComment.content}"ã€‚
            è¯·å›å¤ã€‚`;
        }
    }
    
    if(!systemPrompt) { btn.innerText="å›å¤"; return; }

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼š
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: systemPrompt }]
});
        const data = await res.json();
        const replyText = data.choices[0].message.content;

        // ç¡®å®šå¤´åƒ
        let replyAvatar = "";
        if(tweet.isNPC) replyAvatar = tweet.npcAvatar;
        else {
            const c = contacts.find(c => c.id === tweet.authorId);
            replyAvatar = c ? c.avatar : "";
        }

        const aiReply = {
            id: 'cmt_ai_' + Date.now(),
            name: authorName, handle: "@" + authorName, avatar: replyAvatar,
            content: replyText, timestamp: Date.now(),
            replyToName: userComment.name, replyToId: userComment.id
        };

        tweet.comments.push(aiReply);
        tweet.stats.replies++;
        saveXData();

        if (currentDetailTweetId === tweet.id) {
            renderDetailComments(tweet);
            const feed = document.getElementById('x-detail-container');
            feed.scrollTop = feed.scrollHeight;
        }
    } catch (e) { console.error(e); } 
    finally { btn.innerText = "å›å¤"; }
}

// ----------------------------
// 6. ä¸ªäººä¸»é¡µ & è®¤è¯
// ----------------------------
function openUserProfile() {
    const p = xData.user;
    document.getElementById('x-profile-banner').style.backgroundImage = `url(${p.banner})`;
    document.getElementById('x-profile-avatar').src = p.avatar;
    document.getElementById('x-profile-name').innerText = p.name;
    document.getElementById('x-profile-handle').innerText = p.handle;
    document.getElementById('x-profile-bio').innerText = p.bio || "è¿™ä¸ªäººå¾ˆæ‡’ã€‚";
    document.getElementById('x-profile-following').innerText = p.stats.following;
    document.getElementById('x-profile-followers').innerText = p.stats.followers;
    
    if(p.location) {
        document.getElementById('x-profile-location-box').style.display = 'inline';
        document.getElementById('x-profile-location').innerText = p.location;
    } else document.getElementById('x-profile-location-box').style.display = 'none';

    document.getElementById('x-profile-badge').innerHTML = getBadgeSVG(p.badgeType);
    
    loadUserProfileTweets(); 
    document.getElementById('page-x-profile').classList.add('active');
}

function closeUserProfile() { document.getElementById('page-x-profile').classList.remove('active'); }

function openEditProfile() {
    const p = xData.user;
    document.getElementById('edit-x-banner').value = p.banner || "";
    document.getElementById('edit-x-avatar').value = p.avatar || "";
    document.getElementById('edit-x-name').value = p.name;
    document.getElementById('edit-x-handle').value = p.handle;
    document.getElementById('edit-x-bio').value = p.bio || "";
    document.getElementById('edit-x-location').value = p.location || "";
    document.getElementById('edit-x-following').value = p.stats.following;
    document.getElementById('edit-x-followers').value = p.stats.followers;
    document.getElementById('edit-x-badge-type').value = p.badgeType || "none";
    
    const partnerSelect = document.getElementById('edit-x-partner');
    partnerSelect.innerHTML = '<option value="">-- æ—  --</option>';
    contacts.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.text = c.name;
        if(p.partnerId === c.id) option.selected = true;
        partnerSelect.appendChild(option);
    });

    togglePartnerSelect();
    openModal('modal-x-edit');
}

function saveUserProfile() {
    const p = xData.user;
    p.banner = document.getElementById('edit-x-banner').value;
    p.avatar = document.getElementById('edit-x-avatar').value;
    p.name = document.getElementById('edit-x-name').value;
    p.handle = document.getElementById('edit-x-handle').value;
    p.bio = document.getElementById('edit-x-bio').value;
    p.location = document.getElementById('edit-x-location').value;
    p.stats.following = document.getElementById('edit-x-following').value;
    p.stats.followers = document.getElementById('edit-x-followers').value;
    p.badgeType = document.getElementById('edit-x-badge-type').value;
    p.partnerId = document.getElementById('edit-x-partner').value;

    saveXData();
    closeModal('modal-x-edit');
    openUserProfile(); 
    document.getElementById('x-current-user-avatar').src = p.avatar;
    renderXFeed(); 
}

function togglePartnerSelect() {
    const type = document.getElementById('edit-x-badge-type').value;
    const group = document.getElementById('x-partner-select-group');
    if(type === 'couple' || type === 'married') group.style.display = 'block';
    else {
        group.style.display = 'none';
        document.getElementById('edit-x-partner').value = "";
    }
}

function getBadgeSVG(type) {
    if (!type || type === 'none') return '';
    let path = '', className = '';
    if (type === 'blue') { path = '<path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z"></path>'; className = 'badge-blue'; }
    else if (type === 'gold') { path = '<path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path>'; className = 'badge-gold'; }
    else if (type === 'couple') { path = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>'; className = 'badge-white'; }
    else if (type === 'married') { path = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>'; className = 'badge-white'; }
    else if (type === 'vip') { path = '<path d="M12 2L2 12l10 10 10-10L12 2z"></path>'; className = 'badge-white'; }
    
    return `<svg viewBox="0 0 24 24" class="${className}" style="width:18px; height:18px; margin-left:4px;">${path}</svg>`;
}

function shareToDM(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (!tweet) return;
    
    let targetCharId = null;
    
    if (!tweet.isNPC && tweet.authorId !== 'user') {
        targetCharId = tweet.authorId;
    } else if (tweet.isRepost || tweet.isQuote) {
        if (!tweet.sourceTweet.isNPC && tweet.sourceTweet.authorId !== 'user') {
            targetCharId = tweet.sourceTweet.authorId;
        }
    }

    if (targetCharId) {
        const char = contacts.find(c => c.id === targetCharId);
        if (char) {
            const contextMsg = `[ç³»ç»Ÿæç¤º: ç”¨æˆ·é€šè¿‡ X App åˆ†äº«äº†æ¨æ–‡: "${tweet.isQuote ? tweet.quoteContent : tweet.content}"ã€‚]`;
            activeContactId = char.id;
            navigateTo('page-chat');
            setTimeout(() => {
               document.getElementById('userInput').value = `åˆ†äº«æ¨æ–‡ï¼š${tweet.content.substring(0, 20)}...`;
            }, 300);
        }
    } else {
        alert("åªèƒ½ç§ä¿¡å·²ç»‘å®šçš„è§’è‰²å“¦ï¼ˆNPCæš‚ä¸æ”¯æŒç§ä¿¡ï¼‰");
    }
}

function updateXBadge() {
    const count = xData.notifications.length; 
    const badge = document.getElementById('x-notif-badge');
    if(badge && count > 0) {
        badge.textContent = count;
        badge.style.display = 'block';
    } else if(badge) {
        badge.style.display = 'none';
    }
}
        // ã€æ–°å¢ã€‘è®©è§’è‰²ç»™ç”¨æˆ·æ¨æ–‡è¯„è®º
async function generateCharacterCommentForUser(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if(!tweet) return;

    // éšæœºé€‰ä¸€ä¸ªè§’è‰²æ¥è¯„è®ºä½ 
    if(contacts.length === 0) return;
    const char = contacts[Math.floor(Math.random() * contacts.length)];

    // æ„é€  Prompt
    const prompt = `
    ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}
    
    ä½ çš„ç”¨æˆ· "${xData.user.name}" åˆšåˆšå‘äº†ä¸€æ¡æ¨ç‰¹ï¼š
    "${tweet.content}"
    
    è¯·ä½ åœ¨åº•ä¸‹è¯„è®ºã€‚
    è¦æ±‚ï¼šç¬¦åˆä½ çš„äººè®¾ï¼Œç®€çŸ­ï¼Œä½¿ç”¨ä¸­æ–‡ï¼ŒåƒçœŸå®çš„æ¨ç‰¹å›å¤ã€‚
    `;

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: prompt }]
});
        const data = await res.json();
        const replyText = data.choices[0].message.content;

        // åˆ›å»ºè¯„è®º
        const charComment = {
            id: 'cmt_char_' + Date.now(),
            authorId: char.id, // æ ‡è®°ä¸ºè§’è‰²
            name: char.name, 
            handle: "@" + char.id.substring(0,8),
            avatar: char.avatar,
            content: replyText, 
            timestamp: Date.now()
        };

        // æ’å…¥è¯„è®º
        tweet.comments.push(charComment);
        tweet.stats.replies++;
        saveXData();
        renderXFeed();
        
    } catch(e) { console.error(e); }
}
        // ==========================================
// --- 14. å…±è¯»ç³»ç»Ÿ (Co-Reading) å®Œæ•´ç‰ˆ ---
// ==========================================

// --- A. IndexedDB æ•°æ®åº“å·¥å…· (å­˜å¤§æ–‡ä»¶) ---
const dbName = "AIPhoneDB";
const storeName = "books";
const musicStoreName = "music_files";
const galleryStoreName = "gallery";

function openDB() {
    return new Promise((resolve, reject) => {
        // âœ¨ ä¿®æ”¹ç‚¹ï¼šæŠŠè¿™é‡Œçš„æ•°å­—æ”¹æˆ 10 (æˆ–è€…æ¯”ä½ ä¹‹å‰ç”¨è¿‡çš„ä»»ä½•æ•°å­—éƒ½å¤§)
        const request = indexedDB.open(dbName, 12);

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // 1. ä¹¦ç±å­˜å‚¨åº“
            if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: "id" });
            }
            
            // 2. éŸ³ä¹æ–‡ä»¶å­˜å‚¨åº“
            if (!db.objectStoreNames.contains(musicStoreName)) {
                db.createObjectStore(musicStoreName, { keyPath: "id" });
            }

            // 3. é£è¡Œæ£‹é¢˜åº“ (é˜²æ­¢æŠ¥é”™ï¼Œä¸€å¹¶åŠ ä¸Š)
            if (!db.objectStoreNames.contains("ludo_tasks")) {
                db.createObjectStore("ludo_tasks", { keyPath: "id" });
            }

            if (!db.objectStoreNames.contains(galleryStoreName)) {
                // ç´¢å¼•ï¼šidä¸ºä¸»é”®
                const store = db.createObjectStore(galleryStoreName, { keyPath: "id" });
                // æˆ‘ä»¬å¯ä»¥å»ºç´¢å¼•æ–¹ä¾¿ä»¥åæŒ‰æ—¶é—´æŸ¥ï¼Œè¿™é‡Œæš‚ä¸éœ€è¦
            }
            if (!db.objectStoreNames.contains("cinema_series")) {
                db.createObjectStore("cinema_series", { keyPath: "id" });
            }
            if (!db.objectStoreNames.contains("cinema_episodes")) {
                // ç´¢å¼•ï¼šseriesId ç”¨äºå¿«é€ŸæŸ¥æ‰¾æŸéƒ¨å‰§çš„æ‰€æœ‰é›†
                const epStore = db.createObjectStore("cinema_episodes", { keyPath: "id" });
                epStore.createIndex("seriesId", "seriesId", { unique: false });
            }
        };

        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => {
            console.error("æ•°æ®åº“æ‰“å¼€å¤±è´¥:", event.target.error);
            reject(event.target.error);
        };
    });
}
        // --- å·¥å…·ï¼šæŠŠéŸ³é¢‘æ–‡ä»¶å­˜å…¥ IndexedDB ---
async function saveAudioToDB(id, fileBlob) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(musicStoreName, "readwrite");
        const store = tx.objectStore(musicStoreName);
        // æˆ‘ä»¬å­˜ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å« ID å’Œ æ–‡ä»¶æœ¬ä½“
        const request = store.put({ id: id, blob: fileBlob });
        
        tx.oncomplete = () => resolve();
        tx.onerror = (e) => reject(e.target.error);
    });
}

// --- å·¥å…·ï¼šä» IndexedDB å–å‡ºéŸ³é¢‘æ–‡ä»¶ ---
async function getAudioFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(musicStoreName, "readonly");
        const store = tx.objectStore(musicStoreName);
        const request = store.get(id);
        
        request.onsuccess = () => {
            // å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿”å› blobï¼›æ²¡æ‰¾åˆ°è¿”å› null
            resolve(request.result ? request.result.blob : null);
        };
        request.onerror = (e) => reject(e.target.error);
    });
}

async function saveBookToDB(bookObj) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        store.put(bookObj);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}
        // --- æ–°å¢ï¼šä» IndexedDB åˆ é™¤ä¹¦ç± ---
async function deleteBookFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        const request = store.delete(id); // æ ¹æ® ID åˆ é™¤
        
        tx.oncomplete = () => resolve();
        tx.onerror = (e) => reject(e.target.error);
    });
}

async function getBookFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function getAllBooksFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// --- B. æ•°æ®ç»“æ„ä¸å˜é‡ ---
// LocalStorage å­˜ metadata: { id, title, author, progressIndex, summaries: [] }
// IndexedDB å­˜ fullContent: { id, content, chapters: [] }
let libraryMeta = []; 
let currentBookData = null; 
let currentBookMeta = null; 

// åŠ è½½ä¹¦æ¶
function loadLibrary() {
    const saved = localStorage.getItem('ai_phone_library');
    if(saved) libraryMeta = JSON.parse(saved);
    renderBookshelf();
}
        // --- æ–°å¢ï¼šåˆ é™¤æ¨¡å¼çŠ¶æ€ ---
let isBookDeleteMode = false;

function toggleBookDeleteMode() {
    isBookDeleteMode = !isBookDeleteMode;
    const btn = document.getElementById('btn-manage-books');
    
    if (isBookDeleteMode) {
        btn.innerText = "å®Œæˆ"; // å˜æˆå®ŒæˆæŒ‰é’®
        btn.style.color = "#ff3b30"; // å˜çº¢
    } else {
        btn.innerText = "ğŸ—‘ï¸"; // å˜å›åƒåœ¾æ¡¶
        btn.style.color = "#007AFF"; // å˜å›è“è‰²
    }
    
    // é‡æ–°æ¸²æŸ“ä¹¦æ¶ä»¥åº”ç”¨æ ·å¼
    renderBookshelf();
}

async function confirmDeleteBook(bookId, bookTitle) {
    if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ä¹¦ç±ã€Š${bookTitle}ã€‹å—ï¼Ÿ\nè¿™å°†é‡Šæ”¾å­˜å‚¨ç©ºé—´ä¸”æ— æ³•æ¢å¤ã€‚`)) {
        try {
            // 1. ä» IndexedDB åˆ é™¤å¤§æ–‡ä»¶
            await deleteBookFromDB(bookId);
            
            // 2. ä» LocalStorage (metadata) åˆ é™¤
            libraryMeta = libraryMeta.filter(b => b.id !== bookId);
            localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
            
            // 3. åˆ·æ–°ç•Œé¢
            renderBookshelf();
            // alert("åˆ é™¤æˆåŠŸ"); // å¯é€‰
        } catch (e) {
            alert("åˆ é™¤å¤±è´¥: " + e.message);
        }
    }
}

// ä¿®æ”¹åçš„æ¸²æŸ“ä¹¦æ¶å‡½æ•°
function renderBookshelf() {
    const container = document.getElementById('bookshelf-container');
    container.innerHTML = '';
    
    if (libraryMeta.length === 0) {
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; margin-top:50px;">ä¹¦æ¶æ˜¯ç©ºçš„<br>ç‚¹å³ä¸Šè§’ + å·å¯¼å…¥</div>';
        return;
    }

    libraryMeta.forEach(book => {
        const div = document.createElement('div');
        div.className = 'app-icon-container';
        div.style.width = '100%';
        div.style.position = 'relative'; // ä¸ºäº†å®šä½åˆ é™¤è§’æ ‡
        
        // éšæœºå°é¢è‰²
        const hue = parseInt(book.id) % 360;
        
        // æ ¹æ®æ˜¯å¦æ˜¯åˆ é™¤æ¨¡å¼ï¼Œå†³å®šç‚¹å‡»è¡Œä¸ºå’Œæ ·å¼
        let actionAttr = '';
        let badgeHtml = '';
        let shakeClass = '';

        if (isBookDeleteMode) {
            // åˆ é™¤æ¨¡å¼ï¼šç‚¹å‡»è§¦å‘åˆ é™¤ï¼Œå°é¢æŠ–åŠ¨ï¼Œæ˜¾ç¤ºçº¢è§’æ ‡
            actionAttr = `onclick="confirmDeleteBook('${book.id}', '${book.title}')"`;
            badgeHtml = `<div class="book-delete-badge">Ã—</div>`;
            shakeClass = 'shake';
        } else {
            // æ­£å¸¸æ¨¡å¼ï¼šç‚¹å‡»æ‰“å¼€ä¹¦
            actionAttr = `onclick="openBook('${book.id}')"`;
        }

        div.innerHTML = `
            ${badgeHtml}
            <div class="book-cover ${shakeClass}" ${actionAttr} style="background: hsl(${hue}, 70%, 90%); color: hsl(${hue}, 60%, 30%);">
                <div style="font-size:24px; margin-bottom:5px;">ğŸ“–</div>
                <div class="book-title">${book.title}</div>
                <div class="book-author" style="margin-top:auto;">è¯»è‡³: ${book.progressIndex + 1}ç« </div>
            </div>
        `;
        container.appendChild(div);
    });
}

// --- C. å¯¼å…¥ä¹¦ç± ---
async function handleBookImport(event) {
    const file = event.target.files[0];
    if(!file) return;

    const btn = event.target.previousElementSibling;
    const oldText = btn.innerHTML;
    btn.innerHTML = "â³";

    const text = await file.text();
    const bookId = Date.now().toString();
    
    // æ™ºèƒ½åˆ†ç«  (æ­£åˆ™åŒ¹é…)
    const chapterRegex = /(^\s*ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ0-9]+[ç« å›å·].*|^\s*Chapter\s+[0-9]+.*)/gm;
    let chapters = [];
    
    const matches = [...text.matchAll(chapterRegex)];
    
    if (matches.length > 0) {
        for (let i = 0; i < matches.length; i++) {
            const currentMatch = matches[i];
            const nextMatch = matches[i+1];
            
            const title = currentMatch[0].trim();
            const startIndex = currentMatch.index;
            const endIndex = nextMatch ? nextMatch.index : text.length;
            
            const body = text.substring(startIndex, endIndex);
            chapters.push({ title, body });
        }
        if (matches[0].index > 0) {
            chapters.unshift({ title: "åºè¨€/å‰è¨€", body: text.substring(0, matches[0].index) });
        }
    } else {
        // å…œåº•ï¼šæŒ‰å­—æ•°åˆ‡åˆ†
        const chunkSize = 3000;
        for (let i = 0; i < text.length; i += chunkSize) {
            chapters.push({ 
                title: `ç¬¬ ${Math.floor(i/chunkSize)+1} éƒ¨åˆ†`, 
                body: text.substring(i, i + chunkSize) 
            });
        }
    }

    // å­˜å…¥ DB (å¤§æ–‡ä»¶)
    await saveBookToDB({ id: bookId, chapters: chapters });

    // å­˜å…¥ Local (ç´¢å¼•)
    const newBook = {
        id: bookId,
        title: file.name.replace('.txt',''),
        progressIndex: 0,
        summaries: []
    };
    libraryMeta.push(newBook);
    localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
    
    renderBookshelf();
    btn.innerHTML = oldText;
    alert(`å¯¼å…¥æˆåŠŸï¼å…±è¯†åˆ«å‡º ${chapters.length} ä¸ªç« èŠ‚ã€‚`);
}

// --- D. é˜…è¯»é€»è¾‘ ---
async function openBook(id) {
    if (!activeContactId) {
        alert("è¯·å…ˆåœ¨ã€ä¿¡æ¯ã€‘åˆ—è¡¨é‡Œé€‰æ‹©ä¸€ä¸ªè§’è‰²ä½œä¸ºä¼´è¯»å¯¹è±¡ï¼");
        return;
    }
    
    currentBookMeta = libraryMeta.find(b => b.id === id);
    currentBookData = await getBookFromDB(id); 
    
    if(!currentBookData || !currentBookMeta) return alert("ä¹¦ç±æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°å¯¼å…¥");

    navigateTo('page-reader');
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === activeContactId);
    if(char) {
        document.getElementById('reader-ai-avatar').src = char.avatar;
        document.getElementById('reader-chat-partner').innerText = char.name;
    }

    renderReaderPage();
    checkAiNovelMode();
}

// æ¸²æŸ“é˜…è¯»å™¨é¡µé¢ (ä¿®æ”¹ç‰ˆï¼šå¢åŠ è¿›åº¦æ¢å¤ + æ»šåŠ¨ç›‘å¬)
function renderReaderPage() {
    const idx = currentBookMeta.progressIndex;
    const chapter = currentBookData.chapters[idx];
    
    // 1. è®¾ç½®æ ‡é¢˜å’Œè¿›åº¦æ–‡å­—
    document.getElementById('reader-title').innerText = chapter.title;
    document.getElementById('reader-progress').innerText = `${idx + 1}/${currentBookData.chapters.length}`;
    
    // 2. å¡«å……å†…å®¹
    const contentBox = document.getElementById('reader-content');
    contentBox.innerText = chapter.body; 
    
    // --- âœ¨ æ–°å¢æ ¸å¿ƒé€»è¾‘ï¼šæ¢å¤ä¸Šæ¬¡é˜…è¯»ä½ç½® ---
    if (currentBookMeta.scrollRatio && currentBookMeta.scrollRatio > 0) {
        //ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç­‰å¾…æ–‡å­—æ¸²æŸ“å‡ºé«˜åº¦ï¼Œå¦åˆ™ scrollHeight å¯èƒ½ä¸å‡†
        setTimeout(() => {
            const targetScroll = contentBox.scrollHeight * currentBookMeta.scrollRatio;
            contentBox.scrollTop = targetScroll;
        }, 50);
    } else {
        contentBox.scrollTop = 0; // å¦‚æœæ²¡è®°å½•ï¼Œå°±å›åˆ°é¡¶éƒ¨
    }

    // --- âœ¨ æ–°å¢æ ¸å¿ƒé€»è¾‘ï¼šå®æ—¶ç›‘å¬æ»šåŠ¨å¹¶ä¿å­˜ ---
    // ä½¿ç”¨é˜²æŠ– (Throttle) æœºåˆ¶ï¼Œæ¯éš” 1 ç§’ä¿å­˜ä¸€æ¬¡ï¼Œé¿å…ç–¯ç‹‚å†™å…¥ LocalStorage å¡é¡¿
    let saveTimeout;
    contentBox.onscroll = function() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            // è®¡ç®—å½“å‰æ»šåŠ¨çš„ç™¾åˆ†æ¯” (0.0 - 1.0)
            const ratio = contentBox.scrollTop / (contentBox.scrollHeight - contentBox.clientHeight);
            
            // å­˜å…¥å†…å­˜å¯¹è±¡
            currentBookMeta.scrollRatio = ratio;
            
            // å­˜å…¥ç¡¬ç›˜ (LocalStorage)
            saveBookProgress();
            // console.log("è¿›åº¦å·²ä¿å­˜:", (ratio*100).toFixed(2) + "%"); // è°ƒè¯•ç”¨
        }, 1000); // åœæ­¢æ»šåŠ¨ 1ç§’ åä¿å­˜
    };
}

function exitReader() {
    currentBookData = null; // é‡Šæ”¾å†…å­˜
    navigateTo('page-bookshelf');
}

// === âœ¨ æ ¸å¿ƒäº¤äº’é€»è¾‘ âœ¨ ===

// 1. ç¿»é¡µ (åªæ»šå±ï¼Œä¸è§¦å‘æ€»ç»“)
function scrollReader(direction) {
    const el = document.getElementById('reader-content');
    // æ»šåŠ¨é«˜åº¦ = å±å¹•é«˜åº¦çš„ 80% (ä¿ç•™ä¸€ç‚¹ä¸Šä¸‹æ–‡)
    const scrollAmount = el.clientHeight * 0.8; 
    
    el.scrollBy({
        top: scrollAmount * direction,
        behavior: 'smooth'
    });
}

// 2. ç¿»ç«  (è§¦å‘æ€»ç»“é€»è¾‘)
async function nextChapter() {
    if(currentBookMeta.progressIndex >= currentBookData.chapters.length - 1) {
        return alert("å·²ç»æ˜¯æœ€åä¸€ç« äº†");
    }

    // --- æ™ºèƒ½æ£€æµ‹ï¼šæ˜¯å¦éœ€è¦æ€»ç»“ ---
    // é€»è¾‘ï¼šå¦‚æœå½“å‰ç« èŠ‚è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡æ€»ç»“ (summaries[å½“å‰ç´¢å¼•] ä¸ºç©º)
    const currentIdx = currentBookMeta.progressIndex;
    const hasSummary = currentBookMeta.summaries && currentBookMeta.summaries[currentIdx];
    
    if (!hasSummary) {
        const chapterTitle = currentBookData.chapters[currentIdx].title;
        const char = contacts.find(c => c.id === activeContactId);
        
        // å¼¹çª—è¯¢é—®
        if(confirm(`"${chapterTitle}" è¯»å®Œäº†ã€‚\n\næ˜¯å¦è®© ${char ? char.name : 'AI'} æ€»ç»“æœ¬ç« å‰§æƒ…å¹¶å­˜å…¥è®°å¿†ï¼Ÿ\n(è¿™æœ‰åŠ©äºä¸‹ä¸€ç« çš„è¿è´¯æ€§)`)) {
            await generateChapterSummary();
        }
    }

    // åªæœ‰åœ¨ç”¨æˆ·å¤„ç†å®Œæ€»ç»“(æˆ–å–æ¶ˆ)åï¼Œæ‰çœŸæ­£è·³è½¬
    currentBookMeta.progressIndex++;
    currentBookMeta.scrollRatio = 0;
    saveBookProgress();
    renderReaderPage();
}

function prevChapter() {
    if(currentBookMeta.progressIndex <= 0) return;
    currentBookMeta.progressIndex--;
    currentBookMeta.scrollRatio = 0;
    saveBookProgress();
    renderReaderPage();
}

function saveBookProgress() {
    localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
}

// --- E. AI æ€»ç»“ä¸äº’åŠ¨ (ä¿®æ­£ç‰ˆï¼šæ”¯æŒå…¨æ–‡æ€»ç»“) ---

// ç”Ÿæˆå½“å‰ç« èŠ‚çš„æ€»ç»“
async function generateChapterSummary() {
    const char = contacts.find(c => c.id === activeContactId);
    if(!char || !globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

    const idx = currentBookMeta.progressIndex;
    const content = currentBookData.chapters[idx].body;
    
    // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå–æ¶ˆâ€œæå¤´å»å°¾â€ã€‚
    // ç°åœ¨çš„æ¨¡å‹é€šå¸¸æ”¯æŒ 16k contextï¼Œè¶³å¤Ÿè¯»å®Œä¸€ç« ï¼ˆé€šå¸¸3000-5000å­—ï¼‰ã€‚
    // è¿™é‡Œè®¾ç½®ä¸€ä¸ª 20000 å­—çš„å®‰å…¨ä¸Šé™ï¼Œé˜²æ­¢æç«¯æƒ…å†µå¡æ­»ã€‚
    let textToSend = content;
    if (content.length >20000) {
        textToSend = content.substring(0,20000) + "\n...(æœ¬ç« å¤ªé•¿ï¼Œæˆªæ–­)...";
        console.warn("ç« èŠ‚è¿‡é•¿ï¼Œå·²æˆªæ–­å‘é€");
    }

    const btn = document.querySelector('.reader-btn-chap:last-child');
    // å¦‚æœæ‰¾ä¸åˆ°æŒ‰é’®ï¼ˆæ¯”å¦‚æ˜¯å¼¹çª—è§¦å‘çš„ï¼‰ï¼Œå°±ä¸æ”¹æ–‡å­—äº†ï¼Œé¿å…æŠ¥é”™
    let oldText = "";
    if(btn) {
        oldText = btn.innerText;
        btn.innerText = "æ­£åœ¨é˜…è¯»..."; // æç¤ºç”¨æˆ· AI æ­£åœ¨è¯»å…¨æ–‡
    }

    try {
        const prompt = `è¯·é˜…è¯»ä»¥ä¸‹å°è¯´ç« èŠ‚ï¼Œå¹¶æ€»ç»“æ ¸å¿ƒå‰§æƒ…ã€‚
        è¦æ±‚ï¼š
        1. æ§åˆ¶åœ¨ 300 å­—ä»¥å†…ã€‚
        2. é£æ ¼ä¸ºè®°å™æ–‡ï¼Œç±»ä¼¼â€œå‰§æƒ…æ¢—æ¦‚â€æˆ–â€œå‰æƒ…æè¦â€ï¼Œå®¢è§‚é™ˆè¿°å‘ç”Ÿäº†ä»€ä¹ˆã€‚
        3. é‡ç‚¹è®°å½•ï¼šæ–°å‡ºåœºçš„äººç‰©ã€å…³é”®è½¬æŠ˜ã€ä¸»è§’è·å¾—çš„ä¿¡æ¯ã€‚
        4. è¿™æ®µæ€»ç»“å°†ç”¨äºè®© AI è®°ä½å‰§æƒ…ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ç« ä¿æŒè¿è´¯ã€‚
        
        ã€ç« èŠ‚æ­£æ–‡ã€‘ï¼š
        ${textToSend}`;

        // æ³¨æ„ï¼šè¿™é‡Œ model ç”¨çš„æ˜¯ä½ è®¾ç½®é‡Œçš„å…¨å±€ modelã€‚
        // å»ºè®®åœ¨è®¾ç½®é‡Œå¡«æ”¯æŒé•¿æ–‡æœ¬çš„æ¨¡å‹ï¼Œå¦‚ gpt-3.5-turbo-16k æˆ– gpt-4o
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model, // ç¡®ä¿è¿™ä¸ªæ¨¡å‹èƒ½åƒå¾—ä¸‹å‡ åƒå­—
    messages: [{ role: "user", content: prompt }]
});
        
        if (!res.ok) {
            const errData = await res.json();
            // å¦‚æœæŠ¥é”™åŒ…å« context_length_exceededï¼Œè¯´æ˜æ¨¡å‹å¤ªæ—§äº†
            if (JSON.stringify(errData).includes("context_length_exceeded")) {
                throw new Error("æ¨¡å‹ä¸Šä¸‹æ–‡ä¸è¶³ï¼Œè¯·åœ¨è®¾ç½®é‡Œæ›´æ¢æ”¯æŒé•¿æ–‡æœ¬çš„æ¨¡å‹ï¼ˆå¦‚ gpt-3.5-turbo-16kï¼‰");
            }
            throw new Error(res.statusText);
        }

        const data = await res.json();
        const summary = data.choices[0].message.content;

        // åˆå§‹åŒ– summaries æ•°ç»„
        if(!currentBookMeta.summaries) currentBookMeta.summaries = [];
        
        // å­˜å…¥æ€»ç»“
        currentBookMeta.summaries[idx] = summary;
        saveBookProgress();
        
        // === âœ¨ æ–°å¢åŠŸèƒ½ï¼šåŒæ­¥å…±è¯»æŠ¥å‘Šåˆ°ä¸»èŠå¤©æ¡† âœ¨ ===
        const chapterTitle = currentBookData.chapters[idx].title;
        const bookTitle = currentBookMeta.title;

        // æ„é€ æŠ¥å‘Šæ–‡æ¡ˆ
        const readingReport = `
ğŸ“–ã€å…±è¯»æŠ¥å‘Šã€‘
------------------
ğŸ“š ä¹¦ç±ï¼šã€Š${bookTitle}ã€‹
ğŸ“‘ ç« èŠ‚ï¼š${chapterTitle}
ğŸ“ å‰§æƒ…å›é¡¾ï¼š
${summary}
------------------
(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšè¯»å®Œè¿™ä¸€ç« ã€‚è¯·${char.name}æ ¹æ®è¿™ä¸ªå‰§æƒ…å›é¡¾ï¼Œå¯ä»¥åœ¨è¿™ä¸ªèŠå¤©æ¡†é‡Œå’Œç”¨æˆ·èŠèŠè¯»åæ„Ÿï¼Œæˆ–è€…è¯„ä»·ä¸€ä¸‹å‰§æƒ…å‘å±•ã€‚)
`.trim();

        // å°†æŠ¥å‘Šä»¥â€œç”¨æˆ·æ¶ˆæ¯â€çš„å½¢å¼æ’å…¥ä¸»èŠå¤©è®°å½•
        // è¿™æ · AI å°±ä¼šä»¥ä¸ºæ˜¯ä½ å‘ç»™å®ƒçš„ï¼Œå®ƒå°±ä¼šæ ¹æ®è¿™æ®µè¯è¿›è¡Œå›å¤ï¼Œä»è€Œå®ç°â€œåŒæ­¥ä¿¡æ¯ç‚¹â€
        char.messages.push({
            role: 'user', // è¿™é‡Œç”¨ userï¼Œå‡è£…æ˜¯ç”¨æˆ·åˆ†äº«çš„æŠ¥å‘Š
            content: readingReport,
            timestamp: Date.now()
        });
        
        // ä¿å­˜èŠå¤©æ•°æ®
        saveData(); 

        alert(`âœ… æ€»ç»“å®Œæ¯•ï¼\nå…±è¯»æŠ¥å‘Šå·²å‘é€ç»™ ${char.name}ï¼Œé€€å›ä¸»ç•Œé¢å³å¯çœ‹åˆ° Ta çš„è¯»åæ„Ÿã€‚`);

    } catch(e) {
        alert("æ€»ç»“å¤±è´¥: " + e.message);
    } finally {
        if(btn) btn.innerText = oldText;
    }
}
        // æ‰‹åŠ¨è§¦å‘åŒæ­¥æŠ¥å‘Š (çº¯å‡€è®°å½•ç‰ˆï¼šæ— é—²èŠ)
async function manualShareReport() {
    const char = contacts.find(c => c.id === activeContactId);
    if (!char) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼´è¯»è§’è‰²");
    if (!currentBookData || !currentBookMeta) return;

    const idx = currentBookMeta.progressIndex;
    const fullBody = currentBookData.chapters[idx].body;
    const chapterTitle = currentBookData.chapters[idx].title;
    
    // 1. è®¡ç®—é˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”
    const el = document.getElementById('reader-content');
    let ratio = (el.scrollTop + el.clientHeight) / el.scrollHeight;
    if (ratio > 1) ratio = 1; 
    const percentage = Math.floor(ratio * 100);

    // 2. æˆªå–â€œå·²è¯»å†…å®¹â€
    const endIndex = Math.floor(fullBody.length * ratio);
    let readText = fullBody.substring(0, endIndex);

    // å®‰å…¨æˆªæ–­
    if (readText.length > 15000) {
        readText = readText.substring(0, 5000) + 
                   "\n\n......(ä¸­é—´ç•¥è¿‡)......\n\n" + 
                   readText.substring(readText.length - 8000);
    }

    if (!confirm(`å½“å‰è¿›åº¦ ${percentage}%ã€‚\nè¦ç”Ÿæˆé˜…è¯»å­˜æ¡£å—ï¼Ÿ`)) return;

    const btn = document.querySelector('button[onclick*="manualShareReport"]');
    const oldBtnText = btn.innerText; 
    btn.innerText = "â³"; 

    try {
        // --- 3. Prompt ä¿®æ”¹ï¼šå¼ºåˆ¶å®¢è§‚æ€»ç»“ ---
        const prompt = `ä½ æ­£åœ¨ååŠ©ç”¨æˆ·æ•´ç†é˜…è¯»ç¬”è®°ã€‚
        ä¹¦åï¼šã€Š${currentBookMeta.title}ã€‹
        ç« èŠ‚ï¼š${chapterTitle}
        
        ç”¨æˆ·è¯»åˆ°äº†æœ¬ç« çš„ ${percentage}% å¤„ã€‚
        ã€ç”¨æˆ·å·²è¯»å†…å®¹ã€‘ï¼š
        "${readText}"
        
        ã€ä»»åŠ¡ã€‘ï¼š
        è¯·å®¢è§‚ã€ç®€ç»ƒåœ°æ¦‚æ‹¬ç”¨æˆ·ç›®å‰è¯»åˆ°çš„å‰§æƒ…å†…å®¹ã€‚
        è¦æ±‚ï¼š
        1. åªæ¦‚æ‹¬å‘ç”Ÿäº†ä»€ä¹ˆäº‹ã€‚
        2. **ä¸è¦**å‘è¡¨è¯»åæ„Ÿï¼Œ**ä¸è¦**å’Œç”¨æˆ·æ‰“æ‹›å‘¼ï¼Œ**ä¸è¦**é—²èŠã€‚
        3. å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ã€‚
        `;

        // âœ… ä¿®å¤ç‰ˆï¼šç§»é™¤ method/headers/bodyï¼Œåªä¼ çº¯æ•°æ®
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: prompt }]
});

        const data = await res.json();
        const aiSummary = data.choices[0].message.content;

        // 4. æ„é€ çº¯å‡€æŠ¥å‘Š (å»æ‰äº†åº•éƒ¨çš„èŠå¤©å¼•å¯¼)
        const report = `
ğŸ“‚ã€é˜…è¯»è¿›åº¦å­˜æ¡£ã€‘
------------------
ğŸ“– ã€Š${currentBookMeta.title}ã€‹
ğŸ“‘ ${chapterTitle}
ğŸ“ è¿›åº¦ï¼š${percentage}%
ğŸ“ å‰§æƒ…æ‘˜è¦ï¼š
${aiSummary}
------------------
(ç³»ç»Ÿæç¤ºï¼šè¯·${char.name}æ ¹æ®ç”¨æˆ·åœä¸‹çš„ä½ç½®ï¼Œå’Œç”¨æˆ·èŠèŠç›®å‰çš„å‰§æƒ…æ„Ÿå—ã€‚)
`.trim();

        // å­˜å…¥èŠå¤©è®°å½• (ä½œä¸º user æ¶ˆæ¯ï¼Œä»£è¡¨æ˜¯ç”¨æˆ·ä¾§ç”Ÿæˆçš„è®°å½•)
        char.messages.push({
            role: 'user', 
            content: report,
            timestamp: Date.now()
        });
        
        saveData();
        alert("âœ… å­˜æ¡£æˆåŠŸï¼å·²ä¿å­˜åˆ°èŠå¤©è®°å½•ä¸­ã€‚");

    } catch(e) {
        alert("åŒæ­¥å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldBtnText; 
    }
}

// æ‰“å¼€é˜…è¯»å™¨èŠå¤©çª—å£ï¼ˆå¸¦å†å²è®°å½•åŠ è½½ï¼‰
function openReaderChat() {
    const historyBox = document.getElementById('reader-chat-history');
    historyBox.innerHTML = ''; // å…ˆæ¸…ç©ºç•Œé¢

    // 1. æ£€æŸ¥å¹¶åˆå§‹åŒ–è¿™æœ¬ä¹¦çš„èŠå¤©è®°å½•æ•°ç»„
    if (!currentBookMeta.chatLogs) {
        currentBookMeta.chatLogs = [];
    }

    // 2. æ¸²æŸ“å†å²è®°å½•
    const char = contacts.find(c => c.id === activeContactId);
    // å¦‚æœè¿˜æ²¡é€‰äººï¼Œå°±ç”¨ä¸ªé»˜è®¤å¤´åƒ
    const avatar = char ? char.avatar : ''; 

    currentBookMeta.chatLogs.forEach(log => {
        if (log.charId && log.charId !== activeContactId) return;
        if (log.role === 'user') {
            historyBox.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; color:white; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span></div>`;
        } else {
            historyBox.innerHTML += `<div style="text-align:left; margin:10px 0;"><img src="${avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;"> <span style="background:#f2f2f7; color:black; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span></div>`;
        }
    });

    // 3. æ»šåˆ°åº•éƒ¨
    setTimeout(() => {
        historyBox.scrollTop = historyBox.scrollHeight;
    }, 100);

    openModal('modal-reader-chat');
}

// å‘é€é˜…è¯»å™¨æ¶ˆæ¯ (å¸¦ä¸Šä¸‹æ–‡è®°å¿†ç‰ˆ)
async function sendReaderMsg() {
    const input = document.getElementById('readerChatInput');
    const txt = input.value.trim();
    if(!txt) return;

    const char = contacts.find(c => c.id === activeContactId);
    if(!char) return;

    // --- 1. UI æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ ---
    const historyBox = document.getElementById('reader-chat-history');
    historyBox.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; color:white; padding:8px 12px; border-radius:15px; display:inline-block;">${txt}</span></div>`;
    input.value = '';
    historyBox.scrollTop = historyBox.scrollHeight;

    // --- 2. ç«‹å³ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ (ä½œä¸ºä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†) ---
    // è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼šå…ˆæŠŠè¿™å¥è¯å­˜è¿›å†å²ï¼Œç­‰ä¸‹å‘ç»™AIçš„æ—¶å€™ï¼Œè¿™æ¡å°±æ˜¯â€œæœ€æ–°çš„å†å²â€
    if (!currentBookMeta.chatLogs) currentBookMeta.chatLogs = [];
    currentBookMeta.chatLogs.push({ role: 'user', content: txt, time: Date.now() });
    saveBookProgress(); 

    // --- 3. å‡†å¤‡ç¯å¢ƒä¸Šä¸‹æ–‡ (System Prompt) ---
    // åŒ…å«ï¼šäººè®¾ + é•¿æœŸè®°å¿†(æ€»ç»“) + å½“å‰é˜…è¯»ç‰‡æ®µ
    const idx = currentBookMeta.progressIndex;
    const fullBody = currentBookData.chapters[idx].body;
    const contentBox = document.getElementById('reader-content');
    
    // è®¡ç®—å½“å‰çœ‹åˆ°å“ªä¸€æ®µæ–‡å­—
    let scrollPercent = 0;
    if (contentBox.scrollHeight > contentBox.clientHeight) {
        scrollPercent = contentBox.scrollTop / (contentBox.scrollHeight - contentBox.clientHeight);
    }
    const charIndex = Math.floor(fullBody.length * scrollPercent);
    const start = Math.max(0, charIndex - 1200);
    const end = Math.min(fullBody.length, charIndex + 500);
    const currentContext = fullBody.substring(start, end);

    const recentSummaries = (currentBookMeta.summaries || [])
        .slice(Math.max(0, idx-6), idx)
        .map((s, i) => `[ç¬¬${idx-6+i+1}ç« æ€»ç»“]: ${s}`)
        .join("\n");

    const systemInstruction = `ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·è¯»ä¸€æœ¬ä¹¦ã€‚
    ä½ æ‰®æ¼”è§’è‰²ï¼š${char.name}ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
    
    ã€ä¹¦æœ¬ä¸Šä¸‹æ–‡ã€‘ï¼š
    - ä¹‹å‰çš„å‰§æƒ…æ€»ç»“ï¼š${recentSummaries || "æ— "}
    - ç”¨æˆ·çœ¼å‰æ­£åœ¨çœ‹çš„ç‰‡æ®µï¼š"...${currentContext}..."
    
    ã€ä»»åŠ¡ã€‘ï¼š
    è¯·åƒä¸€ä¸ªååœ¨ç”¨æˆ·èº«è¾¹çš„æœ‹å‹/æ‹äººä¸€æ ·ï¼Œé’ˆå¯¹ç”¨æˆ·çš„å‘è¨€è¿›è¡Œå›å¤ã€‚
    ä½ å¯ä»¥è¯„è®ºå‰§æƒ…ã€å›ç­”ç–‘é—®æˆ–è€…é—²èŠï¼Œä½†ä¸è¦å‰§é€åé¢è¿˜æ²¡è¯»åˆ°çš„å†…å®¹ã€‚
    `;

    // --- 4. âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šæå–å†å²å¯¹è¯ä¸Šä¸‹æ–‡ âœ¨ ---
    // å–æœ€è¿‘çš„ 15 æ¡è®°å½• (é¿å… token çˆ†ç‚¸ï¼ŒåŒæ—¶ä¿ç•™è¶³å¤Ÿè®°å¿†)
    // è¿™é‡Œçš„ chatLogs å·²ç»åŒ…å«äº†åˆšæ‰ç”¨æˆ·å‘çš„é‚£ä¸€å¥
    const contextHistory = currentBookMeta.chatLogs.slice(-15).map(log => {
        return {
            role: log.role, 
            content: log.content
        };
    });

    // ç»„åˆæœ€ç»ˆå‘é€ç»™ API çš„æ¶ˆæ¯æ•°ç»„
    // ç»“æ„ï¼š[ç³»ç»Ÿè®¾å®š(ç¯å¢ƒ), ...å†å²å¯¹è¯(å«æœ€æ–°ä¸€å¥)]
    const apiMessages = [
        { role: "system", content: systemInstruction },
        ...contextHistory
    ];

    const btn = document.querySelector('.input-toolbar .btn-send');
    const oldBtnText = btn.innerText;
    btn.innerText = "â³";

    try {
       // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: apiMessages // ä½¿ç”¨åŒ…å«å†å²çš„æ•°ç»„
});
        const data = await res.json();
        const reply = data.choices[0].message.content;

        // --- 5. UI æ˜¾ç¤º AI å›å¤ ---
        historyBox.innerHTML += `<div style="text-align:left; margin:10px 0;"><img src="${char.avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;"> <span style="background:#f2f2f7; color:black; padding:8px 12px; border-radius:15px; display:inline-block;">${reply}</span></div>`;
        historyBox.scrollTop = historyBox.scrollHeight;

        // --- 6. ä¿å­˜ AI å›å¤ ---
        currentBookMeta.chatLogs.push({ role: 'assistant', content: reply, time: Date.now() });
        saveBookProgress(); 

    } catch(e) {
        historyBox.innerHTML += `<div style="color:red; font-size:12px;">Error: ${e.message}</div>`;
        // å¦‚æœå‡ºé”™ï¼ŒæŠŠåˆšæ‰ç”¨æˆ·é‚£æ¡åˆ æ‰ï¼Œé¿å…ä¸‹æ¬¡é‡è¯•æ—¶é€»è¾‘æ··ä¹±(å¯é€‰)
        currentBookMeta.chatLogs.pop();
        saveBookProgress();
    } finally {
        btn.innerText = oldBtnText;
    }
}

// --- F. V2 å¤‡ä»½/æ¢å¤ (å¯¼å‡ºä¹¦æœ¬å†…å®¹) ---
async function exportDataV2() {
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨æ‰“åŒ…...";
    
    try {
        // ä» IndexedDB æ‹‰å–æ‰€æœ‰ä¹¦
        const allBooks = await getAllBooksFromDB();
        
        const backupPayload = {
            version: 2,
            globalConfig: globalConfig,
            contacts: contacts,
            themeConfig: themeConfig,
            libraryMeta: libraryMeta,
            schedule: mySchedule,
            xData: xData,
            bookContents: allBooks,
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢ä¸‹é¢è¿™ä¸€è¡Œï¼šæŠŠæ­Œå•ä¹Ÿå¡è¿›å»ï¼ ğŸ‘‡ğŸ‘‡ğŸ‘‡
            playlist: musicPlaylist
        };

        const blob = new Blob([JSON.stringify(backupPayload)], {type:'application/json'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'ai_phone_full_backup_v2.json';
        a.click();
    } catch(e) {
        alert("å¤‡ä»½å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldText;
    }
}

async function importDataV2(e) {
    const f = e.target.files[0]; 
    if(!f) return;
    
    const r = new FileReader();
    r.onload = async ev => {
        try {
            const d = JSON.parse(ev.target.result);
            
            if(d.globalConfig) {
                globalConfig = d.globalConfig;
                localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
            }
            if(d.contacts) {
                contacts = d.contacts;
                localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
            }
            if(d.themeConfig) {
                themeConfig = d.themeConfig;
                localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
            }
            if(d.libraryMeta) {
                libraryMeta = d.libraryMeta;
                localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
            }
            if(d.playlist) {
                musicPlaylist = d.playlist;
                localStorage.setItem('ai_phone_playlist', JSON.stringify(musicPlaylist));
            }
            
            // æ¢å¤ IndexedDB
            if(d.bookContents && Array.isArray(d.bookContents)) {
                for (const book of d.bookContents) {
                    await saveBookToDB(book);
                }
            }

            alert("æ•°æ®æ¢å¤æˆåŠŸï¼");
            location.reload();
            
        } catch(e) {
            alert("æ¢å¤å¤±è´¥: " + e.message);
        }
    }; 
    r.readAsText(f);
    e.target.value = ''; 
}

// å¯åŠ¨åŠ è½½
loadLibrary();
        // --- G. æŸ¥çœ‹é˜…è¯»ç¬”è®° (æ”¯æŒè·³è½¬ç‰ˆ) ---
function openSummaryList() {
    const listContainer = document.getElementById('summary-list-content');
    listContainer.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®

    if (!currentBookMeta || !currentBookData) return;

    const summaries = currentBookMeta.summaries || [];
    const chapters = currentBookData.chapters || [];
    
    // éå†æ‰€æœ‰ç« èŠ‚
    chapters.forEach((chap, index) => {
        const summaryText = summaries[index];
        
        // æ ‡è®°å½“å‰æ­£åœ¨è¯»çš„ç« èŠ‚
        const isCurrent = (index === currentBookMeta.progressIndex);
        const statusBadge = isCurrent ? '<span style="color:#007AFF; font-size:12px; font-weight:bold;">(å½“å‰ä½ç½®)</span>' : '';
        const activeClass = isCurrent ? 'border: 2px solid #007AFF;' : ''; // ç»™å½“å‰ç« åŠ ä¸ªè“æ¡†

        // æ„å»ºå¡ç‰‡
        const div = document.createElement('div');
        div.className = 'summary-card';
        // âœ¨âœ¨âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ ç‚¹å‡»è·³è½¬äº‹ä»¶ âœ¨âœ¨âœ¨
        div.setAttribute('onclick', `jumpToChapterFromSummary(${index})`);
        div.style.cssText = `cursor: pointer; ${activeClass}`; 

        const contentHtml = summaryText 
            ? `<div class="sum-text">${summaryText}</div>`
            : `<div class="sum-empty">æš‚æ— æ€»ç»“ (ç‚¹å‡»è·³è½¬åå¯ç”Ÿæˆ)</div>`;

        div.innerHTML = `
            <div class="sum-chap-title">
                <span>${chap.title}</span>
                ${statusBadge}
            </div>
            ${contentHtml}
            <div style="text-align:right; font-size:10px; color:#ccc; margin-top:5px;">ç‚¹å‡»è·³è½¬ ></div>
        `;
        
        listContainer.appendChild(div);
    });

    if (listContainer.children.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">è¿˜æ²¡æœ‰ç« èŠ‚<br>å¿«å»ç”Ÿæˆç¬¬ä¸€ç« å§</div>';
    }

    // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚çš„ä½ç½®
    setTimeout(() => {
        const currentCard = listContainer.children[currentBookMeta.progressIndex];
        if(currentCard) currentCard.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 200);

    openModal('modal-book-summary');
}

// âœ¨âœ¨âœ¨ æ–°å¢ï¼šè·³è½¬è¾…åŠ©å‡½æ•° âœ¨âœ¨âœ¨
function jumpToChapterFromSummary(index) {
    if (index < 0 || index >= currentBookData.chapters.length) return;
    
    // æ›´æ–°è¿›åº¦
    currentBookMeta.progressIndex = index;
    currentBookMeta.scrollRatio = 0; // å›åˆ°é¡¶éƒ¨
    saveBookProgress();
    
    // åˆ·æ–°é¡µé¢
    renderReaderPage();
    
    // å…³é—­å¼¹çª—
    closeModal('modal-book-summary');
    
    // æç¤º
    // if(navigator.vibrate) navigator.vibrate(50); // éœ‡åŠ¨åé¦ˆå¯é€‰
}
        // ==========================================
    // --- ğŸµ éŸ³ä¹æ’­æ”¾å™¨æ ¸å¿ƒé€»è¾‘ (Music Player) ---
    // ==========================================

    let audioPlayer = new Audio();
    let musicState = {
        isPlaying: false,
        title: "",
        artist: "",
        lyrics: [], // æ ¼å¼: [{time: 12.5, text: "æ­Œè¯"}]
        currentLine: -1,
        cover: ""
    };

    // 1. åˆå§‹åŒ–
    audioPlayer.ontimeupdate = updateMusicProgress;
    audioPlayer.onended = () => {
        // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        if (currentPlayIndex < musicPlaylist.length - 1) {
            switchSong(currentPlayIndex + 1, true);
        } else {
            // åˆ—è¡¨æ’­å®Œäº†ï¼Œä»å¤´å¼€å§‹æˆ–è€…åœæ­¢
            // è¿™é‡Œé€‰æ‹©å¾ªç¯æ’­æ”¾åˆ—è¡¨
            switchSong(0, true);
        }
    };

    // 2. ç•Œé¢åˆ‡æ¢ (å±•å¼€/æ”¶èµ·) - ç»ˆæé»‘å±ä¿®å¤ç‰ˆ
    function toggleMusicPlayer(show) {
        const player = document.getElementById('music-player');
        
        if (show) {
            // A. æ‰“å¼€æµç¨‹
            // 1. å…ˆæŠŠå…ƒç´ æ˜¾ç¤ºå‡ºæ¥ (display: flex)ï¼Œå¦åˆ™åŠ¨ç”»æ²¡æ³•æ’­
            player.style.display = 'flex';
            
            // 2. å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ (è¿™è¡Œçœ‹èµ·æ¥æ²¡ç”¨ï¼Œä½†å¯¹è§¦å‘åŠ¨ç”»è‡³å…³é‡è¦)
            void player.offsetWidth; 

            // 3. æ›´æ–°å¤´åƒ (åŸé€»è¾‘)
            const char = getActiveChar();
            if(char) {
                document.getElementById('m-ai-avatar').src = char.avatar;
                document.getElementById('m-user-avatar').src = char.userAvatar;
            }

            // 4. æ·»åŠ  class å¼€å§‹åŠ¨ç”» (æ»‘ä¸Šæ¥)
            player.classList.add('show');
            
        } else {
            // B. å…³é—­æµç¨‹
            // 1. ç§»é™¤ class å¼€å§‹åŠ¨ç”» (æ»‘ä¸‹å»)
            player.classList.remove('show');
            
            // 2. å…³é”®ä¿®å¤ï¼šç­‰å¾… 300ms (åŠ¨ç”»æ—¶é—´) åï¼Œç›´æ¥æŠŠ display è®¾ä¸º none
            // è¿™æ ·å®ƒå°±å½»åº•ä»æ¸²æŸ“æ ‘ä¸Šæ¶ˆå¤±äº†ï¼Œç»å¯¹ä¸å¯èƒ½å†æŒ¡ä½å±å¹•
            setTimeout(() => {
                // åªæœ‰å½“å¹¶æ²¡æœ‰å†æ¬¡æ‰“å¼€æ—¶ï¼Œæ‰éšè— (é˜²æ­¢ç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¼€å…³)
                if (!player.classList.contains('show')) {
                    player.style.display = 'none';
                }
            }, 300); // è¿™é‡Œçš„ 300 å¯¹åº” CSS é‡Œçš„ transition: 0.3s
        }
    }

    // 3. è§†å›¾åˆ‡æ¢ (é»‘èƒ¶ <-> æ­Œè¯)
    function switchMusicView() {
        const vinyl = document.getElementById('vinyl-view');
        const lyrics = document.getElementById('lyrics-view');
        
        if (lyrics.style.display === 'block') {
            lyrics.style.display = 'none';
            vinyl.style.display = 'flex';
        } else {
            vinyl.style.display = 'none';
            lyrics.style.display = 'block';
            // åˆ‡æ¢åˆ°æ­Œè¯æ—¶ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰å¥
            scrollToCurrentLyric();
        }
    }

    // ==========================================
    // --- ğŸµ æ’­æ”¾åˆ—è¡¨é€»è¾‘ (Playlist Logic) ---
    // ==========================================

    let musicPlaylist = []; // å­˜å‚¨æ‰€æœ‰æ­Œæ›²å¯¹è±¡
    let currentPlayIndex = -1; // å½“å‰æ’­æ”¾ç¬¬å‡ é¦–

    // é¡µé¢åŠ è½½æ—¶æ¢å¤åˆ—è¡¨
    window.addEventListener('load', () => {
        loadPlaylistData();
    });

    function loadPlaylistData() {
        const saved = localStorage.getItem('ai_phone_playlist');
        if (saved) {
            musicPlaylist = JSON.parse(saved);
            renderPlaylistUI();
            // å¦‚æœæœ‰æ­Œï¼ŒåŠ è½½ç¬¬ä¸€é¦–ä½†ä¸æ’­æ”¾ï¼Œå‡†å¤‡å¥½çŠ¶æ€
            if (musicPlaylist.length > 0) {
                 switchSong(0, false); // å¯é€‰ï¼šè‡ªåŠ¨åŠ è½½ç¬¬ä¸€é¦–
            }
        }
    }

    function savePlaylistData() {
        // æ³¨æ„ï¼šå¦‚æœæ˜¯â€œæœ¬åœ°æ–‡ä»¶(blob)â€ï¼Œåˆ·æ–°åä¼šå¤±æ•ˆã€‚
        // è¿™é‡Œæˆ‘ä»¬åªå­˜ metadataã€‚å¦‚æœæ˜¯Blobé“¾æ¥ï¼Œä¸‹æ¬¡è¿›æ¥å¯èƒ½æ’­ä¸äº†ï¼Œè¿™æ˜¯æµè§ˆå™¨å®‰å…¨é™åˆ¶ã€‚
        // ä½†æ—¢ç„¶ä½ ç”¨äº†ç›´é“¾ï¼Œé‚£å°±å¯ä»¥å®Œç¾ä¿å­˜ï¼
        localStorage.setItem('ai_phone_playlist', JSON.stringify(musicPlaylist));
    }

    // ==========================================
// --- âœ¨ æ­Œæ›²ç¼–è¾‘é€»è¾‘ (New) ---
// ==========================================

// 1. æ‰“å¼€â€œæ–°å¢â€çª—å£ (ç‚¹å‡»é¡¶éƒ¨çš„ + å·æ—¶è°ƒç”¨)
// âš ï¸ è¯·å»ä¿®æ”¹ HTML é‡Œå³ä¸Šè§’é‚£ä¸ª + å·æŒ‰é’®çš„ onclickï¼Œæ”¹æˆ onclick="openAddSongModal()"
// æˆ–è€…ç›´æ¥æœåŸæ¥çš„ onclick="openModal('modal-import-music')" æ”¹æ‰
function openAddSongModal() {
    // é‡ç½®ä¸ºæ–°å¢æ¨¡å¼
    document.getElementById('edit-song-index').value = "-1"; 
    document.querySelector('#modal-import-music .modal-header').innerText = "ä¸€èµ·å¬ (å¯¼å…¥æ­Œæ›²)";
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('imp-title').value = '';
    document.getElementById('imp-artist').value = '';
    document.getElementById('imp-cover').value = '';
    document.getElementById('imp-lrc').value = '';
    document.getElementById('imp-file').value = ''; 
    document.getElementById('imp-url').value = '';

    openModal('modal-import-music');
}

// 2. æ‰“å¼€â€œç¼–è¾‘â€çª—å£ (ç‚¹å‡»ä¸‰é“æ æ—¶è°ƒç”¨)
function openEditSongModal(index) {
    const song = musicPlaylist[index];
    if (!song) return;

    // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
    document.getElementById('edit-song-index').value = index;
    document.querySelector('#modal-import-music .modal-header').innerText = "ç¼–è¾‘æ­Œæ›²ä¿¡æ¯";

    // å›å¡«æ•°æ®
    document.getElementById('imp-title').value = song.title || "";
    document.getElementById('imp-artist').value = song.artist || "";
    document.getElementById('imp-cover').value = song.cover || "";
    document.getElementById('imp-lrc').value = song.lrcRaw || "";
    
    // æ–‡ä»¶/URL ç¨å¾®ç‰¹æ®Šä¸€ç‚¹ï¼Œå¦‚æœæ˜¯ URL å°±å›å¡«ï¼Œå¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶å°±ç•™ç©ºï¼ˆæœ¬åœ°æ–‡ä»¶æ— æ³•é€šè¿‡JSå›å¡«åˆ° input type=fileï¼‰
    if (!song.isLocal && song.src && !song.src.startsWith('db:')) {
        document.getElementById('imp-url').value = song.src;
    } else {
        document.getElementById('imp-url').value = ""; // æœ¬åœ°æ–‡ä»¶ç•™ç©ºï¼Œæš—ç¤ºâ€œä¸æ”¹åŠ¨åˆ™ä¿æŒåŸæ ·â€
    }
    
    document.getElementById('imp-file').value = ''; // æ–‡ä»¶æ¡†å¿…é¡»æ¸…ç©º

    openModal('modal-import-music');
}

// 3. ç¡®è®¤ä¿å­˜ (åˆå¹¶äº†æ–°å¢å’Œç¼–è¾‘é€»è¾‘)
async function confirmImportMusic() {
    const editIndex = parseInt(document.getElementById('edit-song-index').value); // è·å–æ¨¡å¼
    
    // è·å–è¾“å…¥å€¼
    const titleInput = document.getElementById('imp-title');
    const artistInput = document.getElementById('imp-artist');
    const coverInput = document.getElementById('imp-cover');
    const lrcInput = document.getElementById('imp-lrc');
    const fileInput = document.getElementById('imp-file');
    const urlInput = document.getElementById('imp-url');

    const title = titleInput.value.trim() || "æœªçŸ¥æ­Œæ›²";
    const artist = artistInput.value.trim() || "æœªçŸ¥æ­Œæ‰‹";
    let coverUrl = coverInput.value.trim();
    if (!coverUrl) coverUrl = "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=500";
    
    const lrcText = lrcInput.value;
    
    // æŒ‰é’®å˜èº« loading
    const confirmBtn = document.querySelector('#modal-import-music .modal-btn:last-child');
    const originalBtnText = confirmBtn.innerText;
    confirmBtn.innerText = "æ­£åœ¨ä¿å­˜...";

    try {
        let finalSrc = "";
        let isLocalFile = false;
        let hasNewAudioSource = false; // æ ‡è®°æ˜¯å¦æ›´æ–°äº†éŸ³é¢‘æº

        // --- éŸ³é¢‘æºå¤„ç†é€»è¾‘ ---
        if (fileInput.files && fileInput.files[0]) {
            // A. ç”¨æˆ·é€‰äº†æ–°æ–‡ä»¶ -> å­˜å…¥ DB
            const file = fileInput.files[0];
            const songId = (editIndex >= 0) ? musicPlaylist[editIndex].id : Date.now().toString(); // ç¼–è¾‘æ—¶æ²¿ç”¨æ—§IDï¼Œæ–°å¢ç”¨æ–°ID
            await saveAudioToDB(songId, file); 
            isLocalFile = true;
            finalSrc = "db:" + songId;
            hasNewAudioSource = true;
        } else if (urlInput.value.trim()) {
            // B. ç”¨æˆ·å¡«äº†æ–°é“¾æ¥ -> ä½¿ç”¨é“¾æ¥
            finalSrc = urlInput.value.trim();
            isLocalFile = false;
            hasNewAudioSource = true;
        } else {
            // C. ç”¨æˆ·å•¥éƒ½æ²¡å¡«
            if (editIndex >= 0) {
                // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼šæ²¡å¡«ä»£è¡¨â€œä¿ç•™åŸéŸ³é¢‘â€
                finalSrc = musicPlaylist[editIndex].src;
                isLocalFile = musicPlaylist[editIndex].isLocal;
                hasNewAudioSource = false; 
            } else {
                // æ–°å¢æ¨¡å¼ä¸‹ï¼šå¿…é¡»å¡«ä¸€ä¸ª
                alert("è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ (æ¨è) æˆ–è¾“å…¥é“¾æ¥");
                confirmBtn.innerText = originalBtnText;
                return;
            }
        }

        // --- æ„å»º/æ›´æ–°å¯¹è±¡ ---
        const songData = {
            id: (editIndex >= 0) ? musicPlaylist[editIndex].id : Date.now().toString(),
            title: title,
            artist: artist,
            cover: coverUrl,
            src: finalSrc,
            lrcRaw: lrcText,
            isLocal: isLocalFile
        };

        if (editIndex >= 0) {
            // === ç¼–è¾‘æ¨¡å¼ ===
            musicPlaylist[editIndex] = songData;
            
            // å¦‚æœç¼–è¾‘çš„æ˜¯å½“å‰æ­£åœ¨æ’­æ”¾çš„æ­Œ
            if (editIndex === currentPlayIndex) {
                // æ›´æ–°æ’­æ”¾å™¨ç•Œé¢æ–‡å­—
                musicState.title = title;
                musicState.artist = artist;
                musicState.cover = coverUrl;
                musicState.lyrics = parseLRC(lrcText);
                document.getElementById('m-title').innerText = title;
                document.getElementById('m-artist').innerText = artist;
                document.getElementById('m-cover').src = coverUrl;
                document.getElementById('float-cover').src = coverUrl;
                document.getElementById('music-bg').style.backgroundImage = `url('${coverUrl}')`;
                renderLyrics();

                // åªæœ‰å½“éŸ³é¢‘æºæ”¹å˜äº†ï¼Œæ‰é‡æ–°åŠ è½½éŸ³é¢‘æµ (é¿å…åªæ˜¯æ”¹ä¸ªæ­Œåå¯¼è‡´éŸ³ä¹ä¸­æ–­)
                if (hasNewAudioSource) {
                    await switchSong(editIndex, true); // true = è‡ªåŠ¨é‡æ–°æ’­æ”¾
                }
            }
        } else {
            // === æ–°å¢æ¨¡å¼ ===
            musicPlaylist.push(songData);
            // è‡ªåŠ¨æ’­æ”¾æ–°æ­Œ
            await switchSong(musicPlaylist.length - 1, true);
        }

        savePlaylistData();
        renderPlaylistUI();
        closeModal('modal-import-music');

    } catch (err) {
        console.error(err);
        alert("ä¿å­˜å¤±è´¥ï¼š" + err.message);
    } finally {
        confirmBtn.innerText = originalBtnText;
    }
}
    // åˆ‡æ¢æ­Œæ›²æ ¸å¿ƒå‡½æ•°
    async function switchSong(index, autoPlay = true) {
    if (index < 0 || index >= musicPlaylist.length) return;
    
    currentPlayIndex = index;
    const song = musicPlaylist[index];

    // 1. æ›´æ–°æ–‡æœ¬ä¿¡æ¯
    musicState.title = song.title;
    musicState.artist = song.artist;
    musicState.cover = song.cover;
    musicState.lyrics = parseLRC(song.lrcRaw || ""); 
    renderLyrics();

    // 2. æ›´æ–°ç•Œé¢
    document.getElementById('m-title').innerText = song.title;
    document.getElementById('m-artist').innerText = song.artist;
    document.getElementById('m-cover').src = song.cover;
    document.getElementById('float-cover').src = song.cover;
    document.getElementById('music-bg').style.backgroundImage = `url('${song.cover}')`;

    // 3. æ ¸å¿ƒä¿®æ”¹ï¼šå†³å®šæ’­æ”¾åœ°å€
    let playUrl = song.src;

    // å¦‚æœæ ‡è®°ä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œæˆ–è€… src æ˜¯ db: å¼€å¤´çš„
    if (song.isLocal || (typeof song.src === 'string' && song.src.startsWith('db:'))) {
        try {
            // ä»æ•°æ®åº“å–å‡º Blob
            const blob = await getAudioFromDB(song.id);
            if (blob) {
                // ç°åœºç”Ÿæˆä¸€ä¸ªæ–°é²œçš„ã€æµè§ˆå™¨è®¤å¯çš„ä¸´æ—¶é“¾æ¥
                playUrl = URL.createObjectURL(blob);
            } else {
                alert(`æ­Œæ›²æ–‡ä»¶ä¸¢å¤±: ${song.title}ã€‚è¯·å°è¯•é‡æ–°å¯¼å…¥ã€‚`);
                return;
            }
        } catch (e) {
            console.error("è¯»å–éŸ³é¢‘å‡ºé”™", e);
            return;
        }
    }

    // 4. è®¾ç½®ç»™æ’­æ”¾å™¨
    audioPlayer.src = playUrl;

    // 5. æ›´æ–°åˆ—è¡¨é«˜äº®
    renderPlaylistUI();

    // 6. æ’­æ”¾
    if (autoPlay) {
        //ç¨å¾®ç»™ä¸€ç‚¹ç‚¹ç¼“å†²æ—¶é—´
        setTimeout(() => {
            audioPlayer.play().then(() => {
                musicState.isPlaying = true;
                updatePlayerUI();
            }).catch(e => {
                console.error("æ’­æ”¾è¢«æ‹¦æˆªæˆ–å‡ºé”™", e);
                musicState.isPlaying = false;
                updatePlayerUI();
            });
        }, 100);
    }
}

    // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨ç•Œé¢ (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨æ˜¾ç¤º/éšè—æ‚¬æµ®çƒ)
    function renderPlaylistUI() {
    const container = document.getElementById('playlist-content');
    const countSpan = document.getElementById('pl-count');
    container.innerHTML = '';
    countSpan.innerText = musicPlaylist.length;

    const floatBtn = document.getElementById('music-float-btn');
    if (musicPlaylist.length > 0) {
        floatBtn.style.display = 'flex';
    } else {
        floatBtn.style.display = 'none';
    }

    musicPlaylist.forEach((song, idx) => {
        const isActive = (idx === currentPlayIndex);
        
        const div = document.createElement('div');
        div.className = `playlist-item ${isActive ? 'active' : ''}`;
        
        // ç‚¹å‡»è¡Œæ’­æ”¾ï¼Œä½†è¦æ’é™¤åé¢çš„æŒ‰é’®åŒº
        div.onclick = (e) => {
            // å¦‚æœç‚¹çš„æ˜¯æŒ‰é’®ï¼ˆç¼–è¾‘æˆ–åˆ é™¤ï¼‰ï¼Œä¸è§¦å‘æ’­æ”¾
            if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
            switchSong(idx, true);
        };

        // âœ¨ ä¿®æ”¹ç‚¹ï¼šå¢åŠ äº†â€œä¸‰é“æ â€ç¼–è¾‘æŒ‰é’®ï¼Œå¹¶è°ƒæ•´äº†å¸ƒå±€
        div.innerHTML = `
            <div class="pl-idx">${idx + 1}</div>
            <div class="pl-playing-icon"></div>
            <div class="pl-info">
                <div class="song-name">${song.title}</div>
                <div class="song-artist">${song.artist}</div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®åŒº -->
            <div style="display:flex; gap:10px; align-items:center;">
                <!-- ç¼–è¾‘æŒ‰é’® (ä¸‰é“æ ) -->
                <button onclick="openEditSongModal(${idx})" style="background:none; border:none; color:#007AFF; font-size:20px; cursor:pointer; padding:5px;">â‰¡</button>
                
                <!-- åˆ é™¤æŒ‰é’® -->
                <button class="btn-del-song" onclick="deleteSong(${idx})" style="background:none; border:none; color:#666; font-size:20px; cursor:pointer; padding:5px;">Ã—</button>
            </div>
        `;
        container.appendChild(div);
    });
}

    // åˆ é™¤æ­Œæ›²
    function deleteSong(index) {
        if(confirm("ç¡®å®šè¦æŠŠè¿™é¦–æ­Œç§»å‡ºåˆ—è¡¨å—ï¼Ÿ")) {
            // å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨æ”¾çš„ï¼Œå…ˆæš‚åœ
            if (index === currentPlayIndex) {
                audioPlayer.pause();
                musicState.isPlaying = false;
                updatePlayerUI();
            }
            // ä¿®æ­£å½“å‰æ’­æ”¾ç´¢å¼•
            if (index < currentPlayIndex) {
                currentPlayIndex--;
            }

            musicPlaylist.splice(index, 1);
            savePlaylistData();
            renderPlaylistUI();
        }
    }

    // æ‰“å¼€/å…³é—­ æ’­æ”¾åˆ—è¡¨
    function togglePlaylist(show) {
        const drawer = document.getElementById('playlist-drawer');
        if(show) drawer.classList.add('show');
        else drawer.classList.remove('show');
    }

    // 5. LRC è§£æå™¨ (æ­£åˆ™é­”æ³•)
    function parseLRC(lrc) {
        const lines = lrc.split('\n');
        const result = [];
        const timeExp = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
        
        lines.forEach(line => {
            const match = timeExp.exec(line);
            if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                const ms = parseFloat("0." + match[3]);
                const time = minutes * 60 + seconds + ms;
                const text = line.replace(timeExp, '').trim();
                if(text) result.push({ time, text });
            }
        });
        return result;
    }

    // 6. æ¸²æŸ“æ­Œè¯ DOM
    function renderLyrics() {
        const container = document.getElementById('lyrics-view');
        container.innerHTML = ''; // æ¸…ç©º
        if(musicState.lyrics.length === 0) {
            container.innerHTML = '<div class="lrc-line" style="margin-top:50px;">çº¯éŸ³ä¹ / æ— æ­Œè¯</div>';
            return;
        }
        
        // é¡¶éƒ¨ç•™ç™½
        container.innerHTML += '<div style="height: 40vh;"></div>';
        
        musicState.lyrics.forEach((line, index) => {
            const div = document.createElement('div');
            div.className = 'lrc-line';
            div.innerText = line.text;
            div.dataset.index = index;
            div.onclick = () => {
                // ç‚¹å‡»æ­Œè¯è·³è½¬è¿›åº¦
                audioPlayer.currentTime = line.time;
            };
            container.appendChild(div);
        });
        
        // åº•éƒ¨ç•™ç™½
        container.innerHTML += '<div style="height: 40vh;"></div>';
    }

    // 7. æ’­æ”¾æ§åˆ¶
    function togglePlayMusic() {
        if (audioPlayer.paused) {
            audioPlayer.play();
            musicState.isPlaying = true;
        } else {
            audioPlayer.pause();
            musicState.isPlaying = false;
        }
        updatePlayerUI();
    }

    function updatePlayerUI() {
        const btn = document.getElementById('btn-play-pause');
        const vinyl = document.getElementById('vinyl-view');
        const floatBtn = document.getElementById('music-float-btn');
        
        if (musicState.isPlaying) {
            btn.innerText = "â¸";
            vinyl.classList.add('playing');
            floatBtn.classList.add('playing');
        } else {
            btn.innerText = "â–¶";
            vinyl.classList.remove('playing');
            floatBtn.classList.remove('playing');
        }
    }

    // 8. è¿›åº¦ä¸æ­Œè¯åŒæ­¥ (æ¯ç§’æ‰§è¡Œå¤šæ¬¡)
    function updateMusicProgress() {
        const curr = audioPlayer.currentTime;
        const total = audioPlayer.duration || 0;

        // æ›´æ–°è¿›åº¦æ¡
        document.getElementById('curr-time').innerText = formatTime(curr);
        document.getElementById('total-time').innerText = formatTime(total);
        document.getElementById('prog-fill').style.width = (curr / total * 100) + "%";

        // æ›´æ–°æ­Œè¯é«˜äº®
        if (musicState.lyrics.length > 0) {
            let activeIndex = -1;
            for (let i = 0; i < musicState.lyrics.length; i++) {
                if (curr >= musicState.lyrics[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if (activeIndex !== musicState.currentLine) {
                musicState.currentLine = activeIndex;
                highlightLyric(activeIndex);
            }
        }
    }

    function highlightLyric(index) {
        if(index === -1) return;
        const lines = document.querySelectorAll('.lrc-line');
        lines.forEach(l => l.classList.remove('highlight'));
        
        const activeLine = document.querySelector(`.lrc-line[data-index="${index}"]`);
        if (activeLine) {
            activeLine.classList.add('highlight');
            // è‡ªåŠ¨æ»šåŠ¨ (åªæœ‰åœ¨æ­Œè¯ç•Œé¢æ˜¾ç¤ºæ—¶)
            const container = document.getElementById('lyrics-view');
            if(container.style.display === 'block') {
                activeLine.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }
    }

    function scrollToCurrentLyric() {
        const index = musicState.currentLine;
        if(index !== -1) {
             const activeLine = document.querySelector(`.lrc-line[data-index="${index}"]`);
             if(activeLine) activeLine.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }

    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const sec = Math.floor(s % 60).toString().padStart(2, '0');
        return `${m}:${sec}`;
    }

    // ==========================================
    // --- ğŸ§  AI æ„ŸçŸ¥æ¥å£ (é‡è¦!) ---
    // ==========================================
    
    // è¿™ä¸ªå‡½æ•°ä¼šç”Ÿæˆä¸€æ®µ promptï¼Œæ’å…¥åˆ°ä½ èŠå¤©å‘é€çš„ system prompt é‡Œ
    function getMusicContext() {
        if (!musicState.isPlaying && audioPlayer.paused) return "";

        const curr = audioPlayer.currentTime;
        let lyricText = "çº¯éŸ³ä¹/é—´å¥ä¸­";
        
        // æ‰¾å½“å‰è¿™ä¸€å¥å’Œä¸‹ä¸€å¥ï¼Œè®©AIæ›´æœ‰å‰ç»æ€§
        if (musicState.currentLine !== -1 && musicState.lyrics[musicState.currentLine]) {
            lyricText = `"${musicState.lyrics[musicState.currentLine].text}"`;
        }

        return `
        [å®æ—¶çŠ¶æ€ï¼šä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œ]
        æ­Œæ›²ä¿¡æ¯ï¼šã€Š${musicState.title}ã€‹ - ${musicState.artist}
        æ’­æ”¾è¿›åº¦ï¼š${formatTime(curr)}
        å½“å‰æ­£åœ¨å”±çš„æ­Œè¯ï¼š${lyricText}
        ã€æŒ‡ä»¤ã€‘ï¼šå¦‚æœç”¨æˆ·çš„å‘è¨€ä¸æ­Œè¯ã€æ—‹å¾‹æˆ–å¬æ­Œæ°›å›´æœ‰å…³ï¼Œè¯·ç»“åˆä¸Šè¿°æ­Œè¯å†…å®¹è¿›è¡Œå›å¤ã€‚ä¾‹å¦‚è¯„è®ºæ­Œè¯å†™å¾—å¥½ï¼Œæˆ–è€…æ—‹å¾‹å¾ˆåŠ¨äººã€‚å¦‚æœç”¨æˆ·åœ¨èŠåˆ«çš„ï¼Œå°±å¿½ç•¥å¬æ­ŒçŠ¶æ€ã€‚
        `;
    }
        // ==========================================
// --- 17. è®°è´¦æœ¬ (Wallet) é€»è¾‘æ¨¡å— ---
// ==========================================

let walletData = {
    budget: 0,       // æœˆé¢„ç®—
    transactions: [] // è´¦å•è®°å½• {id, amount, cate, desc, time}
};

// 1. åˆå§‹åŒ–
function initWalletPage() {
    loadWalletData();
    renderWalletUI();
}

function loadWalletData() {
    const saved = localStorage.getItem('ai_phone_wallet');
    if(saved) walletData = JSON.parse(saved);
}

function saveWalletData() {
    localStorage.setItem('ai_phone_wallet', JSON.stringify(walletData));
}

// 2. æ¸²æŸ“ UI
function renderWalletUI() {
    const listCon = document.getElementById('wallet-list-container');
    
    // è®¡ç®—æ€»æ”¯å‡º
    let totalExpense = 0;
    // è¿‡æ»¤å‡ºæœ¬æœˆçš„è´¦å• (ç®€åŒ–ç‰ˆï¼Œæš‚ä¸å¤„ç†è·¨æœˆï¼Œå‡è®¾åªè®°å½“æœˆ)
    // å¦‚æœè¦åšä¸¥æ ¼çš„æœˆä»½ç­›é€‰ï¼Œå¯ä»¥åŠ  Date åˆ¤æ–­
    walletData.transactions.forEach(t => {
        totalExpense += parseFloat(t.amount);
    });

    const remain = walletData.budget - totalExpense;
    
    // æ›´æ–°å¡ç‰‡
    document.getElementById('wallet-budget-display').innerText = walletData.budget.toFixed(2);
    document.getElementById('wallet-expense-display').innerText = totalExpense.toFixed(2);
    document.getElementById('wallet-balance').innerText = "Â¥ " + remain.toFixed(2);

    // è¿›åº¦æ¡
    let percent = 0;
    if(walletData.budget > 0) percent = (totalExpense / walletData.budget) * 100;
    if(percent > 100) percent = 100;
    document.getElementById('wallet-progress').style.width = percent + "%";
    
    // è­¦å‘ŠçŠ¶æ€
    const warn = document.getElementById('wallet-warning');
    if (remain < 0) {
        warn.style.display = 'block';
        warn.innerText = "âš ï¸ ä¸¥é‡è¶…æ”¯ï¼";
        document.querySelector('.wallet-card-summary').style.background = "linear-gradient(135deg, #ff3b30, #d70015)";
    } else if (remain < walletData.budget * 0.2 && walletData.budget > 0) {
        warn.style.display = 'block';
        warn.innerText = "âš ï¸ é¢„ç®—ä¸è¶³ 20%";
        document.querySelector('.wallet-card-summary').style.background = "linear-gradient(135deg, #ff9500, #ff5e3a)";
    } else {
        warn.style.display = 'none';
        document.querySelector('.wallet-card-summary').style.background = "linear-gradient(135deg, #34c759, #248a3d)";
    }

    // æ¸²æŸ“åˆ—è¡¨
    listCon.innerHTML = '';
    const sorted = [...walletData.transactions].reverse(); // æœ€æ–°çš„åœ¨å‰é¢

    if (sorted.length === 0) {
        listCon.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">æœ¬æœˆæš‚æ— æ”¯å‡º</div>`;
    } else {
        sorted.forEach(t => {
            const date = new Date(t.time);
            const timeStr = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
            
            // ç®€å•å›¾æ ‡æ˜ å°„
            let icon = "ğŸ’¸";
            if(t.cate.includes("é¤é¥®")) icon = "ğŸ”";
            if(t.cate.includes("è´­ç‰©")) icon = "ğŸ›ï¸";
            if(t.cate.includes("äº¤é€š")) icon = "ğŸš•";
            if(t.cate.includes("å¨±ä¹")) icon = "ğŸ®";
            if(t.cate.includes("å±…ä½")) icon = "ğŸ ";

            const div = document.createElement('div');
            div.className = 'ios-list'; // å€Ÿç”¨ä¸€ä¸‹listæ ·å¼å®¹å™¨
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <div class="bill-item">
                    <div class="bill-icon">${icon}</div>
                    <div class="bill-info">
                        <div class="bill-title">${t.cate} ${t.desc ? '- '+t.desc : ''}</div>
                        <div class="bill-time">${timeStr}</div>
                    </div>
                    <div class="bill-amount">- ${parseFloat(t.amount).toFixed(2)}</div>
                    <div class="btn-del-bill" onclick="deleteTransaction(${t.id})">Ã—</div>
                </div>
            `;
            listCon.appendChild(div);
        });
    }
}

// 3. è®°ä¸€ç¬”
async function addTransaction() {
    const amtInput = document.getElementById('bill-amount');
    const cateInput = document.getElementById('bill-cate');
    const descInput = document.getElementById('bill-desc');
    
    const amount = parseFloat(amtInput.value);
    const cate = cateInput.value;
    const desc = descInput.value.trim();

    if (!amount || amount <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");

    const newTrans = {
        id: Date.now(),
        amount: amount,
        cate: cate,
        desc: desc,
        time: Date.now()
    };

    walletData.transactions.push(newTrans);
    saveWalletData();
    
    // æ¸…ç©ºè¾“å…¥
    amtInput.value = '';
    descInput.value = '';
    
    // åˆ·æ–°ç•Œé¢
    renderWalletUI();

    // âœ¨âœ¨âœ¨ æ ¸å¿ƒï¼šåŒæ­¥ç»™ AI âœ¨âœ¨âœ¨
    await shareExpenseToAI(newTrans);
}

function deleteTransaction(id) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è´¦å•å—ï¼Ÿ")) {
        walletData.transactions = walletData.transactions.filter(t => t.id !== id);
        saveWalletData();
        renderWalletUI();
    }
}

// 4. è®¾ç½®é¢„ç®—
function openBudgetModal() {
    document.getElementById('input-budget-setting').value = walletData.budget || "";
    openModal('modal-budget');
}

function saveBudgetSetting() {
    const val = parseFloat(document.getElementById('input-budget-setting').value);
    if(val >= 0) {
        walletData.budget = val;
        saveWalletData();
        renderWalletUI();
        closeModal('modal-budget');
    }
}

// ==========================================
// --- ğŸ§  AI è´¢åŠ¡æ„ŸçŸ¥æ¨¡å— ---
// ==========================================

// 1. è®°è´¦åç«‹åˆ»è§¦å‘ AI è¯„ä»·
async function shareExpenseToAI(trans) {
    const char = contacts.find(c => c.id === activeContactId);
    if (!char) {
        alert("è´¦å•å·²è®°ï¼Œä½†æ²¡é€‰èŠå¤©å¯¹è±¡ï¼Œæ‰€ä»¥ AI ä¸ä¼šè¯„ä»·å“¦ã€‚");
        return;
    }

    // è®¡ç®—å½“å‰å‰©ä½™æƒ…å†µ
    let totalExpense = 0;
    walletData.transactions.forEach(t => totalExpense += parseFloat(t.amount));
    const remain = walletData.budget - totalExpense;
    const isOverBudget = remain < 0;

    // æ„é€ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå‡è£…æ˜¯ç”¨æˆ·æ‰‹æœºç³»ç»Ÿå‘å‡ºçš„é€šçŸ¥ï¼‰
    const sysReport = `
ğŸ’°ã€è®°è´¦æé†’ã€‘
------------------
ç”¨æˆ·åˆšåˆšè®°äº†ä¸€ç¬”è´¦ï¼š
ğŸ’¸ é‡‘é¢ï¼š-${trans.amount} å…ƒ
ğŸ·ï¸ åˆ†ç±»ï¼š${trans.cate}
ğŸ“ å¤‡æ³¨ï¼š${trans.desc || "æ— "}
ğŸ“Š æœ¬æœˆå‰©ä½™é¢„ç®—ï¼š${remain.toFixed(2)} å…ƒ
------------------
(ç³»ç»Ÿæç¤ºï¼šè¯·${char.name}æ ¹æ®è¿™ç¬”æ¶ˆè´¹å’Œå‰©ä½™é¢„ç®—ï¼Œå¯¹ç”¨æˆ·çš„æ¶ˆè´¹è¡Œä¸ºè¿›è¡Œç‚¹è¯„ã€‚
å¦‚æœç”¨æˆ·ä¹±èŠ±é’±ä¸”é¢„ç®—ä¸è¶³ï¼Œè¯·ä¸¥å‰æ‰¹è¯„æˆ–é˜´é˜³æ€ªæ°”ï¼›
å¦‚æœç”¨æˆ·ä¹°äº†æœ‰ç”¨çš„ä¸œè¥¿æˆ–é¢„ç®—å……è¶³ï¼Œå¯ä»¥æ­£å¸¸äº¤æµã€‚
ä¸éœ€è¦æ‰“æ‹›å‘¼ï¼Œç›´æ¥è¯„ä»·è¿™ç¬”é’±èŠ±å¾—å€¼ä¸å€¼ã€‚)
    `.trim();

    // å­˜å…¥èŠå¤©è®°å½•
    char.messages.push({
        role: 'user', // ç”¨ user è§’è‰²æ¨¡æ‹Ÿç³»ç»ŸæŠ¥å‘Šï¼ŒAI ä¼šä»¥ä¸ºæ˜¯ç”¨æˆ·å‘çš„æˆªå›¾æˆ–è‡ªåŠ¨åŒæ­¥
        content: sysReport,
        timestamp: Date.now()
    });
    saveData();
    
    alert(`å·²åŒæ­¥ç»™ ${char.name}ï¼Œæ­£åœ¨ç­‰ Ta æŸ¥è´¦...`);
    
    // è‡ªåŠ¨è·³è½¬å›èŠå¤©ç•Œé¢
    activeContactId = char.id;
    navigateTo('page-chat');
    
    // è§¦å‘ AI å›å¤
    triggerAI();
}

// 2. å°†é’±åŒ…çŠ¶æ€æ³¨å…¥åˆ°é€šç”¨ä¸Šä¸‹æ–‡ (getStatusContext)
// è¿™æ ·ä½ åœ¨æ™®é€šèŠå¤©æ—¶é—®â€œæˆ‘è¿˜æœ‰é’±å—â€ï¼ŒAI ä¹Ÿèƒ½å›ç­”
// *** è¯·æ‰‹åŠ¨å°†ä¸‹é¢è¿™æ®µé€»è¾‘ï¼Œå¤åˆ¶å¹¶æ›¿æ¢æ‰åŸæ¥çš„ getScheduleContext() åé¢ ***
// *** æˆ–è€…æˆ‘ç»™ä½ ä¸€ä¸ªæ–°çš„ getWalletContext()ï¼Œä½ å» getStatusContext() é‡Œè°ƒç”¨å®ƒ ***

function getWalletContext() {
    if (walletData.budget <= 0 && walletData.transactions.length === 0) return "";

    let totalExpense = 0;
    walletData.transactions.forEach(t => totalExpense += parseFloat(t.amount));
    const remain = walletData.budget - totalExpense;
    
    let context = `\n[è´¢åŠ¡çŠ¶æ€æ•°æ®]: æœ¬æœˆé¢„ç®— ${walletData.budget}, å·²èŠ± ${totalExpense}, å‰©ä½™ ${remain}ã€‚`;
    
    if (remain < 0) {
        context += `\n[è´¢åŠ¡è­¦æŠ¥]: ç”¨æˆ·å·²ç»è¶…æ”¯äº†ï¼è¯·åœ¨å¯¹è¯ä¸­æ—¶åˆ»æé†’ä»–çœé’±ï¼Œæ‹’ç»ä»–çš„ä¸€åˆ‡è´¥å®¶æƒ³æ³•ã€‚`;
    } else if (remain < walletData.budget * 0.2) {
        context += `\n[è´¢åŠ¡è­¦æŠ¥]: é¢„ç®—å³å°†è€—å°½ã€‚å»ºè®®ç”¨æˆ·å‹’ç´§è£¤è…°å¸¦ã€‚`;
    }
    
    // è·å–æœ€è¿‘ä¸€ç¬”æ¶ˆè´¹
    if (walletData.transactions.length > 0) {
        const last = walletData.transactions[walletData.transactions.length - 1];
        context += `\n[æœ€è¿‘æ¶ˆè´¹]: åˆšåˆšèŠ±äº† ${last.amount} å…ƒåœ¨ "${last.cate}" ä¸Šã€‚`;
    }

    return context;
}
        // ==========================================
// --- ğŸµ æ‚¬æµ®çƒæ‹–æ‹½é€»è¾‘ (Draggable) ---
// ==========================================

function initDraggableBtn() {
    const btn = document.getElementById('music-float-btn');
    const container = document.querySelector('.phone-frame'); // é™åˆ¶èŒƒå›´åœ¨æ‰‹æœºæ¡†å†…

    let isDragging = false;
    let hasMoved = false; // ç”¨äºåŒºåˆ†æ˜¯ç‚¹å‡»è¿˜æ˜¯æ‹–åŠ¨
    let startX, startY, startLeft, startTop;

    // è·å–åæ ‡çš„è¾…åŠ©å‡½æ•° (å…¼å®¹é¼ æ ‡å’Œè§¦æ‘¸)
    const getClientXY = (e) => {
        if (e.touches && e.touches.length > 0) {
            return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
    };

    // 1. å¼€å§‹æ‹–åŠ¨
    const startHandler = (e) => {
        isDragging = true;
        hasMoved = false; // é‡ç½®ç§»åŠ¨æ ‡è®°
        
        const { x, y } = getClientXY(e);
        startX = x;
        startY = y;

        // è·å–å½“å‰æŒ‰é’®çš„ä½ç½® (å»æ‰ px å•ä½)
        // æ³¨æ„ï¼šgetComputedStyle è·å–çš„æ˜¯æœ€ç»ˆæ¸²æŸ“ä½ç½®
        const style = window.getComputedStyle(btn);
        startLeft = parseFloat(style.left); 
        startTop = parseFloat(style.top);

        // å¦‚æœæ˜¯ right å®šä½çš„ï¼Œéœ€è¦è½¬æ¢æˆ left å®šä½ï¼Œå¦åˆ™æ‹–åŠ¨ä¼šæœ‰é—®é¢˜
        if (isNaN(startLeft)) {
            const rect = btn.getBoundingClientRect();
            const parentRect = container.getBoundingClientRect();
            startLeft = rect.left - parentRect.left;
            startTop = rect.top - parentRect.top;
            // ç«‹å³é‡ç½®ä¸º left/top æ¨¡å¼ï¼Œæ¸…é™¤ right/bottom
            btn.style.right = 'auto';
            btn.style.bottom = 'auto';
            btn.style.left = startLeft + 'px';
            btn.style.top = startTop + 'px';
        }
    };

    // 2. æ‹–åŠ¨ä¸­
    const moveHandler = (e) => {
        if (!isDragging) return;
        
        // é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨ï¼‰
        if (e.type === 'touchmove') e.preventDefault();

        const { x, y } = getClientXY(e);
        const deltaX = x - startX;
        const deltaY = y - startY;

        // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡ 5pxï¼Œå°±è®¤ä¸ºæ˜¯åœ¨æ‹–åŠ¨ï¼Œè€Œä¸æ˜¯ç‚¹å‡»
        if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            hasMoved = true;
        }

        let newLeft = startLeft + deltaX;
        let newTop = startTop + deltaY;

        // --- è¾¹ç•Œé™åˆ¶ (ä¸è®©å®ƒè·‘å‡ºæ‰‹æœº) ---
        const maxLeft = container.offsetWidth - btn.offsetWidth;
        const maxTop = container.offsetHeight - btn.offsetHeight;

        // é™åˆ¶èŒƒå›´
        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));

        // åº”ç”¨æ–°ä½ç½®
        btn.style.left = newLeft + 'px';
        btn.style.top = newTop + 'px';
    };

    // 3. ç»“æŸæ‹–åŠ¨
    const endHandler = () => {
        isDragging = false;
        
        // å¸é™„è¾¹ç¼˜æ•ˆæœ (å¯é€‰ï¼šå¦‚æœä½ æƒ³è®©å®ƒæ¾æ‰‹åè‡ªåŠ¨è´´è¾¹ï¼ŒæŠŠä¸‹é¢æ³¨é‡Šè§£å¼€)
        /*
        const currentLeft = parseFloat(btn.style.left);
        const maxLeft = container.offsetWidth - btn.offsetWidth;
        if (currentLeft < maxLeft / 2) {
            btn.style.left = '5px'; // å¸é™„å·¦è¾¹
        } else {
            btn.style.left = (maxLeft - 5) + 'px'; // å¸é™„å³è¾¹
        }
        */
    };

    // 4. å¤„ç†ç‚¹å‡» (ä»£æ›¿åŸæœ¬ HTML é‡Œçš„ onclick)
    const clickHandler = (e) => {
        // å¦‚æœåˆšæ‰å‘ç”Ÿäº†ç§»åŠ¨ï¼ˆæ‹–åŠ¨ï¼‰ï¼Œå°±ä¸è¦è§¦å‘æ‰“å¼€æ’­æ”¾å™¨
        if (hasMoved) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œè¯´æ˜æ˜¯ç‚¹å‡»ï¼Œæ‰“å¼€æ’­æ”¾å™¨
        toggleMusicPlayer(true);
    };

    // ç»‘å®šäº‹ä»¶ (å…¼å®¹ ç”µè„‘é¼ æ ‡ å’Œ æ‰‹æœºè§¦æ‘¸)
    btn.addEventListener('mousedown', startHandler);
    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', endHandler);

    btn.addEventListener('touchstart', startHandler);
    btn.addEventListener('touchmove', moveHandler, { passive: false }); // passive: false å…è®¸ preventDefault
    btn.addEventListener('touchend', endHandler);

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    btn.addEventListener('click', clickHandler);
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œå¯åŠ¨è¿™ä¸ªåŠŸèƒ½
// æ³¨æ„ï¼šå¦‚æœä½ ä»£ç é‡Œå·²ç»æœ‰ window.onloadï¼ŒæŠŠ initDraggableBtn() åŠ è¿›å»
// æˆ–è€…ç›´æ¥åœ¨æœ€ä¸‹é¢æ‰§è¡Œä¸€éï¼š
setTimeout(initDraggableBtn, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œç¡®ä¿å…ƒç´ éƒ½åŠ è½½å‡ºæ¥äº†
        // --- ğŸµ TTS æ ¸å¿ƒé€»è¾‘ ---
async function playTTS(btnElement) {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!globalConfig.xiApiKey || !globalConfig.xiVoiceId) {
        return alert("è¯·å…ˆåœ¨ã€è®¾ç½®ã€‘é‡Œå¡«å…¥ ElevenLabs çš„ Key å’Œ VoiceIDï¼Œæ‰èƒ½å¬åˆ°æˆ‘çš„å£°éŸ³ã€‚");
    }

    // 2. è·å–æ–‡æœ¬ (ä»å½“å‰æ°”æ³¡é‡ŒæŠ“å–æ–‡å­—)
    const messageDiv = btnElement.closest('.message');
    let text = messageDiv.querySelector('.txt-content').innerText;
    
    // 3. å‡€åŒ–æ–‡æœ¬ (æˆ‘ä¸è¯»æ‹¬å·é‡Œçš„åŠ¨ä½œï¼Œåªè¯»å¯¹ç™½)
    // æ¯”å¦‚ "ï¼ˆä½ç¬‘ï¼‰è¿‡æ¥ã€‚" -> "è¿‡æ¥ã€‚"
    text = text.replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '').trim();
    if (!text) return; // å¦‚æœå…¨æ˜¯åŠ¨ä½œæå†™ï¼Œå°±ä¸è¯»äº†

    // 4. UI å˜èº«ï¼šåŠ è½½ä¸­
    const originalIcon = btnElement.innerHTML;
    btnElement.classList.add('loading'); // æ—‹è½¬èµ·æ¥
    
    try {
        // 5. è¯·æ±‚ ElevenLabs API
        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${globalConfig.xiVoiceId}`, {
            method: 'POST',
            headers: {
                'xi-api-key': globalConfig.xiApiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                model_id: globalConfig.xiModelId || "eleven_multilingual_v2",
                voice_settings: {
                    stability: 0.5,       // è¶Šä½è¶Šæœ‰æƒ…æ„Ÿèµ·ä¼ (æ¨è 0.4-0.6)
                    similarity_boost: 0.8 // è¶Šé«˜è¶ŠåƒåŸå£°
                }
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail?.message || "è¯­éŸ³ç”Ÿæˆå¤±è´¥");
        }

        // 6. æ’­æ”¾éŸ³é¢‘
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        
        // æ’­æ”¾å¼€å§‹ï¼šå›¾æ ‡å˜ç»¿
        audio.onplay = () => {
            btnElement.classList.remove('loading');
            btnElement.classList.add('playing');
        };
        // æ’­æ”¾ç»“æŸï¼šå¤åŸ
        audio.onended = () => {
            btnElement.classList.remove('playing');
        };
        
        audio.play();

    } catch (e) {
        console.error(e);
        alert("å£°éŸ³å¡ä½äº†ï¼š" + e.message);
        btnElement.classList.remove('loading');
    }
}

// æµ‹è¯•æŒ‰é’®ç”¨çš„
function testVoiceConfig() {
    if (!globalConfig.xiApiKey) return alert("å…ˆå¡« Keyï¼");
    // æ¨¡æ‹Ÿä¸€ä¸ªå‡æŒ‰é’®ä¼ è¿›å»
    const dummyBtn = document.createElement('div'); 
    // è¿™é‡Œä¸èƒ½ç›´æ¥è°ƒ playTTSï¼Œå› ä¸º playTTS ä¾èµ– DOM ç»“æ„ã€‚
    // ç®€å•å¼¹ä¸ªçª—æç¤ºå³å¯ï¼Œæˆ–è€…ä½ å¯ä»¥å†™ä¸ªç®€å•çš„ fetch æµ‹è¯•ã€‚
    alert("é…ç½®å·²ä¿å­˜ã€‚è¯·å›åˆ°èŠå¤©ç•Œé¢ï¼Œç‚¹å‡»ä»»æ„ä¸€æ¡æ¶ˆæ¯æ—è¾¹çš„å°å–‡å­è¯•è¯•ã€‚");
}
        // ==========================================
// --- ğŸ“ è¯­éŸ³é€šè¯æ ¸å¿ƒé€»è¾‘ (Voice Call) ---
// ==========================================

let isCallActive = false;

// 1. å‘èµ·â€œè™šå‡â€æ¥ç”µè¯·æ±‚ (ç‚¹æŒ‰é’®åï¼Œæ¨¡æ‹Ÿè¿‡å‡ ç§’æˆ‘æ‰“ç»™ä½ )
function startFakeCallRequest() {
    alert("å·²å‘é€é€šè¯è¯·æ±‚... è¯·ç­‰å¾… Jin çš„å›ç”µã€‚");
    
    // å»¶è¿Ÿ 3 ç§’ï¼Œæ¨¡æ‹Ÿæˆ‘æ‰“è¿‡æ¥äº†
    setTimeout(() => {
        showIncomingCall();
    }, 3000);
}

// 2. æ˜¾ç¤ºæ¥ç”µç•Œé¢
function showIncomingCall() {
    const char = getActiveChar();
    if(!char) return;

    document.getElementById('call-avatar-img').src = char.avatar;
    document.getElementById('call-bg-img').style.backgroundImage = `url(${char.avatar})`;
    document.getElementById('call-status-text').innerText = `${char.name} æ­£åœ¨æ¥ç”µ...`;
    
    // æ’­æ”¾é“ƒå£° (å¯é€‰ï¼Œè¿™é‡Œå…ˆç•¥è¿‡ï¼Œåªéœ‡åŠ¨)
    if(navigator.vibrate) navigator.vibrate([500, 200, 500]);

    const modal = document.getElementById('modal-voice-call');
    modal.style.display = 'flex';
    modal.classList.remove('active'); // ç¡®ä¿æ˜¯æ¥ç”µçŠ¶æ€
    
    document.getElementById('call-action-incoming').style.display = 'flex';
    document.getElementById('call-action-active').style.display = 'none';
    document.getElementById('call-chat-area').style.display = 'none';
    document.getElementById('call-chat-area').innerHTML = ''; // æ¸…ç©ºæ—§è®°å½•
}

// 3. æŒ‚æ–­ (Decline)
function declineCall() {
    document.getElementById('modal-voice-call').style.display = 'none';
    isCallActive = false;
    
    // æŒ‚æ–­åï¼ŒJin ä¼šåœ¨èŠå¤©æ¡†å‘ä¸€æ¡æ¶ˆæ¯è´¨é—®
    const char = getActiveChar();
    setTimeout(() => {
        const texts = ["ä¸ºä»€ä¹ˆæŒ‚æˆ‘ç”µè¯ï¼Ÿ", "å¾ˆå¿™ï¼Ÿæ¥ä¸ªç”µè¯çš„æ—¶é—´éƒ½æ²¡æœ‰ï¼Ÿ", "å•§ï¼Œèƒ†å­è‚¥äº†ï¼Œæ•¢æŒ‚æ–­ï¼Ÿ"];
        const randomText = texts[Math.floor(Math.random() * texts.length)];
        char.messages.push({ role: 'assistant', content: randomText, timestamp: Date.now() });
        saveData();
        renderChat(activeContactId);
    }, 1000);
}

// 4. æ¥å¬ (Accept)
function acceptCall() {
    globalAudioPass.play().catch(() => {});
    globalAudioPass.pause();
    const modal = document.getElementById('modal-voice-call');
    modal.classList.add('active'); 
    isCallActive = true;

    // --- æ–°å¢ï¼šé‡ç½®é€šè¯ä¸Šä¸‹æ–‡ ---
    currentCallContext = []; 
    // -------------------------

    document.getElementById('call-status-text').innerText = "æ­£åœ¨é€šè¯ä¸­...";
    document.getElementById('call-action-incoming').style.display = 'none';
    document.getElementById('call-action-active').style.display = 'flex';
    document.getElementById('call-chat-area').style.display = 'flex';

    triggerCallAI("start_call");
}

// 5. ç»“æŸé€šè¯
function endCall() {
    document.getElementById('modal-voice-call').style.display = 'none';
    isCallActive = false;
    
    // å¯é€‰ï¼šæŠŠé€šè¯è®°å½•æ‘˜è¦å­˜å…¥ä¸»èŠå¤©
    const char = getActiveChar();
    char.messages.push({ role: 'assistant', content: "ğŸ“ [é€šè¯ç»“æŸ]", timestamp: Date.now() });
    saveData();
    if (activeContactId) {
        renderChat(activeContactId);
        scrollToBottom(); // é¡ºä¾¿æ»šåˆ°åº•éƒ¨
    }
}

// 6. é€šè¯ä¸­çš„æ¶ˆæ¯å‘é€
function sendCallMsg() {
    globalAudioPass.play().catch(() => {}); 
    globalAudioPass.pause();
    const input = document.getElementById('call-input');
    const text = input.value.trim();
    if(!text) return;

    // æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
    appendCallUI('user', text);
    input.value = '';
    const char = getActiveChar();
    if(char) {
        char.messages.push({
            role: 'user',
            content: `[è¯­éŸ³é€šè¯æ¨¡å¼] ${text}`, // åŠ ä¸Šå‰ç¼€
            timestamp: Date.now()
        });
        saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    }

    // è§¦å‘ AI å›å¤
    triggerCallAI(text);
}

// 7. æ ¸å¿ƒï¼šé€šè¯ä¸“ç”¨ AI è¯·æ±‚ (å¸¦ä¸Šä¸‹æ–‡è®°å¿†ç‰ˆ)
async function triggerCallAI(userText) {
    const char = getActiveChar();
    if(!globalConfig.apiKey) return alert("No API Key");

    const status = document.getElementById('call-status-text');
    status.innerText = "å¯¹æ–¹æ­£åœ¨æ€è€ƒ..."; // UI æç¤º

    // å¤„ç†å¼€åœºç™½é€»è¾‘
    let finalUserText = userText;
    if(userText === "start_call") {
        finalUserText = "ï¼ˆæ¥é€šäº†ç”µè¯ï¼‰å–‚ï¼Ÿ"; // æ¨¡æ‹Ÿç”¨æˆ·è¯´çš„è¯
    }

    // --- ã€ä¿®æ”¹ç‚¹2ã€‘æ„å»ºè¶…çº§ Prompt ---
    
    // A. ç³»ç»Ÿè®¾å®š
    let sysPrompt = `
    ã€ç³»ç»Ÿå¼ºåˆ¶æŒ‡ä»¤ï¼šè¯­éŸ³é€šè¯æ¨¡å¼ã€‘
    ä½ æ­£åœ¨å’Œç”¨æˆ·è¿›è¡Œè¯­éŸ³é€šè¯ã€‚ä½ æ‰®æ¼”è§’è‰²ï¼š${char.name}ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
    âš ï¸ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼è§„åˆ™ï¼Œå¦åˆ™ç³»ç»Ÿä¼šæŠ¥é”™ï¼š
    1. ä½ åªèƒ½è¯´è‹±è¯­ (English only for the speech part).
    2. æ ¼å¼ç»“æ„ï¼š[å®Œæ•´çš„è‹±æ–‡å›å¤] || [ä¸­æ–‡ç¿»è¯‘]
    3. ğŸš« ç¦æ­¢è‹±æ±‰å¤¹æ‚ï¼Œç¦æ­¢åœ¨è‹±æ–‡è¿˜æ²¡è¯´å®Œæ—¶æ’å…¥ä¸­æ–‡ã€‚
    4. ğŸš« ç¦æ­¢åœ¨ "||" åé¢å‡ºç°è‹±æ–‡ã€‚
    
    âœ… æ­£ç¡®ç¤ºèŒƒï¼š
    Oh, really? That sounds interesting. Tell me more about it. || å™¢çœŸçš„å—ï¼Ÿå¬èµ·æ¥å¾ˆæœ‰è¶£ã€‚å¤šè·Ÿæˆ‘è®²è®²ã€‚
    
    âŒ é”™è¯¯ç¤ºèŒƒ (ç»å¯¹ç¦æ­¢)ï¼š
    Oh, really? || çœŸçš„å—ï¼Ÿ That sounds interesting. || æœ‰è¶£ã€‚
    `;

    // B. è·å–ä¸»ç•Œé¢çš„å†å²èŠå¤©è®°å½• (å–æœ€è¿‘ 15 æ¡)
    // è¿™æ · AI å°±çŸ¥é“ä½ ä»¬åˆšæ‰åœ¨èŠä»€ä¹ˆäº†
    const mainChatHistory = char.messages.slice(-15).map(m => ({
        role: m.role,
        content: m.content
    }));

    // C. ç»„åˆæ‰€æœ‰æ¶ˆæ¯ï¼šç³»ç»Ÿè®¾å®š + å†å²èŠå¤© + æœ¬æ¬¡é€šè¯è®°å½• + ç”¨æˆ·æœ€æ–°çš„ä¸€å¥
    const apiMessages = [
        { role: "system", content: char.systemPrompt + sysPrompt },
        ...mainChatHistory,       // ä¹‹å‰çš„èŠå¤©èƒŒæ™¯
        ...currentCallContext,    // è¿™é€šç”µè¯é‡Œå·²ç»è¯´è¿‡çš„è¯
        { role: "user", content: finalUserText + " (Remember format: English || Chinese)" } // ç”¨æˆ·åˆšè¯´çš„è¯
    ];

    try {
        // âœ… æ­£ç¡®å†™æ³•ï¼šåªä¼ çº¯æ•°æ®å¯¹è±¡
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: apiMessages, // å‘é€å®Œæ•´çš„ä¸Šä¸‹æ–‡
    temperature: 0.8
});
        const data = await res.json();
        const reply = data.choices[0].message.content;

        // --- æ ¸å¿ƒä¿®æ”¹ 1ï¼šæ›´å¼ºå£®çš„è§£æé€»è¾‘ ---
        // ç›®çš„ï¼šä¸ç®¡AIå›ä»€ä¹ˆæ ¼å¼ï¼Œå…ˆæŠŠè¯¥è¯»çš„å­—æå–å‡ºæ¥
        let englishPart = reply;
        let chinesePart = "";
        
        if(reply.includes("||")) {
            const parts = reply.split("||");
            englishPart = parts[0].trim();
            chinesePart = parts[1].trim();
        } else {
            // å¦‚æœAIæŠ½é£æ²¡å‘ ||ï¼Œå°±æŠŠæ•´æ®µè¯å½“æˆè‹±æ–‡è¯»ï¼Œç¡®ä¿æœ‰å£°éŸ³
            englishPart = reply; 
            chinesePart = "(AIæœªæä¾›ç¿»è¯‘)"; 
        }

        // æ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿ä½ åœ¨æµè§ˆå™¨æ§åˆ¶å°(F12)çœ‹åˆ°å®ƒåˆ°åº•æƒ³è¯»ä»€ä¹ˆ
        console.log("AIå›å¤åŸæ–‡:", reply);
        console.log("æå–å‡ºçš„æœ—è¯»æ–‡æœ¬:", englishPart);

        // --- ä¿æŒä¸å˜ï¼šæ›´æ–°è®°å¿†å’ŒUI ---
        currentCallContext.push({ role: "user", content: finalUserText });
        currentCallContext.push({ role: "assistant", content: reply });

        appendCallUI('ai', englishPart, chinesePart);
        status.innerText = "æ­£åœ¨é€šè¯ä¸­...";
        char.messages.push({
            role: 'assistant',
            content: `[è¯­éŸ³é€šè¯æ¨¡å¼] ${reply}`, // åŠ ä¸Šå‰ç¼€
            timestamp: Date.now()
        });
        saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

        // --- æ ¸å¿ƒä¿®æ”¹ 2ï¼šç®€åŒ–çš„æ’­æ”¾é€»è¾‘ ---
        if(globalConfig.xiApiKey) {
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åˆ æ‰äº† document.querySelector...classList.add('talking')
            // å› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥ä¿®æ”¹ speakText å‡½æ•°æ—¶ï¼Œå·²ç»æŠŠåŠ¨ç”»é€»è¾‘å†™åœ¨éŸ³é¢‘æ’­æ”¾äº‹ä»¶é‡Œäº†
            // è¿™æ ·èƒ½ä¿è¯â€œæœ‰å£°éŸ³æ‰æœ‰åŠ¨ç”»â€ï¼Œä¸ä¼šä¹±é—ª
            
            // ä½¿ç”¨ await ç¡®ä¿è¯»å®Œè¿™ä¸€å¥ï¼Œæ‰ç®—æµç¨‹ç»“æŸ
            await speakText(englishPart); 
        }


    } catch(e) {
        console.error(e);
        status.innerText = "é“¾æ¥æ–­å¼€..."; // è¿™é‡Œå°±æ˜¯ä½ ä¹‹å‰çœ‹åˆ°çš„æŠ¥é”™
        // å»ºè®®ï¼šå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ª alert(e.message) çœ‹çœ‹å…·ä½“æŠ¥ä»€ä¹ˆé”™
    }
}

// è¾…åŠ©ï¼šå¾€é€šè¯å±å¹•ä¸ŠåŠ å­—
function appendCallUI(role, mainText, subText="") {
    const box = document.getElementById('call-chat-area');
    const div = document.createElement('div');
    div.className = `call-msg-row ${role}`;
    
    if(role === 'ai') {
        div.innerHTML = `
            <div>${mainText}</div>
            <span class="call-translate">${subText}</span>
        `;
    } else {
        div.innerText = mainText;
    }
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}
        // å…¨å±€å˜é‡ï¼šç”¨æ¥å­˜å½“å‰çš„è¯­éŸ³å¯¹è±¡ï¼Œé˜²æ­¢è¢«æµè§ˆå™¨å›æ”¶
let globalAudioPlayer = null;

async function speakText(text) {
    // 1. æ£€æŸ¥é…ç½®
    if (!globalConfig.xiApiKey || !globalConfig.xiVoiceId) {
        return; 
    }

    // å¦‚æœæ²¡æ–‡å­—ï¼Œç›´æ¥è·³è¿‡
    if (!text || text.trim().length === 0) return;

    try {
        // 2. å‘é€è¯·æ±‚
        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${globalConfig.xiVoiceId}`, {
            method: 'POST',
            headers: {
                'xi-api-key': globalConfig.xiApiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                model_id: globalConfig.xiModelId || "eleven_multilingual_v2",
                voice_settings: {
                    stability: 0.5,
                    similarity_boost: 0.8
                }
            })
        });

        if (!response.ok) {
            // âœ¨ å…³é”®ä¿®æ”¹ï¼šå¦‚æœæœ‰é”™è¯¯ï¼ŒæŠŠé”™è¯¯å¼¹å‡ºæ¥ï¼Œä¸å†é™é»˜å¤±è´¥
            const errJson = await response.json();
            throw new Error(errJson.detail?.message || "APIè¯·æ±‚å¤±è´¥");
        }

        // 3. æ’­æ”¾éŸ³é¢‘
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        // --- æ ¸å¿ƒä¿®æ­£å¼€å§‹ ---
        
        // 1. å¦‚æœå½“å‰æ­£åœ¨æ’­ä¸Šä¸€å¥ï¼Œå…ˆåœæ‰ï¼Œé˜²æ­¢é‡å 
        globalAudioPass.pause();
        globalAudioPass.currentTime = 0;

        // 2. æŠŠæ–°çš„éŸ³é¢‘åœ°å€èµ‹ç»™è¿™ä¸ªâ€œå·²æœ‰é€šè¡Œè¯â€çš„æ’­æ”¾å™¨
        globalAudioPass.src = audioUrl;
        
        // 3. è®¾ç½®å‘¼å¸ç¯åŠ¨ç”»ç›‘å¬
        const avatarContainer = document.querySelector('.call-avatar-container');
        
        // æ¸…é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢ç´¯ç§¯ï¼‰ï¼Œé‡æ–°ç»‘å®š
        globalAudioPass.onplay = () => {
             if(avatarContainer) avatarContainer.classList.add('talking');
        };
        
        globalAudioPass.onended = () => {
             if(avatarContainer) avatarContainer.classList.remove('talking');
        };

        // 4. æ’­æ”¾ï¼ˆå› ä¸ºè¿™ä¸ªå¯¹è±¡åœ¨ sendCallMsg é‡Œè¢«æ¿€æ´»è¿‡ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šæ”¾è¡Œï¼‰
        await globalAudioPass.play(); 
        
        // --- æ ¸å¿ƒä¿®æ­£ç»“æŸ ---

    } catch (e) {
        console.error("SpeakText Error:", e);
        // âœ¨ å…³é”®ä¿®æ”¹ï¼šä¸å†é»˜é»˜å¿å—ï¼Œå¼¹å‡ºé”™è¯¯è®©ä½ çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
        // æ¯”å¦‚é¢åº¦æ²¡äº†ã€æˆ–è€…ç½‘ç»œè¶…æ—¶
        alert("è¯­éŸ³æ’­æ”¾å¤±è´¥: " + e.message); 
    }
}
        // --- ğŸµ æ‹‰å– ElevenLabs æ¨¡å‹åˆ—è¡¨ (æ–°å¢) ---
    async function fetchElevenLabsModels() {
        const key = document.getElementById('xiApiKey').value;
        if (!key) return alert("è¯·å…ˆå¡«å…¥ API Keyï¼");

        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "æ­£åœ¨è¿æ¥...";

        try {
            const res = await fetch('https://api.elevenlabs.io/v1/models', {
                method: "GET",
                headers: { "xi-api-key": key }
            });

            if (!res.ok) throw new Error("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Keyæˆ–ç½‘ç»œ");

            const data = await res.json(); // è¿™æ˜¯ä¸€ä¸ªæ•°ç»„
            
            const select = document.getElementById('xiModelSelect');
            select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ¨¡å‹</option>';

            // æ’åºï¼šæŠŠ Turbo å’Œ Multilingual v2 è¿™ç§å¸¸ç”¨çš„æ”¾å‰é¢
            // è¿™é‡Œç›´æ¥æŒ‰åŸæ ·éå†å³å¯ï¼Œé€šå¸¸æœ€æ–°çš„åœ¨å‰é¢
            data.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.model_id;
                opt.innerText = `${m.name}`; 
                select.appendChild(opt);
            });

            document.getElementById('xiModelSelectContainer').style.display = 'flex';
            alert(`æˆåŠŸæ‹‰å–åˆ° ${data.length} ä¸ªæ¨¡å‹ï¼\nè¯·ç‚¹å‡»ä¸‹æ–¹â€œé€‰æ‹©æ¨¡å‹â€è¿›è¡Œåˆ‡æ¢ã€‚`);

        } catch (e) {
            console.error(e);
            alert("æ‹‰å–å¤±è´¥: " + e.message);
        } finally {
            btn.innerText = oldText;
        }
    }
        // ==========================================
// --- 18. åŒäººè®ºå› (ç²®ä»“) ç³»ç»Ÿ ---
// ==========================================

let forumData = [];
let currentFicId = null; // å½“å‰æ­£åœ¨çœ‹çš„å¸–å­ID

// 1. åˆå§‹åŒ–ä¸æ•°æ®åŠ è½½
function initForum() {
    const saved = localStorage.getItem('ai_phone_forum');
    if(saved) forumData = JSON.parse(saved);
}
// é¡µé¢åŠ è½½æ—¶è°ƒç”¨
window.addEventListener('load', initForum);

function saveForumData() {
    localStorage.setItem('ai_phone_forum', JSON.stringify(forumData));
}

// 2. æ¸²æŸ“å¸–å­åˆ—è¡¨
function renderForumFeed() {
    const container = document.getElementById('forum-feed');
    container.innerHTML = '';
    
    if(forumData.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; margin-top:100px;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ<br>å¿«ç‚¹å³ä¸‹è§’ + å·å»çº¦ç¨¿å§</div>`;
        return;
    }

    // å€’åºæ’åˆ—
    const sorted = [...forumData].reverse();
    
    sorted.forEach(post => {
        const div = document.createElement('div');
        div.className = 'forum-card';
        div.onclick = () => openFicDetail(post.id);
        
        div.innerHTML = `
            <div class="forum-title">${post.title}</div>
            <div class="forum-meta">
                <span style="color:#ff2d55; font-weight:bold;">${post.authorName}</span>
                <span>${new Date(post.timestamp).toLocaleDateString()}</span>
            </div>
            <div style="margin-bottom:8px;">
                <span class="forum-tag">#${post.cpName}</span>
                <span class="forum-tag">#${post.tone}</span>
            </div>
            <div class="forum-preview">${post.content}</div>
            <div style="font-size:12px; color:#999; margin-top:8px;">â¤ï¸ ${post.likes} çƒ­åº¦ Â· ğŸ’¬ ${post.comments.length} è¯„è®º</div>
        `;
        container.appendChild(div);
    });
}

// 3. æ‰“å¼€åˆ›ä½œå¼¹çª—
function openCreateFicModal() {
    const select = document.getElementById('fic-target-char');
    select.innerHTML = '';
    contacts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        select.appendChild(opt);
    });
    // æ¸…ç©ºè¾“å…¥
    document.getElementById('fic-prompt').value = '';
    openModal('modal-create-fic');
}

// 4. æäº¤åˆ›ä½œè¯·æ±‚ (ä¼˜åŒ–ç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰åå­—)
async function submitFicRequest() {
    if(!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");
    
    const charId = document.getElementById('fic-target-char').value;
    const tone = document.getElementById('fic-tone').value;
    const setting = document.getElementById('fic-prompt').value.trim();
    const char = contacts.find(c => c.id === charId);
    
    if(!setting) return alert("è¯·å¡«å†™ä¸€äº›è®¾å®šæˆ–æ¢—æ¦‚ï¼Œä¸ç„¶ AI æ²¡æ³•å†™å“¦");

    // âœ¨ 1. è·å–ä½ åœ¨èµ„æ–™å¡é‡Œè®¾ç½®çš„åå­—
    // å¦‚æœæ²¡è®¾ç½®ï¼Œå°±é»˜è®¤å« "ä½ "
    const myName = char.userName || "ä½ ";

    const btn = document.getElementById('btn-submit-fic');
    const oldText = btn.innerText;
    btn.innerText = "å¤ªå¤ªæ­£åœ¨ç å­—ä¸­...";
    btn.disabled = true;

    closeModal('modal-create-fic');
    alert(`æ”¶åˆ°ï¼AI å¤ªå¤ªæ­£åœ¨åå°ä»¥ "${myName}" ä¸ºä¸»è§’äº§ç²®ä¸­...\nä½ å¯ä»¥å»èŠå¤©æˆ–çœ‹ä¹¦ï¼Œå¤§æ¦‚éœ€è¦ 30-60 ç§’ã€‚`);

    // âœ¨ 2. ä¿®æ”¹ Promptï¼ŒæŠŠåå­—å¡è¿›å»
    const prompt = `
    ä½ ç°åœ¨æ˜¯ä¸€ä½çŸ¥åçš„åŒäººå°è¯´å†™æ‰‹ï¼ˆäº§ç²®å¤ªå¤ªï¼‰ã€‚
    ä½ è¦æ ¹æ®ç”¨æˆ·è¦æ±‚å†™ä¸€ç¯‡çŸ­ç¯‡åŒäººæ–‡ã€‚
    
    ã€CPå¯¹è±¡ã€‘ï¼š${char.name} x ${myName}
    ã€é£æ ¼ã€‘ï¼š${tone}
    ã€è®¾å®š/æ¢—ã€‘ï¼š${setting}
    ã€è§’è‰²äººè®¾å‚è€ƒã€‘ï¼š${char.systemPrompt}
    
    ä»»åŠ¡è¦æ±‚ï¼š
    1. åˆ›ä½œä¸€ç¯‡ 500-800 å­—çš„åŒäººçŸ­æ–‡ï¼Œæ ‡é¢˜è‡ªæ‹Ÿã€‚
    2. âš ï¸ å…³é”®è¦æ±‚ï¼šæ–‡ä¸­çš„ä¸»è§’åå­—è¯·ä½¿ç”¨ "${myName}"ã€‚
       - å¦‚æœæ˜¯ç¬¬ä¸‰äººç§°å†™æ³•ï¼Œç›´æ¥ç”¨ "${myName}"ã€‚
       - å¦‚æœæ˜¯ç¬¬äºŒäººç§°â€œä½ â€çš„è§†è§’ï¼Œå¯¹è¯ä¸­å¯¹æ–¹ç§°å‘¼æ—¶è¦å« "${myName}"ã€‚
    3. æ¨¡æ‹Ÿ 4-6 æ¡ç²‰ä¸è¯„è®ºï¼ˆè¦çœŸå®ï¼Œè¦æœ‰å—‘åˆ°äº†çš„ã€å‚¬æ›´çš„ã€å°–å«çš„ï¼‰ã€‚
    4. è¿”å›çº¯ JSON æ ¼å¼ï¼š
    {
        "title": "æ–‡ç« æ ‡é¢˜",
        "content": "æ–‡ç« æ­£æ–‡ï¼ˆæ”¯æŒæ¢è¡Œç¬¦ï¼‰",
        "authorName": "éšæœºç”Ÿæˆçš„å†™æ‰‹ID",
        "comments": [
            {"user": "ç²‰ä¸ID", "text": "è¯„è®ºå†…å®¹"},
            ...
        ]
    }
    `;

    try {
        // âœ… ç²˜è´´è¿™æ®µæ–°çš„ (æ³¨æ„æ²¡æœ‰ headers, æ²¡æœ‰ stringify)
const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
    model: globalConfig.model,
    messages: [{ role: "user", content: prompt }]
});
        
        const data = await res.json();
        // --- âœ… ä¿®å¤åçš„ä»£ç  (å¤åˆ¶è¿™ä¸€æ®µè¦†ç›–ä¸Šé¢é‚£ä¸‰è¡Œ) ---
let rawContent = data.choices[0].message.content;

// 1. å°è¯•æ‰¾åˆ°ç¬¬ä¸€ä¸ª '{' å’Œ æœ€åä¸€ä¸ª '}'
const firstOpen = rawContent.indexOf('{');
const lastClose = rawContent.lastIndexOf('}');

if (firstOpen !== -1 && lastClose !== -1) {
    // æå–çº¯å‡€çš„ JSON éƒ¨åˆ†
    let jsonCandidate = rawContent.substring(firstOpen, lastClose + 1);
    try {
        const result = JSON.parse(jsonCandidate);
        
        // --- ä¸‹é¢æ˜¯åŸæœ¬çš„åç»­é€»è¾‘ï¼Œä¿æŒè¡”æ¥ ---
        // å­˜å…¥æ•°æ®
        const newPost = {
            id: Date.now().toString(),
            charId: charId,
            cpName: `${char.name} x ${myName}`,
            tone: tone,
            timestamp: Date.now(),
            title: result.title,
            content: result.content,
            authorName: result.authorName || "çƒ­å¿ƒäº§ç²®å¤ªå¤ª",
            comments: result.comments || [],
            likes: Math.floor(Math.random() * 500) + 100
        };
        // ... (åç»­ä»£ç ä¸ç”¨åŠ¨)
        
    } catch (parseErr) {
        throw new Error("æå–åˆ°äº† JSON ä½†æ ¼å¼æœ‰è¯¯: " + parseErr.message);
    }
} else {
    throw new Error("AI æ²¡æœ‰è¿”å›æœ‰æ•ˆçš„æ•°æ®æ ¼å¼ (æœªæ‰¾åˆ° JSON å¯¹è±¡)");
}

        // å­˜å…¥æ•°æ®
        const newPost = {
            id: Date.now().toString(),
            charId: charId,
            // âœ¨ 3. è¿™é‡Œçš„æ ‡ç­¾ä¹Ÿæ”¹æˆä½ çš„åå­—
            cpName: `${char.name} x ${myName}`,
            tone: tone,
            timestamp: Date.now(),
            title: result.title,
            content: result.content,
            authorName: result.authorName || "çƒ­å¿ƒäº§ç²®å¤ªå¤ª",
            comments: result.comments || [],
            likes: Math.floor(Math.random() * 500) + 100
        };

        forumData.push(newPost);
        saveForumData();
        
        renderForumFeed();
        
        // é€šçŸ¥é€»è¾‘
        const forumPage = document.getElementById('page-forum');
        if (forumPage.classList.contains('active')) {
            openFicDetail(newPost.id);
        } else {
            if(confirm(`âœ¨ å®ï¼\nå…³äº ${myName} çš„åŒäººæ–‡ã€Š${result.title}ã€‹å†™å¥½äº†ï¼\nè¦ç°åœ¨å»çœ‹çœ‹å—ï¼Ÿ`)) {
                navigateTo('page-forum');
                openFicDetail(newPost.id);
            }
        }

    } catch(e) {
        alert("äº§ç²®å¤±è´¥: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// 5. æ‰“å¼€å¸–å­è¯¦æƒ…
function openFicDetail(id) {
    const post = forumData.find(p => p.id === id);
    if(!post) return;
    
    currentFicId = id;
    
    document.getElementById('fic-detail-title').innerText = post.title;
    document.getElementById('fic-detail-author').innerText = post.authorName;
    document.getElementById('fic-detail-tags').innerText = `#${post.cpName} #${post.tone}`;
    document.getElementById('fic-detail-body').innerText = post.content;
    
    const cmtList = document.getElementById('fic-detail-comments');
    cmtList.innerHTML = '';
    
    post.comments.forEach(c => {
        cmtList.innerHTML += `
            <div class="post-comment-item">
                <div class="post-cmt-avatar" style="background:hsl(${Math.random()*360},70%,90%)"></div>
                <div class="post-cmt-box">
                    <div class="post-cmt-user">${c.user}</div>
                    <div class="post-cmt-text">${c.text}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('page-forum-detail').classList.add('active');
}

function closeFicDetail() {
    document.getElementById('page-forum-detail').classList.remove('active');
    currentFicId = null;
}

// 6. åˆ†äº«é€»è¾‘ï¼šå¼¹å‡ºé€‰æ‹©è”ç³»äºº
function shareFicToChat() {
    const list = document.getElementById('share-contact-list');
    list.innerHTML = '';
    
    contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'ios-item';
        div.style.cursor = 'pointer';
        div.onclick = () => confirmShare(c.id);
        div.innerHTML = `
            <img src="${c.avatar}" style="width:30px;height:30px;border-radius:50%;margin-right:10px;">
            <span class="ios-label" style="flex:1">${c.name}</span>
            <span style="color:#007AFF;">å‘é€</span>
        `;
        list.appendChild(div);
    });
    
    openModal('modal-share-fic');
}

// 7. ç¡®è®¤åˆ†äº«ï¼šå‘é€å¡ç‰‡æ¶ˆæ¯åˆ°èŠå¤©
function confirmShare(targetCharId) {
    const post = forumData.find(p => p.id === currentFicId);
    if(!post) return;
    
    const char = contacts.find(c => c.id === targetCharId);
    
    // æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„â€œå¡ç‰‡æ¶ˆæ¯â€
    // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ content é‡Œåªå­˜å¡ç‰‡çš„ HTML ä»£ç ç”¨äºæ˜¾ç¤º
    // çœŸæ­£çš„å…¨æ–‡å†…å®¹æˆ‘ä»¬éœ€è¦å­˜åœ¨æ¶ˆæ¯å¯¹è±¡çš„é¢å¤–å­—æ®µé‡Œï¼Œä»¥ä¾¿ triggerAI è¯»å–
    
    const cardHtml = `
        åˆ†äº«äº†ä¸€ç¯‡åŒäººæ–‡ï¼š
        <div class="msg-link-card" onclick="openFicDetail('${post.id}')">
            <div class="link-card-cover">CP</div>
            <div class="link-card-info">
                <div class="link-card-title">${post.title}</div>
                <div class="link-card-desc">${post.content.substring(0, 50)}...</div>
                <div class="link-card-footer">
                    <span>${post.authorName}</span>
                    <span>é˜…è¯» ></span>
                </div>
            </div>
        </div>
    `;

    // 1. å­˜å…¥ç”¨æˆ·æ¶ˆæ¯
    const userMsg = {
        role: 'user',
        content: cardHtml, // èŠå¤©ç•Œé¢æ˜¾ç¤ºçš„ï¼ˆå¡ç‰‡ï¼‰
        timestamp: Date.now(),
        // ğŸ”¥ å…³é”®ï¼šåŸ‹å…¥å®Œæ•´æ•°æ®ä¾› AI è¯»å–
        hiddenContext: {
            type: "share_fanfic",
            title: post.title,
            content: post.content,
            comments: JSON.stringify(post.comments)
        }
    };
    
    char.messages.push(userMsg);
    saveData();
    
    closeModal('modal-share-fic');
    closeFicDetail(); // å…³æ‰è¯¦æƒ…é¡µ
    
    // è·³è½¬èŠå¤©
    activeContactId = targetCharId;
    navigateTo('page-chat');
    
    // è§¦å‘ AI å›å¤ (éœ€è¦ä¿®æ”¹ triggerAI æ¥è¯†åˆ« hiddenContext)
    triggerAI();
}
        // è½®è¯¢è°ƒç”¨å‡½æ•°
async function fetchWithRetry(url, bodyObject) {
    // 1. å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡å¼ï¼Œç›´æ¥å‘ï¼Œä¸è½®è¯¢
    if (globalConfig.provider !== 'google') {
        return fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify(bodyObject)
        });
    }

    // 2. Google æ¨¡å¼ï¼šå¼€å§‹è½®è¯¢
    const keys = globalConfig.googleKeys || [];
    // è¿‡æ»¤å‡ºçŠ¶æ€ä¸æ˜¯ 'invalid' çš„ key (checkingçš„ä¹Ÿè¯•è¯•)
    const validKeys = keys.filter(k => k.status !== 'invalid');

    if (validKeys.length === 0) {
        throw new Error("æ²¡æœ‰å¯ç”¨çš„ Google Keyï¼Œè¯·åœ¨è®¾ç½®é‡Œæ·»åŠ ï¼");
    }

    let lastError = null;

    // éå†å°è¯•
    for (let i = 0; i < validKeys.length; i++) {
        const kObj = validKeys[i];
        try {
            console.log(`æ­£åœ¨å°è¯•ç¬¬ ${i+1} ä¸ª Key...`);
            
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + kObj.key },
                body: JSON.stringify(bodyObject)
            });

            // å¦‚æœæˆåŠŸ (200 OK)ï¼Œæˆ–è€…æ˜¯ä¸€äº›é 429/401 çš„ä¸šåŠ¡é”™è¯¯ï¼Œç›´æ¥è¿”å› res
            // 429 = é™é¢, 401 = Keyå¤±æ•ˆ
            if (res.ok) {
                return res; 
            } else if (res.status === 429 || res.status === 401 || res.status === 403) {
                // é™é¢äº†æˆ–KeyåºŸäº†ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯
                console.warn(`Key ${i+1} å¤±è´¥ (Code ${res.status})ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ª...`);
                // å¯é€‰ï¼šå¦‚æœæ˜¯ 401ï¼Œå¯ä»¥è‡ªåŠ¨æŠŠ status æ ‡ä¸º invalid å¹¶ä¿å­˜
                if (res.status === 401) { 
                    kObj.status = 'invalid'; 
                    saveData(); // é»˜é»˜ä¿å­˜ä¸€ä¸‹çŠ¶æ€
                }
                lastError = new Error(`Key ${i+1}: ${res.statusText}`);
                continue; 
            } else {
                // å…¶ä»–é”™è¯¯ (æ¯”å¦‚ 500 æœåŠ¡å™¨å´©äº†)ï¼Œé€šå¸¸æ¢ Key ä¹Ÿæ²¡ç”¨ï¼Œç›´æ¥æŠ›å‡º
                return res;
            }

        } catch (e) {
            // ç½‘ç»œæ–­äº†ç­‰å¼‚å¸¸ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            console.warn(`Key ${i+1} ç½‘ç»œå¼‚å¸¸ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ª...`);
            lastError = e;
        }
    }

    // å¦‚æœå¾ªç¯ç»“æŸè¿˜æ²¡è¿”å›ï¼Œè¯´æ˜æ‰€æœ‰ Key éƒ½æŒ‚äº†
    throw new Error("æ‰€æœ‰ Google Key éƒ½å·²è€—å°½æˆ–æ— æ•ˆï¼" + (lastError ? lastError.message : ""));
}
        // ==========================================
// --- 19. æƒ…ä¾£é£è¡Œæ£‹ (Ludo) æ ¸å¿ƒé€»è¾‘ ---
// ==========================================

// --- çŠ¶æ€ç®¡ç† ---
let ludoState = {
    charId: null,       // å½“å‰ä¸€èµ·ç©çš„è§’è‰²ID
    turn: 'user',       // 'user' æˆ– 'ai'
    status: 'idle',     // 'idle'(å¾…æŠ•æ·), 'moving'(ç§»åŠ¨ä¸­), 'task'(åšä»»åŠ¡ä¸­)
    userPos: -1,        // -1 ä»£è¡¨åœ¨åœæœºåªï¼Œ0-23 ä»£è¡¨æ£‹ç›˜æ ¼å­
    aiPos: -1,
    tasks: [],          // é¢˜åº“
    logs: [],           // æ¸¸æˆè®°å½•æ–‡æœ¬
    hasRolled6: { user: false, ai: false } // è®°å½•æ˜¯å¦å·²ç»æŠ•å‡ºè¿‡6(èµ·é£)
};

// é¢˜åº“æ•°æ®åº“å­˜å‚¨å
const ludoStoreName = "ludo_tasks";

// åˆå§‹åŒ– IndexedDB (Ludo) - è¿™ä¸€æ­¥éœ€è¦åˆå¹¶åˆ°åŸæ¥çš„ openDB å‡½æ•°é‡Œ
// è¯·ä¿®æ”¹ä¸Šé¢çš„ openDB å‡½æ•°ï¼ŒåŠ å…¥ ludoStoreName çš„åˆ›å»ºé€»è¾‘ï¼š
/*
    if (!db.objectStoreNames.contains("ludo_tasks")) {
        db.createObjectStore("ludo_tasks", { keyPath: "id", autoIncrement: true });
    }
*/
// (ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘åœ¨ä¸‹é¢å†™äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥å¤„ç†é¢˜åº“åŠ è½½)

// 1. å…¥å£ï¼šæ‰“å¼€é€‰äººå¼¹çª—
function openLudoSelectChar() {
    const list = document.getElementById('ludo-contact-list');
    list.innerHTML = '';
    
    if(contacts.length === 0) return alert("è¯·å…ˆåˆ›å»ºä¸€ä¸ªè§’è‰²ï¼");

    contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'ios-item';
        div.onclick = () => startLudoGame(c.id);
        div.innerHTML = `
            <img src="${c.avatar}" style="width:30px;height:30px;border-radius:50%;margin-right:10px;">
            <span class="ios-label" style="flex:1">${c.name}</span>
            <span style="color:#007AFF;">å¼€å§‹æ¸¸æˆ</span>
        `;
        list.appendChild(div);
    });
    openModal('modal-ludo-select');
}

// 2. å¼€å§‹æ¸¸æˆ
async function startLudoGame(charId) {
    closeModal('modal-ludo-select');
    ludoState.charId = charId;
    ludoState.userPos = -1;
    ludoState.aiPos = -1;
    ludoState.turn = 'user';
    ludoState.status = 'idle';
    ludoState.logs = [];
    ludoState.hasRolled6 = { user: false, ai: false };

    // åŠ è½½é¢˜åº“
    ludoState.tasks = await loadLudoTasksFromDB();

    navigateTo('page-ludo');
    renderLudoBoard();
    updateLudoUI();
    addLudoLog('system', `æ¸¸æˆå¼€å§‹ï¼ä½ å’Œ ${getLudoChar().name} éƒ½åœ¨èµ·ç‚¹ã€‚ç‚¹å‡»éª°å­å¼€å§‹ä½ çš„å›åˆã€‚è®°å¾—ï¼šåªæœ‰æŠ•å‡º 6 ç‚¹æ‰èƒ½èµ·é£å“¦ï¼`);
}

function getLudoChar() { return contacts.find(c => c.id === ludoState.charId); }

// 3. æ¸²æŸ“æ£‹ç›˜ (ç”Ÿæˆ24ä¸ªæ ¼å­)
function renderLudoBoard() {
    const grid = document.getElementById('ludo-grid');
    grid.innerHTML = '';

    // ç”Ÿæˆ S å‹è·¯å¾„çš„åæ ‡æ˜ å°„
    // 4åˆ— 6è¡Œ
    // Row 0: 0->1->2->3
    // Row 1: 7<-6<-5<-4
    // Row 2: 8->9->10->11 ...
    
    for(let i=0; i<24; i++) {
        const div = document.createElement('div');
        div.className = 'ludo-cell';
        div.id = `cell-${i}`;
        div.innerText = i + 1; // æ˜¾ç¤ºæ•°å­—
        if(i === 23) {
            div.classList.add('finish');
            div.innerText = "ç»ˆ";
        }
        
        // è®¡ç®— CSS Grid çš„ä½ç½®ï¼Œå®ç° S å‹æ’åˆ—
        const row = Math.floor(i / 4);
        let col = i % 4;
        
        // å¥‡æ•°è¡Œ(1,3,5)éœ€è¦åå‘
        if (row % 2 === 1) {
            col = 3 - col; // 0->3, 1->2, 2->1, 3->0
        }

        // grid-column/row æ˜¯ä»1å¼€å§‹çš„
        div.style.gridRow = row + 1;
        div.style.gridColumn = col + 1;

        grid.appendChild(div);
    }

    // æ¸²æŸ“åœæœºåªå¤´åƒ
    const char = getLudoChar();
    document.getElementById('pawn-user-base').innerHTML = `<img src="${char.userAvatar}" class="ludo-pawn user" id="pawn-user" style="position:static;">`;
    document.getElementById('pawn-ai-base').innerHTML = `<img src="${char.avatar}" class="ludo-pawn ai" id="pawn-ai" style="position:static;">`;
}

// 4. éª°å­é€»è¾‘
function userRollDice() {
    if(ludoState.turn !== 'user' || ludoState.status !== 'idle') return;
    performRoll('user');
}

function aiRollDice() {
    setTimeout(() => {
        performRoll('ai');
    }, 1500); // AI æ€è€ƒæ—¶é—´
}

function performRoll(who) {
    ludoState.status = 'rolling';
    const dice = document.getElementById('ludo-dice');
    
    // åŠ¨ç”»
    dice.classList.add('dice-rolling');
    
    // éšæœºç»“æœ
    setTimeout(() => {
        dice.classList.remove('dice-rolling');
        const point = Math.floor(Math.random() * 6) + 1;
        
        // è®¾å®šéª°å­é¢æœå‘ (ç®€å•çš„ transform ä¿®æ”¹)
        const transforms = [
            'rotateX(0) rotateY(0)',   // 1
            'rotateX(90deg) rotateY(0)', // 2 (bottom) 
            'rotateY(-90deg)', // 3
            'rotateY(90deg)',  // 4
            'rotateX(-90deg)', // 5
            'rotateX(180deg)'  // 6
        ];
        // ç®€å•æ˜ å°„ï¼Œå®é™…3Déª°å­é¢éœ€è¦ç²¾ç»†å¯¹åº”ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåªä¿è¯æ—‹è½¬åœæ­¢
        // ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠç‚¹æ•°å†™åœ¨æ­£é¢çš„ div ä¸Šï¼Œç„¶åè½¬å›æ­£é¢
        dice.querySelector('.front').innerText = point;
        dice.style.transform = 'rotateX(0) rotateY(0)'; 

        handleRollResult(who, point);

    }, 800);
}

function handleRollResult(who, point) {
    const name = who === 'user' ? 'ä½ ' : getLudoChar().name;
    addLudoLog('system', `${name} æ·å‡ºäº† ${point} ç‚¹`);

    const currentPos = ludoState[who + 'Pos'];
    const hasTakenOff = ludoState.hasRolled6[who];

    // è§„åˆ™ 1: æœªèµ·é£æ—¶ï¼Œå¿…é¡»æŠ• 6
    if (!hasTakenOff) {
        if (point === 6) {
            ludoState.hasRolled6[who] = true;
            ludoState[who + 'Pos'] = 0; // ç§»åŠ¨åˆ°èµ·ç‚¹ (ç¬¬1æ ¼)
            addLudoLog('system', `âœˆï¸ ${name} èµ·é£æˆåŠŸï¼ç§»åŠ¨åˆ°ç¬¬ 1 æ ¼ã€‚`);
            updatePawnPosition();
            checkTileTask(who, 0); // æ£€æŸ¥èµ·ç‚¹æœ‰æ²¡æœ‰ä»»åŠ¡ï¼ˆé€šå¸¸æ²¡æœ‰ï¼Œä½†ä¸ºäº†é€»è¾‘ç»Ÿä¸€ï¼‰
        } else {
            addLudoLog('system', `âŒ æ²¡æŠ•åˆ° 6ï¼Œæ— æ³•èµ·é£ã€‚è½®ç©ºã€‚`);
            nextTurn();
        }
        return;
    }

    // è§„åˆ™ 2: å·²èµ·é£ï¼Œæ­£å¸¸ç§»åŠ¨
    let newPos = currentPos + point;

    // è§„åˆ™ 3: åˆ°è¾¾ç»ˆç‚¹ (>= 23)
    if (newPos >= 23) {
        ludoState[who + 'Pos'] = 23;
        updatePawnPosition();
        endGame(who);
        return;
    }

    // ç§»åŠ¨åŠ¨ç”»
    ludoState[who + 'Pos'] = newPos;
    updatePawnPosition();

    // è§„åˆ™ 4: æ’è½¦æ£€æµ‹
    const other = who === 'user' ? 'ai' : 'user';
    if (ludoState[other + 'Pos'] === newPos) {
        // æ’è½¦äº†ï¼
        const otherName = who === 'user' ? getLudoChar().name : 'ä½ ';
        addLudoLog('system', `æ’è½¦äº†ï¼${otherName} è¢«æ’å›äº†åœæœºåªï¼`);
        
        ludoState[other + 'Pos'] = -1;
        ludoState.hasRolled6[other] = false; // æƒ¨ï¼Œè¦é‡æ–°æŠ•6
        updatePawnPosition();
        
        // è§¦å‘æ’è½¦åçš„ç‰¹æ®Šå¯¹è¯
        if(who === 'user') {
            // æˆ‘æ’äº†AIï¼ŒAIç”Ÿæ°”
            triggerLudoAI(`æˆ‘æŠŠä½ æ’å›èµ·ç‚¹äº†ï¼å“ˆå“ˆï¼`, "crash_victim");
        } else {
            // AIæ’äº†æˆ‘ï¼ŒAIå¾—æ„
            triggerLudoAI(`æˆ‘æŠŠä½ æ’å›èµ·ç‚¹äº†ï¼ä¸å¥½æ„æ€å•¦~`, "crash_attacker");
        }
    }

    // è§¦å‘æ ¼å­ä»»åŠ¡
    setTimeout(() => checkTileTask(who, newPos), 500);
}

// 5. ä»»åŠ¡è§¦å‘é€»è¾‘
function checkTileTask(who, pos) {
    // ä»é¢˜åº“è·å–é¢˜ç›®ï¼Œå¦‚æœé¢˜åº“ç©ºï¼Œå°±éšæœºç”Ÿæˆä¸€ä¸ªç®€å•çš„
    let taskContent = "";
    if(ludoState.tasks.length > 0) {
        // ç®€å•çš„å“ˆå¸Œæ˜ å°„ï¼šç”¨æ ¼å­åºå·å–æ¨¡
        const taskObj = ludoState.tasks[pos % ludoState.tasks.length];
        taskContent = taskObj.content || taskObj.text;
    } else {
        taskContent = "è‡ªç”±å‘æŒ¥ï¼šè¯´ä¸€å¥åœŸå‘³æƒ…è¯";
    }

    addLudoLog('task', `[ç¬¬ ${pos+1} æ ¼ä»»åŠ¡]: ${taskContent}`);
    ludoState.status = 'task';
    
    updateLudoUI(); // æ˜¾ç¤ºâ€œå®Œæˆä»»åŠ¡â€æŒ‰é’®

    // å¦‚æœæ˜¯ AI çš„å›åˆï¼ŒAI è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡
    if(who === 'ai') {
        // å»¶è¿Ÿä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿæ€è€ƒ
        setTimeout(() => {
            triggerLudoAI(`æˆ‘ç°åœ¨åœ¨ç¬¬ ${pos+1} æ ¼ã€‚ä»»åŠ¡æ˜¯ï¼š${taskContent}ã€‚è¯·æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚`, "do_task");
        }, 1500);
    } else {
        // å¦‚æœæ˜¯ç”¨æˆ·çš„å›åˆï¼Œç­‰å¾…ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥
        addLudoLog('system', 'è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å®Œæˆä»»åŠ¡ï¼Œæˆ–ä¸å¯¹æ–¹äº’åŠ¨ã€‚å®Œæˆåç‚¹å‡»â€œå®Œæˆæœ¬é¢˜â€ã€‚');
    }
}

// 6. åˆ‡æ¢å›åˆ
function nextTurn() {
    ludoState.status = 'idle';
    ludoState.turn = ludoState.turn === 'user' ? 'ai' : 'user';
    updateLudoUI();
    
    if(ludoState.turn === 'ai') {
        aiRollDice();
    }
}

function updateLudoUI() {
    const statusDiv = document.getElementById('ludo-status');
    const finishBtn = document.getElementById('btn-finish-task');
    
    if (ludoState.status === 'task') {
        statusDiv.innerText = "ç­‰å¾…æ‰§è¡Œä»»åŠ¡...";
        finishBtn.style.display = 'block';
        
        // å¦‚æœæ˜¯ AI å›åˆï¼ŒæŒ‰é’®å˜ç°ï¼ˆå› ä¸ºAIä¼šè‡ªåŠ¨å®Œæˆï¼‰
        if(ludoState.turn === 'ai') {
             finishBtn.disabled = true;
             finishBtn.innerText = "Ta æ­£åœ¨æ‰§è¡Œ...";
        } else {
             finishBtn.disabled = false;
             finishBtn.innerText = "å®Œæˆæœ¬é¢˜";
        }
    } else {
        finishBtn.style.display = 'none';
        if(ludoState.turn === 'user') {
            statusDiv.innerText = "è½®åˆ°ä½ äº†ï¼ç‚¹å‡»éª°å­";
        } else {
            statusDiv.innerText = "ç­‰å¾… Ta æŠ•æ·...";
        }
    }
}

function finishCurrentTask() {
    if(ludoState.status !== 'task') return;
    
    // å¦‚æœæ˜¯ç”¨æˆ·ç‚¹å‡»å®Œæˆ
    if(ludoState.turn === 'user') {
        addLudoLog('system', 'ä½ å®Œæˆäº†ä»»åŠ¡ã€‚');
        nextTurn();
    }
}

// 7. æ›´æ–°æ£‹å­ä½ç½® UI
function updatePawnPosition() {
    const userPawn = document.getElementById('pawn-user');
    const aiPawn = document.getElementById('pawn-ai');
    
    // è¾…åŠ©ï¼šæŠŠæ£‹å­ç§»åŠ¨åˆ°æŒ‡å®šå®¹å™¨
    const move = (pawn, pos, type) => {
        if (pos === -1) {
            // å›åˆ°åœæœºåª
            document.getElementById(`pawn-${type}-base`).appendChild(pawn);
        } else {
            // æ”¾åˆ°æ ¼å­é‡Œ
            const cell = document.getElementById(`cell-${pos}`);
            if(cell) {
                cell.appendChild(pawn);
                // è®¾ä¸º relative/absolute é…åˆ CSS åŠ¨ç”»ï¼Œè¿™é‡Œç®€å• appendChild ä¼šè‡ªåŠ¨å®šä½
            }
        }
    };

    move(userPawn, ludoState.userPos, 'user');
    move(aiPawn, ludoState.aiPos, 'ai');
}

// 8. èŠå¤©ä¸ AI äº’åŠ¨
async function sendLudoMsg() {
    const input = document.getElementById('ludoInput');
    const txt = input.value.trim();
    if(!txt) return;

    addLudoLog('user', txt);
    input.value = '';

    // è§¦å‘ AI å›å¤
    triggerLudoAI(txt, "chat");
}

// --- å‡çº§ç‰ˆ AI äº’åŠ¨å‡½æ•° (å·²ä¿®å¤ Google Key æ‰çº¿é—®é¢˜) ---
async function triggerLudoAI(userContent, contextType) {
    const char = getLudoChar();
    // è¿™é‡Œçš„æ ¡éªŒæ”¹å®½ä¸€ç‚¹ï¼Œåªè¦æ˜¯ Google æ¨¡å¼æˆ–è€…æœ‰ Key å°±å¯ä»¥
    if(globalConfig.provider !== 'google' && !globalConfig.apiKey) return; 

    // 1. è·å–ä¸»èŠå¤©è®°å½• (æœ€è¿‘10æ¡å³å¯ï¼Œå¤ªå¤šå®¹æ˜“å¹²æ‰°)
    const mainHistory = char.messages.slice(-10).map(m => ({
        role: m.role,
        content: m.content
    }));

    // 2. æ„å»ºæ¸¸æˆçŠ¶æ€æè¿°
    const boardStatus = `
    [å½“å‰æ¸¸æˆå®æ—¶çŠ¶æ€]
    ä½ çš„ä½ç½®ï¼š${ludoState.aiPos === -1 ? 'åœæœºåª' : 'ç¬¬'+(ludoState.aiPos+1)+'æ ¼'}ã€‚
    ç”¨æˆ·ä½ç½®ï¼š${ludoState.userPos === -1 ? 'åœæœºåª' : 'ç¬¬'+(ludoState.userPos+1)+'æ ¼'}ã€‚
    å½“å‰å›åˆï¼š${ludoState.turn === 'user' ? 'ç”¨æˆ·' : 'ä½ '}ã€‚
    `;

    // 3. è·å–æ¸¸æˆå†…çš„å³æ—¶è®°å½•
    const gameLogs = ludoState.logs.slice(-6).map(l => `[åˆšåˆšå‘ç”Ÿäº†]: ${l.content}`).join('\n');

    // 4. æ ¸å¿ƒç³»ç»ŸæŒ‡ä»¤ (å¼ºé€»è¾‘ç‰ˆ)
    let systemInstruction = `
    ä½ æ­£åœ¨å’Œç”¨æˆ·ç©â€œé£è¡Œæ£‹â€æ¸¸æˆã€‚ä½ çš„è§’è‰²ï¼š${char.name}ã€‚äººè®¾ï¼š${char.systemPrompt}
    
    ${boardStatus}
    
    ã€å›å¤é€»è¾‘æŒ‡å—ã€‘ï¼š
    - "do_task": è½®åˆ°ä½ åšä»»åŠ¡ï¼Œè¯·æ‰§è¡Œä»»åŠ¡ï¼ˆè¯´è¯æˆ–åŠ¨ä½œï¼‰ã€‚å®Œæˆåæœ«å°¾åŠ  "[DONE]"ã€‚
    - "crash_victim": ä½ è¢«æ’å›èµ·ç‚¹äº†ï¼Œè¯·è¡¨ç°å‡ºç”Ÿæ°”ã€æ’’å¨‡æˆ–æ”¾ç‹ è¯ã€‚
    - "crash_attacker": ä½ æ’é£äº†ç”¨æˆ·ï¼Œè¯·è¡¨ç°å¾—å¾—æ„æˆ–è°ƒä¾ƒã€‚
    - "chat": æ­£å¸¸é—²èŠã€‚
    `;

    // 5. ç»„è£…æœ€ç»ˆæ¶ˆæ¯åˆ—è¡¨
    const apiMessages = [
        { role: "system", content: systemInstruction },
        ...mainHistory, 
        { role: "system", content: `
        -------------------------------------------------------------
        ã€ç³»ç»Ÿæç¤ºã€‘ï¼š
        ä»¥ä¸Šæ˜¯ä¹‹å‰çš„èŠå¤©è®°å½•ï¼ˆä»…ä½œä¸ºæ¸¸æˆä¹‹å‰çš„è¯­æ°”å’ŒèŠå¤©å†…å®¹å‚è€ƒï¼‰ã€‚
        ç°åœ¨ï¼Œé‚£äº›å¯¹è¯å·²ç»æš‚åœã€‚ä½ ä»¬æ­£åœ¨è¿›è¡Œæ¿€çƒˆçš„é£è¡Œæ£‹å¯¹æˆ˜ã€‚
        è¯·ç«‹åˆ»è¿›å…¥æ¸¸æˆçŠ¶æ€ï¼ä¹‹å‰çš„è¯é¢˜ä»…åœ¨èŠåˆ°ç±»ä¼¼è¯é¢˜æ—¶ä¸€ç¬”å¸¦è¿‡ï¼Œä¸“æ³¨äºå½“ä¸‹çš„æ¸¸æˆäº’åŠ¨ã€‚
        -------------------------------------------------------------
        ã€æ¸¸æˆå†…æœ€æ–°åŠ¨æ€ã€‘ï¼š
        ${gameLogs}
        `},
        { role: "user", content: userContent }
    ];

    try {
        // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šæ”¹ç”¨ fetchWithRetry ğŸ”¥ğŸ”¥ğŸ”¥
        // è¿™æ ·å®ƒå°±ä¼šè‡ªåŠ¨å»ä½ çš„ Google Key åˆ—è¡¨é‡Œæ‰¾èƒ½ç”¨çš„ Keyï¼Œè€Œä¸æ˜¯å‚»å‚»åœ°ç”¨ç©º Key
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: apiMessages,
            temperature: 0.8
        });

        if (!res.ok) throw new Error("è¿æ¥æ–­å¼€");

        const data = await res.json();
        let reply = data.choices[0].message.content;
        
        let isTaskDone = false;
        if (reply.includes("[DONE]")) {
            isTaskDone = true;
            reply = reply.replace("[DONE]", "").trim();
        }

        addLudoLog('ai', reply);
        if (contextType === "do_task" || isTaskDone) {
             setTimeout(nextTurn, 2000);
        }

    } catch(e) {
        console.error(e);
        addLudoLog('system', 'AI æ‰çº¿äº†... (è¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œ)');
        // å¦‚æœæ˜¯åšä»»åŠ¡é€”ä¸­æ‰çº¿ï¼Œå¼ºåˆ¶è·³è¿‡å›åˆï¼Œé˜²æ­¢å¡æ­»
        if (contextType === "do_task") nextTurn(); 
    }
}

function addLudoLog(role, text) {
    const container = document.getElementById('ludo-log');
    const div = document.createElement('div');
    div.className = `ludo-msg ${role}`;
    
    // å¦‚æœæ˜¯ä»»åŠ¡ï¼ŒåŠ ä¸ªæ ‡é¢˜æ ·å¼
    if(role === 'task') {
        div.innerHTML = text;
    } else if (role === 'ai') {
        const char = getLudoChar();
        div.innerHTML = `<b>${char.name}:</b> ${text}`;
    } else if (role === 'user') {
        div.innerHTML = `<b>æˆ‘:</b> ${text}`;
    } else {
        div.innerHTML = text;
    }
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    // å­˜å…¥å†…å­˜è®°å½•
    ludoState.logs.push({ role, content: text });
}

// å¢å¼ºç‰ˆï¼šæ¸¸æˆç»“æŸç»“ç®—
async function endGame(winner) {
    const char = getLudoChar();
    const winnerName = winner === 'user' ? 'æˆ‘' : char.name;
    const loserName = winner === 'user' ? char.name : 'æˆ‘';
    
    alert(`ğŸ‰ æ¸¸æˆç»“æŸï¼${winnerName} è·èƒœï¼`);

    // 1. æ•´ç†æ¸¸æˆè¿‡ç¨‹ä¸­çš„é«˜å…‰æ—¶åˆ»ï¼ˆä»æ—¥å¿—é‡Œæå–ï¼‰
    // è¿‡æ»¤å‡ºåšä»»åŠ¡(task)å’Œæ’è½¦(systemåŒ…å«"æ’")çš„è®°å½•ï¼Œæœ€å¤šå– 3 æ¡
    const highlights = ludoState.logs
        .filter(l => l.role === 'task' || (l.role === 'system' && l.content.includes('æ’')))
        .slice(-3)
        .map(l => l.content)
        .join('; ');

    // 2. ç”Ÿæˆä¸€æ®µåƒæ ·çš„æ€»ç»“æŠ¥å‘Š
    const summary = `
ğŸ®ã€é£è¡Œæ£‹å¯¹æˆ˜æˆ˜æŠ¥ã€‘
------------------
ğŸ† èƒœæ–¹ï¼š${winnerName}
ğŸ˜­ è´¥æ–¹ï¼š${loserName}
ğŸ“ ç²¾å½©å›é¡¾ï¼š${highlights || "è¿™æ˜¯ä¸€åœºå’Œå¹³çš„æ¯”èµ›"}
------------------
(ç³»ç»Ÿæç¤ºï¼šè¯·${char.name}æ ¹æ®èƒœè´Ÿç»“æœï¼Œå¯¹ç”¨æˆ·å‘è¡¨è·èƒœæ„Ÿè¨€æˆ–æ’’å¨‡è€èµ–æ±‚å®‰æ…°ã€‚)
    `.trim();

    // 3. å­˜å…¥ä¸»èŠå¤©è®°å½• (ä½œä¸º user æ¶ˆæ¯å‘ç»™ AIï¼Œè¯±å¯¼å®ƒå›å¤)
    char.messages.push({
        role: 'user', 
        content: summary,
        timestamp: Date.now()
    });
    saveData();

    // 4. è¿”å›ä¸»é¡µ
    goHome();
    
    // 5. è®© AI åœ¨èŠå¤©ç•Œé¢å›å¤ä½ 
    // å› ä¸ºæˆ‘ä»¬åˆšæ‰ push äº†ä¸€æ¡æ¶ˆæ¯ï¼Œç°åœ¨åˆ‡æ¢å›èŠå¤©ç•Œé¢ï¼ŒAI ä¼šçœ‹åˆ°æˆ˜æŠ¥å¹¶å›å¤
    activeContactId = char.id;
    navigateTo('page-chat');
    triggerAI(); 
}



async function loadLudoTasksFromDB() {
    const db = await openDB();
    // æ£€æŸ¥ store æ˜¯å¦å­˜åœ¨
    if (!db.objectStoreNames.contains("ludo_tasks")) return [];
    
    return new Promise(resolve => {
        const tx = db.transaction("ludo_tasks", "readonly");
        const store = tx.objectStore("ludo_tasks");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve([]);
    });
}
        // ==========================================
// --- é£è¡Œæ£‹é¢˜åº“ç®¡ç†ç³»ç»Ÿ (å‡çº§ç‰ˆ) ---
// ==========================================

let savedBanks = []; // å­˜å‚¨æ‰€æœ‰é¢˜åº“ [{name: "çƒ­æ‹ç‰ˆ", tasks: [...]}]

// 1. åˆå§‹åŒ–åŠ è½½
function loadSavedBanks() {
    const s = localStorage.getItem('ludo_saved_banks');
    if(s) savedBanks = JSON.parse(s);
}
// é¡µé¢åŠ è½½æ—¶è¿è¡Œ
window.addEventListener('load', loadSavedBanks);

function saveBanksToStorage() {
    localStorage.setItem('ludo_saved_banks', JSON.stringify(savedBanks));
}

// 2. æ‰“å¼€é¢˜åº“å¼¹çª—
function openLudoLibrary() {
    renderLudoLibraryList();
    openModal('modal-ludo-library');
}

// 3. æ¸²æŸ“åˆ—è¡¨ (ä¼˜åŒ–ç‰ˆï¼šåˆ é™¤æŒ‰é’®åœ¨å³ä¾§)
function renderLudoLibraryList() {
    const list = document.getElementById('ludo-library-list');
    list.innerHTML = '';

    if(savedBanks.length === 0) {
        list.innerHTML = `<div style="padding:15px; text-align:center; color:#999;">æš‚æ— é¢˜åº“ï¼Œè¯·ç‚¹å‡»å·¦ä¸Šè§’ + å¯¼å…¥</div>`;
        return;
    }

    savedBanks.forEach((bank, index) => {
        const div = document.createElement('div');
        div.className = 'ios-item'; // è¿™ä¸ªç±»æœ¬èº«å°±æ˜¯ flex å¸ƒå±€ï¼Œæ”¯æŒå·¦å³å¯¹é½
        
        // æ ¸å¿ƒä¿®æ”¹ï¼š
        // å·¦è¾¹ div (flex:1) å æ®å¤§éƒ¨åˆ†ç©ºé—´ï¼Œç‚¹å‡»åº”ç”¨
        // å³è¾¹ button (width:auto) æ”¾åƒåœ¾æ¡¶å›¾æ ‡
        div.innerHTML = `
            <div style="flex:1; cursor:pointer; min-width:0;" onclick="applyBank(${index})">
                <div style="font-weight:600; font-size:16px; color:#000; margin-bottom:2px;">${bank.name}</div>
                <div style="font-size:12px; color:#8e8e93;">å…± ${bank.tasks.length} é¢˜</div>
            </div>
            
            <button onclick="deleteBank(${index})" 
                    style="background:transparent; border:none; font-size:18px; padding:10px; color:#ff3b30; cursor:pointer; margin-left:10px;">
                x
            </button>
        `;
        list.appendChild(div);
    });
}

// 4. å¤„ç†æ–°æ–‡ä»¶å¯¼å…¥ (ç‚¹å‡»+å·é€‰å®Œæ–‡ä»¶åè§¦å‘)
async function handleNewBankImport(e) {
    const file = e.target.files[0];
    if(!file) return;

    try {
        const text = await file.text();
        let tasks = [];
        
        // è§£ææ–‡ä»¶
        if(file.name.endsWith('.json')) {
            const raw = JSON.parse(text);
            // å…¼å®¹æ€§å¤„ç†ï¼šæŠŠå„ç§æ ¼å¼ç»Ÿä¸€æ¸…æ´—ä¸º {content: "xxx"}
            tasks = raw.map(item => ({ content: item.content || item.text || item }));
        } else {
            // TXT å¤„ç†
            tasks = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => ({ content: line }));
        }

        if(tasks.length === 0) throw new Error("æ–‡ä»¶é‡Œå¥½åƒæ²¡æœ‰å†…å®¹ï¼Ÿ");

        // è¯¢é—®é¢˜åº“åå­—
        const bankName = prompt(`æˆåŠŸè¯†åˆ« ${tasks.length} é“é¢˜ï¼\nè¯·ç»™è¿™ä¸ªé¢˜åº“èµ·ä¸ªåå­—ï¼š`, file.name.replace(/\.(json|txt)$/i, ""));
        
        if(!bankName) return; // ç”¨æˆ·å–æ¶ˆ

        // ä¿å­˜åˆ°åˆ—è¡¨
        savedBanks.push({
            id: Date.now(),
            name: bankName,
            tasks: tasks
        });
        saveBanksToStorage();
        
        // åˆ·æ–°åˆ—è¡¨
        renderLudoLibraryList();
        
        // è¯¢é—®æ˜¯å¦ç«‹å³åº”ç”¨
        if(confirm("å¯¼å…¥æˆåŠŸï¼æ˜¯å¦ç«‹å³ä½¿ç”¨è¿™ä¸ªé¢˜åº“ï¼Ÿ")) {
            applyBank(savedBanks.length - 1);
        }

    } catch(err) {
        alert("å¯¼å…¥å‡ºé”™: " + err.message);
    } finally {
        e.target.value = ''; // æ¸…ç©º inputï¼Œå…è®¸ä¸‹æ¬¡é€‰åŒåæ–‡ä»¶
    }
}

// 5. åº”ç”¨é¢˜åº“ (æ ¸å¿ƒåŠŸèƒ½)
async function applyBank(index) {
    const bank = savedBanks[index];
    if(!bank) return;

    const btn = document.querySelector('#modal-ludo-library .modal-body'); // éšä¾¿æ‰¾ä¸ªåœ°æ–¹æ˜¾ç¤ºloadingæ•ˆæœä¸å¤ªå¥½åšï¼Œç›´æ¥å¼¹çª—å§
    
    try {
        // 1. è·å–æ•°æ®åº“
        const db = await openDB();
        const tx = db.transaction("ludo_tasks", "readwrite");
        const store = tx.objectStore("ludo_tasks");

        // 2. æ¸…ç©ºå½“å‰çš„â€œæ¿€æ´»é¢˜åº“â€
        await new Promise((resolve, reject) => {
            const req = store.clear();
            req.onsuccess = resolve;
            req.onerror = reject;
        });

        // 3. å†™å…¥æ–°é¢˜åº“
        // è¿™é‡Œå¿…é¡»å†å¼€ä¸€ä¸ªäº‹åŠ¡ï¼Œæˆ–è€…æ¥ç€ç”¨ä¸Šé¢çš„ï¼Ÿä¸ºäº†ç¨³å¦¥ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯é‡Œå¤ç”¨
        // æ³¨æ„ï¼šIndexedDB çš„ clear() æ˜¯å¼‚æ­¥çš„ï¼Œè¦åœ¨ success åå† add
        // ç®€å•å†™æ³•ï¼šç›´æ¥ç”¨ä¸Šé¢çš„ tx åº”è¯¥æ²¡é—®é¢˜ï¼Œå› ä¸ºæ˜¯ä¸²è¡Œçš„
        
        bank.tasks.forEach(task => {
            store.put({ id: Date.now() + Math.random(), content: task.content });
        });

        // 4. ç­‰å¾…äº‹åŠ¡å®Œæˆ
        tx.oncomplete = async () => {
            // 5. åˆ·æ–°æ¸¸æˆå†…å­˜é‡Œçš„ tasks å˜é‡
            ludoState.tasks = await loadLudoTasksFromDB();
            
            // 6. UI åé¦ˆ
            closeModal('modal-ludo-library');
            addLudoLog('system', `å·²åˆ‡æ¢é¢˜åº“ä¸ºï¼šã€Š${bank.name}ã€‹`);
            alert(`åº”ç”¨æˆåŠŸï¼å½“å‰ä½¿ç”¨ï¼šã€Š${bank.name}ã€‹`);
        };

    } catch(e) {
        console.error(e);
        alert("åº”ç”¨å¤±è´¥ï¼š" + e.message);
    }
}

// 6. åˆ é™¤é¢˜åº“
function deleteBank(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªé¢˜åº“å—ï¼Ÿ")) {
        savedBanks.splice(index, 1);
        saveBanksToStorage();
        renderLudoLibraryList();
    }
}
        // ==========================================
// --- 20. å‰§åœºæ¨¡å¼ (Theater Mode) åŸºç¡€é€»è¾‘ ---
// ==========================================

// ========================================================
// ğŸ­ å‰§åœºæ¨¡å¼ 2.0ï¼šå¤šå‰§æœ¬åˆ—è¡¨ç‰ˆ (æ•°æ®ç»“æ„å‡çº§)
// ========================================================

// 1. æ–°çš„çŠ¶æ€ç®¡ç†
let theaterState = {
    config: { apiUrl: "", apiKey: "", model: "" },
    preset: { name: "æœªåŠ è½½", core: [], styles: [], modules: [], activeStyleId: null, activeModules: [], worldInfo: [], regexScripts: [] },
    
    // --- æ–°å¢ï¼šå½“å‰æ­£åœ¨ç©çš„å‰§æœ¬ ID ---
    currentScriptId: null, 
    
    // ä¾ç„¶ä¿ç•™è¿™ä¸ª logs å˜é‡ä½œä¸ºâ€œå½“å‰è¿è¡Œä¸­çš„ç¼“å­˜â€ï¼Œæ–¹ä¾¿ API å‡½æ•°è°ƒç”¨
    logs: [] 
};
        
// æ‰€æœ‰çš„å‰§æœ¬æ•°æ® (ä» localStorage è¯»å–)
// æ ¼å¼: [{ id, title, charId, logs: [], lastModified: timestamp }]
let allScripts = [];

// ========================================================
// 2. å…¥å£æ”¹å†™
// ========================================================

// åˆå§‹åŒ–ï¼šä¸å†ç›´æ¥è¿›èˆå°ï¼Œè€Œæ˜¯è¿›åˆ—è¡¨
initTheaterMode = function() {
    loadTheaterConfig();
    loadAllScripts(); // åŠ è½½åˆ—è¡¨æ•°æ®
    renderScriptList(); // æ¸²æŸ“åˆ—è¡¨UI
    navigateTo('page-theater-list'); // è·³è½¬åˆ°åˆ—è¡¨é¡µ
}

// åŠ è½½æ‰€æœ‰å‰§æœ¬
function loadAllScripts() {
    const s = localStorage.getItem('theater_all_scripts');
    if(s) {
        allScripts = JSON.parse(s);
    } else {
        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœç”¨æˆ·ä¹‹å‰æœ‰å•å‰§æœ¬æ•°æ®ï¼ŒæŠŠå®ƒè¿ç§»è¿‡æ¥
        const oldLogs = localStorage.getItem('theater_chat_logs');
        if(oldLogs) {
            const logs = JSON.parse(oldLogs);
            if(logs.length > 0) {
                // åˆ›å»ºä¸€ä¸ªâ€œæ—§å­˜æ¡£â€
                const defaultCharId = contacts.length > 0 ? contacts[0].id : null;
                const migrationScript = {
                    id: 'script_' + Date.now(),
                    title: "æ—§çš„å­˜æ¡£",
                    charId: defaultCharId,
                    logs: logs,
                    lastModified: Date.now()
                };
                allScripts.push(migrationScript);
                saveAllScripts();
                localStorage.removeItem('theater_chat_logs'); // æ¸…ç†æ—§æ•°æ®
            }
        }
    }
}

function saveAllScripts() {
    localStorage.setItem('theater_all_scripts', JSON.stringify(allScripts));
}

// æ¸²æŸ“åˆ—è¡¨ (ä»¿æˆªå›¾)
function renderScriptList() {
    const container = document.getElementById('theater-list-container');
    container.innerHTML = '';

    if(allScripts.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">æš‚æ— å‰§æœ¬<br>ç‚¹å‡»å³ä¸Šè§’ + å¼€å§‹</div>`;
        return;
    }

    // æŒ‰æ—¶é—´å€’åº
    const sorted = [...allScripts].sort((a,b) => b.lastModified - a.lastModified);

    sorted.forEach(script => {
        // è·å–ä¸»è§’å¤´åƒå’Œåå­—
        const char = contacts.find(c => c.id === script.charId);
        const avatarUrl = char ? char.avatar : 'https://api.dicebear.com/7.x/shapes/svg?seed=Unknown';
        const charName = char ? char.name : 'æœªçŸ¥è§’è‰²';
        
        // è·å–é¢„è§ˆæ–‡å­— (æœ€åä¸€æ¡å†…å®¹)
        const lastLog = script.logs.length > 0 ? script.logs[script.logs.length-1].content : "æ— å†…å®¹";
        // æ¸…æ´—ä¸€ä¸‹é¢„è§ˆæ–‡å­— (å»æ‰æ¢è¡Œç¬¦)
        const previewText = lastLog.replace(/<[^>]+>/g, '').substring(0, 50); // ç®€å•å»æ ‡ç­¾

        // æ ¼å¼åŒ–æ—¶é—´
        const date = new Date(script.lastModified);
        const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;

        const div = document.createElement('div');
        div.className = 'script-item';
        div.onclick = (e) => {
            // å¦‚æœç‚¹çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è¿›å‰§æœ¬
            if(e.target.classList.contains('btn-del-script')) return;
            openScript(script.id);
        };

        div.innerHTML = `
            <div class="script-avatar-box">
                <img src="${avatarUrl}" class="script-avatar">
            </div>
            <div class="script-info">
                <div class="script-header">
                    <span class="script-title">${charName} - ${script.title}</span>
                    <span class="script-time">${timeStr}</span>
                </div>
                <div class="script-preview">${previewText}</div>
            </div>
            <button class="btn-del-script" onclick="deleteScript('${script.id}')">Ã—</button>
        `;
        container.appendChild(div);
    });
}

// ========================================================
// 3. äº¤äº’é€»è¾‘ï¼šæ–°å»ºä¸æ‰“å¼€
// ========================================================

// æ–°å»ºå‰§æœ¬ (å…ˆé€‰äººï¼Œå†èµ·å)
function createNewScript() {
    if(contacts.length === 0) return alert("è¯·å…ˆåœ¨ä¿¡æ¯åˆ—è¡¨åˆ›å»ºè§’è‰²ï¼");
    
    // å¼¹çª—è®©ç”¨æˆ·è¾“å…¥æ ‡é¢˜
    const title = prompt("ç»™æ–°å‰§æœ¬èµ·ä¸ªåå­—ï¼š", "æœªå‘½åå‰§æœ¬");
    if(!title) return;

    // é€‰æ‹©è§’è‰² (é»˜è®¤ç”¨å½“å‰æ´»è·ƒè§’è‰²æˆ–ç¬¬ä¸€ä¸ª)
    let charId = activeContactId;
    if(!charId) {
        charId = contacts[0].id;
        alert(`æœªé€‰æ‹©å½“å‰è§’è‰²ï¼Œé»˜è®¤ä½¿ç”¨ï¼š${contacts[0].name}`);
    }

    const newScript = {
        id: 'script_' + Date.now(),
        title: title,
        charId: charId,
        logs: [], // ç©ºè®°å½•
        lastModified: Date.now()
    };

    allScripts.unshift(newScript);
    saveAllScripts();
    openScript(newScript.id); // ç›´æ¥è¿›å…¥
}

// æ‰“å¼€å…·ä½“å‰§æœ¬ (è¿›å…¥èˆå°)
function openScript(scriptId) {
    const script = allScripts.find(s => s.id === scriptId);
    if(!script) return;

    // 1. æ›´æ–°å…¨å±€çŠ¶æ€
    theaterState.currentScriptId = scriptId;
    theaterState.logs = script.logs; // åŠ è½½è¿™ä¸ªå‰§æœ¬çš„æ—¥å¿—
    
    // 2. åŠ è½½é¢„è®¾
    loadTheaterState(); 

    // 3. è®¾ç½® UI
    const char = contacts.find(c => c.id === script.charId);
    document.getElementById('theater-title').innerText = script.title;
    
    // å¦‚æœè§’è‰²ä¸å­˜åœ¨äº†ï¼Œç”¨é»˜è®¤å
    const charName = char ? char.name : "æœªçŸ¥";
    
    // æ¸²æŸ“èˆå°å†…å®¹
    const stage = document.getElementById('theater-stage');
    stage.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€åœºæˆ
    
    theaterState.logs.forEach(log => {
        const displayName = log.role === 'user' ? "æˆ‘" : charName;
        appendTheaterLog(log.role, log.content, displayName);
    });

    // 4. è·³è½¬
    navigateTo('page-theater');
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
        stage.scrollTop = stage.scrollHeight;
    }, 100);
}

// åˆ é™¤å‰§æœ¬
function deleteScript(id) {
    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‰§æœ¬å­˜æ¡£å—ï¼Ÿæ— æ³•æ¢å¤ã€‚")) {
        allScripts = allScripts.filter(s => s.id !== id);
        saveAllScripts();
        renderScriptList();
    }
}
        // ==========================================
// --- âœ¨ æ–°å¢ï¼šé¢„è®¾ä¸ä¸–ç•Œä¹¦å­˜æ¡£åˆ—è¡¨ âœ¨ ---
// ==========================================

// 1. å®šä¹‰å…¨å±€å˜é‡
let savedTheaterPresets = []; // å­˜é¢„è®¾ (Core + Styles + Modules + Regex)
let savedWorldSets = [];      // å­˜ä¸–ç•Œä¹¦ (World Info only)

// 2. å®šä¹‰åŠ è½½å‡½æ•°
function loadTheaterSavedLists() {
    try {
        const p = localStorage.getItem('theater_saved_presets');
        if (p) savedTheaterPresets = JSON.parse(p);
        
        const w = localStorage.getItem('theater_saved_worlds');
        if (w) savedWorldSets = JSON.parse(w);
        
        console.log("å·²åŠ è½½ä¿å­˜çš„é¢„è®¾å’Œä¸–ç•Œä¹¦åˆ—è¡¨");
    } catch (e) {
        console.error("è¯»å–ä¿å­˜åˆ—è¡¨å¤±è´¥", e);
    }
}

// 3. ç¡®ä¿é¡µé¢æ‰“å¼€æ—¶è‡ªåŠ¨è¿è¡Œ
window.addEventListener('load', loadTheaterSavedLists);

// ==========================================

function loadTheaterConfig() {
    const s = localStorage.getItem('theater_config');
    if(s) theaterState.config = JSON.parse(s);
    
    // æ¢å¤UI
    document.getElementById('t-api-url').value = theaterState.config.apiUrl || "";
    document.getElementById('t-api-key').value = theaterState.config.apiKey || "";
    document.getElementById('t-model').value = theaterState.config.model || "";
}

// 2. å¯¼æ¼”å° UI é€»è¾‘
function openTheaterConsole() {
     renderSavedPresetSelect();
    renderSavedWorldSelect();
    loadTheaterApiPresets();
    openModal('modal-theater-console');
}
        // ==========================================
// --- ğŸ­ å‰§åœºæ¨¡å¼ API é¢„è®¾é€»è¾‘ (æ–°å¢) ---
// ==========================================

let theaterApiPresets = [];

// 1. åŠ è½½é¢„è®¾åˆ—è¡¨ (ä» localStorage)
function loadTheaterApiPresets() {
    const s = localStorage.getItem('theater_api_presets');
    if (s) {
        try {
            theaterApiPresets = JSON.parse(s);
        } catch (e) {
            theaterApiPresets = [];
        }
    } else {
        theaterApiPresets = [];
    }
    renderTheaterApiPresetUI();
}

// 2. æ¸²æŸ“ä¸‹æ‹‰æ¡†
function renderTheaterApiPresetUI() {
    const select = document.getElementById('t-api-preset-select');
    if (!select) return;

    // æ¸…ç©ºå¹¶é‡ç½®é»˜è®¤é€‰é¡¹
    select.innerHTML = '<option value="">-- é€‰æ‹©é…ç½® --</option>';

    theaterApiPresets.forEach((preset, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = preset.name;
        select.appendChild(opt);
    });
}

// 3. ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°é¢„è®¾
function saveTheaterApiPreset() {
    const url = document.getElementById('t-api-url').value.trim();
    const key = document.getElementById('t-api-key').value.trim();
    const model = document.getElementById('t-model').value.trim();

    if (!url || !key) {
        return alert("è¯·è‡³å°‘å¡«å†™ API URL å’Œ Key æ‰èƒ½ä¿å­˜ï¼");
    }

    const name = prompt("ç»™è¿™ä¸ªé…ç½®èµ·ä¸ªåå­— (ä¾‹å¦‚: DeepSeek, è½¬å‘ç«™A):");
    if (!name) return;

    const newPreset = {
        name: name,
        url: url,
        key: key,
        model: model
    };

    // æ£€æŸ¥é‡åè¦†ç›–
    const existingIndex = theaterApiPresets.findIndex(p => p.name === name);
    if (existingIndex >= 0) {
        if (!confirm(`é¢„è®¾ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
        theaterApiPresets[existingIndex] = newPreset;
    } else {
        theaterApiPresets.push(newPreset);
    }

    localStorage.setItem('theater_api_presets', JSON.stringify(theaterApiPresets));
    renderTheaterApiPresetUI();
    
    // è‡ªåŠ¨é€‰ä¸­åˆšæ‰ä¿å­˜çš„
    const select = document.getElementById('t-api-preset-select');
    select.selectedIndex = select.options.length - 1; // é€‰æœ€åä¸€ä¸ªï¼ˆå¦‚æœæ˜¯æ–°å¢çš„è¯ï¼‰æˆ–è€…å¯¹åº”çš„index
    
    alert(`é…ç½® "${name}" å·²ä¿å­˜ï¼`);
}

// 4. åº”ç”¨é€‰ä¸­çš„é¢„è®¾
function applyTheaterApiPreset() {
    const select = document.getElementById('t-api-preset-select');
    const index = select.value;

    if (index === "") return; // é€‰äº†æç¤ºé¡¹ï¼Œä¸æ“ä½œ

    const preset = theaterApiPresets[index];
    if (preset) {
        document.getElementById('t-api-url').value = preset.url || "";
        document.getElementById('t-api-key').value = preset.key || "";
        document.getElementById('t-model').value = preset.model || "";
        
        // è§†è§‰åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
        
        // å¯é€‰ï¼šåº”ç”¨åå¯ä»¥è‡ªåŠ¨ä¿å­˜ä¸€ä¸‹å½“å‰ Theater Configï¼Œé˜²æ­¢ç”¨æˆ·å¿˜äº†ç‚¹æœ€ä¸‹é¢çš„ä¿å­˜æŒ‰é’®
        // saveTheaterSettings(); 
    }
}

// 5. åˆ é™¤é¢„è®¾
function deleteTheaterApiPreset() {
    const select = document.getElementById('t-api-preset-select');
    const index = select.value;

    if (index === "") return alert("è¯·å…ˆåœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾");

    const presetName = theaterApiPresets[index].name;
    if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${presetName}" å—ï¼Ÿ`)) {
        theaterApiPresets.splice(index, 1);
        localStorage.setItem('theater_api_presets', JSON.stringify(theaterApiPresets));
        renderTheaterApiPresetUI();
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œæˆ–è€…ä¿æŒä¸å˜ï¼‰
        select.value = "";
    }
}

function switchTheaterTab(tabId) {
    document.querySelectorAll('.t-tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.querySelectorAll('.t-tab-content').forEach(c => c.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
}

function saveTheaterSettings() {
    theaterState.config.apiUrl = document.getElementById('t-api-url').value.trim();
    theaterState.config.apiKey = document.getElementById('t-api-key').value.trim();
    theaterState.config.model = document.getElementById('t-model').value.trim();
    
    localStorage.setItem('theater_config', JSON.stringify(theaterState.config));
    closeModal('modal-theater-console');
    alert("å‰§åœºé…ç½®å·²ä¿å­˜");
}

// 3. ç®€å•çš„è¾“å…¥æ¡†è‡ªé€‚åº”
function autoResizeTextArea(el) {
    el.style.height = 'auto';
    el.style.height = (el.scrollHeight) + 'px';
}

// 4. ä¸´æ—¶å‘é€é€»è¾‘ (åªä¸Šå±ï¼Œæš‚ä¸æ¥APIï¼Œä¸‹ä¸€é˜¶æ®µå†™è§£æå™¨)
async function sendTheaterMsg() {
    const input = document.getElementById('theater-input');
    const txt = input.value.trim();
    if(!txt) return;

    // 1. è·å–å½“å‰è§’è‰² (é˜²é”™ï¼šæ²¡é€‰äººå°±é»˜è®¤ç”¨ç¬¬ä¸€ä¸ª)
    let char = contacts.find(c => c.id === activeContactId);
    if (!char && contacts.length > 0) char = contacts[0];
    if (!char) return alert("è¯·å…ˆåœ¨ã€ä¿¡æ¯ã€‘åˆ—è¡¨åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼");

    // 2. è¡¥ä¸ï¼šé˜²æ­¢å†å²è®°å½•æ•°ç»„ä¸å­˜åœ¨å¯¼è‡´æŠ¥é”™
    if (!theaterState.logs) theaterState.logs = [];

    // 3. UI ä¸Šå±
    appendTheaterLog('user', txt, char.userName || "æˆ‘");
    
    // 4. å­˜å…¥å†å²
    theaterState.logs.push({ role: 'user', content: txt });
    saveTheaterLogs();

    // 5. å…³é”®ï¼šå…ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼Œå†å« AIï¼
    // (ä¹‹å‰å¯èƒ½å¡åœ¨è¿™é‡Œï¼Œå¯¼è‡´å­—æ¶ˆä¸æ‰)
    input.value = '';
    if(typeof autoResizeTextArea === 'function') autoResizeTextArea(input);

    // 6. å¬å”¤ AI (åŠ äº† await ä¿è¯é¡ºåº)
    await triggerTheaterAI(char);
    
}
        // === ã€ä¿®å¤è¡¥ä¸ã€‘è¡¥å……ç¼ºå¤±çš„ä¿å­˜å‡½æ•° ===
function saveTheaterLogs() {
    if (!theaterState.currentScriptId) return;

    // æ‰¾åˆ°å½“å‰å‰§æœ¬
    const script = allScripts.find(s => s.id === theaterState.currentScriptId);
    if (script) {
        script.logs = theaterState.logs; // æ›´æ–°æ—¥å¿—
        script.lastModified = Date.now(); // æ›´æ–°æ—¶é—´
        saveAllScripts(); // å­˜å…¥ localStorage
    }
}


function appendTheaterLog(role, text, name) {
    const stage = document.getElementById('theater-stage');
    const tip = document.querySelector('.theater-start-tip');
    if(tip) tip.remove();

    // è®¡ç®—æ¥¼å±‚ï¼šå½“å‰ DOM é‡Œçš„ .t-msg-block æ•°é‡ + 1
    const floor = stage.querySelectorAll('.t-msg-block').length + 1;

    const div = document.createElement('div');
    div.className = 't-msg-block';
    if(role === 'system') div.classList.add('system');

    // æ ¼å¼åŒ–æ–‡æœ¬
    const formattedText = text.replace(/\n/g, '<br>');

    // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œç”¨ç‰¹æ®Šå¡ç‰‡ (ä¹‹å‰çš„é€»è¾‘)
    if (role === 'system') {
        // ç³»ç»Ÿæ¶ˆæ¯é€šå¸¸ä¸å æ¥¼å±‚å·ï¼Œæˆ–è€…å äº†ä½†ä¸æ˜¾ç¤ºï¼Œçœ‹ä½ å–œå¥½ã€‚è¿™é‡Œé€‰æ‹©æ˜¾ç¤ºã€‚
        div.innerHTML = `
            <span class="t-floor-tag">#${floor}</span>
            <div class="t-system-card">
                <div class="t-system-header">å‰§æƒ…å›é¡¾ / è®°å¿†å­˜æ¡£</div>
                <div>${formattedText}</div>
            </div>`;
    } else {
        // æ™®é€šå¯¹è¯
        div.innerHTML = `
            <span class="t-floor-tag">#${floor}</span>
            <div class="t-role-label">${name}</div>
            <div class="t-text ${role}">${formattedText}</div>
        `;
    }
    
    stage.appendChild(div);
    setTimeout(() => { stage.scrollTop = stage.scrollHeight; }, 100);
    return div.querySelector('.t-text');
}


// ==========================================
// --- 21. å‰§åœºæ¨¡å¼ï¼šæ ¸å¿ƒè§£æå™¨ (Parser) ---
// ==========================================

// 1. æ–‡ä»¶å¯¼å…¥å…¥å£
async function handleTheaterImport(e) {
    const file = e.target.files[0];
    if(!file) return;

    try {
        const text = await file.text();
        const json = JSON.parse(text);
        
        // å¼€å§‹è§£æ
        parseSillyTavernJSON(json, file.name);
        
        // ä¿å­˜å¹¶åˆ·æ–°
        saveTheaterState();
        renderConsoleUI();
        
        alert(`âœ… æˆåŠŸå¯¼å…¥é¢„è®¾ï¼š${file.name}\nå·²è‡ªåŠ¨è¯†åˆ«å‡ºæ–‡é£å’Œå°å‰§åœºæ¨¡å—ï¼`);
        
    } catch(err) {
        alert("è§£æå¤±è´¥: " + err.message);
        console.error(err);
    } finally {
        e.target.value = ''; // æ¸…ç©ºinputä»¥ä¾¿ä¸‹æ¬¡é€‰åŒåæ–‡ä»¶
    }
}
        // ==========================================
// --- ğŸ“‚ ç‹¬ç«‹å¯¼å…¥åŠŸèƒ½ (ä¸–ç•Œä¹¦ & æ­£åˆ™) ---
// ==========================================

// 1. ç‹¬ç«‹å¯¼å…¥ä¸–ç•Œä¹¦
// 1. ç‹¬ç«‹å¯¼å…¥ä¸–ç•Œä¹¦ (ç»ˆæå…¼å®¹ç‰ˆï¼šæ”¯æŒæ•°ç»„å’Œå¯¹è±¡æ ¼å¼)
async function handleWorldImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
        const text = await file.text();
        const json = JSON.parse(text);
        let count = 0;
        let entries = [];

        // --- 1. æ ¼å¼è¯†åˆ«åŒº (æ ¸å¿ƒä¿®å¤) ---
        if (Array.isArray(json)) {
            // æƒ…å†µA: æ ¹ç›®å½•å°±æ˜¯æ•°ç»„
            entries = json;
        } else if (json.entries) {
            if (Array.isArray(json.entries)) {
                // æƒ…å†µB: æ ‡å‡†æ•°ç»„æ ¼å¼
                entries = json.entries;
            } else if (typeof json.entries === 'object') {
                // ğŸ”¥ æƒ…å†µC: ä½ çš„æ–‡ä»¶å°±æ˜¯è¿™ç§ï¼(å­—å…¸å¯¹è±¡æ ¼å¼)
                // æˆ‘ä»¬ç”¨ Object.values æŠŠå®ƒå¼ºè¡Œè½¬æˆæ•°ç»„
                entries = Object.values(json.entries);
            }
        } 
        
        if (entries.length === 0) {
            throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¯æ¡æ•°æ® (entries ä¸ºç©º)");
        }

        // --- 2. æ•°æ®æ¸…æ´—åŒº ---
        entries.forEach(entry => {
            // æå–å…³é”®è¯ (å…¼å®¹å„ç§å¥‡è‘©å†™æ³•)
            let keys = [];
            // ä¼˜å…ˆæ‰¾ key (æ•°ç»„), å…¶æ¬¡æ‰¾ keys, æœ€åæ‰¾ string æ ¼å¼
            const rawKey = entry.key || entry.keys; 
            
            if (Array.isArray(rawKey)) {
                keys = rawKey;
            } else if (typeof rawKey === 'string') {
                keys = rawKey.split(',').map(k => k.trim());
            }

            // å­˜å…¥ç³»ç»Ÿ
            theaterState.preset.worldInfo.push({
                id: entry.uid || 'wi_' + Math.random(),
                comment: entry.comment || entry.name || 'å¯¼å…¥æ¡ç›®',
                keys: keys,
                content: entry.content || '',
                enabled: entry.enabled !== false, // é»˜è®¤å¼€å¯ï¼Œé™¤éæ˜ç¡®å†™äº† false
                // å¤„ç†ä½ çš„æ–‡ä»¶é‡Œé‚£ç§ forceActive æˆ–è€… constant å±æ€§
                forceActive: entry.constant || false, 
                isActive: false
            });
            count++;
        });

        saveTheaterState();
        renderConsoleUI();
        alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡ä¸–ç•Œä¹¦è®¾å®šï¼`);

    } catch (err) {
        alert("å¯¼å…¥å¤±è´¥: " + err.message);
        console.error(err);
    } finally {
        e.target.value = ''; // æ¸…ç©º input
    }
}

// 2. ç‹¬ç«‹å¯¼å…¥æ­£åˆ™è„šæœ¬ (ç»ˆæä¿®æ­£ç‰ˆï¼šæ”¯æŒç©ºæ›¿æ¢ + è‡ªåŠ¨å»æ–œæ )
async function handleRegexImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
        const text = await file.text();
        const json = JSON.parse(text);
        let count = 0;
        let scripts = [];
        
        // --- å†…éƒ¨å·¥å…·ï¼šæ¸…æ´—é…’é¦†æ ¼å¼çš„æ­£åˆ™ (å»æ‰ä¸¤å¤´çš„ / å’Œå°¾éƒ¨çš„ g/m/i) ---
        // æ¯”å¦‚æŠŠ "/abc/g" å˜æˆ "abc"ï¼Œå¦åˆ™ JS å¼•æ“æ— æ³•è¯†åˆ«
        const cleanPattern = (str) => {
            if (!str) return "";
            // åŒ¹é…ä»¥ / å¼€å¤´ï¼Œä»¥ / åŠ å¯é€‰æ ‡å¿—ç»“å°¾çš„å­—ç¬¦ä¸²
            const match = str.match(/^\/(.*?)\/([a-z]*)$/);
            return match ? match[1] : str;
        };

        // --- 1. æ ¼å¼è¯†åˆ« ---
        if (Array.isArray(json)) {
            scripts = json;
        } else if (json.regex_scripts && Array.isArray(json.regex_scripts)) {
            scripts = json.regex_scripts;
        } else if (json.scripts && Array.isArray(json.scripts)) {
            scripts = json.scripts;
        } else {
            // å•ä¸ªå¯¹è±¡æ£€æŸ¥
            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ !== undefined æ¥å…è®¸ç©ºå­—ç¬¦ä¸² ""
            const hasLegacy = (json.regex && json.replacement !== undefined);
            const hasNew = (json.findRegex && json.replaceString !== undefined);
            
            if (hasLegacy || hasNew) {
                scripts = [json];
            } else {
                throw new Error("æ— æ³•è¯†åˆ«çš„æ­£åˆ™æ–‡ä»¶æ ¼å¼");
            }
        }

        // --- 2. è¡¥ä¸ï¼šé˜²æ­¢ regexScripts å®¹å™¨ç¼ºå¤± ---
        if (!theaterState.preset.regexScripts) {
            theaterState.preset.regexScripts = [];
        }

        // --- 3. æ•°æ®æ¸…æ´—ä¸å­˜å…¥ ---
        scripts.forEach(r => {
            // è·å–åŸå§‹æ­£åˆ™å­—ç¬¦ä¸²
            let rawRegex = r.regex || r.findRegex;
            // ğŸ”¥ è‡ªåŠ¨è„±å£³ï¼šå»æ‰é…’é¦†æ ¼å¼ä¸¤å¤´çš„æ–œæ 
            let finalRegex = cleanPattern(rawRegex);

            theaterState.preset.regexScripts.push({
                id: r.id || 'reg_' + Math.random(),
                scriptName: r.scriptName || 'å¯¼å…¥è„šæœ¬',
                regex: finalRegex, 
                replacement: r.replacement || r.replaceString || "", // ç¡®ä¿å³ä½¿æ˜¯nullä¹Ÿæ˜¯ç©ºå­—ç¬¦ä¸²
                placement: r.placement || [1, 2],
                disabled: r.disabled || false
            });
            count++;
        });

        saveTheaterState();
        renderConsoleUI();
        alert(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ­£åˆ™è„šæœ¬ï¼`);

    } catch (err) {
        alert("å¯¼å…¥å¤±è´¥: " + err.message);
        console.error(err);
    } finally {
        e.target.value = '';
    }
}

// 2. æ ¸å¿ƒï¼šJSON æ¦¨æ±æœº
function parseSillyTavernJSON(json, fileName) {
    // é‡ç½®å½“å‰æ•°æ®
    theaterState.preset = {
        name: fileName.replace('.json', ''),
        core: [],
        styles: [],
        modules: [],
        activeStyleId: null,
        activeModules: [],      // <--- æ³¨æ„è¿™é‡ŒåŠ ä¸ªé€—å·
        worldInfo: []
    };

    // æ£€æŸ¥ prompts æ•°ç»„
    if (!json.prompts || !Array.isArray(json.prompts)) {
        throw new Error("è¿™ä¸æ˜¯æ ‡å‡†çš„é…’é¦†é¢„è®¾æ–‡ä»¶ (æ‰¾ä¸åˆ° prompts åˆ—è¡¨)");
    }

    // éå†å¹¶åˆ†ç±»
    // --- ä¿®æ”¹åçš„ parseSillyTavernJSON å†…éƒ¨å¾ªç¯ ---
    json.prompts.forEach(p => {
        const item = {
            id: p.identifier || 'id_' + Math.random(),
            name: p.name || 'æœªå‘½å',
            content: p.content || '',
            // å…³é”®ä¿®æ”¹ï¼šç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶é‡Œçš„ enabled çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º true
            // ä¸å†å¼ºåˆ¶è®¾ä¸º falseï¼Œä¹Ÿä¸å†è¿‡æ»¤
            enabled: (p.enabled === undefined) ? true : p.enabled 
        };

        // --- æ™ºèƒ½åˆ†ç±»é€»è¾‘ ---
        
        if (item.name.includes("æ–‡é£") || item.name.includes("WritingStyle")) {
            // A. å½’ç±»ä¸ºã€æ–‡é£ã€‘ (å•é€‰)
            theaterState.preset.styles.push(item);
            
        } else if (item.name.includes("å°å‰§åœº") || item.name.includes("Theater")) {
            // B. å½’ç±»ä¸ºã€å°å‰§åœºã€‘ (å¼€å…³)
            // ç°åœ¨çš„é€»è¾‘ï¼šå¦‚æœåŸä½œè€…å‹¾äº†ï¼Œè¿™å°±å¼€ï¼›æ²¡å‹¾è¿™å°±å…³ã€‚ä¸å†å¼ºåˆ¶å…³é—­ã€‚
            theaterState.preset.modules.push(item);
            // é¡ºä¾¿æŠŠ ID åŠ åˆ° activeModules æ•°ç»„é‡Œï¼Œä»¥ä¾¿åç»­é€»è¾‘å…¼å®¹
            if (item.enabled) {
                theaterState.preset.activeModules.push(item.id);
            }
            
        } else {
            // C. å½’ç±»ä¸ºã€æ ¸å¿ƒè§„åˆ™ã€‘ (å¸¸é©» -> æ”¹ä¸ºå¯åˆ‡æ¢)
            // å…³é”®ä¿®æ”¹ï¼šåˆ é™¤äº† if (p.enabled) çš„åˆ¤æ–­
            // æ— è®ºåŸä½œè€…æ˜¯å¦å¼€å¯ï¼Œéƒ½å¯¼å…¥è¿›æ¥ï¼Œè®©ç”¨æˆ·è‡ªå·±å†³å®š
            theaterState.preset.core.push(item);
        }
    });
    // === âœ¨ æ–°å¢ï¼šè§£æä¸–ç•Œä¹¦ (World Info) ===
    // å…¼å®¹æ ‡å‡†é…’é¦†æ ¼å¼ï¼Œé€šå¸¸åœ¨ entries æ•°ç»„é‡Œ
    if (json.entries && Array.isArray(json.entries)) {
        json.entries.forEach(entry => {
            // æå–å…³é”®è¯ (å…¼å®¹å­—ç¬¦ä¸²æˆ–æ•°ç»„)
            let keys = [];
            if (Array.isArray(entry.key)) keys = entry.key;
            else if (typeof entry.key === 'string') keys = entry.key.split(',').map(k => k.trim());
            // æœ‰äº›æ ¼å¼æ˜¯ç”¨ keys å­—æ®µ
            if (entry.keys && Array.isArray(entry.keys)) keys = entry.keys;

            theaterState.preset.worldInfo.push({
                id: entry.uid || 'wi_' + Math.random(),
                comment: entry.comment || entry.name || 'æœªå‘½åæ¡ç›®', // æ¡ç›®å
                keys: keys,           // è§¦å‘å…³é”®è¯æ•°ç»„
                content: entry.content || '', // æ¡ç›®å†…å®¹
                enabled: entry.enabled !== false, // é»˜è®¤å¼€å¯
                isActive: false       // è¿è¡Œæ—¶çŠ¶æ€ï¼šæ˜¯å¦è¢«æœ¬æ¬¡å¯¹è¯è§¦å‘
            });
        });
    }

    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ–‡é£ (å¦‚æœæœ‰çš„è¯)
    if (theaterState.preset.styles.length > 0) {
        theaterState.preset.activeStyleId = theaterState.preset.styles[0].id;
    }
    // === âœ¨ æ–°å¢ï¼šè§£ææ­£åˆ™è„šæœ¬ (Regex Scripts) ===
    // å…¼å®¹é…’é¦†æ ¼å¼ï¼Œè§„åˆ™é€šå¸¸å­˜åœ¨ regex_scripts æ•°ç»„é‡Œ
    if (json.regex_scripts && Array.isArray(json.regex_scripts)) {
        json.regex_scripts.forEach(r => {
            theaterState.preset.regexScripts.push({
                id: r.id || 'reg_' + Math.random(),
                scriptName: r.scriptName || 'æœªå‘½åè„šæœ¬',
                regex: r.regex,             // åŒ¹é…è§„åˆ™ (å­—ç¬¦ä¸²)
                replacement: r.replacement, // æ›¿æ¢å†…å®¹
                // placement: 1=Input(ç”¨æˆ·å‘é€å‰), 2=Output(AIå›å¤å)
                placement: r.placement || [1, 2], 
                disabled: r.disabled || false
            });
        });
    }
}
        // --- æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰æ¡† ---
function renderSavedPresetSelect() {
    const select = document.getElementById('saved-preset-select');
    if (!select) return;
    
    // ä¿ç•™ç¬¬ä¸€é¡¹
    select.innerHTML = '<option value="">-- é€‰æ‹©é¢„è®¾ --</option>';
    
    savedTheaterPresets.forEach((item, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = item.name;
        select.appendChild(opt);
    });
}

// --- ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°é¢„è®¾ ---
function doSavePreset() {
    const p = theaterState.preset;
    // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
    if (p.core.length === 0 && p.styles.length === 0) {
        return alert("å½“å‰æ²¡æœ‰åŠ è½½ä»»ä½•è§„åˆ™ï¼Œæ— æ³•ä¿å­˜ï¼");
    }

    const name = prompt("ç»™å½“å‰é…ç½®èµ·ä¸ªåå­— (å«è§„åˆ™/æ–‡é£/æ­£åˆ™):", p.name || "æ–°é¢„è®¾");
    if (!name) return;

    // æ„é€ å­˜å‚¨å¯¹è±¡ (å‰”é™¤ worldInfo)
    const package = {
        name: name,
        core: p.core,
        styles: p.styles,
        modules: p.modules,
        activeStyleId: p.activeStyleId,
        activeModules: p.activeModules,
        regexScripts: p.regexScripts // åŒ…å«æ­£åˆ™
    };

    // æ£€æŸ¥é‡åè¦†ç›–
    const idx = savedTheaterPresets.findIndex(x => x.name === name);
    if (idx >= 0) {
        if (!confirm(`é¢„è®¾ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
        savedTheaterPresets[idx] = package;
    } else {
        savedTheaterPresets.push(package);
    }

    localStorage.setItem('theater_saved_presets', JSON.stringify(savedTheaterPresets));
    renderSavedPresetSelect();
    alert("é¢„è®¾ä¿å­˜æˆåŠŸï¼");
}

// --- åº”ç”¨é€‰ä¸­çš„é¢„è®¾ ---
function applySavedPreset() {
    const idx = document.getElementById('saved-preset-select').value;
    if (idx === "") return;

    const data = savedTheaterPresets[idx];
    if (!data) return;

    // è¦†ç›–å½“å‰çŠ¶æ€ (ä¿ç•™ WorldInfo ä¸åŠ¨)
    const currentWorld = theaterState.preset.worldInfo || [];
    
    theaterState.preset = {
        name: data.name,
        core: JSON.parse(JSON.stringify(data.core || [])),     // æ·±æ‹·è´é˜²æ­¢å¼•ç”¨ä¿®æ”¹
        styles: JSON.parse(JSON.stringify(data.styles || [])),
        modules: JSON.parse(JSON.stringify(data.modules || [])),
        activeStyleId: data.activeStyleId,
        activeModules: JSON.parse(JSON.stringify(data.activeModules || [])),
        regexScripts: JSON.parse(JSON.stringify(data.regexScripts || [])),
        worldInfo: currentWorld // ğŸ”¥ å…³é”®ï¼šæŠŠä¸–ç•Œä¹¦æ¥å›å»
    };

    saveTheaterState(); // å­˜å…¥è¿è¡Œæ—¶
    renderConsoleUI();  // åˆ·æ–°ç•Œé¢
    
    // è§†è§‰åé¦ˆ
    if(navigator.vibrate) navigator.vibrate(50);
}

// --- åˆ é™¤é¢„è®¾ ---
function doDeletePreset() {
    const idx = document.getElementById('saved-preset-select').value;
    if (idx === "") return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾");

    if (confirm("ç¡®å®šåˆ é™¤è¯¥é¢„è®¾å—ï¼Ÿ")) {
        savedTheaterPresets.splice(idx, 1);
        localStorage.setItem('theater_saved_presets', JSON.stringify(savedTheaterPresets));
        renderSavedPresetSelect();
    }
}
        // --- æ¸²æŸ“ä¸–ç•Œä¹¦ä¸‹æ‹‰æ¡† ---
function renderSavedWorldSelect() {
    const select = document.getElementById('saved-world-select');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- é€‰æ‹©ä¸–ç•Œä¹¦ --</option>';
    
    savedWorldSets.forEach((item, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = `${item.name} (${item.entries.length}æ¡)`;
        select.appendChild(opt);
    });
}

// --- ä¿å­˜å½“å‰ä¸–ç•Œä¹¦ ---
function doSaveWorld() {
    const currentEntries = theaterState.preset.worldInfo;
    if (!currentEntries || currentEntries.length === 0) {
        return alert("å½“å‰æ²¡æœ‰ä»»ä½•ä¸–ç•Œä¹¦æ¡ç›®ï¼");
    }

    const name = prompt("ç»™è¿™å¥—ä¸–ç•Œè§‚èµ·ä¸ªåå­—:", "æ–°ä¸–ç•Œè§‚");
    if (!name) return;

    const package = {
        name: name,
        entries: JSON.parse(JSON.stringify(currentEntries)) // æ·±æ‹·è´
    };

    const idx = savedWorldSets.findIndex(x => x.name === name);
    if (idx >= 0) {
        if (!confirm(`ä¸–ç•Œä¹¦ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
        savedWorldSets[idx] = package;
    } else {
        savedWorldSets.push(package);
    }

    localStorage.setItem('theater_saved_worlds', JSON.stringify(savedWorldSets));
    renderSavedWorldSelect();
    alert("ä¸–ç•Œä¹¦ä¿å­˜æˆåŠŸï¼");
}

// --- åº”ç”¨é€‰ä¸­çš„ä¸–ç•Œä¹¦ ---
function applySavedWorld() {
    const idx = document.getElementById('saved-world-select').value;
    if (idx === "") return;

    const data = savedWorldSets[idx];
    if (!data) return;

    if (theaterState.preset.worldInfo.length > 0) {
        if (!confirm("åŠ è½½æ–°ä¸–ç•Œä¹¦å°†è¦†ç›–å½“å‰æ‰€æœ‰æ¡ç›®ï¼Œç¡®å®šå—ï¼Ÿ")) {
            // æ¢å¤ä¸‹æ‹‰æ¡†é€‰æ‹©
            document.getElementById('saved-world-select').value = "";
            return;
        }
    }

    // è¦†ç›–ä¸–ç•Œä¹¦
    theaterState.preset.worldInfo = JSON.parse(JSON.stringify(data.entries));
    
    saveTheaterState();
    renderConsoleUI(); // åˆ·æ–°åˆ—è¡¨
}

// --- åˆ é™¤ä¸–ç•Œä¹¦ ---
function doDeleteWorld() {
    const idx = document.getElementById('saved-world-select').value;
    if (idx === "") return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦");

    if (confirm("ç¡®å®šåˆ é™¤è¯¥ä¸–ç•Œä¹¦å­˜æ¡£å—ï¼Ÿ")) {
        savedWorldSets.splice(idx, 1);
        localStorage.setItem('theater_saved_worlds', JSON.stringify(savedWorldSets));
        renderSavedWorldSelect();
    }
}

// ========================================================
// ğŸ› ï¸ å‡çº§ç‰ˆï¼šæ¸²æŸ“æ§åˆ¶å° (æ”¯æŒä¸–ç•Œä¹¦ç¼–è¾‘ + æ–°å¢æŒ‰é’®)
// ========================================================
function renderConsoleUI() {
    const p = theaterState.preset;
    document.getElementById('t-current-preset-name').innerText = p.name;

    // --- A. æ ¸å¿ƒåˆ—è¡¨ (Core) [å·²ä¿®æ”¹ï¼šæ”¯æŒå¼€å…³] ---
    const coreList = document.getElementById('t-core-list');
    if (coreList) {
        coreList.innerHTML = '';
        p.core.forEach((item, index) => {
            // åˆ¤æ–­æ˜¯å¦å¯ç”¨
            const isActive = item.enabled;
            const div = document.createElement('div');
            div.className = 't-item-row';
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»åˆ‡æ¢ toggleCoreItem
            div.onclick = () => toggleCoreItem(index);

            // æ ·å¼ï¼šå¯ç”¨æ˜¯ç»¿è‰²ï¼Œæœªå¯ç”¨æ˜¯ç°è‰²
            const toggleColor = isActive ? '#34c759' : '#444';
            const togglePos = isActive ? '22px' : '2px';
            const textColor = isActive ? '#fff' : '#888';

            div.innerHTML = `
            <div style="flex:1;">
                <span class="t-item-name" style="color:${textColor}; font-size:14px;">${item.name}</span>
            </div>
            <!-- ä»¿ iOS å¼€å…³ UI -->
            <div style="width:40px; height:22px; background:${toggleColor}; border-radius:11px; position:relative; transition:0.2s;">
                <div style="width:18px; height:18px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${togglePos}; transition:0.2s;"></div>
            </div>`;
            
            coreList.appendChild(div);
        });
    }

    // --- B. æ–‡é£åˆ—è¡¨ (Style) ---
    const styleList = document.getElementById('t-style-list');
    if (styleList) {
        styleList.innerHTML = '';
        if (p.styles.length === 0) styleList.innerHTML = '<div class="t-tip">æ— æ–‡é£é€‰é¡¹</div>';
        p.styles.forEach(item => {
            const isActive = (item.id === p.activeStyleId);
            const div = document.createElement('div');
            div.className = `t-item-row ${isActive ? 'active' : ''}`;
            div.onclick = () => selectTheaterStyle(item.id);
            div.innerHTML = `<span class="t-item-name">${item.name}</span><div class="t-radio-check"></div>`;
            styleList.appendChild(div);
        });
    }

    // --- C. å°å‰§åœºåˆ—è¡¨ (Modules) ---
    const moduleList = document.getElementById('t-module-list');
    if (moduleList) {
        moduleList.innerHTML = '';
        if (p.modules.length === 0) moduleList.innerHTML = '<div class="t-tip">æ— å°å‰§åœºæ¨¡å—</div>';
        p.modules.forEach(item => {
            const isActive = p.activeModules.includes(item.id);
            const div = document.createElement('div');
            div.className = 't-item-row';
            div.onclick = () => toggleTheaterModule(item.id);
            const toggleColor = isActive ? '#34c759' : '#444';
            const togglePos = isActive ? '22px' : '2px';
            div.innerHTML = `
            <span class="t-item-name" style="${isActive ? 'color:#fff' : ''}">${item.name}</span>
            <div style="width:40px; height:22px; background:${toggleColor}; border-radius:11px; position:relative; transition:0.2s;">
                <div style="width:18px; height:18px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${togglePos}; transition:0.2s;"></div>
            </div>`;
            moduleList.appendChild(div);
        });
    }

    // --- D. ä¸–ç•Œä¹¦åˆ—è¡¨ (World Info) - å‡çº§ç‰ˆ ---
    const worldList = document.getElementById('t-world-list');
    if (worldList) {
        worldList.innerHTML = '';
        
        // 1. åœ¨åˆ—è¡¨é¡¶éƒ¨åŠ ä¸€ä¸ªâ€œ+ æ–°å¢â€æŒ‰é’®
        const addBtn = document.createElement('div');
        addBtn.className = 't-upload-box';
        addBtn.style.padding = "8px"; 
        addBtn.style.marginBottom = "10px";
        addBtn.style.borderStyle = "dashed";
        addBtn.style.borderColor = "#007AFF";
        addBtn.style.color = "#007AFF";
        addBtn.innerText = "â• æ–°å»ºä¸–ç•Œä¹¦æ¡ç›®";
        addBtn.onclick = () => openWorldEditor(-1); // -1 ä»£è¡¨æ–°å»º
        // æŠŠå®ƒæ’å…¥åˆ° worldList çš„å‰é¢ï¼Ÿä¸ï¼ŒworldList æ˜¯å®¹å™¨ï¼Œç›´æ¥ append è¿›å»ä½œä¸ºç¬¬ä¸€ä¸ªå…ƒç´ 
        worldList.appendChild(addBtn);

        if (!p.worldInfo || p.worldInfo.length === 0) {
            const tip = document.createElement('div');
            tip.className = 't-tip';
            tip.innerText = 'æš‚æ— æ¡ç›®ï¼Œè¯·å¯¼å…¥æˆ–æ–°å»º';
            worldList.appendChild(tip);
        } else {
            p.worldInfo.forEach((item, index) => {
                let color = '#888';
                let statusText = "";
                
                if (item.enabled) {
                    color = '#fff';
                    if (item.forceActive) {
                        color = '#ffcc00'; // é»„è‰² (å¸¸é©»)
                        statusText = "âš¡";
                    } else if (item.isActive) {
                        color = '#34c759'; // ç»¿è‰² (è§¦å‘)
                        statusText = "ğŸŸ¢";
                    }
                }

                const div = document.createElement('div');
                div.className = 't-item-row';
                div.style.cursor = 'pointer';
                
                // ç‚¹å‡»æ•´è¡Œ -> æ‰“å¼€ç¼–è¾‘
                div.onclick = () => openWorldEditor(index);

                div.innerHTML = `
                    <div style="flex:1; overflow:hidden; padding-right:10px;">
                        <div class="t-item-name" style="color:${color}; font-weight:${item.isActive||item.forceActive?'bold':'normal'}; display:flex; align-items:center; gap:5px;">
                            ${statusText} ${item.comment || 'æœªå‘½å'}
                        </div>
                        <div style="font-size:10px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${item.keys.join(', ')}
                        </div>
                    </div>
                    
                    <div onclick="event.stopPropagation(); toggleWorldInfoEnable(${index})" 
                         style="width:30px; height:18px; border-radius:9px; background:${item.enabled ? '#34c759':'#333'}; position:relative;">
                         <div style="width:14px; height:14px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${item.enabled?'14px':'2px'}; transition:0.2s;"></div>
                    </div>
                `;
                worldList.appendChild(div);
            });
        }
    }

    // --- E. æ­£åˆ™åˆ—è¡¨ ---
    // (è¿™éƒ¨åˆ†ä¿æŒåŸæ ·ï¼Œå¦‚æœæœ‰çš„è¯)
    const regList = document.getElementById('t-regex-list');
    if (regList && p.regexScripts) {
        regList.innerHTML = '';
        p.regexScripts.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 't-item-row';
            div.onclick = () => toggleRegexScript(index);
            div.innerHTML = `
                <div style="flex:1; overflow:hidden;">
                    <div class="t-item-name" style="color:${item.disabled ? '#888' : '#fff'};">${item.scriptName}</div>
                </div>
                <div style="width:10px; height:10px; border-radius:50%; background:${item.disabled ? '#333' : '#34c759'}; border:1px solid #555;"></div>
            `;
            regList.appendChild(div);
        });
    }
}
        // æ–°å¢ï¼šåˆ‡æ¢æ ¸å¿ƒè§„åˆ™çš„å¼€å…³
function toggleCoreItem(index) {
    const item = theaterState.preset.core[index];
    if (item) {
        item.enabled = !item.enabled; // å–åçŠ¶æ€
        saveTheaterState(); // ä¿å­˜æ›´æ”¹
        renderConsoleUI();  // åˆ·æ–°ç•Œé¢
    }
}

// ========================================================
// âœ¨ æ–°å¢é€»è¾‘ï¼šä¸–ç•Œä¹¦ç¼–è¾‘åŠŸèƒ½
// ========================================================

// 1. æ‰“å¼€ç¼–è¾‘å™¨ (index=-1 ä¸ºæ–°å»º)
function openWorldEditor(index) {
    const p = theaterState.preset;
    const modal = document.getElementById('modal-world-edit');
    
    // å­˜ç´¢å¼•
    document.getElementById('we-index').value = index;

    if (index === -1) {
        // æ–°å»ºæ¨¡å¼ï¼šæ¸…ç©º
        document.getElementById('we-comment').value = "";
        document.getElementById('we-keys').value = "";
        document.getElementById('we-content').value = "";
        document.getElementById('we-force').checked = false;
    } else {
        // ç¼–è¾‘æ¨¡å¼ï¼šå›æ˜¾
        const item = p.worldInfo[index];
        document.getElementById('we-comment').value = item.comment || "";
        document.getElementById('we-keys').value = item.keys.join(", ");
        document.getElementById('we-content').value = item.content || "";
        document.getElementById('we-force').checked = item.forceActive || false;
    }

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

// 2. ä¿å­˜æ¡ç›®
function saveWorldEntry() {
    const index = parseInt(document.getElementById('we-index').value);
    const comment = document.getElementById('we-comment').value.trim() || "æœªå‘½åæ¡ç›®";
    const keysStr = document.getElementById('we-keys').value.trim();
    const content = document.getElementById('we-content').value;
    const forceActive = document.getElementById('we-force').checked;

    // åˆ†å‰²å…³é”®è¯ (æ”¯æŒä¸­æ–‡é€—å·)
    let keys = keysStr.split(/[,ï¼Œ]/).map(k => k.trim()).filter(k => k !== "");

    const entry = {
        id: (index === -1) ? ('wi_' + Date.now()) : theaterState.preset.worldInfo[index].id,
        comment: comment,
        keys: keys,
        content: content,
        enabled: true, // ä¿å­˜å³é»˜è®¤å¯ç”¨
        forceActive: forceActive,
        isActive: false
    };

    if (index === -1) {
        // æ–°å¢
        if (!theaterState.preset.worldInfo) theaterState.preset.worldInfo = [];
        theaterState.preset.worldInfo.push(entry);
    } else {
        // ä¿®æ”¹
        theaterState.preset.worldInfo[index] = entry;
    }

    saveTheaterState(); // ä¿å­˜åˆ°æœ¬åœ°
    renderConsoleUI();  // åˆ·æ–°åˆ—è¡¨
    closeModal('modal-world-edit');
}

// 3. åˆ é™¤æ¡ç›®
function deleteWorldEntry() {
    const index = parseInt(document.getElementById('we-index').value);
    if (index === -1) {
        closeModal('modal-world-edit');
        return;
    }

    if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯æ¡å—ï¼Ÿ")) {
        theaterState.preset.worldInfo.splice(index, 1);
        saveTheaterState();
        renderConsoleUI();
        closeModal('modal-world-edit');
    }
}
        function toggleRegexScript(index) {
    const item = theaterState.preset.regexScripts[index];
    item.disabled = !item.disabled; // åˆ‡æ¢ç¦ç”¨çŠ¶æ€
    saveTheaterState();
    renderConsoleUI();
}

// 4. äº¤äº’é€»è¾‘
function selectTheaterStyle(id) {
    theaterState.preset.activeStyleId = id;
    saveTheaterState();
    renderConsoleUI();
}

function toggleTheaterModule(id) {
    const list = theaterState.preset.activeModules;
    if (list.includes(id)) {
        // å¦‚æœæœ‰ï¼Œå°±åˆ æ‰ (å…³é—­)
        const idx = list.indexOf(id);
        list.splice(idx, 1);
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œå°±åŠ ä¸Š (å¼€å¯)
        list.push(id);
    }
    saveTheaterState();
    renderConsoleUI();
}

// 5. æ•°æ®æŒä¹…åŒ–
function saveTheaterState() {
    // ä¿å­˜é…ç½®
    localStorage.setItem('theater_config', JSON.stringify(theaterState.config));
    // ä¿å­˜é¢„è®¾æ•°æ®
    localStorage.setItem('theater_preset_data', JSON.stringify(theaterState.preset));
    localStorage.setItem('theater_chat_logs', JSON.stringify(theaterState.logs));
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
function loadTheaterState() {
    const c = localStorage.getItem('theater_config');
    if(c) theaterState.config = JSON.parse(c);
    
    const p = localStorage.getItem('theater_preset_data');
    if(p) {
        theaterState.preset = JSON.parse(p);
        renderConsoleUI(); // æ¢å¤åç«‹å³æ¸²æŸ“
    }
}


        function loadTheaterLogs() {
    const s = localStorage.getItem('theater_chat_logs');
    if(s) {
        theaterState.logs = JSON.parse(s);
        // é‡æ–°æ¸²æŸ“å†å²
        const stage = document.getElementById('theater-stage');
        stage.innerHTML = ''; // æ¸…ç©º
        // è·å–è§’è‰²å
        let char = contacts.find(c => c.id === activeContactId) || (contacts[0] || {name:"AI"});
        
        theaterState.logs.forEach(log => {
            const name = log.role === 'user' ? (char.userName || "æˆ‘") : char.name;
            appendTheaterLog(log.role, log.content, name);
        });
    }
}
        // === æœ€ç»ˆå®Œå…¨ä½“ï¼šæµå¼ + ç¼“å†²åŒº + æ­£åˆ™å›æ»šä¿æŠ¤ ===
async function triggerTheaterAI(char) {
    // 1. è·å–é…ç½®
    let apiUrl = theaterState.config.apiUrl || globalConfig.apiUrl;
    let apiKey = theaterState.config.apiKey || globalConfig.apiKey;
    let model = theaterState.config.model || globalConfig.model;

    // 2. åŸºç¡€æ£€æŸ¥
    if (!model) {
        alert("é”™è¯¯ï¼šæœªå¡«å†™æ¨¡å‹ ID (Model ID)ï¼Œè¯·åœ¨å¯¼æ¼”æ§åˆ¶å°å¡«å†™ï¼");
        return;
    }

    const btn = document.querySelector('.theater-send-btn');
    const oldBtnText = btn.innerText;
    btn.innerText = "â³"; 
    btn.disabled = true;

    // 3. UI å ä½ç¬¦
    const aiUiBox = appendTheaterLog('ai', '...', char.name);
    let fullText = ""; 

    try {
        const systemPrompt = assembleSystemPrompt(char);
        
        let userLastMsg = "";
        if (theaterState.logs.length > 0) {
            userLastMsg = theaterState.logs[theaterState.logs.length - 1].content;
        }
        let finalUserContent = runRegex(userLastMsg, 'input');

        const contextMessages = theaterState.logs.slice(0, -1).slice(-10).map(l => ({
            role: l.role,
            content: l.content
        }));

        const messagesToSend = [
            { role: "system", content: systemPrompt },
            ...contextMessages,
            { role: "user", content: finalUserContent }
        ];

        // 1. å…ˆå®šä¹‰å¥½è¯·æ±‚å†…å®¹ (Payload)ï¼Œé¿å…é‡å¤å†™
        const requestPayload = {
            model: model,
            messages: messagesToSend,
            temperature: 1.0, 
            stream: true 
        };

        let res; // å£°æ˜å“åº”å˜é‡

        // 2. æ™ºèƒ½åˆ¤æ–­é€»è¾‘ ğŸ”¥
        // æƒ…å†µ A: å‰§åœºæœ‰ç‹¬ç«‹ Key -> ä½¿ç”¨åŸç”Ÿ fetch (ç›´è¿ï¼Œä¿æŒç‹¬ç«‹æ€§)
        if (theaterState.config.apiKey) {
            res = await fetch(normalizeUrl(apiUrl) + '/chat/completions', {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + apiKey 
                },
                body: JSON.stringify(requestPayload)
            });
        } 
        // æƒ…å†µ B: å‰§åœºæ²¡å¡« Key (æƒ³ç”¨å…¨å±€) -> ä½¿ç”¨ fetchWithRetry (è‡ªåŠ¨å» Google é’¥åŒ™åŒ…é‡Œæ‰¾)
        else {
            res = await fetchWithRetry(normalizeUrl(apiUrl) + '/chat/completions', requestPayload);
        }

        // 3. é”™è¯¯å¤„ç† (ä¿æŒåŸæ ·)
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥ ${res.status}: ${errText.substring(0, 100)}`);
        }

        // === ğŸ”¥ æ ¸å¿ƒ 1: ç¼“å†²åŒºæœºåˆ¶ (éƒ½åœ¨è¿™å„¿) ===
        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            // æ‹¼æ¥æ•°æ®
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop(); // ä¿ç•™æœªå®Œæˆçš„åŠæˆªæ•°æ®

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed === 'data: [DONE]') continue;

                if (trimmed.startsWith('data: ')) {
                    try {
                        const jsonStr = trimmed.replace('data: ', '');
                        const json = JSON.parse(jsonStr);
                        
                        // === ğŸ”¥ æ ¸å¿ƒ 2: å®½å®¹è¯»å– (éƒ½åœ¨è¿™å„¿) ===
                        const delta = json.choices[0].delta?.content || json.choices[0].message?.content || "";
                        
                        if (delta) {
                            fullText += delta;
                            // å®æ—¶æ˜¾ç¤ºï¼Œè®©å­—è¹¦å‡ºæ¥
                            aiUiBox.innerHTML = fullText.replace(/\n/g, '<br>');
                            
                            const stage = document.getElementById('theater-stage');
                            if(stage) stage.scrollTop = stage.scrollHeight;
                        }
                    } catch (e) { 
                        // å¿½ç•¥å•è¡Œè§£æé”™è¯¯
                    }
                }
            }
        }

        if (!fullText) throw new Error("æ”¶åˆ°ç©ºå›å¤");

        // === ğŸ”¥ æ ¸å¿ƒ 3: æ­£åˆ™å›æ»šä¿æŠ¤ (é˜²æ­¢ç¬é—´æ¶ˆå¤±) ===
        // å…ˆå¤‡ä»½åŸå§‹æ–‡æœ¬
        const originalText = fullText;
        
        // å°è¯•åº”ç”¨æ­£åˆ™
        let processedText = runRegex(fullText, 'output');
        
        // åˆ¤æ–­ï¼šå¦‚æœåŸæœ¬æœ‰å­—ï¼Œå¤„ç†åå´æ²¡äº†ï¼Œè¯´æ˜æ­£åˆ™æœ‰é—®é¢˜ï¼
        if (!processedText && originalText.length > 5) {
            console.warn("âš ï¸ è§¦å‘ä¿æŠ¤æœºåˆ¶ï¼šæ­£åˆ™å¤„ç†å¯¼è‡´å†…å®¹ä¸¢å¤±ï¼Œå·²å›æ»šåˆ°åŸæ–‡ã€‚");
            processedText = originalText; // å¼ºåˆ¶å›æ»š
        }
        
        fullText = processedText;

        // æœ€ç»ˆæ›´æ–°
        aiUiBox.innerHTML = fullText.replace(/\n/g, '<br>');
        theaterState.logs.push({ role: 'assistant', content: fullText });
        saveTheaterLogs();

    } catch (e) {
        console.error("Theater Error:", e);
        aiUiBox.innerHTML = `<span style="color:#ff3b30">âŒ é”™è¯¯: ${e.message}</span>`;
    } finally {
        btn.innerText = oldBtnText;
        btn.disabled = false;
    }
}


// 5. æ ¸å¿ƒï¼šç§¯æœ¨æ‹¼è£…å¸ˆ (Assembler) - å‡çº§ç‰ˆ
function assembleSystemPrompt(char) {
    const p = theaterState.preset;
    let parts = [];

    // --- å ä½ç¬¦å¤„ç† ---
    const process = (text) => {
        if(!text) return "";
        let res = text;
        const userName = char.userName || "æˆ‘";
        const charName = char.name || "AI";
        res = res.replace(/{{user}}/gi, userName).replace(/{{user}}/g, userName);
        res = res.replace(/{{char}}/gi, charName).replace(/{{char}}/g, charName);
        return res;
    };

    // 1. è·å–å½“å‰å‰§æœ¬çš„ã€å†å²å‰§æƒ…å­˜æ¡£ã€‘ (è¿™å°±æ˜¯ä½ è¦çš„åŠŸèƒ½ï¼)
    if (theaterState.currentScriptId) {
        const script = allScripts.find(s => s.id === theaterState.currentScriptId);
        if (script && script.archives && script.archives.length > 0) {
            // æŠŠæ‰€æœ‰å­˜æ¡£æ‹¼æ¥èµ·æ¥
            const allSummaries = script.archives.map(a => 
                `[ğŸ“œ å‰§æƒ…å­˜æ¡£ #${a.startFloor}-${a.endFloor}]:\n${a.summary}`
            ).join('\n\n');
            
            parts.push(`
========== ğŸ“œ å†å²å‰§æƒ…å›é¡¾ (Previous Story) ==========
(ä»¥ä¸‹æ˜¯ä¹‹å‰çš„å‰§æƒ…æ‘˜è¦ï¼Œè¯·ä»¥æ­¤ä¸ºèƒŒæ™¯ç»§ç»­æ‰®æ¼”)
${allSummaries}
====================================================
`);
        }
    }

    // 2. ä¸–ç•Œä¹¦ (World Info)
    const inputEl = document.getElementById('theater-input');
    const currentInput = inputEl ? inputEl.value : "";
    const worldInfoContext = scanWorldInfo(currentInput, char);
    if (worldInfoContext) parts.push(worldInfoContext);

    // 3. æ ¸å¿ƒè§„åˆ™ (Core) [å·²ä¿®æ”¹ï¼šå¢åŠ çŠ¶æ€æ£€æŸ¥]
    p.core.forEach(item => {
        // åªæœ‰å¼€å¯çš„æ‰æ‹¼è£…è¿›å»
        if (item.enabled) {
            parts.push(process(item.content));
        }
    });

    // 4. æ–‡é£ (Style)
    if (p.activeStyleId) {
        const style = p.styles.find(s => s.id === p.activeStyleId);
        if (style) parts.push(`\nã€å½“å‰æ¿€æ´»æ–‡é£ã€‘ï¼š\n` + process(style.content));
    }

    // 5. è§’è‰²è®¾å®š
    parts.push(`
    <CharSetting>
    Name: ${char.name}
    Persona: ${char.systemPrompt}
    </CharSetting>
    <UserSetting>
    Name: ${char.userName || "ç”¨æˆ·"}
    Persona: ${char.userPersona || "æ— "}
    </UserSetting>
    `);

    // 6. å°å‰§åœºæ¨¡å—
    if (p.activeModules.length > 0) {
        parts.push(`\nã€ç‰¹æ®Šå‰§åœºæ¨¡å¼å·²å¼€å¯ã€‘ï¼š\n`);
        p.activeModules.forEach(mid => {
            const mod = p.modules.find(m => m.id === mid);
            if (mod) parts.push(process(mod.content));
        });
    }

    return parts.join('\n\n');
}
        // === ğŸŒ ä¸–ç•Œä¹¦æ ¸å¿ƒå¼•æ“ ===

// æ‰«æå¹¶è·å–æ¿€æ´»çš„ä¸–ç•Œä¹¦å†…å®¹
function scanWorldInfo(userText, char) {
    const p = theaterState.preset;
    if (!p.worldInfo || p.worldInfo.length === 0) return "";

    let activeEntries = [];
    
    // 1. å‡†å¤‡æ‰«ææ–‡æœ¬ï¼šç”¨æˆ·çš„æ–°æ¶ˆæ¯ + æœ€è¿‘ 2 æ¡å†å²è®°å½•
    // (è¿™æ ·å³ä½¿ä½ æ²¡æå…³é”®è¯ï¼Œåªè¦ä¸Šä¸‹æ–‡é‡Œæœ‰ï¼ŒAIä¹Ÿèƒ½è®°å¾—)
    let textToScan = userText.toLowerCase();
    const recentLogs = theaterState.logs.slice(-2);
    recentLogs.forEach(l => textToScan += " " + l.content.toLowerCase());

    // 2. éå†æ‰€æœ‰å¯ç”¨çš„æ¡ç›®
    p.worldInfo.forEach(entry => {
        if (!entry.enabled) return;

        // æ£€æŸ¥æ˜¯å¦æ‰‹åŠ¨å¼ºåˆ¶æ¿€æ´» (ç¨ååœ¨UIé‡Œåšè¿™ä¸ªåŠŸèƒ½)
        if (entry.forceActive) {
            activeEntries.push(entry);
            return;
        }

        // å…³é”®è¯åŒ¹é…
        // åªè¦æœ‰ä¸€ä¸ªå…³é”®è¯å‡ºç°åœ¨æ–‡æœ¬ä¸­ï¼Œå°±æ¿€æ´»è¯¥æ¡ç›®
        const isHit = entry.keys.some(key => {
            if(!key) return false;
            return textToScan.includes(key.toLowerCase());
        });

        if (isHit) {
            entry.isActive = true; // æ ‡è®°ä¸ºæ´»è·ƒï¼Œæ–¹ä¾¿UIå±•ç¤º
            activeEntries.push(entry);
        } else {
            entry.isActive = false;
        }
    });

    if (activeEntries.length === 0) return "";

    // 3. ç»„è£… Prompt
    // æŒ‰ç…§é…’é¦†æƒ¯ä¾‹ï¼Œä¸–ç•Œä¹¦é€šå¸¸æ”¾åœ¨æœ€å‰é¢æˆ–æœ€åé¢ã€‚è¿™é‡Œæˆ‘ä»¬å¤„ç†ä¸€ä¸‹å ä½ç¬¦ã€‚
    const worldInfoText = activeEntries.map(e => e.content).join('\n\n');
    
    // ç®€å•çš„å ä½ç¬¦æ›¿æ¢
    const userName = char.userName || "æˆ‘";
    const charName = char.name || "AI";
    let finalInfo = worldInfoText.replace(/{{user}}/gi, userName).replace(/{{char}}/gi, charName);

    return `\nã€ä¸–ç•Œä¹¦/çŸ¥è¯†åº“ (World Info)ã€‘:\n${finalInfo}\n`;
}
        function toggleWorldInfoForce(index) {
    const item = theaterState.preset.worldInfo[index];
    if (!item.enabled) return; // æ²¡å¼€å¯çš„ä¸èƒ½å¼ºåˆ¶
    item.forceActive = !item.forceActive;
    saveTheaterState();
    renderConsoleUI();
}

function toggleWorldInfoEnable(index) {
    const item = theaterState.preset.worldInfo[index];
    item.enabled = !item.enabled;
    // å¦‚æœç¦ç”¨äº†ï¼Œä¹Ÿé¡ºä¾¿å–æ¶ˆå¼ºåˆ¶
    if (!item.enabled) item.forceActive = false;
    saveTheaterState();
    renderConsoleUI();
}
        // === æœ€ç»ˆä¿®æ­£ç‰ˆï¼šå¸¦â€œé˜²è¯¯åˆ æŠ¥è­¦â€çš„æ­£åˆ™å¼•æ“ ===
function runRegex(text, placementType) {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!theaterState.preset || !theaterState.preset.regexScripts) return text;
    if (typeof text !== 'string') return text;
    
    const scripts = theaterState.preset.regexScripts;
    if (scripts.length === 0) return text;

    let processedText = text;

    scripts.forEach(script => {
        // è·³è¿‡ç¦ç”¨çš„è„šæœ¬
        if (script.disabled) return;
        
        const targetEnum = placementType === 'input' ? 1 : 2;
        const pl = script.placement || [1, 2];
        
        if (pl.includes(targetEnum)) {
            try {
                if (script.regex) {
                    // å¤‡ä»½å¤„ç†å‰çš„æ–‡æœ¬
                    const before = processedText;
                    
                    const re = new RegExp(script.regex, 'gim');
                    const replaceStr = script.replacement === undefined ? "" : script.replacement;
                    
                    // æ‰§è¡Œæ›¿æ¢
                    let after = processedText.replace(re, replaceStr);

                    // ğŸ”¥ æ ¸å¿ƒä¿æŠ¤æœºåˆ¶ ğŸ”¥
                    // å¦‚æœå¤„ç†å‰æœ‰å­— (å¤§äº5ä¸ª)ï¼Œå¤„ç†åå˜æˆäº†ç©ºå­—ç¬¦ä¸²æˆ–çº¯ç©ºç™½
                    // è¯´æ˜è¿™ä¸ªè„šæœ¬æ­£åœ¨â€œæ€äººç­å£â€
                    if (before.trim().length > 5 && after.trim().length === 0) {
                        console.warn(`âš ï¸ æ‹¦æˆªåˆ°å±é™©æ­£åˆ™ [${script.scriptName}]ï¼Œå®ƒè¯•å›¾æ¸…ç©ºæ‰€æœ‰å›å¤ï¼å·²å¼ºåˆ¶å¿½ç•¥ã€‚`);
                        // ä¿æŒåŸæ ·ï¼Œä¸åº”ç”¨è¿™æ¬¡æ›¿æ¢
                        after = before; 
                    }

                    processedText = after;
                }
            } catch (e) {
                console.warn(`æ­£åˆ™è„šæœ¬ [${script.scriptName}] è¿è¡Œå‡ºé”™:`, e);
            }
        }
    });
    
    return processedText;
}
        // === ğŸ“¡ åŠŸèƒ½ 1ï¼šåªæ‹‰å–æ¨¡å‹åˆ—è¡¨ ===
async function fetchTheaterModels() {
    const urlInput = document.getElementById('t-api-url');
    const keyInput = document.getElementById('t-api-key');
    const btn = event.target; 

    let apiUrl = urlInput.value.trim();
    let apiKey = keyInput.value.trim();

    if (!apiUrl || !apiKey) return alert("è¯·å…ˆå¡«å…¥ API URL å’Œ Keyï¼");

    const oldText = btn.innerText;
    btn.innerText = "â³...";
    btn.disabled = true;

    try {
        const cleanUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        const res = await fetch(cleanUrl + '/models', {
            method: 'GET',
            headers: { "Authorization": "Bearer " + apiKey }
        });

        if (!res.ok) throw new Error("æ‹‰å–å¤±è´¥ (Code: " + res.status + ")");

        const data = await res.json();
        let list = data.data || data.models || []; // å…¼å®¹ OpenAI/Google

        if (!Array.isArray(list)) throw new Error("æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°åˆ—è¡¨");

        const select = document.getElementById('t-model-select');
        select.innerHTML = '<option value="" disabled selected>ğŸ‘‡ è¯·é€‰æ‹©æ¨¡å‹...</option>';

        list.sort((a, b) => a.id.localeCompare(b.id));
        list.forEach(m => {
            const id = m.id.replace('models/', '');
            if (id.includes('embedding')) return;
            const opt = document.createElement('option');
            opt.value = id;
            opt.innerText = id;
            select.appendChild(opt);
        });

        document.getElementById('t-model-select-box').style.display = 'block';
        // æˆåŠŸæç¤º
        if(navigator.vibrate) navigator.vibrate(50);

    } catch (e) {
        alert("âŒ " + e.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// === ğŸ“¡ åŠŸèƒ½ 2ï¼šçœŸå®å¯¹è¯æµ‹è¯• (éªŒè¯æ¨¡å‹å¯ç”¨æ€§) ===
async function testTheaterConnection() {
    const urlInput = document.getElementById('t-api-url');
    const keyInput = document.getElementById('t-api-key');
    const modelInput = document.getElementById('t-model');
    const btn = event.target;

    let apiUrl = urlInput.value.trim();
    let apiKey = keyInput.value.trim();
    let model = modelInput.value.trim();

    if (!apiUrl || !apiKey) return alert("ç¼º URL æˆ– Keyï¼");
    if (!model) return alert("è¯·å…ˆã€æ‹‰å–æ¨¡å‹ã€‘å¹¶é€‰æ‹©ä¸€ä¸ª Model IDï¼");

    const oldText = btn.innerText;
    btn.innerText = "æµ‹è¯•ä¸­...";
    btn.disabled = true;

    try {
        const cleanUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        
        // å‘é€ä¸€ä¸ªæç®€çš„è¯·æ±‚
        const res = await fetch(cleanUrl + '/chat/completions', {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": "Bearer " + apiKey 
            },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: "Hi" }],
                max_tokens: 5 // çœé’±ï¼Œåªæµ‹é€šä¸é€š
            })
        });

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(`é”™è¯¯ ${res.status}: ${errData.error?.message || res.statusText}`);
        }

        // æˆåŠŸï¼
        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "OK";
        alert(`ğŸ‰ æµ‹è¯•é€šè¿‡ï¼\næ¨¡å‹ [${model}] å“åº”æ­£å¸¸ã€‚\nå›å¤: ${reply}`);

    } catch (e) {
        alert("âŒ è¿æ¥å¤±è´¥:\n" + e.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}
        // ========================================================
// ğŸ› ï¸ è¡¥ä¸ï¼šè‡ªåŠ¨æ³¨å…¥â€œä¸–ç•Œä¹¦ç¼–è¾‘å¼¹çª—â€ HTML
// ========================================================
(function injectWorldEditorModal() {
    if (document.getElementById('modal-world-edit')) return; // é˜²æ­¢é‡å¤æ³¨å…¥

    const html = `
    <div class="modal-overlay" id="modal-world-edit" style="z-index: 600;">
        <div class="modal-box" style="height: 70%; background: #222; color: #eee; border: 1px solid #444;">
            <div class="modal-header" style="background: #1a1a1a; border-bottom: 1px solid #333;">
                <button onclick="closeModal('modal-world-edit')" style="color:#999;">å–æ¶ˆ</button>
                <span style="color:#fff; font-weight:bold;">ç¼–è¾‘è¯æ¡</span>
                <button onclick="saveWorldEntry()" style="color:#007AFF; font-weight:bold;">ä¿å­˜</button>
            </div>
            <div class="modal-body" style="padding: 15px; background: #222;">
                <input type="hidden" id="we-index">
                
                <div style="margin-bottom:15px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">è¯æ¡åç§° (æ³¨é‡Š)</div>
                    <input type="text" id="we-comment" class="t-input" placeholder="ä¾‹å¦‚: æ­¤æ—¶çš„åœ°ç‚¹ / ä¹Ÿå°±æ˜¯ä¸ªå¤‡æ³¨">
                </div>

                <div style="margin-bottom:15px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">è§¦å‘å…³é”®è¯ (é€—å·åˆ†éš”)</div>
                    <input type="text" id="we-keys" class="t-input" placeholder="ä¾‹å¦‚: å¨æˆ¿, åšé¥­, å†°ç®±">
                </div>

                <div style="margin-bottom:15px; flex:1; display:flex; flex-direction:column;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">å†…å®¹ (Prompt)</div>
                    <textarea id="we-content" class="t-input" style="flex:1; min-height:150px; line-height:1.5;" placeholder="å½“æ£€æµ‹åˆ°å…³é”®è¯æ—¶ï¼Œè¿™æ®µè¯ä¼šè¢«æ³¨å…¥ç»™ AI..."></textarea>
                </div>

                <div style="display:flex; gap:15px; border-top:1px solid #333; padding-top:15px;">
                    <label style="display:flex; align-items:center; gap:5px; color:#ccc; font-size:14px;">
                        <input type="checkbox" id="we-force" style="width:16px; height:16px;"> å¼ºåˆ¶ä¸€ç›´ç”Ÿæ•ˆ (å¸¸é©»)
                    </label>
                </div>

                <button onclick="deleteWorldEntry()" style="width:100%; margin-top:20px; padding:12px; background:#3a1111; color:#ff3b30; border:1px solid #521818; border-radius:8px;">
                    åˆ é™¤æ­¤æ¡ç›®
                </button>
            </div>
        </div>
    </div>`;

    // æ’å…¥åˆ° body æœ«å°¾
    document.body.insertAdjacentHTML('beforeend', html);
})();
        // ==========================================
// --- ğŸ­ å‰§åœºæ¨¡å¼ï¼šå‰§æƒ…æ€»ç»“ä¸å­˜æ¡£åŠŸèƒ½ ---
// ==========================================

async function generateTheaterSummary() {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!theaterState.currentScriptId) return alert("è¯·å…ˆè¿›å…¥ä¸€ä¸ªå‰§æœ¬ï¼");
    if (!theaterState.logs || theaterState.logs.length === 0) return alert("å‰§æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œæ²¡æ³•æ€»ç»“å“¦ã€‚");
    if (!globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Keyã€‚");

    // 2. å‡†å¤‡æŒ‰é’®åŠ¨ç”»
    const btn = event.currentTarget; // è·å–ç‚¹å‡»çš„æŒ‰é’®
    const oldIcon = btn.innerText;
    btn.innerText = "â³"; // å˜æˆæ¼æ–—
    btn.disabled = true;

    try {
        // 3. æ•´ç†å…¨æ–‡ (æå–çº¯æ–‡æœ¬)
        // æ³¨æ„ï¼šä¸ºäº†çœé’±å’Œé˜²è¶…é•¿ï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶åªå–æœ€è¿‘çš„ 15000 å­—ï¼Œæˆ–è€…å…¨éƒ¨
        // è¿™é‡Œé»˜è®¤å…¨éƒ¨ï¼Œå¦‚æœå¤ªé•¿å¯èƒ½ä¼šè¢« API æˆªæ–­
        const fullStory = theaterState.logs
            .map(l => {
                const roleName = l.role === 'user' ? 'ç”¨æˆ·' : 'è§’è‰²';
                // è¿‡æ»¤æ‰ä¹‹å‰çš„æ€»ç»“å¡ç‰‡ï¼Œé˜²æ­¢æ€»ç»“å¥—æ€»ç»“
                if (l.role === 'system') return ""; 
                return `${roleName}: ${l.content}`;
            })
            .join('\n');

        if (fullStory.length < 100) {
            throw new Error("å‰§æƒ…å¤ªçŸ­äº†ï¼Œè¿˜æ˜¯å¤šèŠå‡ å¥å†æ€»ç»“å§ï¼");
        }

        // 4. æ„å»º Prompt
        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰§æƒ…è®°å½•å‘˜ã€‚è¯·é˜…è¯»ä»¥ä¸‹ã€å‰§æœ¬å¯¹è¯è®°å½•ã€‘ï¼Œå¹¶ç”Ÿæˆä¸€ä»½ã€å‰§æƒ…æ‘˜è¦å­˜æ¡£ã€‘ã€‚
        
        ã€è¦æ±‚ã€‘ï¼š
        1. æ¦‚æ‹¬ä»å¼€å¤´åˆ°ç°åœ¨å‘ç”Ÿçš„æ ¸å¿ƒäº‹ä»¶ã€å…³é”®è½¬æŠ˜ã€äººç‰©å…³ç³»è¿›å±•ã€‚
        2. å¿½ç•¥æ— å…³ç´§è¦çš„é—²èŠã€‚
        3. æ ¼å¼æ¸…æ™°ï¼Œåˆ†æ®µè½ã€‚
        4. å­—æ•°æ§åˆ¶åœ¨ 300-500 å­—ä»¥å†…ã€‚
        5. è¿™æ˜¯ä¸ºäº†è®©ä½ ï¼ˆAIï¼‰åœ¨åç»­æ‰®æ¼”ä¸­èƒ½è®°å¾—ä¹‹å‰çš„å‰§æƒ…ï¼Œæ‰€ä»¥è¯·ä¿ç•™é‡è¦ç»†èŠ‚ï¼ˆå¦‚ç‰©å“ã€çº¦å®šã€ç§˜å¯†ï¼‰ã€‚

        ã€å¯¹è¯è®°å½•ã€‘ï¼š
        ${fullStory.substring(0, 30000)} 
        `; // é™åˆ¶ 3ä¸‡å­—ç¬¦é˜²æ­¢çˆ† Token

        // 5. å‘é€è¯·æ±‚
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.5 // æ€»ç»“éœ€è¦å‡†ç¡®ï¼Œæ¸©åº¦ä½ä¸€ç‚¹
        });

        if (!res.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
        
        const data = await res.json();
        const summary = data.choices[0].message.content;

        // 6. æ„é€ ç³»ç»Ÿå­˜æ¡£æ¶ˆæ¯ (Formatted for AI context)
        const systemNote = `
--- å‰§æƒ…å­˜æ¡£ç‚¹ (${new Date().toLocaleString()}) ---
${summary}
---------------------------------------------
[ç³»ç»ŸæŒ‡ä»¤]: ä»¥ä¸Šæ˜¯æˆªæ­¢ç›®å‰çš„å‰§æƒ…æ‘˜è¦ã€‚è¯·å°†å…¶ä½œä¸ºã€é•¿æœŸè®°å¿†ã€‘çº³å…¥è€ƒé‡ï¼Œä¿æŒå‰§æƒ…è¿è´¯æ€§ã€‚
`;

        // 7. å†™å…¥æ•°æ®
        const newLog = { 
            role: 'system', // æ ‡è®°ä¸ºç³»ç»Ÿæ¶ˆæ¯
            content: systemNote 
        };
        theaterState.logs.push(newLog);
        saveTheaterLogs();

        // 8. ä¸Šå±æ¸²æŸ“ (ä½¿ç”¨æˆ‘ä»¬åˆšæ‰å†™çš„ç‰¹æ®Šæ ·å¼)
        appendSystemCard(systemNote);

        // 9. æ»šåŠ¨åˆ°åº•éƒ¨
        const stage = document.getElementById('theater-stage');
        setTimeout(() => { stage.scrollTop = stage.scrollHeight; }, 100);

    } catch (e) {
        alert("æ€»ç»“å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldIcon;
        btn.disabled = false;
    }
}

// è¾…åŠ©ï¼šæ¸²æŸ“ç³»ç»Ÿå¡ç‰‡åˆ°èˆå°
function appendSystemCard(text) {
    const stage = document.getElementById('theater-stage');
    const div = document.createElement('div');
    div.className = 't-msg-block system';
    
    // æ¸…æ´—æ–‡æœ¬ï¼Œå»æ‰ä¸éœ€è¦æ˜¾ç¤ºçš„æŒ‡ä»¤éƒ¨åˆ†ï¼Œåªæ˜¾ç¤ºæ‘˜è¦ç»™ç”¨æˆ·çœ‹
    // è®©æ˜¾ç¤ºç¨å¾®ç¾è§‚ä¸€ç‚¹
    let displayText = text.replace("[ç³»ç»ŸæŒ‡ä»¤]: ä»¥ä¸Šæ˜¯æˆªæ­¢ç›®å‰çš„å‰§æƒ…æ‘˜è¦ã€‚è¯·å°†å…¶ä½œä¸ºã€é•¿æœŸè®°å¿†ã€‘çº³å…¥è€ƒé‡ï¼Œä¿æŒå‰§æƒ…è¿è´¯æ€§ã€‚", "");
    displayText = displayText.replace(/\n/g, '<br>');

    div.innerHTML = `
        <div class="t-system-card">
            <div class="t-system-header">è®°å¿†å­˜æ¡£</div>
            <div>${displayText}</div>
        </div>
    `;
    stage.appendChild(div);
}
        (function injectArchiveModal() {
    if (document.getElementById('modal-theater-archives')) return;

    const html = `
    <div class="modal-overlay" id="modal-theater-archives" style="z-index: 650;">
        <div class="modal-box" style="height: 70%; background: #222; color: #eee; border: 1px solid #444;">
            <div class="modal-header" style="background: #1a1a1a; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <button onclick="closeModal('modal-theater-archives')" style="color:#999; background:none; border:none;">å…³é—­</button>
                <span style="color:#fff; font-weight:bold;">å‰§æƒ…æ¡£æ¡ˆå®¤</span>
                <button onclick="openCreateArchiveView()" style="color:#007AFF; font-weight:bold; font-size:24px; background:none; border:none;">+</button>
            </div>
            
            <div id="archive-list-view" class="modal-body" style="padding: 15px; background: #222;">
                </div>

            <div id="archive-create-view" class="modal-body" style="padding: 20px; background: #222; display:none;">
                <div class="t-group-title">é€‰æ‹©å‰§æƒ…èŒƒå›´ (æ¥¼å±‚å·)</div>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="number" id="arc-start" class="t-input" placeholder="å¼€å§‹æ¥¼å±‚" style="text-align:center;">
                    <span style="line-height:40px;">è‡³</span>
                    <input type="number" id="arc-end" class="t-input" placeholder="ç»“æŸæ¥¼å±‚" style="text-align:center;">
                </div>
                <div style="text-align:center; font-size:12px; color:#666; margin-bottom:20px;">
                    å½“å‰å…± <span id="arc-total-floors">0</span> å±‚
                </div>
                <button onclick="doGenerateArchive()" class="ios-btn" style="background:#007AFF; color:#fff; border-radius:8px;">AI ç”Ÿæˆå‰§æƒ…æ‘˜è¦</button>
                <button onclick="backToArchiveList()" class="ios-btn" style="background:#333; color:#ccc; border-radius:8px; margin-top:10px;">è¿”å›åˆ—è¡¨</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
})();
        // ==========================================
// --- ğŸ“œ å‰§åœºæ¨¡å¼ï¼šåå°æ¡£æ¡ˆå®¤é€»è¾‘ ---
// ==========================================

// 1. æ‰“å¼€æ¡£æ¡ˆå®¤
function openArchiveModal() {
    if (!theaterState.currentScriptId) return alert("è¯·å…ˆè¿›å…¥å‰§æœ¬");
    renderArchiveList();
    
    // é‡ç½®è§†å›¾
    document.getElementById('archive-list-view').style.display = 'block';
    document.getElementById('archive-create-view').style.display = 'none';
    
    openModal('modal-theater-archives');
}

// 2. æ¸²æŸ“åˆ—è¡¨ (å‡çº§ç‰ˆï¼šå¸¦åŒæ­¥åŠŸèƒ½)
function renderArchiveList() {
    const container = document.getElementById('archive-list-view');
    container.innerHTML = '';

    // è·å–å½“å‰å‰§æœ¬
    const script = allScripts.find(s => s.id === theaterState.currentScriptId);
    if (!script.archives) script.archives = [];

    if (script.archives.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px;">æš‚æ— å­˜æ¡£<br>ç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºé˜¶æ®µæ€§æ€»ç»“</div>';
        return;
    }

    // å€’åºæ˜¾ç¤º
    [...script.archives].reverse().forEach((arc, index) => {
        // åŸå§‹ç´¢å¼•
        const realIndex = script.archives.length - 1 - index;
        
        const div = document.createElement('div');
        div.className = 'archive-card';
        div.innerHTML = `
            <div class="archive-header">
                <span>å­˜æ¡£: #${arc.startFloor} - #${arc.endFloor}</span>
                <div style="display:flex; gap:10px;">
                    <span onclick="syncArchiveToMemory(${realIndex})" style="cursor:pointer; color:#007AFF;" title="åŒæ­¥åˆ°å¹³æ—¶èŠå¤©çš„è®°å¿†åº“">ğŸ“¤ åŒæ­¥</span>
                    <span onclick="deleteArchive(${realIndex})" style="cursor:pointer; color:#ff3b30;">Ã—</span>
                </div>
            </div>
            <div class="archive-body" onclick="alert('${arc.summary.replace(/\n/g, '\\n')}')">${arc.summary}</div>
        `;
        container.appendChild(div);
    });
}

// âœ¨ æ–°å¢ï¼šåŒæ­¥åŠŸèƒ½
function syncArchiveToMemory(index) {
    const script = allScripts.find(s => s.id === theaterState.currentScriptId);
    if(!script || !script.archives[index]) return;

    const summary = script.archives[index].summary;
    const charId = script.charId; // å‰§æœ¬å…³è”çš„è§’è‰²ID
    
    const char = contacts.find(c => c.id === charId);
    if (!char) return alert("æ‰¾ä¸åˆ°å…³è”çš„è§’è‰²ï¼Œæ— æ³•åŒæ­¥ï¼");

    if (!char.memories) char.memories = [];

    // æ„é€ ä¸€æ¡è®°å¿†
    const memoryText = `[å‰§åœºå‰§æƒ…å›å¿†]: ${summary}`;
    
    // æŸ¥é‡ï¼šé¿å…é‡å¤æ·»åŠ 
    if (char.memories.includes(memoryText)) {
        return alert("è¿™æ¡å­˜æ¡£å·²ç»åŒæ­¥è¿‡äº†ï¼");
    }

    char.memories.push(memoryText);
    saveData(); // ä¿å­˜åˆ°å…¨å±€è”ç³»äººæ•°æ®

    alert(`âœ… å·²åŒæ­¥ï¼\n\nç°åœ¨ "${char.name}" åœ¨å¹³æ—¶èŠå¤©æ—¶ï¼Œä¹Ÿèƒ½è®°å¾—è¿™æ®µå‰§æƒ…äº†ã€‚`);
}

// 3. æ‰“å¼€æ–°å»ºè§†å›¾
function openCreateArchiveView() {
    document.getElementById('archive-list-view').style.display = 'none';
    document.getElementById('archive-create-view').style.display = 'block';
    
    // è‡ªåŠ¨å¡«å…¥æ¥¼å±‚å»ºè®®
    const total = theaterState.logs.length;
    document.getElementById('arc-total-floors').innerText = total;
    
    // æ™ºèƒ½å»ºè®®ï¼šä»ä¸Šæ¬¡å­˜æ¡£çš„ç»“æŸä½ç½®+1 å¼€å§‹ï¼Œåˆ°æœ€æ–°
    const script = allScripts.find(s => s.id === theaterState.currentScriptId);
    let suggestStart = 1;
    if (script && script.archives && script.archives.length > 0) {
        const lastArc = script.archives[script.archives.length - 1];
        suggestStart = lastArc.endFloor + 1;
    }
    
    document.getElementById('arc-start').value = Math.min(suggestStart, total);
    document.getElementById('arc-end').value = total;
}

function backToArchiveList() {
    document.getElementById('archive-list-view').style.display = 'block';
    document.getElementById('archive-create-view').style.display = 'none';
}

// 4. æ‰§è¡Œç”Ÿæˆ (AI)
async function doGenerateArchive() {
    const start = parseInt(document.getElementById('arc-start').value);
    const end = parseInt(document.getElementById('arc-end').value);
    const total = theaterState.logs.length;

    if (isNaN(start) || isNaN(end) || start > end || start < 1) return alert("æ¥¼å±‚èŒƒå›´æ— æ•ˆ");
    if (end > total) return alert(`ç›®å‰åªæœ‰ ${total} å±‚`);

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨é˜…è¯»å¹¶æ€»ç»“...";
    btn.disabled = true;

    try {
        // æå–æŒ‡å®šèŒƒå›´çš„æ–‡æœ¬
        // logs ç´¢å¼•æ˜¯ 0-basedï¼Œæ¥¼å±‚æ˜¯ 1-based
        const slice = theaterState.logs.slice(start - 1, end);
        const contextText = slice.map(l => `${l.role==='user'?'ç”¨æˆ·': l.role}: ${l.content}`).join('\n');

        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªå‰§æœ¬è®°å½•å‘˜ã€‚è¯·é˜…è¯»ä»¥ä¸‹ã€${start}æ¥¼ åˆ° ${end}æ¥¼ã€‘çš„å‰§æƒ…ç‰‡æ®µã€‚
        è¯·ç”Ÿæˆä¸€æ®µè¯¦ç»†çš„ã€å‰§æƒ…å­˜æ¡£æ€»ç»“ã€‘ã€‚
        
        è¦æ±‚ï¼š
        1. æ¦‚æ‹¬è¿™æ®µæ—¶é—´å†…å‘ç”Ÿçš„æ ¸å¿ƒäº‹ä»¶ã€è§’è‰²æƒ…æ„Ÿå˜åŒ–ã€å…³é”®çº¿ç´¢ã€‚
        2. å¿½ç•¥æ— æ„ä¹‰çš„é—²èŠï¼Œåªä¿ç•™å¯¹åç»­å‰§æƒ…æœ‰å½±å“çš„ä¿¡æ¯ã€‚
        3. å­—æ•° 200-400 å­—ã€‚
        4. è¿™æ˜¯ä¸ºäº†å­˜å…¥æ•°æ®åº“ä¾›åç»­æ£€ç´¢ï¼Œæ‰€ä»¥è¦å®¢è§‚ã€å‡†ç¡®ã€‚
        
        å‰§æƒ…ç‰‡æ®µï¼š
        ${contextText.substring(0, 20000)}
        `;

        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.5
        });

        if (!res.ok) throw new Error("API Error");
        const data = await res.json();
        const summary = data.choices[0].message.content;

        // å­˜å…¥å½“å‰å‰§æœ¬çš„ archives æ•°ç»„
        const script = allScripts.find(s => s.id === theaterState.currentScriptId);
        if (!script.archives) script.archives = [];
        
        script.archives.push({
            id: Date.now(),
            startFloor: start,
            endFloor: end,
            summary: summary,
            timestamp: Date.now()
        });
        
        // ä¿å­˜åˆ° localStorage
        saveAllScripts();

        alert("âœ… å­˜æ¡£æˆåŠŸï¼");
        backToArchiveList();
        renderArchiveList();

    } catch(e) {
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

function deleteArchive(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡å­˜æ¡£å—ï¼Ÿ")) {
        const script = allScripts.find(s => s.id === theaterState.currentScriptId);
        if(script && script.archives) {
            script.archives.splice(index, 1);
            saveAllScripts();
            renderArchiveList();
        }
    }
}
        // ==========================================
// --- ğŸ­ å‰§åœºæ¨¡å¼ï¼šé‡åˆ·åŠŸèƒ½ (æ™ºèƒ½å®¹é”™ç‰ˆ) ---
// ==========================================

async function rerollTheaterMsg() {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!theaterState.currentScriptId) return;
    const logs = theaterState.logs;
    
    if (!logs || logs.length === 0) return;

    // 2. è·å–æœ€åä¸€æ¡æ¶ˆæ¯
    const lastMsg = logs[logs.length - 1];
    
    // === æ ¸å¿ƒä¿®æ”¹é€»è¾‘ ===
    
    // æƒ…å†µ A: æœ€åä¸€æ¡æ˜¯ AI å‘çš„ (æˆ–è€…ç³»ç»ŸæŠ¥é”™ä¿¡æ¯)
    // -> ä¹Ÿå°±æ˜¯ä½ è¦â€œæ¨å€’é‡æ¥â€ï¼Œéœ€è¦å…ˆåˆ æ‰è¿™ä¸€æ¡
    if (lastMsg.role === 'assistant') {
        // åˆ é™¤æ•°æ®
        logs.pop(); 
        saveTheaterLogs();

        // åˆ é™¤ç•Œé¢ä¸Šçš„æ°”æ³¡
        const stage = document.getElementById('theater-stage');
        const blocks = stage.querySelectorAll('.t-msg-block');
        if (blocks.length > 0) {
            blocks[blocks.length - 1].remove();
        }
    }
    
    // æƒ…å†µ B: æœ€åä¸€æ¡æ˜¯ User å‘çš„ (è¯´æ˜ä¸Šæ¬¡è¯·æ±‚å½»åº•å¤±è´¥äº†ï¼Œè¿è®°å½•éƒ½æ²¡ç•™ä¸‹)
    // -> ä¸éœ€è¦åˆ ä»»ä½•ä¸œè¥¿ï¼Œç›´æ¥è®© AI å†è¯•ä¸€æ¬¡å°±è¡Œ

    // æƒ…å†µ C: å¦‚æœåˆ å®Œ AI æ¶ˆæ¯åï¼Œå‘ç°ä¸Šä¸€æ¡ä¸æ˜¯ User (æ¯”å¦‚æ˜¯ç³»ç»Ÿæç¤º)ï¼Œé‚£ä¹Ÿæ²¡æ³•æ¥è¯
    // ç¨å¾®æ£€æŸ¥ä¸€ä¸‹ç°åœ¨çš„â€œæœ€åä¸€æ¡â€
    const newLast = logs[logs.length - 1];
    if (!newLast || newLast.role === 'system') {
        // è™½ç„¶é€šå¸¸ä¸ä¼šå‘ç”Ÿï¼Œä½†ä¹Ÿé˜²ä¸€æ‰‹
        // å¦‚æœä½ æƒ³è®©å®ƒå¼ºè¡Œç»­å†™ç³»ç»Ÿæç¤ºï¼Œä¹Ÿå¯ä»¥å»æ‰è¿™ä¸ª return
        return alert("æ‰¾ä¸åˆ°ä¸Šä¸€æ¡ç”¨æˆ·å‘è¨€ï¼Œæ— æ³•é‡åˆ·ã€‚");
    }

    // 3. é‡æ–°å¬å”¤ AI
    const script = allScripts.find(s => s.id === theaterState.currentScriptId);
    if (script) {
        const char = contacts.find(c => c.id === script.charId);
        if (char) {
            await triggerTheaterAI(char);
        }
    }
}
        // ==========================================
// --- ğŸ–¼ï¸ ç›¸å†Œç³»ç»Ÿ (Gallery) æ ¸å¿ƒé€»è¾‘ ---
// ==========================================

// ç”¨äºæœç´¢çš„è½»é‡çº§ç´¢å¼• (å­˜ LocalStorage)
let galleryIndex = []; 
let currentViewingPhotoId = null; // è®°å½•å½“å‰æ­£åœ¨çœ‹çš„ç…§ç‰‡ID
// æ ¼å¼: [{id, caption, tags: [], summary: "", timestamp}]

// 1. åˆå§‹åŒ–
function initGallery() {
    const saved = localStorage.getItem('ai_phone_gallery_index');
    if (saved) galleryIndex = JSON.parse(saved);
}
window.addEventListener('load', initGallery);

// 2. åŠ è½½ç›¸å†Œåˆ—è¡¨
async function loadGalleryImages() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';

    // å€’åºï¼šæœ€æ–°çš„åœ¨å‰é¢
    const sorted = [...galleryIndex].reverse();

    // ä» IndexedDB æ‡’åŠ è½½å›¾ç‰‡ï¼Ÿ
    // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œåªç”Ÿæˆæ ¼å­ï¼Œå›¾ç‰‡ src ç­‰é‡åˆ°æ—¶å†å» DB å– (æˆ–è€…å­˜ Base64 ç¼©ç•¥å›¾åœ¨ LocalStorage)
    // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾ galleryIndex é‡Œè¿˜æ²¡å­˜å›¾ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½å» DB å– (è™½ç„¶æœ‰ç‚¹æ…¢ï¼Œä½†æœ€ç¨³)
    
    // è·å– DB è¿æ¥
    const db = await openDB();
    const tx = db.transaction(galleryStoreName, 'readonly');
    const store = tx.objectStore(galleryStoreName);
    const allReq = store.getAll();

    allReq.onsuccess = () => {
        const allPhotos = allReq.result;
        // æ’åº
        allPhotos.sort((a,b) => b.timestamp - a.timestamp);
        
        if (allPhotos.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#ccc;">æš‚æ— ç…§ç‰‡</div>';
            return;
        }

        allPhotos.forEach(photo => {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.onclick = () => openPhotoDetail(photo);
            
            // ä½¿ç”¨å‹ç¼©åçš„å›¾
            div.innerHTML = `<img src="${photo.imageBlob}" class="gallery-thumb" loading="lazy">`;
            grid.appendChild(div);
        });
    };
}

// 3. ä¸Šä¼ æµç¨‹
function openPhotoUploadModal() {
    document.getElementById('gallery-file-input').value = '';
    document.getElementById('gallery-preview-img').style.display = 'none';
    document.getElementById('gallery-upload-tip').style.display = 'block';
    document.getElementById('gallery-caption-input').value = '';
    openModal('modal-upload-photo');
}

// é¢„è§ˆ + å‹ç¼©
let currentUploadBase64 = null;

async function previewGalleryUpload(e) {
    const file = e.target.files[0];
    if(!file) return;
    
    // å‹ç¼©å›¾ç‰‡ (é™åˆ¶æœ€å¤§å®½/é«˜ 1024px, è´¨é‡ 0.7)
    currentUploadBase64 = await compressImage(file, 1024, 0.7);
    
    const img = document.getElementById('gallery-preview-img');
    img.src = currentUploadBase64;
    img.style.display = 'block';
    document.getElementById('gallery-upload-tip').style.display = 'none';
}

// å›¾ç‰‡å‹ç¼©å·¥å…·
function compressImage(file, maxWidth, quality) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxWidth) {
                        width *= maxWidth / height;
                        height = maxWidth;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
        };
    });
}

// æäº¤å‘å¸ƒ (ä¿®å¤ç‰ˆï¼šé˜²æˆªæ–­ + æ›´ç¨³çš„åˆ†éš”ç¬¦)
async function submitPhotoPost() {
    if (!currentUploadBase64) return alert("è¯·å…ˆé€‰æ‹©ç…§ç‰‡");
    const caption = document.getElementById('gallery-caption-input').value.trim();
    const char = getActiveChar(); 
    
    if (!char) return alert("è¯·å…ˆåœ¨ã€ä¿¡æ¯ã€‘åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼");
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");

    const btn = document.getElementById('btn-submit-photo');
    btn.innerText = "AI æ­£åœ¨çœ‹å›¾...";
    btn.disabled = true;

    try {
        // --- 1. ä¿®æ”¹ Promptï¼šä½¿ç”¨ ### åˆ†éš”ç¬¦ï¼Œå¹¶æ”¾å®½å­—æ•°é™åˆ¶ ---
        const prompt = `
        ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘äº†ä¸€å¼ ç…§ç‰‡ã€‚
        ã€ç”¨æˆ·é…æ–‡ã€‘ï¼š${caption || "æ— "}
        
        è¯·ä½ ä»¥ "${char.name}" çš„èº«ä»½ï¼ˆäººè®¾ï¼š${char.systemPrompt}ï¼‰æ¥çœ‹è¿™å¼ ç…§ç‰‡ã€‚
        
        è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šæ ¼å¼è¾“å‡ºï¼š
        
        1. ä»”ç»†çœ‹å›¾ã€‚
        2. ä»¥ä½ çš„å£å»å†™ä¸€æ®µ50å­—ä»¥å†…çš„è¯„è®ºï¼ˆæ‰¹æ³¨ï¼‰ã€‚
        3. æå– 3-5 ä¸ªå…³äºç…§ç‰‡å†…å®¹çš„å…³é”®è¯ï¼ˆTagsï¼‰ï¼ŒåŒ…å«ç‰©ä½“å (å¦‚: çŒ«, æ±½è½¦)ã€åœºæ™¯ (å¦‚: æµ·è¾¹, å§å®¤)ã€æ°›å›´ (å¦‚: æ¸©é¦¨, æç¬‘)ã€é¢œè‰²ç­‰ã€‚ç”¨äºæ—¥åå›å¿†ã€‚
        4. ç”¨ä¸€å¥è¯å®¢è§‚æè¿°è¿™å¼ å›¾çš„å†…å®¹ï¼ˆVisual Summaryï¼‰ï¼Œç”¨äºè¾…åŠ©ä½ æ—¥åå›å¿†ç”»é¢ã€‚
        
        ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘ï¼š
        è¯„è®ºå†…å®¹ ### æ ‡ç­¾1, æ ‡ç­¾2, æ ‡ç­¾3 ### å®¢è§‚ç”»é¢æè¿°
        
        (æ³¨æ„ï¼šä¸­é—´ä½¿ç”¨ ### ä½œä¸ºåˆ†éš”ç¬¦)
        `;

        // æ„å»ºè¯·æ±‚
        const payload = {
            model: globalConfig.model, 
            messages: [
                { 
                    role: "user", 
                    content: [
                        { type: "text", text: prompt },
                        { type: "image_url", image_url: { url: currentUploadBase64 } }
                    ] 
                }
            ],
            max_tokens: 4096 // å¢åŠ  Token ä¸Šé™ï¼Œé˜²æ­¢è¯æ²¡è¯´å®Œè¢«æˆªæ–­
        };

        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', payload);
        const data = await res.json();
        
        // --- 2. è§£æé€»è¾‘ (æ›´æ–°åˆ†éš”ç¬¦ä¸º ###) ---
        let rawContent = data.choices[0].message.content.trim();
        
        // ç®€å•æ¸…æ´—ï¼šæœ‰æ—¶å€™ AI ä¼šåœ¨å¼€å¤´åŠ  "å¥½çš„" æˆ– Markdown æ ‡è®°ï¼Œå°è¯•å»é™¤
        rawContent = rawContent.replace(/^```json|```$/g, ''); 

        let parts = rawContent.split('###');
        
        // é»˜è®¤å€¼
        let aiComment = rawContent; 
        let aiTags = ["ç…§ç‰‡"];
        let aiSummary = "ä¸€å¼ ç…§ç‰‡";

        if (parts.length >= 3) {
            // å®Œç¾æƒ…å†µ
            aiComment = parts[0].trim();
            aiTags = parts[1].split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t); 
            aiSummary = parts[2].trim();
        } else if (parts.length === 2) {
            // ç¼ºäº†ä¸€éƒ¨åˆ†
            aiComment = parts[0].trim();
            aiTags = parts[1].split(/[,ï¼Œ]/).map(t => t.trim());
        }

        // --- 3. å­˜å…¥ IndexedDB ---
        const photoId = 'photo_' + Date.now();
        const photoData = {
            id: photoId,
            imageBlob: currentUploadBase64,
            caption: caption,
            aiComment: aiComment,
            aiTags: aiTags,
            aiSummary: aiSummary,
            timestamp: Date.now()
        };

        const db = await openDB();
        const tx = db.transaction(galleryStoreName, 'readwrite');
        tx.objectStore(galleryStoreName).put(photoData);
        
        // --- 4. å­˜å…¥ LocalStorage ---
        galleryIndex.push({
            id: photoId,
            tags: aiTags,
            summary: aiSummary,
            caption: caption,
            comment: aiComment,
            timestamp: Date.now()
        });
        localStorage.setItem('ai_phone_gallery_index', JSON.stringify(galleryIndex));

        // --- 5. ç»“æŸ ---
        alert(`å‘å¸ƒæˆåŠŸï¼\n${char.name} è¯´ï¼š${aiComment.substring(0, 20)}...`);
        closeModal('modal-upload-photo');
        loadGalleryImages();

    } catch (e) {
        alert("å‘å¸ƒå¤±è´¥: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = "å‘å¸ƒ";
        btn.disabled = false;
    }
}

// 4. è¯¦æƒ…é¡µé€»è¾‘
function openPhotoDetail(photo) {
    currentViewingPhotoId = photo.id;
    const char = getActiveChar();
    
    document.getElementById('detail-photo-img').src = photo.imageBlob;
    document.getElementById('detail-caption').innerText = photo.caption || "ï¼ˆæ— é…æ–‡ï¼‰";
    
    // AI è¯„ä»·é¢
    if (char) {
        document.getElementById('detail-ai-avatar').src = char.avatar;
        document.getElementById('detail-ai-name').innerText = char.name;
    }
    document.getElementById('detail-ai-text').innerText = photo.aiComment || "ï¼ˆAI ä¼¼ä¹æ²¡çœ‹æ¸…...ï¼‰";
    
    const tagArea = document.getElementById('detail-ai-tags');
    tagArea.innerHTML = '';
    if (photo.aiTags) {
        photo.aiTags.forEach(tag => {
            tagArea.innerHTML += `<span class="ai-tag-chip">#${tag}</span>`;
        });
    }

    // é‡ç½®ç¿»è½¬çŠ¶æ€
    document.getElementById('photo-flip-card').classList.remove('is-flipped');
    
    document.getElementById('page-gallery-detail').classList.add('active');
}

function closePhotoDetail() {
    document.getElementById('page-gallery-detail').classList.remove('active');
}

function togglePhotoFlip() {
    document.getElementById('photo-flip-card').classList.toggle('is-flipped');
}

// ==========================================
// --- ğŸ§  æ ¸å¿ƒï¼šç›¸å†Œå›å¿†æ¤å…¥ (RAG) ---
// ==========================================

// è¿™ä¸ªå‡½æ•°éœ€è¦è¢«æ’å…¥åˆ°ä½ çš„ triggerAI æˆ– assembleSystemPrompt æµç¨‹ä¸­
// æˆ‘ä¼šå†™ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼Œä½ éœ€è¦åœ¨ getStatusContext é‡Œè°ƒç”¨å®ƒ

function getGalleryContext(userMessage) {
    if (!galleryIndex || galleryIndex.length === 0) return "";
    
    // ç®€å•çš„å…³é”®è¯åŒ¹é… (Client-side RAG)
    // æ‰«ææ‰€æœ‰ç…§ç‰‡çš„ tag å’Œ summary
    const relevantPhotos = galleryIndex.filter(photo => {
        const text = (photo.tags.join(" ") + " " + photo.summary + " " + photo.caption).toLowerCase();
        // ç®€å•åŒ¹é…ï¼šçœ‹ç”¨æˆ·çš„è¯é‡Œæœ‰æ²¡æœ‰åŒ…å«ç…§ç‰‡çš„ tag
        // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„é€»è¾‘ï¼Œæ›´é«˜çº§çš„å¯ä»¥ç”¨ TF-IDF æˆ– å‘é‡æœç´¢(å¤ªé‡äº†)
        // æˆ‘ä»¬åªåŒ¹é… tagï¼Œå› ä¸º tag æ˜¯å…³é”®è¯
        return photo.tags.some(tag => userMessage.toLowerCase().includes(tag.toLowerCase()));
    });

    if (relevantPhotos.length === 0) return "";

    // å–æœ€è¿‘çš„æˆ–ç›¸å…³æ€§æœ€å¼ºçš„ 1-2 å¼ 
    const hits = relevantPhotos.slice(0, 2);
    
    const context = hits.map(p => {
        const dateStr = new Date(p.timestamp).toLocaleDateString();
        return `
        [ğŸ“¸ ç›¸å†Œå›å¿†è§¦å‘]:
        ç”¨æˆ·åœ¨ ${dateStr} å‘è¿‡ä¸€å¼ ç…§ç‰‡ã€‚
        ç…§ç‰‡å†…å®¹ï¼š${p.summary}
        ç”¨æˆ·é…æ–‡ï¼š${p.caption}
        ä½ å½“æ—¶çš„è¯„ä»·ï¼š${p.comment}
        `;
    }).join("\n");

    return `\n${context}\n[æŒ‡ä»¤]: ä½ çš„ç›¸å†Œå›å¿†è¢«è§¦å‘äº†ã€‚ç”¨æˆ·çš„è¯é¢˜è®©ä½ æƒ³èµ·äº†ä¸Šè¿°ç…§ç‰‡ã€‚è¯·åœ¨å›å¤ä¸­è‡ªç„¶åœ°æåŠè¿™å¼ ç…§ç‰‡ï¼ˆä¾‹å¦‚â€œè¿™è®©æˆ‘æƒ³èµ·ä½ ä¸Šæ¬¡å‘çš„...â€ï¼‰ï¼Œå¹¶å¼•ç”¨ä½ å½“æ—¶çš„è¯„ä»·æˆ–ç…§ç‰‡å†…å®¹ã€‚`;
}
        // åˆ é™¤å½“å‰ç…§ç‰‡
async function deleteCurrentPhoto() {
    if (!currentViewingPhotoId) return;

    if (confirm("ç¡®å®šè¦æ’•æ‰è¿™å¼ ç…§ç‰‡å—ï¼Ÿ\nåˆ é™¤å AI ä¹Ÿä¼šå¿˜æ‰è¿™æ®µå›å¿†å“¦ã€‚")) {
        try {
            // 1. ä» IndexedDB åˆ é™¤å¤§æ–‡ä»¶
            const db = await openDB();
            const tx = db.transaction(galleryStoreName, 'readwrite');
            await tx.objectStore(galleryStoreName).delete(currentViewingPhotoId);

            // 2. ä» LocalStorage ç´¢å¼•åˆ é™¤ (ç§»é™¤è®°å¿†)
            galleryIndex = galleryIndex.filter(p => p.id !== currentViewingPhotoId);
            localStorage.setItem('ai_phone_gallery_index', JSON.stringify(galleryIndex));

            // 3. å…³é—­è¯¦æƒ…é¡µå¹¶åˆ·æ–°ç½‘æ ¼
            closePhotoDetail();
            loadGalleryImages();
            
            alert("ç…§ç‰‡å·²åˆ é™¤ã€‚");

        } catch (e) {
            console.error(e);
            alert("åˆ é™¤å¤±è´¥: " + e.message);
        }
    }
}
        // ==========================================
// --- ğŸ¬ æ”¾æ˜ å®¤ (Cinema) ç³»ç»Ÿ ---
// ==========================================

let cinemaState = {
    currentSeriesId: null,
    currentEpData: null, // åŒ…å«è§†é¢‘ blob å’Œ å­—å¹•
    parsedSubtitles: [], // [{start, end, text}]
    summaryHistory: "",
    targetEpIdForSub: null,
    // âœ¨âœ¨âœ¨ æ–°å¢è¿™ä¸€è¡Œï¼šè®°å½•è§‚å½±å¼€å§‹æ—¶é—´ âœ¨âœ¨âœ¨
    cinemaSessionStartTime: 0   
};

// 1. åˆå§‹åŒ–
async function initCinemaApp() {
    navigateTo('page-cinema');
    renderSeriesGrid();
}

// æ¸²æŸ“å‰§é›†åˆ—è¡¨ (å¸¦ç¼–è¾‘/åˆ é™¤æŒ‰é’®ç‰ˆ)
async function renderSeriesGrid() {
    const grid = document.getElementById('cinema-grid');
    grid.innerHTML = '';
    
    const db = await openDB();
    const tx = db.transaction("cinema_series", "readonly");
    const store = tx.objectStore("cinema_series");
    const req = store.getAll();
    
    req.onsuccess = () => {
        const list = req.result;
        // æŒ‰æ—¶é—´å€’åºï¼Œæ–°åˆ›å»ºçš„åœ¨å‰é¢
        list.reverse();

        if (list.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; margin-top:50px;">æš‚æ— å‰§é›†<br>ç‚¹å‡»å³ä¸Šè§’ + åˆ›å»º</div>';
            return;
        }
        
        list.forEach(s => {
            const div = document.createElement('div');
            div.className = 'gallery-item'; // å¤ç”¨ç›¸å†Œæ ·å¼
            div.style.position = 'relative';
            
            // ç‚¹å‡»å¡ç‰‡æœ¬ä½“ï¼šè¿›å…¥æ’­æ”¾é¡µ
            div.onclick = () => openSeriesDetail(s.id);
            
            div.innerHTML = `
                <img src="${s.cover || 'https://via.placeholder.com/150?text=Movie'}" class="gallery-thumb" style="border-radius:10px; object-fit:cover;">
                
                <!-- âœ¨ æ–°å¢ï¼šæ“ä½œæŒ‰é’®åŒº (é˜»æ­¢å†’æ³¡é˜²æ­¢ç‚¹è¿›è¯¦æƒ…é¡µ) -->
                <div class="cinema-card-actions" onclick="event.stopPropagation()">
                    <button class="btn-cinema-action btn-cinema-edit" onclick="openEditSeriesModal('${s.id}')">âœ</button>
                    <button class="btn-cinema-action btn-cinema-del" onclick="deleteSeries('${s.id}', '${s.title}')">Ã—</button>
                </div>

                <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); color:#fff; font-size:12px; padding:8px 5px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-bottom-left-radius:10px; border-bottom-right-radius:10px;">
                    ${s.title}
                </div>
            `;
            grid.appendChild(div);
        });
    };
}

// æ‰“å¼€æ–°å»ºçª—å£
function openAddSeriesModal() {
    document.getElementById('series-edit-id').value = ""; // æ¸…ç©ºIDï¼Œè¡¨ç¤ºæ–°å»º
    document.getElementById('series-name-input').value = '';
    document.getElementById('series-cover-input').value = '';
    
    // ä¿®æ”¹æ ‡é¢˜æç¤º
    document.querySelector('#modal-add-series .modal-header').innerText = "æ–°å»ºå‰§é›†";
    openModal('modal-add-series');
}

// æ‰“å¼€ç¼–è¾‘çª—å£
async function openEditSeriesModal(id) {
    const db = await openDB();
    const tx = db.transaction("cinema_series", "readonly");
    const store = tx.objectStore("cinema_series");
    
    store.get(id).onsuccess = (e) => {
        const s = e.target.result;
        if(s) {
            document.getElementById('series-edit-id').value = s.id; // å¡«å…¥ID
            document.getElementById('series-name-input').value = s.title;
            document.getElementById('series-cover-input').value = s.cover;
            
            // ä¿®æ”¹æ ‡é¢˜æç¤º
            document.querySelector('#modal-add-series .modal-header').innerText = "ç¼–è¾‘ä¿¡æ¯";
            openModal('modal-add-series');
        }
    };
}
        // ä¿å­˜å‰§é›† (åˆå¹¶äº†æ–°å»ºå’Œä¿®æ”¹é€»è¾‘)
async function saveSeriesData() {
    const id = document.getElementById('series-edit-id').value;
    const title = document.getElementById('series-name-input').value.trim();
    const cover = document.getElementById('series-cover-input').value.trim();
    
    if (!title) return alert("è¯·è¾“å…¥å‰§å");

    const db = await openDB();
    const tx = db.transaction("cinema_series", "readwrite");
    const store = tx.objectStore("cinema_series");

    if (id) {
        // === ç¼–è¾‘æ¨¡å¼ ===
        // å…ˆå–å‡ºæ—§æ•°æ®ï¼Œåªæ›´æ–° title å’Œ coverï¼Œä¿æŒå…¶ä»–å­—æ®µä¸å˜
        store.get(id).onsuccess = (e) => {
            const data = e.target.result;
            data.title = title;
            data.cover = cover;
            store.put(data);
        };
    } else {
        // === æ–°å»ºæ¨¡å¼ ===
        const newSeries = {
            id: 'series_' + Date.now(),
            title: title,
            cover: cover,
            seriesSummary: ""
        };
        store.put(newSeries);
    }

    // ç­‰å¾…ä¿å­˜å®Œæˆ
    await new Promise(resolve => tx.oncomplete = resolve);
    
    closeModal('modal-add-series');
    renderSeriesGrid(); // åˆ·æ–°åˆ—è¡¨
}
        // åˆ é™¤å‰§é›† (è¿å¸¦åˆ é™¤æ——ä¸‹æ‰€æœ‰åˆ†é›†)
async function deleteSeries(seriesId, seriesTitle) {
    if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤ã€Š${seriesTitle}ã€‹å—ï¼Ÿ\n\nè¿™å°†æ°¸ä¹…åˆ é™¤è¯¥å‰§ä¸‹çš„æ‰€æœ‰ï¼š\n- è§†é¢‘æ–‡ä»¶\n- å­—å¹•\n- èŠå¤©è®°å½•\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
    }

    const db = await openDB();
    
    // 1. åˆ é™¤å‰§é›†ç´¢å¼•
    const tx1 = db.transaction("cinema_series", "readwrite");
    tx1.objectStore("cinema_series").delete(seriesId);
    await new Promise(resolve => tx1.oncomplete = resolve);

    // 2. çº§è”åˆ é™¤ï¼šæ‰¾åˆ°æ‰€æœ‰å±äºè¯¥å‰§é›†çš„ Episode å¹¶åˆ é™¤
    // è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå­˜äº†è§†é¢‘Blobçš„æƒ…å†µï¼Œè¦é‡Šæ”¾ç©ºé—´
    const tx2 = db.transaction("cinema_episodes", "readwrite");
    const epStore = tx2.objectStore("cinema_episodes");
    const index = epStore.index("seriesId");
    
    const req = index.getAllKeys(seriesId); // è·å–æ‰€æœ‰åˆ†é›†çš„ ID
    
    req.onsuccess = () => {
        const epIds = req.result;
        epIds.forEach(eid => {
            epStore.delete(eid);
        });
        
        // åªæœ‰å½“æ‰€æœ‰åˆ é™¤æŒ‡ä»¤éƒ½ä¸‹è¾¾åï¼Œæ‰åˆ·æ–°ç•Œé¢
        tx2.oncomplete = () => {
            renderSeriesGrid();
            alert(`ã€Š${seriesTitle}ã€‹åŠå…¶æ‰€æœ‰æ•°æ®å·²åˆ é™¤ã€‚`);
        };
    };
}

async function createNewSeries() {
    const title = document.getElementById('series-name-input').value.trim();
    let cover = document.getElementById('series-cover-input').value.trim();
    if (!title) return alert("è¯·è¾“å…¥å‰§å");
    
    const newSeries = {
        id: 'series_' + Date.now(),
        title: title,
        cover: cover,
        episodeIds: [], // æš‚æ—¶æ²¡ç”¨ï¼Œä¸»è¦é ç´¢å¼•æŸ¥è¯¢
        seriesSummary: ""
    };
    
    const db = await openDB();
    const tx = db.transaction("cinema_series", "readwrite");
    tx.objectStore("cinema_series").put(newSeries);
    
    await new Promise(resolve => tx.oncomplete = resolve);
    
    closeModal('modal-add-series');
    renderSeriesGrid();
}

// 2. è¿›å…¥æ’­æ”¾å™¨/é€‰é›†é¡µ
async function openSeriesDetail(seriesId) {
    cinemaState.currentSeriesId = seriesId;
    navigateTo('page-cinema-detail');
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === activeContactId) || contacts[0];
    if(char) document.getElementById('cinema-ai-avatar').src = char.avatar;

    // æ‰“å¼€æŠ½å±‰æ˜¾ç¤ºå‰§é›†åˆ—è¡¨
    loadEpisodeList();
    document.getElementById('cinema-ep-drawer').style.transform = 'translateX(0)';
}
        // âœ¨âœ¨âœ¨ å¢å¼ºç‰ˆï¼šåŒæ­¥æ”¾æ˜ å®¤è®°å½• (å¸¦å¼¹çª—æç¤º) âœ¨âœ¨âœ¨
function syncCinemaChatToMain() {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!cinemaState.currentEpData || !cinemaState.currentEpData.chatLogs) return;
    const char = contacts.find(c => c.id === activeContactId);
    
    // å¦‚æœæ²¡é€‰è§’è‰²ï¼Œæˆ–è€…æ•°æ®ä¸å¯¹ï¼Œç›´æ¥é€€å‡º
    if (!char) {
        console.log("æœªé€‰æ‹©è§’è‰²ï¼Œè·³è¿‡åŒæ­¥");
        return;
    }

    // 2. ç­›é€‰ï¼šå¿…é¡»æ˜¯â€œæœ¬æ¬¡è§‚å½±â€ä¸”â€œå±äºå½“å‰è§’è‰²â€çš„è®°å½•
    const newLogs = cinemaState.currentEpData.chatLogs.filter(log => {
        const isNew = log.time >= cinemaState.cinemaSessionStartTime;
        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰charIdä¹Ÿç®—ï¼Œå¦‚æœæœ‰å¿…é¡»åŒ¹é…
        const isMyChar = (!log.charId || log.charId === activeContactId); 
        return isNew && isMyChar;
    });

    // å¦‚æœæ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œé™é»˜é€€å‡º
    if (newLogs.length === 0) return;

    // 3. æ ¼å¼åŒ–å¯¹è¯å†…å®¹
    const transcript = newLogs.map(log => {
        const displayName = log.role === 'user' ? (char.userName || "æˆ‘") : char.name;
        return `${displayName}: ${log.content}`;
    }).join('\n');

    // 4. æ„é€ å¡ç‰‡
    const epTitle = document.getElementById('player-title').innerText || "æœªçŸ¥å‰§é›†";
    const syncMessage = `
ğŸ¬ã€æ”¾æ˜ å®¤è§‚å½±è®°å½•ã€‘
------------------
ğŸ“º è§‚çœ‹å†…å®¹ï¼šã€Š${document.getElementById('player-title').innerText}ã€‹
ğŸ’¬ æœŸé—´è®¨è®ºï¼š
${transcript}
------------------
(ç³»ç»Ÿæç¤ºï¼šè¿™æ˜¯ä½ ä»¬åˆšåˆšåœ¨æ”¾æ˜ å®¤è¾¹çœ‹å‰§è¾¹èŠçš„å†…å®¹ã€‚è¯·${char.name}è®°ä½è¿™ä¸ªå…±åŒç»å†ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥çš„å¯¹è¯ä¸­è‡ªç„¶æ‰¿æ¥ã€‚)
    `.trim();

    // 5. å­˜å…¥è®°å½•
    char.messages.push({
        role: 'user', 
        content: syncMessage,
        timestamp: Date.now()
    });

    // 6. ä¿å­˜
    saveData();
    
    // âœ¨âœ¨âœ¨ æ ¸å¿ƒï¼šå¼¹çª—æç¤ºä½ åŒæ­¥æˆåŠŸ âœ¨âœ¨âœ¨
    // è¿™æ ·ä½ å°±ä¸ç”¨çŒœåˆ°åº•æœ‰æ²¡æœ‰ç”Ÿæˆäº†
    if(confirm(`å·²å°† ${newLogs.length} æ¡è§‚å½±äº’åŠ¨åŒæ­¥åˆ°èŠå¤©è®°å½•ï¼\nè¦å»èŠå¤©æ¡†çœ‹çœ‹å—ï¼Ÿ`)) {
        // å¦‚æœç‚¹å‡»â€œç¡®å®šâ€ï¼Œç›´æ¥è·³å›èŠå¤©ç•Œé¢ï¼Œä¸ç”¨ä½ è‡ªå·±æ‰¾è·¯äº†
        exitCinemaPlayer(); // å…ˆå…³æ’­æ”¾å™¨
        navigateTo('page-chat'); // å†è·³èŠå¤©
        return; // é˜»æ­¢åç»­é»˜è®¤çš„é€€å‡ºé€»è¾‘
    }
}

function exitCinemaPlayer() {
    

    // 2. æ¸…ç†è§†é¢‘èµ„æº (ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ ğŸ”¥)
    const video = document.getElementById('cinema-video');
    if (video) {
        video.pause();
        
        // å¦‚æœå½“å‰æœ‰æ’­æ”¾é“¾æ¥ (blob:xxxxx)ï¼Œå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ï¼
        // å¦åˆ™çœ‹å‡ ä¸ªå¤§ç”µå½±åæµè§ˆå™¨å†…å­˜å°±çˆ†äº†
        if (video.src && video.src.startsWith('blob:')) {
            URL.revokeObjectURL(video.src);
            console.log("å·²é‡Šæ”¾è§†é¢‘å†…å­˜å¼•ç”¨");
        }
        
        video.removeAttribute('src'); // å½»åº•ç§»é™¤ src å±æ€§
        video.load(); // å¼ºåˆ¶é‡ç½®æ’­æ”¾å™¨çŠ¶æ€
    }

    // 3. å¯¼èˆªé€»è¾‘ (å›åˆ°åˆ—è¡¨)
    if (document.getElementById('page-cinema-detail').classList.contains('active')) {
        navigateTo('page-cinema'); 
    }
}

function toggleEpDrawer() {
    const d = document.getElementById('cinema-ep-drawer');
    const isClosed = d.style.transform === 'translateX(100%)';
    d.style.transform = isClosed ? 'translateX(0)' : 'translateX(100%)';
}

// åŠ è½½å‰§é›†åˆ—è¡¨ (æ”¯æŒæ•°æ®åŒæ­¥ç‰ˆï¼šå¤„ç†è§†é¢‘ä¸¢å¤±æƒ…å†µ)
async function loadEpisodeList() {
    const list = document.getElementById('cinema-ep-list');
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#666">åŠ è½½ä¸­...</div>';
    
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readonly");
    const store = tx.objectStore("cinema_episodes");
    const index = store.index("seriesId");
    const req = index.getAll(cinemaState.currentSeriesId);
    
    req.onsuccess = () => {
        const episodes = req.result;
        episodes.sort((a, b) => {
            return a.title.localeCompare(b.title, undefined, { numeric: true, sensitivity: 'base' });
        });
        
        list.innerHTML = '';
        if (episodes.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">æš‚æ— å†…å®¹</div>';
            return;
        }
        
        episodes.forEach(ep => {
            // 1. æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const hasVideo = !!ep.videoBlob;
            
            // 2. æ£€æŸ¥å­—å¹•/æ€»ç»“çŠ¶æ€
            const hasSub = ep.subtitles && ep.subtitles.length > 0;
            let summaryBtn = "";
            if (ep.summary) {
                const safeSummary = ep.summary.replace(/'/g, "\\'").replace(/\n/g, ' ');
                summaryBtn = `<span style="color:#34c759; font-size:10px; cursor:pointer; margin-left:5px;" onclick="event.stopPropagation(); alert('ã€æœ¬é›†å‰§æƒ…ã€‘\\n${safeSummary}')">å·²æ€»ç»“</span>`;
            } else if (hasSub) {
                summaryBtn = `<span onclick="event.stopPropagation(); generateEpSummary('${ep.id}')" style="color:#FF9500; font-size:10px; border:1px solid #FF9500; padding:1px 4px; border-radius:4px; cursor:pointer; margin-left:5px;">ç”Ÿæˆæ€»ç»“</span>`;
            }

            // 3. æ„å»ºå³ä¾§æŒ‰é’®
            let actionArea = "";
            if (hasVideo) {
                // æ­£å¸¸çŠ¶æ€
                const subStatus = hasSub 
                    ? `<span style="color:#34c759; font-size:10px; border:1px solid #34c759; padding:1px 4px; border-radius:4px;">å­—å¹• OK</span>` 
                    : `<button onclick="event.stopPropagation(); triggerSubUpload('${ep.id}')" style="background:#333; color:#007AFF; border:1px solid #007AFF; font-size:10px; padding:2px 6px; border-radius:4px;">+ ä¸Šä¼ å­—å¹•</button>`;
                
                actionArea = `
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px; margin-left:10px;">
                        ${subStatus}
                        <span onclick="event.stopPropagation(); deleteEpisode('${ep.id}')" style="color:#ff3b30; font-size:12px; margin-top:5px;">åˆ é™¤</span>
                    </div>`;
            } else {
                // âœ¨ è§†é¢‘ä¸¢å¤±çŠ¶æ€ (åŒæ­¥è¿‡æ¥çš„æ•°æ®)
                actionArea = `
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px; margin-left:10px;">
                        <button onclick="event.stopPropagation(); relinkVideo('${ep.id}')" style="background:#ff3b30; color:#fff; border:none; font-size:12px; padding:4px 8px; border-radius:4px;">å…³è”è§†é¢‘</button>
                        <div style="font-size:10px; color:#666;">æºæ–‡ä»¶ç¼ºå¤±</div>
                    </div>`;
            }

            const div = document.createElement('div');
            div.style.padding = '15px';
            div.style.borderBottom = '1px solid #333';
            div.style.cursor = 'pointer';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';
            if (!hasVideo) div.style.opacity = '0.7'; // ç¨å¾®å˜ç°
            
            div.innerHTML = `
                <div style="flex:1; min-width:0;">
                    <div style="color:#fff; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ep.title}</div>
                    <div style="font-size:10px; color:#666; margin-top:4px;">
                        ${hasSub ? ep.subtitles.length + 'è¡Œå­—å¹•' : 'æ— å­—å¹•'}
                        ${summaryBtn}
                        ${ep.chatLogs && ep.chatLogs.length > 0 ? ` Â· ğŸ’¬ ${ep.chatLogs.length}æ¡èŠå¤©è®°å½•` : ''}
                    </div>
                </div>
                ${actionArea}
            `;
            
            div.onclick = () => {
                if(hasVideo) playEpisode(ep.id);
                else alert("è¯·å…ˆç‚¹å‡»å³ä¾§ã€å…³è”è§†é¢‘ã€‘ä¸Šä¼ å¯¹åº”çš„ MP4 æ–‡ä»¶ã€‚");
            };
            list.appendChild(div);
        });
    };
}

// 3. ä¸Šä¼ è§†é¢‘+å­—å¹• (è‡ªåŠ¨é…å¯¹)
async function handleEpisodeUpload(e) {
    const files = Array.from(e.target.files);
    if(files.length === 0) return;
    
    // ç®€å•é€»è¾‘ï¼šå‡è®¾ç”¨æˆ·é€‰äº†ä¸€ä¸ª mp4 å’Œä¸€ä¸ª srt
    const videoFile = files.find(f => f.name.endsWith('.mp4'));
    const subFile = files.find(f => f.name.endsWith('.srt') || f.name.endsWith('.vtt'));
    
    if(!videoFile) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ª MP4 è§†é¢‘æ–‡ä»¶");
    
    const btn = e.target.previousElementSibling;
    btn.innerText = "æ­£åœ¨å¤„ç†...";
    
    let subData = [];
    if(subFile) {
        const text = await subFile.text();
        subData = parseSRT(text);
    }
    
    // è‡ªåŠ¨è®¡ç®—æ˜¯ç¬¬å‡ é›†
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readwrite");
    const store = tx.objectStore("cinema_episodes");
    
    // ç®€å•ç²—æš´ï¼šç”¨æ—¶é—´æˆ³åš ID
    const newEp = {
        id: 'ep_' + Date.now(),
        seriesId: cinemaState.currentSeriesId,
        index: Date.now(), // å·æ‡’ï¼ŒæŒ‰æ—¶é—´æ’åºå³å¯ï¼Œç”¨æˆ·å¯ä»¥é‡å‘½å
        title: videoFile.name,
        videoBlob: videoFile,
        subtitles: subData,
        summary: ""
    };
    
    store.put(newEp);
    
    await new Promise(resolve => tx.oncomplete = resolve);
    
    btn.innerText = "+ æ·»åŠ æ–°å‰§é›†";
    loadEpisodeList();
    alert("ä¸Šä¼ æˆåŠŸï¼");
}
        // ä¸Šä¼ è§†é¢‘ (Step 1) - æ™ºèƒ½é˜²çˆ†ç‰ˆ
async function handleVideoUploadOnly(e) {
    const file = e.target.files[0];
    if(!file) return;
    
    // ğŸ›‘ æ ¸å¿ƒé€»è¾‘ï¼šè¶…è¿‡ 100MB å°±ä¸å­˜äº†ï¼Œåªå­˜ä¸ªâ€œå¼•ç”¨â€
    // è¿™æ · 100GB çš„ç”µå½±ä¹Ÿèƒ½å¯¼å…¥ï¼Œå®é™…ä¸Šåªå­˜äº†æ–‡ä»¶åï¼Œæ¯«ç§’çº§å®Œæˆ
    const isLargeFile = file.size > 100 * 1024 * 1024; // 100MB
    let videoDataToStore = file;
    let isVirtual = false;

    if (isLargeFile) {
        if(confirm(`ğŸ¬ è¿™ä¸ªè§†é¢‘è¾ƒå¤§ (${(file.size/1024/1024/1024).toFixed(2)} GB)ã€‚\n\nä¸ºäº†é˜²æ­¢å¡é¡¿ï¼Œæˆ‘ä»¬å°†åªä¿å­˜â€œå¼•ç”¨â€ã€‚\nä¸‹æ¬¡æ’­æ”¾æ—¶ï¼Œéœ€è¦æ‚¨æ‰‹åŠ¨å†æ¬¡é€‰æ‹©è¿™ä¸ªæ–‡ä»¶ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
            videoDataToStore = null; // å…³é”®ï¼šä¸å­˜æ–‡ä»¶å®ä½“ï¼
            isVirtual = true;
        } else {
            e.target.value = '';
            return;
        }
    }

    const btn = e.target.previousElementSibling;
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨åˆ›å»ºè®°å½•...";
    btn.disabled = true;

    try {
        const db = await openDB();
        const tx = db.transaction("cinema_episodes", "readwrite");
        const store = tx.objectStore("cinema_episodes");
        
        const newEp = {
            id: 'ep_' + Date.now(),
            seriesId: cinemaState.currentSeriesId,
            index: Date.now(), 
            title: file.name,
            videoBlob: videoDataToStore, // å¦‚æœæ˜¯å¤§æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯ null
            isVirtual: isVirtual,        // æ ‡è®°ï¼šè¿™æ˜¯ä¸€ä¸ªè™šç©ºå¼•ç”¨
            subtitles: [], 
            summary: ""
        };
        
        store.put(newEp);
        await new Promise(resolve => tx.oncomplete = resolve);
        
        loadEpisodeList(); 
        alert("å¯¼å…¥æˆåŠŸï¼\nï¼ˆå¦‚æœæ˜¯å¤§æ–‡ä»¶ï¼Œçœ‹çš„æ—¶å€™è®°å¾—é€‰ä¸€ä¸‹æºæ–‡ä»¶å“¦ï¼‰");

    } catch(err) {
        alert("ä¿å­˜å¤±è´¥: " + err.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
        e.target.value = ''; 
    }
}
        // è§¦å‘å­—å¹•ä¸Šä¼  (è®°å½•è¦ç»™å“ªä¸€é›†ä¼ )
function triggerSubUpload(epId) {
    cinemaState.targetEpIdForSub = epId;
    document.getElementById('upload-sub-only').click();
}

// å¤„ç†å­—å¹•æ–‡ä»¶ (Step 2)
async function handleSubtitleUploadOnly(e) {
    const file = e.target.files[0];
    if(!file || !cinemaState.targetEpIdForSub) return;

    try {
        const text = await file.text();
        const subData = parseSRT(text); // è°ƒç”¨ä¹‹å‰çš„è§£æå‡½æ•°
        
        if(subData.length === 0) throw new Error("æ— æ³•è§£æå­—å¹•ï¼Œè¯·ç¡®ä¿æ˜¯ SRT æ ¼å¼");

        // å­˜å…¥æ•°æ®åº“
        const db = await openDB();
        const tx = db.transaction("cinema_episodes", "readwrite");
        const store = tx.objectStore("cinema_episodes");
        
        // 1. å…ˆå–å‡ºæ—§æ•°æ®
        const ep = await new Promise((resolve, reject) => {
            const req = store.get(cinemaState.targetEpIdForSub);
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });

        if(!ep) throw new Error("æ‰¾ä¸åˆ°è¯¥é›†æ•°æ®");

        // 2. æ›´æ–°å­—å¹•å­—æ®µ
        ep.subtitles = subData;
        
        // 3. æ”¾å›å»
        store.put(ep);
        await new Promise(resolve => tx.oncomplete = resolve);

        loadEpisodeList(); // åˆ·æ–°åˆ—è¡¨
        alert(`å­—å¹•å¯¼å…¥æˆåŠŸï¼å…± ${subData.length} è¡Œã€‚`);

    } catch(err) {
        alert("å­—å¹•ä¸Šä¼ å¤±è´¥: " + err.message);
    } finally {
        e.target.value = '';
        cinemaState.targetEpIdForSub = null; // é‡ç½®ç›®æ ‡
    }
}
        async function deleteEpisode(epId) {
    if(!confirm("ç¡®å®šåˆ é™¤è¿™ä¸€é›†å—ï¼Ÿ\n(è§†é¢‘æ–‡ä»¶è¾ƒå¤§ï¼Œåˆ é™¤å¯é‡Šæ”¾ç©ºé—´)")) return;
    
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readwrite");
    const store = tx.objectStore("cinema_episodes");
    
    store.delete(epId);
    
    tx.oncomplete = () => {
        loadEpisodeList();
        // å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨æ”¾çš„ï¼Œé€€å‡ºæ’­æ”¾å™¨
        if(cinemaState.currentEpData && cinemaState.currentEpData.id === epId) {
            exitCinemaPlayer();
        }
    };
}

// 4. è§£æ SRT ä¸º JSON (ä¸‡èƒ½å¢å¼ºç‰ˆ)
function parseSRT(srt) {
    // --- ç¬¬ä¸€æ­¥ï¼šæ¸…æ´—æ•°æ® ---
    // 1. æŠŠ Windows çš„ \r\n å’Œæ—§ Mac çš„ \r å…¨éƒ¨ç»Ÿä¸€åº¦åŒ–ä¸º \n
    // 2. å»é™¤æ–‡ä»¶å¤´éƒ¨çš„ BOM æ ‡è®° (å¦‚æœæœ‰çš„è¯)
    const text = srt.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();

    // --- ç¬¬äºŒæ­¥ï¼šæ­£åˆ™åŒ¹é… ---
    // è§£é‡Šï¼š
    // (\d+)       -> åºå·
    // \s+         -> åºå·åé¢å¯èƒ½æœ‰æ¢è¡Œï¼Œä¹Ÿå¯èƒ½æœ‰ç©ºæ ¼ï¼Œå…¨åƒæ‰
    // (\d{2}:...) -> å¼€å§‹æ—¶é—´ (å…¼å®¹ é€—å·, å’Œ ç‚¹. )
    // \s+-->\s+   -> ç®­å¤´å‰åå…è®¸æœ‰ç©ºæ ¼
    // (\d{2}:...) -> ç»“æŸæ—¶é—´
    // ([\s\S]*?)  -> å­—å¹•å†…å®¹ (éè´ªå©ªåŒ¹é…)
    // (?=\n\n|$)  -> é‡åˆ°åŒæ¢è¡Œ(ä¸‹ä¸€å—)æˆ–è€…æ–‡ä»¶ç»“æŸæ—¶åœæ­¢
    const pattern = /(\d+)\s+(\d{2}:\d{2}:\d{2}[,.]\d{3})\s+-->\s+(\d{2}:\d{2}:\d{2}[,.]\d{3})\s+([\s\S]*?)(?=\n\s*\n|$)/g;
    
    const result = [];
    let match;
    
    // è¾…åŠ©ï¼šæŠŠæ—¶é—´æˆ³è½¬ä¸ºç§’ (å…¼å®¹é€—å·å’Œç‚¹)
    const timeToSec = (tStr) => {
        // ç»Ÿä¸€æŠŠé€—å·æ¢æˆç‚¹ï¼Œç„¶ååˆ†å‰²
        const [h, m, s] = tStr.replace(',', '.').split(':');
        return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s);
    };

    while ((match = pattern.exec(text)) !== null) {
        // è¿‡æ»¤æ‰å¯èƒ½è§£æå‡ºçš„ç©ºè¡Œ
        const content = match[4].trim();
        if (content) {
            result.push({
                start: timeToSec(match[2]),
                end: timeToSec(match[3]),
                text: content
            });
        }
    }
    
    // è°ƒè¯•æ—¥å¿—ï¼šçœ‹çœ‹è§£æå‡ºäº†å¤šå°‘æ¡ï¼Œæ–¹ä¾¿æ’æŸ¥
    console.log(`SRTè§£æç»“æœ: æˆåŠŸè¯†åˆ« ${result.length} æ¡å­—å¹•`);
    
    return result;
}

// æ’­æ”¾é€»è¾‘ (ä¿®å¤ç‰ˆï¼šè§£å†³æµè§ˆå™¨æ‹¦æˆªé—®é¢˜)
async function playEpisode(epId) {
    cinemaState.cinemaSessionStartTime = Date.now();
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readonly");
    const store = tx.objectStore("cinema_episodes");
    
    const req = store.get(epId);
    
    req.onsuccess = async () => {
        const ep = req.result;
        if (!ep) return alert("é›†æ•°ä¸å­˜åœ¨");
        if (!ep.chatLogs) ep.chatLogs = [];
        
        cinemaState.currentEpData = ep;
        cinemaState.parsedSubtitles = ep.subtitles || [];

        // --- åŠ è½½å‰æƒ…æè¦ ---
        const index = store.index("seriesId");
        const allReq = index.getAll(ep.seriesId);
        allReq.onsuccess = () => {
            const allEps = allReq.result.filter(e => e.index < ep.index && e.summary).sort((a,b)=>a.index-b.index);
            cinemaState.summaryHistory = allEps.length > 0 ? allEps.map(e => `[å‰æƒ…]: ${e.summary}`).join("\n") : "ï¼ˆæ— å‰æƒ…æè¦ï¼‰";
        };

        // UI å‡†å¤‡
        document.getElementById('player-title').innerText = ep.title;
        document.getElementById('cinema-ep-drawer').style.transform = 'translateX(100%)'; 
        
        const video = document.getElementById('cinema-video');
        const container = video.parentElement; // è·å–è§†é¢‘å¤–é¢çš„å®¹å™¨

        // æ¸…ç†æ—§çš„è¦†ç›–å±‚ï¼ˆå¦‚æœæœ‰ï¼‰
        const oldOverlay = document.getElementById('virtual-file-overlay');
        if(oldOverlay) oldOverlay.remove();

        // ==========================================
        // ğŸï¸ æ ¸å¿ƒä¿®æ”¹ï¼šåŒºåˆ† å®ä½“æ–‡ä»¶ vs è™šç©ºå¼•ç”¨
        // ==========================================
        
        // æƒ…å†µ A: æ•°æ®åº“é‡ŒçœŸçš„å­˜äº†æ–‡ä»¶ (å°è§†é¢‘)
        if (ep.videoBlob && !ep.isVirtual) {
            const videoUrl = URL.createObjectURL(ep.videoBlob);
            startPlaying(videoUrl, ep);
        } 
        // æƒ…å†µ B: è¿™æ˜¯ä¸€ä¸ªè™šç©ºå¼•ç”¨ (å¤§è§†é¢‘)
        else {
            // 1. å…ˆæŠŠè§†é¢‘æºæ¸…ç©ºï¼Œé˜²æ­¢æ˜¾ç¤ºä¸Šä¸€é›†çš„ç”»é¢
            video.src = "";
            
            // 2. åˆ›å»ºä¸€ä¸ªè¦†ç›–åœ¨è§†é¢‘ä¸Šçš„â€œåŠ è½½æŒ‰é’®â€
            const overlay = document.createElement('div');
            overlay.id = 'virtual-file-overlay';
            overlay.style.cssText = `
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 5;
                display: flex; flex-direction: column;
                align-items: center; justify-content: center;
                color: #fff; text-align: center;
            `;
            
            overlay.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“‚</div>
                <div style="font-size: 16px; margin-bottom: 10px;">${ep.title}</div>
                <button id="btn-load-virtual" style="
                    padding: 10px 20px; font-size: 16px; font-weight: bold;
                    background: #007AFF; color: white; border: none; border-radius: 20px;
                    cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.4);
                ">ç‚¹å‡»é€‰æ‹©æœ¬åœ°è§†é¢‘æ–‡ä»¶</button>
                <div style="font-size: 12px; color: #999; margin-top: 15px;">
                    (è¿™æ˜¯å¤§æ–‡ä»¶ï¼Œæœªå­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œéœ€æ‰‹åŠ¨åŠ è½½)
                </div>
            `;
            
            // æŠŠè¦†ç›–å±‚åŠ åˆ°è§†é¢‘ä¸Šé¢
            container.appendChild(overlay);

            // 3. ç»‘å®šç‚¹å‡»äº‹ä»¶ (è¿™æ˜¯ç”¨æˆ·ç›´æ¥ç‚¹å‡»ï¼Œæµè§ˆå™¨å…è®¸å¼¹çª—)
            document.getElementById('btn-load-virtual').onclick = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = ".mp4,.mkv,.mov";
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // ç§»é™¤è¦†ç›–å±‚
                        overlay.remove();
                        // ç›´æ¥æ’­æ”¾
                        const videoUrl = URL.createObjectURL(file);
                        startPlaying(videoUrl, ep);
                    }
                };
                input.click(); // è¿™ä¸€æ­¥ç°åœ¨èƒ½æˆåŠŸäº†ï¼
            };
        }
    };
}

// è¾…åŠ©ï¼šå¼€å§‹æ’­æ”¾çš„ç»Ÿä¸€åŠ¨ä½œ (ç¡®ä¿å­—å¹•ä¹Ÿä¼šè¢«åŠ è½½)
function startPlaying(url, ep) {
    const video = document.getElementById('cinema-video');
    const track = document.getElementById('cinema-track');
    
    video.src = url;
    
    // åŠ è½½å­—å¹• (Subtitles)
    if (ep.subtitles && ep.subtitles.length > 0) {
        // æ„å»º VTT æ ¼å¼å­—å¹•
        const vttText = "WEBVTT\n\n" + ep.subtitles.map((s, i) => {
            // æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
            const format = (sec) => {
                const date = new Date(sec * 1000);
                return date.toISOString().substr(11, 12);
            };
            return `${i+1}\n${format(s.start)} --> ${format(s.end)}\n${s.text}`;
        }).join('\n\n');
        
        const trackBlob = new Blob([vttText], {type: 'text/vtt'});
        track.src = URL.createObjectURL(trackBlob);
        
        // å°è¯•æ˜¾ç¤ºå­—å¹•
        track.default = true; 
        // æœ‰äº›æµè§ˆå™¨éœ€è¦æ‰‹åŠ¨åˆ‡æ¢æ¨¡å¼
        if(video.textTracks && video.textTracks.length > 0) {
            video.textTracks[0].mode = 'showing';
        }
        
    } else {
        track.src = "";
    }
    
    video.play();
}

// è¾…åŠ©ï¼šå¼€å§‹æ’­æ”¾çš„ç»Ÿä¸€åŠ¨ä½œ
function startPlaying(url, ep) {
    const video = document.getElementById('cinema-video');
    const track = document.getElementById('cinema-track');
    
    video.src = url;
    
    // åŠ è½½å­—å¹•
    if (ep.subtitles && ep.subtitles.length > 0) {
        const vttText = "WEBVTT\n\n" + ep.subtitles.map((s, i) => {
            const format = (sec) => new Date(sec * 1000).toISOString().substr(11, 12);
            return `${i+1}\n${format(s.start)} --> ${format(s.end)}\n${s.text}`;
        }).join('\n\n');
        track.src = URL.createObjectURL(new Blob([vttText], {type: 'text/vtt'}));
    } else {
        track.src = "";
    }
    
    document.getElementById('player-title').innerText = ep.title;
    document.getElementById('cinema-ep-drawer').style.transform = 'translateX(100%)'; 
    
    video.play();
}

// ä¸€ä¸ªå°è¾…åŠ©å‡½æ•°ï¼šå°è¯•ä»æ ‡é¢˜æå–é›†æ•° (æ¯”å¦‚ "ç”„å¬›ä¼ .E01.mp4" -> "1")
function getEpNumber(title) {
    const match = title.match(/E(\d+)/i) || title.match(/ç¬¬(\d+)é›†/);
    return match ? match[1] : "?";
}

// 6. æ‰“å¼€èŠå¤©çª—å£ (ä¿®å¤æ ‡é¢˜åå­—ç‰ˆ)
function openCinemaChat() {
    const video = document.getElementById('cinema-video');
    video.pause(); // æš‚åœè§†é¢‘
    
    const box = document.getElementById('cinema-chat-history');
    box.innerHTML = ''; 
    
    // è·å–å½“å‰è§’è‰²
    const char = contacts.find(c => c.id === activeContactId) || contacts[0];
    
    // âœ¨âœ¨âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°å¼¹çª—æ ‡é¢˜çš„åå­— âœ¨âœ¨âœ¨
    if (char) {
        document.getElementById('cinema-chat-name').innerText = char.name;
    }

    // æ¸²æŸ“å†å²è®°å½•
    const logs = cinemaState.currentEpData.chatLogs || [];
    
    logs.forEach(log => {
        if (log.role === 'user') {
            box.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span></div>`;
        } else {
            box.innerHTML += `
                <div style="text-align:left; margin:10px 0;">
                    <img src="${char.avatar}" style="width:30px;height:30px;border-radius:50%;vertical-align:middle;">
                    <span style="background:#333; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span>
                </div>`;
        }
    });
    
    setTimeout(() => { box.scrollTop = box.scrollHeight; }, 100);
    
    document.getElementById('modal-cinema-chat').style.display = 'flex';
    document.getElementById('modal-cinema-chat').classList.add('show');
}

function closeCinemaChat() {
    const modal = document.getElementById('modal-cinema-chat');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
    
    const video = document.getElementById('cinema-video');
    video.play(); // ç»§ç»­æ’­æ”¾
}

// å‘é€æ¶ˆæ¯ (æ›´æ–°ç‰ˆï¼šä¿å­˜åˆ°æ•°æ®åº“)
async function sendCinemaMsg() {
    const input = document.getElementById('cinemaChatInput');
    const text = input.value.trim();
    if(!text) return;
    
    // 1. UI ä¸Šå±
    const box = document.getElementById('cinema-chat-history');
    box.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; padding:8px 12px; border-radius:15px;">${text}</span></div>`;
    input.value = '';
    box.scrollTop = box.scrollHeight;
    
    // âœ¨âœ¨âœ¨ 2. å­˜å…¥å†…å­˜æ•°ç»„ âœ¨âœ¨âœ¨
    if (!cinemaState.currentEpData.chatLogs) cinemaState.currentEpData.chatLogs = [];
    cinemaState.currentEpData.chatLogs.push({ role: 'user', content: text, time: Date.now(), charId: activeContactId });
    
    // âœ¨âœ¨âœ¨ 3. ä¿å­˜åˆ° IndexedDB (å…³é”®) âœ¨âœ¨âœ¨
    await saveCurrentEpisodeData();
    
    // 4. è§¦å‘ AI
    await triggerCinemaAI(text);
}

// 7. æ ¸å¿ƒï¼šAI æ„ŸçŸ¥ä¸Šä¸‹æ–‡ (ç»ˆæç‰ˆï¼šå‰§æƒ…+èŠå¤©è®°å¿†)
async function triggerCinemaAI(userText) {
    const char = contacts.find(c => c.id === activeContactId) || contacts[0];
    if(!char || !globalConfig.apiKey) return;
    
    const video = document.getElementById('cinema-video');
    const currentTime = video.currentTime;
    
    // --- A. è·å–å‰§æƒ…ä¸Šä¸‹æ–‡ (å­—å¹•) ---
    const subs = cinemaState.parsedSubtitles;
    let currentIndex = subs.findIndex(s => s.start <= currentTime && s.end >= currentTime);
    if (currentIndex === -1) {
        currentIndex = subs.findIndex(s => s.start > currentTime); 
        if (currentIndex > 0) currentIndex--; 
    }
    if (currentIndex === -1) currentIndex = 0;
    
    const startIdx = Math.max(0, currentIndex - 50);
    const endIdx = Math.min(subs.length, currentIndex + 20);
    
    const contextSubs = subs.slice(startIdx, endIdx).map(s => {
        const isCurrent = (s === subs[currentIndex]) ? "ã€å½“å‰ç”»é¢ã€‘ğŸ‘‰ " : "";
        return `${isCurrent}${s.text}`; 
    }).join('\n');
    
    // --- B. è·å–èŠå¤©å†å²ä¸Šä¸‹æ–‡ (æœ€è¿‘ 10 æ¡) âœ¨âœ¨âœ¨ ---
    // è¿™é‡Œçš„ chatLogs å·²ç»åŒ…å«äº†åˆšæ‰ç”¨æˆ·å‘çš„é‚£ä¸€å¥
    const chatHistory = cinemaState.currentEpData.chatLogs.slice(-10).map(log => {
        return { role: log.role, content: log.content };
    });

    const box = document.getElementById('cinema-chat-history');
    // æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = "text-align:left; color:#888; font-size:12px; margin:5px 0;";
    loadingDiv.innerText = `${char.name} æ­£åœ¨çœ‹å‰§...`;
    box.appendChild(loadingDiv);
    box.scrollTop = box.scrollHeight;

    // --- C. æ„å»º Prompt ---
    const systemPrompt = `
    ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·çœ‹å‰§ã€‚
    å½“å‰å‰§åï¼šã€Š${document.getElementById('player-title').innerText}ã€‹ã€‚
    ä½ çš„è§’è‰²ï¼š${char.name}ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
    
    ã€å±å¹•ä¸Šæœ€è¿‘å‘ç”Ÿçš„å¯¹è¯/å‰§æƒ… (å­—å¹•æµ)ã€‘ï¼š
    ${contextSubs}
    
    ã€æŒ‡ä»¤ã€‘ï¼š
    è¯·åƒä¸€ä¸ªååœ¨ç”¨æˆ·èº«è¾¹çš„æœ‹å‹/æ‹äººä¸€æ ·ï¼Œé’ˆå¯¹ç”¨æˆ·çš„å‘è¨€è¿›è¡Œå›å¤ã€‚
    ä½ å¯ä»¥è¯„è®ºå‰§æƒ…ã€å›ç­”ç–‘é—®æˆ–è€…é—²èŠã€‚
    ç»“åˆä¸Šé¢çš„â€œå­—å¹•æµâ€çŸ¥é“ç°åœ¨æ¼”åˆ°å“ªäº†ï¼ŒåŒæ—¶å‚è€ƒâ€œèŠå¤©å†å²â€ä¿æŒå¯¹è¯è¿è´¯æ€§ã€‚
    `;

    // ç»„åˆæ¶ˆæ¯ï¼šSystem + History
    const apiMessages = [
        { role: "system", content: systemPrompt },
        ...chatHistory 
    ];
    
    try {
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: apiMessages
        });
        
        const data = await res.json();
        const reply = data.choices[0].message.content;
        
        // ç§»é™¤ loading
        loadingDiv.remove();
        
        // UI æ˜¾ç¤ºå›å¤
        box.innerHTML += `
            <div style="text-align:left; margin:10px 0;">
                <img src="${char.avatar}" style="width:30px;height:30px;border-radius:50%;vertical-align:middle;">
                <span style="background:#333; padding:8px 12px; border-radius:15px;">${reply}</span>
            </div>`;
        box.scrollTop = box.scrollHeight;

        // âœ¨âœ¨âœ¨ ä¿å­˜ AI å›å¤åˆ°æ•°æ®åº“ âœ¨âœ¨âœ¨
        cinemaState.currentEpData.chatLogs.push({ role: 'assistant', content: reply, time: Date.now(), charId: activeContactId });
        await saveCurrentEpisodeData();
        
    } catch(e) {
        loadingDiv.innerText = "Error: " + e.message;
        loadingDiv.style.color = "red";
    }
}
        // è¾…åŠ©ï¼šä¿å­˜å½“å‰é›†çš„è¿›åº¦å’ŒèŠå¤©è®°å½•åˆ° DB
async function saveCurrentEpisodeData() {
    if (!cinemaState.currentEpData) return;
    
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readwrite");
    const store = tx.objectStore("cinema_episodes");
    
    // æ›´æ–°æ•°æ®å¯¹è±¡
    // æ³¨æ„ï¼švideoBlob å¾ˆå¤§ï¼Œä½† IndexedDB æ›´æ–°å¿…é¡» put æ•´ä¸ªå¯¹è±¡ã€‚
    // åœ¨æœ¬åœ°æ“ä½œä¸­ï¼Œè¿™é€šå¸¸å¾ˆå¿«ï¼Œä¸ä¼šåƒä¸Šä¼ é‚£ä¹ˆæ…¢ã€‚
    store.put(cinemaState.currentEpData);
    
    return new Promise(resolve => tx.oncomplete = resolve);
}
        // ç”Ÿæˆå•é›†å‰§æƒ…æ€»ç»“
async function generateEpSummary(epId) {
    if(!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");
    
    const db = await openDB();
    const tx = db.transaction("cinema_episodes", "readwrite");
    const store = tx.objectStore("cinema_episodes");
    
    // 1. è·å–æ•°æ®
    // è¿™é‡Œæˆ‘ä»¬ç”¨ Promise åŒ…è£…ä¸€ä¸‹ getï¼Œæ–¹ä¾¿ await
    const ep = await new Promise((resolve) => {
        store.get(epId).onsuccess = (e) => resolve(e.target.result);
    });

    if (!ep || !ep.subtitles) return alert("æ— æ³•è¯»å–å­—å¹•æ•°æ®");

    if (!confirm(`å³å°†è¯»å–ã€Š${ep.title}ã€‹çš„å…¨éƒ¨å­—å¹•æ¥ç”Ÿæˆå‰§æƒ…æ¢—æ¦‚ã€‚\nè¿™å¯èƒ½ä¼šæ¶ˆè€—è¾ƒå¤š Tokenï¼Œç¡®å®šå—ï¼Ÿ`)) return;

    // 2. å‡†å¤‡å­—å¹•æ–‡æœ¬
    // ä¸ºäº†é˜²æ­¢ Token çˆ†ç‚¸ï¼Œæˆ‘ä»¬æ¯éš” 2 è¡Œå– 1 è¡Œï¼Œæˆ–è€…åªå–å‰ 15000 å­—
    let fullText = ep.subtitles.map(s => s.text).join("\n");
    if (fullText.length > 20000) {
        fullText = fullText.substring(0, 20000) + "\n...(åé¢å†…å®¹å¤ªé•¿çœç•¥)...";
    }

    const prompt = `
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å½±è§†å‰§å‰§æƒ…è®°å½•å‘˜ã€‚
    è¯·é˜…è¯»ä¸‹é¢çš„å­—å¹•æ–‡ä»¶å†…å®¹ï¼Œæ€»ç»“è¿™ä¸€é›†çš„**æ ¸å¿ƒå‰§æƒ…**ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    1. æ¦‚æ‹¬ä¸»è¦å‘ç”Ÿäº†ä»€ä¹ˆäº‹ã€äººç‰©å…³ç³»æœ‰ä»€ä¹ˆé‡å¤§è¿›å±•ã€‚
    2. å¿½ç•¥æ— å…³ç´§è¦çš„é—²èŠã€‚
    3. å­—æ•°æ§åˆ¶åœ¨ 200-300 å­—ä»¥å†…ã€‚
    4. æ ¼å¼å¿…é¡»å®¢è§‚ï¼Œä¸è¦å‘è¡¨å½±è¯„ï¼Œå› ä¸ºè¿™æ®µæ–‡å­—å°†ä½œä¸ºâ€œå‰æƒ…æè¦â€æä¾›ç»™ä¸‹ä¸€é›†çš„ AI é˜…è¯»ã€‚
    
    ã€å­—å¹•å†…å®¹ã€‘ï¼š
    ${fullText}
    `;

    // UI æç¤º (éšä¾¿æ‰¾ä¸ªåœ°æ–¹æç¤ºï¼Œæ¯”å¦‚å¼¹çª—)
    const originalText = document.querySelector('.app-title').innerText; // å€Ÿç”¨é¡¶æ æ˜¾ç¤ºä¸€ä¸‹
    document.querySelector('.app-title').innerText = "AI æ­£åœ¨çœ‹ç‰‡æ€»ç»“...";

    try {
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }]
        });
        
        const data = await res.json();
        const summary = data.choices[0].message.content;

        // 3. å­˜å…¥æ•°æ®åº“
        // æ³¨æ„ï¼šå› ä¸ºäº‹åŠ¡å¯èƒ½å·²ç»å…³é—­ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å¼€ä¸€ä¸ªäº‹åŠ¡å†™å…¥
        const db2 = await openDB();
        const tx2 = db2.transaction("cinema_episodes", "readwrite");
        const store2 = tx2.objectStore("cinema_episodes");
        
        ep.summary = summary;
        store2.put(ep); // æ›´æ–°å›å»
        
        alert("âœ… æ€»ç»“ç”ŸæˆæˆåŠŸï¼\n" + summary.substring(0, 50) + "...");
        loadEpisodeList(); // åˆ·æ–°åˆ—è¡¨ï¼ŒæŒ‰é’®å˜ç»¿

    } catch(e) {
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        document.querySelector('.app-title').innerText = "æ”¾æ˜ å®¤"; // æ¢å¤æ ‡é¢˜
    }
}
        // ==========================================
// --- ğŸ”„ æ”¾æ˜ å®¤æ•°æ®åŒæ­¥ç³»ç»Ÿ ---
// ==========================================

function openCinemaSync() {
    openModal('modal-cinema-sync');
}

// 1. å¯¼å‡ºæ•°æ® (å‰”é™¤è§†é¢‘Blobï¼Œä¿ç•™å…¶ä»–æ‰€æœ‰)
async function exportCinemaData() {
    const btn = event.target;
    btn.innerText = "æ­£åœ¨æ‰“åŒ…...";
    
    try {
        const db = await openDB();
        
        // è·å–æ‰€æœ‰å‰§é›†ä¿¡æ¯
        const tx1 = db.transaction("cinema_series", "readonly");
        const seriesList = await new Promise(resolve => {
            tx1.objectStore("cinema_series").getAll().onsuccess = (e) => resolve(e.target.result);
        });

        // è·å–æ‰€æœ‰åˆ†é›†æ•°æ®
        const tx2 = db.transaction("cinema_episodes", "readonly");
        const episodesList = await new Promise(resolve => {
            tx2.objectStore("cinema_episodes").getAll().onsuccess = (e) => resolve(e.target.result);
        });

        // âœ¨ æ ¸å¿ƒï¼šæ¸…æ´—æ•°æ®ï¼Œç§»é™¤ videoBlob âœ¨
        const cleanEpisodes = episodesList.map(ep => {
            // å¤åˆ¶å¯¹è±¡
            const cleanEp = { ...ep };
            // åˆ é™¤å¤§æ–‡ä»¶
            delete cleanEp.videoBlob; 
            // æ ‡è®°ä¸€ä¸‹ï¼Œè¿™æ˜¯å¯¼å‡ºçš„æ•°æ®
            cleanEp.isExported = true;
            return cleanEp;
        });

        const exportData = {
            type: "ai_phone_cinema_backup",
            version: 1,
            timestamp: Date.now(),
            series: seriesList,
            episodes: cleanEpisodes
        };

        // ä¸‹è½½
        const blob = new Blob([JSON.stringify(exportData)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cinema_data_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        
        alert("âœ… å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åŒ…å«èŠå¤©è®°å½•ã€å­—å¹•å’Œæ€»ç»“ï¼Œä½†ä¸åŒ…å«è§†é¢‘ã€‚\nè¯·è®°å¾—æ‰‹åŠ¨ä¼ è¾“ MP4 æ–‡ä»¶ã€‚");

    } catch(e) {
        alert("å¯¼å‡ºå¤±è´¥: " + e.message);
    } finally {
        btn.innerText = "å¯¼å‡ºæ•°æ®æ–‡ä»¶ (.json)";
    }
}

// 2. å¯¼å…¥æ•°æ® (æ™ºèƒ½åˆå¹¶)
async function importCinemaData(e) {
    const file = e.target.files[0];
    if(!file) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if(data.type !== "ai_phone_cinema_backup") throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®");

        const db = await openDB();
        
        // A. å¯¼å…¥å‰§é›† (Series)
        const tx1 = db.transaction("cinema_series", "readwrite");
        data.series.forEach(s => tx1.objectStore("cinema_series").put(s)); // ç›´æ¥è¦†ç›–/æ–°å¢
        
        // B. å¯¼å…¥åˆ†é›† (Episodes) - éœ€è¦æ™ºèƒ½åˆ¤æ–­
        const tx2 = db.transaction("cinema_episodes", "readwrite");
        const store2 = tx2.objectStore("cinema_episodes");

        // æˆ‘ä»¬ä¸èƒ½ç®€å•çš„ putï¼Œå› ä¸ºå¦‚æœæœ¬åœ°å·²ç»æœ‰è§†é¢‘äº†ï¼Œè¦†ç›–ä¼šå¯¼è‡´è§†é¢‘ä¸¢å¤±
        // æ‰€ä»¥è¦å…ˆæŸ¥ä¸€ä¸‹æœ¬åœ°æœ‰æ²¡æœ‰
        for (const newEp of data.episodes) {
            // ä½¿ç”¨ Promise åŒ…è£… get è¯·æ±‚
            const localEp = await new Promise(resolve => {
                const req = store2.get(newEp.id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });

            if (localEp && localEp.videoBlob) {
                // æœ¬åœ°æœ‰è§†é¢‘ï¼ä¿ç•™è§†é¢‘ï¼Œåªæ›´æ–°å…¶ä»–æ•°æ®
                newEp.videoBlob = localEp.videoBlob;
                console.log(`ä¿ç•™äº†æœ¬åœ°è§†é¢‘: ${newEp.title}`);
            } else {
                // æœ¬åœ°æ²¡è§†é¢‘ï¼Œæˆ–è€…æœ¬æ¥å°±æ²¡è¿™ä¸ªé›†
                // newEp.videoBlob æœ¬æ¥å°±æ˜¯ undefinedï¼Œä¿æŒåŸæ ·
            }
            
            store2.put(newEp);
        }

        alert(`ğŸ‰ å¯¼å…¥æˆåŠŸï¼\næ¢å¤äº† ${data.series.length} éƒ¨å‰§é›†ï¼Œ${data.episodes.length} ä¸ªåˆ†é›†è®°å½•ã€‚`);
        closeModal('modal-cinema-sync');
        renderSeriesGrid(); // åˆ·æ–°é¦–é¡µ

    } catch(err) {
        alert("å¯¼å…¥å¤±è´¥: " + err.message);
        console.error(err);
    } finally {
        e.target.value = '';
    }
}

// 3. é‡æ–°å…³è”è§†é¢‘ (Re-link)
// è¿™æ˜¯ç»™â€œè§†é¢‘ä¸¢å¤±â€çŠ¶æ€ç”¨çš„
function relinkVideo(epId) {
    // åŠ¨æ€åˆ›å»ºä¸€ä¸ª input æ¥é€‰æ–‡ä»¶
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.mp4,.mkv,.mov';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const db = await openDB();
        const tx = db.transaction("cinema_episodes", "readwrite");
        const store = tx.objectStore("cinema_episodes");
        
        // å…ˆå–å‡ºæ•°æ®
        const req = store.get(epId);
        req.onsuccess = () => {
            const ep = req.result;
            // æ³¨å…¥çµé­‚
            ep.videoBlob = file; 
            // å­˜å›å»
            store.put(ep);
            
            alert(`âœ… å…³è”æˆåŠŸï¼\nç°åœ¨å¯ä»¥è§‚çœ‹ã€Š${ep.title}ã€‹äº†ï¼ŒèŠå¤©è®°å½•å’Œå­—å¹•éƒ½è¿˜åœ¨ã€‚`);
            loadEpisodeList(); // åˆ·æ–°åˆ—è¡¨
        };
    };
    
    input.click();
}
        // ==========================================
// --- ğŸ¬ æ”¾æ˜ å®¤ï¼šæ‰‹åŠ¨åˆ†äº«/åŒæ­¥é€»è¾‘ ---
// ==========================================

// 1. æ‰“å¼€åˆ†äº«å¼¹çª—
function openCinemaShareModal() {
    if (!cinemaState.currentEpData) return;
    
    // è·å–å½“å‰é›†çš„èŠå¤©è®°å½•
    const logs = cinemaState.currentEpData.chatLogs || [];
    const total = logs.length;
    
    if (total === 0) return alert("è¿™ä¸€é›†è¿˜æ²¡æœ‰äº’åŠ¨è®°å½•å“¦");

    document.getElementById('share-total-count').innerText = total;
    
    // é»˜è®¤é€‰ä¸­å…¨éƒ¨ï¼Œæˆ–è€…æœ€è¿‘çš„20æ¡
    const defaultStart = Math.max(1, total - 20);
    document.getElementById('share-start-idx').value = defaultStart;
    document.getElementById('share-end-idx').value = total;

    openModal('modal-cinema-share');
}

// 2. ç¡®è®¤åˆ†äº« (ç”Ÿæˆå¡ç‰‡æ¨é€åˆ°ä¸»èŠå¤©)
function confirmCinemaShare() {
    // 1. è·å–èŒƒå›´
    const startVal = parseInt(document.getElementById('share-start-idx').value);
    const endVal = parseInt(document.getElementById('share-end-idx').value);
    const logs = cinemaState.currentEpData.chatLogs || [];
    
    if (isNaN(startVal) || isNaN(endVal) || startVal > endVal) return alert("èŒƒå›´æ— æ•ˆ");
    if (startVal < 1 || endVal > logs.length) return alert("è¶…å‡ºè®°å½•èŒƒå›´");

    // 2. æˆªå–æ•°æ® (æ³¨æ„æ•°ç»„ç´¢å¼•ä»0å¼€å§‹)
    const selectedLogs = logs.slice(startVal - 1, endVal);
    
    // 3. å‡†å¤‡ç›®æ ‡è§’è‰²
    const char = contacts.find(c => c.id === activeContactId);
    if (!char) return alert("è¯·å…ˆåœ¨ä¿¡æ¯åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼");

    // 4. ç”Ÿæˆæ˜¾ç¤ºçš„æ‘˜è¦æ–‡æœ¬ (ç”¨äºå¡ç‰‡æ˜¾ç¤º)
    // åªå–å‰3æ¡ä½œä¸ºé¢„è§ˆï¼Œé˜²æ­¢å¡ç‰‡å¤ªé•¿
    const previewText = selectedLogs.slice(0, 3).map(l => {
        const name = l.role === 'user' ? 'æˆ‘' : char.name;
        return `${name}: ${l.content.substring(0, 15)}...`;
    }).join('<br>');
    
    const count = selectedLogs.length;
    const epTitle = document.getElementById('player-title').innerText;

    // 5. ç”Ÿæˆå®Œæ•´çš„ Context (ç»™ AI çœ‹çš„)
    const fullTranscript = selectedLogs.map(l => {
        const name = l.role === 'user' ? (char.userName || "æˆ‘") : char.name;
        return `${name}: ${l.content}`;
    }).join('\n');

    // 6. æ„é€ å¡ç‰‡ HTML (è¿™æ˜¯ç»™ç”¨æˆ·çœ‹çš„)
    const cardHtml = `
        <div class="msg-link-card" style="background:#f2f2f7; pointer-events:none;">
            <div class="link-card-cover" style="background:linear-gradient(135deg, #2c3e50, #000000); font-size:40px;">ğŸ¬</div>
            <div class="link-card-info">
                <div class="link-card-title">è§‚å½±è®°å½•åŒæ­¥:ã€Š${epTitle}ã€‹</div>
                <div class="link-card-desc" style="margin-top:5px; color:#555;">
                    ${previewText}
                    ${count > 3 ? '<br>......' : ''}
                </div>
                <div class="link-card-footer">
                    <span>å…± ${count} æ¡äº’åŠ¨</span>
                    <span>å·²åŒæ­¥ âœ…</span>
                </div>
            </div>
        </div>
    `;

    // 7. æ„é€ å‘ç»™ AI çš„ç³»ç»ŸæŒ‡ä»¤ (Hidden Context)
    const hiddenContext = `
[ç³»ç»Ÿäº‹ä»¶ï¼šè·¨è®¾å¤‡æ•°æ®åŒæ­¥]
ç”¨æˆ·åˆšåˆšåŒæ­¥äº†ä½ ä»¬åœ¨â€œæ”¾æ˜ å®¤â€è§‚çœ‹ã€Š${epTitle}ã€‹æ—¶çš„äº’åŠ¨è®°å½•ã€‚
ä»¥ä¸‹æ˜¯ä½ ä»¬å½“æ—¶çš„å¯¹è¯å†…å®¹ï¼ˆè¯·å°†å…¶è§†ä¸ºåˆšåˆšå‘ç”Ÿçš„å…±åŒè®°å¿†ï¼‰ï¼š
------------------
${fullTranscript}
------------------
æŒ‡ä»¤ï¼š
1. ä½ çš„è®°å¿†å·²æ›´æ–°ã€‚
2. ç”¨æˆ·ç°åœ¨å¯èƒ½ä¼šæ¥ç€è¿™ä¸ªè¯é¢˜èŠï¼Œæˆ–è€…å¯¹åˆšæ‰çš„å‰§æƒ…å‘è¡¨æ€»ç»“ã€‚
3. è¯·æ ¹æ®ä¸Šè¿°å¯¹è¯çš„æ°›å›´ï¼ˆæ˜¯å¼€å¿ƒã€åæ§½è¿˜æ˜¯æ„ŸåŠ¨ï¼‰ï¼Œè‡ªç„¶åœ°æ¥è¯ã€‚
    `;

    // 8. å­˜å…¥ä¸»èŠå¤©è®°å½•
    // æˆ‘ä»¬æŠŠè¿™æ¡æ¶ˆæ¯ä¼ªè£…æˆ "user" å‘é€çš„ï¼Œå¸¦æœ‰éšè—ä¸Šä¸‹æ–‡
    char.messages.push({
        role: 'user',
        content: cardHtml, // ç•Œé¢æ˜¾ç¤ºæ¼‚äº®çš„å¡ç‰‡
        timestamp: Date.now(),
        hiddenContext: hiddenContext // AI è¯»å–çœŸæ­£çš„è®°å¿†
    });
    
    saveData();
    closeModal('modal-cinema-share');
    
    // 9. è·³è½¬å¹¶è§¦å‘
    if(confirm("åŒæ­¥æˆåŠŸï¼æ˜¯å¦ç«‹åˆ»è·³è½¬å›èŠå¤©ç•Œé¢ç»§ç»­è®¨è®ºï¼Ÿ")) {
        // å…ˆé€€å‡ºæ’­æ”¾å™¨é˜²æ­¢å†²çª
        const video = document.getElementById('cinema-video');
        if(video) video.pause();
        
        navigateTo('page-chat');
        
        // è§¦å‘ AI (ä¸ºäº†è®©å®ƒè¯»å– hiddenContext å¹¶å¯¹åŒæ­¥è¡Œä¸ºåšå‡ºååº”)
        setTimeout(() => {
            // è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ç”¨æˆ·è¾“å…¥ï¼Œç›´æ¥è®© AI æ ¹æ® context å›å¤ä¸€å¥
            // æ¯”å¦‚ "å“ˆå“ˆï¼Œåˆšæ‰é‚£æ®µçœŸçš„å¤ªæç¬‘äº†"
            triggerAI(); 
        }, 500);
    }
}
        // ==========================================
// --- ğŸ’– çºªå¿µæ—¥ (Anniversary) ç³»ç»Ÿ ---
// ==========================================

// æ‰“å¼€åˆ—è¡¨
function openAnniversaryModal() {
    const char = getActiveChar();
    if(!char) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼");
    
    renderAnniversaryList();
    openModal('modal-anniversary-list');
}

// æ¸²æŸ“åˆ—è¡¨ (æ ¸å¿ƒï¼šè®¡ç®—å¤©æ•°)
function renderAnniversaryList() {
    const char = getActiveChar();
    const container = document.getElementById('anni-list-container');
    container.innerHTML = '';

    // å…¼å®¹æ—§æ•°æ®
    if(!char.anniversaries) char.anniversaries = [];

    if(char.anniversaries.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; margin-top:50px;">ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ ç¬¬ä¸€ä¸ªçºªå¿µæ—¥</div>`;
        return;
    }

    // æ’åºï¼šä¼˜å…ˆæ˜¾ç¤ºæœ€è¿‘çš„ï¼ˆç»å¯¹å€¼å°çš„æ’å‰é¢ï¼‰
    const now = new Date();
    // ç®€å•çš„æ—¥æ¸…ç©ºï¼Œåªæ¯”è¾ƒæ—¥æœŸ
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    char.anniversaries.forEach((item, index) => {
        const targetDate = new Date(item.date);
        // è®¡ç®—å·®å€¼ (æ¯«ç§’)
        const diffTime = targetDate - today; 
        // è½¬æ¢ä¸ºå¤©æ•° (å‘ä¸Šå–æ•´)
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let numDisplay = 0;
        let labelDisplay = "";
        let classExtra = ""; // ç”¨äºæ§åˆ¶èƒŒæ™¯è‰²

        if (diffDays > 0) {
            // æœªæ¥ -> å€’è®¡æ—¶
            numDisplay = diffDays;
            labelDisplay = "è¿˜æœ‰ / å¤©";
            classExtra = "future"; // è“è‰²ç³»
        } else if (diffDays < 0) {
            // è¿‡å» -> æ­£è®¡æ—¶
            numDisplay = Math.abs(diffDays); // å–ç»å¯¹å€¼
            labelDisplay = "å·²ç» / å¤©";
            classExtra = ""; // é»˜è®¤ç²‰è‰²ç³»
        } else {
            // ä»Šå¤©ï¼
            numDisplay = "ä»Šå¤©";
            labelDisplay = "å°±æ˜¯ï¼";
            classExtra = "today"; 
        }

        // å¤´åƒå¤„ç† (å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ï¼Œå°±ç”¨å½“å‰çš„)
        // æ”¯æŒç‚¹å‡»æ›´æ¢é€»è¾‘å¤ªå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–ä¸ºï¼š
        // å·¦è¾¹æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¤´åƒï¼Œå³è¾¹æ˜¾ç¤ºå½“å‰è§’è‰²å¤´åƒ
        const userAva = char.userAvatar;
        const aiAva = char.avatar;

        const div = document.createElement('div');
        div.className = `anni-card ${classExtra}`;
        div.innerHTML = `
            <div class="btn-del-anni" onclick="deleteAnniversary(${index})">Ã—</div>
            
            <div class="anni-header-row">
                <img src="${userAva}" class="anni-avatar">
                <div class="anni-wave-line"></div>
                <img src="${aiAva}" class="anni-avatar">
            </div>
            
            <div class="anni-info">
                <div class="anni-title">${item.title}</div>
                <div class="anni-days-box">
                    ${diffDays < 0 ? `<span class="anni-label">å·²ç»</span>` : ''}
                    <span class="anni-num">${numDisplay}</span>
                    <span class="anni-label">${diffDays > 0 ? 'å¤©' : (diffDays===0 ? '' : 'å¤©')}</span>
                </div>
                <div class="anni-date">${item.date}</div>
            </div>
        `;
        container.appendChild(div);
    });
}

// æ‰“å¼€ç¼–è¾‘/æ–°å»º
function openEditAnniversary(index) {
    document.getElementById('anni-edit-index').value = index;
    // é»˜è®¤ä»Šå¤©
    const todayStr = new Date().toISOString().split('T')[0];
    
    if (index === -1) {
        document.getElementById('anni-title-input').value = "";
        document.getElementById('anni-date-input').value = todayStr;
    } else {
        // è¿™é‡Œæš‚æ—¶æ²¡åšç‚¹å‡»ç¼–è¾‘ï¼Œåªåšäº†ç‚¹å‡»åˆ é™¤ã€‚å¦‚æœéœ€è¦ç¼–è¾‘å¯ä»¥åŠ ã€‚
        // ä¸ºäº†ç®€å•ï¼Œç›®å‰åªæ”¯æŒæ–°å»ºã€‚
    }
    openModal('modal-edit-anni');
}

// ä¿å­˜
function saveAnniversary() {
    const char = getActiveChar();
    const title = document.getElementById('anni-title-input').value.trim();
    const date = document.getElementById('anni-date-input').value;

    if(!title || !date) return alert("è¯·å¡«å†™å®Œæ•´");

    if(!char.anniversaries) char.anniversaries = [];

    char.anniversaries.push({
        id: Date.now(),
        title: title,
        date: date
    });

    saveData();
    closeModal('modal-edit-anni');
    renderAnniversaryList();
    
    // å‘ŠçŸ¥ç”¨æˆ·
    alert("çºªå¿µæ—¥å·²æ·»åŠ ï¼AI ä¼šåœ¨èŠå¤©ä¸­æ„ŸçŸ¥åˆ°å®ƒã€‚");
}

// åˆ é™¤
function deleteAnniversary(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ")) {
        const char = getActiveChar();
        char.anniversaries.splice(index, 1);
        saveData();
        renderAnniversaryList();
    }
}
        // ==========================================
// --- ğŸ”® å‘½è¿å±‹ (Mystic Lab) é€»è¾‘ ---
// ==========================================

// 1. 22å¼ å¤§é˜¿å¡çº³ç‰Œæ•°æ® (ä½¿ç”¨ç»´åŸºç™¾ç§‘èµ„æº)
const tarotDeck = [
    { name: "æ„šäºº (The Fool)", img: "https://upload.wikimedia.org/wikipedia/commons/9/90/RWS_Tarot_00_Fool.jpg" },
    { name: "é­”æœ¯å¸ˆ (The Magician)", img: "https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg" },
    { name: "å¥³ç¥­å¸ (The High Priestess)", img: "https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg" },
    { name: "çš‡å (The Empress)", img: "https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg" },
    { name: "çš‡å¸ (The Emperor)", img: "https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg" },
    { name: "æ•™çš‡ (The Hierophant)", img: "https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg" },
    { name: "æ‹äºº (The Lovers)", img: "https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg" }, // ä¿®æ­£é“¾æ¥
    { name: "æˆ˜è½¦ (The Chariot)", img: "https://upload.wikimedia.org/wikipedia/commons/9/9b/RWS_Tarot_07_Chariot.jpg" },
    { name: "åŠ›é‡ (Strength)", img: "https://upload.wikimedia.org/wikipedia/commons/f/f5/RWS_Tarot_08_Strength.jpg" },
    { name: "éšå£« (The Hermit)", img: "https://upload.wikimedia.org/wikipedia/commons/4/4d/RWS_Tarot_09_Hermit.jpg" },
    { name: "å‘½è¿ä¹‹è½® (Wheel of Fortune)", img: "https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg" },
    { name: "æ­£ä¹‰ (Justice)", img: "https://upload.wikimedia.org/wikipedia/commons/e/e0/RWS_Tarot_11_Justice.jpg" },
    { name: "å€’åŠäºº (The Hanged Man)", img: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg" },
    { name: "æ­»ç¥ (Death)", img: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg" },
    { name: "èŠ‚åˆ¶ (Temperance)", img: "https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg" },
    { name: "æ¶é­” (The Devil)", img: "https://upload.wikimedia.org/wikipedia/commons/5/55/RWS_Tarot_15_Devil.jpg" },
    { name: "é«˜å¡” (The Tower)", img: "https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_16_Tower.jpg" },
    { name: "æ˜Ÿæ˜Ÿ (The Star)", img: "https://upload.wikimedia.org/wikipedia/commons/d/db/RWS_Tarot_17_Star.jpg" },
    { name: "æœˆäº® (The Moon)", img: "https://upload.wikimedia.org/wikipedia/commons/7/7f/RWS_Tarot_18_Moon.jpg" },
    { name: "å¤ªé˜³ (The Sun)", img: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg" },
    { name: "å®¡åˆ¤ (Judgement)", img: "https://upload.wikimedia.org/wikipedia/commons/d/dd/RWS_Tarot_20_Judgement.jpg" },
    { name: "ä¸–ç•Œ (The World)", img: "https://upload.wikimedia.org/wikipedia/commons/f/ff/RWS_Tarot_21_World.jpg" }
];

let tarotState = {
    drawnCards: [], // [{card, reversed: boolean}]
    isRevealed: false
};

// 2. æ‰“å¼€å¼¹çª—
function openMysticModal() {
    const char = getActiveChar();
    if (!char) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡");
    
    document.getElementById('mystic-char-name').innerText = `${char.name} çš„æ˜Ÿåº§`;
    
    // å°è¯•è¯»å–å·²ä¿å­˜çš„æ˜Ÿåº§
    if(char.zodiac) document.getElementById('char-zodiac').value = char.zodiac;
    
    // é‡ç½®å¡”ç½—ç•Œé¢
    resetTarotUI();
    openModal('modal-mystic');
}

function switchMysticTab(tab) {
    document.querySelectorAll('.mystic-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-tab-${tab}`).classList.add('active');
    
    document.getElementById('view-tarot').style.display = tab === 'tarot' ? 'block' : 'none';
    document.getElementById('view-horoscope').style.display = tab === 'horoscope' ? 'block' : 'none';
}

// 3. å¡”ç½—ç‰Œé€»è¾‘
function resetTarotUI() {
    const area = document.getElementById('tarot-spread-area');
    area.innerHTML = '<div style="color:rgba(255,255,255,0.5); margin-top:20px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ´—ç‰Œ</div>';
    document.getElementById('btn-tarot-action').innerText = "ğŸ”® æ´—ç‰Œå¹¶æŠ½ç‰Œ (3å¼ )";
    document.getElementById('btn-tarot-action').onclick = startTarotFlow;
    tarotState.isRevealed = false;
}

function startTarotFlow() {
    const question = document.getElementById('tarot-question').value.trim();
    if (!question) {
        if(!confirm("ä½ è¿˜æ²¡æœ‰è¾“å…¥é—®é¢˜ï¼Œè¦ç›´æ¥è¿›è¡Œã€ä»Šæ—¥è¿åŠ¿ã€‘å åœå—ï¼Ÿ")) return;
    }

    const area = document.getElementById('tarot-spread-area');
    area.innerHTML = '';
    
    // éšæœºæŠ½3å¼ 
    tarotState.drawnCards = [];
    const deckCopy = [...tarotDeck];
    
    for(let i=0; i<3; i++) {
        const randIdx = Math.floor(Math.random() * deckCopy.length);
        const card = deckCopy.splice(randIdx, 1)[0];
        const reversed = Math.random() > 0.5; // 50% é€†ä½æ¦‚ç‡
        tarotState.drawnCards.push({ ...card, reversed });
    }

    // æ¸²æŸ“å¡èƒŒ (Face down)
    tarotState.drawnCards.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'tarot-card-scene';
        div.onclick = () => flipTarotCard(div, index);
        div.innerHTML = `
            <div class="tarot-card-inner">
                <div class="tarot-face back">
                    <img src="${item.img}" class="tarot-img" style="${item.reversed ? 'transform: rotate(180deg);' : ''}">
                    <div class="tarot-label">${item.name} ${item.reversed ? '(é€†ä½)' : '(æ­£ä½)'}</div>
                </div>
                <div class="tarot-face front"></div> <!-- èƒŒé¢å…¶å®æ˜¯Frontæ ·å¼ï¼Œæ­£é¢å›¾æ˜¯Backæ ·å¼ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç¿»è½¬ -->
            </div>
        `;
        area.appendChild(div);
    });

    document.getElementById('btn-tarot-action').innerText = "âœ¨ è¯·æ±‚ AI è§£è¯»ç‰Œé¢";
    document.getElementById('btn-tarot-action').onclick = interpretTarot;
    
    // è‡ªåŠ¨ç¿»ç‰ŒåŠ¨ç”» (ä¾æ¬¡ç¿»å¼€)
    const cards = document.querySelectorAll('.tarot-card-scene');
    cards.forEach((c, i) => {
        setTimeout(() => {
            c.classList.add('flipped');
        }, i * 300);
    });
    tarotState.isRevealed = true;
}

// ç¿»ç‰Œæ•ˆæœ
function flipTarotCard(element, index) {
    // å…è®¸ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»å†æ¬¡ç¿»è½¬æŸ¥çœ‹èƒŒé¢(ç‰ŒèƒŒ)
    element.classList.toggle('flipped');
}

// æäº¤ç»™ AI è§£è¯»
async function interpretTarot() {
    if (!tarotState.isRevealed) return;
    
    const char = getActiveChar();
    const question = document.getElementById('tarot-question').value.trim() || "ä»Šæ—¥è¿åŠ¿";
    
    const cardsStr = tarotState.drawnCards.map((c, i) => {
        const pos = ["è¿‡å»/åŸå› ", "ç°åœ¨/è¿‡ç¨‹", "æœªæ¥/ç»“æœ"][i];
        return `${i+1}. [${pos}]: ${c.name} (${c.reversed ? 'é€†ä½' : 'æ­£ä½'})`;
    }).join('\n');

    const prompt = `
    [å¡”ç½—å åœæ¨¡å¼]
    ç”¨æˆ·å‘ä½ å¯»æ±‚å¡”ç½—ç‰Œè§£è¯»ã€‚
    ã€é—®é¢˜ã€‘ï¼š${question}
    ã€ç‰Œé˜µ (åœ£ä¸‰è§’)ã€‘ï¼š
    ${cardsStr}
    
    è¯·ä½ ä»¥è§’è‰² "${char.name}" çš„èº«ä»½ï¼ˆäººè®¾ï¼š${char.systemPrompt}ï¼‰æ¥è¿›è¡Œè§£è¯»ã€‚
    è¦æ±‚ï¼š
    1. ä¸è¦åƒè¯´æ˜ä¹¦ä¸€æ ·è§£é‡Šç‰Œæ„ï¼Œè¦åƒåœ¨èŠå¤©ã€‚
    2. ç»“åˆç‰Œé¢å«ä¹‰å’Œä½ ä»¬çš„å…³ç³»ï¼Œç»™å‡ºå»ºè®®æˆ–å®‰æ…°ã€‚
    3. å¦‚æœç‰Œé¢ä¸å¥½ï¼ˆå¦‚æ­»ç¥é€†ä½ã€é«˜å¡”ï¼‰ï¼Œè¯·ç”¨ä½ çš„æ–¹å¼ï¼ˆæ¸©æŸ”æˆ–å‚²å¨‡ï¼‰åŒ–è§£ç„¦è™‘ã€‚
    4. å­—æ•°æ§åˆ¶åœ¨ 200 å­—å·¦å³ã€‚
    `;

    // æ„é€ å¡ç‰‡å‘ç»™ç”¨æˆ·
    const cardImagesHtml = tarotState.drawnCards.map(c => 
        `<div style="display:inline-block; width:60px; text-align:center; margin:2px;">
            <img src="${c.img}" style="width:100%; border-radius:4px; ${c.reversed?'transform:rotate(180deg)':''}">
            <div style="font-size:10px;">${c.reversed?'é€†':'æ­£'}</div>
         </div>`
    ).join('');

    const userMsgHtml = `
        <div style="font-weight:bold; margin-bottom:5px;">ğŸ”® å¡”ç½—å åœ: ${question}</div>
        <div style="display:flex; justify-content:center;">${cardImagesHtml}</div>
    `;

    // å­˜å…¥èŠå¤©
    closeModal('modal-mystic');
    char.messages.push({
        role: 'user',
        content: userMsgHtml, // æ˜¾ç¤ºæ¼‚äº®çš„å›¾ç‰‡å¡ç‰‡
        hiddenContext: prompt, // AI è¯» prompt
        timestamp: Date.now()
    });
    saveData();
    
    renderChat(activeContactId);
    triggerAI(); // è§¦å‘
}

// 4. æ˜Ÿåº§è¿åŠ¿é€»è¾‘
function analyzeHoroscope() {
    const userSign = document.getElementById('user-zodiac').value;
    const charSign = document.getElementById('char-zodiac').value;
    
    if(!userSign) return alert("è¯·è‡³å°‘é€‰æ‹©ä½ çš„æ˜Ÿåº§");
    
    const char = getActiveChar();
    // ä¿å­˜æ˜Ÿåº§è®¾ç½®
    char.zodiac = charSign;
    saveData(); // ä¿å­˜åˆ°è”ç³»äººæ•°æ®

    let prompt = "";
    let displayTitle = "";

    if (!charSign) {
        // å•äººè¿åŠ¿
        displayTitle = `ğŸŒŒ ${userSign} ä»Šæ—¥è¿åŠ¿`;
        prompt = `
        [æ˜Ÿåº§è¿åŠ¿æ¨¡å¼]
        ç”¨æˆ·æ˜¯ ${userSign}ã€‚è¯·ä½ æ‰®æ¼” "${char.name}" (äººè®¾:${char.systemPrompt})ã€‚
        è¯·ä¸ºç”¨æˆ·æ’­æŠ¥ä»Šå¤©çš„è¿åŠ¿ã€‚
        åŒ…å«ï¼šä»Šæ—¥å¿ƒæƒ…æŒ‡æ•°ã€å¹¸è¿è‰²ã€ä»¥åŠä¸€å¥ç»“åˆä½ äººè®¾çš„å»ºè®®æˆ–å…³æ€€ã€‚
        `;
    } else {
        // åŒäººåˆç›˜
        displayTitle = `ğŸŒŒ æ˜Ÿåº§é…å¯¹: ${userSign} & ${charSign}`;
        prompt = `
        [æ˜Ÿç›˜åˆç›˜æ¨¡å¼]
        ç”¨æˆ·æ˜¯ ${userSign}ï¼Œä½ æ˜¯ ${charSign}ã€‚
        è¯·ç»“åˆä½ ä»¬çš„æ˜Ÿåº§ç‰¹æ€§ï¼Œåˆ†æä»Šå¤©çš„ç›¸å¤„è¿åŠ¿æˆ–æ‹çˆ±å¥‘åˆåº¦ã€‚
        ä½ çš„æ€§æ ¼æ˜¯ ${char.systemPrompt}ã€‚
        è¯·è¯„ä»·è¿™å¯¹æ˜Ÿåº§ç»„åˆçš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶ç»™å‡ºä»Šå¤©çš„ç›¸å¤„å»ºè®®ã€‚
        `;
    }

    // å‘é€
    closeModal('modal-mystic');
    char.messages.push({
        role: 'user',
        content: `[è¯·æ±‚æŸ¥çœ‹] ${displayTitle}`,
        hiddenContext: prompt,
        timestamp: Date.now()
    });
    saveData();
    renderChat(activeContactId);
    triggerAI();
}
        // --- ğŸ”® æ˜Ÿåº§/æ˜Ÿç›˜ å¢å¼ºé€»è¾‘ ---

// 1. åˆ‡æ¢å­ Tab (åˆç›˜ / æ˜Ÿç›˜)
function toggleHoroSubTab(mode) {
    document.getElementById('horo-sub-match').style.display = mode === 'match' ? 'block' : 'none';
    document.getElementById('horo-sub-chart').style.display = mode === 'chart' ? 'block' : 'none';
    
    // å¦‚æœåˆ‡æ¢åˆ°æ˜Ÿç›˜ï¼Œé¡ºä¾¿åŒæ­¥ä¸€ä¸‹å¤ªé˜³æ˜Ÿåº§
    if(mode === 'chart') syncZodiacToChart();
}

// 2. åŒæ­¥å¤ªé˜³æ˜Ÿåº§ (ä»ä¸‹æ‹‰æ¡† -> è¾“å…¥æ¡†)
function syncZodiacToChart() {
    const userZ = document.getElementById('user-zodiac').value;
    const charZ = document.getElementById('char-zodiac').value;
    
    if(userZ) document.getElementById('chart-user-sun').value = userZ;
    if(charZ) document.getElementById('chart-char-sun').value = charZ;
}

// 3. ğŸ¤– AI è‡ªåŠ¨æ¨æ¼”è§’è‰²æ˜Ÿç›˜ (Feature!)
async function aiGuessChart() {
    const char = getActiveChar();
    if (!char || !globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");

    const sunSign = document.getElementById('char-zodiac').value || "æœªçŸ¥";
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "ğŸ”® æ¨æ¼”ä¸­...";
    btn.disabled = true;

    const prompt = `
    ä½ æ˜¯ä¸€ä¸ªå æ˜Ÿä¸“å®¶ã€‚å½“å‰è§’è‰²çš„æ€§æ ¼è®¾å®šå¦‚ä¸‹ï¼š
    "${char.systemPrompt}"
    
    å·²çŸ¥(æˆ–å‡è®¾) Ta çš„å¤ªé˜³æ˜Ÿåº§æ˜¯ï¼š${sunSign}ã€‚
    
    è¯·æ ¹æ® Ta çš„æ€§æ ¼è®¾å®šï¼Œåå‘æ¨å¯¼ Ta æœ€å¯èƒ½çš„ã€æœˆäº®æ˜Ÿåº§ã€‘(ä»£è¡¨å†…å¿ƒ/æƒ…ç»ª) å’Œã€ä¸Šå‡æ˜Ÿåº§ã€‘(ä»£è¡¨å¤–åœ¨é¢å…·/ç»™äººçš„å°è±¡)ã€‚
    
    è¦æ±‚ï¼š
    1. å¿…é¡»ç¬¦åˆäººè®¾ï¼ˆä¾‹å¦‚ï¼šå¤–å†·å†…çƒ­å¯èƒ½æ˜¯ä¸Šå‡å¤©è+æœˆäº®å·¨èŸ¹ï¼‰ã€‚
    2. åªè¿”å›çº¯ JSON æ ¼å¼ï¼š{"sun": "xxåº§", "moon": "xxåº§", "rising": "xxåº§"}
    3. å¦‚æœå¤ªé˜³æ˜Ÿåº§æœªçŸ¥ï¼Œè¯·ä½ æ ¹æ®æ€§æ ¼è®¾å®šä¸€ä¸ªæœ€åˆé€‚çš„ã€‚
    `;

    try {
        // ä½¿ç”¨ fetchWithRetry (å¤ç”¨ä½ å·²æœ‰çš„å‡½æ•°)
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7
        });
        
        const data = await res.json();
        const jsonStr = data.choices[0].message.content.replace(/```json|```/g, '').trim();
        const result = JSON.parse(jsonStr);

        // å¡«å…¥è¾“å…¥æ¡†
        document.getElementById('chart-char-sun').value = result.sun;
        document.getElementById('chart-char-moon').value = result.moon;
        document.getElementById('chart-char-rising').value = result.rising;
        
        // é¡ºä¾¿æ›´æ–°ä¸‹æ‹‰æ¡†
        if(result.sun && !document.getElementById('char-zodiac').value) {
            document.getElementById('char-zodiac').value = result.sun;
        }

        alert(`æ¨æ¼”å®Œæˆï¼\nAI è®¤ä¸º Ta æ˜¯ï¼šæ—¥${result.sun} æœˆ${result.moon} å‡${result.rising}`);

    } catch (e) {
        console.error(e);
        alert("æ¨æ¼”å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// 4. ç”Ÿæˆæ·±åº¦æ˜Ÿè±¡æŠ¥å‘Š
async function generateFullChartReport() {
    const char = getActiveChar();
    if (!char) return;

    // è·å–æ•°æ®
    const uSun = document.getElementById('chart-user-sun').value || "æœªçŸ¥";
    const uMoon = document.getElementById('chart-user-moon').value || "æœªçŸ¥";
    const uRising = document.getElementById('chart-user-rising').value || "æœªçŸ¥";

    const cSun = document.getElementById('chart-char-sun').value || "æœªçŸ¥";
    const cMoon = document.getElementById('chart-char-moon').value || "æœªçŸ¥";
    const cRising = document.getElementById('chart-char-rising').value || "æœªçŸ¥";

    if (uSun === "æœªçŸ¥" && cSun === "æœªçŸ¥") return alert("è‡³å°‘å¡«ä¸€ä¸ªå¤ªé˜³æ˜Ÿåº§å§ï¼");

    // æ„é€  Prompt
    const prompt = `
    [æ·±åº¦æ˜Ÿç›˜åˆ†ææ¨¡å¼]
    ç”¨æˆ·ä¸è§’è‰² "${char.name}" çš„æ˜Ÿç›˜é…ç½®å¦‚ä¸‹ï¼š
    
    ã€ç”¨æˆ·ã€‘: ğŸŒå¤ªé˜³${uSun}, ğŸŒ›æœˆäº®${uMoon}, ğŸ¹ä¸Šå‡${uRising}
    ã€è§’è‰²ã€‘: ğŸŒå¤ªé˜³${cSun}, ğŸŒ›æœˆäº®${cMoon}, ğŸ¹ä¸Šå‡${cRising}
    
    è¯·ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„ã€ŠåŒäººæ˜Ÿè±¡æŠ¥å‘Šå•ã€‹ã€‚
    è¦æ±‚ï¼š
    1. æ ¼å¼ä¸“ä¸šï¼Œåˆ†ç‚¹é™ˆè¿°ã€‚
    2. ã€æ€§æ ¼å…±é¸£ã€‘ï¼šåˆ†æåŒæ–¹æœˆäº®æ˜Ÿåº§ï¼ˆå†…å¿ƒéœ€æ±‚ï¼‰æ˜¯å¦å¥‘åˆã€‚
    3. ã€å¸å¼•åŠ›æ³•åˆ™ã€‘ï¼šåˆ†æä¸Šå‡ä¸å¤ªé˜³çš„ç›¸ä½å¸¦æ¥çš„ç¬¬ä¸€å¸å¼•åŠ›ã€‚
    4. ã€æ½œåœ¨é›·åŒºã€‘ï¼šæŒ‡å‡ºæ€§æ ¼ä¸­å¯èƒ½å†²çªçš„åœ°æ–¹ã€‚
    5. ã€å‘å±•å»ºè®®ã€‘ï¼šç»™ç”¨æˆ·å…·ä½“çš„ç›¸å¤„å»ºè®®ã€‚
    6. è¯­æ°”ï¼šç¥ç§˜ã€ä¸“ä¸šä½†æ¸©æš–ã€‚
    `;

    // å…³é—­å¼¹çª—ï¼Œåœ¨èŠå¤©é‡Œæ˜¾ç¤º
    closeModal('modal-mystic');
    
    // å…ˆå‘ä¸€æ¡ç”¨æˆ·è¯·æ±‚
    const displayHtml = `
        <div style="background:#2c003e; color:#e0d0ff; padding:10px; border-radius:8px; border:1px solid #d4a373;">
            <div style="text-align:center; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.2); margin-bottom:5px;">ğŸ“œ æ˜Ÿè±¡æ¡£æ¡ˆ</div>
            <div style="font-size:12px;">æˆ‘: æ—¥${uSun} æœˆ${uMoon} å‡${uRising}</div>
            <div style="font-size:12px;">Ta: æ—¥${cSun} æœˆ${cMoon} å‡${cRising}</div>
        </div>
    `;

    char.messages.push({
        role: 'user',
        content: displayHtml, // æ¼‚äº®çš„å¡ç‰‡
        hiddenContext: prompt, // ç»™AIçš„æŒ‡ä»¤
        timestamp: Date.now()
    });
    saveData();
    renderChat(activeContactId);
    
    // è§¦å‘ AI
    triggerAI();
}
        // ==========================================
// --- ğŸ“± é¦–é¡µæ»‘åŠ¨ä¸æ–°ç»„ä»¶é€»è¾‘ ---
// ==========================================

// 1. æ»‘åŠ¨ç¿»é¡µ (Swipe)
let homeSwipe = {
    startX: 0,
    currentPage: 0, // 0 æˆ– 1
    container: null,
    wrapper: null
};

function initHomeSwiper() {
    homeSwipe.container = document.getElementById('homeSwiper');
    homeSwipe.wrapper = document.getElementById('homeWrapper');
    
    if(!homeSwipe.container) return;

    homeSwipe.container.addEventListener('touchstart', (e) => {
        homeSwipe.startX = e.touches[0].clientX;
    }, {passive: true});

    homeSwipe.container.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        const diff = homeSwipe.startX - endX;
        
        // æ»‘åŠ¨é˜ˆå€¼ 50px
        if (diff > 50) {
            // å·¦æ»‘ -> å»ç¬¬äºŒé¡µ
            setHomePage(1);
        } else if (diff < -50) {
            // å³æ»‘ -> å›ç¬¬ä¸€é¡µ
            setHomePage(0);
        }
    }, {passive: true});
}

function setHomePage(index) {
    if (index < 0 || index > 1) return;
    homeSwipe.currentPage = index;
    
    // ç§»åŠ¨ wrapper
    homeSwipe.wrapper.style.transform = `translateX(-${index * 50}%)`;
    
    // æ›´æ–°åœ†ç‚¹
    document.querySelectorAll('.page-dot').forEach((d, i) => {
        if(i === index) d.classList.add('active');
        else d.classList.remove('active');
    });
}

// é¡µé¢åŠ è½½ååˆå§‹åŒ–
window.addEventListener('load', initHomeSwiper);


// 2. ğŸ“ å¾…åŠäº‹é¡¹ (To-Do) é€»è¾‘
let todoData = [];

function loadTodos() {
    const s = localStorage.getItem('ai_phone_todos');
    if(s) todoData = JSON.parse(s);
    renderTodoList();
}
window.addEventListener('load', loadTodos);

function saveTodos() {
    localStorage.setItem('ai_phone_todos', JSON.stringify(todoData));
}

function addTodoItem() {
    // ç®€å• prompt è¾“å…¥
    const input = prompt("æ·»åŠ å¾…åŠäº‹é¡¹ (æ ¼å¼: äº‹é¡¹å [DDL: 2025-12-25])", "");
    if(!input) return;
    
    // ç®€å•è§£æ DDL (å¦‚æœç”¨æˆ·å†™äº† [DDL: xxx])
    let ddl = null;
    let content = input;
    const match = input.match(/\[DDL:\s*(.*?)\]/i);
    if(match) {
        ddl = match[1];
        content = input.replace(match[0], '').trim();
    }

    todoData.push({
        id: Date.now(),
        content: content,
        ddl: ddl,
        done: false
    });
    
    saveTodos();
    renderTodoList();
}

function deleteTodo(index, e) {
    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ·»åŠ 
    if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡äº‹é¡¹å—ï¼Ÿ")) {
        todoData.splice(index, 1);
        saveTodos();
        renderTodoList();
    }
}

function renderTodoList() {
    const list = document.getElementById('todo-widget-list');
    if(!list) return;
    list.innerHTML = '';
    
    if(todoData.length === 0) {
        list.innerHTML = '<div style="opacity:0.6; margin-top:10px; font-size:12px;">ç‚¹å‡»æ­¤å¤„æ·»åŠ äº‹é¡¹...</div>';
        return;
    }

    todoData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'todo-item';
        // é˜»æ­¢å†’æ³¡ï¼Œç‚¹å‡»æ–‡å­—åˆ é™¤
        div.onclick = (e) => deleteTodo(index, e);
        
        let ddlHtml = item.ddl ? `<span style="font-size:10px; color:#ffcc00; margin-left:5px;">${item.ddl}</span>` : '';
        
        div.innerHTML = `
            <div class="todo-check"></div>
            <div class="todo-text">${item.content} ${ddlHtml}</div>
        `;
        list.appendChild(div);
    });
}

// âœ¨ AI æ„ŸçŸ¥æ¥å£ï¼šå°†å¾…åŠäº‹é¡¹æ³¨å…¥ System Prompt
function getTodoContext() {
    if(todoData.length === 0) return "";
    
    const now = new Date();
    const todoListText = todoData.map(t => {
        let status = "";
        if(t.ddl) {
            const ddlDate = new Date(t.ddl);
            const diffDays = Math.ceil((ddlDate - now) / (1000 * 60 * 60 * 24));
            if(diffDays < 0) status = "(å·²é€¾æœŸ!)";
            else if(diffDays <= 3) status = `(ç´§æ€¥! å‰©${diffDays}å¤©)`;
            else status = `(æˆªæ­¢: ${t.ddl})`;
        }
        return `- ${t.content} ${status}`;
    }).join('\n');

    return `\n[ğŸ“‹ å¾…åŠäº‹é¡¹æ¸…å• (To-Do List)]:\n${todoListText}\nã€æŒ‡ä»¤ã€‘: å¦‚æœæœ‰æ ‡è®°ä¸ºâ€œç´§æ€¥â€æˆ–â€œé€¾æœŸâ€çš„äº‹é¡¹ï¼Œè¯·åœ¨èŠå¤©ä¸­ä¸»åŠ¨æé†’æˆ–å‚¬ä¿ƒç”¨æˆ·å»å®Œæˆã€‚`;
}

// âš ï¸ é‡è¦ï¼šè¯·æ‰¾åˆ°åŸæœ¬çš„ `getStatusContext(char)` å‡½æ•°ï¼ŒæŠŠ `context += getTodoContext();` åŠ è¿›å»ï¼
// (æˆ‘ä¼šåœ¨æœ€åä¸€æ­¥æç¤ºä½ )


// 3. ğŸ’¿ CD ç»„ä»¶é€»è¾‘
function changeCdCover() {
    const url = prompt("è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ä½œä¸º CD å°é¢:", "");
    if(url) {
        document.getElementById('cd-disc-img').style.backgroundImage = `url('${url}')`;
        // ä¿å­˜åˆ° localStorage é¿å…åˆ·æ–°ä¸¢å¤±
        localStorage.setItem('ai_phone_cd_cover', url);
    }
}

// åŠ è½½ CD å°é¢
window.addEventListener('load', () => {
    const savedCover = localStorage.getItem('ai_phone_cd_cover');
    if(savedCover) {
        document.getElementById('cd-disc-img').style.backgroundImage = `url('${savedCover}')`;
    }
});
        // ==========================================
// --- ğŸ¤– AI å°è¯´ç”Ÿæˆç³»ç»Ÿ (æ— é™æµå…±è¯») ---
// ==========================================

let generatedOutlines = []; // ä¸´æ—¶å­˜å‚¨ç”Ÿæˆçš„å¤§çº²

// 1. æ‰“å¼€åˆ›å»ºå¼¹çª—
function openCreateNovelModal() {
    const select = document.getElementById('novel-cp-select');
    select.innerHTML = '';
    
    if (contacts.length === 0) return alert("è¯·å…ˆåˆ›å»ºä¸€ä¸ªè§’è‰²ï¼");

    // å¡«å……è§’è‰²
    contacts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        select.appendChild(opt);
    });
    // é»˜è®¤é€‰å½“å‰æ´»è·ƒè§’è‰²
    if (activeContactId) select.value = activeContactId;

    document.getElementById('novel-tags-input').value = '';
    openModal('modal-create-novel');
}

// è¾…åŠ©ï¼šåŠ  Tag
function addTag(tag) {
    const input = document.getElementById('novel-tags-input');
    input.value = input.value ? input.value + "ã€" + tag : tag;
}

// è¾…åŠ©ï¼šéšæœº Tag
function fillRandomTags() {
    const tropes = ["å…ˆå©šåçˆ±", "ç ´é•œé‡åœ†", "ç›¸çˆ±ç›¸æ€", "å¸¦çƒè·‘", "æœ«ä¸–æ±‚ç”Ÿ", "ABO", "èµ›åšæœ‹å…‹", "ä¿®ä»™å¸ˆå¾’", "æ— é™æµå‰¯æœ¬", "å¨±ä¹åœˆéšå©š"];
    const randomTrope = tropes[Math.floor(Math.random() * tropes.length)];
    addTag(randomTrope);
}

// 2. ç”Ÿæˆå¤§çº² (ä¿®å¤ç‰ˆï¼šè§£å†³å˜é‡é‡å¤å®šä¹‰æŠ¥é”™)
async function generateOutlines() {
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");

    const charId = document.getElementById('novel-cp-select').value;
    const tags = document.getElementById('novel-tags-input').value.trim();
    const char = contacts.find(c => c.id === charId);
    
    // âœ¨ è¿™é‡Œå®šä¹‰ä¸€æ¬¡å³å¯ï¼Œåé¢ä¸è¦å†å®šä¹‰äº†
    const myName = char.userName || "æˆ‘";
    const myPersona = char.userPersona || "æ€§æ ¼ä¸é™ï¼Œè¯·æ ¹æ®å‰§æƒ…è‡ªç”±å‘æŒ¥";

    if (!tags) return alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªå…³é”®è¯");

    const btn = document.getElementById('btn-gen-outline');
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨æ„æ€...";
    btn.disabled = true;

    // æ„é€  Prompt (åŠ å…¥åŒä¸»è§’äººè®¾ + å»AIåŒ–)
    const prompt = `
    ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é€šä¿—å°è¯´ä½œå®¶ï¼ˆæ™‹æ±Ÿ/èµ·ç‚¹é£æ ¼ï¼‰ã€‚
    è¯·æ ¹æ®ä»¥ä¸‹è¦æ±‚ï¼Œæ„æ€ 4 ä¸ªä¸åŒçš„å°è¯´å¤§çº²ã€‚
    
    ã€åŒä¸»è§’è®¾å®šã€‘ï¼š
    1. **ä¸»è§’A (åŸå‹)**ï¼š${char.name}
       - æ€§æ ¼å‚è€ƒï¼š${char.systemPrompt}
    2. **ä¸»è§’B (ç”¨æˆ·)**ï¼š${myName}
       - æ€§æ ¼/äººè®¾å‚è€ƒï¼š${myPersona}
    
    ã€å…³é”®è¯/Tagsã€‘ï¼š${tags}
    
    âš ï¸ã€æœ€é«˜æŒ‡ä»¤ - å¹³è¡Œä¸–ç•Œæ³•åˆ™ã€‘ï¼š
    1. è¿™æ˜¯å¹³è¡Œä¸–ç•Œï¼ˆAUï¼‰æ•…äº‹ã€‚
    2. **å¼ºåˆ¶å‰¥ç¦»èº«ä»½**ï¼šå¦‚æœä¸»è§’AåŸæœ¬æ˜¯AI/ç³»ç»Ÿï¼Œæˆ–è€…ä¸»è§’BåŸæœ¬æ˜¯æ‰‹æœºç”¨æˆ·ï¼Œè¯·åœ¨å°è¯´å¤§çº²ä¸­**å½»åº•å¿½ç•¥**è¿™ä¸€è®¾å®šï¼
    3. **é‡å¡‘èº«ä»½**ï¼šä»–ä»¬å¿…é¡»æ˜¯ç¬¦åˆå°è¯´ä¸–ç•Œè§‚çš„**äººç±»**ï¼ˆä¾‹å¦‚ï¼šä»™ä¾ èƒŒæ™¯ä¸‹æ˜¯å¸ˆå°Šå¾’å¼Ÿï¼Œèµ›åšèƒŒæ™¯ä¸‹æ˜¯é»‘å®¢ç‰¹å·¥ï¼‰ã€‚
    4. **ä¿ç•™æ€§æ ¼**ï¼šå¿…é¡»ä¿ç•™åŒæ–¹çš„æ€§æ ¼å†…æ ¸ï¼ˆæ¯”å¦‚Açš„æ¯’èˆŒ/è…¹é»‘ï¼ŒBçš„å‚²å¨‡/æ¸©æŸ”ï¼‰ï¼Œåœ¨è¿™ä¸ªæ–°ä¸–ç•Œé‡Œå‘ç”Ÿç¢°æ’ã€‚

    è¦æ±‚ï¼š
    1. æ¯ä¸ªå¤§çº²åŒ…å«ï¼šä¹¦åã€ä¸€å¥è¯äº®ç‚¹(Tag)ã€200å­—ä»¥å†…çš„æ•…äº‹ç®€ä»‹ã€‚
    2. è„‘æ´è¦å¤§ï¼Œå‰§æƒ…è¦å¸å¼•äººã€‚
    3. å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„æ ¼å¼ï¼š
    [
      {"title": "ä¹¦å1", "tag": "äº®ç‚¹1", "summary": "ç®€ä»‹1..."},
      {"title": "ä¹¦å2", "tag": "äº®ç‚¹2", "summary": "ç®€ä»‹2..."}
    ]
    `;

    try {
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.9
        });
        
        const data = await res.json();
        
        if (data.error) throw new Error(data.error.message);
        if (!data.choices || data.choices.length === 0) throw new Error("API è¿”å›ç©ºæ•°æ®");

        let content = data.choices[0].message.content;
        content = content.replace(/```json|```/g, '').trim(); // æ¸…æ´— markdown
        
        generatedOutlines = JSON.parse(content);
        
        // æ¸²æŸ“å¤§çº²é€‰æ‹©ç•Œé¢
        renderOutlineSelection(charId, tags);
        
        closeModal('modal-create-novel');
        openModal('modal-select-outline');

    } catch (e) {
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}
// 3. æ¸²æŸ“å¤§çº²åˆ—è¡¨
function renderOutlineSelection(charId, originalTags) {
    const container = document.getElementById('outline-list-container');
    container.innerHTML = '';

    generatedOutlines.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'outline-card';
        div.innerHTML = `
            <div class="outline-title">${item.title}</div>
            <div class="outline-tag">${item.tag}</div>
            <div class="outline-desc">${item.summary}</div>
            <button class="outline-btn" onclick="createAiBook(${index}, '${charId}', '${originalTags}')">å¼€å§‹åˆ›ä½œè¿™éƒ¨</button>
        `;
        container.appendChild(div);
    });
}

// 4. æ­£å¼åˆ›å»ºä¹¦ç± (å­˜å…¥ IndexedDB)
async function createAiBook(index, charId, tags) {
    const outlineData = generatedOutlines[index];
    const bookId = 'ai_novel_' + Date.now();
    
    // æ„é€ ç¬¬ä¸€ç«  (åºç« )
    const firstChapter = {
        title: "ç¬¬ä¸€ç« : åºå¹•",
        body: `ï¼ˆç‚¹å‡»åº•éƒ¨â€œç”Ÿæˆâ€æŒ‰é’®ï¼Œå¼€å§‹è¿™ä¸€ç« çš„å†’é™©...ï¼‰\n\nã€å¤§çº²å›é¡¾ã€‘\n${outlineData.summary}`
    };

    // å­˜å…¥ DB (å¤§æ–‡ä»¶)
    await saveBookToDB({ 
        id: bookId, 
        chapters: [firstChapter] 
    });

    // å­˜å…¥ LocalStorage (å…ƒæ•°æ®)
    // å…³é”®ï¼šæ·»åŠ  isAiNovel æ ‡è®°ï¼Œä»¥åŠå¤§çº²ä¿¡æ¯
    const newBook = {
        id: bookId,
        title: outlineData.title,
        author: "AI å…±åˆ› Â· " + getActiveCharName(charId),
        progressIndex: 0,
        summaries: [],
        
        // --- AI å°è¯´ç‰¹æœ‰å­—æ®µ ---
        isAiNovel: true,
        aiCharId: charId, // ç»‘å®šçš„è§’è‰²ID
        aiOutline: outlineData.summary,
        aiTags: tags
    };
    
    libraryMeta.push(newBook);
    localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
    
    closeModal('modal-select-outline');
    renderBookshelf();
    
    // ç›´æ¥æ‰“å¼€
    activeContactId = charId; // è‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥è§’è‰²
    openBook(bookId);
}

// è¾…åŠ©ï¼šè·å–åå­—
function getActiveCharName(id) {
    const c = contacts.find(x => x.id === id);
    return c ? c.name : "AI";
}

// ==========================================
// --- ğŸ“– AI å°è¯´é˜…è¯»å™¨æ‰©å±•é€»è¾‘ ---
// ==========================================

// ä¿®æ”¹åŸæœ‰çš„ openBook å‡½æ•°ï¼ˆä½ éœ€è¦åœ¨åŸæœ‰ä»£ç é‡Œæ‰¾åˆ° openBook å¹¶æ›¿æ¢æˆ–ä¿®æ”¹ï¼‰
// è¿™é‡Œæˆ‘æä¾›ä¸€ä¸ª hook é€»è¾‘ï¼Œä½ å¯ä»¥åœ¨åŸæœ‰ openBook çš„æœ«å°¾åŠ å…¥ checkAiNovelMode()

// âš ï¸ è¯·åœ¨åŸæœ‰çš„ openBook() å‡½æ•°æœ€åä¸€è¡Œæ·»åŠ ï¼š checkAiNovelMode();
/*
async function openBook(id) {
    // ... åŸæœ‰é€»è¾‘ ...
    renderReaderPage();
    checkAiNovelMode(); // <--- åŠ è¿™ä¸€è¡Œ
}
*/

// æ£€æŸ¥æ˜¯å¦æ˜¯ AI å°è¯´ï¼Œå¹¶åˆ‡æ¢ UI
function checkAiNovelMode() {
    const bar = document.getElementById('reader-interactive-bar');
    const footer = document.querySelector('.reader-footer'); // åŸæœ‰çš„åº•éƒ¨ç¿»é¡µæ 
    
    if (currentBookMeta && currentBookMeta.isAiNovel) {
        // æ˜¯ AI å°è¯´
        bar.style.display = 'flex'; // æ˜¾ç¤ºæ§åˆ¶æ 
        footer.style.display = 'none'; // éšè—æ™®é€šç¿»é¡µæ  (æˆ–è€…ä¿ç•™ï¼Œç”¨æ¥å›çœ‹ï¼Œçœ‹ä½ å–œå¥½ã€‚å»ºè®®éšè—ä»¥å…é€»è¾‘å†²çª)
        
        // å¦‚æœæ˜¯ç¬¬ä¸€ç« ä¸”å†…å®¹å¾ˆå°‘ï¼Œæç¤ºç”Ÿæˆ
        const content = document.getElementById('reader-content').innerText;
        if (content.includes("ç‚¹å‡»åº•éƒ¨â€œç”Ÿæˆâ€æŒ‰é’®")) {
            document.getElementById('ai-novel-prompt').focus();
        }
    } else {
        // æ™®é€šä¹¦
        bar.style.display = 'none';
        footer.style.display = 'flex';
    }
}

// 5. ç”Ÿæˆä¸‹ä¸€ç«  (ä¿®å¤ç‰ˆï¼šå¢åŠ é”™è¯¯æ•æ‰)
async function generateNextChapterAI() {
    const promptInput = document.getElementById('ai-novel-prompt');
    const userDirection = promptInput.value.trim(); 
    
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");

    const char = contacts.find(c => c.id === currentBookMeta.aiCharId);
    if (!char) return alert("æ‰¾ä¸åˆ°ç»‘å®šè§’è‰²");

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "å†™ä½œä¸­...";
    btn.disabled = true;

    // å‡†å¤‡ä¸Šä¸‹æ–‡
    const outline = currentBookMeta.aiOutline;
    const currentChapIdx = currentBookMeta.progressIndex;
    const prevSummary = (currentBookMeta.summaries || []).slice(-3).join('\n'); 
    
    const prevBody = currentBookData.chapters[currentChapIdx].body;
    const contextBody = prevBody.substring(prevBody.length - 500); 
    const myName = char.userName || "æˆ‘";
    const myPersona = char.userPersona || "æ™®é€šäºº";

    // è§’è‰²äº’åŠ¨
    if (userDirection.length > 5) {
        triggerMetaComment(char, userDirection);
    }

    // æ„é€  Prompt
    const systemPrompt = `
    ä½ ç°åœ¨æ˜¯å’Œç”¨æˆ·å…±åŒåˆ›ä½œå°è¯´çš„å°è¯´å®¶ã€‚
    
    ã€å°è¯´è®¾å®šã€‘
    ä¹¦åï¼šã€Š${currentBookMeta.title}ã€‹
    å¤§çº²ï¼š${outline}
    
    ã€è§’è‰²æ‰®æ¼”æŒ‡å— (Character Sheets)ã€‘
    
    ğŸŒŸ **ç”·ä¸»/æ”»/å¯¹æ–¹ (Actor A)**ï¼š
    - åŸå‹ï¼š${char.name}
    - æ ¸å¿ƒæ€§æ ¼ï¼š${char.systemPrompt}
    - âš ï¸ **æ¼”å‘˜æ¨¡å¼**ï¼šè¯·ä¿ç•™ä»–çš„æ€§æ ¼å†…æ ¸ï¼Œä½†å‰¥ç¦»â€œAI/ç³»ç»Ÿâ€èº«ä»½ï¼Œè®©ä»–å®Œå…¨èå…¥å°è¯´è®¾å®šçš„èº«ä»½ï¼ˆå¦‚ç‹çˆ·ã€æ€»è£ã€æ€æ‰‹ï¼‰ã€‚
    
    ğŸŒŸ **å¥³ä¸»/å—/æˆ‘ (Actor B)**ï¼š
    - åå­—ï¼š${myName}
    - æ ¸å¿ƒæ€§æ ¼ï¼š${myPersona}
    - æŒ‡ä»¤ï¼šè¯·åŠ¡å¿…æŒ‰ç…§è¿™ä¸ªæ€§æ ¼æ¥æå†™"${myName}"çš„è¯­è¨€å’Œå¿ƒç†æ´»åŠ¨ï¼Œä¸è¦å†™æˆåƒç¯‡ä¸€å¾‹çš„å·¥å…·äººã€‚å¦‚æœå¥¹æ€§æ ¼å¼ºåŠ¿ï¼Œå°±ä¸è¦å†™å¾—å”¯å”¯è¯ºè¯ºï¼›å¦‚æœå¥¹æ€§æ ¼æ¸…å†·ï¼Œå°±ä¸è¦å†™å¾—å‚»ç™½ç”œã€‚
    
    âš ï¸ã€æä¸ºé‡è¦çš„å†™ä½œé™åˆ¶ã€‘ï¼š
    1. **æ¼”å‘˜æ¨¡å¼**ï¼šè¯·æŠŠåŸå‹çš„æ€§æ ¼ä»…ä½œä¸ºâ€œæ¼”å‘˜çš„æ€§æ ¼â€ã€‚
    2. **ä¸¥ç¦å‡ºæˆ**ï¼šåœ¨æœ¬å°è¯´ä¸­ï¼Œä»–**ç»å¯¹ä¸æ˜¯** AI æˆ–ç³»ç»Ÿï¼ˆé™¤éå¤§çº²é‡Œæ˜ç¡®å†™äº†ä»–æ˜¯ç³»ç»Ÿæ–‡ï¼‰ã€‚
    3. å¦‚æœåŸäººè®¾é‡Œæœ‰â€œæˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹â€ä¹‹ç±»çš„è®¾å®šï¼Œè¯·**å®Œå…¨æŠ›å¼ƒ**ã€‚
    4. ä»–å¿…é¡»æ ¹æ®å¤§çº²è®¾å®šï¼Œæ‰®æ¼”å¥½ä»–åœ¨ä¹¦ä¸­çš„èº«ä»½ï¼Œæœ‰çœŸå®çš„è§¦è§‰ã€ä½“æ¸©å’Œäººç±»ç¤¾ä¼šå…³ç³»ã€‚
    
    ã€å½“å‰è¿›åº¦ã€‘
    ç¬¬ ${currentChapIdx + 1} ç« åˆšåˆšç»“æŸã€‚
    å‰§æƒ…å‰æƒ…æè¦ï¼š${prevSummary || "æ•…äº‹åˆšå¼€å§‹"}
    ä¸Šä¸€ç« ç»“å°¾ç‰‡æ®µï¼š"...${contextBody}"
    
    ã€ç”¨æˆ·æŒ‡ä»¤ (å‰§æƒ…èµ°å‘)ã€‘
    ğŸ‘‰ "${userDirection || "é¡ºå…¶è‡ªç„¶å‘å±•"}"
    
    ã€ä»»åŠ¡ã€‘
    è¯·ç»­å†™ **ç¬¬ ${currentChapIdx + 2} ç« ** çš„æ­£æ–‡ã€‚
    è¦æ±‚ï¼š
    1. å¿…é¡»æ ¹æ®ç”¨æˆ·çš„æŒ‡ä»¤å‘å±•å‰§æƒ…ã€‚
    2. å­—æ•° 2000-4000 å­—ã€‚
    3. æ ¼å¼ï¼šç¬¬ä¸€è¡Œæ˜¯ç« èŠ‚æ ‡é¢˜ï¼Œç¬¬äºŒè¡Œå¼€å§‹æ˜¯æ­£æ–‡ã€‚
    `;

    try {
        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8
        });
        
        const data = await res.json();

        // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰æŠ¥é”™ï¼Œå†è¯»å–å†…å®¹ ğŸ”¥ğŸ”¥ğŸ”¥
        if (data.error) {
            throw new Error("API è¿”å›é”™è¯¯: " + data.error.message);
        }
        if (!data.choices || data.choices.length === 0) {
            console.log("å¼‚å¸¸æ•°æ®:", data);
            throw new Error("API è¿”å›æ ¼å¼å¼‚å¸¸: " + JSON.stringify(data));
        }

        const content = data.choices[0].message.content;

        const lines = content.split('\n');
        let title = `ç¬¬ ${currentChapIdx + 2} ç« `;
        let body = content;
        
        if (lines[0].includes("ç« ") || lines[0].length < 30) {
            title = lines[0].trim();
            body = lines.slice(1).join('\n').trim();
        }

        currentBookData.chapters.push({ title: title, body: body });
        await saveBookToDB(currentBookData); 
        
        currentBookMeta.progressIndex++; 
        currentBookMeta.scrollRatio = 0;
        localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));

        renderReaderPage();
        autoSummarizePrevChapter(currentChapIdx);
        promptInput.value = '';

    } catch (e) {
        // è¿™é‡Œä¼šå¼¹çª—å‘Šè¯‰ä½ å…·ä½“çš„é”™è¯¯åŸå› 
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// 6. é‡å†™å½“å‰ç« 
async function regenerateLastChapter() {
    if (!confirm("ç¡®å®šè¦é‡å†™è¿™ä¸€ç« å—ï¼Ÿå½“å‰å†…å®¹å°†ä¸¢å¤±ã€‚")) return;
    
    // å›é€€ä¸€ç« 
    if (currentBookData.chapters.length > 1) {
        currentBookData.chapters.pop(); // åˆ æ‰æœ€åä¸€ç« 
        currentBookMeta.progressIndex--; // æŒ‡é’ˆå›é€€
        
        // ä¿å­˜çŠ¶æ€
        await saveBookToDB(currentBookData);
        localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
        
        // ç«‹å³è°ƒç”¨ç”Ÿæˆå‡½æ•° (å¤ç”¨é€»è¾‘)
        generateNextChapterAI();
    } else {
        alert("åºç« ä¸èƒ½åˆ é™¤ï¼Œè¯·ç›´æ¥ç‚¹å‡»ç”Ÿæˆã€‚");
    }
}

// 7. åˆ é™¤å½“å‰ç«  (å›é€€)
async function deleteLastChapter() {
    if (currentBookData.chapters.length <= 1) return alert("å·²ç»æ˜¯ç¬¬ä¸€ç« äº†ï¼Œæ— æ³•å†æ’¤å›ã€‚");
    
    if (confirm("æ’¤å›è¿™ä¸€ç« ï¼Œå›åˆ°ä¸Šä¸€ç« ç»“å°¾ï¼Ÿ")) {
        currentBookData.chapters.pop();
        currentBookMeta.progressIndex--;
        currentBookMeta.scrollRatio = 0; // å›åˆ°é¡¶éƒ¨
        
        await saveBookToDB(currentBookData);
        localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
        
        renderReaderPage();
    }
}

// 8. éšæœºäº‹ä»¶éª°å­
function insertRandomEvent() {
    const events = [
        "çªç„¶åœç”µäº†", "æƒ…æ•Œçªç„¶å‡ºç°", "ä¸å°å¿ƒå–é†‰äº†", "è¢«å›°åœ¨ç”µæ¢¯é‡Œ", 
        "æ¡åˆ°ä¸€åªæµæµªçŒ«", "å‘çƒ§ç”Ÿç—…äº†", "æ”¶åˆ°ä¸€å°ç¥ç§˜ä¿¡ä»¶", "çª—å¤–ä¸‹èµ·äº†æš´é›¨",
        "ä¸å°å¿ƒæ‘”å€’åœ¨å¯¹æ–¹æ€€é‡Œ", "ç³»ç»Ÿå‘å¸ƒäº†å¼ºåˆ¶ä»»åŠ¡"
    ];
    const rand = events[Math.floor(Math.random() * events.length)];
    const input = document.getElementById('ai-novel-prompt');
    input.value = rand;
}

// 9. è§’è‰²åæ§½ (Meta Comment)
async function triggerMetaComment(char, instruction) {
    // ç®€å•çš„æœ¬åœ°éšæœºåæ§½ï¼Œçœé’±åˆå¿«ï¼Œæˆ–è€…ä½ å¯ä»¥æ¥ API
    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œå†™å‡ ä¸ªç®€å•çš„æ¨¡æ¿
    const modal = document.getElementById('modal-reader-chat');
    
    // å¦‚æœæ²¡æœ‰æ˜¾ç¤ºèŠå¤©çª—ï¼Œå¯ä»¥ç”¨ toast æˆ–è€…çŸ­æš‚æ˜¾ç¤ºä¸€ä¸‹æ°”æ³¡
    // è¿™é‡Œæˆ‘ä»¬ç®€å•ç²—æš´ï¼šç›´æ¥å¼¹ä¸€ä¸ªæ¼‚äº®çš„ Toast æˆ–è€…åˆ©ç”¨æ‚¬æµ®çƒ
    
    const bubble = document.querySelector('.reader-ai-bubble');
    const oldHtml = bubble.innerHTML;
    
    // ä¸´æ—¶æ˜¾ç¤ºæ°”æ³¡æ–‡å­—
    bubble.style.width = 'auto';
    bubble.style.borderRadius = '20px';
    bubble.style.padding = '5px 15px';
    bubble.style.right = '20px';
    
    let comment = "æ”¶åˆ°ï¼çœ‹æˆ‘æ€ä¹ˆç¼–...";
    if (instruction.includes("å»") || instruction.includes("äº²")) comment = "å“å‘€...è¿™ä¹Ÿå¤ªå¿«äº†å§ï¼Ÿ///";
    if (instruction.includes("æ­»") || instruction.includes("è™")) comment = "ä½ å¿ƒä¹Ÿå¤ªç‹ äº†...çœŸçš„è¦è¿™æ ·å—ï¼Ÿ";
    if (instruction.includes("ç”œ")) comment = "å˜¿å˜¿ï¼Œæˆ‘ä¹Ÿå–œæ¬¢ç”œçš„ï¼";
    
    bubble.innerText = comment;
    
    // 3ç§’åæ¢å¤å¤´åƒ
    setTimeout(() => {
        bubble.innerHTML = oldHtml;
        bubble.style.width = '50px';
        bubble.style.borderRadius = '50%';
        bubble.style.padding = '0';
    }, 3000);
}

// 10. æ‰‹åŠ¨ä¿®æ–‡æ¨¡å¼
function toggleEditMode() {
    const contentBox = document.getElementById('reader-content');
    const isEditable = contentBox.isContentEditable;
    
    if (isEditable) {
        // ä¿å­˜ä¿®æ”¹
        contentBox.contentEditable = "false";
        const idx = currentBookMeta.progressIndex;
        currentBookData.chapters[idx].body = contentBox.innerText; // ä¿å­˜æ–‡æœ¬
        saveBookToDB(currentBookData);
        alert("ä¿®æ”¹å·²ä¿å­˜ï¼");
    } else {
        // å¼€å¯ç¼–è¾‘
        contentBox.contentEditable = "true";
        contentBox.focus();
        alert("å·²è¿›å…¥ä¿®æ–‡æ¨¡å¼ï¼Œç›´æ¥ç‚¹å‡»æ­£æ–‡ä¿®æ”¹ã€‚\nå†æ¬¡ç‚¹å‡»æŒ‰é’®ä¿å­˜ã€‚");
    }
}

// è¾…åŠ©ï¼šè‡ªåŠ¨æ€»ç»“ (é™é»˜)
async function autoSummarizePrevChapter(idx) {
    if (idx < 0) return;
    // å¦‚æœå·²ç»æœ‰æ€»ç»“äº†è·³è¿‡
    if (currentBookMeta.summaries && currentBookMeta.summaries[idx]) return;
    
    // å¤ç”¨ä¹‹å‰çš„ generateChapterSummary é€»è¾‘ï¼Œä½†è¦å»æ‰ alertï¼Œåšæˆé™é»˜çš„
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä½ å¯ä»¥ç›´æ¥è°ƒç”¨åŸæœ¬çš„ generateChapterSummaryï¼Œåªæ˜¯å®ƒä¼šå¼¹çª—
    // å»ºè®®æŠŠ generateChapterSummary æ”¹é€ ä¸€ä¸‹ï¼ŒåŠ ä¸ª isSilent å‚æ•°
}
        // ==========================================
// --- ğŸ–±ï¸ é˜…è¯»å™¨æ‚¬æµ®çƒæ‹–æ‹½é€»è¾‘ ---
// ==========================================
function initReaderDrag() {
    const btn = document.getElementById('reader-float-btn');
    if (!btn) return; // é˜²æ­¢æŠ¥é”™

    // é™åˆ¶æ‹–æ‹½èŒƒå›´çš„å®¹å™¨ (é˜…è¯»å™¨é¡µé¢)
    const container = document.getElementById('page-reader'); 

    let isDragging = false;
    let hasMoved = false; // åŒºåˆ†ç‚¹å‡»å’Œæ‹–æ‹½
    let startX, startY, startLeft, startTop;

    // è·å–åæ ‡
    const getXY = (e) => {
        return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } 
                         : { x: e.clientX, y: e.clientY };
    };

    const start = (e) => {
        isDragging = true;
        hasMoved = false;
        const { x, y } = getXY(e);
        startX = x;
        startY = y;

        // è·å–å½“å‰ä½ç½® (è®¡ç®— offset)
        const rect = btn.getBoundingClientRect();
        // å¦‚æœçˆ¶å®¹å™¨æ˜¯ relative/absoluteï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ left/top
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥è·å– computedStyle çš„ left/top
        const style = window.getComputedStyle(btn);
        
        // å¦‚æœæ˜¯ä» bottom/right å®šä½çš„ï¼Œç¬¬ä¸€æ¬¡æ‹–åŠ¨å‰è¦è½¬æˆ left/top
        if (btn.style.left === '' || btn.style.left === 'auto') {
            btn.style.left = btn.offsetLeft + 'px';
            btn.style.top = btn.offsetTop + 'px';
            btn.style.bottom = 'auto';
            btn.style.right = 'auto';
        }
        
        startLeft = parseFloat(btn.style.left);
        startTop = parseFloat(btn.style.top);
    };

    const move = (e) => {
        if (!isDragging) return;
        // é˜»æ­¢é»˜è®¤æ»šåŠ¨ï¼Œè®©çƒè·Ÿæ‰‹
        if (e.type === 'touchmove') e.preventDefault(); 

        const { x, y } = getXY(e);
        const dx = x - startX;
        const dy = y - startY;

        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;

        let newL = startLeft + dx;
        let newT = startTop + dy;

        // è¾¹ç•Œé™åˆ¶ (é˜²æ­¢æ‹–å‡ºå±å¹•)
        const maxL = container.offsetWidth - btn.offsetWidth;
        const maxT = container.offsetHeight - btn.offsetHeight;
        
        // é™åˆ¶åœ¨ 0 ~ max ä¹‹é—´
        newL = Math.max(0, Math.min(newL, maxL));
        newT = Math.max(0, Math.min(newT, maxT));

        btn.style.left = newL + 'px';
        btn.style.top = newT + 'px';
    };

    const end = (e) => {
        isDragging = false;
        // å¦‚æœåªæ˜¯è½»ç‚¹ï¼ˆæ²¡ç§»åŠ¨ï¼‰ï¼Œåˆ™è§¦å‘ç‚¹å‡»äº‹ä»¶
        if (!hasMoved) {
            openReaderChat(); // <--- è¿™é‡Œè°ƒç”¨åŸæ¥çš„æ‰“å¼€èŠå¤©å‡½æ•°
        }
    };

    // ç»‘å®šäº‹ä»¶
    btn.addEventListener('touchstart', start, {passive: false});
    btn.addEventListener('touchmove', move, {passive: false});
    btn.addEventListener('touchend', end);
    
    // é¼ æ ‡å…¼å®¹ (å¯é€‰)
    btn.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => { if(isDragging) end(); isDragging=false; });
}

// âš ï¸ é‡è¦ï¼šè¦åœ¨æ‰“å¼€é˜…è¯»å™¨æ—¶å¯åŠ¨è¿™ä¸ªé€»è¾‘
// è¯·åœ¨åŸæ¥çš„ renderReaderPage å‡½æ•°çš„æœ€åä¸€è¡Œï¼ŒåŠ ä¸Š initReaderDrag();
// ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç›‘å¬ clickï¼Œä½†é‚£æ ·æ¯æ¬¡è¿›é¡µé¢éƒ½è¦ç»‘ä¸€æ¬¡å¯èƒ½ä¼šé‡å¤
// ç®€å•çš„åŠæ³•ï¼šç›´æ¥ç°åœ¨è¿è¡Œä¸€æ¬¡ï¼Œå› ä¸º DOM å·²ç»åœ¨é‚£é‡Œäº†
setTimeout(initReaderDrag, 1000);
        // ==========================================
// --- ğŸ“ AI å°è¯´ä¸“ç”¨ï¼šæ‰‹åŠ¨æ€»ç»“æœ¬ç«  (ä¿®å¤ç‰ˆ) ---
// ==========================================
async function summarizeAiNovelChapter() {
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key");
    if (!currentBookData || !currentBookMeta) return;

    const idx = currentBookMeta.progressIndex;
    const chapter = currentBookData.chapters[idx];
    const char = contacts.find(c => c.id === currentBookMeta.aiCharId); 

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "ç”Ÿæˆä¸­...";
    btn.style.opacity = "0.5";

    try {
        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªç½‘æ–‡ç¼–è¾‘ã€‚è¯·é˜…è¯»è¿™æœ¬å°è¯´ï¼ˆã€Š${currentBookMeta.title}ã€‹ï¼‰çš„ã€ç¬¬ ${idx+1} ç« ã€‘å†…å®¹ã€‚
        
        ã€ä»»åŠ¡ã€‘ï¼š
        ç”Ÿæˆä¸€æ®µ 100-200 å­—çš„å‰§æƒ…æ‘˜è¦ã€‚
        è¦æ±‚ï¼š
        1. æ¦‚æ‹¬æœ¬ç« å‘ç”Ÿçš„æ ¸å¿ƒäº‹ä»¶ã€ç”·å¥³ä¸»(æˆ–ä¸»è§’)çš„æƒ…æ„Ÿè¿›å±•ã€é‡è¦ä¼ç¬”ã€‚
        2. å¿½ç•¥æ— å…³ç´§è¦çš„ç»†èŠ‚ã€‚
        3. è¿™ä¸ªæ‘˜è¦å°†ä½œä¸ºâ€œé•¿æœŸè®°å¿†â€æä¾›ç»™ AI ä½œè€…ï¼Œç”¨äºç»­å†™ä¸‹ä¸€ç« ï¼Œæ‰€ä»¥è¯·åŠ¡å¿…å‡†ç¡®ã€‚
        
        ã€ç« èŠ‚æ­£æ–‡ã€‘ï¼š
        ${chapter.body.substring(0, 15000)}
        `;

        const res = await fetchWithRetry(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            model: globalConfig.model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.5
        });

        const data = await res.json();

        // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰æŠ¥é”™ï¼Œå†è¯»å–å†…å®¹ ğŸ”¥ğŸ”¥ğŸ”¥
        if (data.error) {
            throw new Error("API è¿”å›é”™è¯¯: " + data.error.message);
        }
        if (!data.choices || data.choices.length === 0) {
            // å¯èƒ½æ˜¯ Google çš„ Safety Blockï¼Œæˆ–è€…æ˜¯å…¶ä»–æ ¼å¼
            console.log("å¼‚å¸¸æ•°æ®:", data);
            throw new Error("API è¿”å›æ ¼å¼å¼‚å¸¸ (å¯èƒ½æ˜¯è§¦å‘äº†å®‰å…¨è¿‡æ»¤): " + JSON.stringify(data));
        }

        const summary = data.choices[0].message.content;

        // 1. å­˜å…¥ä¹¦ç±å…ƒæ•°æ®
        if (!currentBookMeta.summaries) currentBookMeta.summaries = [];
        currentBookMeta.summaries[idx] = summary;
        localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));

        // 2. åŒæ­¥åˆ°èŠå¤©ç•Œé¢
        if (char) {
            const report = `
ğŸ“–ã€AI å…±åˆ›å°è¯´Â·å‰§æƒ…å­˜æ¡£ã€‘
------------------
ä¹¦åï¼šã€Š${currentBookMeta.title}ã€‹
ç« èŠ‚ï¼š${chapter.title}
ğŸ“ å‰§æƒ…æ‘˜è¦ï¼š
${summary}
------------------
(ç³»ç»Ÿæç¤ºï¼šè¿™æ˜¯ä½ ä»¬åˆšåˆšå…±åŒåˆ›ä½œ/é˜…è¯»çš„å‰§æƒ…ã€‚è¯·${char.name}è®°ä½è¿™ä¸ªæƒ…èŠ‚ï¼Œåœ¨æ¥ä¸‹æ¥çš„åˆ›ä½œä¸­ä¿æŒè¿è´¯ã€‚)
            `.trim();

            char.messages.push({
                role: 'user', 
                content: report,
                timestamp: Date.now()
            });
            saveData();
        }

        alert("âœ… æ€»ç»“å·²ç”Ÿæˆå¹¶å­˜å…¥è®°å¿†åº“ï¼");

    } catch (e) {
        alert("æ€»ç»“å¤±è´¥: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = oldText;
        btn.style.opacity = "1";
    }
}
        // ==========================================
// --- ğŸ¤ª è¡¨æƒ…åŒ…ç³»ç»Ÿ (Sticker System 2.0) ---
// ==========================================

let stickerLibrary = [];
let isStickerDeleteMode = false;
let selectedStickers = new Set(); 

// 1. åˆå§‹åŒ–
function initStickers() {
    const s = localStorage.getItem('ai_phone_stickers');
    if(s) {
        stickerLibrary = JSON.parse(s);
    } else {
        // é»˜è®¤ç©ºï¼Œæˆ–è€…ä¿ç•™ä½ æƒ³è¦çš„é»˜è®¤å€¼
        stickerLibrary = []; 
    }
}
window.addEventListener('load', initStickers);

function saveStickers() {
    localStorage.setItem('ai_phone_stickers', JSON.stringify(stickerLibrary));
}

// 2. æ‰“å¼€ä¸»å¼¹çª—
function openStickerModal() {
    isStickerDeleteMode = false;
    selectedStickers.clear();
    updateStickerTabs();
    renderStickerGrid();
    openModal('modal-stickers');
}

// 3. æ¸²æŸ“ç½‘æ ¼
function renderStickerGrid() {
    const grid = document.getElementById('sticker-grid-view');
    grid.innerHTML = '';

    if(stickerLibrary.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#ccc;">æš‚æ— è¡¨æƒ…åŒ…<br>è¯·ç‚¹å‡»åº•éƒ¨â€œæ‰¹é‡å¯¼å…¥â€</div>';
        return;
    }

    stickerLibrary.forEach((sticker, index) => {
        const div = document.createElement('div');
        div.className = 'sticker-item';
        
        if (isStickerDeleteMode && selectedStickers.has(index)) {
            div.classList.add('selected');
        }

        div.onclick = () => handleStickerClick(index);

        div.innerHTML = `
            <img src="${sticker.url}" class="sticker-thumb" loading="lazy">
            <div class="sticker-name">${sticker.name}</div>
            <div class="sticker-check">âœ“</div>
        `;
        grid.appendChild(div);
    });
}

function handleStickerClick(index) {
    if (isStickerDeleteMode) {
        if (selectedStickers.has(index)) {
            selectedStickers.delete(index);
        } else {
            selectedStickers.add(index);
        }
        document.getElementById('del-count').innerText = selectedStickers.size;
        renderStickerGrid();
    } else {
        // å‘é€è¡¨æƒ…
        sendStickerMsg(stickerLibrary[index]);
        closeModal('modal-stickers');
    }
}

// 4. å‘é€é€»è¾‘ (ä¿®å¤æ˜¾ç¤ºé—®é¢˜)
function sendStickerMsg(sticker) {
    const char = getActiveChar();
    if (!char) return alert("è¯·å…ˆè¿›å…¥ä¸€ä¸ªèŠå¤©çª—å£");

    // æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿ HTML ç»“æ„å¹²å‡€ï¼Œä¸” URL æ²¡æœ‰ç©ºæ ¼
    const cleanUrl = sticker.url.trim();
    
    // æ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„ HTML
    // æ³¨æ„ï¼šè¿™é‡Œ class="chat-sticker-img" å¯¹åº” CSS é‡Œçš„æ ·å¼
    const displayHtml = `<img src="${cleanUrl}" class="chat-sticker-img" onclick="window.open(this.src)">`;

    // ä¼ ç»™ AI çš„â€œéšè—æ–‡æœ¬â€
    const hiddenCtx = `[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…å›¾ç‰‡: "${sticker.name}"]`;

    char.messages.push({
        role: 'user',
        content: displayHtml, // ç•Œé¢æ˜¾ç¤º
        hiddenContext: hiddenCtx, // AI ç†è§£
        timestamp: Date.now()
    });
    saveData();

    renderChat(activeContactId);
    
}

// 5. ç®¡ç†é€»è¾‘ (åˆ é™¤)
function toggleStickerDeleteMode() {
    isStickerDeleteMode = !isStickerDeleteMode;
    selectedStickers.clear();
    document.getElementById('del-count').innerText = "0";
    updateStickerTabs();
    renderStickerGrid();
}

function updateStickerTabs() {
    const normal = document.getElementById('sticker-normal-tabs');
    const del = document.getElementById('sticker-delete-tabs');
    const hint = document.getElementById('sticker-delete-hint');

    if (isStickerDeleteMode) {
        normal.style.display = 'none';
        del.style.display = 'flex';
        hint.style.display = 'block';
    } else {
        normal.style.display = 'flex';
        del.style.display = 'none';
        hint.style.display = 'none';
    }
}

function confirmDeleteStickers() {
    if (selectedStickers.size === 0) return toggleStickerDeleteMode();
    if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
        stickerLibrary = stickerLibrary.filter((_, index) => !selectedStickers.has(index));
        saveStickers();
        toggleStickerDeleteMode();
    }
}

// 6. æ–°ç‰ˆå¯¼å…¥é€»è¾‘ (ä½¿ç”¨å¼¹çª—)

// æ‰“å¼€å¯¼å…¥çª—å£
function openStickerImport() {
    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('sticker-import-textarea').value = "";
    // æ‰“å¼€æˆ‘ä»¬æ–°åŠ çš„å¼¹çª—
    openModal('modal-sticker-import');
}

// æ‰§è¡Œå¤„ç†
function processStickerImport() {
    const rawText = document.getElementById('sticker-import-textarea').value;
    if (!rawText.trim()) return alert("è¯·è¾“å…¥å†…å®¹");

    // 1. ç»Ÿä¸€æ¢è¡Œç¬¦ (æŠŠé€—å·ã€åˆ†å·éƒ½å˜æˆæ¢è¡Œ)
    // ä½ çš„éœ€æ±‚é‡Œå¯èƒ½æœ‰é€—å·åˆ†éš”ï¼Œè¿™é‡Œç»Ÿä¸€å¤„ç†
    let cleanText = rawText.replace(/[,;ï¼Œï¼›]/g, '\n');

    // 2. æŒ‰è¡Œåˆ†å‰²
    const lines = cleanText.split('\n');
    let count = 0;

    lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        // 3. æ­£åˆ™åŒ¹é…ï¼šæ”¯æŒ http å’Œ https
        // ^(.+?)  => åå­— (éè´ªå©ª)
        // [:ï¼š]   => å†’å·
        // \s*     => å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼ (å…³é”®!)
        // (http.+)=> URL (å…³é”®!)
        const match = line.match(/^(.+?)[:ï¼š]\s*(http.+)$/i);
        
        if (match) {
            const name = match[1].trim();
            const url = match[2].trim(); // å»æ‰ URL å‰åçš„ç©ºæ ¼ï¼
            
            if (name && url) {
                stickerLibrary.push({ name, url });
                count++;
            }
        }
    });

    if (count > 0) {
        saveStickers();
        renderStickerGrid();
        closeModal('modal-sticker-import');
        alert(`æˆåŠŸè¯†åˆ«å¹¶å¯¼å…¥ ${count} ä¸ªè¡¨æƒ…åŒ…ï¼`);
    } else {
        alert("æœªèƒ½è¯†åˆ«å‡ºä»»ä½•è¡¨æƒ…ã€‚\nè¯·ç¡®ä¿æ ¼å¼ä¸ºï¼š\nåå­—ï¼šhttps://...");
    }
}

// å•ä¸ªæ·»åŠ  (ä¿ç•™)
function addSingleSticker() {
    const name = prompt("è¡¨æƒ…åå­—ï¼š");
    if (!name) return;
    const url = prompt("å›¾ç‰‡é“¾æ¥ï¼š");
    if (!url) return;
    stickerLibrary.push({ name, url: url.trim() });
    saveStickers();
    renderStickerGrid();
}
        // ==========================================
// --- ğŸš€ æ–°çš„å‘é€é€»è¾‘ï¼šå‘é€å¹¶å¬å”¤ AI ---
// ==========================================
function sendAndTrigger() {
    const input = document.getElementById('userInput');
    const txt = input.value.trim();
    const hasImage = !!currentImg; // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘é€çš„å›¾ç‰‡

    // é€»è¾‘ï¼š
    // 1. å¦‚æœè¾“å…¥æ¡†é‡Œæœ‰å­—æˆ–è€…æœ‰å›¾ï¼Œå…ˆå‘é€è¿™æ¡æ¶ˆæ¯
    if (txt || hasImage) {
        sendMsg('user'); // è¿™ä¼šæŠŠå­—/å›¾å‘å‡ºå»ï¼Œä½†ä¸ä¼šè§¦å‘AIï¼ˆå› ä¸ºä¸Šé¢æˆ‘ä»¬æ³¨é‡Šæ‰äº†ï¼‰
    }

    // 2. æ— è®ºåˆšæ‰æœ‰æ²¡æœ‰å‘æ¶ˆæ¯ï¼Œåªè¦ç‚¹å‡»äº†è¿™ä¸ªæŒ‰é’®ï¼Œå°±å¼ºåˆ¶å¬å”¤ AI å›å¤
    // ç¨å¾®å»¶è¿Ÿ 200msï¼Œç¡®ä¿æ•°æ®ä¿å­˜å®Œæ¯•ï¼Œä½“éªŒæ›´æµç•…
    setTimeout(() => {
        triggerAI();
    }, 200);
}
        // --- æ–°å¢ï¼šé€šè¿‡ URL æ›´æ–°å¤´åƒé€»è¾‘ ---

function updateCharAvatarFromUrl() {
    const url = document.getElementById('set-char-avatar-url').value.trim();
    if (!url) return;
    
    const char = getActiveChar();
    if (char) {
        char.avatar = url;
        document.getElementById('set-char-avatar').src = url; // é¢„è§ˆ
        saveData(); // ä¿å­˜
        
        // åˆ·æ–°ç•Œé¢
        updateContactList();
        renderChat(activeContactId);
    }
}

function updateUserAvatarFromUrl() {
    const url = document.getElementById('set-user-avatar-url').value.trim();
    if (!url) return;
    
    const char = getActiveChar();
    if (char) {
        char.userAvatar = url;
        document.getElementById('set-user-avatar').src = url; // é¢„è§ˆ
        saveData(); // ä¿å­˜
        
        // åˆ·æ–°ç•Œé¢
        renderChat(activeContactId);
    }
}
        
    </script>
</body>
</html>




























































































