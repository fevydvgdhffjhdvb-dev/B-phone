<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å°æ‰‹æœº V7.5 (å…¨èƒ½ç»ˆæç‰ˆ)</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; }
        body { background-color: #e0e5ec; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #fff; border-radius: 35px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); 
            border: 10px solid #2c3e50; 
            display: flex; flex-direction: column; 
            position: relative; overflow: hidden; 
        }

        /* --- é¡¶éƒ¨æ  --- */
        .header { 
            padding: 15px 20px; background-color: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .header-title { font-weight: 700; color: #333; font-size: 16px; }
        .header-icons { display: flex; gap: 8px; }
        .btn-icon { background: none; border: none; font-size: 18px; cursor: pointer; padding: 6px; transition: 0.2s; border-radius: 50%; }
        .btn-icon:hover { background-color: #e1e1e1; }

        /* --- èŠå¤©åŒºåŸŸ --- */
        .chat-box { 
            flex: 1; padding: 15px; overflow-y: auto; 
            background-color: #ffffff; display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; animation: fadeIn 0.3s ease; }
        .msg-row.right { flex-direction: row-reverse; }
        
        .avatar { 
            width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #ddd; border: 1px solid #fff;
        }

        .message { 
            max-width: 75%; padding: 12px 15px; border-radius: 18px; 
            font-size: 14px; line-height: 1.5; word-wrap: break-word; 
            position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-row.right .message { background-color: #007AFF; color: white; border-bottom-right-radius: 4px; }
        .msg-row.left .message { background-color: #F2F2F7; color: #000; border-bottom-left-radius: 4px; }
        
        .msg-index { font-size: 9px; opacity: 0.5; position: absolute; top: -15px; color: #999; width: 100%; display: none;}
        .msg-row:hover .msg-index { display: block; } /* é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ¥¼å±‚å· */
        
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .system-notice { text-align: center; font-size: 12px; color: #aaa; margin: 10px 0; width: 100%; }

        /* --- åº•éƒ¨è¾“å…¥æ  --- */
        .input-area { 
            padding: 10px 15px; background-color: #f8f9fa; border-top: 1px solid #eee; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .input-toolbar { display: flex; align-items: center; gap: 8px; width: 100%; }
        
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; justify-content: space-between; font-size: 12px; color: #666;}
        #previewImg { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }

        #userInput { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 14px; transition: border 0.2s;}
        #userInput:focus { border-color: #007AFF; }
        
        .btn-send { background-color: #007AFF; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px; flex-shrink: 0;}
        .btn-send:disabled { background-color: #ccc; }
        .btn-attach { background: none; border: none; font-size: 22px; color: #555; cursor: pointer; padding: 0 5px; }

        /* --- é¢æ¿é€šç”¨æ ·å¼ --- */
        .panel-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.98); backdrop-filter: blur(5px);
            z-index: 100; padding: 20px; display: none; flex-direction: column; overflow-y: auto;
        }
        .panel-overlay.show { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-size: 20px; font-weight: bold; margin: 0; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; outline: none; }
        .form-textarea { height: 80px; resize: none; }
        
        .btn { padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; text-align: center; transition: 0.2s; width: 100%; margin-top: 5px;}
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-primary { background-color: #007AFF; color: white; }
        .btn-secondary { background-color: #e9ecef; color: #333; border: 1px solid #ddd; }
        .btn-danger { background-color: #FF3B30; color: white; }
        .btn-fetch { background-color: #5856D6; color: white; } 

        /* å¤´åƒä¸Šä¼ æ ·å¼ */
        .avatar-uploader { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .current-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #eee; object-fit: cover; }
        .upload-btn-label { background: #f0f0f0; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #ccc; }
        
        /* è®°å¿†åˆ—è¡¨ */
        .memory-item { background: #f0f4f8; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: flex-start; font-size: 13px;}
        .mem-del { color: #ff3b30; cursor: pointer; margin-left: 10px; font-weight: bold; }

        /* --- æ€»ç»“å¼¹çª— (æ¨¡æ€æ¡†) --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; display:none;}
        .modal-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .hint-text { font-size: 11px; color: #888; margin-top: 3px; }
    </style>
</head>
<body>

    <div class="phone-frame">
        <!-- é¡¶éƒ¨ -->
        <div class="header">
            <span class="header-title">AI Phone V7.5</span>
            <div class="header-icons">
                <button class="btn-icon" onclick="openSummaryModal()" title="è‡ªåŠ¨æ€»ç»“">ğŸª„</button>
                <button class="btn-icon" onclick="togglePanel('memoryPanel')" title="è®°å¿†åº“">ğŸ§ </button>
                <button class="btn-icon" onclick="togglePanel('settingsPanel')" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </div>

        <!-- èŠå¤©å†…å®¹ -->
        <div class="chat-box" id="chatBox">
            <div class="system-notice">âœ¨ ç³»ç»Ÿå°±ç»ªï¼šæ”¯æŒè§†è§‰ã€è®°å¿†ã€æµå¼è¾“å‡º</div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥ -->
        <div class="input-area">
            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <div id="uploadPreview">
                <div style="display:flex; align-items:center; gap:8px;">
                    <img id="previewImg" src="">
                    <span>å·²æ·»åŠ å›¾ç‰‡ (å°†éšæ¶ˆæ¯å‘é€)</span>
                </div>
                <span style="cursor:pointer; color:red; font-size:16px;" onclick="clearUpload()">Ã—</span>
            </div>

            <div class="input-toolbar">
                <button class="btn-attach" onclick="document.getElementById('chatFileInput').click()" title="ä¸Šä¼ å›¾ç‰‡">ğŸ“</button>
                <input type="file" id="chatFileInput" accept="image/*" style="display:none" onchange="handleChatImageSelect(event)">
                
                <input type="text" id="userInput" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="handleEnter(event)">
                <button class="btn-send" id="sendBtn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>

        <!-- ================= 1. è®¾ç½®é¢æ¿ ================= -->
        <div class="panel-overlay" id="settingsPanel">
            <div class="panel-header">
                <h2 class="panel-title">è®¾ç½®ä¸­å¿ƒ</h2>
                <button class="btn-close" onclick="togglePanel('settingsPanel')">Ã—</button>
            </div>
            
            <!-- API é…ç½® -->
            <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #eee;">
                <div class="form-group">
                    <label class="form-label">API Base URL</label>
                    <input type="text" id="apiUrl" class="form-input" value="https://api.openai.com/v1" onchange="saveSettings()">
                    <div class="hint-text">âš ï¸ å¿…é¡»åŒ…å«ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ <b>/v1</b></div>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="sk-xxxxxxxx" onchange="saveSettings()">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="testConnection()">ğŸ“¶ æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-fetch" onclick="fetchModels()">ğŸ“¡ æ‹‰å–æ¨¡å‹</button>
                </div>
            </div>

            <!-- èº«ä»½è®¾ç½® -->
            <div class="form-group">
                <label class="form-label" style="color:#007AFF">ğŸ¤– AI å¤´åƒä¸è®¾å®š</label>
                <div class="avatar-uploader">
                    <img id="aiAvatarPreview" src="https://api.dicebear.com/7.x/bottts/svg?seed=AI" class="current-avatar">
                    <label class="upload-btn-label">ä¸Šä¼  AI å¤´åƒ <input type="file" style="display:none" accept="image/*" onchange="handleAvatarUpload(event, 'ai')"></label>
                </div>
                <textarea id="systemPrompt" class="form-textarea" onchange="saveSettings()" placeholder="è¾“å…¥ System Prompt...">ä½ æ˜¯ä¸€ä¸ªå¹½é»˜çš„AIåŠ©æ‰‹ã€‚</textarea>
            </div>

            <div class="form-group">
                <label class="form-label" style="color:#34C759">ğŸ‘¤ ç”¨æˆ·å¤´åƒä¸ç§°å‘¼</label>
                <div class="avatar-uploader">
                    <img id="userAvatarPreview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="current-avatar">
                    <label class="upload-btn-label">ä¸Šä¼ ä½ çš„å¤´åƒ <input type="file" style="display:none" accept="image/*" onchange="handleAvatarUpload(event, 'user')"></label>
                </div>
                <input type="text" id="userName" class="form-input" placeholder="æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ" onchange="saveSettings()">
            </div>

            <!-- å‚æ•°å¾®è°ƒ -->
            <div style="border-top:1px solid #eee; padding-top:15px;">
                <div class="form-group">
                    <label class="form-label">ğŸŒ¡ï¸ æ¸©åº¦ (Temperature): <span id="tempVal" style="color:#007AFF">0.7</span></label>
                    <input type="range" id="tempRange" min="0" max="2" step="0.1" value="0.7" style="width:100%" oninput="document.getElementById('tempVal').innerText=this.value; saveSettings()">
                    <div class="hint-text">0.2 ç†æ€§ä¸¥è°¨ -> 1.0 åˆ›æ„å‘æ•£</div>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ§  æœ€å¤§è®°å¿†è½®æ•°: <span id="contextVal" style="color:#007AFF">10</span></label>
                    <input type="range" id="contextRange" min="2" max="50" step="2" value="10" style="width:100%" oninput="document.getElementById('contextVal').innerText=this.value; saveSettings()">
                    <div class="hint-text">ä»…æºå¸¦æœ€è¿‘ X æ¡æ¶ˆæ¯ï¼ŒèŠ‚çœ Token</div>
                </div>

                <div class="form-group">
                    <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                    <select id="modelSelect" class="form-input" onchange="document.getElementById('customModel').value=this.value; saveSettings();">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4o">gpt-4o (è§†è§‰æ¨è)</option>
                    </select>
                    <input type="text" id="customModel" class="form-input" style="display:none; margin-top:5px;" placeholder="è¾“å…¥æ¨¡å‹ID">
                    <div style="text-align:right; font-size:11px; color:#007AFF; margin-top:2px; cursor:pointer" onclick="toggleCustomModel()">åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥</div>
                </div>
            </div>

            <!-- å¤‡ä»½ä¸é‡ç½® -->
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            </div>
            <button class="btn btn-danger" onclick="clearChat()" style="margin-top:10px;">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰å¯¹è¯</button>
        </div>

        <!-- ================= 2. è®°å¿†åº“é¢æ¿ ================= -->
        <div class="panel-overlay" id="memoryPanel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ§  é•¿æœŸè®°å¿†åº“</h2>
                <button class="btn-close" onclick="togglePanel('memoryPanel')">Ã—</button>
            </div>
            <div style="margin-bottom: 15px;">
                <textarea id="newMemoryInput" class="form-input" style="height:60px;" placeholder="æ‰‹åŠ¨è¾“å…¥æƒ³è¦ AI è®°ä½çš„äº‹å®..."></textarea>
                <button class="btn btn-primary" onclick="addMemoryManual()">â• æ·»åŠ è®°å¿†</button>
            </div>
            <div class="form-label">å·²å­˜è®°å¿† (èŠå¤©æ—¶è‡ªåŠ¨ç”Ÿæ•ˆ)</div>
            <div id="memoryList"></div>
        </div>

        <!-- ================= 3. æ€»ç»“å¼¹çª— ================= -->
        <div class="modal-overlay" id="summaryModalOverlay">
            <div class="modal-box">
                <h3>ğŸª„ æ™ºèƒ½æ€»ç»“</h3>
                <p style="font-size:12px; color:#666;">AI å°†é˜…è¯»æŒ‡å®šèŒƒå›´çš„æ¶ˆæ¯ï¼Œå¹¶æå–é‡ç‚¹å­˜å…¥è®°å¿†åº“ã€‚</p>
                
                <div class="form-group">
                    <label class="form-label">å¼€å§‹ (From Msg #)</label>
                    <input type="number" id="sumStart" class="form-input" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">ç»“æŸ (To Msg #)</label>
                    <input type="number" id="sumEnd" class="form-input" value="10">
                </div>
                <div class="hint-text" id="msgCountHint">å½“å‰å…±æœ‰ 0 æ¡æ¶ˆæ¯</div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSummaryModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="btnDoSum" onclick="doSummarize()">å¼€å§‹æ€»ç»“</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½®å¯¹è±¡ ---
        let settings = {
            aiAvatar: "https://api.dicebear.com/7.x/bottts/svg?seed=AI",
            userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
            userName: "",
            contextLimit: 10,
            temperature: 0.7
        };
        let messages = []; 
        let memories = [];
        let currentUploadBase64 = null; 

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadSettings();
            loadData();
            renderMessages();
            renderMemories();
        };

        // --- æ ¸å¿ƒåŠŸèƒ½: å‘é€æ¶ˆæ¯ ---
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();
            
            if (!text && !currentUploadBase64) return;
            if (!document.getElementById('apiKey').value) {
                alert("è¯·å…ˆé…ç½® API Key ğŸ”‘"); togglePanel('settingsPanel'); return;
            }

            // 1. UIæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            const userMsg = { role: 'user', content: text, image: currentUploadBase64 };
            messages.push(userMsg);
            appendMessageUI('user', text, currentUploadBase64);
            saveData();

            // UIé‡ç½®
            input.value = '';
            clearUpload();
            btn.disabled = true; btn.innerText = "ğŸ’¬";

            // 2. æ„é€ è¯·æ±‚ Prompt
            const sysPromptRaw = document.getElementById('systemPrompt').value;
            const userName = document.getElementById('userName').value || "ç”¨æˆ·";
            const timeStr = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
            
            let fullSystemPrompt = `${sysPromptRaw}\n[System: Current Time (Asia/Shanghai): ${timeStr}]\n[System: Talking to user: ${userName}]`;
            
            if(memories.length > 0) {
                fullSystemPrompt += `\n\n[é•¿æœŸè®°å¿†åº“]:\n${memories.map(m => '- ' + m).join('\n')}`;
            }

            // 3. æ„é€ ä¸Šä¸‹æ–‡ (æˆªå–æœ€è¿‘Næ¡)
            const limit = parseInt(document.getElementById('contextRange').value) || 10;
            // è¿‡æ»¤å‡ºéœ€è¦å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶è½¬æ¢æ ¼å¼ï¼ˆVisionæ ¼å¼ï¼‰
            let apiMessages = [{ role: "system", content: fullSystemPrompt }];
            
            const history = messages.slice(-limit); 
            history.forEach(msg => {
                if(msg.image) {
                    // è§†è§‰æ ¼å¼
                    apiMessages.push({
                        role: msg.role,
                        content: [
                            { type: "text", text: msg.content || " " },
                            { type: "image_url", image_url: { url: msg.image } }
                        ]
                    });
                } else {
                    apiMessages.push({ role: msg.role, content: msg.content });
                }
            });

            // 4. å‘èµ·è¯·æ±‚
            const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('customModel').value || "gpt-3.5-turbo";
            const temp = parseFloat(document.getElementById('tempRange').value);

            // é¢„å…ˆåˆ›å»º AI æ°”æ³¡ç”¨äºæµå¼å¡«å……
            const aiBubble = appendMessageUI('assistant', '', null, true); 
            let fullReply = "";

            try {
                const res = await fetch(url + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
                    body: JSON.stringify({
                        model: model,
                        messages: apiMessages,
                        temperature: temp,
                        stream: true
                    })
                });

                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || res.statusText);
                }

                // æµå¼è¯»å–
                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while(true) {
                    const { done, value } = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if(dataStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(dataStr);
                                const content = json.choices[0].delta.content || "";
                                fullReply += content;
                                aiBubble.innerHTML = cleanText(fullReply).replace(/\n/g, '<br>');
                                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
                            } catch(e) {}
                        }
                    }
                }
                
                messages.push({ role: 'assistant', content: fullReply });
                saveData();

            } catch (e) {
                aiBubble.innerHTML += `<br><span style="color:red;font-size:12px;">ğŸš« é”™è¯¯: ${e.message}</span>`;
            }

            btn.disabled = false; btn.innerText = "å‘é€";
        }

        // --- è‡ªåŠ¨æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() {
            document.getElementById('summaryModalOverlay').style.display = 'block';
            document.getElementById('sumEnd').value = messages.length;
            document.getElementById('msgCountHint').innerText = `å½“å‰å†å²è®°å½•å…±æœ‰ ${messages.length} æ¡`;
        }
        function closeSummaryModal() {
            document.getElementById('summaryModalOverlay').style.display = 'none';
        }

        async function doSummarize() {
            const start = parseInt(document.getElementById('sumStart').value) - 1;
            const end = parseInt(document.getElementById('sumEnd').value);
            
            if (isNaN(start) || start < 0 || end > messages.length || start >= end) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆæ¯èŒƒå›´"); return;
            }

            const targetMsgs = messages.slice(start, end);
            // ç®€åŒ–ä¸ºæ–‡æœ¬ç”¨äºæ€»ç»“
            const chatText = targetMsgs.map(m => `${m.role}: ${m.content}`).join('\n');
            
            const btn = document.getElementById('btnDoSum');
            btn.disabled = true; btn.innerText = "æ€»ç»“ä¸­...";

            try {
                const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
                const key = document.getElementById('apiKey').value;
                const model = document.getElementById('customModel').value || "gpt-3.5-turbo";

                const res = await fetch(url + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°å½•å‘˜ã€‚"},
                            {role: "user", content: `è¯·ç®€è¦æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒä¿¡æ¯ï¼Œæç‚¼æˆä¸€æ¡ç®€çŸ­çš„è®°å¿†ç‚¹ï¼š\n\n${chatText}`}
                        ]
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                const summary = data.choices[0].message.content;
                memories.push(summary);
                saveData();
                renderMemories();
                alert("âœ… æ€»ç»“æˆåŠŸå¹¶å·²å­˜å…¥è®°å¿†åº“ï¼");
                closeSummaryModal();

            } catch(e) {
                alert("âŒ æ€»ç»“å¤±è´¥: " + e.message);
            }
            btn.disabled = false; btn.innerText = "å¼€å§‹æ€»ç»“";
        }

        // --- æ•°æ®å¤‡ä»½ä¸å¯¼å…¥ ---
        function exportData() {
            const data = {
                settings: settings,
                memories: memories,
                messages: messages,
                apiConfig: { 
                    // åªå¯¼å‡ºURLï¼Œä¸å¯¼å‡ºKeyä»¥é˜²æ³„éœ²ï¼Œé™¤éç”¨æˆ·çœŸçš„æƒ³å¯¼å‡ºKey...ä¸ºäº†å®‰å…¨è¿˜æ˜¯ä¸å¯¼Keyå§
                    url: document.getElementById('apiUrl').value,
                    sys: document.getElementById('systemPrompt').value
                }
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ai_phone_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm("å¯¼å…¥å°†è¦†ç›–å½“å‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        if(json.messages) messages = json.messages;
                        if(json.memories) memories = json.memories;
                        if(json.settings) settings = json.settings;
                        // æ¢å¤è®¾ç½®åˆ° UI
                        if(json.apiConfig) {
                            document.getElementById('apiUrl').value = json.apiConfig.url;
                            document.getElementById('systemPrompt').value = json.apiConfig.sys;
                        }
                        saveData();
                        saveSettings(); // è¿™ä¸€æ­¥ä¼šæŠŠ settings å¯¹è±¡å†™å…¥ LocalStorage
                        location.reload(); // åˆ·æ–°ç”Ÿæ•ˆ
                    }
                } catch(err) {
                    alert("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯");
                }
            };
            reader.readAsText(file);
        }

        // --- è¾…åŠ© UI é€»è¾‘ ---
        function appendMessageUI(role, text, imgBase64, isStreaming) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            
            const avatarUrl = role==='user' ? settings.userAvatar : settings.aiAvatar;
            
            // æ¥¼å±‚å· (index)
            const index = messages.length + (isStreaming ? 1 : 0); 

            let html = `
                <div style="position:relative">
                    <img src="${avatarUrl}" class="avatar">
                </div>
                <div class="message">
                    <div class="msg-index">#${index}</div>
                    ${imgBase64 ? `<img src="${imgBase64}" class="chat-img"><br>` : ''}
                    <span class="msg-content">${cleanText(text).replace(/\n/g, '<br>')}</span>
                </div>
            `;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            if(isStreaming) return div.querySelector('.msg-content');
        }

        function cleanText(text) {
            // ç®€å•å»é™¤Markdown (ç²—ä½“ã€ä»£ç å—åå¼•å·)
            return text.replace(/\*\*(.*?)\*\*/g, '$1')
                       .replace(/```/g, '')
                       .replace(/`/g, '');
        }

        function normalizeBaseUrl(url) {
            url = url.trim();
            if (url.endsWith('/')) url = url.slice(0, -1); 
            if (url.endsWith('/chat/completions')) url = url.replace('/chat/completions', ''); 
            // æ™ºèƒ½è¡¥å…¨
            if (!url.endsWith('/v1') && url.includes('openai')) url += '/v1'; 
            // å¦‚æœç”¨æˆ·å®Œå…¨æ²¡å†™v1ï¼Œç»™ä¸ªæç¤ºæˆ–å¼ºè¡ŒåŠ ï¼Ÿè¿™é‡Œæˆ‘ä»¬åšä¸ªå®‰å…¨æ£€æŸ¥
            if (!url.endsWith('/v1')) {
                 // å¯ä»¥åœ¨è¿™é‡Œåšä¸€ä¸ªé™é»˜è¡¥å……ï¼Œæˆ–è€…ä¿¡ä»»ç”¨æˆ·ã€‚
                 // æ ¹æ®è¦æ±‚ï¼Œæˆ‘ä»¬å·²ç»åœ¨UIä¸Šæç¤ºäº†ã€‚è¿™é‡Œåšä¸€ä¸ªè½¯æ€§è¡¥å……ã€‚
                 // url += '/v1'; // æš‚æ—¶ä¸å¼ºåˆ¶ï¼Œæœ‰çš„ç§æœ‰éƒ¨ç½²å¯èƒ½ä¸æ˜¯v1
            }
            return url;
        }

        // å›¾ç‰‡å¤„ç†
        function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentUploadBase64 = ev.target.result;
                document.getElementById('previewImg').src = currentUploadBase64;
                document.getElementById('uploadPreview').style.display = 'flex';
            }
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        function clearUpload() {
            currentUploadBase64 = null;
            document.getElementById('uploadPreview').style.display = 'none';
        }

        function handleAvatarUpload(e, type) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const res = ev.target.result;
                if(type === 'ai') {
                    settings.aiAvatar = res;
                    document.getElementById('aiAvatarPreview').src = res;
                } else {
                    settings.userAvatar = res;
                    document.getElementById('userAvatarPreview').src = res;
                }
                saveSettings();
            }
            reader.readAsDataURL(file);
        }

        // é¢æ¿ä¸å­˜å‚¨
        function togglePanel(id) {
            document.querySelectorAll('.panel-overlay').forEach(p => {
                if(p.id !== id) p.style.display = 'none';
            });
            const p = document.getElementById(id);
            if(p.style.display === 'flex') {
                p.style.display = 'none';
                saveSettings();
            } else {
                p.style.display = 'flex';
                p.classList.add('show');
            }
        }

        function saveSettings() {
            localStorage.setItem('v75_url', document.getElementById('apiUrl').value);
            localStorage.setItem('v75_key', document.getElementById('apiKey').value);
            localStorage.setItem('v75_sys', document.getElementById('systemPrompt').value);
            localStorage.setItem('v75_mod', document.getElementById('customModel').value);
            
            settings.userName = document.getElementById('userName').value;
            settings.contextLimit = document.getElementById('contextRange').value;
            settings.temperature = document.getElementById('tempRange').value;
            
            localStorage.setItem('v75_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            if(localStorage.getItem('v75_url')) document.getElementById('apiUrl').value = localStorage.getItem('v75_url');
            if(localStorage.getItem('v75_key')) document.getElementById('apiKey').value = localStorage.getItem('v75_key');
            if(localStorage.getItem('v75_sys')) document.getElementById('systemPrompt').value = localStorage.getItem('v75_sys');
            if(localStorage.getItem('v75_mod')) document.getElementById('customModel').value = localStorage.getItem('v75_mod');

            const saved = localStorage.getItem('v75_settings');
            if(saved) {
                settings = JSON.parse(saved);
                document.getElementById('userName').value = settings.userName || "";
                document.getElementById('contextRange').value = settings.contextLimit || 10;
                document.getElementById('contextVal').innerText = settings.contextLimit || 10;
                document.getElementById('tempRange').value = settings.temperature || 0.7;
                document.getElementById('tempVal').innerText = settings.temperature || 0.7;
                document.getElementById('aiAvatarPreview').src = settings.aiAvatar;
                document.getElementById('userAvatarPreview').src = settings.userAvatar;
            }
        }

        function saveData() {
            localStorage.setItem('v75_msg', JSON.stringify(messages));
            localStorage.setItem('v75_mem', JSON.stringify(memories));
        }
        function loadData() {
            const m = localStorage.getItem('v75_msg'); if(m) messages = JSON.parse(m);
            const mem = localStorage.getItem('v75_mem'); if(mem) memories = JSON.parse(mem);
        }

        // è®°å¿†åº“ç®¡ç†
        function renderMemories() {
            const list = document.getElementById('memoryList');
            list.innerHTML = '';
            memories.forEach((m, i) => {
                list.innerHTML += `<div class="memory-item"><span>${m}</span><span class="mem-del" onclick="deleteMemory(${i})">Ã—</span></div>`;
            });
        }
        function deleteMemory(i) { memories.splice(i, 1); saveData(); renderMemories(); }
        function addMemoryManual() {
            const v = document.getElementById('newMemoryInput').value.trim();
            if(v) { memories.push(v); saveData(); renderMemories(); document.getElementById('newMemoryInput').value=''; }
        }
        
        function toggleCustomModel() {
            const sel = document.getElementById('modelSelect');
            const inp = document.getElementById('customModel');
            if(inp.style.display === 'none') { inp.style.display = 'block'; sel.style.display='none'; inp.value = sel.value; }
            else { inp.style.display = 'none'; sel.style.display='block'; }
        }

        function clearChat() { if(confirm("æ¸…ç©ºå¯¹è¯è®°å½•ï¼Ÿ")) { messages=[]; saveData(); renderMessages(); } }
        function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
        
        async function testConnection() {
            try {
                const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
                const key = document.getElementById('apiKey').value;
                await fetch(url + '/models', { headers: {Authorization: "Bearer "+key}});
                alert("âœ… è¿æ¥æˆåŠŸï¼");
            } catch(e) { alert("âŒ è¿æ¥å¤±è´¥: " + e.message); }
        }
        async function fetchModels() {
            const sel = document.getElementById('modelSelect');
            try {
                const url = normalizeBaseUrl(document.getElementById('apiUrl').value);
                const key = document.getElementById('apiKey').value;
                const res = await fetch(url + '/models', { headers: {Authorization: "Bearer "+key}});
                const d = await res.json();
                sel.innerHTML = '';
                d.data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id; opt.innerText = m.id;
                    sel.appendChild(opt);
                });
                alert(`å·²æ›´æ–° ${d.data.length} ä¸ªæ¨¡å‹`);
            } catch(e) { alert("æ‹‰å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥"); toggleCustomModel(); }
        }
    </script>
</body>
</html>