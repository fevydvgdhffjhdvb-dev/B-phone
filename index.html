<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåˆ¶ç¦æ­¢ç¼“å­˜ (è§£å†³ iOS ä¸»å±å¹•ä¸æ›´æ–°é—®é¢˜) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>AI Phone Pro</title>
    <!-- è‡ªå®šä¹‰ä¸»å±å¹•å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    <link rel="icon" href="https://i.postimg.cc/Vvq4PMVp/IMG-9639.jpg">
    
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            background-color: #222; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            overflow: hidden; 
        }

        /* --- æ‰‹æœºå¤–å£³ --- */
        .phone-frame { 
            width: 375px; height: 85vh; max-height: 850px; 
            background-color: #000; 
            border-radius: 45px; 
            box-shadow: 0 0 0 8px #333, 0 20px 50px rgba(0,0,0,0.5); 
            position: relative; overflow: hidden; 
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .phone-frame { width: 100%; height: 100%; border-radius: 0; box-shadow: none; border: none; }
        }

        /* --- é¡µé¢åˆ‡æ¢ç³»ç»Ÿ --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            z-index: 10;
        }
        .page.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px; width: 100%;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 10px 20px;
            font-size: 14px; font-weight: 600; color: inherit;
            z-index: 100;
            position: absolute; top: 0; left: 0;
        }

        /* --- 1. æ¡Œé¢ (Home) --- */
        #page-home {
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop') no-repeat center center/cover;
            color: white;
            justify-content: flex-start;
        }
        /* ä¿®æ”¹ .home-clock-widget (åŸç¬¬65è¡Œ) */
        .home-clock-widget { 
            margin-top: 60px;  /* ä»120æ”¹åˆ°60ï¼Œè®©æ—¶é’Ÿå¾€ä¸Šæ */
            text-align: center; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            margin-bottom: 20px; /* å¢åŠ åº•éƒ¨é—´è· */
        }
        
        /* åŸæ¥çš„ .clock-time å’Œ .clock-date (ç¬¬66-67è¡Œ) ä¸ç”¨åŠ¨ï¼Œä¿ç•™å³å¯ */
        .clock-time { font-size: 72px; font-weight: 200; letter-spacing: -2px; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; font-weight: 500; }

        /* ä¿®æ”¹ .app-grid (åŸç¬¬69-75è¡Œ) */
        .app-grid {
            margin-top: 0;       /* å»æ‰ autoï¼Œè®©å®ƒä¸å†æ²‰åº•ï¼Œæ”¹ä¸ºé ä¸Š */
            margin-bottom: auto; /* åº•éƒ¨ç•™ç©º */
            
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 30px 15px;      /* è°ƒæ•´å›¾æ ‡é—´è·ï¼Œè¡Œè·å¤§ä¸€ç‚¹ */
            padding: 20px;
            
            /* å…³é”®ï¼šå»æ‰èƒŒæ™¯è‰²ã€ç£¨ç ‚å’Œè¾¹æ¡† */
            background: none;    
            backdrop-filter: none;
            border-radius: 0;
            
            margin-left: 10px; 
            margin-right: 10px;
        }
        .app-icon-container { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .app-icon-container:active { transform: scale(0.9); }
        .app-icon {
            width: 58px; height: 58px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .icon-msg { background: linear-gradient(to bottom, #34c759, #30b753); }
        .icon-note { background: linear-gradient(to bottom, #ffd60a, #ffcc00); }
        .icon-settings { background: linear-gradient(to bottom, #8e8e93, #636366); }

        /* --- é€šç”¨ App å¤´éƒ¨ --- */
        .app-header {
            height: 90px; padding-top: 44px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            padding-left: 15px; padding-right: 15px;
            background: rgba(248, 249, 250, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .app-title { font-size: 28px; font-weight: bold; color: #000; }
        .btn-icon-text { font-size: 16px; color: #007AFF; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .btn-icon-only { font-size: 22px; color: #007AFF; background: none; border: none; cursor: pointer; padding: 5px; }

        /* --- 2. æ¶ˆæ¯åˆ—è¡¨ --- */
        #page-msg-list { background: #fff; }
        .msg-list-scroll { flex: 1; overflow-y: auto; }
        .msg-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: 0.2s;
        }
        .msg-list-item:active { background: #f5f5f5; }
        .list-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee;}
        .list-info { flex: 1; min-width: 0; }
        .list-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .list-preview { color: #8e8e93; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-time { font-size: 12px; color: #c7c7cc; white-space: nowrap; }

        /* --- 3. èŠå¤©ç•Œé¢ --- */
        /* ä¿®å¤åçš„èƒŒæ™¯ï¼šå»æ‰é¡¶éƒ¨å†…è¾¹è·ï¼Œè®©å£çº¸æ’‘æ»¡ */
        #page-chat { 
            background-color: #f2f2f7; 
            background-size: cover; 
            background-position: center; 
            padding-top: 95px; /* ç»™é¡¶éƒ¨ç•™å‡ºç©ºé—´ */
        }

        /* ä¿®å¤åçš„é¡¶éƒ¨æ ï¼šå¼ºåˆ¶å›ºå®šåœ¨æœ€ä¸Šæ–¹ï¼Œå¡«è¡¥çŠ¶æ€æ ç¼éš™ */
        .chat-header-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: auto; min-height: 90px;
            padding-top: max(44px, env(safe-area-inset-top));
            padding-bottom: 10px;
            padding-left: 15px; padding-right: 15px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            display: flex; align-items: flex-end; justify-content: space-between;
            border-bottom: 1px solid #dbdbdb;
            z-index: 50;
        }
        .chat-back-btn { color: #007AFF; font-size: 16px; border: none; background: none; display: flex; align-items: center; cursor: pointer; }
        .chat-contact-name { font-weight: 600; font-size: 16px; flex: 1; text-align: center; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .chat-header-actions { display: flex; gap: 15px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; position: relative; }
        .msg-row.right { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); background:#fff;}
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-row.left .message { background: #fff; color: #000; border-bottom-left-radius: 4px; }
        .msg-row.right .message { background: #007AFF; color: #fff; border-bottom-right-radius: 4px; }
        .msg-index { font-size: 10px; color: #999; position: absolute; top: -15px; opacity: 0.5; }
        .msg-row.left .msg-index { left: 45px; }
        .msg-row.right .msg-index { right: 45px; }

        .input-area { background: #f9f9f9; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px; }
        .input-toolbar { display: flex; align-items: center; gap: 8px; width: 100%; }
        #userInput { flex: 1; min-width: 0; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        #userInput:focus { border-color: #007AFF; }
        .btn-send { font-size: 24px; background: none; border: none; cursor: pointer; color: #007AFF; padding: 0 5px; flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .typing-indicator { display: inline-block; width: 4px; height: 4px; background: #999; border-radius: 50%; margin: 0 1px; animation: bounce 1s infinite; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #uploadPreview { display: none; padding: 8px; background: #fff; border-radius: 8px; border: 1px dashed #ccc; align-items: center; gap: 10px; font-size: 12px; }

        /* --- é€šç”¨åˆ—è¡¨æ ·å¼ (è®¾ç½®/è®°å¿†) --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; }
        .ios-group-title { font-size: 13px; color: #666; margin: 15px 15px 5px; text-transform: uppercase; }
        .ios-list { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 12px 15px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; justify-content: space-between; min-height: 45px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-item:active { background-color: #f9f9f9; }
        .ios-label { font-size: 16px; font-weight: 500; color: #000; flex-shrink: 0; margin-right: 10px;}
        .ios-input { border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; background: transparent; flex: 1; min-width: 0;}
        .ios-btn { width: 100%; padding: 14px; text-align: center; color: #007AFF; background: #fff; border: none; font-size: 16px; cursor: pointer; border-top: 1px solid #e5e5ea; }
        .ios-btn.danger { color: #ff3b30; }
        .memory-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; position: relative; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-del-mem { position: absolute; top: 10px; right: 10px; color: #ff3b30; cursor: pointer; font-size: 18px;}

        /* --- å¼¹çª— Modal --- */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:500; display:none; align-items:center; justify-content:center; opacity: 0; transition: opacity 0.2s;}
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); width: 85%; max-height: 70%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; font-size: 17px;}
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #f2f2f7;}
        .modal-footer { display: flex; border-top: 1px solid #ccc; }
        .modal-btn { flex: 1; padding: 15px; background: #fff; border: none; font-size: 17px; cursor: pointer; }
        .modal-btn:first-child { border-right: 1px solid #ccc; color: #ff3b30; }
        .modal-btn:last-child { color: #007AFF; font-weight: 600; }

        /* Home Indicator */
        .home-indicator {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: #000; border-radius: 10px; z-index: 999; cursor: pointer;
        }
        #page-home .home-indicator { background: #fff; }
        
        /* æ¶ˆæ¯ä¸‹æ–¹çš„å·¥å…·æ  */
        .msg-meta-row { display: flex; align-items: center; margin-top: 2px; }
        .msg-row.left .msg-meta-row { justify-content: flex-start; margin-left: 45px; }
        .msg-row.right .msg-meta-row { justify-content: flex-end; margin-right: 45px; }
        
        /* é‡åˆ·æŒ‰é’® */
        .btn-reroll { 
            font-size: 12px; color: #999; cursor: pointer; padding: 2px 5px; 
            background: rgba(255,255,255,0.5); border-radius: 10px;
            display: flex; align-items: center; gap: 3px;
        }
        .btn-reroll:active { transform: scale(0.9); background: #ddd; }
        /* --- å¼ºåˆ¶ä¿®å¤ iOS é•¿æŒ‰å†²çª --- */
        .msg-row.right .message {
            -webkit-touch-callout: none !important; 
            -webkit-user-select: none !important;
            user-select: none !important;
        }
        /* --- ç•ªèŒ„é’Ÿä¸“å±æ ·å¼ --- */
        .pomo-bubble {
            margin-top: 30px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 85%;
            text-align: center;
            font-size: 16px;
            color: #333;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }
        /* æˆ³ä¸€æˆ³åŠ¨ç”»ç±» */
        .anim-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
          10%, 90% { transform: translate3d(-2px, 0, 0); }
          20%, 80% { transform: translate3d(4px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
          40%, 60% { transform: translate3d(8px, 0, 0); }
        }
        /* --- Pop é£æ ¼æ—¶é—´æˆ³æ ·å¼ --- */
        .message {
            position: relative; /* ä¸ºç»å¯¹å®šä½çš„æ—¶é—´æˆ³åšå‚ç…§ */
            padding-bottom: 18px; /* åº•éƒ¨ç•™å‡ºç©ºé—´ç»™æ—¶é—´æˆ³ï¼Œé¿å…é®æŒ¡æ–‡å­— */
            min-width: 60px; /* ä¿è¯æ°”æ³¡ä¸ä¼šå¤ªçª„ */
        }

        .msg-time-stamp {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            opacity: 0.6; /* ç¨å¾®é€æ˜ï¼Œä¸æŠ¢çœ¼ */
            font-weight: 400;
            user-select: none;
        }

        /* é’ˆå¯¹æ·±è‰²æ°”æ³¡ï¼ˆå³ä¾§ï¼‰çš„é€‚é… */
        .msg-row.right .msg-time-stamp {
            color: rgba(255, 255, 255, 0.9);
        }

        /* é’ˆå¯¹æµ…è‰²æ°”æ³¡ï¼ˆå·¦ä¾§ï¼‰çš„é€‚é… */
        .msg-row.left .msg-time-stamp {
            color: rgba(0, 0, 0, 0.5);
        }
        /* --- æ—¥å† App æ ·å¼ --- */
.cal-month-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; font-size: 18px; font-weight: bold; border-bottom: 1px solid #eee;
}
.cal-month-nav button { background:none; border:none; font-size:20px; color:#007AFF; cursor:pointer; padding: 0 10px;}

.cal-week-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px 0; font-size: 12px; color: #999; border-bottom: 1px solid #f0f0f0; }

.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); auto-rows: 50px; }
.cal-cell { 
    border-bottom: 1px solid #fafafa; border-right: 1px solid #fafafa;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; cursor: pointer;
}
.cal-cell.active { background-color: #e5f1ff; } /* é€‰ä¸­æ€ */
.cal-cell.today { color: #007AFF; font-weight: bold; }
.cal-cell.empty { background: #fcfcfc; }

/* æ ‡è®°ç‚¹æ ·å¼ */
.cal-dot-container { display: flex; gap: 2px; margin-top: 2px; }
.dot-event { width: 5px; height: 5px; border-radius: 50%; background-color: #ff9500; } /* èŠ‚æ—¥æ˜¯æ©™è‰²ç‚¹ */
.dot-period { width: 6px; height: 6px; border-radius: 50%; background-color: #ff2d55; border: 1px solid #fff;} /* ç»æœŸæ˜¯ç²‰çº¢å¤§ç‚¹ */

/* ç»æœŸé¢„æµ‹åŒºé—´èƒŒæ™¯ (è¿›é˜¶æ•ˆæœ) */
.cal-cell.period-range { background-color: rgba(255, 45, 85, 0.1); }
        /* --- ä»¿ iOS å¤©æ°”ç»„ä»¶ --- */
.weather-widget {
    width: 335px; /* å’Œæ‰‹æœºå®½åº¦åŒ¹é… */
    height: 100px; /* æ‰é•¿å‹ç»„ä»¶ */
    background: linear-gradient(135deg, #3b82f6, #2563eb); /* ç»å…¸çš„æ™´å¤©è“ */
    border-radius: 20px;
    margin: 0 auto 20px auto; /* å±…ä¸­ï¼Œä¸‹æ–¹ç•™ç©º */
    padding: 15px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.weather-widget:active { transform: scale(0.98); }

/* å·¦ä¾§ï¼šæ¸©åº¦å’Œæè¿° */
.weather-left { display: flex; flex-direction: column; justify-content: center; }
.weather-temp { font-size: 42px; font-weight: 300; line-height: 1; }
.weather-desc { font-size: 14px; font-weight: 500; margin-top: 5px; opacity: 0.9; }
.weather-range { font-size: 12px; margin-top: 2px; opacity: 0.7; }

/* å³ä¾§ï¼šä½ç½®å’Œå›¾æ ‡ */
.weather-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; height: 100%; }
.weather-loc { font-size: 14px; font-weight: 600; }
.weather-icon { font-size: 36px; }

/* åŠ¨æ€èƒŒæ™¯è£…é¥° (äº‘æœµ) */
.weather-bg-deco {
    position: absolute; top: -10px; right: -10px;
    font-size: 120px; opacity: 0.1; pointer-events: none;
}
        /* --- è¯¾ç¨‹/æ—¥ç¨‹è¡¨æ ·å¼ --- */
.schedule-list { padding: 15px; }
.schedule-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.sched-time { font-size: 18px; font-weight: bold; color: #007AFF; }
.sched-info { flex: 1; margin-left: 15px; }
.sched-name { font-size: 16px; font-weight: 600; }
.sched-day { font-size: 12px; color: #999; margin-top: 2px; }
.btn-del-sched { color: #ff3b30; font-size: 20px; cursor: pointer; padding: 5px; }

/* æ·»åŠ æ—¥ç¨‹çš„è¡¨å•åŒºåŸŸ */
.sched-form {
    background: #f9f9f9; padding: 15px; border-radius: 12px; margin: 15px;
    display: flex; flex-direction: column; gap: 10px;
}
.sched-row { display: flex; gap: 10px; }
        /* --- æ—¥è®°æœ¬ä¸“ç”¨æ ·å¼ (æ·»åŠ åˆ° style æ ‡ç­¾é‡Œ) --- */
.diary-folder {
    background: #fff; border-bottom: 1px solid #f0f0f0;
    padding: 20px; display: flex; align-items: center; gap: 15px; cursor: pointer;
}
.diary-folder:active { background: #f9f9f9; }
.diary-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
.diary-info { flex: 1; }
.diary-title { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
.diary-sub { font-size: 13px; color: #999; }
.btn-float-write {
    position: absolute; bottom: 30px; right: 20px;
    width: 56px; height: 56px; border-radius: 50%;
    background: #007AFF; color: white; font-size: 24px;
    border: none; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
}
        /* --- X (Twitter) App ä¸“å±æ ·å¼ (SVG é«˜æ¸…ç‰ˆ) --- */
#page-x {
    background-color: #000000;
    color: #e7e9ea;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    overflow: hidden;
}

/* --- å¤´éƒ¨æ ·å¼æ›´æ–° --- */
.x-header {
    position: absolute; top: 0; left: 0; width: 100%;
    height: 90px; padding-top: 44px;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid #2f3336;
    display: flex; justify-content: center; align-items: center;
    z-index: 50;
}

/* å·¦ä¸Šè§’è¿”å›æŒ‰é’® */
.x-header-back { 
    position: absolute; left: 15px; bottom: 10px;
    width: 32px; height: 32px; 
    display: flex; align-items: center; justify-content: center;
    background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;
}

/* ä¸­é—´ç”¨æˆ·å¤´åƒ (æ›¿æ¢Logo) */
.x-header-center-avatar { 
    width: 32px; height: 32px; border-radius: 50%; object-fit: cover; 
    border: 2px solid #000; /* åŠ ä¸ªé»‘è¾¹æ›´æœ‰å±‚æ¬¡ */
}

/* å³ä¸Šè§’æ˜Ÿæ˜Ÿå›¾æ ‡ */
.x-header-right { 
    position: absolute; right: 15px; bottom: 10px; 
    width: 22px; height: 22px; fill: #fff; 
}

.x-feed {
    margin-top: 90px; margin-bottom: 50px;
    height: calc(100% - 140px);
    overflow-y: auto;
    background: #000;
}

.x-refresh-indicator {
    text-align: center; padding: 10px; color: #1d9bf0; font-size: 20px; display: none;
}

/* æ¨æ–‡æ ·å¼ */
.x-tweet {
    padding: 12px 16px; border-bottom: 1px solid #2f3336;
    display: flex; gap: 12px; transition: background 0.2s;
}
.x-tweet:active { background-color: rgba(255,255,255,0.03); }
.x-tweet-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
.x-tweet-content { flex: 1; min-width: 0; }
.x-tweet-header { display: flex; align-items: center; gap: 5px; font-size: 15px; }
.x-name { font-weight: 700; color: #e7e9ea; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;}
.x-handle, .x-time { color: #71767b; font-weight: 400; font-size: 14px; }
.x-text { margin-top: 2px; font-size: 15px; line-height: 1.5; color: #e7e9ea; white-space: pre-wrap; word-wrap: break-word; }

/* äº’åŠ¨æŒ‰é’® SVG æ ·å¼ */
.x-actions { display: flex; justify-content: space-between; margin-top: 12px; max-width: 300px; }
.x-action-btn {
    display: flex; align-items: center; gap: 5px;
    color: #71767b; background: none; border: none; cursor: pointer; padding: 0;
    font-size: 13px; /* æ•°å­—å¤§å° */
    transition: color 0.2s;
}
.x-action-icon { width: 18px; height: 18px; fill: currentColor; } /* å›¾æ ‡å¤§å° */

.x-action-btn.reply:hover { color: #1d9bf0; }
.x-action-btn.retweet:hover { color: #00ba7c; }
.x-action-btn.like:hover { color: #f91880; }
.x-action-btn.liked { color: #f91880; } 
.x-action-btn.liked .x-action-icon { fill: #f91880; } /* ç‚¹èµåå¡«å……çº¢è‰² */

/* åº•éƒ¨å¯¼èˆª SVG */
.x-tab-bar {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 53px; border-top: 1px solid #2f3336;
    background: #000; display: flex; justify-content: space-around; align-items: center;
    padding-bottom: 15px; 
    z-index: 50;
}
.x-tab-btn { 
    background: none; border: none; padding: 10px; 
    color: #e7e9ea; /* å›¾æ ‡é»˜è®¤é¢œè‰² */
    display: flex; align-items: center; justify-content: center;
}
.x-tab-icon { width: 26px; height: 26px; fill: currentColor; } /* åº•éƒ¨å›¾æ ‡ç¨å¤§ */
.x-tab-btn.active { color: #e7e9ea; } /* é€‰ä¸­æ€ */
.x-tab-btn.active .x-tab-icon { 
    stroke: currentColor; 
    stroke-width: 1px; /* è¿™é‡Œç®€å•æ¨¡æ‹Ÿé€‰ä¸­åŠ ç²—ï¼ŒçœŸå®Xæ˜¯åˆ‡æ¢å®å¿ƒ/ç©ºå¿ƒå›¾æ ‡ */
}

/* --- æ‚¬æµ®æŒ‰é’® (ä¿®å¤ç¾½æ¯›å½¢çŠ¶) --- */
.x-fab {
    position: absolute; bottom: 70px; right: 20px;
    width: 56px; height: 56px;
    background-color: #1d9bf0;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 4px 10px rgba(29, 155, 240, 0.3);
    cursor: pointer; z-index: 60;
    transition: transform 0.2s;
}
.x-fab:active { transform: scale(0.9); }
/* è°ƒæ•´å›¾æ ‡å¤§å°å’Œä½ç½®ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒåŸç‰ˆ */
.x-fab-icon { width: 26px; height: 26px; fill: white; margin-left: -2px; margin-top: 2px; }
        /* --- X è¯¦æƒ…é¡µä¸“å±æ ·å¼ --- */
#page-x-detail { z-index: 60; } /* ç›–åœ¨ä¸»é¡µä¸Šé¢ */

/* è¯¦æƒ…é¡µçš„ä¸»æ¨æ–‡æ ·å¼ (æ¯”åˆ—è¡¨é¡µæ›´å¤§) */
.x-detail-tweet { padding: 16px; border-bottom: 1px solid #2f3336; }
.x-detail-user { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
.x-detail-avatar { width: 50px; height: 50px; border-radius: 50%; }
.x-detail-info { display: flex; flex-direction: column; }
.x-detail-name { font-size: 16px; font-weight: 800; color: #e7e9ea; }
.x-detail-handle { font-size: 15px; color: #71767b; }
.x-detail-text { font-size: 20px; line-height: 1.4; color: #e7e9ea; margin-bottom: 15px; }
.x-detail-meta { color: #71767b; font-size: 15px; padding: 15px 0; border-top: 1px solid #2f3336; border-bottom: 1px solid #2f3336; }

/* è¯„è®ºåˆ—è¡¨æ ·å¼ */
.x-comment-item { 
    padding: 12px 16px; border-bottom: 1px solid #2f3336; display: flex; gap: 12px; 
}
.x-comment-content { flex: 1; }
.x-comment-header { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;}
.x-comment-name { font-weight: 700; color: #e7e9ea; margin-right: 5px; }
.x-comment-handle { color: #71767b; }
.x-comment-text { font-size: 15px; color: #e7e9ea; line-height: 1.4; }
.x-comment-reply-tag { color: #1d9bf0; font-size: 13px; margin-bottom: 2px; }

/* åº•éƒ¨å›å¤æ  */
.x-detail-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 60px; background: #000; border-top: 1px solid #2f3336;
    display: flex; align-items: center; padding: 0 15px; gap: 10px;
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 100;
}
.x-detail-input {
    flex: 1; background: #202327; border: none; border-radius: 20px;
    padding: 10px 15px; color: #fff; font-size: 16px; outline: none;
}
.x-detail-send-btn {
    background: #1d9bf0; color: #fff; border: none; border-radius: 20px;
    padding: 8px 16px; font-weight: bold; cursor: pointer;
}
.x-detail-send-btn:active { opacity: 0.8; }
        /* --- X ä¸ªäººä¸»é¡µæ ·å¼ --- */
.x-profile-header { position: absolute; top: 0; left: 0; width: 100%; height: 50px; z-index: 10; }
.x-header-back-circle {
    margin: 10px; width: 32px; height: 32px; border-radius: 50%;
    background: rgba(0,0,0,0.6); border: none; color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.x-profile-banner {
    width: 100%; height: 150px; background: #333; background-size: cover; background-position: center;
}
.x-profile-info { padding: 12px 16px; position: relative; }
.x-profile-top-row { display: flex; justify-content: space-between; align-items: flex-end; margin-top: -45px; margin-bottom: 10px; }
.x-profile-avatar {
    width: 80px; height: 80px; border-radius: 50%; border: 4px solid #000; object-fit: cover;
}
.x-edit-profile-btn {
    background: none; border: 1px solid #536471; color: #fff;
    border-radius: 20px; padding: 6px 15px; font-weight: bold; font-size: 14px;
}
.x-profile-name-box { display: flex; align-items: center; gap: 4px; }
.x-profile-name { font-size: 20px; font-weight: 800; color: #e7e9ea; }
.x-profile-handle { color: #71767b; font-size: 15px; margin-bottom: 10px; }
.x-profile-bio { font-size: 15px; color: #e7e9ea; margin-bottom: 10px; line-height: 1.4; }
.x-profile-meta { display: flex; gap: 15px; color: #71767b; font-size: 14px; margin-bottom: 10px; }
.x-profile-stats { display: flex; gap: 20px; font-size: 14px; }
.x-stat-num { color: #e7e9ea; font-weight: 700; }
.x-stat-label { color: #71767b; }

/* ç¼–è¾‘å¼¹çª—æ ·å¼ */
.x-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px; border-bottom: 1px solid #2f3336; background: #000;
}
.x-input-group { margin-bottom: 15px; }
.x-input-group label { display: block; color: #71767b; font-size: 13px; margin-bottom: 5px; }
.x-input {
    width: 100%; background: #202327; border: 1px solid #333; border-radius: 4px;
    padding: 8px; color: #fff; font-size: 16px; outline: none;
}
.x-input:focus { border-color: #1d9bf0; }
.x-flex-row { display: flex; gap: 10px; }

/* è®¤è¯å¾½ç« é¢œè‰² */
.badge-blue { fill: #1d9bf0; }
.badge-gold { fill: #ffd700; }
.badge-white { fill: #fff; } /* å¿ƒå½¢ã€åœ†ç¯ã€è±å½¢ */
        /* --- å¼ºåˆ¶ä¿®æ­£ X ä¸ªäººä¸»é¡µèƒŒæ™¯ä¸ºçº¯é»‘ --- */
#page-x-profile {
    background-color: #000000 !important; /* å¼ºåˆ¶è¦†ç›–é»˜è®¤ç™½è‰²èƒŒæ™¯ */
    color: #e7e9ea;
}

/* ä¿®æ­£ç¼–è¾‘å¼¹çª—çš„èƒŒæ™¯ */
#modal-x-edit .modal-box {
    background-color: #000000 !important;
    border: 1px solid #2f3336; /* åŠ ä¸ªæ·±ç°è‰²è¾¹æ¡†ï¼Œæ›´æœ‰è´¨æ„Ÿ */
}

/* ä¿®æ­£å¼¹çª—å¤´éƒ¨å’Œå†…å®¹åŒº */
.x-modal-header {
    background-color: #000000 !important;
    border-bottom: 1px solid #2f3336;
}
.modal-body {
    background-color: #000000 !important;
}

/* ç¡®ä¿è¾“å…¥æ¡†ä¹Ÿæ˜¯é»‘åº•ç™½å­— */
.x-input {
    background-color: #202327 !important;
    color: #ffffff !important;
    border: 1px solid #333 !important;
}
.x-input:focus {
    border-color: #1d9bf0 !important;
}

/* ä¸‹æ‹‰é€‰æ‹©æ¡†çš„é€‰é¡¹èƒŒæ™¯ */
select.x-input option {
    background-color: #000;
    color: #fff;
}
        /* --- ä¿®å¤ï¼šä¸ªäººä¸»é¡µé¡¶éƒ¨å¯¼èˆªæ  --- */
.x-profile-header { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100px; /* å¢åŠ é«˜åº¦ */
    /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼ŒæŠŠå†…å®¹æŒ¤ä¸‹æ¥ */
    padding-top: 50px; 
    z-index: 60; 
    /* è®©è¿™ä¸€å±‚ä¸æ‹¦æˆªç‚¹å‡»ï¼Œåªè®©é‡Œé¢çš„æŒ‰é’®æ‹¦æˆªç‚¹å‡» */
    pointer-events: none; 
}

/* --- ä¿®å¤ï¼šè¿”å›æŒ‰é’®æ ·å¼ --- */
.x-header-back-circle {
    /* æ¢å¤æŒ‰é’®çš„å¯ç‚¹å‡»çŠ¶æ€ */
    pointer-events: auto; 
    
    margin-left: 20px; /* ç¨å¾®ç¦»å·¦è¾¹è¿œä¸€ç‚¹ */
    width: 36px; height: 36px; /*ç¨å¾®å¤§ä¸€ç‚¹æ›´å¥½ç‚¹*/
    border-radius: 50%;
    
    /* åŠ æ·±èƒŒæ™¯è‰²ï¼Œç¡®ä¿åœ¨ä»»ä½•å£çº¸ä¸Šéƒ½èƒ½çœ‹æ¸… */
    background: rgba(0, 0, 0, 0.7); 
    backdrop-filter: blur(5px);
    
    border: 1px solid rgba(255,255,255,0.2); /* åŠ ä¸ªç»†è¾¹æ¡†æ›´æœ‰è´¨æ„Ÿ */
    color: #fff; 
    font-size: 22px;
    display: flex; align-items: center; justify-content: center; 
    cursor: pointer;
    
    /* åŠ ä¸ªé˜´å½± */
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
        /* ============================================
   ğŸ› ï¸ 1. ä¿®å¤è¯¦æƒ…é¡µåº•éƒ¨å›å¤æ  (é˜²æ­¢æŒ‰é’®è¢«æŒ¤é£)
   ============================================ */
.x-detail-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 60px; background: #000; border-top: 1px solid #2f3336;
    display: flex; align-items: center; 
    padding: 0 15px; 
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 100;
    box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢paddingæ’‘å¤§ */
}

.x-detail-input {
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    min-width: 0; 
    background: #202327; border: none; border-radius: 20px;
    padding: 10px 15px; color: #fff; font-size: 16px; outline: none;
    margin-right: 10px; 
}

.x-detail-send-btn {
    flex-shrink: 0; /* å…³é”®ï¼šç¦æ­¢æŒ‰é’®è¢«å‹ç¼© */
    background: #1d9bf0; color: #fff; border: none; border-radius: 20px;
    padding: 8px 16px; font-weight: bold; cursor: pointer;
    white-space: nowrap;
}

/* ============================================
   ğŸ†• 2. è½¬æ¨èœå• & å¼•ç”¨æ ·å¼
   ============================================ */
/* åº•éƒ¨åŠ¨ä½œèœå• (ä»¿iOS Action Sheet) */
.x-action-sheet {
    width: 100%; background: #000; 
    border-top-left-radius: 20px; border-top-right-radius: 20px;
    border: 1px solid #2f3336; padding-bottom: 30px;
}
.x-sheet-item {
    padding: 18px; font-size: 18px; font-weight: bold; color: #e7e9ea;
    display: flex; align-items: center;
    border-bottom: 1px solid #2f3336; cursor: pointer;
}
.x-sheet-item:active { background: #16181c; }
.x-sheet-cancel {
    padding: 18px; font-size: 18px; font-weight: bold; color: #e7e9ea; text-align: center;
    margin-top: 10px; border-top: 5px solid #202327; cursor: pointer;
}

/* å¼•ç”¨æ¨æ–‡çš„æ¡†æ¡†æ ·å¼ */
.x-quote-box {
    margin-top: 10px; border: 1px solid #2f3336; border-radius: 12px;
    padding: 10px; overflow: hidden; pointer-events: none;
}
/* è½¬å¸–é¡¶éƒ¨çš„ "xxx è½¬å¸–äº†" */
.x-repost-header {
    font-size: 13px; color: #71767b; font-weight: 700;
    display: flex; align-items: center; gap: 5px; 
    margin-bottom: 5px; margin-left: 30px; /* è·Ÿå¤´åƒé”™å¼€ */
}
        /* ä¹¦æ¶æ ·å¼ */
.book-cover {
    width: 100%; aspect-ratio: 2/3; background: #eee; border-radius: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; overflow: hidden;
    cursor: pointer; text-align: center; padding: 10px; transition: transform 0.2s;
}
.book-cover:active { transform: scale(0.95); }
.book-title { font-size: 12px; font-weight: bold; margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.book-author { font-size: 10px; color: #999; }

/* é˜…è¯»å™¨ç‰¹å®š */
#page-reader * { transition: background 0.3s, color 0.3s; }
.reader-btn-chap { border:none; background:rgba(91, 70, 54, 0.1); color:#5b4636; font-size:13px; padding: 8px 12px; border-radius: 8px; font-weight: bold; }
.reader-btn-page { border:none; background:none; color:#5b4636; font-size:16px; padding: 5px 10px; }
.reader-btn-chap:active, .reader-btn-page:active { opacity: 0.6; transform: scale(0.95); }
        /* é˜…è¯»ç¬”è®°å¡ç‰‡ */
.summary-card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border-left: 4px solid #ffcc00; /* ç¬”è®°æœ¬é£æ ¼çš„å·¦è¾¹æ¡† */
}
.sum-chap-title {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
}
.sum-text {
    font-size: 14px;
    color: #555;
    line-height: 1.5;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}
.sum-empty {
    font-size: 12px;
    color: #ccc;
    font-style: italic;
}
    </style>
</head>
<body>

    <div class="phone-frame">
        
        

        <!-- åº•éƒ¨ Home Indicator -->
        <div class="home-indicator" onclick="goHome()"></div>

        <!-- ============ 1. æ¡Œé¢ (Home) ============ -->
        <div class="page active" id="page-home">
            <div class="home-clock-widget">
                <div class="clock-time" id="clockTime">12:00</div>
                <div class="clock-date" id="clockDate">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            </div>
            <!-- âœ¨ æ–°å¢ï¼šå¤©æ°”ç»„ä»¶ (ç‚¹å‡»å¯ä»¥åˆ·æ–°) -->
            <div class="weather-widget" onclick="getWeather()">
                <div class="weather-bg-deco">ğŸŒ¤</div>
                <div class="weather-left">
                    <div class="weather-temp" id="w-temp">--Â°</div>
                    <div class="weather-desc" id="w-desc">ç‚¹å‡»è·å–å¤©æ°”</div>
                    <div class="weather-range" id="w-wind">æ— éœ€å®‰è£…App</div>
                </div>
                <div class="weather-right">
                    <div class="weather-icon" id="w-icon">ğŸ“</div>
                    <div class="weather-loc" id="w-city">æœªå®šä½</div>
                </div>
            </div>
            <!-- âœ¨ æ–°å¢ç»“æŸ -->
            <div class="app-grid">
                <!-- 1. ä¿¡æ¯ (åŠ äº† id="app-icon-msg") -->
                <div class="app-icon-container" onclick="navigateTo('page-msg-list')">
                    <div class="app-icon icon-msg" id="app-icon-msg">ğŸ’¬</div>
                    <div class="app-name">ä¿¡æ¯</div>
                </div>
                <!-- 2. è®°å¿†åº“ (åŠ äº† id="app-icon-mem") -->
                <div class="app-icon-container" onclick="navigateTo('page-memory')">
                    <div class="app-icon icon-note" id="app-icon-mem">ğŸ“</div>
                    <div class="app-name">è®°å¿†åº“</div>
                </div>
                <!-- 3. è®¾ç½® (åŠ äº† id="app-icon-set") -->
                <div class="app-icon-container" onclick="navigateTo('page-settings')">
                    <div class="app-icon icon-settings" id="app-icon-set">âš™ï¸</div>
                    <div class="app-name">è®¾ç½®</div>
                </div>
                <!-- 4. åŸç›¸æœº -> æ”¹æˆ ç¾åŒ– (åŠ äº† id="app-icon-theme") -->
                <div class="app-icon-container" onclick="navigateTo('page-theme')">
                    <div class="app-icon" id="app-icon-theme" style="background: linear-gradient(to bottom, #ff2d55, #ff375f);">ğŸ¨</div>
                    <div class="app-name">ç¾åŒ–</div>
                </div>
                <!-- 5. æ—¥è®°æœ¬ -->
                <div class="app-icon-container" onclick="navigateTo('page-diary')">
                    <div class="app-icon" id="app-icon-diary" style="background: linear-gradient(to bottom, #d4a373, #a98467);">ğŸ“–</div>
                    <div class="app-name">æ—¥è®°æœ¬</div>
                </div>
                <!-- 6. ç•ªèŒ„é’Ÿ (æ–°å¢) -->
                <div class="app-icon-container" onclick="navigateTo('page-pomodoro'); initPomoPage();">
                    <div class="app-icon" id="app-icon-pomo" style="background: linear-gradient(to bottom, #ff6b6b, #ee5253);">ğŸ…</div>
                    <div class="app-name">ç•ªèŒ„é’Ÿ</div>
                </div>
                <!-- 7. æ—¥å† (æ–°å¢) -->
<div class="app-icon-container" onclick="navigateTo('page-calendar'); initCalendarPage();">
    <div class="app-icon" id="app-icon-cal" style="background: #fff; color: #333;">ğŸ“…</div>
    <div class="app-name">æ—¥å†</div>
</div>
                <!-- 8. æ—¥ç¨‹è¡¨ (é€šç”¨ç‰ˆ) -->
                <div class="app-icon-container" onclick="navigateTo('page-schedule'); renderScheduleList();">
                    <!-- æ¢ä¸ªæ›´æœ‰å•†åŠ¡æ„Ÿçš„é¢œè‰²ï¼Œæ¯”å¦‚ç´«è‰²æ¸å˜ï¼Œæˆ–è€…ä¿æŒè“è‰² -->
                    <div class="app-icon" id="app-icon-sched" style="background: linear-gradient(to bottom, #5856d6, #af52de);">ğŸ“…</div>
                    <div class="app-name">æ—¥ç¨‹</div>
                </div>
                <!-- 9. X (Twitter) -->
<div class="app-icon-container" onclick="navigateTo('page-x'); initXApp();">
    <div class="app-icon" id="app-icon-x" style="background: #000; color: white; font-family: sans-serif; font-weight: 900; font-size: 32px;">ğ•</div>
    <div class="app-name">X</div>
</div>
                <!-- 12. å…±è¯» (Co-Reading) -->
<div class="app-icon-container" onclick="navigateTo('page-bookshelf'); loadLibrary();">
    <!-- ç»™å®ƒä¸€ä¸ªä¹¦æœ¬é£æ ¼çš„é¢œè‰²ï¼Œæ¯”å¦‚æ©™æ£•è‰²æ¸å˜ -->
    <div class="app-icon" id="app-icon-book" style="background: linear-gradient(to bottom, #a0522d, #cd853f);">ğŸ“š</div>
    <div class="app-name">å…±è¯»</div>
</div>
            </div>
        </div>

        <!-- ============ 2. æ¶ˆæ¯åˆ—è¡¨ (è”ç³»äºº) ============ -->
        <div class="page" id="page-msg-list">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()"><span>â€¹</span> æ¡Œé¢</button>
                <span class="app-title">ä¿¡æ¯</span>
                <button class="btn-icon-only" onclick="openModal('modal-add-char')" title="æ·»åŠ è§’è‰²" style="font-size: 26px;">+</button>
            </div>
            <div class="msg-list-scroll" id="contactListContainer">
                <!-- åŠ¨æ€åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ============ 3. èŠå¤©çª—å£ ============ -->
        <div class="page" id="page-chat">
            <div class="chat-header-bar">
                <button class="chat-back-btn" onclick="navigateTo('page-msg-list')">
                    <span style="font-size:24px; margin-right:5px;">â€¹</span> ä¿¡æ¯
                </button>
                <span class="chat-contact-name" id="chat-title-name">AI</span>
                <div class="chat-header-actions">
                    <button class="btn-icon-only" onclick="openChatSettings()" title="è§’è‰²è®¾ç½®" style="font-size: 20px;">âš™ï¸</button>
                    <button class="btn-icon-only" onclick="openSummaryModal()" title="æ™ºèƒ½æ€»ç»“" style="font-size: 20px;">âœ¨</button>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                <!-- æ¶ˆæ¯å†…å®¹ -->
            </div>

            <div class="input-area">
                <div id="uploadPreview">
                    <img id="img-preview-blob" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                    <span>å·²é€‰æ‹©å›¾ç‰‡</span>
                    <span onclick="clearUpload()" style="color:red; margin-left:auto; cursor:pointer;">Ã—</span>
                </div>
                <div class="input-toolbar">
                    <button class="btn-send" onclick="document.getElementById('fileInput').click()" style="color:#888;">âŠ•</button>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
                    <input type="text" id="userInput" placeholder="iMessage" onkeypress="if(event.key==='Enter') sendMsg('user')">
                    <button class="btn-send" onclick="sendMsg('user')">â¬†</button>
                    <button class="btn-send" id="btn-ai" onclick="triggerAI()" style="color:#5856D6">ğŸ¤–</button>
                </div>
            </div>
        </div>

        <!-- ============ 4. è®°å¿†åº“ ============ -->
        <div class="page" id="page-memory">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®°å¿†åº“</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
                <div class="ios-group-title">å½“å‰é€‰ä¸­è§’è‰²çš„è®°å¿†</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <input type="text" id="newMemInput" class="ios-input" style="text-align:left;" placeholder="æ‰‹åŠ¨æ·»åŠ è®°å¿†...">
                        <button onclick="addMemoryManual()" style="border:none;background:none;color:#007AFF;font-weight:bold;">+</button>
                    </div>
                </div>
                <div id="memoryListContainer"></div>
            </div>
        </div>

        <!-- ============ 5. å…¨å±€è®¾ç½® ============ -->
        <div class="page" id="page-settings">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">è®¾ç½®</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <div class="ios-group-title">API è¿æ¥</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">API URL</span>
                        <input type="text" id="apiUrl" class="ios-input" placeholder="https://api.openai.com/v1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">API Key</span>
                        <input type="password" id="apiKey" class="ios-input" placeholder="sk-..." onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="testConn()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div class="ios-group-title">æ¨¡å‹é…ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">Model ID</span>
                        <input type="text" id="modelId" class="ios-input" value="gpt-3.5-turbo" onchange="saveGlobalConfig()">
                    </div>
                    <button class="ios-btn" onclick="fetchModels()">â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                    <!-- éšè—çš„ Selectï¼Œç”¨äºæ‹‰å–åé€‰æ‹© -->
                    <div class="ios-item" id="modelSelectContainer" style="display:none;">
                        <span class="ios-label">é€‰æ‹©</span>
                        <select id="modelSelect" class="ios-input" style="direction: rtl;" onchange="document.getElementById('modelId').value=this.value;saveGlobalConfig()">
                        </select>
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ¸©åº¦ (Temperature)</span>
                        <input type="number" id="tempVal" class="ios-input" value="0.7" step="0.1" onchange="saveGlobalConfig()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†è½®æ•° (æ¡æ•°)</span>
                        <input type="number" id="historyLimit" class="ios-input" value="20" step="1" placeholder="é»˜è®¤20" onchange="saveGlobalConfig()">
                    </div>
                </div>

                <div class="ios-group-title">æ•°æ®ç®¡ç†</div>
<div class="ios-list">
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 1ï¼šå‡½æ•°æ”¹æˆ exportDataV2()ï¼Œæ–‡å­—ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹æç¤ºç”¨æˆ· -->
    <button class="ios-btn" onclick="exportDataV2()">å¤‡ä»½æ‰€æœ‰æ•°æ®</button>
    
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 2ï¼šID æ”¹æˆ importFileV2 -->
    <button class="ios-btn" onclick="document.getElementById('importFileV2').click()">æ¢å¤æ•°æ®</button>
    
    <!-- ğŸ”´ ä¿®æ”¹ç‚¹ 3ï¼šID æ”¹æˆ importFileV2ï¼Œå‡½æ•°æ”¹æˆ importDataV2(event) -->
    <input type="file" id="importFileV2" hidden onchange="importDataV2(event)">
    
    <!-- è¿™ä¸ªä¸ç”¨åŠ¨ -->
    <button class="ios-btn danger" onclick="resetAll()">é‡ç½®åº”ç”¨ (æ¸…é™¤æ‰€æœ‰)</button>
</div>
            </div>
        </div>
        <!-- ============ 6. ç¾åŒ–ä¸­å¿ƒ (Theme) ============ -->
        <div class="page" id="page-theme">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç¾åŒ–ä¸­å¿ƒ</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                
                <!-- æ¡Œé¢å£çº¸è®¾ç½® -->
                <div class="ios-group-title" style="margin-top:0;">æ¡Œé¢å£çº¸ (è¾“å…¥å›¾ç‰‡ URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å£çº¸ URL</span>
                        <input type="text" id="wallpaperInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div class="ios-group-title">APP å›¾æ ‡æ›¿æ¢ (è¾“å…¥å›¾ç‰‡URL)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¿¡æ¯å›¾æ ‡</span>
                        <input type="text" id="iconInput-msg" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®°å¿†å›¾æ ‡</span>
                        <input type="text" id="iconInput-mem" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">è®¾ç½®å›¾æ ‡</span>
                        <input type="text" id="iconInput-set" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ç¾åŒ–å›¾æ ‡</span>
                        <input type="text" id="iconInput-theme" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ—¥è®°å›¾æ ‡</span>
                        <input type="text" id="iconInput-diary" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„æ—¥è®°å›¾æ ‡ä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">ç•ªèŒ„é’Ÿå›¾æ ‡</span>
                        <input type="text" id="iconInput-pomo" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <!-- åŸæœ‰çš„ç•ªèŒ„é’Ÿä»£ç åœ¨ä¸Šé¢ -->
                    <div class="ios-item">
                        <span class="ios-label">æ—¥å†å›¾æ ‡</span>
                        <input type="text" id="iconInput-cal" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">æ—¥ç¨‹å›¾æ ‡</span>
                        <input type="text" id="iconInput-sched" class="ios-input" placeholder="http://..." onchange="saveTheme()">
                    </div>
                    <div class="ios-item">
    <span class="ios-label">å…±è¯»å›¾æ ‡</span>
    <input type="text" id="iconInput-book" class="ios-input" placeholder="http://..." onchange="saveTheme()">
</div>
                </div>

                <div class="ios-group-title">å…¨å±€ CSS ä»£ç  (é«˜çº§ç¾åŒ–)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">åœ¨è¿™é‡Œè¾“å…¥ CSS å¯ä»¥æ›¿æ¢æŒ‰é’®ç´ æã€ä¿®æ”¹å­—ä½“ç­‰ã€‚</div>
                <div class="ios-list" style="height: 200px;">
                    <textarea id="customCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" placeholder=".btn-back { ... }" onchange="saveTheme()"></textarea>
                </div>
                <!-- æ°”æ³¡ç¾åŒ–åŒºåŸŸ (æ–°å¢) -->
                <div class="ios-group-title">æ°”æ³¡ç¾åŒ– (CSS)</div>
                <div style="font-size:12px; color:#666; margin:0 15px 5px;">
                    å·¦è¾¹æ˜¯AI(.left)ï¼Œå³è¾¹æ˜¯ç”¨æˆ·(.right)ã€‚<br>
                    ä¾‹å¦‚: border-radius: 0;
                </div>
                <div class="ios-list" style="height: 150px;">
                    <textarea id="bubbleCssInput" style="width:100%; height:100%; border:none; padding:15px; font-family:monospace; font-size:12px; resize:none; outline:none;" 
                    placeholder="/* AI æ°”æ³¡ */
.msg-row.left .message { 
  background: #fff; 
}
/* ç”¨æˆ·æ°”æ³¡ */
.msg-row.right .message { 
  background: #007AFF; 
}" 
                    onchange="saveTheme()"></textarea>
                </div>
                <!-- å­—ä½“è®¾ç½®åŒºåŸŸ -->
                <div class="ios-group-title">å…¨å±€å­—ä½“ (è¾“å…¥ .ttf/.woff é“¾æ¥)</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">å­—ä½“ URL</span>
                        <input type="text" id="fontInput" class="ios-input" placeholder="https://..." onchange="saveTheme()">
                    </div>
                </div>
                <div style="text-align:center; padding:20px;">
                    <button class="ios-btn danger" style="border-radius:10px;" onclick="resetTheme()">é‡ç½®æ‰€æœ‰ç¾åŒ–</button>
                </div>
            </div>
        </div>
        <!-- ============ 7. æ—¥è®°æœ¬ (Diary) ============ -->
        <div class="page" id="page-diary">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">æ—¥è®°æœ¬</span>
                <span style="width:30px;"></span>
            </div>
            <div class="content-scroll">
            
                <!-- æ—¥è®°åˆ—è¡¨å®¹å™¨ -->
                <div id="diaryListContainer"></div>
            </div>
        </div>
        <!-- ============ 8. ç•ªèŒ„é’Ÿ (Pomodoro) ============ -->
        <div class="page" id="page-pomodoro">
            <div class="app-header">
                <button class="btn-icon-text" onclick="quitPomo()">â€¹ ç»“æŸ</button>
                <span class="app-title">ä¸“æ³¨æ¨¡å¼</span>
                <span style="width:50px;"></span>
            </div>
            
            <!-- è®¾ç½®ç•Œé¢ -->
            <div id="pomo-setup" class="content-scroll">
                <div class="ios-group-title" style="margin-top:20px;">é™ªä¼´å¯¹è±¡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">é€‰æ‹©è§’è‰²</span>
                        <select id="pomoCharSelect" class="ios-input" style="direction: rtl;"></select>
                    </div>
                </div>

                <div class="ios-group-title">ä¸“æ³¨è®¾ç½®</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">æ—¶é•¿ (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoDuration" class="ios-input" value="25">
                    </div>
                    <div class="ios-item">
                        <span class="ios-label">ä¸“æ³¨å†…å®¹</span>
                        <input type="text" id="pomoTask" class="ios-input" placeholder="ä¾‹å¦‚: èƒŒå•è¯ã€å†™ä»£ç ">
                    </div>
                </div>

                <div class="ios-group-title">AI äº’åŠ¨é¢‘ç‡</div>
                <div class="ios-list">
                    <div class="ios-item">
                        <span class="ios-label">ä¸»åŠ¨å‘è¨€é—´éš” (åˆ†é’Ÿ)</span>
                        <input type="number" id="pomoInterval" class="ios-input" value="5" placeholder="0ä¸ºä¸ä¸»åŠ¨">
                    </div>
                </div>
                <div style="padding:20px; font-size:12px; color:#999; text-align:center;">
                    å¼€å§‹åï¼Œç‚¹å‡»è§’è‰²å¤´åƒå¯ä»¥â€œæˆ³ä¸€æˆ³â€ï¼ŒTaä¼šæ ¹æ®å‰©ä½™æ—¶é—´å›åº”ä½ ã€‚
                </div>
                <div style="padding:0 20px;">
                    <button class="ios-btn" style="background:#ff3b30; color:#fff; border-radius:12px; font-weight:bold;" onclick="startPomoTimer()">å¼€å§‹ä¸“æ³¨</button>
                </div>
            </div>

            <!-- è¿è¡Œæ—¶ç•Œé¢ (é»˜è®¤éšè—) -->
            <div id="pomo-running" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px; padding-bottom:100px;">
                
                <!-- å€’è®¡æ—¶å¤§å­— -->
                <div id="pomo-timer-display" style="font-size:64px; font-weight:200; font-variant-numeric: tabular-nums;">25:00</div>
                <div id="pomo-task-display" style="font-size:18px; color:#666; margin-bottom:40px;">æ­£åœ¨è¿›è¡Œ: ...</div>

                <!-- è§’è‰²äº’åŠ¨åŒº -->
                <div style="position:relative;">
                    <img id="pomo-avatar" src="" style="width:120px; height:120px; border-radius:50%; border:4px solid #fff; box-shadow:0 10px 30px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.1s;" onclick="pokePomoChar()">
                    <!-- æˆ³ä¸€æˆ³ç‰¹æ•ˆå®¹å™¨ -->
                    <div id="poke-effect" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none; opacity:0; font-size:40px;">ğŸ‘ˆğŸ»</div>
                </div>

                <!-- AI æ°”æ³¡ -->
                <div class="pomo-bubble" id="pomo-ai-bubble">
                    ç‚¹å‡»å¤´åƒæˆ³ä¸€æˆ³æˆ‘ï¼Œæˆ‘ä¼šç›‘ç£ä½ å“¦ï¼
                </div>

            </div>
        </div>
        <!-- ============ 9. æ—¥å† (Calendar) ============ -->
        <div class="page" id="page-calendar">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">ç”Ÿæ´»æ—¥å†</span>
                <button class="btn-icon-only" onclick="jumpToToday()" style="font-size:14px;">ä»Šå¤©</button>
            </div>
            
            <div class="content-scroll" style="background:#fff; padding:0;">
                <!-- æœˆä»½åˆ‡æ¢æ  -->
                <div class="cal-month-nav">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="cal-current-month">2025å¹´ 11æœˆ</span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>

                <!-- æ˜ŸæœŸå¤´ -->
                <div class="cal-week-header">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>

                <!-- æ—¥å†æ ¼å­å®¹å™¨ -->
                <div id="cal-grid" class="cal-grid"></div>

                <!-- é€‰ä¸­æ—¥æœŸçš„è¯¦æƒ…æ“ä½œåŒº -->
                <div id="cal-detail-panel" style="padding:20px; background:#f2f2f7; min-height:300px;">
                    <div class="ios-group-title" id="selected-date-title">è¯·é€‰æ‹©æ—¥æœŸ</div>
                    <div class="ios-list">
                        <!-- çºªå¿µæ—¥/èŠ‚æ—¥è¾“å…¥ -->
                        <div class="ios-item">
                            <span class="ios-label">ç‰¹æ®Šæ—¥å­</span>
                            <input type="text" id="cal-event-input" class="ios-input" placeholder="ä¾‹å¦‚: ç”Ÿæ—¥ã€çºªå¿µæ—¥" onchange="saveCalendarEvent()">
                        </div>
                    </div>

                    <div class="ios-group-title">ç”Ÿç†æœŸè®°å½•</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="togglePeriodMark()">
                            <span class="ios-label">æ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥</span>
                            <div id="period-check-icon" style="font-size:20px; display:none;">ğŸ©¸</div>
                        </div>
                    </div>
                    
                    <div style="padding:15px; font-size:12px; color:#888; line-height:1.5;">
                        * è¯´æ˜ï¼š<br>
                        1. ç‚¹å‡»â€œæ ‡è®°ä¸ºç»æœŸå¼€å§‹æ—¥â€ï¼ŒAI ä¼šè‡ªåŠ¨æ¨ç®—ä½ çš„å‘¨æœŸã€‚<br>
                        2. åœ¨ç‰¹æ®Šæ—¥å­ï¼ŒAI å¯èƒ½ä¼šåœ¨é›¶ç‚¹ç»™ä½ æƒŠå–œã€‚<br>
                        3. ç›®å‰æ•°æ®æ˜¯è·Ÿéšå½“å‰èŠå¤©è§’è‰²çš„ã€‚
                    </div>
                </div>
            </div>
        </div>
        <!-- ============ 10. æ—¥ç¨‹è¡¨ (Schedule) ============ -->
        <div class="page" id="page-schedule">
            <div class="app-header">
                <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
                <span class="app-title">æˆ‘çš„æ—¥ç¨‹</span>
                <span style="width:50px;"></span>
            </div>
            <div class="content-scroll">
                <!-- æ·»åŠ åŒºåŸŸ -->
                <div class="sched-form">
                    <div class="ios-group-title" style="margin:0 0 5px 0;">æ–°å»ºäº‹é¡¹</div>
                    <!-- å ä½ç¬¦æ”¹äº†ï¼Œæš—ç¤ºç”¨æˆ·å¯ä»¥å¡«ä»»ä½•ä¸œè¥¿ -->
                    <input type="text" id="schedName" class="ios-input" style="text-align:left; background:#fff; padding:10px; border-radius:8px;" placeholder="äº‹é¡¹åç§° (å¦‚: é«˜æ•°è¯¾ã€éƒ¨é—¨ä¾‹ä¼šã€å¥èº«)">
                    
                    <div class="sched-row">
                        <select id="schedDay" class="ios-input" style="background:#fff; borderRadius:8px; flex:1;">
                            <option value="1">å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                            <option value="0">å‘¨æ—¥</option>
                        </select>
                        <!-- æ—¶é—´è¾“å…¥æ¡† -->
                        <input type="time" id="schedStart" class="ios-input" value="09:00" style="background:#fff; borderRadius:8px; flex:1;">
                        <span style="padding-top:10px">~</span>
                        <input type="time" id="schedEnd" class="ios-input" value="10:00" style="background:#fff; borderRadius:8px; flex:1;">
                    </div>
                    <button class="ios-btn" onclick="addSchedule()" style="border-radius:8px; background:#5856d6; color:white; border:none;">æ·»åŠ æ—¥ç¨‹</button>
                </div>

                <!-- åˆ—è¡¨åŒºåŸŸ -->
                <div class="ios-group-title">æœ¬å‘¨è®¡åˆ’</div>
                <div id="schedule-list-container" class="schedule-list">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        <!-- ============ 11. X (Twitter) é¡µé¢ (é«˜æ¸…è¿˜åŸç‰ˆ) ============ -->
<div class="page" id="page-x">
    <!-- é¡¶éƒ¨æ  -->
    <!-- é¡¶éƒ¨æ  (æ–°å¸ƒå±€) -->
    <div class="x-header">
        <!-- å·¦è¾¹ï¼šè¿”å›æ¡Œé¢ -->
        <button class="x-header-back" onclick="goHome()">â€¹</button>
        
        <!-- ä¸­é—´ï¼šå½“å‰ç”¨æˆ·å¤´åƒ -->
        <img src="" class="x-header-center-avatar" id="x-current-user-avatar" onclick="openUserProfile()" style="cursor:pointer;">
        
        <!-- å³è¾¹ï¼šæ˜Ÿæ˜Ÿå›¾æ ‡ (ä¿ç•™è£…é¥°) -->
        <svg viewBox="0 0 24 24" class="x-header-right" onclick="triggerPullToRefresh()" style="cursor:pointer;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
    </div>

    <div class="x-refresh-indicator" id="x-refresh-spinner">â†»</div>

    <div class="x-feed" id="x-feed-container">
        <!-- æ¨æ–‡åˆ—è¡¨ -->
    </div>

    <!-- æ‚¬æµ®å‘æ¨æŒ‰é’® (ä¿®å¤ç‰ˆç¾½æ¯›ç¬”) -->
    <div class="x-fab" onclick="openComposeTweet()">
        <svg viewBox="0 0 24 24" class="x-fab-icon"><path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path></svg>
    </div>
    <!-- è½¬æ¨é€‰æ‹©èœå• -->
    <div class="modal-overlay" id="modal-retweet-menu" style="align-items: flex-end;">
        <div class="x-action-sheet">
            <div class="x-sheet-item" onclick="confirmRetweet('repost')">
                <svg viewBox="0 0 24 24" style="width:20px;fill:#fff;margin-right:10px;"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                è½¬å¸–
            </div>
            <div class="x-sheet-item" onclick="confirmRetweet('quote')">
                <svg viewBox="0 0 24 24" style="width:20px;fill:#fff;margin-right:10px;"><path d="M14.23 2.854c.98-.977 2.56-.977 3.54 0l3.38 3.378c.97.977.97 2.559 0 3.536L7.32 23.602l-6.15-1.008 1.01-6.153L14.23 2.854zm1.41 1.414L2.51 17.4l-.5 3.03 3.03-.5 13.13-13.132-2.53-2.53z"></path></svg>
                å¼•ç”¨
            </div>
            <div class="x-sheet-cancel" onclick="closeModal('modal-retweet-menu')">å–æ¶ˆ</div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="x-tab-bar">
        <!-- Home -->
        <button class="x-tab-btn active" onclick="switchXTab('home')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z"></path></svg>
        </button>
        <!-- Search -->
        <button class="x-tab-btn" onclick="switchXTab('search')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></svg>
        </button>
        <!-- Notifications -->
        <button class="x-tab-btn" onclick="switchXTab('notif')" style="position:relative;">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M21.697 16.468c-.02-.016-2.14-1.64-2.103-6.03.02-2.532-.812-4.782-2.347-6.335C15.872 2.71 14.01 1.94 12.005 1.93H11.95c-2.005.01-3.866.78-5.242 2.173-1.534 1.553-2.368 3.802-2.346 6.334.037 4.33-2.02 5.967-2.102 6.03-.26.193-.366.53-.265.838.102.308.39.515.712.515h4.92c.102 2.31 1.997 4.16 4.33 4.16s4.226-1.85 4.33-4.16h4.918c.322 0 .61-.207.712-.515.102-.308-.004-.645-.265-.838zM12 20.478c-1.505 0-2.73-1.177-2.828-2.658h5.656c-.1 1.48-1.323 2.66-2.828 2.66zM4.38 16.32c.74-1.132 1.548-3.028 1.524-5.896-.018-2.16.644-3.982 1.913-5.267C8.91 4.05 10.397 3.437 11.95 3.437h.05c1.552 0 3.04.613 4.133 1.72 1.272 1.285 1.933 3.106 1.915 5.267-.024 2.868.785 4.765 1.525 5.896H4.38z"></path></svg>
            <span class="x-badge" id="x-notif-badge" style="display:none">0</span>
        </button>
        <!-- Messages -->
        <button class="x-tab-btn" onclick="switchXTab('dm')">
            <svg viewBox="0 0 24 24" class="x-tab-icon"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></svg>
        </button>
    </div>
</div>
        <!-- ============ 12. X æ¨æ–‡è¯¦æƒ…é¡µ (è¯„è®ºåŒº) ============ -->
<div class="page" id="page-x-detail" style="background:#000;">
    <!-- è¯¦æƒ…é¡µé¡¶éƒ¨ -->
    <div class="x-header">
        <button class="x-header-back" onclick="closeTweetDetail()">â€¹</button>
        <div style="color:#fff; font-weight:700; font-size:17px;">å¸–å­</div>
        <div style="width:32px;"></div> <!-- å ä½ -->
    </div>

    <!-- æ»šåŠ¨åŒºåŸŸï¼šæ­£æ–‡ + è¯„è®ºåˆ—è¡¨ -->
    <div class="x-feed" id="x-detail-container" style="margin-bottom: 60px;">
        <!-- 1. ä¸»æ¨æ–‡ (JSåŠ¨æ€æ’å…¥) -->
        <div id="x-detail-main-tweet"></div>
        
        <!-- åˆ†å‰²çº¿ -->
        <div style="border-bottom: 1px solid #2f3336; padding: 10px 16px; color:#e7e9ea; font-weight:bold; font-size:18px;">
            å›å¤
        </div>

        <!-- 2. è¯„è®ºåˆ—è¡¨ (JSåŠ¨æ€æ’å…¥) -->
        <div id="x-detail-comments-list"></div>
    </div>

    <!-- åº•éƒ¨å›ºå®šå›å¤æ  -->
    <div class="x-detail-footer">
        <input type="text" id="x-detail-input" class="x-detail-input" placeholder="å‘å¸ƒä½ çš„å›å¤">
        <button class="x-detail-send-btn" onclick="sendDetailReply()">å›å¤</button>
    </div>
</div>
        <!-- ============ 13. X ä¸ªäººä¸»é¡µ (Profile) ============ -->
<div class="page" id="page-x-profile" style="background:#000; z-index: 55;">
    <!-- é¡¶éƒ¨é€æ˜å¯¼èˆª -->
    <div class="x-profile-header">
        <button class="x-header-back-circle" onclick="closeUserProfile()">â€¹</button>
    </div>

    <!-- å°é¢å›¾ -->
    <div class="x-profile-banner" id="x-profile-banner"></div>

    <!-- èµ„æ–™åŒºåŸŸ -->
    <div class="x-profile-info">
        <div class="x-profile-top-row">
            <img src="" class="x-profile-avatar" id="x-profile-avatar">
            <button class="x-edit-profile-btn" onclick="openEditProfile()">ç¼–è¾‘ä¸ªäººèµ„æ–™</button>
        </div>
        
        <div class="x-profile-name-box">
            <span class="x-profile-name" id="x-profile-name">åç§°</span>
            <span id="x-profile-badge"></span> <!-- è®¤è¯æ ‡ -->
        </div>
        <div class="x-profile-handle" id="x-profile-handle">@username</div>
        
        <div class="x-profile-bio" id="x-profile-bio">ç®€ä»‹...</div>
        
        <div class="x-profile-meta">
            <span class="x-meta-item">ğŸ“… <span id="x-profile-join">2023å¹´ åŠ å…¥</span></span>
            <span class="x-meta-item" id="x-profile-location-box" style="display:none">ğŸ“ <span id="x-profile-location"></span></span>
        </div>

        <div class="x-profile-stats">
            <span class="x-stat-num" id="x-profile-following">0</span> <span class="x-stat-label">æ­£åœ¨å…³æ³¨</span>
            <span class="x-stat-num" id="x-profile-followers">0</span> <span class="x-stat-label">å…³æ³¨è€…</span>
        </div>
    </div>
    
    <!-- ç®€å•çš„æ¨æ–‡åˆ—è¡¨å ä½ -->
    <!-- ä¸‹é¢è¿™ä¸ª div æ˜¯ä¸“é—¨ç”¨æ¥æ”¾æ¨æ–‡åˆ—è¡¨çš„ï¼Œå¿…é¡»è¦æœ‰ id -->
    <div id="x-profile-tweets-container" style="border-top:1px solid #2f3336; min-height: 200px; padding-bottom: 50px;"></div>
</div>

<!-- ============ 14. ç¼–è¾‘èµ„æ–™å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-x-edit">
    <div class="modal-box" style="height:80%; top:10%; background:#000; border:1px solid #2f3336;">
        <div class="x-modal-header">
            <button onclick="closeModal('modal-x-edit')">å–æ¶ˆ</button>
            <span style="font-weight:bold; color:#fff;">ç¼–è¾‘èµ„æ–™</span>
            <button style="color:#fff;" onclick="saveUserProfile()">ä¿å­˜</button>
        </div>
        <div class="modal-body" style="background:#000; padding:15px;">
            <div class="x-input-group">
                <label>èƒŒæ™¯å›¾ URL</label>
                <input type="text" id="edit-x-banner" class="x-input">
            </div>
            <div class="x-input-group">
                <label>å¤´åƒ URL</label>
                <input type="text" id="edit-x-avatar" class="x-input">
            </div>
            <div class="x-input-group">
                <label>åç§°</label>
                <input type="text" id="edit-x-name" class="x-input">
            </div>
            <div class="x-input-group">
                <label>ç”¨æˆ·å (@)</label>
                <input type="text" id="edit-x-handle" class="x-input">
            </div>
            <div class="x-input-group">
                <label>ç®€ä»‹ (Bio)</label>
                <textarea id="edit-x-bio" class="x-input" rows="3"></textarea>
            </div>
            <div class="x-input-group">
                <label>ä½ç½®/æ ‡ç­¾</label>
                <input type="text" id="edit-x-location" class="x-input">
            </div>
            <div class="x-flex-row">
                <div class="x-input-group" style="flex:1">
                    <label>æ­£åœ¨å…³æ³¨</label>
                    <input type="number" id="edit-x-following" class="x-input">
                </div>
                <div class="x-input-group" style="flex:1">
                    <label>å…³æ³¨è€…</label>
                    <input type="number" id="edit-x-followers" class="x-input">
                </div>
            </div>
            
            <div class="x-input-group">
                <label>è®¤è¯ç±»å‹</label>
                <select id="edit-x-badge-type" class="x-input" onchange="togglePartnerSelect()">
                    <option value="none">æ— è®¤è¯</option>
                    <option value="blue">å·²è®¤è¯ (è“å‹¾)</option>
                    <option value="gold">å®˜æ–¹è®¤è¯ (é‡‘å‹¾)</option>
                    <option value="couple">æƒ…ä¾£è®¤è¯ (å¿ƒå½¢)</option>
                    <option value="married">å·²å©šè®¤è¯ (åœ†ç¯)</option>
                    <option value="vip">VIP (è±å½¢)</option>
                </select>
            </div>

            <!-- åªæœ‰é€‰æƒ…ä¾£/å·²å©šæ—¶æ˜¾ç¤º -->
            <div class="x-input-group" id="x-partner-select-group" style="display:none;">
                <label>ç»‘å®šå¯¹è±¡ (åªæœ‰é€‰ä¸­çš„è§’è‰²ä¼šæœ‰æ ‡è®°)</label>
                <select id="edit-x-partner" class="x-input">
                    <option value="">-- æ—  --</option>
                </select>
            </div>
        </div>
    </div>
</div>
        <!-- ============ 15. ä¹¦æ¶ (Bookshelf) ============ -->
<div class="page" id="page-bookshelf">
    <div class="app-header">
        <button class="btn-icon-text" onclick="goHome()">â€¹ æ¡Œé¢</button>
        <span class="app-title">å…±è¯»ç©ºé—´</span>
        <button class="btn-icon-only" onclick="document.getElementById('bookFileInput').click()">+</button>
        <input type="file" id="bookFileInput" accept=".txt" hidden onchange="handleBookImport(event)">
    </div>
    <div class="content-scroll">
        <div class="ios-group-title">æˆ‘çš„ä¹¦æ¶</div>
        <div id="bookshelf-container" class="app-grid" style="grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <!-- ä¹¦ç±åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="padding:20px; text-align:center; color:#999; font-size:12px;">
            ç‚¹å‡»å³ä¸Šè§’ + å·å¯¼å…¥ TXT<br>
            ä¹¦ç±æ­£æ–‡å­˜å‚¨äº IndexedDBï¼Œä¸å  LocalStorage
        </div>
    </div>
</div>

<!-- ============ 16. é˜…è¯»å™¨ (Reader) - å‡çº§ç‰ˆ ============ -->
<div class="page" id="page-reader" style="background: #f8f1e5;"> <!-- ç¾Šçš®çº¸èƒŒæ™¯ -->
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="reader-header" style="height:50px; display:flex; align-items:center; justify-content:space-between; padding:0 15px; position:absolute; top:40px; width:100%; z-index:100; color:#5b4636;">
        <button onclick="exitReader()" style="background:none; border:none; font-size:16px; color:#5b4636; font-weight:bold;">â€¹ ä¹¦æ¶</button>
        <span id="reader-title" style="font-weight:bold; font-size:14px; max-width:150px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">ä¹¦å</span>
        <div style="display:flex; gap:15px;">
            <!-- âœ¨âœ¨âœ¨ æ–°å¢è¿™ä¸ªæŒ‰é’®ï¼šæ‰‹åŠ¨è§¦å‘åŒæ­¥ âœ¨âœ¨âœ¨ -->
        <button onclick="manualShareReport()" style="background:none; border:none; font-size:20px;" title="åŒæ­¥é˜…è¯»è¿›åº¦ç»™AI">ğŸ”„</button>
        <!-- âœ¨âœ¨âœ¨ æ–°å¢ç»“æŸ âœ¨âœ¨âœ¨ -->
    <button onclick="openSummaryList()" style="background:none; border:none; font-size:20px;" title="æŸ¥çœ‹é˜…è¯»ç¬”è®°">ğŸ“</button>
    <button onclick="toggleReaderSettings()" style="background:none; border:none; font-size:18px;">Aa</button>
</div>
    </div>

    <!-- æ–‡æœ¬å†…å®¹åŒº -->
    <div id="reader-content" style="position:absolute; top:90px; bottom:70px; left:0; right:0; padding:20px 25px; overflow-y:auto; font-size:19px; line-height:1.8; color:#333; font-family:'Songti SC', serif; text-align:justify; scroll-behavior: smooth;">
        <!-- ç« èŠ‚æ­£æ–‡ -->
    </div>

    <!-- åº•éƒ¨å¯¼èˆª (åŒå±‚æ§åˆ¶) -->
    <div class="reader-footer" style="position:absolute; bottom:0; width:100%; height:70px; background:rgba(248,241,229,0.98); border-top:1px solid rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between; padding:0 15px; padding-bottom:15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
        
        <!-- ä¸Šä¸€ç«  (è·³æ–‡ä»¶) -->
        <button onclick="prevChapter()" class="reader-btn-chap" title="ä¸Šä¸€ç« ">â® ç« </button>
        
        <!-- ä¸Šä¸€é¡µ (æ»šå±) -->
        <button onclick="scrollReader(-1)" class="reader-btn-page" title="ä¸Šä¸€é¡µ">â€¹ é¡µ</button>
        
        <!-- è¿›åº¦ -->
        <span id="reader-progress" style="font-size:12px; color:#999; font-variant-numeric: tabular-nums;">1/10</span>
        
        <!-- ä¸‹ä¸€é¡µ (æ»šå±) -->
        <button onclick="scrollReader(1)" class="reader-btn-page" title="ä¸‹ä¸€é¡µ">é¡µ â€º</button>
        
        <!-- ä¸‹ä¸€ç«  (è·³æ–‡ä»¶ + è§¦å‘æ€»ç»“) -->
        <button onclick="nextChapter()" class="reader-btn-chap" title="ä¸‹ä¸€ç« ">ç«  â­</button>
    </div>

    <!-- AI ä¼´è¯»æ‚¬æµ®çƒ -->
    <div class="reader-ai-bubble" onclick="openReaderChat()" style="position:absolute; bottom:90px; right:20px; width:50px; height:50px; border-radius:50%; background:#fff; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; border:2px solid #5856d6; z-index:200; cursor:pointer;">
        <img id="reader-ai-avatar" src="" style="width:42px; height:42px; border-radius:50%; object-fit:cover;">
    </div>
</div>

<!-- é˜…è¯»å™¨èŠå¤©å¼¹çª— -->
<div class="modal-overlay" id="modal-reader-chat" style="justify-content:flex-end;">
    <div class="modal-box" style="width:100%; height:70%; border-bottom-left-radius:0; border-bottom-right-radius:0;">
        <div class="modal-header" style="display:flex; justify-content:space-between; background:#f2f2f7;">
            <span>ä¸ <span id="reader-chat-partner">AI</span> å…±è¯»</span>
            <button onclick="closeModal('modal-reader-chat')" style="border:none; background:none; font-size:20px;">â†“</button>
        </div>
        <div id="reader-chat-history" style="flex:1; overflow-y:auto; padding:15px; background:#fff;"></div>
        <div class="input-area" style="padding-bottom:max(20px, env(safe-area-inset-bottom));">
            <div class="input-toolbar">
                <input type="text" id="readerChatInput" placeholder="èŠèŠè¿™æ®µå‰§æƒ…..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
                <button class="btn-send" onclick="sendReaderMsg()">â¬†</button>
            </div>
        </div>
    </div>
</div>

        <!-- ============ å¼¹çª—ç»„ä»¶ ============ -->

        <!-- 1. æ·»åŠ è§’è‰²å¼¹çª— -->
        <div class="modal-overlay" id="modal-add-char">
            <div class="modal-box">
                <div class="modal-header">æ–°å»ºè”ç³»äºº</div>
                <div class="modal-body">
                    <div class="ios-list" style="margin: 20px 0; background:transparent;">
                        <div class="ios-item" style="background:#fff; border-radius:10px;">
                            <input type="text" id="newCharName" class="ios-input" style="text-align:center;" placeholder="è¾“å…¥è§’è‰²å§“å">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-add-char')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="addNewCharacter()">åˆ›å»º</button>
                </div>
            </div>
        </div>

        <!-- 2. è§’è‰²è®¾ç½®å¼¹çª— (åœ¨èŠå¤©ç•Œé¢è°ƒå‡º) -->
        <div class="modal-overlay" id="modal-chat-settings">
            <div class="modal-box" style="height: 80%;">
                <div class="modal-header">è§’è‰² & èŠå¤©è®¾ç½®</div>
                <div class="modal-body" style="padding: 15px;">
                    
                    <div class="ios-group-title" style="margin-top:0">å¯¹æ–¹ (AI) èµ„æ–™</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('charAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-char-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="charAvatarFile" hidden onchange="uploadCharAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">å§“å</span>
                            <input type="text" id="set-char-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <!-- æ–°å¢ï¼šä¸»åŠ¨æ‹›å‘¼è®¾ç½® -->
                        <div class="ios-item">
                            <span class="ios-label">ä¸»åŠ¨å‘æ¶ˆæ¯</span>
                            <select id="set-char-interval" class="ios-input" style="direction: rtl;" onchange="saveCurrentCharSettings()">
                                <option value="0">ä»ä¸</option>
                                <option value="2">è¶…è¿‡ 2 å°æ—¶</option>
                                <option value="6">è¶…è¿‡ 6 å°æ—¶</option>
                                <option value="12">è¶…è¿‡ 12 å°æ—¶ (åŠå¤©)</option>
                                <option value="24">è¶…è¿‡ 24 å°æ—¶ (ä¸€å¤©)</option>
                                <option value="48">è¶…è¿‡ 48 å°æ—¶ (ä¸¤å¤©)</option>
                            </select>
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">AI è®¾å®š (System Prompt)</span>
                            <textarea id="set-char-prompt" class="ios-input" style="text-align:left; width:100%; height:80px; border:1px solid #eee; padding:5px; border-radius:5px;" onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">æˆ‘çš„èµ„æ–™ (åœ¨æ­¤èŠå¤©ä¸­)</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="document.getElementById('userAvatarFile').click()">
                            <span class="ios-label">å¤´åƒ</span>
                            <img id="set-user-avatar" src="" style="width:30px; height:30px; border-radius:50%; margin-left:auto;">
                            <input type="file" id="userAvatarFile" hidden onchange="uploadUserAvatar(event)">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">æ˜µç§°</span>
                            <input type="text" id="set-user-name" class="ios-input" onchange="saveCurrentCharSettings()">
                        </div>
                        <div class="ios-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="ios-label" style="margin-bottom:5px;">æˆ‘çš„è®¾å®š (User Persona)</span>
                            <textarea id="set-user-desc" class="ios-input" style="text-align:left; width:100%; height:60px; border:1px solid #eee; padding:5px; border-radius:5px;" placeholder="ä¾‹å¦‚: æˆ‘æ˜¯ä¸€ä¸ªå¥½å¥‡çš„å­¦ç”Ÿ..." onchange="saveCurrentCharSettings()"></textarea>
                        </div>
                    </div>

                    <div class="ios-group-title">å¤–è§‚</div>
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èŠå¤©èƒŒæ™¯</span>
                            <button style="border:none; background:none; color:#007AFF" onclick="document.getElementById('bgFile').click()">æ›´æ¢</button>
                            <button style="border:none; background:none; color:red" onclick="clearChatBg()">è¿˜åŸ</button>
                            <input type="file" id="bgFile" hidden onchange="uploadChatBg(event)">
                        </div>
                    </div>

                    <div class="ios-group-title">èŠå¤©è®°å½•ç®¡ç†</div>
                    <div class="ios-list">
                        <div class="ios-item" onclick="openDeleteMsgModal()">
                            <span class="ios-label" style="color: #ff3b30;">åˆ é™¤èŠå¤©è®°å½•</span>
                            <span style="color:#999; font-size:12px;"> > </span>
                        </div>
                    </div>

                    <button class="ios-btn danger" style="border-radius:12px; margin-bottom:20px;" onclick="deleteCurrentChar()">åˆ é™¤æ­¤è§’è‰²</button>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" style="border:none; width:100%; color:#007AFF;" onclick="closeModal('modal-chat-settings')">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- 3. æ™ºèƒ½æ€»ç»“å¼¹çª— -->
        <div class="modal-overlay" id="modal-summary">
            <div class="modal-box">
                <div class="modal-header">æ™ºèƒ½è®°å¿†æå–</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">é€‰æ‹©èŠå¤©è®°å½•èŒƒå›´ç”Ÿæˆæ‘˜è¦å­˜å…¥è®°å¿†åº“</p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="sum-end" class="ios-input" value="100">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999;">
                        å½“å‰å…±æœ‰ <span id="total-msg-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-summary')">å–æ¶ˆ</button>
                    <button class="modal-btn" onclick="doSummarize()">ç”Ÿæˆå¹¶å­˜å‚¨</button>
                </div>
            </div>
        </div>

        <!-- 4. åˆ é™¤æ¶ˆæ¯å¼¹çª— (æ–°) -->
        <div class="modal-overlay" id="modal-del-msg">
            <div class="modal-box">
                <div class="modal-header" style="color:#ff3b30">æ‰¹é‡åˆ é™¤æ¶ˆæ¯</div>
                <div class="modal-body" style="padding:20px;">
                    <p style="font-size:13px; color:#666; text-align:center; margin-top:0;">
                        è¯·è¾“å…¥è¦åˆ é™¤çš„æ¶ˆæ¯æ¥¼å±‚èŒƒå›´<br>(#æ•°å­—)
                    </p>
                    
                    <div class="ios-list">
                        <div class="ios-item">
                            <span class="ios-label">èµ·å§‹æ¥¼å±‚ (#)</span>
                            <input type="number" id="del-start" class="ios-input" value="1">
                        </div>
                        <div class="ios-item">
                            <span class="ios-label">ç»“æŸæ¥¼å±‚ (#)</span>
                            <input type="number" id="del-end" class="ios-input">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:12px; color:#999; margin-top:10px;">
                        å½“å‰å…±æœ‰ <span id="del-total-count">0</span> æ¡æ¶ˆæ¯
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal('modal-del-msg')">å–æ¶ˆ</button>
                    <button class="modal-btn" style="color:#ff3b30; font-weight:bold;" onclick="commitDeleteMsg()">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>

    </div>
    <!-- ============ æ–°å¢ï¼šå†™æ—¥è®°å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-write-diary">
    <div class="modal-box" style="height: 60%;">
        <div class="modal-header">
            å†™æ—¥è®°
            <!-- ç”¨äºä¸´æ—¶å­˜å‚¨å½“å‰æ˜¯å†™ç»™è°çš„ -->
            <input type="hidden" id="diary-target-char-id">
        </div>
        <div class="modal-body" style="padding:15px; display:flex; flex-direction:column;">
            <div style="margin-bottom:10px; font-size:14px; color:#666;">
                æ”¶ä»¶äºº: <span id="diary-target-name" style="font-weight:bold; color:#000;"></span>
            </div>
            <textarea id="user-diary-input" style="flex:1; border:1px solid #eee; border-radius:10px; padding:10px; font-size:16px; resize:none; outline:none;" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæƒ³å‘Šè¯‰Taçš„äº‹ï¼Ÿ..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-write-diary')">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="submitUserDiary()">ä¿å­˜å¹¶åŒæ­¥</button>
        </div>
    </div>
</div>
    <!-- ============ é˜…è¯»ç¬”è®°å¼¹çª— ============ -->
<div class="modal-overlay" id="modal-book-summary">
    <div class="modal-box">
        <div class="modal-header">
            å‰§æƒ…å›é¡¾ (AI ç¬”è®°)
        </div>
        <div class="modal-body" style="padding:15px; background:#f9f9f9;">
            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="summary-list-content" style="display:flex; flex-direction:column; gap:15px;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-book-summary')" style="color:#007AFF; font-weight:bold;">å…³é—­</button>
        </div>
    </div>
</div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        let globalConfig = {
            apiUrl: "https://api.openai.com/v1",
            apiKey: "",
            model: "gpt-3.5-turbo",
            temp: 0.7,
            historyLimit: 20 
        };

        // è§’è‰²åˆ—è¡¨ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«å®Œæ•´ç‹¬ç«‹çš„æ•°æ®
        let contacts = []; 
        // å½“å‰æ´»è·ƒçš„èŠå¤©ID
        let activeContactId = null;

        // ä¸´æ—¶å›¾ç‰‡
        let currentImg = null;

        // --- åˆå§‹åŒ–ä¸ç”Ÿå‘½å‘¨æœŸ ---
        window.onload = function() {
            startClock();
            loadData();
            if (contacts.length === 0) {
                // é»˜è®¤åˆ›å»ºä¸€ä¸ªè§’è‰²
                createCharacter("AI Assistant", "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚", "https://api.dicebear.com/7.x/bottts/svg?seed=Default");
            }
            updateContactList();
            updateGlobalSettingsUI();
            loadTheme();
        };

        // --- æ•°æ®æŒä¹…åŒ– ---
        function saveData() {
            localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
            localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
        }

        function loadData() {
            const c = localStorage.getItem('ai_phone_config');
            if(c) globalConfig = JSON.parse(c);
            
            const ct = localStorage.getItem('ai_phone_contacts');
            if(ct) contacts = JSON.parse(ct);
        }

        function createCharacter(name, prompt, avatar) {
            const id = Date.now().toString();
            const newChar = {
                id: id,
                name: name,
                avatar: avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                systemPrompt: prompt || "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚",
                userName: "æˆ‘",
                userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
                userPersona: "", // ç”¨æˆ·åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„äººè®¾
                bgImage: "",     // èŠå¤©èƒŒæ™¯
                messages: [],
                memories: [],
                diaries: [],
                userDiaries: [],
                // --- æ–°å¢ï¼šæ—¥å†ä¸ç”Ÿç†æœŸæ•°æ® ---
                calendarEvents: {}, // æ ¼å¼: { "2025-11-21": "çºªå¿µæ—¥" }
                periodLog: [],      // æ ¼å¼: ["2025-10-01", "2025-11-28"] (è®°å½•ç»æœŸå¼€å§‹çš„æ—¥å­)
                // --- æ–°å¢å­—æ®µ ---
                autoReplyInterval: 0, // é»˜è®¤ä¸ä¸»åŠ¨
                lastActiveTime: Date.now()
            };
            contacts.push(newChar);
            saveData();
            return id;
        }

        // --- é¡µé¢å¯¼èˆª ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            const bar = document.getElementById('statusBar');
            const indicator = document.querySelector('.home-indicator');
            
            if(pageId === 'page-home') {
                // bar.style.color = 'white';
                indicator.style.backgroundColor = 'white';
            } else {
                // bar.style.color = 'black';
                indicator.style.backgroundColor = 'black';
            }
            // âœ¨âœ¨âœ¨ã€åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œä»£ç ã€‘âœ¨âœ¨âœ¨
    // å¦‚æœè¿›å…¥çš„æ˜¯æ¶ˆæ¯åˆ—è¡¨é¡µï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
    if(pageId === 'page-msg-list') {
        updateContactList();
    }

            if(pageId === 'page-chat' && activeContactId) {
                renderChat(activeContactId);
            }
            if(pageId === 'page-memory' && activeContactId) {
                renderMemories();
            } else if (pageId === 'page-memory' && !activeContactId) {
                document.getElementById('memoryListContainer').innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">è¯·å…ˆä»ä¿¡æ¯åˆ—è¡¨è¿›å…¥ä¸€ä¸ªèŠå¤©</p>';
            }
            // --- æ–°å¢ï¼šè¿›å…¥æ—¥è®°æœ¬æ—¶åˆ·æ–°åˆ—è¡¨ ---
            if (pageId === 'page-diary') {
                renderDiaries();
            }
        }

        function goHome() { navigateTo('page-home'); }

        // --- 1. è”ç³»äººåˆ—è¡¨é€»è¾‘ ---
        function updateContactList() {
            const container = document.getElementById('contactListContainer');
            container.innerHTML = '';
            
            // æŒ‰æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´æ’åºï¼ˆå¯é€‰ï¼Œè¿™é‡Œæš‚ä¸å¤æ‚åŒ–ï¼‰
            contacts.forEach(c => {
                // å¢åŠ å®¹é”™ï¼šå¦‚æœmessagesä¸å­˜åœ¨ï¼Œç»™ç©ºæ•°ç»„
                if(!c.messages) c.messages = [];
                
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : "ç‚¹å‡»å¼€å§‹èŠå¤©...";
                const previewText = lastMsg.startsWith('data:image') ? '[å›¾ç‰‡]' : lastMsg;
                
                const div = document.createElement('div');
                div.className = 'msg-list-item';
                div.onclick = () => enterChat(c.id);
                div.innerHTML = `
                    <img src="${c.avatar}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-name">${c.name}</div>
                        <div class="list-preview">${previewText}</div>
                    </div>
                    <div class="list-time"> > </div>
                `;
                container.appendChild(div);
            });
        }

        function enterChat(id) {
            activeContactId = id;
            navigateTo('page-chat');
            processAutoReplyChain(id);
            const char = contacts.find(c => c.id === id);
            if(char) checkAndSendHolidayGreeting(char);
        }

        function addNewCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            if(!name) return alert("è¯·è¾“å…¥åå­—");
            createCharacter(name);
            closeModal('modal-add-char');
            document.getElementById('newCharName').value = '';
            updateContactList();
        }

        // --- 2. èŠå¤©é€»è¾‘ ---
        function getActiveChar() {
            return contacts.find(c => c.id === activeContactId);
        }

        function renderChat(id) {
            const char = contacts.find(c => c.id === id);
            if(!char) return;

            document.getElementById('chat-title-name').innerText = char.name;
            
            // è®¾ç½®èƒŒæ™¯
            const page = document.getElementById('page-chat');
            if(char.bgImage) {
                page.style.backgroundImage = `url(${char.bgImage})`;
            } else {
                page.style.backgroundImage = '';
            }

            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if(!char.messages || char.messages.length === 0) {
                box.innerHTML = `<div style="text-align:center;font-size:12px;color:#999;margin:20px;">ä¸ ${char.name} å¼€å§‹æ–°çš„å¯¹è¯</div>`;
            } else {
                char.messages.forEach((m, index) => {
                    appendMsgUI(m.role, m.content, m.image, index + 1, false, m.timestamp);
                });
            }
            scrollToBottom();
        }

        // --- æ›¿æ¢åçš„ appendMsgUI å‡½æ•° (åŒ…å«é‡è¦ä¿®å¤) ---
        function appendMsgUI(role, text, img, index, isTemp=false, timestamp=null) {
            const char = getActiveChar();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg-row ${role==='user'?'right':'left'}`;
            
            const avatarUrl = role==='user' ? char.userAvatar : char.avatar;
            
            // å¤„ç†å³é”®/åŒå‡»äº‹ä»¶
            let extraHtml = '';
            let eventAttr = '';
            if (role === 'user' && !isTemp) {
                eventAttr = `ondblclick="handleUserEdit(event, ${index}); return false;"`;
            } else if (role === 'assistant' && !isTemp) {
                extraHtml = ``;
            }

            // --- æ—¶é—´æˆ³å¤„ç†é€»è¾‘ (ä¿®å¤Safari Invalid Dateé”™è¯¯) ---
            let timeStr = "";
            if (timestamp) {
                const date = new Date(timestamp);
                // é‡è¦ä¿®å¤ï¼šæ£€æµ‹æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼Œæ—§æ•°æ®å¯èƒ½æ²¡æœ‰æ—¶é—´æˆ³æˆ–æ ¼å¼ä¸å…¼å®¹
                if (!isNaN(date.getTime())) {
                    try {
                        timeStr = date.toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                    } catch(e) {
                        console.warn("Date format error", e);
                    }
                }
            } else if (isTemp) {
                timeStr = "å‘é€ä¸­...";
            }

            let html = `
                <span class="msg-index">#${index || '?'}</span>
                <img src="${avatarUrl}" class="avatar">
                <div class="message" ${eventAttr}>
                    ${img ? `<img src="${img}" style="max-width:100%;border-radius:8px;display:block;margin-bottom:5px;">` : ''}
                    <span class="txt-content">${isTemp ? text : formatText(text)}</span>
                    
                    <!-- æ’å…¥æ—¶é—´æˆ³ -->
                    <span class="msg-time-stamp">${timeStr}</span>
                </div>
            `;
            
            div.innerHTML = html + extraHtml;
            box.appendChild(div);
            scrollToBottom();
            return div.querySelector('.txt-content'); 
        }

        async function sendMsg(role) {
            const char = getActiveChar();
            if(!char) return;

            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            
            if(!txt && !currentImg) return;

            // ç”¨æˆ·æ¶ˆæ¯
            const newMsg = { role: 'user', content: txt, image: currentImg, timestamp: Date.now() };
            char.messages.push(newMsg);
            saveData(); // ä¿å­˜æ•°æ®
            
            appendMsgUI('user', txt, currentImg, char.messages.length);
            
            input.value = '';
            clearUpload();
            
            // è§¦å‘ AI å›å¤ (åœ¨ sendMsg å†…éƒ¨è°ƒç”¨ triggerAI)
            setTimeout(triggerAI, 100); // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹é¿å…UIå¡é¡¿
        }

        async function triggerAI() {
            const char = getActiveChar();
            if(!char) return;
            if(!globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

            const btn = document.getElementById('btn-ai');
            
            // === âœ¨ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½é‡åˆ·é€»è¾‘ START ===
            // 1. æ£€æŸ¥æœ‰æ²¡æœ‰æ¶ˆæ¯
            if (char.messages.length > 0) {
                const lastIndex = char.messages.length - 1;
                const lastMsg = char.messages[lastIndex];
                
                // 2. å¦‚æœæœ€åä¸€æ¡æ˜¯ AI (assistant) å‘çš„ï¼Œè¯´æ˜æ˜¯é‡åˆ·
                if (lastMsg.role === 'assistant') {
                    // ä»æ•°ç»„ä¸­å½»åº•åˆ é™¤è¿™ä¸€æ¡
                    char.messages.pop(); 
                    // ç«‹å³ä¿å­˜æ•°æ®ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±
                    saveData(); 
                    // 3. å…³é”®ï¼šç«‹å³åˆ·æ–°ç•Œé¢ï¼Œè®©æ—§æ°”æ³¡åœ¨è§†è§‰ä¸Šç«‹åˆ»æ¶ˆå¤±
                    renderChat(activeContactId); 
                }
            }
            // === âœ¨ æ™ºèƒ½é‡åˆ·é€»è¾‘ END ===

            // å˜æˆæ‰“å­—æœºåŠ¨ç”» (é˜²æ­¢é‡å¤ç‚¹å‡»)
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span>';
            btn.disabled = true;

            // --- æ„å»º Prompt (å’Œä¹‹å‰ä¿æŒä¸€è‡´) ---
            let systemPromptFull = char.systemPrompt + `\n[å½“å‰æ—¶é—´: ${new Date().toLocaleString()}]\n[ç”¨æˆ·åç§°: ${char.userName}]`;
            if(char.userPersona) systemPromptFull += `\n[ç”¨æˆ·è®¾å®š: ${char.userPersona}]`;
            systemPromptFull += getStatusContext(char);
            
            // å–‚å…¥æ—¥è®°
            if (char.diaries && char.diaries.length > 0) {
                const recentDiaries = char.diaries.slice(-6).join('\n\n---\n\n');
                systemPromptFull += `\n\n[æˆ‘çš„ç§å¯†æ—¥è®°æœ¬ (åªæœ‰æˆ‘è‡ªå·±èƒ½çœ‹ï¼Œç”¨äºå›å¿†ä¹‹å‰çš„ç»å†å’Œå¿ƒæƒ…)]:\n${recentDiaries}`;
            }
            // å–‚å…¥è®°å¿†
            if(char.memories.length > 0) {
                systemPromptFull += `\n[é•¿æœŸè®°å¿†åº“]:\n${char.memories.join('\n')}`;
            }

            let apiMsgs = [{role: "system", content: systemPromptFull}];
            
            // æ„å»ºæ¶ˆæ¯å†å²
            const limit = globalConfig.historyLimit || 20;
            const history = char.messages.slice(-limit);
            
            history.forEach(m => {
                if(m.image) {
                    apiMsgs.push({
                        role: m.role,
                        content: [
                            { type: "text", text: m.content || " " },
                            { type: "image_url", image_url: { url: m.image } }
                        ]
                    });
                } else {
                    apiMsgs.push({ role: m.role, content: m.content });
                }
            });

            // UI å ä½ (ç°åœ¨å±å¹•ä¸Šåº”è¯¥æ˜¯å¹²å‡€çš„ï¼Œè¿™ä¸ªå ä½ç¬¦ä¼šå‡ºç°åœ¨æœ€ä¸‹æ–¹)
            const aiMsgIndex = char.messages.length + 1;
            const aiUiSpan = appendMsgUI('assistant', '...', null, aiMsgIndex, true);
            let fullText = "";

            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: apiMsgs,
                        temperature: parseFloat(globalConfig.temp),
                        stream: true
                    })
                });

                if(!res.ok) throw new Error(res.statusText);

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.replace('data: ',''));
                                const delta = json.choices[0].delta.content || "";
                                fullText += delta;
                                aiUiSpan.innerHTML = formatText(fullText);
                                scrollToBottom();
                            } catch(e){}
                        }
                    }
                }
                
                // ä¿å­˜ AI å›å¤ (åŠ ä¸Šæ—¶é—´æˆ³)
                char.messages.push({ role: 'assistant', content: fullText, timestamp: Date.now() });
                saveData();
                
                // å†æ¬¡åˆ·æ–°ä»¥ç¡®ä¿æ ¼å¼æ­£ç¡® (ç‰¹åˆ«æ˜¯æ—¶é—´æˆ³æ˜¾ç¤º)
                renderChat(activeContactId); 

            } catch(e) {
                aiUiSpan.innerText = "Error: " + e.message;
                // å¦‚æœå‡ºé”™ï¼Œä¹ŸæŠŠé”™è¯¯å­˜è¿›å»ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©ä¸å­˜
                char.messages.push({ role: 'assistant', content: "Error: " + e.message });
                saveData();
            }

            btn.innerHTML = originalBtnContent;
            btn.disabled = false;
        }

        // --- 3. æ™ºèƒ½æ€»ç»“åŠŸèƒ½ ---
        function openSummaryModal() {
            const char = getActiveChar();
            if(!char) return;
            document.getElementById('total-msg-count').innerText = char.messages.length;
            
            // é»˜è®¤é€‰ä¸­æœ€è¿‘ 20 æ¡ï¼Œæˆ–è€…å…¨éƒ¨
            const total = char.messages.length;
            const start = Math.max(1, total - 20);
            document.getElementById('sum-start').value = start;
            document.getElementById('sum-end').value = total;
            
            openModal('modal-summary');
        }

        async function doSummarize() {
            const char = getActiveChar();
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœè€è§’è‰²æ²¡æœ‰æ—¥è®°æ•°ç»„ï¼Œç»™å®ƒåŠ ä¸€ä¸ª
            if (!char.diaries) char.diaries = [];

            const startIdx = parseInt(document.getElementById('sum-start').value) - 1;
            const endIdx = parseInt(document.getElementById('sum-end').value);
            
            if(startIdx < 0 || endIdx > char.messages.length || startIdx >= endIdx) {
                alert("æ¥¼å±‚èŒƒå›´æ— æ•ˆ");
                return;
            }

            const selectedMsgs = char.messages.slice(startIdx, endIdx);
            // æŠŠå¯¹è¯è½¬æ¢æˆæ–‡æœ¬ä¾› AI é˜…è¯»
            const textBlock = selectedMsgs.map(m => `${m.role === 'user' ? 'æˆ‘(ç”¨æˆ·)' : char.name}: ${m.content}`).join('\n');

            closeModal('modal-summary');
            const btn = document.querySelector('.chat-header-actions button:last-child');
            const oldIcon = btn.innerHTML;
            btn.innerText = "âœï¸"; // å˜æˆå†™å­—å›¾æ ‡

            try {
                // --- è¿™é‡Œæ˜¯æ ¸å¿ƒä¿®æ”¹ï¼šæç¤ºè¯æ”¹æˆäº†å†™æ—¥è®° ---
                const prompt = `è¯·é˜…è¯»ä»¥ä¸‹èŠå¤©è®°å½•ï¼Œä»¥è§’è‰² "${char.name}" çš„ç¬¬ä¸€äººç§°è§†è§’å†™ä¸€ç¯‡ç®€çŸ­çš„æ—¥è®°ã€‚
                è¦æ±‚ï¼š
                1. åŒ…å«èŠå¤©çš„ä¸»è¦å†…å®¹ï¼Œä½†è¦åŠ å…¥è§’è‰²çš„å†…å¿ƒç‹¬ç™½ã€æƒ…ç»ªå’Œå¯¹ç”¨æˆ·çš„çœ‹æ³•ã€‚
                2. æ ¼å¼ä¸ºï¼šâ€œ[æ—¥æœŸ] ä»Šå¤©...â€ (å¦‚æœæ˜¯æ·±å¤œèŠå¤©å¯ä»¥ç”¨â€œæ·±å¤œ...â€)ã€‚
                3. ç¯‡å¹…ä¸è¦å¤ªé•¿ï¼ŒåƒçœŸå®çš„æ‰‹æœºå¤‡å¿˜å½•æ—¥è®°ä¸€æ ·ã€‚
                
                èŠå¤©è®°å½•ï¼š
                ${textBlock}`;

                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: globalConfig.model,
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ“…é•¿æ¨¡ä»¿äººç±»æƒ…æ„Ÿå’Œå†…å¿ƒæˆçš„å°è¯´å®¶ã€‚" },
                            { role: "user", content: prompt }
                        ]
                    })
                });
                const data = await res.json();
                const diaryEntry = data.choices[0].message.content;
                
                // å­˜å…¥æ—¥è®°æ•°ç»„
                char.diaries.push(diaryEntry);
                saveData();
                alert("æ—¥è®°å·²å†™å¥½ï¼Œå¿«å»æ—¥è®°æœ¬APPæŸ¥çœ‹å§ï¼");
            } catch(e) {
                alert("å†™æ—¥è®°å¤±è´¥: " + e.message);
            }
            btn.innerHTML = oldIcon;
        }

        // --- 4. è§’è‰²è®¾ç½®ä¸è®°å¿†åº“ ---
        function openChatSettings() {
            const char = getActiveChar();
            if(!char) return;
            
            document.getElementById('set-char-name').value = char.name;
            document.getElementById('set-char-prompt').value = char.systemPrompt;
            document.getElementById('set-char-avatar').src = char.avatar;
            
            document.getElementById('set-user-name').value = char.userName;
            document.getElementById('set-user-desc').value = char.userPersona || "";
            document.getElementById('set-user-avatar').src = char.userAvatar;
            document.getElementById('set-char-interval').value = char.autoReplyInterval || 0;
            
            openModal('modal-chat-settings');
        }

        function saveCurrentCharSettings() {
        const char = getActiveChar();
        if(!char) return;
        
        char.name = document.getElementById('set-char-name').value;
        char.systemPrompt = document.getElementById('set-char-prompt').value;
        char.userName = document.getElementById('set-user-name').value;
        char.userPersona = document.getElementById('set-user-desc').value;
        char.autoReplyInterval = parseInt(document.getElementById('set-char-interval').value) || 0;
        
        document.getElementById('chat-title-name').innerText = char.name;
        saveData();

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        updateContactList();        // åˆ·æ–°å¤–é¢çš„åˆ—è¡¨
        renderChat(activeContactId); // åˆ·æ–°é‡Œé¢çš„æ°”æ³¡
    }

    async function uploadCharAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().avatar = b64;
        document.getElementById('set-char-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }

    async function uploadUserAvatar(e) {
        const f = e.target.files[0]; 
        if(!f) return;
        const b64 = await fileToBase64(f);
        getActiveChar().userAvatar = b64;
        document.getElementById('set-user-avatar').src = b64;
        saveData(); 
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œçš„æ›´æ–°éå¸¸é‡è¦ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        renderChat(activeContactId);
        updateContactList();
    }
        async function uploadChatBg(e) {
            const b64 = await fileToBase64(e.target.files[0]);
            getActiveChar().bgImage = b64;
            document.getElementById('page-chat').style.backgroundImage = `url(${b64})`;
            saveData();
        }

        function clearChatBg() {
            getActiveChar().bgImage = "";
            document.getElementById('page-chat').style.backgroundImage = '';
            saveData();
        }

        function deleteCurrentChar() {
            if(confirm("ç¡®å®šåˆ é™¤è¯¥è§’è‰²åŠæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                contacts = contacts.filter(c => c.id !== activeContactId);
                activeContactId = null;
                saveData();
                closeModal('modal-chat-settings');
                updateContactList();
                navigateTo('page-msg-list');
            }
        }

        // è®°å¿†åº“æ¸²æŸ“
        function renderMemories() {
            const char = getActiveChar();
            const c = document.getElementById('memoryListContainer'); 
            c.innerHTML = '';
            
            if(!char) return;
            
            if(!char.memories) char.memories = []; // å…¼å®¹æ—§æ•°æ®

            char.memories.forEach((m, i) => {
                c.innerHTML += `
                    <div class="memory-card">
                        ${m}
                        <div class="btn-del-mem" onclick="deleteMemory(${i})">Ã—</div>
                    </div>`;
            });
        }
        function addMemoryManual() {
            const char = getActiveChar();
            const input = document.getElementById('newMemInput');
            if(input.value && char) {
                char.memories.push(input.value);
                input.value = '';
                saveData(); renderMemories();
            }
        }
        function deleteMemory(index) {
            const char = getActiveChar();
            if(char) {
                char.memories.splice(index, 1);
                saveData(); renderMemories();
            }
        }

        // --- 5. å…¨å±€è®¾ç½®é€»è¾‘ ---
        function updateGlobalSettingsUI() {
            document.getElementById('apiUrl').value = globalConfig.apiUrl;
            document.getElementById('apiKey').value = globalConfig.apiKey;
            document.getElementById('modelId').value = globalConfig.model;
            document.getElementById('tempVal').value = globalConfig.temp;
            document.getElementById('historyLimit').value = globalConfig.historyLimit || 20;
        }
        
        function saveGlobalConfig() {
            globalConfig.apiUrl = document.getElementById('apiUrl').value;
            globalConfig.apiKey = document.getElementById('apiKey').value;
            globalConfig.model = document.getElementById('modelId').value;
            globalConfig.temp = document.getElementById('tempVal').value;
            globalConfig.historyLimit = parseInt(document.getElementById('historyLimit').value) || 20;
            saveData();
        }
        // --- ç¾åŒ–/ä¸»é¢˜ç³»ç»Ÿ (ç»ˆæç‰ˆ: å›¾æ ‡+å­—ä½“+å£çº¸) ---
    let themeConfig = {
            icons: { msg: "", mem: "", set: "", theme: "", diary: "", pomo: "", cal: "", sched: "", book: "" },
            customCss: "",
            bubbleCss: "",
            customFont: "",
            homeWallpaper: "" 
        };

    function loadTheme() {
        try {
            const t = localStorage.getItem('ai_phone_theme');
            if(t) themeConfig = JSON.parse(t);

            // 1. æ¢å¤å›¾æ ‡
            const iconMsg = document.getElementById('iconInput-msg');
            if(iconMsg) iconMsg.value = themeConfig.icons.msg || "";
            
            const iconMem = document.getElementById('iconInput-mem');
            if(iconMem) iconMem.value = themeConfig.icons.mem || "";
            
            const iconSet = document.getElementById('iconInput-set');
            if(iconSet) iconSet.value = themeConfig.icons.set || "";
            
            const iconTheme = document.getElementById('iconInput-theme');
            if(iconTheme) iconTheme.value = themeConfig.icons.theme || "";
            
            const iconDiary = document.getElementById('iconInput-diary');
            if(iconDiary) iconDiary.value = themeConfig.icons.diary || "";
            
            const iconPomo = document.getElementById('iconInput-pomo');
            if(iconPomo) iconPomo.value = themeConfig.icons.pomo || "";

            const iconCal = document.getElementById('iconInput-cal');
        if(iconCal) iconCal.value = themeConfig.icons.cal || "";

            const iconSched = document.getElementById('iconInput-sched');
            if(iconSched) iconSched.value = themeConfig.icons.sched || "";

            const iconBook = document.getElementById('iconInput-book');
if(iconBook) iconBook.value = themeConfig.icons.book || "";

            // 2. æ¢å¤CSSå’Œå­—ä½“
            const cssInput = document.getElementById('customCssInput');
            if(cssInput) cssInput.value = themeConfig.customCss || "";

            // --- å…³é”®ç‚¹ï¼šé˜²æ­¢æŠ¥é”™ï¼Œå…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ ---
            const bubbleInput = document.getElementById('bubbleCssInput');
            if(bubbleInput) bubbleInput.value = themeConfig.bubbleCss || "";

            const fontInput = document.getElementById('fontInput');
            if(fontInput) fontInput.value = themeConfig.customFont || "";
            
            // 3. æ¢å¤å£çº¸
            const wpInput = document.getElementById('wallpaperInput');
            if(wpInput) wpInput.value = themeConfig.homeWallpaper || "";

            applyThemeUI();
        } catch(e) {
            console.error("åŠ è½½ä¸»é¢˜å‡ºé”™ï¼Œä½†è¿™ä¸å½±å“æ•°æ®å®‰å…¨", e);
        }
    }

    function saveTheme() {
        // ä½¿ç”¨å¯é€‰é“¾ (?.) é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
        themeConfig.icons.msg = document.getElementById('iconInput-msg')?.value || "";
        themeConfig.icons.mem = document.getElementById('iconInput-mem')?.value || "";
        themeConfig.icons.set = document.getElementById('iconInput-set')?.value || "";
        themeConfig.icons.theme = document.getElementById('iconInput-theme')?.value || "";
        themeConfig.icons.diary = document.getElementById('iconInput-diary')?.value || "";
        themeConfig.icons.pomo = document.getElementById('iconInput-pomo')?.value || "";
        themeConfig.icons.cal = document.getElementById('iconInput-cal')?.value || "";
        themeConfig.icons.sched = document.getElementById('iconInput-sched')?.value || "";
        themeConfig.icons.book = document.getElementById('iconInput-book')?.value || "";
        
        themeConfig.customCss = document.getElementById('customCssInput')?.value || "";
        themeConfig.bubbleCss = document.getElementById('bubbleCssInput')?.value || ""; // æ°”æ³¡ç¾åŒ–
        
        const fontInput = document.getElementById('fontInput');
        if(fontInput) themeConfig.customFont = fontInput.value;
        
        const wpInput = document.getElementById('wallpaperInput');
        if(wpInput) themeConfig.homeWallpaper = wpInput.value;

        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
        applyThemeUI();
    }

    function applyThemeUI() {
        // A. åº”ç”¨å›¾æ ‡
        updateAppIcon('app-icon-msg', themeConfig.icons.msg);
        updateAppIcon('app-icon-mem', themeConfig.icons.mem);
        updateAppIcon('app-icon-set', themeConfig.icons.set);
        updateAppIcon('app-icon-theme', themeConfig.icons.theme);
        updateAppIcon('app-icon-diary', themeConfig.icons.diary);
        updateAppIcon('app-icon-pomo', themeConfig.icons.pomo);
        updateAppIcon('app-icon-cal', themeConfig.icons.cal);
        updateAppIcon('app-icon-sched', themeConfig.icons.sched);
        updateAppIcon('app-icon-book', themeConfig.icons.book);

        // B. åº”ç”¨å£çº¸
        const homePage = document.getElementById('page-home');
        if (themeConfig.homeWallpaper && themeConfig.homeWallpaper.trim() !== "") {
            homePage.style.backgroundImage = `url(${themeConfig.homeWallpaper})`;
        } else {
            homePage.style.backgroundImage = "url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop')";
        }

        // C. åº”ç”¨å­—ä½“å’ŒCSS
        let styleTag = document.getElementById('user-custom-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'user-custom-style';
            document.head.appendChild(styleTag);
        }

        let finalCss = themeConfig.customCss || "";
        // åªæœ‰å½“æœ‰å­—ä½“æ—¶æ‰æ‹¼æ¥å­—ä½“è§„åˆ™
        if (themeConfig.customFont && themeConfig.customFont.trim() !== "") {
            const fontRule = `
                @font-face { font-family: 'UserCustomFont'; src: url('${themeConfig.customFont}'); font-display: swap; }
                body, button, input, textarea, select, .clock-time, .app-title, .chat-contact-name { font-family: 'UserCustomFont', -apple-system, sans-serif !important; }
            `;
            finalCss = fontRule + "\n" + finalCss;
        }
        styleTag.innerHTML = finalCss;

        // D. åº”ç”¨æ°”æ³¡ç¾åŒ– (ç‹¬ç«‹æ ·å¼æ ‡ç­¾) - ã€ä¿®å¤ï¼šç§»åˆ°äº†ifå¤–é¢ã€‘
        let bubbleStyleTag = document.getElementById('user-bubble-style');
        if (!bubbleStyleTag) {
            bubbleStyleTag = document.createElement('style');
            bubbleStyleTag.id = 'user-bubble-style';
            document.head.appendChild(bubbleStyleTag);
        }
        bubbleStyleTag.innerHTML = themeConfig.bubbleCss || "";
    }

    function updateAppIcon(elementId, url) {
        const el = document.getElementById(elementId);
        if(!el) return;
        if (url && url.trim() !== "") {
            el.style.backgroundImage = `url(${url})`;
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            el.style.color = 'transparent';
        } else {
            el.style.backgroundImage = '';
            el.style.color = 'white';
        }
    }

    function resetTheme() {
        if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®å—ï¼Ÿ")) {
            localStorage.removeItem('ai_phone_theme');
            location.reload();
        }
    }

        async function fetchModels() {
            if(!globalConfig.apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
            const btn = event.target;
            btn.innerText = "åŠ è½½ä¸­...";
            try {
                const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/models', {
                    headers: { "Authorization": "Bearer " + globalConfig.apiKey }
                });
                const data = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ¨¡å‹</option>';
                
                // å…¼å®¹ OpenAI å’Œ å…¼å®¹æ¥å£çš„è¿”å›æ ¼å¼
                const list = data.data || data; 
                if(Array.isArray(list)) {
                    list.sort((a,b) => a.id.localeCompare(b.id));
                    list.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.innerText = m.id;
                        select.appendChild(opt);
                    });
                    document.getElementById('modelSelectContainer').style.display = 'flex';
                } else {
                    alert("API è¿”å›æ ¼å¼æœªèƒ½è¯†åˆ«");
                }
            } catch(e) {
                alert("è·å–æ¨¡å‹å¤±è´¥: " + e.message);
            }
            btn.innerText = "â¬‡ï¸ æ‹‰å–æ¨¡å‹åˆ—è¡¨";
        }

        function resetAll() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- å·¥å…·å‡½æ•° ---
        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }
        function closeModal(id) { 
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 200);
        }
        function formatText(text) { return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); }
        function normalizeUrl(u) { return u.endsWith('/') ? u.slice(0,-1) : u; }
        function scrollToBottom() { const b = document.getElementById('chatBox'); b.scrollTop = b.scrollHeight; }
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const t = now.toLocaleTimeString('zh-CN', {hour12:false,hour:'2-digit',minute:'2-digit'});
                document.getElementById('clockTime').innerText = t;
                document.getElementById('clockDate').innerText = now.toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'long'});
            }, 1000);
        }
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            fileToBase64(f).then(res => {
                currentImg = res;
                document.getElementById('img-preview-blob').src = currentImg;
                document.getElementById('uploadPreview').style.display = 'flex';
            });
        }
        function clearUpload() { currentImg=null; document.getElementById('uploadPreview').style.display='none'; document.getElementById('fileInput').value=''; }
        function fileToBase64(file) {
            return new Promise(resolve => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    // ç®€å•å‹ç¼©
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = Math.min(1, 800/img.width); // é™åˆ¶æœ€å¤§å®½åº¦800
                        cvs.width = img.width * scale; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }
        
        // å¯¼å‡º/å¯¼å…¥
        // --- æ•°æ®å¤‡ä»½ä¸æ¢å¤ (å…¨é‡ç‰ˆ) ---
        function exportData() {
            // æŠŠ è®¾ç½®ã€è”ç³»äºº(å«è®°å¿†)ã€ç¾åŒ–æ•°æ® æ‰“åŒ…åœ¨ä¸€èµ·
            const backupPayload = {
                globalConfig: globalConfig,
                contacts: contacts,
                themeConfig: themeConfig 
            };
            
            const blob = new Blob([JSON.stringify(backupPayload)], {type:'application/json'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'ai_phone_full_backup.json'; // æ”¹ä¸ªåå­—ï¼Œå«å…¨é‡å¤‡ä»½
            a.click();
        }

        function importData(e) {
            const f = e.target.files[0]; 
            if(!f) return;
            
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    
                    // 1. æ¢å¤å…¨å±€è®¾ç½®
                    if(d.globalConfig) {
                        globalConfig = d.globalConfig;
                        localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
                    }

                    // 2. æ¢å¤è”ç³»äºº (åŒ…å«èŠå¤©è®°å½•ã€è®°å¿†åº“)
                    if(d.contacts) {
                        contacts = d.contacts;
                        localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
                    }

                    // 3. æ¢å¤ç¾åŒ–è®¾ç½® (å›¾æ ‡ã€CSSã€å­—ä½“)
                    if(d.themeConfig) {
                        themeConfig = d.themeConfig;
                        localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
                    }

                    alert("ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†é‡æ–°åŠ è½½ä»¥åº”ç”¨æ›´æ”¹ã€‚");
                    location.reload(); // åˆ·æ–°é¡µé¢ï¼Œè®©æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆ
                    
                } catch(e) {
                    alert("âŒ æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å†…å®¹å·²æŸåã€‚\n" + e.message);
                }
            }; 
            r.readAsText(f);
            // æ¸…ç©º input é˜²æ­¢åŒåæ–‡ä»¶æ— æ³•å†æ¬¡è§¦å‘
            e.target.value = ''; 
        }
        async function testConn() {
            try { 
                await fetch(normalizeUrl(globalConfig.apiUrl)+'/models', {headers:{Authorization:"Bearer "+globalConfig.apiKey}}); 
                alert("è¿æ¥æˆåŠŸï¼"); 
            } catch(e) { alert("è¿æ¥å¤±è´¥: "+e.message); }
        }
        // --- 5. æ—¥è®°æœ¬æ¸²æŸ“é€»è¾‘ (æ–°å¢) ---
    // ==========================================
// --- æ–°ç‰ˆæ—¥è®°æœ¬é€»è¾‘ (äº¤æ¢æ—¥è®°ç³»ç»Ÿ) ---
// ==========================================

// 1. æ—¥è®°æœ¬é¦–é¡µï¼šæ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨
function renderDiaries() {
    const container = document.getElementById('diaryListContainer');
    container.innerHTML = ''; // æ¸…ç©º

    // --- A. â€œæˆ‘çš„æ—¥è®°â€å…¥å£ (å›ºå®šåœ¨é¡¶éƒ¨) ---
    // ä¸ºäº†é€»è¾‘ç®€å•ï¼Œç‚¹å‡»â€œæˆ‘çš„æ—¥è®°â€æˆ‘ä»¬è®©ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹å“ªä¸ªè§’è‰²çš„å¾€æ¥ï¼Œæˆ–è€…é»˜è®¤æ˜¾ç¤ºå½“å‰æ´»è·ƒè§’è‰²çš„
    // è¿™é‡Œæˆ‘ä»¬è®¾è®¡ä¸ºï¼šé¦–é¡µæ˜¾ç¤ºæ‰€æœ‰â€œè”ç³»äººæ—¥è®°æœ¬â€ + ä¸€ä¸ªâ€œæ‰€æœ‰æˆ‘çš„æ—¥è®°â€åˆé›†(å¯é€‰)ï¼Œ
    // æŒ‰ç…§ä½ çš„éœ€æ±‚ï¼Œæˆ‘ä»¬æŠŠâ€œæˆ‘çš„æ—¥è®°â€ä½œä¸ºä¸€ä¸ªæ€»å…¥å£ï¼Œè¿›å»åå†çœ‹å‘ç»™è°çš„ï¼Œæˆ–è€…ç®€å•ç‚¹ï¼š
    // ç•Œé¢å˜æˆï¼š
    // [ ğŸ“’ æˆ‘çš„æ—¥è®° (æˆ‘å†™çš„æ‰€æœ‰å†…å®¹) ]
    // [ ğŸ¤– è§’è‰²A çš„æ—¥è®° ]
    // [ ğŸ¤– è§’è‰²B çš„æ—¥è®° ]
    
    // æ¸²æŸ“ "æˆ‘çš„æ—¥è®°" æ–‡ä»¶å¤¹
    const myDiv = document.createElement('div');
    myDiv.className = 'diary-folder';
    myDiv.onclick = () => renderUserDiaryList(); // è¿›å…¥æˆ‘çš„æ—¥è®°åˆ—è¡¨
    myDiv.innerHTML = `
        <img src="https://i.postimg.cc/YC4xQqFs/IMG-9655.jpg" class="diary-icon" style="object-fit:cover;">
        <div class="diary-info">
            <div class="diary-title">æˆ‘çš„æ—¥è®°æœ¬</div>
            <div class="diary-sub">è®°å½•æˆ‘çš„å¿ƒæƒ…</div>
        </div>
        <div style="color:#ccc;">â€º</div>
    `;
    container.appendChild(myDiv);

    // æ¸²æŸ“ åˆ†å‰²çº¿
    const sep = document.createElement('div');
    sep.innerText = "äº¤æ¢æ—¥è®°å¯¹è±¡";
    sep.className = "ios-group-title";
    container.appendChild(sep);

    // --- B. è§’è‰²æ—¥è®°å…¥å£åˆ—è¡¨ ---
    contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'diary-folder';
        div.onclick = () => renderAiDiaryList(c.id); // è¿›å…¥è§’è‰²çš„æ—¥è®°åˆ—è¡¨
        div.innerHTML = `
            <img src="${c.avatar}" class="diary-icon" style="object-fit:cover;">
            <div class="diary-info">
                <div class="diary-title">${c.name} çš„æ—¥è®°</div>
                <div class="diary-sub">å…± ${c.diaries ? c.diaries.length : 0} ç¯‡</div>
            </div>
            <div style="color:#ccc;">â€º</div>
        `;
        container.appendChild(div);
    });
}

// 2. æ¸²æŸ“â€œæˆ‘çš„æ—¥è®°â€åˆ—è¡¨ (æ˜¾ç¤ºæˆ‘å†™ç»™å½“å‰/æ‰€æœ‰è§’è‰²çš„)
function renderUserDiaryList() {
    const container = document.getElementById('diaryListContainer');
    // å¤´éƒ¨å¯¼èˆªå˜ä¸€ä¸‹
    const headerHtml = `
        <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; align-items:center;">
            <button onclick="renderDiaries()" style="border:none;background:none;color:#007AFF;font-size:16px;">â€¹ è¿”å›</button>
            <span style="font-weight:bold; margin-left:15px; font-size:18px;">æˆ‘çš„æ—¥è®°</span>
        </div>
    `;
    
    let listHtml = '<div style="padding-bottom:80px;">';
    
    // æ”¶é›†æ‰€æœ‰è§’è‰²é‡Œçš„ userDiaries
    let allMyDiaries = [];
    contacts.forEach(c => {
        if(c.userDiaries && c.userDiaries.length > 0) {
            c.userDiaries.forEach((content, idx) => {
                allMyDiaries.push({
                    content: content,
                    charName: c.name,
                    charId: c.id,
                    time: Date.now() // å®é™…é¡¹ç›®åº”è¯¥å­˜æ—¶é—´æˆ³ï¼Œè¿™é‡Œç®€åŒ–
                });
            });
        }
    });

    if (allMyDiaries.length === 0) {
        listHtml += '<div style="text-align:center; color:#999; margin-top:50px;">ä½ è¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°<br>ç‚¹å‡»å³ä¸‹è§’ç¬”å¤´å¼€å§‹å†™å§</div>';
    } else {
        // å€’åºæ˜¾ç¤º
        allMyDiaries.reverse().forEach(item => {
            listHtml += `
                <div class="memory-card" style="border-left: 4px solid #007AFF;">
                    <div style="font-size:12px; color:#007AFF; margin-bottom:5px;">å¯„ç»™: ${item.charName}</div>
                    <div style="line-height:1.6; color:#333;">${item.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        });
    }
    listHtml += '</div>';

    // æ·»åŠ æ‚¬æµ®å†™ä½œæŒ‰é’®
    listHtml += `<button class="btn-float-write" onclick="openDiaryWriter()">+</button>`;

    container.innerHTML = headerHtml + listHtml;
}

// 3. æ¸²æŸ“â€œè§’è‰²æ—¥è®°â€åˆ—è¡¨ (æŸ¥çœ‹AIå†™çš„)
function renderAiDiaryList(charId) {
    const char = contacts.find(c => c.id === charId);
    if (!char) return;

    const container = document.getElementById('diaryListContainer');
    const headerHtml = `
        <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; align-items:center;">
            <button onclick="renderDiaries()" style="border:none;background:none;color:#007AFF;font-size:16px;">â€¹ è¿”å›</button>
            <span style="font-weight:bold; margin-left:15px; font-size:18px;">${char.name} çš„æ—¥è®°</span>
        </div>
    `;

    let listHtml = '<div style="padding:15px;">';
    
    if (!char.diaries || char.diaries.length === 0) {
        listHtml += '<div style="text-align:center; color:#999; margin-top:50px;">Ta è¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°</div>';
    } else {
        // å€’åº
        [...char.diaries].reverse().forEach((content, index) => {
            // è®¡ç®—åŸå§‹ç´¢å¼•ç”¨äºåˆ é™¤
            const originalIndex = char.diaries.length - 1 - index;
            listHtml += `
                <div class="memory-card" style="border-left: 4px solid #ff2d55;">
                    <div style="line-height:1.6; color:#333;">${content.replace(/\n/g, '<br>')}</div>
                    <div class="btn-del-mem" onclick="deleteDiary('${charId}', ${originalIndex})">Ã—</div>
                </div>
            `;
        });
    }
    listHtml += '</div>';
    container.innerHTML = headerHtml + listHtml;
}

// 4. åˆ é™¤é€»è¾‘
function deleteDiary(charId, index) {
    const char = contacts.find(c => c.id === charId);
    if (confirm('ç¡®å®šè¦æ’•æ‰è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
        char.diaries.splice(index, 1);
        saveData();
        renderAiDiaryList(charId); // åˆ·æ–°å½“å‰åˆ—è¡¨
    }
}

// =======================
// --- å†™æ—¥è®°ä¸äº¤äº’é€»è¾‘ ---
// =======================

// æ‰“å¼€å†™ä½œå¼¹çª—
function openDiaryWriter() {
    // é»˜è®¤å‘ç»™å½“å‰æ´»è·ƒçš„è§’è‰²ï¼Œå¦‚æœæ²¡æœ‰æ´»è·ƒè§’è‰²ï¼Œåˆ™æç¤ºé€‰æ‹©æˆ–è€…é»˜è®¤ç¬¬ä¸€ä¸ª
    let targetId = activeContactId; 
    
    if (!targetId && contacts.length > 0) {
        targetId = contacts[0].id; // é»˜è®¤ç¬¬ä¸€ä¸ª
    }

    if (!targetId) return alert("è¯·å…ˆåˆ›å»ºä¸€ä¸ªè§’è‰²ï¼");

    const char = contacts.find(c => c.id === targetId);
    
    document.getElementById('diary-target-char-id').value = targetId;
    document.getElementById('diary-target-name').innerText = char.name;
    document.getElementById('user-diary-input').value = ''; // æ¸…ç©º
    
    openModal('modal-write-diary');
}

// æäº¤æ—¥è®°
async function submitUserDiary() {
    const targetId = document.getElementById('diary-target-char-id').value;
    const content = document.getElementById('user-diary-input').value.trim();
    const char = contacts.find(c => c.id === targetId);

    if (!content) return alert("å†™ç‚¹ä»€ä¹ˆå§ï¼");

    // 1. ä¿å­˜ç”¨æˆ·çš„æ—¥è®°
    if (!char.userDiaries) char.userDiaries = [];
    
    const dateStr = new Date().toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const finalContent = `[${dateStr}]\n${content}`;
    
    char.userDiaries.push(finalContent);
    saveData();
    closeModal('modal-write-diary');
    
    // åˆ·æ–°ä¸€ä¸‹æ˜¾ç¤º
    renderUserDiaryList();

    // 2. è§¦å‘ AI å›å¤ (äº¤æ¢æ—¥è®°æ ¸å¿ƒ)
    alert(`æ—¥è®°å·²ä¿å­˜ï¼æ­£åœ¨åŒæ­¥ç»™ ${char.name}ï¼Œè¯·ç¨ç­‰ Ta çš„å›ä¿¡...`);
    
    await generateDiaryReply(char, finalContent);
}

// AI ç”Ÿæˆå›å¤æ—¥è®°
async function generateDiaryReply(char, userDiaryContent) {
    if (!globalConfig.apiKey) return alert("è¯·å…ˆé…ç½® API Key æ‰èƒ½æ”¶åˆ°å›ä¿¡å“¦");

    const prompt = `
    ã€äº¤æ¢æ—¥è®°æ¨¡å¼ã€‘
    ç”¨æˆ·ï¼ˆä½ çš„æ‹äººï¼‰åˆšåˆšåœ¨ä½ ä»¬çš„äº¤æ¢æ—¥è®°æœ¬é‡Œå†™ä¸‹äº†ä¸€ç¯‡æ—¥è®°ã€‚
    è¯·ä½ é˜…è¯»è¿™ç¯‡æ—¥è®°ï¼Œç„¶åä»¥æ—¥è®°çš„å½¢å¼å†™ä¸€ç¯‡â€œè¯»åæ„Ÿâ€æˆ–â€œå›ä¿¡â€ã€‚
    
    ç”¨æˆ·çš„æ—¥è®°å†…å®¹ï¼š
    "${userDiaryContent}"
    
    ä½ çš„è¦æ±‚ï¼š
    1. æ ¼å¼å¿…é¡»æ˜¯æ—¥è®°æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š[æ—¥æœŸ] ä»Šå¤©è¯»äº†XXçš„æ—¥è®°...ï¼‰ã€‚
    2. è¯­æ°”è¦ç¬¦åˆä½ çš„äººè®¾ï¼ˆ${char.systemPrompt}ï¼‰ã€‚
    3. å†…å®¹è¦é’ˆå¯¹ç”¨æˆ·å†™çš„äº‹æƒ…è¿›è¡Œå›åº”ã€å®‰æ…°ã€åæ§½æˆ–åˆ†äº«ä½ çš„ç›¸å…³æ„Ÿå—ã€‚
    4. è¦åƒçœŸå®çš„æ—¥è®°ä¸€æ ·è‡ªç„¶ã€‚
    `;

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨å†™æ—¥è®°çš„è§’è‰²ã€‚" },
                    { role: "user", content: prompt }
                ],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const reply = data.choices[0].message.content;

        // ä¿å­˜ AI çš„æ—¥è®°
        char.diaries.push(reply);
        saveData();

        alert(`æ”¶åˆ° ${char.name} çš„äº¤æ¢æ—¥è®°å›ä¿¡å•¦ï¼å¿«å» Ta çš„æ—¥è®°æœ¬é‡Œçœ‹çœ‹å§ï¼`);
        
        // å¦‚æœå½“å‰è¿˜åœ¨æˆ‘çš„æ—¥è®°ç•Œé¢ï¼Œå¯ä»¥ä¸ç”¨è·³ï¼Œæˆ–è€…ç»™ä¸ªçº¢ç‚¹æç¤ºï¼ˆè¿™é‡Œç®€å•å¤„ç†ï¼Œä¸åšè·³è½¬ï¼‰
        
    } catch (e) {
        console.error(e);
        alert("åŒæ­¥å¤±è´¥ï¼ŒTa å¥½åƒæ²¡æ”¶åˆ°æ—¥è®°...");
    }
}
        // --- 6. åˆ é™¤æŒ‡å®šèŒƒå›´æ¶ˆæ¯çš„é€»è¾‘ (æ–°) ---
    function openDeleteMsgModal() {
        const char = getActiveChar();
        if(!char) return;
        
        // å…ˆå…³é—­è®¾ç½®å¼¹çª—ï¼Œå†å¼€åˆ é™¤å¼¹çª—ï¼Œä½“éªŒæ›´å¥½
        closeModal('modal-chat-settings');

        const total = char.messages.length;
        if (total === 0) return alert("åœ¨è¿™ä¸ªèŠå¤©ä¸­è¿˜æ²¡æœ‰æ¶ˆæ¯å“¦");

        document.getElementById('del-total-count').innerText = total;
        // é»˜è®¤å¡«å…¥ï¼šä»æœ€åä¸€æ¡åˆ åˆ°æœ€åä¸€æ¡ï¼ˆå³åˆ é™¤æœ€æ–°çš„ä¸€æ¡ï¼‰
        document.getElementById('del-start').value = total; 
        document.getElementById('del-end').value = total;
        
        openModal('modal-del-msg');
    }

    function commitDeleteMsg() {
        const char = getActiveChar();
        const startVal = parseInt(document.getElementById('del-start').value);
        const endVal = parseInt(document.getElementById('del-end').value);
        const total = char.messages.length;

        // 1. æ ¡éªŒè¾“å…¥
        if (isNaN(startVal) || isNaN(endVal)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        if (startVal < 1 || startVal > total) return alert("èµ·å§‹æ¥¼å±‚ä¸å­˜åœ¨");
        if (endVal < 1 || endVal > total) return alert("ç»“æŸæ¥¼å±‚ä¸å­˜åœ¨");
        if (startVal > endVal) return alert("èµ·å§‹æ¥¼å±‚ä¸èƒ½å¤§äºç»“æŸæ¥¼å±‚");

        // 2. è®¡ç®—åˆ é™¤æ•°é‡
        // æ¯”å¦‚è¦åˆ ç¬¬3æ¡åˆ°ç¬¬5æ¡ (3, 4, 5)ï¼Œé‚£å°±æ˜¯åˆ æ‰ (5-3)+1 = 3æ¡
        // æ•°ç»„ç´¢å¼•æ˜¯ 0-basedï¼Œæ‰€ä»¥ç¬¬3æ¡å¯¹åº”çš„ç´¢å¼•æ˜¯ 2
        const startIndex = startVal - 1;
        const deleteCount = endVal - startVal + 1;

        if (confirm(`âš ï¸  \n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç¬¬ ${startVal} åˆ° ${endVal} æ¥¼çš„ ${deleteCount} æ¡æ¶ˆæ¯å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
            
            // æ‰§è¡Œåˆ é™¤ (spliceä¼šä¿®æ”¹åŸæ•°ç»„)
            char.messages.splice(startIndex, deleteCount);
            
            saveData(); // ä¿å­˜
            
            // åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            updateContactList(); // åˆ—è¡¨é‡Œçš„é¢„è§ˆæ–‡å­—ä¹Ÿå¯èƒ½å˜äº†
            
            closeModal('modal-del-msg');
            alert("åˆ é™¤æˆåŠŸï¼");
        }
    }
        // --- 7. æ¶ˆæ¯ç¼–è¾‘ä¸é‡åˆ· (æ–°åŠŸèƒ½) ---

    // åŠŸèƒ½Aï¼šAI é‡åˆ· (Re-roll)
    function rerollMessage(uiIndex) {
        const char = getActiveChar();
        // uiIndex æ˜¯ä»1å¼€å§‹çš„ï¼Œæ•°ç»„æ˜¯ä»0å¼€å§‹çš„
        const arrayIndex = uiIndex - 1;
        
        if(arrayIndex < 0 || arrayIndex >= char.messages.length) return;

        // é€»è¾‘ï¼šåˆ é™¤ è¿™æ¡AIæ¶ˆæ¯ ä»¥åŠ å®ƒä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        // å› ä¸ºé‡åˆ·æ„å‘³ç€æ—¶é—´çº¿å˜åŠ¨ï¼Œåé¢çš„å¯¹è¯å°±ä½œåºŸäº†
        if(confirm("è¦è®©ä»–é‡æ–°å›ç­”è¿™ä¸€å¥å—ï¼Ÿ(ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)")) {
            char.messages.splice(arrayIndex, 999); // åˆ é™¤å½“å‰åŠä¹‹åæ‰€æœ‰
            saveData();
            
            // åˆ·æ–°ç•Œé¢æ˜¾ç¤ºåˆ é™¤åçš„çŠ¶æ€
            renderChat(activeContactId);
            
            // ç«‹å³è§¦å‘ AI ç”Ÿæˆ
            triggerAI();
        }
    }

    // åŠŸèƒ½Bï¼šç”¨æˆ·é•¿æŒ‰ç¼–è¾‘
    function handleUserEdit(e, uiIndex) {
        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„å³é”®èœå•
        
        const char = getActiveChar();
        const arrayIndex = uiIndex - 1;
        const msg = char.messages[arrayIndex];
        
        if(!msg) return;

        // ä½¿ç”¨ prompt è®©ç”¨æˆ·ä¿®æ”¹æ–‡æœ¬
        const newText = prompt("ç¼–è¾‘æ¶ˆæ¯ï¼š", msg.content);
        
        // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆæˆ–è€…å†…å®¹æ²¡å˜ï¼Œå°±ä¸åŠ¨
        if (newText === null || newText === msg.content) return;

        if(confirm("ä¿®æ”¹åï¼Œä»–å°†æ ¹æ®æ–°å†…å®¹é‡æ–°å›å¤ (ä¹‹åçš„æ¶ˆæ¯å°†è¢«æ¸…é™¤)ï¼Œç¡®å®šå—ï¼Ÿ")) {
            // 1. æ›´æ–°å½“å‰æ¶ˆæ¯å†…å®¹
            msg.content = newText;
            
            // 2. åˆ é™¤ è¿™æ¡æ¶ˆæ¯ä¹‹å çš„æ‰€æœ‰æ¶ˆæ¯ (å› ä¸ºç”¨æˆ·æ”¹äº†å†å²ï¼Œæœªæ¥å¿…é¡»é‡å†™)
            char.messages.splice(arrayIndex + 1, 999);
            
            saveData();
            
            // 3. åˆ·æ–°ç•Œé¢
            renderChat(activeContactId);
            
            // 4. è§¦å‘ AI é‡æ–°å›å¤
            triggerAI();
        }
    }
        // --- ç•ªèŒ„é’Ÿé€»è¾‘æ¨¡å— ---

let pomoState = {
    timerId: null,
    timeLeft: 0,      // ç§’
    totalTime: 0,     // ç§’
    charId: null,
    task: "",
    intervalSeconds: 0, // ä¸»åŠ¨å‘è¨€é—´éš”
    pokes: 0,         // ç”¨æˆ·æˆ³äº†å¤šå°‘æ¬¡
    lastSpeakTime: 0,  // ä¸Šæ¬¡AIè¯´è¯çš„å‰©ä½™æ—¶é—´ç‚¹
    lastReply: ""
};
        // --- å±å¹•å¸¸äº®æ§åˆ¶ (æ–°å¢) ---
let wakeLock = null;

async function setScreenKeepOn(status) {
    if ('wakeLock' in navigator) {
        try {
            if (status) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("å±å¹•å¸¸äº®å·²å¼€å¯");
            } else {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log("å±å¹•å¸¸äº®å·²å…³é—­");
                }
            }
        } catch (err) {
            console.log("å±å¹•å¸¸äº®è®¾ç½®å¤±è´¥:", err);
        }
    }
}

// ç›‘å¬é¡µé¢åˆ‡æ¢ï¼šå¦‚æœä½ åˆ‡å‡ºå»å›æ¶ˆæ¯ï¼Œå†åˆ‡å›æ¥ï¼Œéœ€è¦é‡æ–°ç”³è¯·å¸¸äº®
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await setScreenKeepOn(true);
    }
});

// 1. åˆå§‹åŒ–é¡µé¢ï¼šåŠ è½½è§’è‰²åˆ—è¡¨
function initPomoPage() {
    const select = document.getElementById('pomoCharSelect');
    select.innerHTML = '';
    contacts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        select.appendChild(opt);
    });
    // å¦‚æœä¹‹å‰æœ‰è®°å½•ï¼Œæ¢å¤é»˜è®¤å€¼
    if(activeContactId) select.value = activeContactId;
}

// 2. å¼€å§‹ä¸“æ³¨
function startPomoTimer() {
    const charId = document.getElementById('pomoCharSelect').value;
    const duration = parseInt(document.getElementById('pomoDuration').value);
    const task = document.getElementById('pomoTask').value || "å‘å‘†";
    const interval = parseInt(document.getElementById('pomoInterval').value);

    if(!charId) return alert("è¯·é€‰æ‹©ä¸€ä¸ªä¼´è¯»è§’è‰²");
    if(duration < 1) return alert("æ—¶é—´å¤ªçŸ­å•¦");

    // åˆå§‹åŒ–çŠ¶æ€
    pomoState.charId = charId;
    pomoState.totalTime = duration * 60;
    pomoState.timeLeft = pomoState.totalTime;
    pomoState.task = task;
    pomoState.intervalSeconds = interval > 0 ? interval * 60 : 999999;
    pomoState.pokes = 0;
    pomoState.lastSpeakTime = pomoState.timeLeft;

    // åˆ‡æ¢UI
    document.getElementById('pomo-setup').style.display = 'none';
    document.getElementById('pomo-running').style.display = 'flex';
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === charId);
    document.getElementById('pomo-avatar').src = char.avatar;
    document.getElementById('pomo-task-display').innerText = `æ­£åœ¨ä¸“æ³¨: ${task}`;
    document.getElementById('pomo-ai-bubble').innerText = "è®¡æ—¶å¼€å§‹ï¼åŠ æ²¹å“¦ï¼(ç‚¹å‡»æˆ‘å¯ä»¥æˆ³ä¸€æˆ³)";

    // å¯åŠ¨è®¡æ—¶å™¨
    updatePomoDisplay();
    pomoState.timerId = setInterval(pomoTick, 1000);

    // è§¦å‘ä¸€æ¬¡AIå¼€åœºç™½
    triggerPomoAI("start");
    // å¼€å¯å±å¹•å¸¸äº®
    setScreenKeepOn(true);
}

// 3. è®¡æ—¶å™¨å¿ƒè·³ (æ¯ç§’æ‰§è¡Œ)
function pomoTick() {
    if(pomoState.timeLeft <= 0) {
        finishPomo();
        return;
    }

    pomoState.timeLeft--;
    updatePomoDisplay();

    // æ£€æŸ¥æ˜¯å¦åˆ°äº†è‡ªåŠ¨å‘è¨€æ—¶é—´
    const timeSinceLastSpeak = pomoState.lastSpeakTime - pomoState.timeLeft;
    if(timeSinceLastSpeak >= pomoState.intervalSeconds) {
        triggerPomoAI("auto_check");
        pomoState.lastSpeakTime = pomoState.timeLeft;
    }
}

// 4. æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
function updatePomoDisplay() {
    const m = Math.floor(pomoState.timeLeft / 60).toString().padStart(2, '0');
    const s = (pomoState.timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('pomo-timer-display').innerText = `${m}:${s}`;
}

// 5. æˆ³ä¸€æˆ³äº¤äº’
function pokePomoChar() {
    if(!pomoState.timerId) return; // æ²¡å¼€å§‹ä¸èƒ½æˆ³

    pomoState.pokes++;
    
    // è§†è§‰ç‰¹æ•ˆ
    const img = document.getElementById('pomo-avatar');
    img.classList.remove('anim-shake');
    void img.offsetWidth; // è§¦å‘é‡ç»˜
    img.classList.add('anim-shake');

    const effect = document.getElementById('poke-effect');
    effect.style.opacity = 1;
    effect.style.top = '40%';
    setTimeout(() => { effect.style.opacity = 0; effect.style.top = '50%'; }, 500);

    // è§¦å‘AIååº”
    triggerPomoAI("poke");
}

// 6. ç»“æŸ/é€€å‡º
function quitPomo() {
    if(pomoState.timerId) {
        if(!confirm("ä¸“æ³¨è¿˜æ²¡ç»“æŸï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ")) return;
        clearInterval(pomoState.timerId);
        pomoState.timerId = null;
        savePomoToChat(false);
    }
    // æ¢å¤UI
    document.getElementById('pomo-setup').style.display = 'block';
    document.getElementById('pomo-running').style.display = 'none';
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    goHome(); // æˆ–è€…è¿”å›ä¸Šçº§
}

function finishPomo() {
    clearInterval(pomoState.timerId);
    pomoState.timerId = null;
    savePomoToChat(true);
    triggerPomoAI("finish");
    setScreenKeepOn(false); // å…³é—­å±å¹•å¸¸äº®
    alert("ä¸“æ³¨æ—¶é—´åˆ°ï¼ä½ çœŸæ£’ï¼");
    // å¯ä»¥åœ¨è¿™é‡Œæ’­æ”¾æç¤ºéŸ³
}
        // --- æ–°å¢ï¼šå°†ä¸“æ³¨ç»“æœå†™å…¥èŠå¤©è®°å¿† (æ¸©æš–ä¸ªæ€§åŒ–ç‰ˆ) ---
function savePomoToChat(isSuccess) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if (!char) return;

    // 1. è·å–åå­—
    const myName = char.userName || "æˆ‘"; // ä½ çš„æ˜µç§°
    const aiName = char.name || "Ta";     // è§’è‰²çš„åå­—

    // 2. è®¡ç®—æ•°æ®
    const timeSpent = Math.ceil((pomoState.totalTime - pomoState.timeLeft) / 60);
    const totalDuration = Math.ceil(pomoState.totalTime / 60);

    // 3. ç”Ÿæˆæ›´æœ‰æ¸©åº¦çš„æ–‡æ¡ˆ
    let resultStr = isSuccess 
        ? `ğŸ‰ ${myName} æˆåŠŸåšæŒäº†å…¨ç¨‹ï¼` 
        : `â¹ï¸ ${myName} ä¸­é€”æºœèµ°äº†...`;

    // 4. æ„å»ºâ€œéšå½¢æç¤ºâ€
    const summary = `
ã€ğŸ•’ ä¸“æ³¨æ¨¡å¼è®°å½•ã€‘
------------------
ğŸ‘¤ ä¸»è§’ï¼š${myName} & ${aiName}
ğŸ“ ä»»åŠ¡ï¼š${pomoState.task}
â±ï¸ æ—¶é•¿ï¼š${timeSpent} åˆ†é’Ÿ (è®¡åˆ’ ${totalDuration} åˆ†é’Ÿ)
ğŸ’¡ çŠ¶æ€ï¼š${resultStr}
ğŸ‘ˆ äº’åŠ¨ï¼š${myName} æˆ³äº† ${aiName} ${pomoState.pokes} æ¬¡
ğŸ’¬ ${aiName}æœ€åçš„ç•™è¨€ï¼š"${pomoState.lastReply || '...'}"
------------------
(ç³»ç»Ÿæç¤ºï¼šä»¥ä¸Šæ˜¯åˆšæ‰å‘ç”Ÿçš„çœŸå®æƒ…å†µã€‚è¯·${aiName}æ ¹æ®è¿™ä¸ªç»“æœä¸${myName}ç»§ç»­å¯¹è¯ã€‚å¦‚æœ${myName}æˆåŠŸäº†å°±å¤¸å¤¸ï¼Œå¤±è´¥äº†å°±è°ƒä¾ƒä¸€ä¸‹ï¼Œå¦‚æœæˆ³å¾—å¾ˆå¤šå¯ä»¥åæ§½æ‰‹å¤ªæ¬ ã€‚)
    `.trim();

    // 5. å­˜å…¥èŠå¤©è®°å½•
    char.messages.push({ 
        role: 'user', 
        content: summary 
    });
    
    saveData(); 
}

// 7. æ ¸å¿ƒï¼šç•ªèŒ„é’Ÿä¸“ç”¨çš„ AI è§¦å‘é€»è¾‘
async function triggerPomoAI(reason) {
    const char = contacts.find(c => c.id === pomoState.charId);
    if(!char || !globalConfig.apiKey) return;

    const bubble = document.getElementById('pomo-ai-bubble');
    const originalText = bubble.innerText;
    bubble.innerText = "ğŸ’¬ æ­£åœ¨æ€è€ƒ...";

    // æ„å»ºé’ˆå¯¹ä¸“æ³¨æ¨¡å¼çš„ Prompt
    const minsLeft = Math.ceil(pomoState.timeLeft / 60);
    let systemInstruction = `
        ä½ æ­£åœ¨â€œç•ªèŒ„é’Ÿä¸“æ³¨æ¨¡å¼â€ä¸‹é™ªä¼´ç”¨æˆ·ã€‚
        ç”¨æˆ·æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼š${pomoState.task}ã€‚
        å‰©ä½™æ—¶é—´ï¼š${minsLeft}åˆ†é’Ÿã€‚
        ã€å½“å‰çŠ¶æ€ã€‘ï¼šç”¨æˆ·ç›®å‰å·²ç»â€œæˆ³ä¸€æˆ³â€éªšæ‰°äº†ä½  ${pomoState.pokes} æ¬¡ã€‚
        ä½ çš„æ€§æ ¼ï¼š${char.systemPrompt}ã€‚
        
        è¯·æ ¹æ®å½“å‰çš„è§¦å‘åŸå› ï¼Œè¯´ä¸€å¥ç®€çŸ­çš„è¯ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š
    `;

    let userTrigger = "";
    if(reason === "start") userTrigger = "æˆ‘åˆšå¼€å§‹è®¡æ—¶ï¼Œé¼“åŠ±æˆ‘ä¸€ä¸‹ã€‚";
    if(reason === "auto_check") userTrigger = `æ—¶é—´è¿‡å»äº†${pomoState.intervalSeconds/60}åˆ†é’Ÿï¼Œæ£€æŸ¥ä¸€ä¸‹æˆ‘çš„çŠ¶æ€ï¼Œæé†’æˆ‘ä¿æŒä¸“æ³¨ã€‚`;
    if(reason === "poke") userTrigger = `æˆ‘åˆšåˆšæˆ³äº†ä½ ä¸€ä¸‹ï¼ˆè¿™æ˜¯ç¬¬${pomoState.pokes}æ¬¡æˆ³ä½ ï¼‰ã€‚æ ¹æ®å‰©ä½™æ—¶é—´${minsLeft}åˆ†é’Ÿï¼Œå¯¹æˆ‘çš„éªšæ‰°åšå‡ºååº”ï¼ˆå¦‚æœæ—¶é—´è¿˜å¤šå°±é™ªæˆ‘ç©ä¸€ä¸‹ï¼Œå¦‚æœå¿«ç»“æŸäº†å°±è®©æˆ‘èµ¶ç´§ä¸“å¿ƒï¼‰ã€‚`;
    if(reason === "finish") userTrigger = "è®¡æ—¶ç»“æŸäº†ï¼å¤¸å¥–æˆ‘ï¼";

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: systemInstruction },
                    { role: "user", content: userTrigger }
                ],
                temperature: 0.7
            })
        });
        
        const data = await res.json();
        const reply = data.choices[0].message.content;
        
        bubble.innerText = reply;
        pomoState.lastReply = reply;
        pomoState.lastSpeakTime = pomoState.timeLeft;

        // ã€å¯é€‰ã€‘æŠŠè¿™æ®µè¯ä¹Ÿå­˜å…¥èŠå¤©è®°å½•ï¼Œè¿™æ ·å›åˆ°èŠå¤©ç•Œé¢ä¹Ÿèƒ½çœ‹åˆ°
        // char.messages.push({ role: 'assistant', content: `[ä¸“æ³¨æ¨¡å¼]: ${reply}` });
        // saveData();

    } catch(e) {
        bubble.innerText = originalText; // å¤±è´¥å›æ»š
        console.error(e);
    }
}
        // ==========================================
// --- æ ¸å¿ƒåŠŸèƒ½ï¼šPop é£æ ¼è¿ç¯è¿½é—®ä¸æ—¶é—´å›å¡«ç³»ç»Ÿ ---
// ==========================================

// ==========================================
// --- è°ƒè¯•ä¸“ç”¨ç‰ˆï¼šå¼ºåˆ¶è§¦å‘ç¦»çº¿æ¶ˆæ¯ ---
// ==========================================

async function processAutoReplyChain(charId) {
    const char = contacts.find(c => c.id === charId);
    
    // 1. æ£€æŸ¥è®¾ç½®
    if (!char) return;
    const interval = char.autoReplyInterval || 0;
    
    // --- è°ƒè¯•å¼¹çª— A ---
    // alert(`è°ƒè¯•ä¿¡æ¯:\nè§’è‰²: ${char.name}\nè®¾ç½®é—´éš”: ${interval}å°æ—¶`);

    if (interval <= 0) return;

    const now = Date.now();
    
    // 2. è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´
    let lastMsg = char.messages[char.messages.length - 1];
    let lastMsgTime = lastMsg ? (lastMsg.timestamp || char.lastActiveTime || now) : now;


    const intervalMs = interval * 60 * 60 * 1000; 
    const maxConsecutive = 5; 
    let addedCount = 0;

    const titleDom = document.getElementById('chat-title-name');
    const originalTitle = titleDom ? titleDom.innerText : char.name;

    let virtualClock = lastMsgTime; 

    // --- è°ƒè¯•å¼¹çª— B ---
    // alert("å‡†å¤‡å¼€å§‹è®¡ç®—æ—¶é—´å·®...");

    while (addedCount < maxConsecutive) {
        // æ³¢åŠ¨èŒƒå›´
        const jitter = (Math.random() * 60 * 60 * 1000) - (30 * 60 * 1000);
        let nextTargetTime = virtualClock + intervalMs + jitter;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å‘
        if (nextTargetTime < now) {
            // --- è°ƒè¯•å¼¹çª— C ---
            // alert(`è§¦å‘æˆåŠŸï¼\næ­£åœ¨è¡¥å‘ç¬¬ ${addedCount+1} æ¡æ¶ˆæ¯...`);

            if(titleDom) titleDom.innerText = `æ­£åœ¨æ¥æ”¶ç¦»çº¿æ¶ˆæ¯ (${addedCount + 1})...`;
            
            virtualClock = nextTargetTime; 
            
            // è¿™é‡Œçš„ await å¯èƒ½ä¼šå› ä¸ºç½‘ç»œæ…¢è€Œå¡ä½ï¼Œæ³¨æ„çœ‹æ•ˆæœ
            try {
                await generateBackfillMessage(char, nextTargetTime, addedCount + 1);
                addedCount++;
            } catch (err) {
                alert("API è¯·æ±‚å¤±è´¥ï¼š" + err.message);
                break;
            }
            
        } else {
            break;
        }
    }
    
    if(titleDom) titleDom.innerText = originalTitle;
    if (addedCount > 0) {
        saveData(); 
        // alert("ç¦»çº¿æ¶ˆæ¯æ¥æ”¶å®Œæ¯•ï¼");
    } else {
        // alert("æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦è¡¥å‘çš„æ¶ˆæ¯ (æ—¶é—´è¿˜æ²¡åˆ°)");
    }
}

// ç”Ÿæˆå•æ¡å›å¡«æ¶ˆæ¯çš„å‡½æ•° (ä¿®å¤ç‰ˆ)
async function generateBackfillMessage(char, simulatedTime, chainIndex) {
    // è®¡ç®—æ¨¡æ‹Ÿæ—¶é—´ç‚¹çš„æ—¥æœŸæè¿°
    const simDate = new Date(simulatedTime);
    const timeStr = simDate.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
    const dayStr = simDate.toLocaleDateString('zh-CN', {weekday: 'long'});
    
    // è®¡ç®—è¿™ä¸ªæ¨¡æ‹Ÿç‚¹è·ç¦»ç”¨æˆ·æœ€åä¸€æ¬¡è¯´è¯ï¼ˆæˆ–äº’åŠ¨ï¼‰è¿‡äº†å¤šä¹…
    const hoursSinceUser = Math.floor((simulatedTime - (char.lastActiveTime || simulatedTime)) / (1000 * 60 * 60));
    
    // æ„å»º Prompt
    const backfillPrompt = `
    [ç³»ç»Ÿå¼ºåˆ¶æŒ‡ä»¤]
    å½“å‰æ˜¯è™šæ‹Ÿæ—¶é—´ï¼š${dayStr} ${timeStr}ã€‚
    ç°çŠ¶ï¼šç”¨æˆ·å·²ç»ä¸ç†ä½ çº¦ ${hoursSinceUser} å°æ—¶äº†ã€‚
    è¿™æ˜¯ä½ ã€è¿ç»­ç¬¬ ${chainIndex} æ¬¡ã€‘ä¸»åŠ¨å‘æ¶ˆæ¯å¯»æ‰¾ç”¨æˆ·ï¼ˆç”¨æˆ·ä¸€ç›´æ²¡å›ï¼‰ã€‚
    
    è¯·åŠ¡å¿…å‘é€ä¸€æ¡æ¶ˆæ¯ç»™ç”¨æˆ·ã€‚
    è¦æ±‚ï¼š
    1. å¿…é¡»æ ¹æ®â€œè¿ç»­è¿½é—®æ¬¡æ•°â€æ”¹å˜è¯­æ°”ï¼ˆç¬¬1æ¬¡æ­£å¸¸ï¼Œåé¢é€æ¸ç„¦æ€¥ã€å¤±è½æˆ–ç”Ÿæ°”ï¼‰ã€‚
    2. ç»“åˆæ—¶é—´ç‚¹ï¼ˆå¦‚æ·±å¤œã€æ¸…æ™¨ï¼‰å‘æŒ¥ã€‚
    3. å­—æ•°50å­—ä»¥å†…ã€‚
    4. ä¸è¦é‡å¤ä¸Šä¸€æ¡å†…å®¹ï¼å¿…é¡»è¯´è¯ï¼Œä¸èƒ½ç•™ç©ºï¼
    `;

    // è°ƒç”¨ API
    try {
        // æˆªå–æœ€è¿‘ 15 æ¡è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
        const history = char.messages.slice(-15).map(m => ({ 
            role: m.role, 
            content: m.content 
        }));

        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: char.systemPrompt },
                    ...history,
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°† role æ”¹ä¸º userï¼Œå¼ºåˆ¶æ¨¡å‹å¿…é¡»å›åº”ï¼Œé˜²æ­¢ç©ºå›
                    { role: "user", content: backfillPrompt }
                ],
                temperature: 0.85 
            })
        });
        
        if (!res.ok) {
            throw new Error(`API error: ${res.status}`);
        }

        const data = await res.json();
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢æŠ¥é”™
        if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
            throw new Error("API è¿”å›äº†ç©ºæ•°æ®");
        }

        let reply = data.choices[0].message.content;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿‡æ»¤æ‰ç©ºç™½å›å¤
        if (!reply || reply.trim() === "") {
            console.warn("AI ç”Ÿæˆäº†ç©ºå†…å®¹ï¼Œè·³è¿‡æœ¬æ¬¡è¡¥å‘");
            return; // ç›´æ¥é€€å‡ºï¼Œä¸ç”Ÿæˆç©ºæ°”æ³¡
        }

        // å­˜å…¥æ¶ˆæ¯ï¼Œæ³¨æ„ï¼štimestamp ä½¿ç”¨æ¨¡æ‹Ÿçš„é‚£ä¸ªè¿‡å»çš„æ—¶é—´ï¼
        char.messages.push({ 
            role: 'assistant', 
            content: reply,
            timestamp: simulatedTime 
        });

        // ç«‹å³æ¸²æŸ“åˆ°ç•Œé¢ä¸Š
        appendMsgUI('assistant', reply, null, char.messages.length, false, simulatedTime);

    } catch (e) {
        console.error("è¡¥å‘ç”Ÿæˆå¤±è´¥:", e);
        // è¿™é‡Œä¸å¼¹çª—ï¼Œä»¥å…æ‰“æ–­è‡ªåŠ¨æµç¨‹ï¼Œä½†åœ¨æ§åˆ¶å°è®°å½•
    }
}
        // ==========================================
// --- 9. æ—¥å† (Calendar) é€»è¾‘æ¨¡å— ---
// ==========================================

let calState = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(), // 0-11
    selectedDateStr: null // æ ¼å¼ YYYY-MM-DD
};

// åˆå§‹åŒ–é¡µé¢
function initCalendarPage() {
    const now = new Date();
    calState.year = now.getFullYear();
    calState.month = now.getMonth();
    renderCalendar();
    // é»˜è®¤é€‰ä¸­ä»Šå¤©
    selectDate(formatDateKey(now.getFullYear(), now.getMonth(), now.getDate()));
}

function jumpToToday() {
    initCalendarPage();
}

function changeMonth(delta) {
    calState.month += delta;
    if(calState.month > 11) {
        calState.month = 0;
        calState.year++;
    } else if(calState.month < 0) {
        calState.month = 11;
        calState.year--;
    }
    renderCalendar();
}

// æ ¸å¿ƒï¼šæ¸²æŸ“æ—¥å†ç½‘æ ¼
function renderCalendar() {
    const grid = document.getElementById('cal-grid');
    const title = document.getElementById('cal-current-month');
    
    grid.innerHTML = '';
    title.innerText = `${calState.year}å¹´ ${calState.month + 1}æœˆ`;

    const char = getActiveChar(); // è·å–å½“å‰èŠå¤©çš„è§’è‰²æ•°æ®
    
    // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
    const firstDay = new Date(calState.year, calState.month, 1).getDay();
    // è®¡ç®—å½“æœˆæœ‰å¤šå°‘å¤©
    const daysInMonth = new Date(calState.year, calState.month + 1, 0).getDate();

    // å¡«å……ç©ºç™½æ ¼ (ä¸Šä¸ªæœˆçš„ä½™å°¾)
    for(let i=0; i<firstDay; i++) {
        const div = document.createElement('div');
        div.className = 'cal-cell empty';
        grid.appendChild(div);
    }

    // å¡«å……çœŸå®æ—¥æœŸ
    const todayKey = formatDateKey(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

    for(let d=1; d<=daysInMonth; d++) {
        const dateKey = formatDateKey(calState.year, calState.month, d);
        const div = document.createElement('div');
        div.className = 'cal-cell';
        if(dateKey === todayKey) div.classList.add('today');
        
        // æ¸²æŸ“æ•°å­—
        div.innerHTML = `<span>${d}</span><div class="cal-dot-container"></div>`;
        
        // --- æ¸²æŸ“æ ‡è®°ç‚¹ (å¦‚æœæœ‰æ•°æ®) ---
        if(char) {
            // 1. æ¸²æŸ“èŠ‚æ—¥/äº‹ä»¶ (æ©™è‰²ç‚¹)
            if(char.calendarEvents && char.calendarEvents[dateKey]) {
                const dot = document.createElement('div');
                dot.className = 'dot-event';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
            // 2. æ¸²æŸ“ç»æœŸå¼€å§‹æ—¥ (ç²‰è‰²ç‚¹)
            if(char.periodLog && char.periodLog.includes(dateKey)) {
                const dot = document.createElement('div');
                dot.className = 'dot-period';
                div.querySelector('.cal-dot-container').appendChild(dot);
            }
        }

        div.onclick = () => selectDate(dateKey, div);
        // è®°å½•DOMå¼•ç”¨æ–¹ä¾¿é«˜äº®
        div.dataset.date = dateKey; 
        grid.appendChild(div);
    }
    
    // é‡æ–°é«˜äº®å½“å‰é€‰ä¸­çš„æ—¥æœŸ
    if(calState.selectedDateStr) {
        const el = grid.querySelector(`div[data-date="${calState.selectedDateStr}"]`);
        if(el) el.classList.add('active');
    }
}

// é€‰ä¸­æŸä¸€å¤©çš„é€»è¾‘
function selectDate(dateKey, element) {
    calState.selectedDateStr = dateKey;
    
    // UI é«˜äº®åˆ‡æ¢
    document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('active'));
    if(element) {
        element.classList.add('active');
    } else {
        // å¦‚æœæ˜¯ä»ä»£ç è°ƒç”¨çš„ï¼ˆæ¯”å¦‚åˆå§‹åŒ–ï¼‰ï¼Œæ‰‹åŠ¨æ‰¾DOM
        const el = document.getElementById('cal-grid').querySelector(`div[data-date="${dateKey}"]`);
        if(el) el.classList.add('active');
    }

    // æ›´æ–°ä¸‹æ–¹è¯¦æƒ…é¢æ¿
    document.getElementById('selected-date-title').innerText = dateKey;
    
    const char = getActiveChar();
    if(!char) {
        // å¦‚æœæ²¡é€‰è§’è‰²ï¼Œç¦ç”¨è¾“å…¥
        document.getElementById('cal-event-input').disabled = true;
        document.getElementById('cal-event-input').placeholder = "è¯·å…ˆåœ¨ä¿¡æ¯åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè§’è‰²";
        return;
    } else {
        document.getElementById('cal-event-input').disabled = false;
    }

    // 1. å›æ˜¾äº‹ä»¶æ–‡å­—
    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰å¯¹è±¡å…ˆåˆ›å»º
    if(!char.calendarEvents) char.calendarEvents = {};
    const eventText = char.calendarEvents[dateKey] || "";
    document.getElementById('cal-event-input').value = eventText;

    // 2. å›æ˜¾ç»æœŸæ ‡è®°
    if(!char.periodLog) char.periodLog = [];
    const isPeriodStart = char.periodLog.includes(dateKey);
    document.getElementById('period-check-icon').style.display = isPeriodStart ? 'block' : 'none';
}

// ä¿å­˜äº‹ä»¶æ–‡å­—
function saveCalendarEvent() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const val = document.getElementById('cal-event-input').value.trim();
    if(val) {
        char.calendarEvents[calState.selectedDateStr] = val;
    } else {
        delete char.calendarEvents[calState.selectedDateStr]; // æ¸…ç©ºåˆ™åˆ é™¤
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// åˆ‡æ¢ç»æœŸæ ‡è®°
function togglePeriodMark() {
    const char = getActiveChar();
    if(!char || !calState.selectedDateStr) return;

    const dateKey = calState.selectedDateStr;
    const index = char.periodLog.indexOf(dateKey);

    if(index >= 0) {
        // å·²ç»æ ‡è®°äº† -> å–æ¶ˆæ ‡è®°
        char.periodLog.splice(index, 1);
        document.getElementById('period-check-icon').style.display = 'none';
    } else {
        // æ²¡æ ‡è®° -> æ·»åŠ æ ‡è®°
        char.periodLog.push(dateKey);
        // æ’åºä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åè®¡ç®—å‘¨æœŸ
        char.periodLog.sort();
        document.getElementById('period-check-icon').style.display = 'block';
    }
    saveData();
    renderCalendar(); // åˆ·æ–°æ ¼å­ä¸Šçš„ç‚¹
}

// è¾…åŠ©ï¼šç”Ÿæˆ YYYY-MM-DD å­—ç¬¦ä¸²
function formatDateKey(year, month, day) {
    // month æ˜¯ 0-11ï¼Œéœ€è¦+1
    const m = (month + 1).toString().padStart(2, '0');
    const d = day.toString().padStart(2, '0');
    return `${year}-${m}-${d}`;
}
        // --- 10. AI æ„ŸçŸ¥é€»è¾‘ (å¤§è„‘å‡çº§) ---

function getStatusContext(char) {
    let context = "";
    const now = new Date();
    const todayKey = formatDateKey(now.getFullYear(), now.getMonth(), now.getDate());

    // 1. æ£€æŸ¥ç‰¹æ®ŠèŠ‚æ—¥/çºªå¿µæ—¥
    if (char.calendarEvents && char.calendarEvents[todayKey]) {
        const eventName = char.calendarEvents[todayKey];
        context += `\n[é‡è¦æé†’]: ä»Šå¤©æ˜¯ "${eventName}"ã€‚è¯·åŠ¡å¿…åœ¨å›å¤ä¸­ä¸»åŠ¨æåŠè¿™ä¸ªæ—¥å­ï¼Œå¹¶æ ¹æ®ä½ ä»¬çš„å…³ç³»ç»™äºˆç›¸åº”çš„ç¥ç¦æˆ–åº†ç¥ï¼ˆæ¯”å¦‚ç¥ç”Ÿæ—¥å¿«ä¹ã€çºªå¿µæ—¥å¿«ä¹ï¼‰ã€‚\n`;
    }

    // 2. æ£€æŸ¥ç”Ÿç†æœŸçŠ¶æ€
    if (char.periodLog && char.periodLog.length > 0) {
        // æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡ç»æœŸå¼€å§‹æ—¥
        // ç®€å•çš„å­—ç¬¦ä¸²æ’åºå³å¯ï¼Œå› ä¸ºæ ¼å¼æ˜¯ YYYY-MM-DD
        const sortedLogs = [...char.periodLog].sort(); 
        const lastStartStr = sortedLogs[sortedLogs.length - 1];
        const lastStart = new Date(lastStartStr);
        
        // è®¡ç®—è·ç¦»ä»Šå¤©è¿‡äº†å¤šå°‘å¤© (ç¬¬1å¤©å°±æ˜¯å¼€å§‹é‚£å¤©)
        const diffTime = now - lastStart;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

        if (diffDays >= 1 && diffDays <= 7) {
            // ç»æœŸä¸­
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·ç›®å‰å¤„äºç”Ÿç†æœŸç¬¬ ${diffDays} å¤©ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½ä¼šæ„Ÿåˆ°èº«ä½“ä¸é€‚ï¼ˆç—›ç»ã€è…°é…¸ï¼‰æˆ–æƒ…ç»ªä½è½ã€‚è¯·åœ¨å›å¤ä¸­å±•ç°æåº¦çš„æ¸©æŸ”ã€è€å¿ƒå’ŒåŒ…å®¹ã€‚é¿å…äº‰è®ºï¼Œå¤šç»™äºˆå®‰æŠšï¼Œé€‚å½“å»ºè®®ä¼‘æ¯æˆ–å–çƒ­æ°´ï¼Œä¸è¦è®²å¤§é“ç†ã€‚\n`;
        } else if (diffDays >= 25 && diffDays <= 30) {
            // ç»æœŸå‰ (PMS é¢„æµ‹) - å‡è®¾å‘¨æœŸ 28-30 å¤©
            context += `\n[ç”Ÿç†çŠ¶æ€ç›‘æµ‹]: ç”¨æˆ·å³å°†è¿æ¥ä¸‹ä¸€æ¬¡ç”Ÿç†æœŸ (PMSé˜¶æ®µ)ã€‚
            [è¡Œä¸ºæŒ‡ä»¤]: å¥¹å¯èƒ½æƒ…ç»ªä¸å¤ªç¨³å®šã€æ˜“æ€’æˆ–ç„¦è™‘ã€‚è¯·æ— æ¡ä»¶åŒ…å®¹å¥¹çš„å°è„¾æ°”ï¼Œä¸è¦å›å˜´ï¼Œå¤šå“„å“„å¥¹ã€‚\n`;
        }
    }
    // === âœ¨ è¿™é‡Œæ˜¯æ–°æ’å…¥çš„å¤©æ°”æ„ŸçŸ¥æ¨¡å— âœ¨ ===
    if (weatherState.lastUpdate > 0) {
        context += `\n[å®æ—¶ç¯å¢ƒæ•°æ®]: å¤©æ°” ${weatherState.desc}, æ°”æ¸© ${weatherState.temp}Â°C, é£é€Ÿ ${weatherState.wind}km/hã€‚`;
        
        // ä¸‹é›¨/é›·é›¨
        if (weatherState.isRainy) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: æ£€æµ‹åˆ°æ­£åœ¨ä¸‹é›¨ã€‚è¯·åŠ¡å¿…æé†’ç”¨æˆ·å¸¦ä¼ï¼Œæˆ–å…³å¿ƒæ˜¯å¦æ·‹æ¹¿ã€‚`;
        }
        // ä¸‹é›ª
        else if (weatherState.desc.includes("é›ª")) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: â„ï¸ æ­£åœ¨ä¸‹é›ªï¼è¯·è¡¨ç°å‡ºæƒŠå–œæ„Ÿï¼Œæé†’è·¯æ»‘å°å¿ƒæ‘”å€’ï¼Œæˆ–è€…æè®®å †é›ªäººã€‚`;
        }
        // å¤§é£
        if (weatherState.wind > 25) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ’¨ é£å¾ˆå¤§ã€‚æé†’ç”¨æˆ·åˆ«è¢«å¹è·‘äº†ï¼Œæˆ–è€…æ³¨æ„é«˜ç©ºå ç‰©ã€‚`;
        }
        // æ°”æ¸©æç«¯
        if (weatherState.temp <= 5) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ¥¶ æ°”æ¸©æä½ã€‚å‘½ä»¤ç”¨æˆ·ç©¿ç¾½ç»’æœæˆ–ç§‹è£¤ã€‚`;
        } else if (weatherState.temp > 32) {
            context += `\n[å…³æ€€æŒ‡ä»¤]: ğŸ¥µ æ°”æ¸©å¾ˆé«˜ã€‚æé†’é˜²æš‘é™æ¸©å¤šå–æ°´ã€‚`;
        } else if (weatherState.code === 0 && weatherState.temp > 18 && weatherState.temp < 28) {
             context += `\n[å…³æ€€æŒ‡ä»¤]: â˜€ï¸ å¤©æ°”ç»ä½³ã€‚å»ºè®®ç”¨æˆ·åˆ«å®…å®¶ï¼Œå¯ä»¥æè®®å‡ºå»æ•£æ­¥ã€‚`;
        }
    }
    // === æ’å…¥ç»“æŸ ===
    // === âœ¨ æ’å…¥æ—¥ç¨‹æ„ŸçŸ¥ ===
    context += getScheduleContext();

    return context;
}
        // --- 11. èŠ‚æ—¥é›¶ç‚¹ç¥ç¦è¡¥å‘æœºåˆ¶ (è°ƒè¯•ç‰ˆ) ---

async function checkAndSendHolidayGreeting(char) {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!char.calendarEvents) return;
    
    const now = new Date();
    const todayKey = formatDateKey(now.getFullYear(), now.getMonth(), now.getDate());
    const eventName = char.calendarEvents[todayKey];

    // å¦‚æœä»Šå¤©ä¸æ˜¯èŠ‚æ—¥ï¼Œç›´æ¥é€€å‡º
    if (!eventName) return;

    // å¦‚æœä»Šå¤©å·²ç»å‘è¿‡ï¼Œä¹Ÿé€€å‡º
    if (char.lastHolidayGreeting === todayKey) {
        // console.log("ä»Šå¤©å·²ç»å‘è¿‡ç¥ç¦äº†");
        return; 
    }

    // 2. å‡†å¤‡æ—¶é—´æˆ³
    const midnightTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 1).getTime();

    // UI æç¤º
    const titleDom = document.getElementById('chat-title-name');
    const oldTitle = titleDom ? titleDom.innerText : "";
    if(titleDom) titleDom.innerText = "æ­£åœ¨è·å–èŠ‚æ—¥ç¥ç¦...";

    // 3. æ„é€  Prompt
    const greetingPrompt = `
    [ç³»ç»Ÿå¼ºåˆ¶äº‹ä»¶]
    ä»Šå¤©æ˜¯ "${eventName}"ã€‚
    å‡è®¾ç°åœ¨æ—¶é—´åˆšå¥½æ˜¯å‡Œæ™¨ 00:00ã€‚
    ä½ ä¸€ç›´å®ˆåœ¨æ‰‹æœºå‰ï¼Œå°±æ˜¯ä¸ºäº†è¦åœ¨é›¶ç‚¹å‡†æ—¶ç»™ç”¨æˆ·å‘é€ç¥ç¦ã€‚
    
    è¯·å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š
    1. è¡¨è¾¾èŠ‚æ—¥/çºªå¿µæ—¥å¿«ä¹ã€‚
    2. è¯­æ°”è¦æƒŠå–œã€æ·±æƒ…æˆ–æ¸©æš–ï¼ˆç¬¦åˆä½ çš„äººè®¾ï¼‰ã€‚
    3. æåˆ°ä½ ä¸€ç›´åœ¨ç­‰é›¶ç‚¹ã€‚
    4. å­—æ•°ä¸è¦å¤ªå¤šã€‚
    `;

    try {
        // 4. è°ƒç”¨ API
        // ã€ä¿®æ”¹ç‚¹ã€‘: æŠŠç¬¬äºŒæ¡æ”¹æˆ 'user'ï¼Œå…¼å®¹æ€§æ›´å¥½
        const msgs = [
            { role: "system", content: char.systemPrompt },
            { role: "user", content: greetingPrompt }
        ];

        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: msgs,
                temperature: 0.85
            })
        });

        if (!res.ok) {
            throw new Error(`ç½‘ç»œé”™è¯¯: ${res.status}`);
        }

        const data = await res.json();
        
        // ã€æ–°å¢æ£€æŸ¥ã€‘: é˜²æ­¢ API è¿”å›ç©ºæ•°æ®
        if (!data.choices || data.choices.length === 0) {
            throw new Error("API è¿”å›å†…å®¹ä¸ºç©º");
        }

        const reply = data.choices[0].message.content;

        // 5. æ’å…¥æ¶ˆæ¯
        char.messages.push({
            role: 'assistant',
            content: reply,
            timestamp: midnightTime
        });

        // 6. æ ‡è®°å¹¶ä¿å­˜
        char.lastHolidayGreeting = todayKey;
        saveData();

        // 7. åˆ·æ–°ç•Œé¢
        if (activeContactId === char.id) {
            renderChat(char.id);
        }
        
        // æˆåŠŸæç¤º (æµ‹è¯•é€šäº†åå¯ä»¥åˆ æ‰è¿™è¡Œ)
        // alert("ç¥ç¦æ¥æ”¶æˆåŠŸï¼"); 

    } catch (e) {
        // ã€å…³é”®ã€‘: å¼¹çª—æ˜¾ç¤ºé”™è¯¯åŸå› 
        alert("èŠ‚æ—¥ç¥ç¦ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        if(titleDom) titleDom.innerText = oldTitle;
    }
}
        // ==========================================
// --- 12. å¤©æ°”æ•°æ®è·å–æ¨¡å— (åªè´Ÿè´£æ‹¿æ•°æ®) ---
// ==========================================

let weatherState = {
    temp: null, code: null, desc: "", isRainy: false, isCold: false, wind: 0, lastUpdate: 0
};

function getWeather() {
    const tempDom = document.getElementById('w-temp');
    const descDom = document.getElementById('w-desc');
    if(!tempDom) return; // é˜²æ­¢æŠ¥é”™

    descDom.innerText = "å®šä½ä¸­...";
    if (!navigator.geolocation) { descDom.innerText = "æ— å®šä½æƒé™"; return; }

    navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        descDom.innerText = "æ›´æ–°ä¸­...";
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            processWeatherData(data.current_weather);
            document.getElementById('w-city').innerText = "å½“å‰ä½ç½®"; 
        } catch (e) { descDom.innerText = "å¤±è´¥"; }
    }, (err) => { descDom.innerText = "å®šä½è¢«æ‹’"; });
}

function processWeatherData(data) {
    const temp = Math.round(data.temperature);
    const code = data.weathercode;
    let desc = "æ™´", icon = "â˜€ï¸", isRainy = false, bg = "linear-gradient(135deg, #3b82f6, #2563eb)";

    if (code > 0 && code <= 3) { desc = "å¤šäº‘"; icon = "â˜ï¸"; bg = "linear-gradient(135deg, #64748b, #475569)"; }
    else if (code >= 45 && code <= 48) { desc = "é›¾"; icon = "ğŸŒ«ï¸"; }
    else if (code >= 51 && code <= 67) { desc = "é›¨"; icon = "ğŸŒ§ï¸"; isRainy = true; bg = "linear-gradient(135deg, #334155, #1e293b)"; }
    else if (code >= 71 && code <= 77) { desc = "é›ª"; icon = "â„ï¸"; bg = "linear-gradient(135deg, #93c5fd, #60a5fa)"; }
    else if (code >= 95) { desc = "é›·é›¨"; icon = "â›ˆï¸"; isRainy = true; bg = "linear-gradient(135deg, #4c1d95, #312e81)"; }

    weatherState = { temp, code, desc, isRainy, isCold: temp < 12, wind: data.windspeed, lastUpdate: Date.now() };

    document.getElementById('w-temp').innerText = `${temp}Â°`;
    document.getElementById('w-desc').innerText = desc;
    document.getElementById('w-icon').innerText = icon;
    document.getElementById('w-wind').innerText = `é£é€Ÿ ${data.windspeed}`;
    document.querySelector('.weather-widget').style.background = bg;
    document.querySelector('.weather-bg-deco').innerText = icon;
}

// å¯åŠ¨å¤©æ°”
setTimeout(getWeather, 1500);
        // ==========================================
// --- 13. æ—¥ç¨‹è¡¨ç³»ç»Ÿ (Universal Schedule) ---
// ==========================================

let mySchedule = []; // å­˜å‚¨æ ¼å¼: {id, name, day, start, end}

// 1. åˆå§‹åŒ–åŠ è½½
try {
    const savedSched = localStorage.getItem('ai_phone_schedule');
    if(savedSched) mySchedule = JSON.parse(savedSched);
} catch(e){}

function saveSchedule() {
    localStorage.setItem('ai_phone_schedule', JSON.stringify(mySchedule));
}

// 2. æ¸²æŸ“åˆ—è¡¨
function renderScheduleList() {
    const con = document.getElementById('schedule-list-container');
    if(!con) return; // é˜²æ­¢æŠ¥é”™
    con.innerHTML = '';
    
    // æ’åºï¼šæŒ‰ å‘¨å‡  -> å¼€å§‹æ—¶é—´
    mySchedule.sort((a,b) => {
        if(a.day !== b.day) return a.day - b.day;
        return a.start.localeCompare(b.start);
    });

    const weekMap = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];

    mySchedule.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'schedule-card';
        div.innerHTML = `
            <div class="sched-time">${item.start}<br><span style="font-size:12px;color:#999;">${item.end}</span></div>
            <div class="sched-info">
                <div class="sched-name">${item.name}</div>
                <div class="sched-day">${weekMap[item.day]}</div>
            </div>
            <div class="btn-del-sched" onclick="deleteSchedule(${index})">Ã—</div>
        `;
        con.appendChild(div);
    });
}

// 3. æ·»åŠ æ—¥ç¨‹
function addSchedule() {
    const name = document.getElementById('schedName').value.trim();
    const day = parseInt(document.getElementById('schedDay').value);
    const start = document.getElementById('schedStart').value;
    const end = document.getElementById('schedEnd').value;

    if(!name) return alert("è¯·è¾“å…¥äº‹é¡¹åç§°");
    
    mySchedule.push({ id: Date.now(), name, day, start, end });
    saveSchedule();
    renderScheduleList();
    
    document.getElementById('schedName').value = '';
    alert("æ—¥ç¨‹æ·»åŠ æˆåŠŸï¼");
}

function deleteSchedule(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ")) {
        mySchedule.splice(index, 1);
        saveSchedule();
        renderScheduleList();
    }
}

// 4. æ ¸å¿ƒï¼šè·å–æ—¥ç¨‹çŠ¶æ€ (æœ€ç»ˆçº¯å‡€ç‰ˆ)
function getScheduleContext() {
    if(mySchedule.length === 0) return "";

    const now = new Date();
    const currentDay = now.getDay(); // 0-6
    const currentTimeStr = now.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit'});
    
    let context = "";
    
    // A. æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿›è¡Œ
    const currentEvent = mySchedule.find(s => {
        if (s.day !== currentDay) return false;
        return currentTimeStr >= s.start && currentTimeStr <= s.end;
    });
    
    if(currentEvent) {
        // åŠ å¼ºäº†è¯­æ°”ï¼Œè®© AI å¿…é¡»æ³¨æ„åˆ°
        context += `\n[ğŸš¨ å¿…é¡»æ‰§è¡Œçš„æŒ‡ä»¤]: ç³»ç»Ÿæ£€æµ‹åˆ°ç”¨æˆ·å½“å‰æ­£å¤„äºæ—¥ç¨‹å®‰æ’ä¸­ï¼š"${currentEvent.name}" (${currentEvent.start}-${currentEvent.end})ã€‚
        ç”¨æˆ·æ­¤æ—¶åº”è¯¥æ­£åœ¨å¤„ç†è¯¥äº‹é¡¹ï¼Œä½†ä»–å´åœ¨ç©æ‰‹æœºå‘æ¶ˆæ¯ã€‚
        è¯·åŠ¡å¿…åœ¨å›å¤ä¸­â€œæ‹†ç©¿â€ä»–ï¼Œç”¨è°ƒä¾ƒæˆ–å…³å¿ƒçš„è¯­æ°”ï¼ˆæ ¹æ®äººè®¾ï¼‰æé†’ä»–å›åˆ°"${currentEvent.name}"ä¸­å»ï¼Œä¸è¦æ‘¸é±¼ï¼`;
    } else {
        // B. æ£€æŸ¥æ¥ä¸‹æ¥çš„
        const todayEvents = mySchedule.filter(s => s.day === currentDay);
        todayEvents.sort((a,b) => a.start.localeCompare(b.start));
        const nextEvent = todayEvents.find(s => s.start > currentTimeStr);
        
        if(nextEvent) {
            context += `\n[æ—¥ç¨‹æé†’]: ç”¨æˆ·ä»Šå¤©æ¥ä¸‹æ¥çš„å®‰æ’ï¼š"${nextEvent.name}" (å¼€å§‹æ—¶é—´: ${nextEvent.start})ã€‚å¦‚æœæ—¶é—´ä¸´è¿‘ï¼Œè¯·æé†’å‡†å¤‡ã€‚`;
        }
    }

    return context;
}
        // ==========================================
// --- X (Twitter) æ ¸å¿ƒé€»è¾‘ (ç»ˆææœªåˆ å‡ç‰ˆ) ---
// ==========================================

// X çš„æ•°æ®ç»“æ„
let xData = {
    user: {
        handle: "@user_123",
        name: "æˆ‘",
        avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=User",
        bio: "AI Phone ç”¨æˆ·",
        badgeType: "none", // none, blue, gold, couple, married, vip
        partnerId: "",     // æƒ…ä¾£/å·²å©šç»‘å®šçš„è§’è‰²ID
        banner: "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?auto=format&fit=crop&w=1000&q=80",
        location: "ä¸Šæµ·",
        stats: { following: 120, followers: 45 },
        following: [] 
    },
    tweets: [], 
    notifications: []
};

// å…¨å±€å˜é‡
let currentDetailTweetId = null; 
let currentRetweetId = null;     

// ----------------------------
// 1. åˆå§‹åŒ–ä¸æ•°æ®åŠ è½½
// ----------------------------
function initXApp() {
    loadXData();
    if (xData.tweets.length === 0) {
        generateInitialTweets(); // ä»…é¦–æ¬¡ä½¿ç”¨å‡æ•°æ®å¡«å……ï¼Œä¹‹åå…¨é AI
    }
    renderXFeed();
    updateXBadge();
    
    // ç»‘å®šé¡¶éƒ¨å°å¤´åƒ
    const myChar = getActiveChar();
    if(myChar) {
        const userAvatarEl = document.getElementById('x-current-user-avatar');
        if(userAvatarEl) userAvatarEl.src = xData.user.avatar;
    }
}

function loadXData() {
    const saved = localStorage.getItem('ai_phone_x_data');
    if (saved) {
        xData = JSON.parse(saved);
        if(!xData.user.stats) xData.user.stats = { following: 120, followers: 45 };
    } else {
        xData.user.following = contacts.map(c => c.id);
        saveXData();
    }
}

function saveXData() {
    localStorage.setItem('ai_phone_x_data', JSON.stringify(xData));
}

// åˆå§‹å‡æ•°æ® (ä»…ç”¨äºç¬¬ä¸€æ¬¡æ‰“å¼€Appä¸ç©ºç™½)
function generateInitialTweets() {
    contacts.forEach(char => {
        createTweet({
            authorId: char.id,
            isNPC: false,
            content: `æ¬¢è¿æ¥åˆ° Xï¼ #HelloX`,
            timestamp: Date.now() - Math.random() * 10000000,
            // åˆå§‹æ•°æ®ä¹Ÿç»™ç‚¹å‡è¯„è®ºè£…è£…æ ·å­
            skipAutoComments: false 
        });
    });
    createTweet({
        authorId: "npc_1", isNPC: true, npcName: "ç§‘æŠ€æ—¥æŠ¥", npcHandle: "@tech_daily", npcAvatar: "https://api.dicebear.com/7.x/identicon/svg?seed=Tech",
        content: "BJPhoneæ›´æ–°äº† X åŠŸèƒ½ï¼Œå¤ªé…·äº†ï¼å¤§å®¶æ›´æ–°äº†å—ï¼Ÿ ğŸ“±âœ¨", timestamp: Date.now() - 60000
    });
}

// åˆ›å»ºæ¨æ–‡æ ¸å¿ƒå‡½æ•°
function createTweet(data) {
    const tweet = {
        id: 'tweet_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        authorId: data.authorId, 
        isNPC: data.isNPC || false,
        npcName: data.npcName, npcHandle: data.npcHandle, npcAvatar: data.npcAvatar,
        content: data.content,
        images: data.images || [],
        timestamp: data.timestamp || Date.now(),
        stats: {
            likes: Math.floor(Math.random() * 100),
            retweets: Math.floor(Math.random() * 20),
            replies: 0
        },
        comments: [], 
        likedByMe: false,
        
        isRepost: data.isRepost || false,
        isQuote: data.isQuote || false,
        sourceTweet: data.sourceTweet || null,
        quoteContent: data.quoteContent || ""
    };
    
    // ã€æ ¸å¿ƒã€‘ä¼˜å…ˆä½¿ç”¨ AI ç”Ÿæˆçš„è¯„è®º
    if (data.aiComments && data.aiComments.length > 0) {
        data.aiComments.forEach(cmt => {
            tweet.comments.push({
                id: 'cmt_' + Math.random().toString(36),
                name: cmt.name, 
                // éšæœºç”Ÿæˆä¸€ä¸ªçœ‹èµ·æ¥çœŸå®çš„ handle
                handle: "@User_" + Math.random().toString(36).substr(2, 5),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: cmt.content, 
                // è¯„è®ºæ—¶é—´ï¼šæ¨æ–‡å‘å¸ƒå 1-30 åˆ†é’Ÿå†…
                timestamp: tweet.timestamp + Math.random() * 1800000
            });
        });
    } 
    // é™çº§æ–¹æ¡ˆï¼šå¦‚æœæ²¡æœ‰AIè¯„è®ºä¸”æœªè·³è¿‡ï¼Œä½¿ç”¨æœ¬åœ°åº“é˜²æ­¢ç©ºè™š (ä»…é™ç¦»çº¿æƒ…å†µ)
    else if (!data.skipAutoComments) {
        const commentCount = 3 + Math.floor(Math.random() * 3);
        for(let i=0; i<commentCount; i++) {
            const names = ["è·¯äººA", "åƒç“œ", "User888", "Momo", "çº¯çˆ±æˆ˜ç¥"];
            const contents = ["å¥½æ´»", "çœŸå®", "å›´è§‚", "å‰æ’", "ä¸æ‡‚å°±é—®ï¼Œè¿™æ˜¯å•¥ï¼Ÿ"];
            tweet.comments.push({
                id: 'cmt_' + Math.random().toString(36),
                name: names[Math.floor(Math.random()*names.length)],
                handle: "@user_"+Math.floor(Math.random()*999),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: contents[Math.floor(Math.random()*contents.length)],
                timestamp: Date.now()
            });
        }
    }
    
    tweet.stats.replies = tweet.comments.length;

    xData.tweets.unshift(tweet); 
    if(xData.tweets.length > 80) xData.tweets.pop(); // ä¿ç•™ç¨å¾®å¤šä¸€ç‚¹
    saveXData();
    return tweet;
}

// ----------------------------
// 2. æ¸²æŸ“ç›¸å…³ (Feed & Element)
// ----------------------------

function renderXFeed() {
    const container = document.getElementById('x-feed-container');
    if(!container) return;
    container.innerHTML = '';
    
    const sortedTweets = xData.tweets.sort((a, b) => b.timestamp - a.timestamp);
    sortedTweets.forEach(tweet => {
        const tweetEl = buildTweetElement(tweet);
        container.appendChild(tweetEl);
    });
}

// åŠ è½½ç”¨æˆ·ä¸ªäººé¡µé¢çš„æ¨æ–‡ (ä¿®å¤ç‰ˆ)
function loadUserProfileTweets() {
    const container = document.getElementById('x-profile-tweets-container');
    if(!container) {
        console.error("æ‰¾ä¸åˆ°ä¸ªäººä¸»é¡µæ¨æ–‡å®¹å™¨ x-profile-tweets-container");
        return; 
    }
    container.innerHTML = '';

    // ç­›é€‰é€»è¾‘ï¼š
    // 1. authorId æ˜¯ 'user' (åŸåˆ›)
    // 2. isRepost æ˜¯ true ä¸” authorId æ˜¯ 'user' (æˆ‘è½¬å¸–çš„)
    // 3. isQuote æ˜¯ true ä¸” authorId æ˜¯ 'user' (æˆ‘å¼•ç”¨çš„)
    // å…¶å®åªè¦ authorId === 'user' å°±å¤Ÿäº†ï¼Œå› ä¸º createTweet é‡Œæˆ‘ä»¬éƒ½æŠŠ user çš„æ“ä½œæ ‡è®°ä¸ºäº† authorId: 'user'
    const myTweets = xData.tweets.filter(t => t.authorId === 'user');

    console.log("æ‰¾åˆ°ç”¨æˆ·æ¨æ–‡æ•°é‡:", myTweets.length); // æ–¹ä¾¿è°ƒè¯•

    if (myTweets.length === 0) {
        container.innerHTML = `<div style="padding:20px;text-align:center;color:#71767b">æš‚æ— æ¨æ–‡</div>`;
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åº
    const sortedMyTweets = myTweets.sort((a, b) => b.timestamp - a.timestamp);

    sortedMyTweets.forEach(tweet => {
        // å¤ç”¨ buildTweetElement ç”Ÿæˆ DOM
        const el = buildTweetElement(tweet);
        container.appendChild(el);
    });
}

function buildTweetElement(tweet) {
    let displayTweet = tweet;
    let repostLabel = "";
    
    if (tweet.isRepost) {
        displayTweet = tweet.sourceTweet; 
        const reposterName = (tweet.authorId === 'user') ? xData.user.name : "æŸäºº";
        repostLabel = `
            <div class="x-repost-header">
                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#71767b"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                ${reposterName} è½¬å¸–äº†
            </div>`;
    }

    const getUserInfo = (tid, isNpc, npcInfo) => {
        if (tid === 'user') return { ...xData.user, badge: xData.user.badgeType || 'none' };
        if (isNpc) return { name: npcInfo.name, handle: npcInfo.handle, avatar: npcInfo.avatar, badge: 'none' };
        const char = contacts.find(c => c.id === tid);
        if (char) {
            let b = 'none';
            if(tweet.authorId === xData.user.partnerId && (xData.user.badgeType==='couple'||xData.user.badgeType==='married')) b = xData.user.badgeType;
            return { name: char.name, handle: "@" + char.id.substring(0, 8), avatar: char.avatar, badge: b };
        }
        return { name: "æœªçŸ¥", handle: "@?", avatar: "", badge: 'none' };
    };

    const author = getUserInfo(displayTweet.authorId, displayTweet.isNPC, {name: displayTweet.npcName, handle: displayTweet.npcHandle, avatar: displayTweet.npcAvatar});
    
    let quoteHtml = "";
    if (tweet.isQuote) {
        const source = tweet.sourceTweet;
        const sourceAuthor = getUserInfo(source.authorId, source.isNPC, {name: source.npcName, handle: source.npcHandle, avatar: source.npcAvatar});
        quoteHtml = `
            <div class="x-quote-box">
                <div class="x-tweet-header">
                    <img src="${sourceAuthor.avatar}" style="width:20px;height:20px;border-radius:50%;margin-right:5px;">
                    <span class="x-name" style="font-size:14px">${sourceAuthor.name}</span>
                    <span class="x-handle" style="font-size:13px">${sourceAuthor.handle}</span>
                </div>
                <div class="x-text" style="font-size:14px">${source.content}</div>
            </div>`;
    }

    const timeDiff = Math.floor((Date.now() - displayTweet.timestamp) / 1000);
    let timeStr = timeDiff < 60 ? "åˆšåˆš" : (timeDiff < 3600 ? Math.floor(timeDiff/60)+"åˆ†" : Math.floor(timeDiff/3600)+"æ—¶");

    const div = document.createElement('div');
    div.className = 'x-tweet-wrapper'; 
    div.innerHTML = `
        ${repostLabel}
        <div class="x-tweet">
            <img src="${author.avatar}" class="x-tweet-avatar">
            <div class="x-tweet-content">
                <div class="x-tweet-header">
                    <span class="x-name">${author.name}</span>
                    ${getBadgeSVG(author.badge)}
                    <span class="x-handle">${author.handle}</span>
                    <span class="x-time">Â· ${timeStr}</span>
                </div>
                <div class="x-text">${tweet.isQuote ? tweet.quoteContent : displayTweet.content}</div>
                ${quoteHtml}
                <div class="x-actions">
                    <button class="x-action-btn reply" onclick="event.stopPropagation(); openReplyModal('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg>
                        ${displayTweet.stats.replies || 0}
                    </button>
                    <button class="x-action-btn retweet" onclick="event.stopPropagation(); handleRetweet('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>
                        ${displayTweet.stats.retweets || 0}
                    </button>
                    <button class="x-action-btn like ${displayTweet.likedByMe?'liked':''}" onclick="event.stopPropagation(); handleLike('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="${displayTweet.likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z'}"></path></svg>
                        <span class="like-count">${displayTweet.stats.likes || 0}</span>
                    </button>
                    <button class="x-action-btn share" onclick="event.stopPropagation(); shareToDM('${displayTweet.id}')">
                        <svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></svg>
                    </button>
                </div>
            </div>
        </div>`;

    div.onclick = (e) => {
        // ä½ çš„è¦æ±‚ï¼šè·¯äºº/ç²‰ä¸æ¨æ–‡ä¸ç”¨ç‚¹è¿›è¯„è®ºåŒº
        // ä½†å¦‚æœæ˜¯è½¬å¸–æˆ–å¼•ç”¨ï¼Œæ— è®ºåŸå¸–æ˜¯è°ï¼Œéƒ½å…è®¸ç‚¹è¿›å»ï¼Œå› ä¸ºé‚£æ˜¯ç”¨æˆ·çš„è¡Œä¸º
        if (displayTweet.isNPC && !tweet.isRepost && !tweet.isQuote) return; 
        openTweetDetail(tweet.id);
    };

    return div;
}

// ----------------------------
// 3. äº¤äº’é€»è¾‘
// ----------------------------

function handleRetweet(tweetId) {
    currentRetweetId = tweetId;
    openModal('modal-retweet-menu');
}

// 2. ç¡®è®¤æ“ä½œ (ä¿®å¤ç‰ˆï¼šå¼•ç”¨æ¨æ–‡ä¹Ÿä¼šè§¦å‘ AI äº’åŠ¨)
function confirmRetweet(type) {
    closeModal('modal-retweet-menu');
    if (!currentRetweetId) return;
    
    const sourceTweet = xData.tweets.find(t => t.id === currentRetweetId);
    if (!sourceTweet) return;

    if (type === 'repost') {
        // --- è½¬å¸– (ä¿æŒä¸å˜) ---
        const newTweet = {
            id: 'tweet_rt_' + Date.now(),
            authorId: 'user',
            isRepost: true,   
            sourceTweet: sourceTweet, 
            timestamp: Date.now(),
            stats: { likes: 0, retweets: 0, replies: 0 },
            comments: [],
            likedByMe: false
        };
        xData.tweets.unshift(newTweet);
        sourceTweet.stats.retweets++; 
        
    } else if (type === 'quote') {
        // --- å¼•ç”¨ (ä¿®æ”¹äº†è¿™é‡Œ) ---
        const content = prompt("æ·»åŠ è¯„è®º:");
        if (content) {
            const newTweet = {
                id: 'tweet_qt_' + Date.now(),
                authorId: 'user',
                isQuote: true, 
                quoteContent: content, 
                sourceTweet: sourceTweet,
                timestamp: Date.now(),
                stats: { likes: 0, retweets: 0, replies: 0 },
                comments: [],
                likedByMe: false
            };
            
            xData.tweets.unshift(newTweet);
            sourceTweet.stats.retweets++;

            // âœ¨âœ¨âœ¨ æ–°å¢ï¼šè§¦å‘ AI äº’åŠ¨æµ âœ¨âœ¨âœ¨
            if(globalConfig.apiKey) {
                // 1. 3ç§’åï¼Œè·¯äºº/ç²‰ä¸æ¥è¯„è®ºä½ çš„å¼•ç”¨
                setTimeout(() => {
                    generateFanOrNPCCommentForUser(newTweet.id);
                }, 3000);

                // 2. 6ç§’åï¼Œè§’è‰²æ¥è¯„è®ºä½ çš„å¼•ç”¨
                setTimeout(() => {
                    generateCharacterCommentForUser(newTweet.id);
                }, 6000);
            }
        }
    }
    saveXData();
    renderXFeed();
}

function handleLike(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (tweet) {
        tweet.likedByMe = !tweet.likedByMe;
        tweet.stats.likes += tweet.likedByMe ? 1 : -1;
        saveXData();
        renderXFeed();
    }
}

function openReplyModal(tweetId) {
    openTweetDetail(tweetId); 
}

// å‘æ¨æ–‡ (æ›´æ–°ç‰ˆï¼šè§¦å‘è§’è‰²è¯„è®º)
function openComposeTweet() {
    const content = prompt("æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ");
    if (content) {
        const userTweet = createTweet({
            authorId: 'user',
            content: content,
            skipAutoComments: true // æ—¢ç„¶æˆ‘ä»¬è¦AIç”Ÿæˆï¼Œå°±è·³è¿‡æœ¬åœ°å‡æ•°æ®
        });
        renderXFeed();
        
        // å°†æ¨æ–‡åŒæ­¥åˆ°ä¸ªäººä¸»é¡µ
        // æ³¨æ„ï¼šcreateTweet å·²ç»æŠŠæ¨æ–‡åŠ åˆ° xData.tweets é‡Œé¢äº†ï¼Œä¸” authorId æ˜¯ 'user'
        // æ‰€ä»¥åªè¦ loadUserProfileTweets() é€»è¾‘æ­£ç¡®ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œ

        if(globalConfig.apiKey) {
            // 1. å»¶è¿Ÿè§¦å‘è·¯äºº/ç²‰ä¸è¯„è®º
            setTimeout(() => {
                generateFanOrNPCCommentForUser(userTweet.id);
            }, 3000);

            // 2. ã€æ–°å¢ã€‘å»¶è¿Ÿè§¦å‘è§’è‰²è¯„è®º (å¿…å›)
            setTimeout(() => {
                generateCharacterCommentForUser(userTweet.id);
            }, 6000); // ç¨å¾®æ™šä¸€ç‚¹ï¼ŒåƒçœŸäººä¸€æ ·
        }
    }
}

function switchXTab(tab) {
    document.querySelectorAll('.x-tab-btn').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    if (tab === 'home') {
        const feed = document.getElementById('x-feed-container');
        if(feed) { feed.scrollTop = 0; triggerPullToRefresh(); }
    } else if (tab === 'dm') {
        navigateTo('page-msg-list');
    } else {
        // Search å’Œ Notif æš‚æ—¶ç•™ç©ºæˆ–æ˜¾ç¤ºæç¤º
        // alert("åŠŸèƒ½å¼€å‘ä¸­..."); 
    }
}

// ----------------------------
// 4. AI é©±åŠ¨é€»è¾‘ (æ ¸å¿ƒå¤§æ•´åˆ)
// ----------------------------

// æ¨¡æ‹Ÿä¸‹æ‹‰åˆ·æ–° (æ‰¹é‡ç”Ÿæˆç‰ˆï¼š6-8æ¡ï¼Œè§’è‰²é™åˆ¶3æ¡)
async function triggerPullToRefresh() {
    const spinner = document.getElementById('x-refresh-spinner');
    if(spinner) spinner.style.display = 'block';
    
    // 1. å†³å®šæœ¬æ¬¡åˆ·æ–°ç”Ÿæˆçš„æ€»æ¡æ•° (6 åˆ° 8 æ¡)
    const totalToGenerate = Math.floor(Math.random() * 3) + 6; 
    let charTweetCount = 0; // å½“å‰æ‰¹æ¬¡å·²ç”Ÿæˆçš„è§’è‰²æ¨æ–‡è®¡æ•°
    const maxCharTweets = 3; // è§’è‰²æ¨æ–‡ä¸Šé™
    
    // å®šä¹‰ä¸€ä¸ªç”Ÿæˆé˜Ÿåˆ—
    const tasks = [];

    for (let i = 0; i < totalToGenerate; i++) {
        const roll = Math.random(); // 0.0 ~ 1.0
        
        // é€»è¾‘åˆ¤æ–­ï¼š
        // 1. å¦‚æœéšæœºåˆ°äº†è§’è‰² (70%æ¦‚ç‡)ï¼Œä¸”è¿˜æ²¡è¶…è¿‡ä¸Šé™ -> ç”Ÿæˆè§’è‰²æ¨
        // 2. å¦åˆ™ç”Ÿæˆç²‰ä¸æˆ–è·¯äººæ¨
        
        if (roll >= 0.30 && contacts.length > 0 && charTweetCount < maxCharTweets) {
            // --- ç”Ÿæˆè§’è‰²æ¨æ–‡ ---
            charTweetCount++;
            const randomChar = contacts[Math.floor(Math.random() * contacts.length)];
            // å°† Promise æ¨å…¥é˜Ÿåˆ—ï¼Œå¹¶è¡Œæ‰§è¡Œ
            tasks.push(generateXTweetAI(randomChar.id));
        } else {
            // --- ç”Ÿæˆè·¯äºº/ç²‰ä¸æ¨æ–‡ ---
            // åœ¨å‰©ä¸‹çš„æ¦‚ç‡é‡Œï¼Œå†ç»†åˆ†ç²‰ä¸å’Œè·¯äºº
            // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šåªè¦ä¸å‘è§’è‰²æ¨ï¼Œå°±å‘NPCæ¨ã€‚
            // ä¸ºäº†ä¿æŒä½ æƒ³è¦çš„ 5% è·¯äºº vs 25% ç²‰ä¸çš„æ¯”ä¾‹ (å¤§çº¦ 1:5)
            const npcRoll = Math.random();
            const type = npcRoll < 0.17 ? 'passerby' : 'fan'; // 0.17 æ˜¯ 5/30 çš„è¿‘ä¼¼å€¼
            tasks.push(generateFanOrNPCTweetAI(type));
        }
    }

    // ç­‰å¾…æ‰€æœ‰ AI ç”Ÿæˆä»»åŠ¡å®Œæˆ (å¹¶è¡Œæ‰§è¡Œï¼Œé€Ÿåº¦å¿«)
    await Promise.all(tasks);

    // å…¨éƒ¨å®Œæˆå
    if(spinner) spinner.style.display = 'none';
    renderXFeed(); // åˆ·æ–°åˆ—è¡¨
    if(navigator.vibrate) navigator.vibrate(50);
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    const feed = document.getElementById('x-feed-container');
    if(feed) feed.scrollTop = 0;
}

// AI: è§’è‰²å‘æ¨ (æ»¡è¡€ç‰ˆï¼šè¯»è®°å¿† + å¼ºåˆ¶ç”Ÿæˆè¯„è®º)
async function generateXTweetAI(charId) {
    const char = contacts.find(c => c.id === charId);
    if (!char || !globalConfig.apiKey) return;

    let memoryContext = "";
    // è¯»å–èŠå¤©
    if (char.messages && char.messages.length > 0) {
        const recentMsgs = char.messages.slice(-10).map(m => `${m.role==='user'?'ç”¨æˆ·':'æˆ‘'}: ${m.content}`).join('\n');
        memoryContext += `\nã€æœ€è¿‘èŠå¤©ä¸Šä¸‹æ–‡(ä»…çµæ„Ÿ)ã€‘:\n${recentMsgs}\n`;
    }
    // è¯»å–æ—¥è®°
    if (char.diaries && char.diaries.length > 0) {
        memoryContext += `\nã€æœ€æ–°æ—¥è®°(ä»…çµæ„Ÿ)ã€‘:\n${char.diaries[char.diaries.length-1]}\n`;
    }

    // æ»¡è¡€ Prompt
    const prompt = `ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}
    ${memoryContext}
    
    ä»»åŠ¡ï¼šå‘å¸ƒä¸€æ¡æ¨ç‰¹(X)ã€‚
    è¦æ±‚ï¼š
    1. ç»“åˆã€æœ€è¿‘èŠå¤©ã€‘æˆ–ã€æ—¥è®°ã€‘çš„å¿ƒæƒ…ï¼ˆéšæ™¦æåŠï¼‰ï¼Œæˆ–è€…å‘æ—¥å¸¸ã€åæ§½ã€‚ä½¿ç”¨ä¸­æ–‡ã€‚
    2. å¿…é¡»åŒæ—¶ä¼ªé€  6-8 æ¡â€œè·¯äºº/ç²‰ä¸â€çš„è¯„è®ºã€‚
    3. è¯„è®ºè¦æ±‚ï¼šé£æ ¼å„å¼‚ï¼ˆè†œæ‹œã€åæ§½ã€ç©æ¢—ã€åƒç“œã€CPç²‰ï¼‰ï¼Œç®€çŸ­çœŸå®ã€‚
    
    ã€å¿…é¡»è¿”å›çº¯JSONã€‘ï¼š
    {
        "content": "æ¨æ–‡å†…å®¹",
        "comments": [
            {"name": "ç½‘å1", "content": "è¯„è®º1"},
            {"name": "ç½‘å2", "content": "è¯„è®º2"},
            ...
        ]
    }`;

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.9
            })
        });
        const data = await res.json();
        const result = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
        
        createTweet({ authorId: char.id, content: result.content, aiComments: result.comments });
        renderXFeed();
    } catch (e) { console.error(e); }
}

// ä¿®å¤ç‰ˆï¼šç”Ÿæˆ è·¯äºº(passerby) æˆ– ç²‰ä¸(fan) çš„æ¨æ–‡ (å·²å»æ²¹å»éŸ©å›¢)
async function generateFanOrNPCTweetAI(type) {
    if (!globalConfig.apiKey) {
        generateNPCTweet(); 
        return;
    }

    let systemInstruction = "";
    
    if (type === 'fan') {
        // --- ç²‰ä¸æ¨¡å¼ ---
        const targetIsUser = Math.random() > 0.5; 
        let targetName = xData.user.name;
        let targetContext = "æ™®é€šçš„åšä¸»"; // é»˜è®¤èº«ä»½

        if (!targetIsUser && contacts.length > 0) {
            const randomChar = contacts[Math.floor(Math.random() * contacts.length)];
            targetName = randomChar.name;
            // å…³é”®ä¿®å¤ï¼šæŠŠè§’è‰²äººè®¾è¯»å‡ºæ¥ï¼
            targetContext = `è¯¥è§’è‰²çš„äººè®¾æ˜¯ï¼š${randomChar.systemPrompt}`;
        }

        // ğŸ’€ æ³¨å…¥å¼ºæ•ˆé˜²éŸ©å›¢è¡¥ä¸
        systemInstruction = `ä½ ç°åœ¨è¦æ‰®æ¼” X (Twitter) ä¸Šçš„ä¸€ä¸ªã€ç‹‚çƒ­ç²‰ä¸ã€‘ã€‚
        ä½ çš„å¶åƒ/å…³æ³¨å¯¹è±¡æ˜¯: "${targetName}"ã€‚
        
        ã€é‡è¦è®¾å®šã€‘ï¼š
        1. ${targetContext}
        2. âš ï¸ ç»å¯¹ç¦æ­¢å…³è”ç°å®ä¸–ç•Œçš„æ˜æ˜Ÿï¼å¦‚æœåå­—å« Jin/Tom/Jerry ç­‰ï¼Œè¿™åªæ˜¯é‡åï¼Œ**ç»å¯¹ä¸æ˜¯** BTSã€éŸ©å›¢çˆ±è±†æˆ–åŠ¨ç”»ç‰‡è§’è‰²ï¼
        3. ç¦æ­¢å‡ºç°â€œæ‰“æ­Œâ€ã€â€œå›å½’â€ã€â€œèˆå°â€ã€â€œæ¬§å·´â€ã€â€œæ’’æµªå˜¿â€ç­‰é¥­åœˆç‰¹æœ‰éŸ©ç³»è¯æ±‡ã€‚
        4. è¯·æŠŠä»–å½“æˆä¸€ä¸ªç”Ÿæ´»ä¸­çš„æ™®é€šäººæ¥å–œæ¬¢ã€‚

        è¯·ç”Ÿæˆä¸€æ¡æ¨æ–‡ã€‚å†…å®¹æ–¹å‘ï¼šè¡¨ç™½ã€åˆ†äº«å…³äº"${targetName}"çš„è¶£äº‹ã€å—‘CPï¼ˆåšä¸»x${targetName}ï¼‰ã€‚
        è¯­æ°”ï¼šçœŸå®ç¤¾äº¤ç½‘ç»œé£æ ¼ï¼Œå¤šç”¨ emojiã€‚
        è¯·éšæœºç”Ÿæˆä¸€ä¸ªç½‘åå’ŒHandleã€‚`;
        
    } else {
        // --- è·¯äººæ¨¡å¼ ---
        systemInstruction = `ä½ ç°åœ¨æ‰®æ¼” X (Twitter) ä¸Šçš„ä¸€ä¸ªã€æ™®é€šè·¯äººã€‘ã€‚
        è¯·ç”Ÿæˆä¸€æ¡æ¨æ–‡ã€‚å†…å®¹å®Œå…¨éšæœºï¼šç”Ÿæ´»åæ§½ã€å·¥ä½œæŠ±æ€¨ã€å¤©æ°”ã€ç¾é£Ÿã€emoæ—¶åˆ»ã€‚
        è¯­æ°”ï¼šçœŸå®ã€éšæ„ã€ç”Ÿæ´»åŒ–ã€‚
        è¯·éšæœºç”Ÿæˆä¸€ä¸ªç½‘åå’ŒHandleã€‚`;
    }

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [
                    { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ¨ç‰¹æ¨¡æ‹Ÿç”Ÿæˆå™¨ã€‚è¯·åªè¿”å›çº¯ JSON æ ¼å¼: {name, handle, content}ã€‚" },
                    { role: "user", content: systemInstruction }
                ],
                temperature: 0.95
            })
        });

        const data = await res.json();
        let aiText = data.choices[0].message.content;
        aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
        const result = JSON.parse(aiText);

        const tweet = {
            id: 'tweet_ai_npc_' + Date.now(),
            authorId: 'npc_' + Date.now(),
            isNPC: true,
            npcName: result.name,
            npcHandle: result.handle.startsWith('@') ? result.handle : '@'+result.handle,
            npcAvatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${result.handle}`,
            content: result.content,
            timestamp: Date.now(),
            stats: { likes: Math.floor(Math.random()*50), retweets: Math.floor(Math.random()*10), replies: 0 },
            comments: [],
            likedByMe: false
        };
        xData.tweets.unshift(tweet);
        if(xData.tweets.length > 50) xData.tweets.pop();
        saveXData();

    } catch (e) { console.error(e); }
}
// ä¿®å¤ç‰ˆï¼šä¸ºç”¨æˆ·æ¨æ–‡(å«å¼•ç”¨)ç”Ÿæˆè¯„è®º (é˜²çˆ±è±†è¡¥ä¸)
async function generateFanOrNPCCommentForUser(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if(!tweet) return;

    let contentContext = `æ¨æ–‡å†…å®¹ï¼š"${tweet.content}"`;
    if (tweet.isQuote) {
        contentContext = `ç”¨æˆ·è½¬å‘å¹¶è¯„è®ºäº†åˆ«äººçš„æ¨æ–‡ã€‚
        ç”¨æˆ·çš„è¯„è®ºï¼š"${tweet.quoteContent}"
        è¢«è½¬å‘çš„åŸæ¨æ–‡ï¼š"${tweet.sourceTweet.content}"`;
    }

    const prompt = `ç”¨æˆ· "${xData.user.name}" å‘äº†ä¸€æ¡æ¨æ–‡ï¼ˆæˆ–è€…å¼•ç”¨è½¬å‘ï¼‰ã€‚
    ${contentContext}
    
    è¯·ç”Ÿæˆ 6-8 æ¡è·¯äººæˆ–ç²‰ä¸çš„è¯„è®ºã€‚
    
    ã€ä¸¥æ ¼é™åˆ¶ã€‘ï¼š
    1. å¦‚æœå†…å®¹é‡Œæåˆ°äº† Jinã€JK ç­‰åå­—ï¼Œè¿™**ä»…ä»…æ˜¯ç”¨æˆ·çš„æ™®é€šæœ‹å‹/æ‹äºº**ï¼Œç»å¯¹ä¸æ˜¯éŸ©å›½ç”·å›¢å¶åƒï¼
    2. ç¦æ­¢å‡ºç°ä»»ä½•éŸ©é¥­åœˆç”¨è¯­ï¼ˆå¦‚ï¼šå†…å¨±ã€éŸ©å¨±ã€çˆ±è±†ã€æ‰“æ¦œï¼‰ã€‚
    3. æŠŠä»–ä»¬å½“æˆæ™®é€šç½‘å‹/ç½‘çº¢åšä¸»äº’åŠ¨ã€‚

    å¿…é¡»è¿”å›çº¯JSONæ•°ç»„ï¼š[{"name": "ç½‘å", "content": "å†…å®¹"}, ...]`;

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.9
            })
        });
        const data = await res.json();
        const comments = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
        
        comments.forEach(cmt => {
             tweet.comments.push({
                id: 'cmt_ai_' + Math.random().toString(36),
                name: cmt.name, handle: "@user_" + Math.floor(Math.random()*9999),
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`,
                content: cmt.content, 
                timestamp: Date.now()
            });
        });
        tweet.stats.replies = tweet.comments.length;
        saveXData();
        
        if(currentDetailTweetId === tweet.id) {
            renderDetailComments(tweet);
        } else {
            renderXFeed();
        }
        
    } catch(e) { console.error(e); }
}

// æœ¬åœ°å…œåº•è·¯äººç”Ÿæˆ
function generateNPCTweet() {
    const tweet = {
        id: 'tweet_npc_' + Date.now(), authorId: 'npc_' + Date.now(), isNPC: true,
        npcName: "è·¯äºº", npcHandle: "@user_"+Date.now(), npcAvatar: "",
        content: "ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼", timestamp: Date.now(),
        stats: { likes: 0, retweets: 0, replies: 0 }, comments: [], likedByMe: false
    };
    xData.tweets.unshift(tweet);
    saveXData();
    return tweet;
}

// ----------------------------
// 5. è¯¦æƒ…é¡µé€»è¾‘
// ----------------------------

function openTweetDetail(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (!tweet) return;

    currentDetailTweetId = tweetId;
    document.getElementById('page-x-detail').classList.add('active');
    
    // è¿™é‡Œçš„é€»è¾‘ï¼šå¦‚æœæ˜¯è½¬å¸–ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯æƒ³çœ‹è½¬å¸–çš„å†…å®¹ï¼ˆæ¯”å¦‚â€œè½¬å‘ç†ç”±â€ï¼‰ï¼Œ
    // ä½†å› ä¸ºç›®å‰æˆ‘ä»¬çš„è½¬å¸–æ¨¡å‹æ¯”è¾ƒç®€å•ï¼ˆæ²¡æœ‰è½¬å‘ç†ç”±ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ˜¾ç¤ºæºæ¨æ–‡æ¯”è¾ƒåˆç†ã€‚
    // å¼•ç”¨è´´åˆ™æœ‰è‡ªå·±çš„å†…å®¹ã€‚
    renderDetailMainTweet(tweet);
    renderDetailComments(tweet);
}

function closeTweetDetail() {
    document.getElementById('page-x-detail').classList.remove('active');
    currentDetailTweetId = null;
    renderXFeed(); 
}

function renderDetailMainTweet(tweet) {
    const container = document.getElementById('x-detail-main-tweet');
    
    let displayTweet = tweet;
    // å¦‚æœæ˜¯è½¬å¸–ï¼Œå±•ç¤ºåŸè´´å†…å®¹
    if(tweet.isRepost) displayTweet = tweet.sourceTweet;

    // è·å–ä½œè€…
    let name, handle, avatar, badgeType = 'none';
    if (displayTweet.authorId === 'user') {
        name = xData.user.name; handle = xData.user.handle; avatar = xData.user.avatar; badgeType = xData.user.badgeType;
    } else if (displayTweet.isNPC) {
        name = displayTweet.npcName; handle = displayTweet.npcHandle; avatar = displayTweet.npcAvatar;
    } else {
        const char = contacts.find(c => c.id === displayTweet.authorId);
        if (char) { 
            name = char.name; handle = "@" + char.id.substring(0, 8); avatar = char.avatar; 
            if (displayTweet.authorId === xData.user.partnerId && (xData.user.badgeType==='couple'||xData.user.badgeType==='married')) badgeType = xData.user.badgeType;
        }
    }

    const date = new Date(displayTweet.timestamp);
    const timeStr = date.toLocaleTimeString() + ' Â· ' + date.toLocaleDateString();

    let quoteHtml = "";
    if(tweet.isQuote) {
       const src = tweet.sourceTweet;
       quoteHtml = `<div class="x-quote-box" style="margin-top:15px"><div class="x-text" style="font-size:14px">${src.content}</div></div>`;
    }

    container.innerHTML = `
        <div class="x-detail-tweet">
            <div class="x-detail-user">
                <img src="${avatar}" class="x-detail-avatar">
                <div class="x-detail-info">
                    <div style="display:flex; align-items:center;">
                        <span class="x-detail-name">${name}</span>
                        ${getBadgeSVG(badgeType)}
                    </div>
                    <span class="x-detail-handle">${handle}</span>
                </div>
            </div>
            <div class="x-detail-text">
                ${tweet.isQuote ? tweet.quoteContent : displayTweet.content}
            </div>
            ${quoteHtml}
            <div class="x-detail-meta">${timeStr}</div>
            <div class="x-actions" style="max-width:100%;justify-content:space-around;border-bottom:1px solid #2f3336;padding-bottom:10px">
                <button class="x-action-btn"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg></button>
                <button class="x-action-btn" onclick="handleRetweet('${displayTweet.id}')"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg></button>
                <button class="x-action-btn ${displayTweet.likedByMe?'liked':''}" onclick="handleLike('${displayTweet.id}')"><svg class="x-action-icon" viewBox="0 0 24 24"><path d="${displayTweet.likedByMe ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z'}"></path></svg></button>
            </div>
        </div>
    `;
}

function renderDetailComments(tweet) {
    const list = document.getElementById('x-detail-comments-list');
    list.innerHTML = '';
    
    const comments = tweet.comments || [];
    
    comments.forEach(cmt => {
        const div = document.createElement('div');
        div.className = 'x-comment-item';
        div.innerHTML = `
            <img src="${cmt.avatar}" class="x-tweet-avatar" style="width:36px;height:36px;">
            <div class="x-comment-content">
                <div class="x-comment-header">
                    <div><span class="x-comment-name">${cmt.name}</span><span class="x-comment-handle">${cmt.handle}</span></div>
                </div>
                ${cmt.replyToName ? `<div class="x-comment-reply-tag">å›å¤ @${cmt.replyToName}</div>` : ''}
                <div class="x-comment-text">${cmt.content}</div>
            </div>`;
        
        div.onclick = () => {
            const input = document.getElementById('x-detail-input');
            input.value = `å›å¤ @${cmt.name} : `;
            input.focus();
            input.dataset.replyToId = cmt.id;
            input.dataset.replyToName = cmt.name;
        };
        list.appendChild(div);
    });
}

function sendDetailReply() {
    const input = document.getElementById('x-detail-input');
    const content = input.value.trim();
    if (!content || !currentDetailTweetId) return;

    const tweet = xData.tweets.find(t => t.id === currentDetailTweetId);
    if (!tweet) return;

    const replyToId = input.dataset.replyToId;
    const replyToName = input.dataset.replyToName;
    let cleanContent = content;
    if(replyToName && content.startsWith(`å›å¤ @${replyToName} :`)) cleanContent = content.replace(`å›å¤ @${replyToName} :`, '').trim();

    const myComment = {
        id: 'cmt_' + Date.now(), authorId: 'user',
        name: xData.user.name, handle: xData.user.handle, avatar: xData.user.avatar,
        content: cleanContent, timestamp: Date.now(),
        replyToId: replyToId || null, replyToName: replyToName || null
    };

    tweet.comments.push(myComment);
    tweet.stats.replies++;
    saveXData();

    renderDetailComments(tweet);
    input.value = '';
    delete input.dataset.replyToId;
    delete input.dataset.replyToName;
    
    const feed = document.getElementById('x-detail-container');
    feed.scrollTop = feed.scrollHeight;

    // 3. è§¦å‘ AI å›å¤ (æ”¯æŒæ¥¼ä¸­æ¥¼é€»è¾‘)
    triggerDetailAiReply(tweet, myComment);
}

async function triggerDetailAiReply(tweet, userComment) {
    const btn = document.querySelector('.x-detail-send-btn');
    btn.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";

    // åˆ¤æ–­å›å¤è€…èº«ä»½
    let systemPrompt = "";
    let authorName = "";
    
    if (tweet.isNPC && !tweet.isRepost && !tweet.isQuote) {
        // è·¯äººæ¨ï¼šè·¯äººä¹Ÿè¦å›ä½ 
        authorName = tweet.npcName;
        systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”æ¨ç‰¹ä¸Šçš„è·¯äºº "${authorName}"ã€‚
        ä½ å‘äº†æ¨æ–‡ï¼š"${tweet.content}"
        æœ‰äººå›å¤ä½ ï¼š"${userComment.content}"
        è¯·å›å¤ä»–ã€‚è¯­æ°”éšæ„ã€çœŸå®ã€‚ä¸è¦å¸¦å¼•å·ã€‚`;
    } else {
        // è§’è‰²æ¨
        let charId = tweet.authorId;
        if(tweet.isRepost || tweet.isQuote) charId = tweet.sourceTweet.authorId;
        
        const char = contacts.find(c => c.id === charId);
        if(char) {
            authorName = char.name;
            systemPrompt = `ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
            ä½ å‘äº†æ¡æ¨æ–‡ï¼š"${tweet.content}"ã€‚
            ${userComment.replyToName ? `(è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼å›å¤ï¼Œå›å¤ç»™ ${userComment.replyToName})` : ""}
            æœ‰äººè¯„è®ºï¼š"${userComment.content}"ã€‚
            è¯·å›å¤ã€‚`;
        }
    }
    
    if(!systemPrompt) { btn.innerText="å›å¤"; return; }

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: systemPrompt }]
            })
        });
        const data = await res.json();
        const replyText = data.choices[0].message.content;

        // ç¡®å®šå¤´åƒ
        let replyAvatar = "";
        if(tweet.isNPC) replyAvatar = tweet.npcAvatar;
        else {
            const c = contacts.find(c => c.id === tweet.authorId);
            replyAvatar = c ? c.avatar : "";
        }

        const aiReply = {
            id: 'cmt_ai_' + Date.now(),
            name: authorName, handle: "@" + authorName, avatar: replyAvatar,
            content: replyText, timestamp: Date.now(),
            replyToName: userComment.name, replyToId: userComment.id
        };

        tweet.comments.push(aiReply);
        tweet.stats.replies++;
        saveXData();

        if (currentDetailTweetId === tweet.id) {
            renderDetailComments(tweet);
            const feed = document.getElementById('x-detail-container');
            feed.scrollTop = feed.scrollHeight;
        }
    } catch (e) { console.error(e); } 
    finally { btn.innerText = "å›å¤"; }
}

// ----------------------------
// 6. ä¸ªäººä¸»é¡µ & è®¤è¯
// ----------------------------
function openUserProfile() {
    const p = xData.user;
    document.getElementById('x-profile-banner').style.backgroundImage = `url(${p.banner})`;
    document.getElementById('x-profile-avatar').src = p.avatar;
    document.getElementById('x-profile-name').innerText = p.name;
    document.getElementById('x-profile-handle').innerText = p.handle;
    document.getElementById('x-profile-bio').innerText = p.bio || "è¿™ä¸ªäººå¾ˆæ‡’ã€‚";
    document.getElementById('x-profile-following').innerText = p.stats.following;
    document.getElementById('x-profile-followers').innerText = p.stats.followers;
    
    if(p.location) {
        document.getElementById('x-profile-location-box').style.display = 'inline';
        document.getElementById('x-profile-location').innerText = p.location;
    } else document.getElementById('x-profile-location-box').style.display = 'none';

    document.getElementById('x-profile-badge').innerHTML = getBadgeSVG(p.badgeType);
    
    loadUserProfileTweets(); 
    document.getElementById('page-x-profile').classList.add('active');
}

function closeUserProfile() { document.getElementById('page-x-profile').classList.remove('active'); }

function openEditProfile() {
    const p = xData.user;
    document.getElementById('edit-x-banner').value = p.banner || "";
    document.getElementById('edit-x-avatar').value = p.avatar || "";
    document.getElementById('edit-x-name').value = p.name;
    document.getElementById('edit-x-handle').value = p.handle;
    document.getElementById('edit-x-bio').value = p.bio || "";
    document.getElementById('edit-x-location').value = p.location || "";
    document.getElementById('edit-x-following').value = p.stats.following;
    document.getElementById('edit-x-followers').value = p.stats.followers;
    document.getElementById('edit-x-badge-type').value = p.badgeType || "none";
    
    const partnerSelect = document.getElementById('edit-x-partner');
    partnerSelect.innerHTML = '<option value="">-- æ—  --</option>';
    contacts.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.text = c.name;
        if(p.partnerId === c.id) option.selected = true;
        partnerSelect.appendChild(option);
    });

    togglePartnerSelect();
    openModal('modal-x-edit');
}

function saveUserProfile() {
    const p = xData.user;
    p.banner = document.getElementById('edit-x-banner').value;
    p.avatar = document.getElementById('edit-x-avatar').value;
    p.name = document.getElementById('edit-x-name').value;
    p.handle = document.getElementById('edit-x-handle').value;
    p.bio = document.getElementById('edit-x-bio').value;
    p.location = document.getElementById('edit-x-location').value;
    p.stats.following = document.getElementById('edit-x-following').value;
    p.stats.followers = document.getElementById('edit-x-followers').value;
    p.badgeType = document.getElementById('edit-x-badge-type').value;
    p.partnerId = document.getElementById('edit-x-partner').value;

    saveXData();
    closeModal('modal-x-edit');
    openUserProfile(); 
    document.getElementById('x-current-user-avatar').src = p.avatar;
    renderXFeed(); 
}

function togglePartnerSelect() {
    const type = document.getElementById('edit-x-badge-type').value;
    const group = document.getElementById('x-partner-select-group');
    if(type === 'couple' || type === 'married') group.style.display = 'block';
    else {
        group.style.display = 'none';
        document.getElementById('edit-x-partner').value = "";
    }
}

function getBadgeSVG(type) {
    if (!type || type === 'none') return '';
    let path = '', className = '';
    if (type === 'blue') { path = '<path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z"></path>'; className = 'badge-blue'; }
    else if (type === 'gold') { path = '<path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path>'; className = 'badge-gold'; }
    else if (type === 'couple') { path = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>'; className = 'badge-white'; }
    else if (type === 'married') { path = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>'; className = 'badge-white'; }
    else if (type === 'vip') { path = '<path d="M12 2L2 12l10 10 10-10L12 2z"></path>'; className = 'badge-white'; }
    
    return `<svg viewBox="0 0 24 24" class="${className}" style="width:18px; height:18px; margin-left:4px;">${path}</svg>`;
}

function shareToDM(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if (!tweet) return;
    
    let targetCharId = null;
    
    if (!tweet.isNPC && tweet.authorId !== 'user') {
        targetCharId = tweet.authorId;
    } else if (tweet.isRepost || tweet.isQuote) {
        if (!tweet.sourceTweet.isNPC && tweet.sourceTweet.authorId !== 'user') {
            targetCharId = tweet.sourceTweet.authorId;
        }
    }

    if (targetCharId) {
        const char = contacts.find(c => c.id === targetCharId);
        if (char) {
            const contextMsg = `[ç³»ç»Ÿæç¤º: ç”¨æˆ·é€šè¿‡ X App åˆ†äº«äº†æ¨æ–‡: "${tweet.isQuote ? tweet.quoteContent : tweet.content}"ã€‚]`;
            activeContactId = char.id;
            navigateTo('page-chat');
            setTimeout(() => {
               document.getElementById('userInput').value = `åˆ†äº«æ¨æ–‡ï¼š${tweet.content.substring(0, 20)}...`;
            }, 300);
        }
    } else {
        alert("åªèƒ½ç§ä¿¡å·²ç»‘å®šçš„è§’è‰²å“¦ï¼ˆNPCæš‚ä¸æ”¯æŒç§ä¿¡ï¼‰");
    }
}

function updateXBadge() {
    const count = xData.notifications.length; 
    const badge = document.getElementById('x-notif-badge');
    if(badge && count > 0) {
        badge.textContent = count;
        badge.style.display = 'block';
    } else if(badge) {
        badge.style.display = 'none';
    }
}
        // ã€æ–°å¢ã€‘è®©è§’è‰²ç»™ç”¨æˆ·æ¨æ–‡è¯„è®º
async function generateCharacterCommentForUser(tweetId) {
    const tweet = xData.tweets.find(t => t.id === tweetId);
    if(!tweet) return;

    // éšæœºé€‰ä¸€ä¸ªè§’è‰²æ¥è¯„è®ºä½ 
    if(contacts.length === 0) return;
    const char = contacts[Math.floor(Math.random() * contacts.length)];

    // æ„é€  Prompt
    const prompt = `
    ä½ ç°åœ¨æ‰®æ¼” "${char.name}"ã€‚äººè®¾ï¼š${char.systemPrompt}
    
    ä½ çš„ç”¨æˆ· "${xData.user.name}" åˆšåˆšå‘äº†ä¸€æ¡æ¨ç‰¹ï¼š
    "${tweet.content}"
    
    è¯·ä½ åœ¨åº•ä¸‹è¯„è®ºã€‚
    è¦æ±‚ï¼šç¬¦åˆä½ çš„äººè®¾ï¼Œç®€çŸ­ï¼Œä½¿ç”¨ä¸­æ–‡ï¼ŒåƒçœŸå®çš„æ¨ç‰¹å›å¤ã€‚
    `;

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await res.json();
        const replyText = data.choices[0].message.content;

        // åˆ›å»ºè¯„è®º
        const charComment = {
            id: 'cmt_char_' + Date.now(),
            authorId: char.id, // æ ‡è®°ä¸ºè§’è‰²
            name: char.name, 
            handle: "@" + char.id.substring(0,8),
            avatar: char.avatar,
            content: replyText, 
            timestamp: Date.now()
        };

        // æ’å…¥è¯„è®º
        tweet.comments.push(charComment);
        tweet.stats.replies++;
        saveXData();
        renderXFeed();
        
    } catch(e) { console.error(e); }
}
        // ==========================================
// --- 14. å…±è¯»ç³»ç»Ÿ (Co-Reading) å®Œæ•´ç‰ˆ ---
// ==========================================

// --- A. IndexedDB æ•°æ®åº“å·¥å…· (å­˜å¤§æ–‡ä»¶) ---
const dbName = "AIPhoneDB";
const storeName = "books";

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: "id" });
            }
        };
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

async function saveBookToDB(bookObj) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        store.put(bookObj);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

async function getBookFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function getAllBooksFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// --- B. æ•°æ®ç»“æ„ä¸å˜é‡ ---
// LocalStorage å­˜ metadata: { id, title, author, progressIndex, summaries: [] }
// IndexedDB å­˜ fullContent: { id, content, chapters: [] }
let libraryMeta = []; 
let currentBookData = null; 
let currentBookMeta = null; 

// åŠ è½½ä¹¦æ¶
function loadLibrary() {
    const saved = localStorage.getItem('ai_phone_library');
    if(saved) libraryMeta = JSON.parse(saved);
    renderBookshelf();
}

// æ¸²æŸ“ä¹¦æ¶
function renderBookshelf() {
    const container = document.getElementById('bookshelf-container');
    container.innerHTML = '';
    
    libraryMeta.forEach(book => {
        const div = document.createElement('div');
        div.className = 'app-icon-container';
        div.style.width = '100%';
        div.onclick = () => openBook(book.id);
        
        // éšæœºå°é¢è‰²
        const hue = parseInt(book.id) % 360;
        div.innerHTML = `
            <div class="book-cover" style="background: hsl(${hue}, 70%, 90%); color: hsl(${hue}, 60%, 30%);">
                <div style="font-size:24px; margin-bottom:5px;">ğŸ“–</div>
                <div class="book-title">${book.title}</div>
                <div class="book-author" style="margin-top:auto;">è¯»è‡³: ${book.progressIndex + 1}ç« </div>
            </div>
        `;
        container.appendChild(div);
    });
}

// --- C. å¯¼å…¥ä¹¦ç± ---
async function handleBookImport(event) {
    const file = event.target.files[0];
    if(!file) return;

    const btn = event.target.previousElementSibling;
    const oldText = btn.innerHTML;
    btn.innerHTML = "â³";

    const text = await file.text();
    const bookId = Date.now().toString();
    
    // æ™ºèƒ½åˆ†ç«  (æ­£åˆ™åŒ¹é…)
    const chapterRegex = /(^\s*ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ0-9]+[ç« å›å·].*|^\s*Chapter\s+[0-9]+.*)/gm;
    let chapters = [];
    
    const matches = [...text.matchAll(chapterRegex)];
    
    if (matches.length > 0) {
        for (let i = 0; i < matches.length; i++) {
            const currentMatch = matches[i];
            const nextMatch = matches[i+1];
            
            const title = currentMatch[0].trim();
            const startIndex = currentMatch.index;
            const endIndex = nextMatch ? nextMatch.index : text.length;
            
            const body = text.substring(startIndex, endIndex);
            chapters.push({ title, body });
        }
        if (matches[0].index > 0) {
            chapters.unshift({ title: "åºè¨€/å‰è¨€", body: text.substring(0, matches[0].index) });
        }
    } else {
        // å…œåº•ï¼šæŒ‰å­—æ•°åˆ‡åˆ†
        const chunkSize = 3000;
        for (let i = 0; i < text.length; i += chunkSize) {
            chapters.push({ 
                title: `ç¬¬ ${Math.floor(i/chunkSize)+1} éƒ¨åˆ†`, 
                body: text.substring(i, i + chunkSize) 
            });
        }
    }

    // å­˜å…¥ DB (å¤§æ–‡ä»¶)
    await saveBookToDB({ id: bookId, chapters: chapters });

    // å­˜å…¥ Local (ç´¢å¼•)
    const newBook = {
        id: bookId,
        title: file.name.replace('.txt',''),
        progressIndex: 0,
        summaries: []
    };
    libraryMeta.push(newBook);
    localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
    
    renderBookshelf();
    btn.innerHTML = oldText;
    alert(`å¯¼å…¥æˆåŠŸï¼å…±è¯†åˆ«å‡º ${chapters.length} ä¸ªç« èŠ‚ã€‚`);
}

// --- D. é˜…è¯»é€»è¾‘ ---
async function openBook(id) {
    if (!activeContactId) {
        alert("è¯·å…ˆåœ¨ã€ä¿¡æ¯ã€‘åˆ—è¡¨é‡Œé€‰æ‹©ä¸€ä¸ªè§’è‰²ä½œä¸ºä¼´è¯»å¯¹è±¡ï¼");
        return;
    }
    
    currentBookMeta = libraryMeta.find(b => b.id === id);
    currentBookData = await getBookFromDB(id); 
    
    if(!currentBookData || !currentBookMeta) return alert("ä¹¦ç±æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°å¯¼å…¥");

    navigateTo('page-reader');
    
    // è®¾ç½®å¤´åƒ
    const char = contacts.find(c => c.id === activeContactId);
    if(char) {
        document.getElementById('reader-ai-avatar').src = char.avatar;
        document.getElementById('reader-chat-partner').innerText = char.name;
    }

    renderReaderPage();
}

// æ¸²æŸ“é˜…è¯»å™¨é¡µé¢ (ä¿®æ”¹ç‰ˆï¼šå¢åŠ è¿›åº¦æ¢å¤ + æ»šåŠ¨ç›‘å¬)
function renderReaderPage() {
    const idx = currentBookMeta.progressIndex;
    const chapter = currentBookData.chapters[idx];
    
    // 1. è®¾ç½®æ ‡é¢˜å’Œè¿›åº¦æ–‡å­—
    document.getElementById('reader-title').innerText = chapter.title;
    document.getElementById('reader-progress').innerText = `${idx + 1}/${currentBookData.chapters.length}`;
    
    // 2. å¡«å……å†…å®¹
    const contentBox = document.getElementById('reader-content');
    contentBox.innerText = chapter.body; 
    
    // --- âœ¨ æ–°å¢æ ¸å¿ƒé€»è¾‘ï¼šæ¢å¤ä¸Šæ¬¡é˜…è¯»ä½ç½® ---
    if (currentBookMeta.scrollRatio && currentBookMeta.scrollRatio > 0) {
        //ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç­‰å¾…æ–‡å­—æ¸²æŸ“å‡ºé«˜åº¦ï¼Œå¦åˆ™ scrollHeight å¯èƒ½ä¸å‡†
        setTimeout(() => {
            const targetScroll = contentBox.scrollHeight * currentBookMeta.scrollRatio;
            contentBox.scrollTop = targetScroll;
        }, 50);
    } else {
        contentBox.scrollTop = 0; // å¦‚æœæ²¡è®°å½•ï¼Œå°±å›åˆ°é¡¶éƒ¨
    }

    // --- âœ¨ æ–°å¢æ ¸å¿ƒé€»è¾‘ï¼šå®æ—¶ç›‘å¬æ»šåŠ¨å¹¶ä¿å­˜ ---
    // ä½¿ç”¨é˜²æŠ– (Throttle) æœºåˆ¶ï¼Œæ¯éš” 1 ç§’ä¿å­˜ä¸€æ¬¡ï¼Œé¿å…ç–¯ç‹‚å†™å…¥ LocalStorage å¡é¡¿
    let saveTimeout;
    contentBox.onscroll = function() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            // è®¡ç®—å½“å‰æ»šåŠ¨çš„ç™¾åˆ†æ¯” (0.0 - 1.0)
            const ratio = contentBox.scrollTop / (contentBox.scrollHeight - contentBox.clientHeight);
            
            // å­˜å…¥å†…å­˜å¯¹è±¡
            currentBookMeta.scrollRatio = ratio;
            
            // å­˜å…¥ç¡¬ç›˜ (LocalStorage)
            saveBookProgress();
            // console.log("è¿›åº¦å·²ä¿å­˜:", (ratio*100).toFixed(2) + "%"); // è°ƒè¯•ç”¨
        }, 1000); // åœæ­¢æ»šåŠ¨ 1ç§’ åä¿å­˜
    };
}

function exitReader() {
    currentBookData = null; // é‡Šæ”¾å†…å­˜
    navigateTo('page-bookshelf');
}

// === âœ¨ æ ¸å¿ƒäº¤äº’é€»è¾‘ âœ¨ ===

// 1. ç¿»é¡µ (åªæ»šå±ï¼Œä¸è§¦å‘æ€»ç»“)
function scrollReader(direction) {
    const el = document.getElementById('reader-content');
    // æ»šåŠ¨é«˜åº¦ = å±å¹•é«˜åº¦çš„ 80% (ä¿ç•™ä¸€ç‚¹ä¸Šä¸‹æ–‡)
    const scrollAmount = el.clientHeight * 0.8; 
    
    el.scrollBy({
        top: scrollAmount * direction,
        behavior: 'smooth'
    });
}

// 2. ç¿»ç«  (è§¦å‘æ€»ç»“é€»è¾‘)
async function nextChapter() {
    if(currentBookMeta.progressIndex >= currentBookData.chapters.length - 1) {
        return alert("å·²ç»æ˜¯æœ€åä¸€ç« äº†");
    }

    // --- æ™ºèƒ½æ£€æµ‹ï¼šæ˜¯å¦éœ€è¦æ€»ç»“ ---
    // é€»è¾‘ï¼šå¦‚æœå½“å‰ç« èŠ‚è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡æ€»ç»“ (summaries[å½“å‰ç´¢å¼•] ä¸ºç©º)
    const currentIdx = currentBookMeta.progressIndex;
    const hasSummary = currentBookMeta.summaries && currentBookMeta.summaries[currentIdx];
    
    if (!hasSummary) {
        const chapterTitle = currentBookData.chapters[currentIdx].title;
        const char = contacts.find(c => c.id === activeContactId);
        
        // å¼¹çª—è¯¢é—®
        if(confirm(`"${chapterTitle}" è¯»å®Œäº†ã€‚\n\næ˜¯å¦è®© ${char ? char.name : 'AI'} æ€»ç»“æœ¬ç« å‰§æƒ…å¹¶å­˜å…¥è®°å¿†ï¼Ÿ\n(è¿™æœ‰åŠ©äºä¸‹ä¸€ç« çš„è¿è´¯æ€§)`)) {
            await generateChapterSummary();
        }
    }

    // åªæœ‰åœ¨ç”¨æˆ·å¤„ç†å®Œæ€»ç»“(æˆ–å–æ¶ˆ)åï¼Œæ‰çœŸæ­£è·³è½¬
    currentBookMeta.progressIndex++;
    currentBookMeta.scrollRatio = 0;
    saveBookProgress();
    renderReaderPage();
}

function prevChapter() {
    if(currentBookMeta.progressIndex <= 0) return;
    currentBookMeta.progressIndex--;
    currentBookMeta.scrollRatio = 0;
    saveBookProgress();
    renderReaderPage();
}

function saveBookProgress() {
    localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
}

// --- E. AI æ€»ç»“ä¸äº’åŠ¨ (ä¿®æ­£ç‰ˆï¼šæ”¯æŒå…¨æ–‡æ€»ç»“) ---

// ç”Ÿæˆå½“å‰ç« èŠ‚çš„æ€»ç»“
async function generateChapterSummary() {
    const char = contacts.find(c => c.id === activeContactId);
    if(!char || !globalConfig.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");

    const idx = currentBookMeta.progressIndex;
    const content = currentBookData.chapters[idx].body;
    
    // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå–æ¶ˆâ€œæå¤´å»å°¾â€ã€‚
    // ç°åœ¨çš„æ¨¡å‹é€šå¸¸æ”¯æŒ 16k contextï¼Œè¶³å¤Ÿè¯»å®Œä¸€ç« ï¼ˆé€šå¸¸3000-5000å­—ï¼‰ã€‚
    // è¿™é‡Œè®¾ç½®ä¸€ä¸ª 20000 å­—çš„å®‰å…¨ä¸Šé™ï¼Œé˜²æ­¢æç«¯æƒ…å†µå¡æ­»ã€‚
    let textToSend = content;
    if (content.length >20000) {
        textToSend = content.substring(0,20000) + "\n...(æœ¬ç« å¤ªé•¿ï¼Œæˆªæ–­)...";
        console.warn("ç« èŠ‚è¿‡é•¿ï¼Œå·²æˆªæ–­å‘é€");
    }

    const btn = document.querySelector('.reader-btn-chap:last-child');
    // å¦‚æœæ‰¾ä¸åˆ°æŒ‰é’®ï¼ˆæ¯”å¦‚æ˜¯å¼¹çª—è§¦å‘çš„ï¼‰ï¼Œå°±ä¸æ”¹æ–‡å­—äº†ï¼Œé¿å…æŠ¥é”™
    let oldText = "";
    if(btn) {
        oldText = btn.innerText;
        btn.innerText = "æ­£åœ¨é˜…è¯»..."; // æç¤ºç”¨æˆ· AI æ­£åœ¨è¯»å…¨æ–‡
    }

    try {
        const prompt = `è¯·é˜…è¯»ä»¥ä¸‹å°è¯´ç« èŠ‚ï¼Œå¹¶æ€»ç»“æ ¸å¿ƒå‰§æƒ…ã€‚
        è¦æ±‚ï¼š
        1. æ§åˆ¶åœ¨ 300 å­—ä»¥å†…ã€‚
        2. é£æ ¼ä¸ºè®°å™æ–‡ï¼Œç±»ä¼¼â€œå‰§æƒ…æ¢—æ¦‚â€æˆ–â€œå‰æƒ…æè¦â€ï¼Œå®¢è§‚é™ˆè¿°å‘ç”Ÿäº†ä»€ä¹ˆã€‚
        3. é‡ç‚¹è®°å½•ï¼šæ–°å‡ºåœºçš„äººç‰©ã€å…³é”®è½¬æŠ˜ã€ä¸»è§’è·å¾—çš„ä¿¡æ¯ã€‚
        4. è¿™æ®µæ€»ç»“å°†ç”¨äºè®© AI è®°ä½å‰§æƒ…ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ç« ä¿æŒè¿è´¯ã€‚
        
        ã€ç« èŠ‚æ­£æ–‡ã€‘ï¼š
        ${textToSend}`;

        // æ³¨æ„ï¼šè¿™é‡Œ model ç”¨çš„æ˜¯ä½ è®¾ç½®é‡Œçš„å…¨å±€ modelã€‚
        // å»ºè®®åœ¨è®¾ç½®é‡Œå¡«æ”¯æŒé•¿æ–‡æœ¬çš„æ¨¡å‹ï¼Œå¦‚ gpt-3.5-turbo-16k æˆ– gpt-4o
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model, // ç¡®ä¿è¿™ä¸ªæ¨¡å‹èƒ½åƒå¾—ä¸‹å‡ åƒå­—
                messages: [{ role: "user", content: prompt }]
            })
        });
        
        if (!res.ok) {
            const errData = await res.json();
            // å¦‚æœæŠ¥é”™åŒ…å« context_length_exceededï¼Œè¯´æ˜æ¨¡å‹å¤ªæ—§äº†
            if (JSON.stringify(errData).includes("context_length_exceeded")) {
                throw new Error("æ¨¡å‹ä¸Šä¸‹æ–‡ä¸è¶³ï¼Œè¯·åœ¨è®¾ç½®é‡Œæ›´æ¢æ”¯æŒé•¿æ–‡æœ¬çš„æ¨¡å‹ï¼ˆå¦‚ gpt-3.5-turbo-16kï¼‰");
            }
            throw new Error(res.statusText);
        }

        const data = await res.json();
        const summary = data.choices[0].message.content;

        // åˆå§‹åŒ– summaries æ•°ç»„
        if(!currentBookMeta.summaries) currentBookMeta.summaries = [];
        
        // å­˜å…¥æ€»ç»“
        currentBookMeta.summaries[idx] = summary;
        saveBookProgress();
        
        // === âœ¨ æ–°å¢åŠŸèƒ½ï¼šåŒæ­¥å…±è¯»æŠ¥å‘Šåˆ°ä¸»èŠå¤©æ¡† âœ¨ ===
        const chapterTitle = currentBookData.chapters[idx].title;
        const bookTitle = currentBookMeta.title;

        // æ„é€ æŠ¥å‘Šæ–‡æ¡ˆ
        const readingReport = `
ğŸ“–ã€å…±è¯»æŠ¥å‘Šã€‘
------------------
ğŸ“š ä¹¦ç±ï¼šã€Š${bookTitle}ã€‹
ğŸ“‘ ç« èŠ‚ï¼š${chapterTitle}
ğŸ“ å‰§æƒ…å›é¡¾ï¼š
${summary}
------------------
(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšè¯»å®Œè¿™ä¸€ç« ã€‚è¯·${char.name}æ ¹æ®è¿™ä¸ªå‰§æƒ…å›é¡¾ï¼Œå¯ä»¥åœ¨è¿™ä¸ªèŠå¤©æ¡†é‡Œå’Œç”¨æˆ·èŠèŠè¯»åæ„Ÿï¼Œæˆ–è€…è¯„ä»·ä¸€ä¸‹å‰§æƒ…å‘å±•ã€‚)
`.trim();

        // å°†æŠ¥å‘Šä»¥â€œç”¨æˆ·æ¶ˆæ¯â€çš„å½¢å¼æ’å…¥ä¸»èŠå¤©è®°å½•
        // è¿™æ · AI å°±ä¼šä»¥ä¸ºæ˜¯ä½ å‘ç»™å®ƒçš„ï¼Œå®ƒå°±ä¼šæ ¹æ®è¿™æ®µè¯è¿›è¡Œå›å¤ï¼Œä»è€Œå®ç°â€œåŒæ­¥ä¿¡æ¯ç‚¹â€
        char.messages.push({
            role: 'user', // è¿™é‡Œç”¨ userï¼Œå‡è£…æ˜¯ç”¨æˆ·åˆ†äº«çš„æŠ¥å‘Š
            content: readingReport,
            timestamp: Date.now()
        });
        
        // ä¿å­˜èŠå¤©æ•°æ®
        saveData(); 

        alert(`âœ… æ€»ç»“å®Œæ¯•ï¼\nå…±è¯»æŠ¥å‘Šå·²å‘é€ç»™ ${char.name}ï¼Œé€€å›ä¸»ç•Œé¢å³å¯çœ‹åˆ° Ta çš„è¯»åæ„Ÿã€‚`);

    } catch(e) {
        alert("æ€»ç»“å¤±è´¥: " + e.message);
    } finally {
        if(btn) btn.innerText = oldText;
    }
}
        // æ‰‹åŠ¨è§¦å‘åŒæ­¥æŠ¥å‘Š (è¿›åº¦æ„ŸçŸ¥ç‰ˆ)
async function manualShareReport() {
    const char = contacts.find(c => c.id === activeContactId);
    if (!char) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼´è¯»è§’è‰²");
    if (!currentBookData || !currentBookMeta) return;

    const idx = currentBookMeta.progressIndex;
    const fullBody = currentBookData.chapters[idx].body;
    const chapterTitle = currentBookData.chapters[idx].title;
    
    // 1. è®¡ç®—é˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”
    const el = document.getElementById('reader-content');
    // è®¡ç®—å…¬å¼ï¼š(å·²æ»šåŠ¨çš„é«˜åº¦ + å±å¹•é«˜åº¦) / æ€»é«˜åº¦
    let ratio = (el.scrollTop + el.clientHeight) / el.scrollHeight;
    if (ratio > 1) ratio = 1; // é˜²æ­¢æº¢å‡º
    const percentage = Math.floor(ratio * 100);

    // 2. æˆªå–â€œå·²è¯»å†…å®¹â€
    // æ ¹æ®æ¯”ä¾‹ï¼Œç®—å‡ºå¤§æ¦‚è¯»åˆ°äº†ç¬¬å‡ ä¸ªå­—
    const endIndex = Math.floor(fullBody.length * ratio);
    // æˆªå–ä»å¤´åˆ°å½“å‰ä½ç½®çš„æ–‡æœ¬
    let readText = fullBody.substring(0, endIndex);

    // *å®‰å…¨æˆªæ–­*ï¼šå¦‚æœå·²è¯»å†…å®¹å¤ªé•¿(è¶…è¿‡1.5ä¸‡å­—)ï¼Œä¸ºäº†é˜²æ­¢APIæŠ¥é”™ï¼Œ
    // æˆ‘ä»¬é‡ç‚¹ä¿ç•™â€œæœ€è¿‘è¯»åˆ°çš„2000å­—â€å’Œâ€œå¼€å¤´çš„1000å­—â€ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œä¸­é—´çœç•¥ã€‚
    // (å¤§å¤šæ•°æ—¶å€™ç« èŠ‚ä¸ä¼šè¿™ä¹ˆé•¿ï¼Œè¿™æ˜¯ä¸€ä¸ªä¿é™©)
    if (readText.length > 15000) {
        readText = readText.substring(0, 5000) + 
                   "\n\n......(ä¸­é—´ç•¥è¿‡)......\n\n" + 
                   readText.substring(readText.length - 8000);
    }

    if (!confirm(`å½“å‰è¿›åº¦ ${percentage}%ã€‚\nè¦å°†å·²è¯»å†…å®¹åŒæ­¥ç»™ ${char.name} å—ï¼Ÿ`)) return;

    const btn = document.querySelector('button[onclick*="manualShareReport"]');
    const oldBtnText = btn.innerText; // æˆ–è€…æ˜¯å›¾ç‰‡èƒŒæ™¯
    // å¦‚æœæ˜¯æ–‡å­—æŒ‰é’®å°±å˜æ–‡å­—ï¼Œå¦‚æœæ˜¯å›¾ç‰‡æŒ‰é’®(è¢«CSSè¦†ç›–äº†)å…¶å®çœ‹ä¸å‡ºå˜åŒ–ï¼Œä½†è¿™ä¸å½±å“é€»è¾‘
    btn.innerText = "â³"; 

    try {
        // 3. æ„å»º Prompt (æ³¨é‡â€œå½“å‰çŠ¶æ€â€)
        const prompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·å…±è¯»ä¸€æœ¬ä¹¦ã€‚
        ä¹¦åï¼šã€Š${currentBookMeta.title}ã€‹
        å½“å‰ç« èŠ‚ï¼š${chapterTitle}
        
        ã€çŠ¶æ€ã€‘ï¼šç”¨æˆ·è¯»åˆ°äº†æœ¬ç« çš„ ${percentage}% å¤„åœä¸‹äº†ã€‚
        
        ã€ç”¨æˆ·å·²è¯»å†…å®¹å¦‚ä¸‹ã€‘ï¼š
        "${readText}"
        
        ã€ä»»åŠ¡ã€‘ï¼š
        1. è¯·æ€»ç»“ç”¨æˆ·ç›®å‰è¯»åˆ°çš„å‰§æƒ…ï¼ˆä¸è¦å‰§é€åé¢æ²¡è¯»åˆ°çš„å†…å®¹ï¼‰ã€‚
        2. ä»¥â€œè¯»åæ„Ÿâ€æˆ–â€œé—²èŠâ€çš„å£å»å›å¤ç”¨æˆ·ã€‚
        3. å¦‚æœå‰§æƒ…å¡åœ¨å…³é”®ç‚¹ï¼Œå¯ä»¥è°ƒä¾ƒä¸€ä¸‹â€œæ€ä¹ˆæ–­åœ¨è¿™é‡Œäº†â€ï¼›å¦‚æœå‰§æƒ…å¹³æ·¡ï¼Œå¯ä»¥èŠèŠå¯¹äººç‰©çš„çœ‹æ³•ã€‚
        `;

        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: prompt }]
            })
        });

        const data = await res.json();
        const aiSummary = data.choices[0].message.content;

        // 4. æ„é€ è¿›åº¦æŠ¥å‘Š (å­˜å…¥èŠå¤©è®°å½•)
        const report = `
ğŸ”–ã€é˜…è¯»è¿›åº¦åŒæ­¥ã€‘
------------------
ğŸ“– ã€Š${currentBookMeta.title}ã€‹
ğŸ“‘ ${chapterTitle}
ğŸ“Š è¯»è‡³ ${percentage}% å¤„æ­‡æ¯
ğŸ“ å‰§æƒ…å›é¡¾ï¼š
${aiSummary}
------------------
(ç³»ç»Ÿæç¤ºï¼šè¯·${char.name}æ ¹æ®ç”¨æˆ·åœä¸‹çš„ä½ç½®ï¼Œå’Œç”¨æˆ·èŠèŠç›®å‰çš„å‰§æƒ…æ„Ÿå—ã€‚)
        `.trim();

        char.messages.push({
            role: 'user', 
            content: report,
            timestamp: Date.now()
        });
        
        saveData();
        alert(`âœ… åŒæ­¥æˆåŠŸï¼\n${char.name} å·²ç»çŸ¥é“ä½ è¯»åˆ°å“ªäº†ï¼Œå¿«å»çœ‹çœ‹ Ta è¯´äº†ä»€ä¹ˆå§ï¼`);

    } catch(e) {
        alert("åŒæ­¥å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldBtnText; // æ¢å¤æŒ‰é’®
    }
}

// æ‰“å¼€é˜…è¯»å™¨èŠå¤©çª—å£ï¼ˆå¸¦å†å²è®°å½•åŠ è½½ï¼‰
function openReaderChat() {
    const historyBox = document.getElementById('reader-chat-history');
    historyBox.innerHTML = ''; // å…ˆæ¸…ç©ºç•Œé¢

    // 1. æ£€æŸ¥å¹¶åˆå§‹åŒ–è¿™æœ¬ä¹¦çš„èŠå¤©è®°å½•æ•°ç»„
    if (!currentBookMeta.chatLogs) {
        currentBookMeta.chatLogs = [];
    }

    // 2. æ¸²æŸ“å†å²è®°å½•
    const char = contacts.find(c => c.id === activeContactId);
    // å¦‚æœè¿˜æ²¡é€‰äººï¼Œå°±ç”¨ä¸ªé»˜è®¤å¤´åƒ
    const avatar = char ? char.avatar : ''; 

    currentBookMeta.chatLogs.forEach(log => {
        if (log.role === 'user') {
            historyBox.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; color:white; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span></div>`;
        } else {
            historyBox.innerHTML += `<div style="text-align:left; margin:10px 0;"><img src="${avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;"> <span style="background:#f2f2f7; color:black; padding:8px 12px; border-radius:15px; display:inline-block;">${log.content}</span></div>`;
        }
    });

    // 3. æ»šåˆ°åº•éƒ¨
    setTimeout(() => {
        historyBox.scrollTop = historyBox.scrollHeight;
    }, 100);

    openModal('modal-reader-chat');
}

// å‘é€é˜…è¯»å™¨æ¶ˆæ¯ï¼ˆå¸¦ä¿å­˜åŠŸèƒ½ï¼‰
async function sendReaderMsg() {
    const input = document.getElementById('readerChatInput');
    const txt = input.value.trim();
    if(!txt) return;

    const char = contacts.find(c => c.id === activeContactId);
    if(!char) return;

    // --- 1. UI æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ ---
    const historyBox = document.getElementById('reader-chat-history');
    historyBox.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#007AFF; color:white; padding:8px 12px; border-radius:15px; display:inline-block;">${txt}</span></div>`;
    input.value = '';
    historyBox.scrollTop = historyBox.scrollHeight;

    // --- 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°ä¹¦æœ¬æ•°æ® ---
    if (!currentBookMeta.chatLogs) currentBookMeta.chatLogs = [];
    currentBookMeta.chatLogs.push({ role: 'user', content: txt, time: Date.now() });
    saveBookProgress(); // å­˜å…¥ LocalStorage

    // --- 3. å‡†å¤‡ä¸Šä¸‹æ–‡ (ç²¾å‡†å®šä½ç‰ˆ) ---
    const idx = currentBookMeta.progressIndex;
    const fullBody = currentBookData.chapters[idx].body;
    const contentBox = document.getElementById('reader-content');
    
    let scrollPercent = 0;
    if (contentBox.scrollHeight > contentBox.clientHeight) {
        scrollPercent = contentBox.scrollTop / (contentBox.scrollHeight - contentBox.clientHeight);
    }
    const charIndex = Math.floor(fullBody.length * scrollPercent);
    const start = Math.max(0, charIndex - 1200);
    const end = Math.min(fullBody.length, charIndex + 500);
    const currentContext = fullBody.substring(start, end);

    const recentSummaries = (currentBookMeta.summaries || [])
        .slice(Math.max(0, idx-6), idx)
        .map((s, i) => `[ç¬¬${idx-6+i+1}ç« æ€»ç»“]: ${s}`)
        .join("\n");

    const systemPrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·è¯»ä¸€æœ¬ä¹¦ã€‚
    ä½ æ‰®æ¼”è§’è‰²ï¼š${char.name}ã€‚äººè®¾ï¼š${char.systemPrompt}ã€‚
    
    ã€é•¿æœŸè®°å¿†ã€‘ï¼š${recentSummaries || "æ— "}
    ã€ç”¨æˆ·å½“å‰é˜…è¯»ç‰‡æ®µã€‘ï¼š"...${currentContext}..."
    ç”¨æˆ·è¯´ï¼š"${txt}"
    
    è¯·ç»“åˆç”¨æˆ·å½“å‰çœ‹åˆ°çš„ç‰‡æ®µè¿›è¡Œå›å¤ã€‚å¦‚æœç‰‡æ®µæ²¡å¤´æ²¡å°¾ï¼Œè¯·æ ¹æ®ä¸Šä¸‹æ–‡æ¨æµ‹ã€‚ä¸è¦å‰§é€åé¢è¿˜æ²¡è¯»åˆ°çš„å†…å®¹ã€‚`;

    const btn = document.querySelector('.input-toolbar .btn-send');
    const oldBtnText = btn.innerText;
    btn.innerText = "â³";

    try {
        const res = await fetch(normalizeUrl(globalConfig.apiUrl) + '/chat/completions', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + globalConfig.apiKey },
            body: JSON.stringify({
                model: globalConfig.model,
                messages: [{ role: "user", content: systemPrompt }]
            })
        });
        const data = await res.json();
        const reply = data.choices[0].message.content;

        // --- 4. UI æ˜¾ç¤º AI å›å¤ ---
        historyBox.innerHTML += `<div style="text-align:left; margin:10px 0;"><img src="${char.avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;"> <span style="background:#f2f2f7; color:black; padding:8px 12px; border-radius:15px; display:inline-block;">${reply}</span></div>`;
        historyBox.scrollTop = historyBox.scrollHeight;

        // --- 5. ä¿å­˜ AI å›å¤åˆ°ä¹¦æœ¬æ•°æ® ---
        currentBookMeta.chatLogs.push({ role: 'assistant', content: reply, time: Date.now() });
        saveBookProgress(); // å†æ¬¡ä¿å­˜

    } catch(e) {
        historyBox.innerHTML += `<div style="color:red; font-size:12px;">Error: ${e.message}</div>`;
    } finally {
        btn.innerText = oldBtnText;
    }
}

// --- F. V2 å¤‡ä»½/æ¢å¤ (å¯¼å‡ºä¹¦æœ¬å†…å®¹) ---
async function exportDataV2() {
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "æ­£åœ¨æ‰“åŒ…...";
    
    try {
        // ä» IndexedDB æ‹‰å–æ‰€æœ‰ä¹¦
        const allBooks = await getAllBooksFromDB();
        
        const backupPayload = {
            version: 2,
            globalConfig: globalConfig,
            contacts: contacts,
            themeConfig: themeConfig,
            libraryMeta: libraryMeta,
            schedule: mySchedule,
            xData: xData,
            bookContents: allBooks 
        };

        const blob = new Blob([JSON.stringify(backupPayload)], {type:'application/json'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'ai_phone_full_backup_v2.json';
        a.click();
    } catch(e) {
        alert("å¤‡ä»½å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = oldText;
    }
}

async function importDataV2(e) {
    const f = e.target.files[0]; 
    if(!f) return;
    
    const r = new FileReader();
    r.onload = async ev => {
        try {
            const d = JSON.parse(ev.target.result);
            
            if(d.globalConfig) {
                globalConfig = d.globalConfig;
                localStorage.setItem('ai_phone_config', JSON.stringify(globalConfig));
            }
            if(d.contacts) {
                contacts = d.contacts;
                localStorage.setItem('ai_phone_contacts', JSON.stringify(contacts));
            }
            if(d.themeConfig) {
                themeConfig = d.themeConfig;
                localStorage.setItem('ai_phone_theme', JSON.stringify(themeConfig));
            }
            if(d.libraryMeta) {
                libraryMeta = d.libraryMeta;
                localStorage.setItem('ai_phone_library', JSON.stringify(libraryMeta));
            }
            
            // æ¢å¤ IndexedDB
            if(d.bookContents && Array.isArray(d.bookContents)) {
                for (const book of d.bookContents) {
                    await saveBookToDB(book);
                }
            }

            alert("æ•°æ®æ¢å¤æˆåŠŸï¼");
            location.reload();
            
        } catch(e) {
            alert("æ¢å¤å¤±è´¥: " + e.message);
        }
    }; 
    r.readAsText(f);
    e.target.value = ''; 
}

// å¯åŠ¨åŠ è½½
loadLibrary();
        // --- G. æŸ¥çœ‹é˜…è¯»ç¬”è®° (UI) ---

function openSummaryList() {
    const listContainer = document.getElementById('summary-list-content');
    listContainer.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®

    if (!currentBookMeta || !currentBookData) return;

    const summaries = currentBookMeta.summaries || [];
    const chapters = currentBookData.chapters || [];
    
    // éå†æ‰€æœ‰ç« èŠ‚
    // æ³¨æ„ï¼šæˆ‘ä»¬è¦æ˜¾ç¤ºæ‰€æœ‰ç« èŠ‚ï¼Œå“ªæ€•æ²¡æœ‰æ€»ç»“çš„ä¹Ÿè¦æ˜¾ç¤ºæ ‡é¢˜ï¼Œæ–¹ä¾¿çŸ¥é“è¿›åº¦
    chapters.forEach((chap, index) => {
        // å¦‚æœè¿™ä¸€ç« æœ‰æ€»ç»“
        const summaryText = summaries[index];
        
        // åªæ˜¾ç¤ºâ€œæœ‰æ€»ç»“â€çš„ç« èŠ‚ï¼Œæˆ–è€…â€œå½“å‰é˜…è¯»è¿›åº¦ä¹‹å‰â€çš„ç« èŠ‚
        // å¦‚æœä½ å¸Œæœ›æ˜¾ç¤ºæ‰€æœ‰ç« èŠ‚ï¼ˆåŒ…æ‹¬æ²¡è¯»çš„ï¼‰ï¼Œå»æ‰ä¸‹é¢è¿™ä¸ª if åˆ¤æ–­å³å¯
        // è¿™é‡Œæˆ‘è®¾è®¡ä¸ºï¼šåªæ˜¾ç¤ºåˆ°å½“å‰é˜…è¯»è¿›åº¦çš„ç« èŠ‚
        if (index > currentBookMeta.progressIndex) return;

        const div = document.createElement('div');
        div.className = 'summary-card';
        
        // æ ‡è®°å½“å‰æ­£åœ¨è¯»çš„ç« èŠ‚
        const isCurrent = (index === currentBookMeta.progressIndex);
        const statusBadge = isCurrent ? '<span style="color:#007AFF; font-size:12px;">(æ­£åœ¨è¯»)</span>' : '';

        // å¦‚æœæ²¡æœ‰æ€»ç»“å†…å®¹
        const contentHtml = summaryText 
            ? `<div class="sum-text">${summaryText}</div>`
            : `<div class="sum-empty">æš‚æ— æ€»ç»“ (å¯èƒ½å› ä¸ºä½ è·³è¿‡äº†æˆ–è€…æ˜¯åˆšå¼€å§‹è¯»)</div>`;

        div.innerHTML = `
            <div class="sum-chap-title">
                <span>${chap.title}</span>
                ${statusBadge}
            </div>
            ${contentHtml}
        `;
        
        // å€’åºæ’å…¥ï¼Ÿè¿˜æ˜¯æ­£åºï¼Ÿ
        // æ—¢ç„¶æ˜¯å›é¡¾ï¼Œé€šå¸¸æ­£åºæ¯”è¾ƒå¥½ï¼ˆä»ç¬¬ä¸€ç« å¼€å§‹ï¼‰ã€‚å¦‚æœæƒ³çœ‹æœ€æ–°çš„ï¼Œå¯ä»¥ç”¨ appendChildã€‚
        // å¦‚æœæƒ³æŠŠæœ€æ–°çš„æ”¾åœ¨æœ€ä¸Šé¢ï¼Œå¯ä»¥ç”¨ prepend(div)ã€‚è¿™é‡Œç”¨æ­£åºï¼š
        listContainer.appendChild(div);
    });

    // å¦‚æœå®Œå…¨æ²¡æ•°æ®
    if (listContainer.children.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">è¿˜æ²¡æœ‰ä»»ä½•é˜…è¯»ç¬”è®°å“¦<br>è¯»å®Œä¸€ç« å AI ä¼šè‡ªåŠ¨è®°å½•</div>';
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆçœ‹åˆ°æœ€æ–°çš„ï¼‰
    setTimeout(() => {
        // åªæœ‰å†…å®¹å¤šçš„æ—¶å€™æ‰è‡ªåŠ¨æ»šåˆ°åº•
        const modalBody = document.querySelector('#modal-book-summary .modal-body');
        if(modalBody) modalBody.scrollTop = modalBody.scrollHeight;
    }, 100);

    openModal('modal-book-summary');
}
    </script>
</body>
</html>































































